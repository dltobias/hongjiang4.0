<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>入库确认 - 烘匠 BakeManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        orange: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            200: '#fed7aa',
                            300: '#fdba74',
                            400: '#fb923c',
                            500: '#f97316',
                            600: '#ea580c',
                            700: '#c2410c',
                            800: '#9a3412',
                            900: '#7c2d12',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Cookpad Design System */
        :root {
            --primary-orange: #ff9f43;
            --primary-dark: #ff8c00;
            --text-main: #333333;
            --text-sub: #8b8b8b;
            --bg-light: #f7f7f5;
            --bg-white: #ffffff;
        }

        .gradient-primary {
            background: linear-gradient(135deg, #ff9f43 0%, #ff8c00 100%);
        }
        
        .price-input {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: white;
        }
        
        .price-input:focus {
            outline: none;
            border-color: #ff9f43;
            background: #fff7ed;
            box-shadow: 0 0 0 3px rgba(255, 159, 67, 0.1);
        }
        
        .material-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background: #ffffff;
            border: 1px solid #f0f0f0;
        }
        
        .material-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 140, 0, 0.1);
            border-color: #ffedd5;
        }
        
        /* 数量输入框样式 - 与盘点页面保持一致 */
        .quantity-input {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 4px 0;
            font-weight: 600;
            transition: all 0.2s ease;
            background: #ffffff;
            text-align: center;
            height: 36px;
        }
        
        .quantity-input:focus {
            outline: none;
            border-color: #ff9f43;
            background: #fff7ed;
            box-shadow: 0 0 0 3px rgba(255, 159, 67, 0.1);
        }

        /* 防止横向滚动 */
        body {
            overflow-x: hidden;
            max-width: 100vw;
            background-color: #f7f7f5;
        }
        
        .main-container {
            max-width: 100vw;
            overflow-x: hidden;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 顶部导航栏 - Cookpad 风格 -->
    <div class="bg-white px-4 py-3 shadow-sm border-b border-gray-100 sticky top-0 z-30">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="goBack()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-all text-gray-600">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div>
                    <div class="text-lg font-bold text-gray-800 tracking-wide">入库确认</div>
                    <div class="text-xs text-gray-500 font-medium mt-0.5" id="warehouseInfo">请确认入库信息</div>
                </div>
            </div>
            <div class="flex items-center">
                <button onclick="confirmInbound()" id="confirmBtn" class="px-4 py-2 bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white rounded-full font-medium transition-all duration-200 flex items-center space-x-2 shadow-md hover:shadow-lg">
                    <i class="fas fa-check text-sm"></i>
                    <span>确认</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="px-4 py-4 main-container pb-32">
        <!-- 入库材料列表 -->
        <div class="space-y-4" id="materialsList">
            <!-- 材料卡片将通过JavaScript动态生成 -->
        </div>
    </div>
    
    <!-- 固定底部总计和操作区域 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-40">
        <!-- 总计信息和操作按钮 -->
        <div class="px-4 py-3 safe-area-bottom">
            <div class="flex items-center space-x-3">
                <!-- 入库品种 -->
                <div class="flex-1 bg-orange-50 border border-orange-100 rounded-xl p-2.5">
                    <div class="flex items-center space-x-2.5">
                        <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-cube text-orange-500 text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-xs text-orange-600 font-medium">品种</div>
                            <div class="text-base font-bold text-orange-800 leading-none mt-0.5" id="totalItems">0</div>
                        </div>
                    </div>
                </div>
                <!-- 总价值 -->
                <div class="flex-1 bg-orange-50 border border-orange-100 rounded-xl p-2.5">
                    <div class="flex items-center space-x-2.5">
                        <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-coins text-orange-500 text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-xs text-orange-600 font-medium">价值</div>
                            <div class="text-base font-bold text-orange-800 leading-none mt-0.5" id="totalValue">¥0.00</div>
                        </div>
                    </div>
                </div>
                <!-- 继续添加按钮 -->
                 <button onclick="continueInbound()" class="w-12 h-12 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-medium transition-all duration-200 flex items-center justify-center shadow-sm hover:shadow-md" title="继续添加">
                     <i class="fas fa-plus text-lg"></i>
                 </button>
            </div>
        </div>
    </div>

    <!-- 加载指示器 -->
    <div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">处理中...</p>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div id="toast-container"></div>

    <script>
        // 切换库存详情显示
        function toggleStockDetails(materialId) {
            const detailsDiv = document.getElementById(`stock-details-${materialId}`);
            const iconElement = document.getElementById(`stock-icon-${materialId}`);
            
            if (detailsDiv.classList.contains('hidden')) {
                // 先隐藏所有其他的库存详情
                document.querySelectorAll('[id^="stock-details-"]').forEach(div => {
                    div.classList.add('hidden');
                });
                document.querySelectorAll('[id^="stock-icon-"]').forEach(icon => {
                    icon.classList.remove('rotate-180');
                });
                
                // 显示当前的库存详情
                detailsDiv.classList.remove('hidden');
                iconElement.classList.add('rotate-180');
            } else {
                // 隐藏当前的库存详情
                detailsDiv.classList.add('hidden');
                iconElement.classList.remove('rotate-180');
            }
        }
        
        // 点击其他地方时隐藏库存详情
        document.addEventListener('click', function(event) {
            if (!event.target.closest('[id^="stock-btn-"]') && !event.target.closest('[id^="stock-details-"]')) {
                document.querySelectorAll('[id^="stock-details-"]').forEach(div => {
                    div.classList.add('hidden');
                });
                document.querySelectorAll('[id^="stock-icon-"]').forEach(icon => {
                    icon.classList.remove('rotate-180');
                });
            }
        });
        
        // 返回上一页
        function goBack() {
            window.history.back();
        }

        // 继续添加
        function continueInbound() {
            // 保存当前数据
            localStorage.setItem('pendingInboundData', JSON.stringify(inboundData));
            // 返回选择页面
            window.location.href = 'rukuye-zhuye.html';
        }

        // 确认入库
        function confirmInbound() {
            if (!inboundData || !inboundData.items || inboundData.items.length === 0) {
                showToast('入库列表为空', 'error');
                return;
            }

            // 显示加载指示器
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('confirmBtn').disabled = true;

            // 模拟入库处理
            setTimeout(() => {
                const now = new Date();
                const inboundNo = 'IN' + now.getFullYear() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0') + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                
                // 1. 保存入库记录 (Existing Logic)
                const existingRecords = JSON.parse(localStorage.getItem('inboundRecords') || '[]');
                const newRecord = {
                    id: inboundNo,
                    date: now.toISOString(),
                    warehouse: inboundData.warehouse,
                    warehouseName: inboundData.warehouseName,
                    items: inboundData.items.map(item => ({
                        ...item,
                        price: materialPrices[item.materialId] || 0,
                        shelfLife: materialShelfLife[item.materialId] || 0
                    })),
                    totalValue: parseFloat(document.getElementById('totalValue').textContent.replace('¥', '')),
                    status: 'completed'
                };
                existingRecords.unshift(newRecord);
                localStorage.setItem('inboundRecords', JSON.stringify(existingRecords));

                // 2. 生成原料追溯台账 (New Logic for 5.1.2)
                const traceabilityLedger = JSON.parse(localStorage.getItem('materialTraceRecords') || localStorage.getItem('material_traceability_ledger') || '[]');
                const supplierPresets = JSON.parse(localStorage.getItem('preset_supplier') || '[]');
                
                // Use selected supplier from inboundData or fallback
                const selectedSupplier = inboundData.supplier || (supplierPresets.length > 0 ? supplierPresets[0].name : '未指定供应商');

                inboundData.items.forEach((item, index) => {
                    const material = materials.find(m => m.id === item.materialId);
                    const batchNo = 'MAT' + now.getFullYear() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0') + (index + 1).toString().padStart(3, '0');
                    
                    const ledgerEntry = {
                        materialBatchNumber: batchNo,
                        materialName: material ? material.name : '未知原料',
                        inboundOrderId: inboundNo,
                        inboundDate: now.toISOString().split('T')[0],
                        quantity: item.quantity,
                        unit: item.unit,
                        supplier: {
                            name: selectedSupplier,
                            license: "91110000MA01234567" // Mock license
                        },
                        inspectionStatus: '合格',
                        createdAt: now.toISOString(),
                        // Compatible fields for old pages
                        id: 'TL' + Date.now() + index,
                        inboundNo: inboundNo,
                        batchNo: batchNo,
                        status: '合格',
                        personnel: '库管员A'
                    };
                    traceabilityLedger.unshift(ledgerEntry);
                });
                localStorage.setItem('materialTraceRecords', JSON.stringify(traceabilityLedger));
                // Keep old key for compatibility if needed, or just use new one. 
                // Let's save to both to be safe or just new one if we updated everything.
                // Since I updated taizhang-daochu.html to read from both, it's fine.
                localStorage.setItem('material_traceability_ledger', JSON.stringify(traceabilityLedger));

                // 清除待入库数据
                localStorage.removeItem('pendingInboundData');

                // 隐藏加载指示器
                document.getElementById('loadingIndicator').classList.add('hidden');

                // 显示成功消息
                alert('入库成功！\n已自动生成原料追溯台账。');

                // 跳转到入库主页
                window.location.href = 'rukuye-zhuye.html';
            }, 2000);
        }
        
        // 全局变量
        let selectedItems = [];
        let currentEditingIndex = -1;
        let currentMultiSpecItem = null;
        let currentMaterial = null;
        let mixedInputs = {};
        let conversionTable = {};

        // 快速输入相关函数
        let materialQuickInputCounters = {};
        
        function addQuickInput(materialId) {
            const quickInputContainer = document.getElementById(`quickInputContainer-${materialId}`);
            
            // 为每个材料维护独立的计数器
            if (!materialQuickInputCounters[materialId]) {
                materialQuickInputCounters[materialId] = 0;
            }
            materialQuickInputCounters[materialId]++;
            
            const inputId = `quickInput-${materialId}-${materialQuickInputCounters[materialId]}`;
            
            const material = materials.find(m => m.id === materialId);
            if (!material) return;
            
            const quickInputHtml = `
                <div id="${inputId}" class="quick-input-row mb-2 p-2 bg-gray-50 rounded-lg border border-gray-200 relative animate-fade-in" style="touch-action: pan-x;">
                    <div class="text-xs text-gray-500 mb-2 font-medium flex items-center justify-between">
                        <span>其他规格 #${materialQuickInputCounters[materialId]}</span>
                        <button onclick="removeQuickInput('${inputId}')" class="text-red-400 hover:text-red-600 transition-colors">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2 mb-2">
                        <input type="number" 
                               id="quickQuantity-${inputId}" 
                               placeholder="数量" 
                               class="flex-1 p-1.5 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-orange-500 bg-white"
                               oninput="updateQuickQuantity('${inputId}', ${materialId})">
                        <select id="quickUnit-${inputId}" 
                                class="p-1.5 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-orange-500 bg-white" 
                                onchange="updateQuickQuantity('${inputId}', ${materialId})">
                            ${material.units.map(unit => `<option value="${unit.name}" ${unit.purchaseUnit ? 'selected' : ''}>${unit.name}</option>`).join('')}
                        </select>
                    </div>
                    <div id="quickConversion-${inputId}" class="text-xs text-orange-600 hidden bg-orange-50 p-1.5 rounded border border-orange-100">
                        <i class="fas fa-calculator mr-1"></i>
                        <span id="quickConversionText-${inputId}">换算结果</span>
                    </div>

                </div>
            `;
            
            quickInputContainer.insertAdjacentHTML('beforeend', quickInputHtml);
        }
        
        function removeQuickInput(inputId) {
            const element = document.getElementById(inputId);
            if (element) {
                element.remove();
            }
        }
        
        function updateQuickQuantity(inputId, materialId) {
            const quantityInput = document.getElementById(`quickQuantity-${inputId}`);
            const unitSelect = document.getElementById(`quickUnit-${inputId}`);
            const conversionDiv = document.getElementById(`quickConversion-${inputId}`);
            const conversionText = document.getElementById(`quickConversionText-${inputId}`);
            
            const quantity = parseFloat(quantityInput.value) || 0;
            const selectedUnit = unitSelect.value;
            
            if (quantity > 0 && selectedUnit) {
                const material = materials.find(m => m.id === materialId);
                if (material && material.units) {
                    const unit = material.units.find(u => u.name === selectedUnit);
                    if (unit) {
                        const baseQuantity = quantity * unit.ratio;
                        conversionText.textContent = `${quantity} ${selectedUnit} = ${baseQuantity} ${material.unit}`;
                        conversionDiv.classList.remove('hidden');
                        
                        // 实时更新主输入框
                        const mainQuantityInput = document.getElementById(`quantity-${materialId}`);
                        if (mainQuantityInput) {
                            mainQuantityInput.value = baseQuantity;
                            updateQuantity(materialId, baseQuantity);
                        }
                    } else {
                        conversionDiv.classList.add('hidden');
                    }
                } else {
                    conversionDiv.classList.add('hidden');
                }
            } else {
                conversionDiv.classList.add('hidden');
                // 清空主输入框
                const mainQuantityInput = document.getElementById(`quantity-${materialId}`);
                if (mainQuantityInput) {
                    mainQuantityInput.value = '';
                    updateQuantity(materialId, 0);
                }
            }
        }
        
        // 材料数据（包含多层级单位信息）
        const materials = [
            { 
                id: 1, name: '高筋面粉', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 2500, defaultShelfLife: 365, lastPrice: 8.5,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '袋', level: 2, ratio: 500, purchaseUnit: false },
                    { name: '箱', level: 3, ratio: 10000, purchaseUnit: true }
                ]
            },
            { 
                id: 2, name: '低筋面粉', image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 1800, defaultShelfLife: 365, lastPrice: 7.8,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '袋', level: 2, ratio: 500, purchaseUnit: false },
                    { name: '箱', level: 3, ratio: 10000, purchaseUnit: true }
                ]
            },
            { 
                id: 3, name: '中筋面粉', image: 'https://images.unsplash.com/photo-1628873891973-761b1b8e8c4b?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 1200, defaultShelfLife: 365, lastPrice: 8.0,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '袋', level: 2, ratio: 500, purchaseUnit: false },
                    { name: '箱', level: 3, ratio: 10000, purchaseUnit: true }
                ]
            },
            { 
                id: 4, name: '全麦面粉', image: 'https://images.unsplash.com/photo-1549931319-a545dcf3bc73?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 800, defaultShelfLife: 180, lastPrice: 12.0,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '袋', level: 2, ratio: 500, purchaseUnit: false },
                    { name: '箱', level: 3, ratio: 10000, purchaseUnit: true }
                ]
            },
            { 
                id: 5, name: '杏仁粉', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 300, defaultShelfLife: 90, lastPrice: 45.0,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '包', level: 2, ratio: 100, purchaseUnit: true }
                ]
            },
            { 
                id: 6, name: '椰子粉', image: 'https://images.unsplash.com/photo-1520950237264-6b44f0d4b2b5?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 250, defaultShelfLife: 120, lastPrice: 28.0,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '包', level: 2, ratio: 100, purchaseUnit: true }
                ]
            },
            { 
                id: 7, name: '可可粉', image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 400, defaultShelfLife: 730, lastPrice: 35.0,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '罐', level: 2, ratio: 250, purchaseUnit: true }
                ]
            },
            { 
                id: 8, name: '泡打粉', image: 'https://images.unsplash.com/photo-1571115764595-644a1f56a55c?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 150, defaultShelfLife: 540, lastPrice: 18.0,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '罐', level: 2, ratio: 100, purchaseUnit: true }
                ]
            },
            { 
                id: 9, name: '黄油', image: 'https://images.unsplash.com/photo-1589985270826-4b7bb135bc9d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 800, defaultShelfLife: 30, lastPrice: 25.0,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '块', level: 2, ratio: 250, purchaseUnit: true }
                ]
            },
            { 
                id: 10, name: '植物油', image: 'https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'ml', currentStock: 1500, defaultShelfLife: 365, lastPrice: 12.0,
                units: [
                    { name: 'ml', level: 1, ratio: 1, isBase: true },
                    { name: '瓶', level: 2, ratio: 500, purchaseUnit: true }
                ]
            },
            { 
                id: 11, name: '橄榄油', image: 'https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'ml', currentStock: 500, defaultShelfLife: 730, lastPrice: 35.0,
                units: [
                    { name: 'ml', level: 1, ratio: 1, isBase: true },
                    { name: '瓶', level: 2, ratio: 250, purchaseUnit: true }
                ]
            },
            { 
                id: 12, name: '椰子油', image: 'https://images.unsplash.com/photo-1520950237264-6b44f0d4b2b5?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'ml', currentStock: 300, defaultShelfLife: 365, lastPrice: 28.0,
                units: [
                    { name: 'ml', level: 1, ratio: 1, isBase: true },
                    { name: '瓶', level: 2, ratio: 200, purchaseUnit: true }
                ]
            },
            { 
                id: 13, name: '细砂糖', image: 'https://images.unsplash.com/photo-1559181567-c3190ca9959b?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 2000, defaultShelfLife: 1095, lastPrice: 6.0,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '袋', level: 2, ratio: 1000, purchaseUnit: true }
                ]
            },
            { 
                id: 14, name: '红糖', image: 'https://images.unsplash.com/photo-1571115764595-644a1f56a55c?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 800, defaultShelfLife: 730, lastPrice: 8.5,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '袋', level: 2, ratio: 500, purchaseUnit: true }
                ]
            },
            { 
                id: 15, name: '糖粉', image: 'https://images.unsplash.com/photo-1559181567-c3190ca9959b?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 600, defaultShelfLife: 1095, lastPrice: 7.2,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '袋', level: 2, ratio: 500, purchaseUnit: true }
                ]
            },
            { 
                id: 16, name: '蜂蜜', image: 'https://images.unsplash.com/photo-1587049352846-4a222e784d38?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'ml', currentStock: 400, defaultShelfLife: 1095, lastPrice: 45.0,
                units: [
                    { name: 'ml', level: 1, ratio: 1, isBase: true },
                    { name: '瓶', level: 2, ratio: 500, purchaseUnit: true }
                ]
            },
            { 
                id: 17, name: '枫糖浆', image: 'https://images.unsplash.com/photo-1571115764595-644a1f56a55c?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'ml', currentStock: 200, defaultShelfLife: 365, lastPrice: 65.0,
                units: [
                    { name: 'ml', level: 1, ratio: 1, isBase: true },
                    { name: '瓶', level: 2, ratio: 250, purchaseUnit: true }
                ]
            },
            { 
                id: 18, name: '鸡蛋', image: 'https://images.unsplash.com/photo-1518569656558-1f25e69d93d7?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: '个', currentStock: 50, defaultShelfLife: 21, lastPrice: 1.2,
                units: [
                    { name: '个', level: 1, ratio: 1, isBase: true },
                    { name: '盒', level: 2, ratio: 12, purchaseUnit: true }
                ]
            },
            { 
                id: 19, name: '蛋黄', image: 'https://images.unsplash.com/photo-1518569656558-1f25e69d93d7?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: '个', currentStock: 20, defaultShelfLife: 3, lastPrice: 0.8,
                units: [
                    { name: '个', level: 1, ratio: 1, isBase: true }
                ]
            },
            { 
                id: 20, name: '牛奶', image: 'https://images.unsplash.com/photo-1550583724-b2692b85b150?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'ml', currentStock: 1000, defaultShelfLife: 7, lastPrice: 0.012,
                units: [
                    { name: 'ml', level: 1, ratio: 1, isBase: true },
                    { name: '盒', level: 2, ratio: 250, purchaseUnit: true }
                ]
            },
            { 
                id: 21, name: '淡奶油', image: 'https://images.unsplash.com/photo-1550583724-b2692b85b150?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'ml', currentStock: 500, defaultShelfLife: 14, lastPrice: 0.025,
                units: [
                    { name: 'ml', level: 1, ratio: 1, isBase: true },
                    { name: '罐', level: 2, ratio: 1000, purchaseUnit: false },
                    { name: '箱', level: 3, ratio: 12000, purchaseUnit: true }
                ]
            },
            { 
                id: 22, name: '酸奶', image: 'https://images.unsplash.com/photo-1571212515416-ffa0c0cd2adf?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'ml', currentStock: 300, defaultShelfLife: 14, lastPrice: 0.018,
                units: [
                    { name: 'ml', level: 1, ratio: 1, isBase: true },
                    { name: '杯', level: 2, ratio: 200, purchaseUnit: true }
                ]
            },
            { 
                id: 23, name: '奶油奶酪', image: 'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 200, defaultShelfLife: 30, lastPrice: 35.0,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '块', level: 2, ratio: 250, purchaseUnit: true }
                ]
            },
            { 
                id: 24, name: '马斯卡彭', image: 'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', 
                unit: 'g', currentStock: 150, defaultShelfLife: 14, lastPrice: 55.0,
                units: [
                    { name: 'g', level: 1, ratio: 1, isBase: true },
                    { name: '盒', level: 2, ratio: 250, purchaseUnit: true }
                ]
            }
        ];
        
        let inboundData = null;
        let materialPrices = {};
        let materialShelfLife = {};
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadInboundData();
        });
        
        // 加载入库数据
        function loadInboundData() {
            const pendingData = localStorage.getItem('pendingInboundData');
            if (!pendingData) {
                showToast('没有找到入库数据，返回入库页面', 'error');
                setTimeout(() => {
                    window.location.href = 'rukuye-zhuye.html';
                }, 2000);
                return;
            }
            
            try {
                inboundData = JSON.parse(pendingData);
                document.getElementById('warehouseInfo').textContent = `入库到: ${inboundData.warehouseName}`;
                renderMaterialsList();
                calculateTotal();
            } catch (error) {
                console.error('解析入库数据失败:', error);
                showToast('入库数据格式错误', 'error');
            }
        }
        
        // 渲染材料列表
        function renderMaterialsList() {
            const container = document.getElementById('materialsList');
            if (!container) {
                console.error('materialsList容器未找到');
                return;
            }
            container.innerHTML = '';
            
            inboundData.items.forEach((item, index) => {
                const material = materials.find(m => m.id === item.materialId);
                if (!material) return;
                
                // 初始化价格和保质期
                if (!materialPrices[material.id]) {
                    materialPrices[material.id] = material.lastPrice;
                }
                if (!materialShelfLife[material.id]) {
                    materialShelfLife[material.id] = material.defaultShelfLife;
                }
                
                const afterStock = material.currentStock + item.quantity;
                const subtotal = (materialPrices[material.id] * item.quantity).toFixed(2);
                
                // 计算到期日期
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + materialShelfLife[material.id]);
                const expiryDateStr = expiryDate.toISOString().split('T')[0];
                
                // 获取保质期状态
                const shelfLifeStatus = getShelfLifeStatus(materialShelfLife[material.id]);
                
                const cardHtml = `
                    <div class="material-card bg-white rounded-xl shadow-sm border border-gray-100 p-3 relative" id="card-${material.id}">
                        <!-- 删除按钮 - 右上角 -->
                        <button onclick="removeMaterial(${material.id})" class="absolute -top-2 -right-2 w-7 h-7 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-110 z-10" title="删除材料">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                        
                        <!-- 材料信息和金额整体显示框 -->
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-lg p-3 mb-3">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="flex-shrink-0 w-12 h-12 bg-orange-50 rounded-lg overflow-hidden border border-orange-100">
                                    <img src="${material.image}" alt="${material.name}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="text-base font-semibold text-gray-900 truncate">${material.name}</h3>
                                            <div class="flex-shrink-0 relative">
                                                <button onclick="toggleStockDetails(${material.id})" 
                                                        class="text-sm text-gray-500 hover:bg-orange-50 hover:text-orange-600 px-2 py-1 rounded transition-colors flex items-center space-x-1"
                                                        id="stock-btn-${material.id}">
                                                    <span>库存 ${material.currentStock} ${material.unit}</span>
                                                    <i class="fas fa-chevron-down text-xs transition-transform" id="stock-icon-${material.id}"></i>
                                                </button>
                                                <div class="hidden absolute z-20 mt-1 bg-white border border-gray-100 rounded-lg shadow-xl p-3 text-xs stock-details min-w-[150px]" 
                                                     id="stock-details-${material.id}">
                                                    <div class="text-gray-400 mb-2 font-medium">详细库存变化</div>
                                                    <div class="space-y-1">
                                                        <div class="flex justify-between">
                                                            <span class="text-gray-600">当前：</span>
                                                            <span class="font-bold text-gray-800">${material.currentStock} ${material.unit}</span>
                                                        </div>
                                                        <div class="flex justify-between border-t border-gray-100 pt-1 mt-1">
                                                            <span class="text-gray-600">入库后：</span>
                                                            <span class="font-bold text-green-500">${afterStock} ${material.unit}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-gray-500 mb-1">小计金额</div>
                                            <div class="text-lg font-bold text-orange-600" id="subtotal-${material.id}">¥${subtotal}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 价格和保质期设置 -->
                            <div class="grid grid-cols-2 gap-2">
                                <!-- 价格设置 -->
                                <div class="bg-white border border-gray-200 rounded-lg p-2">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs font-medium text-gray-600 flex items-center">
                                            <i class="fas fa-tag mr-1 text-orange-400"></i>价格
                                        </span>
                                        <span class="text-xs text-gray-400">¥/${item.unit}</span>
                                    </div>
                                    <input type="number" 
                                           class="w-full px-2 py-1 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 bg-gray-50" 
                                           value="${materialPrices[material.id]}" 
                                           min="0" 
                                           step="0.01"
                                           id="price-${material.id}"
                                           onchange="updatePrice(${material.id}, this.value)">
                                </div>
                                
                                <!-- 保质期设置 -->
                                <div class="bg-white border border-gray-200 rounded-lg p-2">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs font-medium text-gray-600 flex items-center">
                                            <i class="fas fa-hourglass-half mr-1 text-orange-400"></i>保质期
                                        </span>
                                        <span class="text-xs">${shelfLifeStatus.icon}</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <button type="button" class="flex-1 px-2 py-1 text-xs font-medium text-gray-700 bg-gray-50 border border-gray-200 rounded-md hover:bg-gray-100 focus:outline-none focus:border-orange-500 transition-colors truncate" id="expiry-display-${material.id}" onclick="openDatePicker(${material.id})">
                                            <i class="fas fa-calendar-alt mr-1 text-gray-400"></i>${expiryDateStr}
                                        </button>
                                        <div class="px-1 py-1 text-xs text-gray-600 bg-gray-50 border border-gray-200 rounded-md min-w-[40px] text-center" id="shelflife-display-${material.id}">
                                            ${materialShelfLife[material.id]}天
                                        </div>
                                    </div>
                                    <input type="date" 
                                           class="hidden" 
                                           value="${expiryDateStr}"
                                           id="expiry-${material.id}"
                                           onchange="updateExpiryDate(${material.id}, this.value)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 数量步进器和单位选择 -->
                        <div class="flex items-center justify-between mb-1.5 gap-2">
                            <div class="flex items-center flex-1 bg-gray-50 rounded-lg p-1 border border-gray-200">
                                <button onclick="adjustQuantity(${material.id}, -1)" class="w-7 h-7 bg-white text-gray-500 rounded-md flex items-center justify-center shadow-sm hover:text-orange-600 active:scale-95 transition-all">
                                    <i class="fas fa-minus text-xs"></i>
                                </button>
                                <input type="number" 
                                       class="quantity-input flex-1 mx-1 bg-transparent border-none text-sm font-bold text-gray-800 focus:ring-0 p-0" 
                                       id="quantity-${material.id}" 
                                       value="${item.quantity}" 
                                       min="0" 
                                       onchange="updateQuantity(${material.id}, this.value)"
                                       onfocus="this.select()"
                                       placeholder="0">
                                <button onclick="adjustQuantity(${material.id}, 1)" class="w-7 h-7 bg-white text-gray-500 rounded-md flex items-center justify-center shadow-sm hover:text-orange-600 active:scale-95 transition-all">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                            <select id="unit-${material.id}" class="text-xs text-gray-600 bg-gray-50 border border-gray-200 rounded-lg px-2 py-0 h-[36px] focus:outline-none focus:border-orange-300 min-w-[60px]" onchange="updateUnit(${material.id}, this.value)">
                                ${material.units.map(unit => `<option value="${unit.name}" ${unit.name === item.unit ? 'selected' : ''}>${unit.name}</option>`).join('')}
                            </select>
                            
                            <!-- 多规格按钮 (内联) -->
                            <button onclick="addQuickInput(${item.materialId})" class="flex items-center justify-center w-[36px] h-[36px] bg-orange-50 text-orange-500 rounded-lg border border-orange-100 hover:bg-orange-100 transition-colors flex-shrink-0" title="添加其他规格">
                                <i class="fas fa-plus-circle text-base"></i>
                            </button>
                        </div>
                        
                        <!-- 多规格快速输入容器 -->
                        <div id="quickInputContainer-${item.materialId}" class="mt-1">
                            <!-- 快速输入框将动态添加到这里 -->
                        </div>
                    </div>
                `;
                
                container.innerHTML += cardHtml;
            });
        }
        
        // 更新价格
        function updatePrice(materialId, price) {
            materialPrices[materialId] = parseFloat(price) || 0;
            
            // 更新小计
            const item = inboundData.items.find(item => item.materialId === materialId);
            if (item) {
                const subtotal = (materialPrices[materialId] * item.quantity).toFixed(2);
                document.getElementById(`subtotal-${materialId}`).textContent = `¥${subtotal}`;
            }
            
            calculateTotal();
        }
        
        // 更新保质期天数
        function updateShelfLife(materialId, days) {
            materialShelfLife[materialId] = parseInt(days) || 1;
            
            // 更新到期日期
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + materialShelfLife[materialId]);
            const expiryDateStr = expiryDate.toISOString().split('T')[0];
            document.getElementById(`expiry-${materialId}`).value = expiryDateStr;
            
            // 更新显示的到期日期
                const expiryDisplay = document.getElementById(`expiry-display-${materialId}`);
                if (expiryDisplay) {
                    expiryDisplay.innerHTML = `<i class="fas fa-calendar-alt mr-1"></i>${expiryDateStr}`;
                }
            
            // 更新保质期状态
            updateShelfLifeStatus(materialId);
        }
        
        // 更新到期日期
        function updateExpiryDate(materialId, dateStr) {
            const expiryDate = new Date(dateStr);
            const today = new Date();
            const diffTime = expiryDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays > 0) {
                materialShelfLife[materialId] = diffDays;
                
                // 更新显示的到期日期
                const expiryDisplay = document.getElementById(`expiry-display-${materialId}`);
                if (expiryDisplay) {
                    expiryDisplay.innerHTML = `<i class="fas fa-calendar-alt mr-1"></i>${dateStr}`;
                }
                
                // 更新显示的剩余天数
                const shelfLifeDisplay = document.getElementById(`shelflife-display-${materialId}`);
                if (shelfLifeDisplay) {
                    shelfLifeDisplay.textContent = `${diffDays}天`;
                }
                
                updateShelfLifeStatus(materialId);
            }
        }
        
        // 打开日期选择器
        function openDatePicker(materialId) {
            const hiddenInput = document.getElementById(`expiry-${materialId}`);
            const triggerButton = document.getElementById(`expiry-display-${materialId}`);
            if (hiddenInput && triggerButton) {
                // 获取触发按钮的位置
                const buttonRect = triggerButton.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                
                // 创建临时日期输入框
                const tempInput = document.createElement('input');
                tempInput.type = 'date';
                tempInput.value = hiddenInput.value;
                
                // 计算最佳位置（在按钮下方，如果空间不够则在上方）
                const viewportHeight = window.innerHeight;
                const spaceBelow = viewportHeight - buttonRect.bottom;
                const spaceAbove = buttonRect.top;
                const datePickerHeight = 300; // 估计的日期选择器高度
                
                let top, left;
                if (spaceBelow >= datePickerHeight || spaceBelow >= spaceAbove) {
                    // 在按钮下方显示
                    top = buttonRect.bottom + scrollTop + 5;
                } else {
                    // 在按钮上方显示
                    top = buttonRect.top + scrollTop - datePickerHeight - 5;
                }
                
                // 水平居中对齐按钮，但确保不超出屏幕
                left = Math.max(10, Math.min(
                    buttonRect.left + scrollLeft + (buttonRect.width / 2) - 150,
                    window.innerWidth - 310
                ));
                
                tempInput.style.cssText = `
                    position: absolute;
                    top: ${top}px;
                    left: ${left}px;
                    z-index: 9999;
                    width: 300px;
                    height: auto;
                    padding: 8px;
                    border: 2px solid #ff9f43;
                    border-radius: 8px;
                    background: white;
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                    font-size: 16px;
                `;
                
                document.body.appendChild(tempInput);
                
                // 监听日期变化
                const handleChange = () => {
                    if (tempInput.value) {
                        updateExpiryDate(materialId, tempInput.value);
                    }
                    cleanup();
                };
                
                // 监听取消操作 - 延迟处理，避免立即触发
                const handleCancel = () => {
                    setTimeout(() => {
                        cleanup();
                    }, 100);
                };
                
                // 清理函数
                const cleanup = () => {
                    if (document.body.contains(tempInput)) {
                        document.body.removeChild(tempInput);
                    }
                    tempInput.removeEventListener('change', handleChange);
                    tempInput.removeEventListener('blur', handleCancel);
                    document.removeEventListener('keydown', handleKeydown);
                };
                
                // ESC键取消
                const handleKeydown = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                    }
                };
                
                tempInput.addEventListener('change', handleChange);
                tempInput.addEventListener('blur', handleCancel);
                document.addEventListener('keydown', handleKeydown);
                
                // 立即触发日期选择器
                setTimeout(() => {
                    tempInput.focus();
                    // 尝试多种方式触发日期选择器
                    if (tempInput.showPicker) {
                        try {
                            tempInput.showPicker();
                        } catch (e) {
                            // 如果showPicker失败，尝试点击
                            tempInput.click();
                        }
                    } else {
                        // 浏览器不支持showPicker，使用点击
                        tempInput.click();
                    }
                }, 50);
            }
        }
        
        // 更新保质期状态显示
        function updateShelfLifeStatus(materialId) {
            const status = getShelfLifeStatus(materialShelfLife[materialId]);
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + materialShelfLife[materialId]);
            const expiryDateStr = expiryDate.toISOString().split('T')[0];
            
            const statusElement = document.getElementById(`shelf-status-${materialId}`);
            if (statusElement) {
                statusElement.innerHTML = `
                    <i class="fas fa-info-circle mr-1"></i>
                    <span>${status.icon} ${status.text} (${expiryDateStr} 到期)</span>
                `;
            }
        }
        
        // 获取保质期状态
        function getShelfLifeStatus(days) {
            if (days <= 3) {
                return { icon: '🚨', text: '极短保质期', color: 'red' };
            } else if (days <= 7) {
                return { icon: '⚠️', text: '短期保质期', color: 'orange' };
            } else if (days <= 30) {
                return { icon: '📅', text: '中期保质期', color: 'yellow' };
            } else if (days <= 180) {
                return { icon: '📆', text: '', color: 'green' };
            } else {
                return { icon: '🔒', text: '', color: 'orange' };
            }
        }
        
        // 计算总计
        function calculateTotal() {
            let totalValue = 0;
            const totalItems = inboundData.items.length;
            
            inboundData.items.forEach(item => {
                const price = materialPrices[item.materialId] || 0;
                totalValue += price * item.quantity;
            });
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalValue').textContent = `¥${totalValue.toFixed(2)}`;
        }
        
        // 调整数量
        function adjustQuantity(materialId, change) {
            const input = document.getElementById(`quantity-${materialId}`);
            if (!input) return;
            
            let currentValue = parseFloat(input.value) || 0;
            let newValue = Math.max(0, currentValue + change);
            
            input.value = newValue;
            updateQuantity(materialId, newValue);
            
            // 添加视觉反馈
            if (Math.abs(change) >= 1) {
                input.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    input.style.transform = 'scale(1)';
                }, 200);
            }
        }
        
        // 更新数量
        function updateQuantity(materialId, quantity) {
            const newQuantity = Math.max(0, parseFloat(quantity) || 0);
            
            // 更新入库数据中的数量
            const itemIndex = inboundData.items.findIndex(item => item.materialId === materialId);
            if (itemIndex !== -1) {
                inboundData.items[itemIndex].quantity = newQuantity;
                
                // 如果数量为0，询问是否删除
                if (newQuantity === 0) {
                    if (confirm('数量为0，是否删除该材料？')) {
                        removeMaterial(materialId);
                        return;
                    } else {
                        // 恢复为1
                        inboundData.items[itemIndex].quantity = 1;
                        document.getElementById(`quantity-${materialId}`).value = 1;
                    }
                }
                
                // 更新localStorage
                localStorage.setItem('pendingInboundData', JSON.stringify(inboundData));
                
                // 更新小计显示
                const price = materialPrices[materialId] || 0;
                const subtotal = (price * inboundData.items[itemIndex].quantity).toFixed(2);
                const subtotalElement = document.getElementById(`subtotal-${materialId}`);
                if (subtotalElement) {
                    subtotalElement.textContent = `¥${subtotal}`;
                }
                
                // 重新计算总计
                calculateTotal();
            }
        }

        // 更新单位
        function updateUnit(materialId, newUnit) {
            const itemIndex = inboundData.items.findIndex(item => item.materialId === materialId);
            if (itemIndex === -1) return;
            
            const item = inboundData.items[itemIndex];
            item.unit = newUnit;
            
            localStorage.setItem('pendingInboundData', JSON.stringify(inboundData));
            renderMaterialsList();
        }
        
        // Toast提示功能
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transition-all duration-300 transform translate-x-full shadow-lg flex items-center space-x-2`;
            
            let icon = '';
            switch(type) {
                case 'success':
                    toast.classList.add('bg-green-500');
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    toast.classList.add('bg-red-500');
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'warning':
                    toast.classList.add('bg-orange-500');
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                default:
                    toast.classList.add('bg-blue-500');
                    icon = '<i class="fas fa-info-circle"></i>';
            }
            
            toast.innerHTML = `${icon}<span>${message}</span>`;
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // 移除材料
        function removeMaterial(materialId) {
            if (confirm('确定要移除这个材料吗？')) {
                const itemIndex = inboundData.items.findIndex(item => item.materialId === materialId);
                if (itemIndex !== -1) {
                    inboundData.items.splice(itemIndex, 1);
                    
                    // 更新localStorage
                    localStorage.setItem('pendingInboundData', JSON.stringify(inboundData));
                    
                    // 重新渲染
                    renderMaterialsList();
                    calculateTotal();
                    
                    // 如果没有材料了，返回上一页
                    if (inboundData.items.length === 0) {
                        showToast('入库列表为空，返回选择页面', 'warning');
                        setTimeout(() => goBack(), 1000);
                    }
                }
            }
        }
    </script>
</body>
</html>