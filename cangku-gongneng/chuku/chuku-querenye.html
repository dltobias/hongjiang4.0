<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出库确认 - 烘匠 BakeManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        orange: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            200: '#fed7aa',
                            300: '#fdba74',
                            400: '#fb923c',
                            500: '#f97316',
                            600: '#ea580c',
                            700: '#c2410c',
                            800: '#9a3412',
                            900: '#7c2d12',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Cookpad Design System */
        :root {
            --primary-orange: #ff9f43;
            --primary-dark: #ff8c00;
            --text-main: #333333;
            --text-sub: #8b8b8b;
            --bg-light: #f7f7f5;
            --bg-white: #ffffff;
        }

        .gradient-primary {
            background: linear-gradient(135deg, #ff9f43 0%, #ff8c00 100%);
        }
        
        .price-input {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: white;
        }
        
        .price-input:focus {
            outline: none;
            border-color: #ff9f43;
            background: #fff7ed;
            box-shadow: 0 0 0 3px rgba(255, 159, 67, 0.1);
        }
        
        .material-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background: #ffffff;
            border: 1px solid #f0f0f0;
        }
        
        .material-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 140, 0, 0.1);
            border-color: #ffedd5;
        }
        
        /* 材料图片样式 */
        .material-image {
            transition: all 0.3s ease;
        }
        
        .material-card:hover .material-image {
            transform: scale(1.05);
        }
        
        /* 数量输入框样式 */
        .quantity-input {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            background: white;
            height: 32px;
            min-width: 60px;
        }
        
        .quantity-input:focus {
            outline: none;
            border-color: #ff9f43;
            background: #fff7ed;
            box-shadow: 0 0 0 3px rgba(255, 159, 67, 0.1);
        }

        /* 防止横向滚动 */
        body {
            overflow-x: hidden;
            max-width: 100vw;
            background-color: #f7f7f5;
        }
        
        .main-container {
            max-width: 100vw;
            overflow-x: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff9f43 0%, #ff8c00 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.3);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(255, 140, 0, 0.4);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 顶部导航栏 - Cookpad 风格 -->
    <div class="bg-white px-4 py-3 shadow-sm border-b border-gray-100 sticky top-0 z-30">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="goBack()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-all text-gray-600">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div>
                    <div class="text-lg font-bold text-gray-800 tracking-wide">出库确认</div>
                    <div class="text-xs text-gray-500 font-medium mt-0.5" id="warehouseInfo">请确认出库信息</div>
                </div>
            </div>
            <div class="flex items-center">
                <button onclick="confirmOutbound()" id="confirmBtn" class="px-4 py-2 bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white rounded-full font-medium transition-all duration-200 flex items-center space-x-2 shadow-md hover:shadow-lg">
                    <i class="fas fa-check text-sm"></i>
                    <span>确认</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="px-4 py-4 main-container pb-32">
        <!-- 出库材料列表 -->
        <div class="space-y-4" id="materialsList">
            <!-- 材料卡片将通过JavaScript动态生成 -->
        </div>
    </div>
    
    <!-- 固定底部总计和操作区域 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-40">
        <!-- 总计信息和操作按钮 -->
        <div class="px-4 py-3 safe-area-bottom">
            <div class="flex items-center space-x-3">
                <!-- 出库品种 -->
                <div class="flex-1 bg-orange-50 border border-orange-100 rounded-xl p-2.5">
                    <div class="flex items-center space-x-2.5">
                        <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-cube text-orange-500 text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-xs text-orange-600 font-medium">品种</div>
                            <div class="text-base font-bold text-orange-800 leading-none mt-0.5" id="totalItems">0</div>
                        </div>
                    </div>
                </div>
                <!-- 总价值 -->
                <div class="flex-1 bg-orange-50 border border-orange-100 rounded-xl p-2.5">
                    <div class="flex items-center space-x-2.5">
                        <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-coins text-orange-500 text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-xs text-orange-600 font-medium">价值</div>
                            <div class="text-base font-bold text-orange-800 leading-none mt-0.5" id="totalValue">¥0.00</div>
                        </div>
                    </div>
                </div>
                <!-- 继续添加按钮 -->
                 <button onclick="continueOutbound()" class="w-12 h-12 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-medium transition-all duration-200 flex items-center justify-center shadow-sm hover:shadow-md" title="继续添加">
                     <i class="fas fa-plus text-lg"></i>
                 </button>
            </div>
        </div>
    </div>

    <!-- 加载指示器 -->
    <div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">处理中...</p>
        </div>
    </div>

    <script>
        // 全局变量
        let outboundData = null;
        let materials = [];
        
        // 返回上一页
        function goBack() {
            window.history.back();
        }

        
        // 快速输入相关函数
        let materialQuickInputCounters = {};
        
        function addQuickInput(materialId) {
            const quickInputContainer = document.getElementById(`quickInputContainer-${materialId}`);
            
            // 为每个材料维护独立的计数器
            if (!materialQuickInputCounters[materialId]) {
                materialQuickInputCounters[materialId] = 0;
            }
            materialQuickInputCounters[materialId]++;
            
            const inputId = `quickInput-${materialId}-${materialQuickInputCounters[materialId]}`;
            
            const material = materials.find(m => m.id === materialId);
            if (!material) return;
            
            const quickInputHtml = `
                <div id="${inputId}" class="quick-input-row mb-2 p-2 bg-orange-50 rounded-lg border border-orange-100 relative" style="touch-action: pan-x;">
                    <div class="text-xs text-orange-700 mb-2 font-medium flex items-center justify-between">
                        <span>其他规格 #${materialQuickInputCounters[materialId]}</span>
                        <button onclick="removeQuickInput('${inputId}')" class="text-red-500 hover:text-red-700 transition-colors">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2 mb-2">
                        <input type="number" 
                               id="quickQuantity-${inputId}" 
                               placeholder="数量" 
                               class="flex-1 p-1.5 border border-orange-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-orange-500 bg-white"
                               oninput="updateQuickQuantity('${inputId}', ${materialId})">
                        <select id="quickUnit-${inputId}" 
                                class="p-1.5 border border-orange-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-orange-500 bg-white" 
                                onchange="updateQuickQuantity('${inputId}', ${materialId})">
                            ${material.units.map(unit => `<option value="${unit.name}" ${unit.purchaseUnit ? 'selected' : ''}>${unit.name}</option>`).join('')}
                        </select>
                    </div>
                    <div id="quickConversion-${inputId}" class="text-xs text-orange-600 hidden">
                        <i class="fas fa-calculator mr-1"></i>
                        <span id="quickConversionText-${inputId}">换算结果</span>
                    </div>
                </div>
            `;
            
            quickInputContainer.insertAdjacentHTML('beforeend', quickInputHtml);
        }
        
        function removeQuickInput(inputId) {
            const element = document.getElementById(inputId);
            if (element) {
                element.remove();
            }
        }
        
        function updateQuickQuantity(inputId, materialId) {
            const quantityInput = document.getElementById(`quickQuantity-${inputId}`);
            const unitSelect = document.getElementById(`quickUnit-${inputId}`);
            const conversionDiv = document.getElementById(`quickConversion-${inputId}`);
            const conversionText = document.getElementById(`quickConversionText-${inputId}`);
            
            const quantity = parseFloat(quantityInput.value) || 0;
            const selectedUnit = unitSelect.value;
            
            if (quantity > 0 && selectedUnit) {
                const material = materials.find(m => m.id === materialId);
                if (material && material.units) {
                    const unit = material.units.find(u => u.name === selectedUnit);
                    if (unit) {
                        const baseQuantity = quantity * unit.ratio;
                        conversionText.textContent = `${quantity} ${selectedUnit} = ${baseQuantity} ${material.unit}`;
                        conversionDiv.classList.remove('hidden');
                        
                        // 找到对应的出库项目并更新数量
                        const outboundItem = outboundData.items.find(item => item.materialId === materialId);
                        if (outboundItem) {
                            const itemIndex = outboundData.items.indexOf(outboundItem);
                            const mainQuantityInput = document.getElementById(`quantity-${itemIndex}`);
                            if (mainQuantityInput) {
                                mainQuantityInput.value = baseQuantity;
                                updateQuantity(itemIndex, baseQuantity);
                            }
                        }
                    }
                }
            } else {
                conversionDiv.classList.add('hidden');
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadOutboundData();
            loadMaterialsData();
            renderMaterials();
            updateSummary();
        });

        // 加载出库数据
        function loadOutboundData() {
            try {
                const savedData = localStorage.getItem('pendingOutboundData');
                if (!savedData) {
                    showToast('未找到出库数据，请重新选择材料', 'warning');
                    setTimeout(() => goBack(), 2000);
                    return false;
                }
                
                outboundData = JSON.parse(savedData);
                
                // 数据验证
                if (!outboundData || !outboundData.items || !Array.isArray(outboundData.items)) {
                    showToast('出库数据格式错误', 'error');
                    return false;
                }
                
                // 数据兼容性处理：将旧格式的id字段转换为materialId
                let hasUpdated = false;
                outboundData.items.forEach(item => {
                    if (item.id && !item.materialId) {
                        item.materialId = item.id;
                        delete item.id;
                        hasUpdated = true;
                    }
                    
                    // 确保必要字段存在
                    if (!item.quantity) item.quantity = 0;
                    if (!item.price) item.price = 0;
                });
                
                // 如果有更新，保存数据
                if (hasUpdated) {
                    localStorage.setItem('pendingOutboundData', JSON.stringify(outboundData));
                    showToast('数据格式已自动更新', 'info');
                }
                
                // 更新仓库信息
                const warehouseElement = document.getElementById('warehouseInfo');
                if (warehouseElement && outboundData.warehouseName) {
                    warehouseElement.textContent = `从 ${outboundData.warehouseName} 出库`;
                }
                
                return true;
            } catch (error) {
                console.error('加载出库数据失败:', error);
                showToast('数据加载失败，请重新操作', 'error');
                return false;
            }
        }

        // 加载材料数据
        function loadMaterialsData() {
            try {
                // 尝试从localStorage获取缓存的材料数据
                const cachedMaterials = localStorage.getItem('materialsCache');
                const cacheTime = localStorage.getItem('materialsCacheTime');
                const now = Date.now();
                
                // 如果缓存存在且未过期（1小时）
                if (cachedMaterials && cacheTime && (now - parseInt(cacheTime)) < 3600000) {
                    materials = JSON.parse(cachedMaterials);
                    showToast('材料数据加载成功', 'success');
                    return true;
                }
                
                // 使用模拟数据（实际项目中应该从API获取）
                materials = [
                {
                    id: 1,
                    name: '高筋面粉',
                    category: 'flour',
                    image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=100&h=100&fit=crop',
                    unit: 'kg',
                    currentStock: 50,

                    price: 8.5,
                    supplier: '金龙鱼',
                    description: '优质高筋面粉，适合制作面包',
                    units: [
                        { name: 'kg', ratio: 1, level: 1 },
                        { name: 'g', ratio: 0.001, level: 2 },
                        { name: '包', ratio: 5, level: 2 },
                        { name: '箱', ratio: 50, level: 3 }
                    ]
                },
                {
                    id: 2,
                    name: '低筋面粉',
                    category: 'flour',
                    image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=100&h=100&fit=crop',
                    unit: 'kg',
                    currentStock: 30,
                    defaultShelfLife: 365,
                    price: 7.8,
                    supplier: '金龙鱼',
                    description: '优质低筋面粉，适合制作蛋糕',
                    units: [
                        { name: 'kg', ratio: 1, level: 1 },
                        { name: 'g', ratio: 0.001, level: 2 },
                        { name: '包', ratio: 5, level: 2 },
                        { name: '箱', ratio: 50, level: 3 }
                    ]
                },
                {
                    id: 3,
                    name: '细砂糖',
                    category: 'sugar',
                    image: 'https://images.unsplash.com/photo-1559181567-c3190ca9959b?w=100&h=100&fit=crop',
                    unit: 'kg',
                    currentStock: 25,

                    price: 6.2,
                    supplier: '太古糖业',
                    description: '纯正细砂糖，烘焙必备',
                    units: [
                        { name: 'kg', ratio: 1, level: 1 },
                        { name: 'g', ratio: 0.001, level: 2 },
                        { name: '袋', ratio: 25, level: 2 }
                    ]
                },
                {
                    id: 4,
                    name: '黄油',
                    category: 'dairy',
                    image: 'https://images.unsplash.com/photo-1589985270826-4b7bb135bc9d?w=100&h=100&fit=crop',
                    unit: 'kg',
                    currentStock: 15,

                    price: 45.0,
                    supplier: '安佳',
                    description: '新西兰进口黄油，香味浓郁',
                    units: [
                        { name: 'kg', ratio: 1, level: 1 },
                        { name: 'g', ratio: 0.001, level: 2 },
                        { name: '块', ratio: 0.25, level: 2 }
                    ]
                },
                {
                    id: 5,
                    name: '鸡蛋',
                    category: 'dairy',
                    image: 'https://images.unsplash.com/photo-1582722872445-44dc5f7e3c8f?w=100&h=100&fit=crop',
                    unit: '个',
                    currentStock: 200,

                    price: 0.8,
                    supplier: '德青源',
                    description: '新鲜鸡蛋，营养丰富',
                    units: [
                        { name: '个', ratio: 1, level: 1 },
                        { name: '打', ratio: 12, level: 2 },
                        { name: '箱', ratio: 360, level: 3 }
                    ]
                },
                {
                    id: 6,
                    name: '牛奶',
                    category: 'dairy',
                    image: 'https://images.unsplash.com/photo-1550583724-b2692b85b150?w=100&h=100&fit=crop',
                    unit: 'L',
                    currentStock: 40,

                    price: 12.5,
                    supplier: '蒙牛',
                    description: '纯牛奶，口感醇厚',
                    units: [
                        { name: 'L', ratio: 1, level: 1 },
                        { name: 'ml', ratio: 0.001, level: 2 },
                        { name: '盒', ratio: 1, level: 2 },
                        { name: '箱', ratio: 12, level: 3 }
                    ]
                },
                {
                    id: 7,
                    name: '可可粉',
                    category: 'flavor',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=100&h=100&fit=crop',
                    unit: 'kg',
                    currentStock: 8,

                    price: 35.0,
                    supplier: '好时',
                    description: '纯可可粉，巧克力风味',
                    units: [
                        { name: 'kg', ratio: 1, level: 1 },
                        { name: 'g', ratio: 0.001, level: 2 },
                        { name: '罐', ratio: 0.5, level: 2 }
                    ]
                },
                {
                    id: 8,
                    name: '香草精',
                    category: 'flavor',
                    image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=100&h=100&fit=crop',
                    unit: 'ml',
                    currentStock: 12,

                    price: 25.0,
                    supplier: '麦德龙',
                    description: '天然香草精，提升风味',
                    units: [
                        { name: 'ml', ratio: 1, level: 1 },
                        { name: '瓶', ratio: 100, level: 2 }
                    ]
                },
                {
                    id: 9,
                    name: '泡打粉',
                    category: 'additive',
                    image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=100&h=100&fit=crop',
                    unit: 'g',
                    currentStock: 500,
                    defaultShelfLife: 365,
                    price: 0.05,
                    supplier: '安琪',
                    description: '优质泡打粉，蓬松效果好',
                    units: [
                        { name: 'g', ratio: 1, level: 1 },
                        { name: 'kg', ratio: 1000, level: 2 },
                        { name: '包', ratio: 100, level: 2 }
                    ]
                },
                {
                    id: 10,
                    name: '酵母',
                    category: 'additive',
                    image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=100&h=100&fit=crop',
                    unit: 'g',
                    currentStock: 300,
                    defaultShelfLife: 365,
                    price: 0.08,
                    supplier: '安琪',
                    description: '活性干酵母，发酵效果佳',
                    units: [
                        { name: 'g', ratio: 1, level: 1 },
                        { name: 'kg', ratio: 1000, level: 2 },
                        { name: '包', ratio: 50, level: 2 }
                    ]
                }
            ];
            
            // 缓存材料数据
            localStorage.setItem('materialsCache', JSON.stringify(materials));
            localStorage.setItem('materialsCacheTime', Date.now().toString());
            showToast('材料数据加载完成', 'success');
            return true;
            
        } catch (error) {
            console.error('加载材料数据失败:', error);
            showToast('材料数据加载失败', 'error');
            return false;
        }
    }

        // 渲染材料列表
        function renderMaterials() {
            try {
                if (!outboundData || !outboundData.items) {
                    showToast('没有出库数据', 'warning');
                    return;
                }

                const materialsList = document.getElementById('materialsList');
                if (!materialsList) {
                    console.error('找不到材料列表容器');
                    return;
                }
                
                // 显示加载状态
                materialsList.innerHTML = '<div class="text-center py-4 text-gray-500">正在加载材料...</div>';
                
                // 使用 DocumentFragment 提高性能
                const fragment = document.createDocumentFragment();

                outboundData.items.forEach((item, index) => {
                    try {
                        // 验证数据完整性
                        if (!item || !item.materialId) {
                            console.warn(`跳过无效的出库项目 (索引: ${index})`);
                            return;
                        }
                        
                        const material = materials.find(m => m.id === item.materialId);
                        if (!material) {
                            console.warn(`找不到材料 ID: ${item.materialId}`);
                            return;
                        }

                        // 确保数量和价格为有效数值
                        const quantity = parseFloat(item.quantity) || 0;
                        const price = parseFloat(material.price) || 0;
                        const totalPrice = quantity * price;

                        const materialCard = document.createElement('div');
                        materialCard.className = 'material-card bg-white rounded-xl p-3 shadow-sm border border-gray-100 hover:shadow-md transition-all relative';
                        
                        // 安全地获取材料属性
                        const materialName = material.name || '未知材料';
                        const materialImage = material.image || '/api/placeholder/40/40';
                        const currentStock = material.currentStock || 0;
                        const materialUnit = material.unit || item.unit || 'kg';
                        
                        // 生成单位选项
                        const unitOptions = material.units && material.units.length > 0 
                            ? material.units.map(unit => 
                                `<option value="${unit.name}" ${unit.name === item.unit ? 'selected' : ''}>${unit.name}</option>`
                              ).join('')
                            : `<option value="${item.unit || materialUnit}">${item.unit || materialUnit}</option>`;
                        
                        materialCard.innerHTML = `
                            <!-- 删除按钮 - 右上角 -->
                            <button onclick="removeMaterial(${index})" class="absolute -top-2 -right-2 w-7 h-7 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-110 z-10" title="删除材料">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                            
                            <!-- 材料头部信息 -->
                            <div class="flex items-center mb-3 pr-4">
                                <div class="flex items-center space-x-3 flex-1">
                                    <div class="flex-shrink-0 w-14 h-14 bg-orange-50 rounded-xl overflow-hidden border border-orange-100">
                                        <img src="${materialImage}" alt="${materialName}" class="material-image w-full h-full object-cover" onerror="this.src='/api/placeholder/56/56'">
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between mb-1.5">
                                            <h3 class="text-base font-semibold text-gray-900 truncate">${materialName}</h3>
                                            <div class="flex-shrink-0 relative">
                                                <button onclick="toggleStockDetails(${index})" 
                                                        class="text-sm text-gray-500 hover:bg-orange-50 hover:text-orange-600 px-2 py-1 rounded transition-colors flex items-center space-x-1"
                                                        id="stock-btn-${index}">
                                                    <span>库存 ${currentStock} ${materialUnit}</span>
                                                    <i class="fas fa-chevron-down text-xs transition-transform" id="stock-icon-${index}"></i>
                                                </button>
                                                <div class="hidden absolute z-20 mt-1 right-0 bg-white border border-gray-100 rounded-lg shadow-xl p-3 text-xs stock-details min-w-[150px]" 
                                                     id="stock-details-${index}">
                                                    <div class="text-gray-400 mb-2 font-medium">详细库存变化</div>
                                                    <div class="space-y-1">
                                                        <div class="flex justify-between">
                                                            <span class="text-gray-600">当前：</span>
                                                            <span class="font-bold text-gray-800">${currentStock} ${materialUnit}</span>
                                                        </div>
                                                        <div class="flex justify-between border-t border-gray-100 pt-1 mt-1">
                                                            <span class="text-gray-600">出库后：</span>
                                                            <span class="font-bold ${currentStock - quantity < 0 ? 'text-red-500' : 'text-green-500'}">${Math.max(0, currentStock - quantity)} ${materialUnit}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 数量步进器和单位选择 -->
                            <div class="flex items-center justify-between mb-1.5">
                                <div class="flex items-center space-x-2">
                                    <button onclick="adjustQuantity(${index}, -1)" class="w-10 h-10 bg-gray-50 border border-gray-200 rounded-lg flex items-center justify-center hover:bg-orange-100 hover:text-orange-600 hover:border-orange-200 transition-colors flex-shrink-0">
                                        <i class="fas fa-minus text-sm"></i>
                                    </button>
                                    <input type="number" 
                                           class="quantity-input text-center text-sm font-bold w-20 h-10 text-gray-800" 
                                           id="quantity-${index}" 
                                           value="${quantity}" 
                                           min="0" 
                                           step="0.01"
                                           onchange="updateQuantity(${index}, this.value)"
                                           onfocus="this.select()"
                                           placeholder="0">
                                    <button onclick="adjustQuantity(${index}, 1)" class="w-10 h-10 bg-gray-50 border border-gray-200 rounded-lg flex items-center justify-center hover:bg-orange-100 hover:text-orange-600 hover:border-orange-200 transition-colors flex-shrink-0">
                                        <i class="fas fa-plus text-sm"></i>
                                    </button>
                                    <select onchange="updateUnit(${item.materialId}, this.value)" class="h-10 text-sm text-gray-600 bg-gray-50 border border-gray-200 rounded-lg px-2 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 min-w-[70px]">
                                        ${unitOptions}
                                    </select>
                                </div>
                                <!-- 多规格按钮 -->
                                <button onclick="addQuickInput(${item.materialId})" class="flex items-center justify-center w-8 h-8 rounded-lg bg-orange-50 hover:bg-orange-100 text-orange-500 transition-colors" title="添加快速输入">
                                    <i class="fas fa-calculator text-sm"></i>
                                </button>
                            </div>
                            
                            <!-- 多规格快速输入容器 -->
                            <div id="quickInputContainer-${item.materialId}" class="mb-2">
                                <!-- 快速输入框将动态添加到这里 -->
                            </div>
                            
                            <!-- 价格设置 -->
                            <div class="bg-gray-50 rounded-lg p-2.5 flex items-center justify-between mt-3">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-gray-500">单价</span>
                                    <span class="text-sm font-medium text-gray-700">¥${price.toFixed(2)}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-gray-500">小计</span>
                                    <span class="text-base font-bold text-orange-600" id="subtotal-${index}">¥${totalPrice.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                        
                        fragment.appendChild(materialCard);
                        
                    } catch (error) {
                        console.error(`渲染材料卡片失败 (索引: ${index}):`, error);
                    }
                });
                
                // 清空容器并添加所有材料卡片
                materialsList.innerHTML = '';
                if (fragment.children.length === 0) {
                    materialsList.innerHTML = '<div class="text-center py-12 bg-white rounded-xl border border-gray-100 shadow-sm"><div class="text-gray-300 text-5xl mb-3"><i class="fas fa-box-open"></i></div><div class="text-gray-500 font-medium">暂无出库材料</div></div>';
                } else {
                    materialsList.appendChild(fragment);
                }
                
            } catch (error) {
                console.error('渲染材料列表失败:', error);
                showToast('渲染材料列表失败', 'error');
                const materialsList = document.getElementById('materialsList');
                if (materialsList) {
                    materialsList.innerHTML = '<div class="text-center py-8 text-red-500">加载材料失败，请刷新页面重试</div>';
                }
            }
        }

        // 调整数量
        function adjustQuantity(index, change) {
            try {
                if (!outboundData || !outboundData.items || !outboundData.items[index]) {
                    showToast('数据错误，请刷新页面', 'error');
                    return;
                }
                
                const item = outboundData.items[index];
                const currentQuantity = parseFloat(item.quantity) || 0;
                const changeAmount = parseFloat(change) || 0;
                const newQuantity = Math.max(0.01, currentQuantity + changeAmount);
                
                item.quantity = newQuantity;
                
                const quantityInput = document.getElementById(`quantity-${index}`);
                if (quantityInput) {
                    quantityInput.value = newQuantity.toFixed(2);
                }
                
                updateSubtotal(index);
                updateSummary();
                
                // 更新localStorage
                localStorage.setItem('pendingOutboundData', JSON.stringify(outboundData));
                
            } catch (error) {
                console.error('调整数量失败:', error);
                showToast('调整数量失败', 'error');
            }
        }

        // 更新数量
        function updateQuantity(index, value) {
            try {
                if (!outboundData || !outboundData.items || !outboundData.items[index]) {
                    showToast('数据错误，请刷新页面', 'error');
                    return;
                }
                
                const quantity = Math.max(0.01, parseFloat(value) || 0.01);
                outboundData.items[index].quantity = quantity;
                
                updateSubtotal(index);
                updateSummary();
                
                // 更新localStorage
                localStorage.setItem('pendingOutboundData', JSON.stringify(outboundData));
                
            } catch (error) {
                console.error('更新数量失败:', error);
                showToast('更新数量失败', 'error');
            }
        }

        // 多规格相关全局变量

        // Toast提示功能
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transition-all duration-300 transform translate-x-full shadow-lg flex items-center space-x-2`;
            
            let icon = '';
            switch(type) {
                case 'success':
                    toast.classList.add('bg-green-500');
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    toast.classList.add('bg-red-500');
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'warning':
                    toast.classList.add('bg-orange-500');
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                default:
                    toast.classList.add('bg-blue-500');
                    icon = '<i class="fas fa-info-circle"></i>';
            }
            
            toast.innerHTML = `${icon}<span>${message}</span>`;
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }


        // 单位更新函数
         function updateUnit(materialId, newUnit) {
             // 找到对应的材料和出库项
             const material = materials.find(m => m.id === materialId);
             const itemIndex = outboundData.items.findIndex(item => item.materialId === materialId);
             
             if (!material || itemIndex === -1) return;
             
             const item = outboundData.items[itemIndex];
             const oldUnit = item.unit;
             
             // 如果单位没有变化，直接返回
             if (oldUnit === newUnit) return;
             
             // 获取单位信息
             const oldUnitInfo = material.units.find(u => u.name === oldUnit);
             const newUnitInfo = material.units.find(u => u.name === newUnit);
             
             if (!oldUnitInfo || !newUnitInfo) return;
             
             // 计算换算后的数量（保持实际数量不变）
             const baseQuantity = item.quantity * oldUnitInfo.ratio;
             const newQuantity = Math.round(baseQuantity / newUnitInfo.ratio * 100) / 100;
             
             // 更新出库数据
             outboundData.items[itemIndex].unit = newUnit;
             outboundData.items[itemIndex].quantity = newQuantity;
             
             // 保存到本地存储
             localStorage.setItem('outboundData', JSON.stringify(outboundData));
             
             // 重新渲染材料列表和更新汇总
             renderMaterials();
             updateSummary();
         }
        
        // 切换单位功能
        function toggleUnit(index) {
            const item = outboundData.items[index];
            
            // 定义可用单位
            const availableUnits = ['kg', 'g', 't', '个', '箱', '包', 'L', 'ml'];
            const currentIndex = availableUnits.indexOf(item.unit);
            const nextIndex = (currentIndex + 1) % availableUnits.length;
            
            // 更新单位
            item.unit = availableUnits[nextIndex];
            
            // 更新localStorage
            localStorage.setItem('pendingOutboundData', JSON.stringify(outboundData));
            
            // 重新渲染材料列表
            renderMaterials();
            updateSummary();
        }

        // 更新小计
        function updateSubtotal(index) {
            const item = outboundData.items[index];
            const material = materials.find(m => m.id === item.materialId);
            if (!material) return;
            
            const subtotal = item.quantity * material.price;
            const subtotalElement = document.getElementById(`subtotal-${index}`);
            if (subtotalElement) {
                subtotalElement.textContent = `¥${subtotal.toFixed(2)}`;
            }
        }
        
        // 更新保质期天数


        // 移除材料
        function removeMaterial(index) {
            if (confirm('确定要移除这个材料吗？')) {
                outboundData.items.splice(index, 1);
                
                // 更新localStorage
                localStorage.setItem('pendingOutboundData', JSON.stringify(outboundData));
                
                // 重新渲染
                renderMaterials();
                updateSummary();
                
                // 如果没有材料了，返回上一页
                if (outboundData.items.length === 0) {
                    alert('出库列表为空，返回选择页面');
                    goBack();
                }
            }
        }

        // 更新总计信息
        function updateSummary() {
            if (!outboundData || !outboundData.items) {
                return;
            }

            const totalItems = outboundData.items.length;
            let totalValue = 0;

            outboundData.items.forEach(item => {
                const material = materials.find(m => m.id === item.materialId);
                if (material) {
                    totalValue += item.quantity * material.price;
                }
            });

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalValue').textContent = `¥${totalValue.toFixed(2)}`;
        }

        // 继续添加材料
        function continueOutbound() {
            // 保存当前数据
            localStorage.setItem('pendingOutboundData', JSON.stringify(outboundData));
            // 返回选择页面
            window.location.href = 'chukuzhuye.html';
        }

        // 确认出库
        function confirmOutbound() {
            if (!outboundData || !outboundData.items || outboundData.items.length === 0) {
                alert('出库列表为空');
                return;
            }

            // 显示加载指示器
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('confirmBtn').disabled = true;

            // 模拟出库处理
            setTimeout(() => {
                // 生成出库记录
                const outboundRecord = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    warehouse: outboundData.warehouse,
                    warehouseName: outboundData.warehouseName,
                    items: outboundData.items.map(item => {
                        const material = materials.find(m => m.id === item.materialId);
                        return {
                            ...item,
                            name: material ? material.name : '未知材料',
                            price: material ? material.price : 0,
                            total: item.quantity * (material ? material.price : 0)
                        };
                    }),
                    totalValue: outboundData.items.reduce((sum, item) => {
                        const material = materials.find(m => m.id === item.materialId);
                        return sum + (item.quantity * (material ? material.price : 0));
                    }, 0),
                    status: 'completed'
                };

                // 保存出库记录
                const existingRecords = JSON.parse(localStorage.getItem('outboundRecords') || '[]');
                existingRecords.unshift(outboundRecord);
                localStorage.setItem('outboundRecords', JSON.stringify(existingRecords));

                // 清除待出库数据
                localStorage.removeItem('pendingOutboundData');

                // 隐藏加载指示器
                document.getElementById('loadingIndicator').classList.add('hidden');

                // 显示成功消息
                alert('出库成功！');

                // 跳转到出库主页
                window.location.href = 'chukuzhuye.html';
            }, 2000);
        }

        // 切换库存详情显示
        function toggleStockDetails(index) {
            const detailsDiv = document.getElementById(`stock-details-${index}`);
            const iconElement = document.getElementById(`stock-icon-${index}`);
            
            if (detailsDiv && iconElement) {
                if (detailsDiv.classList.contains('hidden')) {
                    detailsDiv.classList.remove('hidden');
                    iconElement.style.transform = 'rotate(180deg)';
                } else {
                    detailsDiv.classList.add('hidden');
                    iconElement.style.transform = 'rotate(0deg)';
                }
            }
        }
    </script>
</body>
</html>