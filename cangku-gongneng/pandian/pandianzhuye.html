<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>库存盘点 - 烘匠 BakeManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Cookpad Design System */
        :root {
            --primary-orange: #ff9f43;
            --primary-dark: #ff8c00;
            --text-main: #333333;
            --text-sub: #8b8b8b;
            --bg-light: #f7f7f5;
            --bg-white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* 滚动条美化 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        /* 卡片样式 */
        .card {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
            transition: all 0.2s;
        }
        
        .card:active {
            transform: scale(0.98);
        }

        /* 侧边栏样式 */
        .category-sidebar {
            width: 80px;
            background-color: #ffffff;
            border-right: 1px solid #f0f0f0;
        }
        
        .category-item {
            transition: all 0.2s ease;
            margin: 4px 8px;
            border-radius: 8px;
            border: 1px solid transparent;
        }
        
        .category-item:hover {
            background-color: #f7f7f5;
        }
        
        .category-item.active {
            background-color: #fff7ed;
            border-color: #ffedd5;
            color: var(--primary-dark);
        }
        
        .category-item.active .category-icon-container {
            background-color: #ffedd5 !important;
        }
        
        .category-item.active i {
            color: var(--primary-dark) !important;
        }
        
        .category-item.active .category-name {
            color: var(--primary-dark) !important;
            font-weight: 600;
        }

        /* 批量操作按钮 (Shared style) */
        .batch-inbound-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9f43 0%, #ff8c00 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .batch-inbound-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 140, 0, 0.4);
        }
        
        .batch-inbound-btn:active {
            transform: scale(0.95);
        }

        /* 数量输入框 */
        .quantity-input {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 4px 0;
            font-weight: 600;
            transition: all 0.2s ease;
            background: #f9fafb;
            text-align: center;
        }
        
        .quantity-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            background: #fff;
            box-shadow: 0 0 0 2px rgba(255, 159, 67, 0.1);
        }
        
        .quantity-input.has-value {
            border-color: var(--primary-orange);
            background-color: #fff7ed;
            color: var(--primary-dark);
        }

        /* 下拉选择框 */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">
    
    <!-- 顶部导航栏 - Cookpad 风格 -->
    <div class="bg-white px-4 py-3 shadow-sm border-b border-gray-100 z-30 flex-shrink-0">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="window.location.href='../erp-zhuye-canku.html'" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-all text-gray-600">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div>
                    <div class="text-lg font-bold text-gray-800 tracking-wide">库存盘点</div>
                    <div class="text-xs text-gray-500 font-medium mt-0.5">快速批量盘点</div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="window.location.href='pandian-lishi.html'" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-50 hover:bg-orange-50 hover:text-orange-600 transition-all text-gray-500">
                    <i class="fas fa-history text-sm"></i>
                </button>
                <button onclick="showScanModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-50 hover:bg-orange-50 hover:text-orange-600 transition-all text-gray-500">
                    <i class="fas fa-qrcode text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 工具栏 -->
    <div class="bg-white border-b border-gray-100 flex-shrink-0 z-20">
        <div class="px-4 py-3">
            <div class="flex items-center gap-3">
                <!-- 仓库选择 -->
                <div class="flex-1 relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-warehouse text-gray-400 text-xs"></i>
                    </div>
                    <select id="warehouseSelect" class="custom-select w-full bg-gray-50 border border-gray-200 rounded-xl pl-9 pr-8 py-2.5 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-100 focus:border-orange-300 transition-all">
                        <option value="warehouse1">主仓库 (A区)</option>
                        <option value="warehouse2">二号仓库 (B区)</option>
                        <option value="warehouse3">三号仓库 (C区)</option>
                        <option value="warehouse4">四号仓库 (D区)</option>
                        <option value="warehouse5">五号仓库 (E区)</option>
                    </select>
                </div>
                
                <!-- 搜索按钮 -->
                <button id="searchToggleBtn" onclick="toggleSearchBox()" class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center hover:bg-orange-50 hover:text-orange-600 transition-all border border-gray-200 text-gray-500">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <!-- 展开的搜索框 -->
            <div id="expandedSearchBox" class="mt-3 hidden animate-fade-in">
                <div class="relative">
                    <input type="text" placeholder="搜索材料名称..." 
                           class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-10 pr-10 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-orange-100 focus:border-orange-300 transition-all"
                           id="searchInput">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <button class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 hidden" 
                            id="clearSearch" 
                            onclick="clearSearchInput()">
                        <i class="fas fa-times-circle text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="flex flex-1 overflow-hidden">
        <!-- 左侧分类栏 -->
        <div class="category-sidebar h-full overflow-y-auto custom-scrollbar flex flex-col py-2">
            <div id="categorySidebar">
                <!-- 分类项将通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 右侧材料列表 -->
        <div class="flex-1 h-full overflow-y-auto custom-scrollbar p-3 bg-gray-50" id="materialList">
            <!-- 材料卡片将通过JS动态生成 -->
        </div>
    </div>
    
    <!-- 批量盘点按钮 -->
    <button class="batch-inbound-btn" id="batchInventoryBtn" onclick="showBatchInventoryModal()" style="display: none;">
        <i class="fas fa-check text-xl"></i>
        <div class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center border-2 border-white">
            <span class="text-[10px] text-white font-bold" id="batchCount">0</span>
        </div>
    </button>

    <!-- 加载中提示 -->
    <div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
            <p class="text-gray-500 text-sm font-medium">加载中...</p>
        </div>
    </div>

    <!-- 成功提示 Toast -->
    <div id="toast-container" class="fixed top-24 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none"></div>

    <script>
        // 材料数据 (保留Pandian数据)
        const categories = [
            { id: 'all', name: '全部', count: 36, icon: 'fa-th', color: 'blue' },
            { id: 'flour', name: '粉类', count: 8, icon: 'fa-wheat-awn', color: 'amber' },
            { id: 'oil', name: '油脂类', count: 6, icon: 'fa-oil-can', color: 'yellow' },
            { id: 'sugar', name: '糖类', count: 5, icon: 'fa-candy-cane', color: 'pink' },
            { id: 'dairy', name: '乳制品', count: 4, icon: 'fa-cheese', color: 'green' },
            { id: 'egg', name: '蛋类', count: 2, icon: 'fa-egg', color: 'orange' },
            { id: 'fruit', name: '水果类', count: 5, icon: 'fa-apple-whole', color: 'red' },
            { id: 'nut', name: '坚果类', count: 3, icon: 'fa-seedling', color: 'lime' },
            { id: 'other', name: '其他', count: 3, icon: 'fa-mortar-pestle', color: 'purple' }
        ];
        
        const materials = [
            { id: 1, name: '高筋面粉', category: 'flour', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '箱': { quantity: 3, baseUnit: 'kg', conversion: 25 }, 'kg': { quantity: 12, baseUnit: 'kg', conversion: 1 }, 'g': { quantity: 500, baseUnit: 'g', conversion: 1 } }, primaryUnit: '箱', lowStock: 500, status: 'normal', price: 8.5 },
            { id: 2, name: '中筋面粉', category: 'flour', image: 'https://images.unsplash.com/photo-1628088062854-d1870b4553da?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '箱': { quantity: 2, baseUnit: 'kg', conversion: 25 }, 'kg': { quantity: 8, baseUnit: 'kg', conversion: 1 } }, primaryUnit: '箱', lowStock: 500, status: 'normal', price: 7.8 },
            { id: 3, name: '低筋面粉', category: 'flour', image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { 'kg': { quantity: 0, baseUnit: 'kg', conversion: 1 }, 'g': { quantity: 300, baseUnit: 'g', conversion: 1 } }, primaryUnit: 'kg', lowStock: 500, status: 'low', price: 9.2 },
            { id: 4, name: '全麦面粉', category: 'flour', image: 'https://images.unsplash.com/photo-1595535373192-fc8935bacd89?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '袋': { quantity: 2, baseUnit: 'kg', conversion: 10 }, 'kg': { quantity: 5, baseUnit: 'kg', conversion: 1 } }, primaryUnit: '袋', lowStock: 500, status: 'normal', price: 12.0 },
            { id: 5, name: '黑麦面粉', category: 'flour', image: 'https://images.unsplash.com/photo-1576618148400-f54bed99fcfd?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: {}, primaryUnit: 'kg', lowStock: 500, status: 'out', price: 15.5 },
            { id: 6, name: '杏仁粉', category: 'flour', image: 'https://images.unsplash.com/photo-1599599810694-57a2ca8276a8?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '袋': { quantity: 1, baseUnit: 'g', conversion: 500 }, 'g': { quantity: 300, baseUnit: 'g', conversion: 1 } }, primaryUnit: '袋', lowStock: 200, status: 'normal', price: 45.0 },
            { id: 7, name: '燕麦粉', category: 'flour', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { 'kg': { quantity: 0, baseUnit: 'kg', conversion: 1 }, 'g': { quantity: 600, baseUnit: 'g', conversion: 1 } }, primaryUnit: 'kg', lowStock: 300, status: 'normal', price: 18.0 },
            { id: 8, name: '玉米粉', category: 'flour', image: 'https://images.unsplash.com/photo-1551754655-cd27e38d2076?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { 'g': { quantity: 150, baseUnit: 'g', conversion: 1 } }, primaryUnit: 'g', lowStock: 300, status: 'low', price: 6.5 },
            { id: 9, name: '黄油', category: 'oil', image: 'https://images.unsplash.com/photo-1589985270958-bf087be2a336?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '箱': { quantity: 1, baseUnit: 'g', conversion: 1000 }, 'g': { quantity: 500, baseUnit: 'g', conversion: 1 } }, primaryUnit: '箱', lowStock: 300, status: 'normal', price: 28.0 },
            { id: 10, name: '植物油', category: 'oil', image: 'https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '桶': { quantity: 1, baseUnit: 'L', conversion: 5 }, 'L': { quantity: 2, baseUnit: 'L', conversion: 1 }, 'ml': { quantity: 500, baseUnit: 'ml', conversion: 1 } }, primaryUnit: '桶', lowStock: 500, status: 'normal', price: 12.5 },
            { id: 11, name: '橄榄油', category: 'oil', image: 'https://images.unsplash.com/photo-1596040033229-a9821ebd058d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '瓶': { quantity: 2, baseUnit: 'ml', conversion: 500 }, 'ml': { quantity: 300, baseUnit: 'ml', conversion: 1 } }, primaryUnit: '瓶', lowStock: 200, status: 'normal', price: 65.0 },
            { id: 12, name: '椰子油', category: 'oil', image: 'https://images.unsplash.com/photo-1605522324253-e8a0ffc4e78a?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { 'g': { quantity: 100, baseUnit: 'g', conversion: 1 } }, primaryUnit: 'g', lowStock: 200, status: 'low', price: 35.0 },
            { id: 13, name: '猪油', category: 'oil', image: 'https://images.unsplash.com/photo-1589985270958-bf087be2a336?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { 'g': { quantity: 500, baseUnit: 'g', conversion: 1 } }, primaryUnit: 'g', lowStock: 100, status: 'normal', price: 18.0 },
            { id: 14, name: '起酥油', category: 'oil', image: 'https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { 'kg': { quantity: 1, baseUnit: 'kg', conversion: 1 }, 'g': { quantity: 200, baseUnit: 'g', conversion: 1 } }, primaryUnit: 'kg', lowStock: 300, status: 'normal', price: 22.0 },
            { id: 15, name: '白砂糖', category: 'sugar', image: 'https://images.unsplash.com/photo-1516684669134-de6f7c473a2a?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '袋': { quantity: 6, baseUnit: 'kg', conversion: 5 }, 'kg': { quantity: 2, baseUnit: 'kg', conversion: 1 } }, primaryUnit: '袋', lowStock: 500, status: 'normal', price: 5.5 },
            { id: 16, name: '红糖', category: 'sugar', image: 'https://images.unsplash.com/photo-1571115764595-644a1f56a55c?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '袋': { quantity: 1, baseUnit: 'g', conversion: 500 }, 'g': { quantity: 300, baseUnit: 'g', conversion: 1 } }, primaryUnit: '袋', lowStock: 200, status: 'normal', price: 8.0 },
            { id: 17, name: '蜂蜜', category: 'sugar', image: 'https://images.unsplash.com/photo-1587049352846-4a222e784d38?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '瓶': { quantity: 3, baseUnit: 'ml', conversion: 500 }, 'ml': { quantity: 200, baseUnit: 'ml', conversion: 1 } }, primaryUnit: '瓶', lowStock: 300, status: 'normal', price: 45.0 },
            { id: 18, name: '枫糖浆', category: 'sugar', image: 'https://images.unsplash.com/photo-1571115764595-644a1f56a55c?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '瓶': { quantity: 0, baseUnit: 'ml', conversion: 250 }, 'ml': { quantity: 400, baseUnit: 'ml', conversion: 1 } }, primaryUnit: '瓶', lowStock: 200, status: 'normal', price: 85.0 },
            { id: 19, name: '糖粉', category: 'sugar', image: 'https://images.unsplash.com/photo-1516684669134-de6f7c473a2a?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '袋': { quantity: 1, baseUnit: 'g', conversion: 500 }, 'g': { quantity: 100, baseUnit: 'g', conversion: 1 } }, primaryUnit: '袋', lowStock: 200, status: 'normal', price: 12.0 },
            { id: 20, name: '牛奶', category: 'dairy', image: 'https://images.unsplash.com/photo-1550583724-b2692b85b150?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '箱': { quantity: 2, baseUnit: 'ml', conversion: 1000 }, '瓶': { quantity: 3, baseUnit: 'ml', conversion: 250 }, 'ml': { quantity: 250, baseUnit: 'ml', conversion: 1 } }, primaryUnit: '箱', lowStock: 500, status: 'normal', price: 4.5 },
            { id: 21, name: '奶油', category: 'dairy', image: 'https://images.unsplash.com/photo-1628088062854-d1870b4553da?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '盒': { quantity: 2, baseUnit: 'ml', conversion: 500 }, 'ml': { quantity: 300, baseUnit: 'ml', conversion: 1 } }, primaryUnit: '盒', lowStock: 200, status: 'normal', price: 25.0 },
            { id: 22, name: '酸奶', category: 'dairy', image: 'https://images.unsplash.com/photo-1571212515416-fac8c2b1e279?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { 'ml': { quantity: 200, baseUnit: 'ml', conversion: 1 } }, primaryUnit: 'ml', lowStock: 300, status: 'low', price: 8.5 },
            { id: 23, name: '奶酪', category: 'dairy', image: 'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '块': { quantity: 2, baseUnit: 'g', conversion: 250 }, 'g': { quantity: 0, baseUnit: 'g', conversion: 1 } }, primaryUnit: '块', lowStock: 100, status: 'normal', price: 35.0 },
            { id: 24, name: '鸡蛋', category: 'egg', image: 'https://images.unsplash.com/photo-1582722872445-44dc5f7e3c8f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '箱': { quantity: 2, baseUnit: '个', conversion: 30 }, '个': { quantity: 12, baseUnit: '个', conversion: 1 } }, primaryUnit: '箱', lowStock: 6, status: 'normal', price: 1.2 },
            { id: 25, name: '蛋黄', category: 'egg', image: 'https://images.unsplash.com/photo-1587486913049-53fc88980cfc?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80', multiUnitStock: { '个': { quantity: 12, baseUnit: '个', conversion: 1 } }, primaryUnit: '个', lowStock: 5, status: 'normal', price: 2.5 }
        ];

        // 盘点数量记录
        let inventoryQuantities = {};
        
        // 仓库记忆功能
        let selectedWarehouse = localStorage.getItem('selectedWarehouse') || 'warehouse1';
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            showLoading();
            initWarehouseSelector();
            renderCategories();
            renderMaterials('all');
            initSearchFunction();
            restoreInventoryState();
            setTimeout(() => {
                hideLoading();
            }, 500);
        });
        
        // 恢复盘点状态
        function restoreInventoryState() {
            const savedState = localStorage.getItem('inventoryState');
            const pendingData = localStorage.getItem('pendingInventoryData');
            
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.quantities) {
                        inventoryQuantities = state.quantities;
                        Object.keys(inventoryQuantities).forEach(materialId => {
                            const input = document.getElementById(`quantity-${materialId}`);
                            if (input) {
                                input.value = inventoryQuantities[materialId];
                                input.classList.add('has-value');
                            }
                        });
                        updateBatchButton();
                    }
                    if (state.warehouse) {
                        selectedWarehouse = state.warehouse;
                        const warehouseSelect = document.getElementById('warehouseSelect');
                        if (warehouseSelect) {
                            warehouseSelect.value = selectedWarehouse;
                        }
                    }
                    localStorage.removeItem('inventoryState');
                } catch (e) {
                    console.error('恢复盘点状态失败:', e);
                }
            }
            
            if (pendingData) {
                try {
                    const existingData = JSON.parse(pendingData);
                    const existingItems = existingData.items || existingData;
                    if (Array.isArray(existingItems)) {
                        existingItems.forEach(item => {
                            const materialId = item.materialId || item.id;
                            if (materialId && item.quantity !== undefined) {
                                inventoryQuantities[materialId] = item.quantity;
                                const input = document.getElementById(`quantity-${materialId}`);
                                if (input) {
                                    input.value = item.quantity;
                                    input.classList.add('has-value');
                                }
                            }
                        });
                        updateBatchButton();
                    }
                } catch (e) {
                    console.error('恢复pendingInventoryData失败:', e);
                }
            }
        }
        
        // 初始化仓库选择器
        function initWarehouseSelector() {
            const warehouseSelect = document.getElementById('warehouseSelect');
            warehouseSelect.value = selectedWarehouse;
            
            warehouseSelect.addEventListener('change', function() {
                selectedWarehouse = this.value;
                localStorage.setItem('selectedWarehouse', selectedWarehouse);
                showToast(`已切换到: ${this.selectedOptions[0].text.split(' ')[1]}`, 'info');
            });
        }
        
        // 渲染分类栏
        function renderCategories() {
            const sidebar = document.getElementById('categorySidebar');
            
            // Generate All Category
            let html = `
                <div class="category-item ${currentCategory === 'all' ? 'active' : ''} px-2 py-3 text-center cursor-pointer group" 
                     data-category="all" 
                     onclick="filterByCategory('all')">
                    <div class="category-icon-container w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center mx-auto mb-1.5 transition-colors group-hover:bg-gray-100">
                        <i class="fas fa-th text-gray-400 text-sm group-hover:text-gray-600 transition-colors"></i>
                    </div>
                    <div class="category-name text-xs font-medium text-gray-600 group-hover:text-gray-800 transition-colors">全部</div>
                    <div class="text-[10px] text-gray-400 mt-0.5">${categories.find(c => c.id === 'all').count}</div>
                </div>
            `;
            
            categories.forEach(category => {
                if (category.id === 'all') return;
                html += `
                <div class="category-item ${currentCategory === category.id ? 'active' : ''} px-2 py-3 text-center cursor-pointer group" 
                     data-category="${category.id}" 
                     onclick="filterByCategory('${category.id}')">
                    <div class="category-icon-container w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center mx-auto mb-1.5 transition-colors group-hover:bg-gray-100">
                        <i class="fas ${category.icon} text-gray-400 text-sm group-hover:text-gray-600 transition-colors"></i>
                    </div>
                    <div class="category-name text-xs font-medium text-gray-600 group-hover:text-gray-800 transition-colors">${category.name}</div>
                    <div class="text-[10px] text-gray-400 mt-0.5">${category.count}</div>
                </div>
                `;
            });
            
            sidebar.innerHTML = html;
        }

        let currentCategory = 'all';

        // 快速筛选功能
        function filterByCategory(categoryId) {
            currentCategory = categoryId;
            renderCategories();
            renderMaterials(categoryId);
            
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
                document.getElementById('clearSearch').classList.add('hidden');
            }
        }
        
        // 获取材料可用单位
        function getMaterialUnits(material) {
            if (material.multiUnitStock && Object.keys(material.multiUnitStock).length > 0) {
                return Object.keys(material.multiUnitStock);
            }
            return [material.unit || 'g'];
        }
        
        // 获取主要库存显示文本
        function getPrimaryStockDisplay(material) {
            if (!material.multiUnitStock || Object.keys(material.multiUnitStock).length === 0) {
                return material.stock ? `${material.stock}${material.unit || 'g'}` : '无库存';
            }
            const primaryUnit = material.primaryUnit;
            const primaryStock = material.multiUnitStock[primaryUnit];
            if (primaryStock && primaryStock.quantity > 0) {
                return `${primaryStock.quantity}${primaryUnit}`;
            }
            for (const [unit, stock] of Object.entries(material.multiUnitStock)) {
                if (stock.quantity > 0) {
                    return `${stock.quantity}${unit}`;
                }
            }
            return '无库存';
        }
        
        // 格式化多单位库存信息
        function formatMultiUnitStock(material) {
            if (!material.multiUnitStock || Object.keys(material.multiUnitStock).length === 0) {
                return material.stock ? `剩${material.stock}${material.unit || 'g'}` : '无库存';
            }
            const stockParts = [];
            for (const [unit, stock] of Object.entries(material.multiUnitStock)) {
                if (stock.quantity > 0) {
                    stockParts.push(`${stock.quantity}${unit}`);
                }
            }
            if (stockParts.length === 0) return '无库存';
            if (stockParts.length === 1) return `剩${stockParts[0]}`;
            return stockParts.map(part => `剩${part}`).join('<br>');
        }
        
        // 更新材料单位
        function updateMaterialUnit(materialId, newUnit) {
            const material = materials.find(m => m.id == materialId);
            if (!material) return;
            showToast(`${material.name} 单位已更改为 ${newUnit}`, 'info');
        }
        
        // 切换库存详情显示
        function toggleStockDetails(materialId) {
            const detailsDiv = document.getElementById(`stock-details-${materialId}`);
            const iconElement = document.getElementById(`stock-icon-${materialId}`);
            
            if (detailsDiv.classList.contains('hidden')) {
                document.querySelectorAll('[id^="stock-details-"]').forEach(div => div.classList.add('hidden'));
                document.querySelectorAll('[id^="stock-icon-"]').forEach(icon => icon.classList.remove('rotate-180'));
                detailsDiv.classList.remove('hidden');
                iconElement.classList.add('rotate-180');
            } else {
                detailsDiv.classList.add('hidden');
                iconElement.classList.remove('rotate-180');
            }
        }
        
        document.addEventListener('click', function(event) {
            if (!event.target.closest('button[onclick^="toggleStockDetails"]') && !event.target.closest('[id^="stock-details-"]')) {
                document.querySelectorAll('[id^="stock-details-"]').forEach(div => div.classList.add('hidden'));
                document.querySelectorAll('[id^="stock-icon-"]').forEach(icon => icon.classList.remove('rotate-180'));
            }
        });
        
        // 渲染材料列表
        function renderMaterials(categoryId, searchQuery = '') {
            const materialListContainer = document.getElementById('materialList');
            
            let filteredMaterials = materials;
            
            if (categoryId !== 'all') {
                filteredMaterials = materials.filter(material => material.category === categoryId);
            }
            
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filteredMaterials = filteredMaterials.filter(material => 
                    material.name.toLowerCase().includes(query)
                );
            }
            
            if (filteredMaterials.length === 0) {
                materialListContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-6">
                        <i class="fas fa-search text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500">未找到符合条件的材料</p>
                        ${searchQuery ? `<p class="text-sm text-gray-400 mt-2">搜索词：${searchQuery}</p>` : ''}
                        <button onclick="clearSearchInput()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">
                            清除搜索
                        </button>
                    </div>
                `;
                return;
            }
            
            materialListContainer.innerHTML = filteredMaterials.map(material => {
                const availableUnits = getMaterialUnits(material);
                const defaultUnit = availableUnits[0];
                let stockClass = material.status === 'out' ? 'text-red-600 border-red-100 bg-red-50' : 
                               material.status === 'low' ? 'text-orange-600 border-orange-100 bg-orange-50' : 'text-green-600 border-green-100 bg-green-50';
                
                // 模拟供应商信息 (因为数据中没有)
                const supplier = '烘焙原料供应商';

                return `
                    <div class="card p-2.5 mb-2.5 animate-fade-in relative">
                        <div class="flex gap-3 items-center">
                            <div class="w-14 h-14 rounded-lg bg-gray-100 flex-shrink-0 overflow-hidden border border-gray-100">
                                <img src="${material.image}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0 flex flex-col justify-center">
                                <div>
                                    <div class="flex justify-between items-start">
                                        <h3 class="text-sm font-bold text-gray-800 truncate pr-2">${material.name}</h3>
                                        <div class="relative">
                                            <button onclick="toggleStockDetails(${material.id})" class="text-[10px] px-1.5 py-0.5 rounded border ${stockClass} flex items-center gap-1 transition-colors hover:bg-white">
                                                <span>账面 ${getPrimaryStockDisplay(material)}</span>
                                                <i class="fas fa-chevron-down text-[8px] transition-transform" id="stock-icon-${material.id}"></i>
                                            </button>
                                            <div class="hidden absolute right-0 top-full mt-1 z-20 bg-white border border-gray-200 rounded-lg shadow-lg p-3 text-xs stock-details min-w-[140px]" 
                                                 id="stock-details-${material.id}">
                                                <div class="text-gray-600 mb-1 font-medium">库存详情：</div>
                                                <div class="text-gray-800 font-semibold leading-relaxed" id="stock-content-${material.id}">${formatMultiUnitStock(material)}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500 truncate mt-0.5">${supplier}</div>
                                </div>
                                <div class="flex items-center justify-between mt-1.5">
                                    <div class="text-xs text-gray-400">单价: ¥${material.price}</div>
                                    
                                    <div class="flex items-center gap-2">
                                         <div class="flex items-center bg-gray-50 rounded-lg p-0.5 border border-gray-200">
                                            <button onclick="adjustQuantity(${material.id}, -1)" class="w-6 h-6 flex items-center justify-center rounded-md bg-white text-gray-500 shadow-sm hover:text-orange-600 active:scale-95 transition-all">
                                                <i class="fas fa-minus text-[10px]"></i>
                                            </button>
                                            <input type="number" 
                                                   class="quantity-input w-10 h-6 mx-1 bg-transparent border-none text-sm p-0 focus:ring-0" 
                                                   id="quantity-${material.id}"
                                                   value="${inventoryQuantities[material.id] || ''}"
                                                   min="0"
                                                   onchange="updateQuantity(${material.id}, this.value)"
                                                   placeholder="0">
                                            <button onclick="adjustQuantity(${material.id}, 1)" class="w-6 h-6 flex items-center justify-center rounded-md bg-white text-gray-500 shadow-sm hover:text-orange-600 active:scale-95 transition-all">
                                                <i class="fas fa-plus text-[10px]"></i>
                                            </button>
                                        </div>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateBatchButton();
        }
        
        // 调整数量
        function adjustQuantity(materialId, change) {
            const input = document.getElementById(`quantity-${materialId}`);
            let currentValue = parseInt(input.value) || 0;
            let newValue = Math.max(0, currentValue + change);
            
            input.value = newValue > 0 ? newValue : '';
            updateQuantity(materialId, input.value);
            
            if (Math.abs(change) >= 1) {
                input.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    input.style.transform = 'scale(1)';
                }, 200);
            }
        }
        
        // 更新数量
        function updateQuantity(materialId, value) {
            const quantity = parseInt(value);
            const input = document.getElementById(`quantity-${materialId}`);
            
            if (!isNaN(quantity) && quantity > 0) {
                inventoryQuantities[materialId] = quantity;
                input.classList.add('has-value');
            } else {
                delete inventoryQuantities[materialId];
                input.classList.remove('has-value');
            }
            
            updateBatchButton();
        }
        
        // 更新批量盘点按钮
        function updateBatchButton() {
            const batchBtn = document.getElementById('batchInventoryBtn');
            const batchCount = document.getElementById('batchCount');
            const itemCount = Object.keys(inventoryQuantities).length;
            
            if (itemCount > 0) {
                batchBtn.style.display = 'flex';
                batchCount.textContent = itemCount;
                // 添加跳动动画
                batchBtn.classList.add('animate-bounce');
                setTimeout(() => batchBtn.classList.remove('animate-bounce'), 1000);
            } else {
                batchBtn.style.display = 'none';
            }
        }
        
        // 初始化搜索功能
        function initSearchFunction() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearch');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (query) {
                    clearButton.classList.remove('hidden');
                } else {
                    clearButton.classList.add('hidden');
                }
                
                renderMaterials(currentCategory, query);
            });
        }
        
        // 清除搜索
        function clearSearchInput() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearch');
            
            searchInput.value = '';
            clearButton.classList.add('hidden');
            
            renderMaterials(currentCategory);
        }
        
        // 切换搜索框显示状态
        function toggleSearchBox() {
            const expandedSearchBox = document.getElementById('expandedSearchBox');
            const searchInput = document.getElementById('searchInput');
            
            if (expandedSearchBox.classList.contains('hidden')) {
                expandedSearchBox.classList.remove('hidden');
                setTimeout(() => {
                    searchInput.focus();
                }, 100);
            } else {
                expandedSearchBox.classList.add('hidden');
                clearSearchInput();
            }
        }
        
        // 显示/隐藏加载指示器
        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }
        
        // 显示扫描模态框 (Placeholder)
        function showScanModal() {
            showToast('扫描功能暂未开放', 'info');
        }
        
        // 批量盘点确认
        function showBatchInventoryModal() {
            const itemsToInventory = [];
            
            Object.keys(inventoryQuantities).forEach(materialId => {
                const material = materials.find(m => m.id == materialId);
                if (material && inventoryQuantities[materialId] !== undefined) {
                    itemsToInventory.push({
                        materialId: material.id,
                        materialName: material.name,
                        quantity: inventoryQuantities[materialId],
                        unit: document.getElementById(`unit-${material.id}`)?.value || material.unit || material.primaryUnit,
                        currentStock: getPrimaryStockDisplay(material) // 传递当前账面库存用于对比
                    });
                }
            });
            
            if (itemsToInventory.length === 0) {
                showToast('请先输入盘点数量', 'warning');
                return;
            }
            
            // 保存盘点数据到localStorage
            const inventoryData = {
                warehouse: selectedWarehouse,
                warehouseName: document.getElementById('warehouseSelect').selectedOptions[0].text,
                items: itemsToInventory,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('pendingInventoryData', JSON.stringify(inventoryData));
            
            // 跳转到确认页面
            window.location.href = 'pandian-querenye.html';
        }
        
        // Toast 提示
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgClass = 'bg-gray-800';
            let icon = 'fa-info-circle';
            
            if (type === 'success') {
                bgClass = 'bg-green-500';
                icon = 'fa-check-circle';
            } else if (type === 'warning') {
                bgClass = 'bg-orange-500';
                icon = 'fa-exclamation-triangle';
            } else if (type === 'error') {
                bgClass = 'bg-red-500';
                icon = 'fa-times-circle';
            }
            
            toast.className = `${bgClass} text-white px-4 py-2 rounded-full shadow-lg mb-2 flex items-center gap-2 text-sm animate-fade-in transition-all`;
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        
    </script>
</body>
</html>