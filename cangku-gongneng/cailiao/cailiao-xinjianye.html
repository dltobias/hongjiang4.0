<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新建材料 - 烘匠 BakeManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Cookpad Design System & Unified Theme */
        :root {
            --primary-orange: #ff9f43;
            --primary-dark: #ff8c00;
            --secondary-green: #28c76f;
            --secondary-blue: #00cfe8;
            --text-main: #333333;
            --text-sub: #8b8b8b;
            --bg-light: #f7f7f5;
            --bg-white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* 重新定义渐变类以匹配新主题 */
        .gradient-primary {
            background: linear-gradient(135deg, #ff9f43 0%, #ff8c00 100%);
        }
        .gradient-recipe {
            background: linear-gradient(135deg, #28c76f 0%, #1eef82 100%);
        }
        .gradient-message {
            background: linear-gradient(135deg, #ffc107 0%, #ffca28 100%);
        }
        .gradient-inventory {
            background: linear-gradient(135deg, #00cfe8 0%, #00e5ff 100%);
        }
        .gradient-order {
            background: linear-gradient(135deg, #7367f0 0%, #8f85f3 100%);
        }

        /* 卡片样式 */
        .card {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        /* 表单样式 */
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
            background-color: #f9fafb;
            transition: all 0.2s ease;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(255, 159, 67, 0.1);
        }

        /* 开关样式 - Orange Theme */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider { background-color: var(--primary-orange); }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* 单位层级样式 - 适配新设计 */
        .unit-level {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: #fff;
            position: relative;
            transition: all 0.3s ease;
        }
        .unit-level[data-level="1"] { border-left: 4px solid #3b82f6; }
        .unit-level[data-level="2"] { border-left: 4px solid #10b981; }
        .unit-level[data-level="3"] { border-left: 4px solid #f59e0b; }
        .unit-level[data-level="4"] { border-left: 4px solid #8b5cf6; }

        /* 按钮样式 */
        .btn-primary {
            background: linear-gradient(135deg, #ff9f43 0%, #ff8c00 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 140, 0, 0.2);
            border: none;
        }
        .btn-primary:hover {
            box-shadow: 0 6px 15px rgba(255, 140, 0, 0.3);
            transform: translateY(-1px);
        }

        /* 图片上传 */
        .image-upload {
            border: 2px dashed #e5e7eb;
            background-color: #f9fafb;
        }
        .image-upload:hover {
            border-color: var(--primary-orange);
            background-color: #fff7ed;
        }

        /* ActionSheet */
        .action-sheet {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
        }
        .action-sheet.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        
        /* 遮罩层 */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .action-sheet.active + .modal-overlay,
        .action-sheet.active ~ .modal-overlay { /* 修正选择器逻辑，通常JS控制显示 */
            opacity: 1;
            visibility: visible;
        }
        /* JS控制遮罩显示 */
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        /* 价格输入组 */
        .price-input-group {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background-color: #fff;
        }
        .price-input-group:focus-within {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 159, 67, 0.1);
        }

        /* 动画 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-[#f7f7f5] pb-24">

    <!-- 顶部导航栏 - Unified Style -->
    <div class="fixed top-0 left-0 right-0 bg-white z-50 px-4 py-3 shadow-sm border-b border-gray-100">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <a href="javascript:history.back()" class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-all text-gray-600">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <h1 class="text-lg font-bold text-gray-800">新建材料</h1>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="startScanCode()" class="w-9 h-9 flex items-center justify-center rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 transition-all">
                    <i class="fas fa-qrcode"></i>
                </button>
                <button type="submit" form="newMaterialForm" class="btn-primary px-4 py-1.5 rounded-full text-sm shadow-lg shadow-orange-200/50">
                    保存
                </button>
            </div>
        </div>
    </div>

    <!-- 占位符 -->
    <div class="h-16"></div>

    <!-- 主内容区域 -->
    <div class="main-content p-4 max-w-2xl mx-auto">
        <form id="newMaterialForm" onsubmit="return saveMaterial(event)">
            
            <!-- 基础信息卡片 -->
            <div id="simpleMaterialCard" class="card p-5 mb-4">
                <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-50">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center">
                            <i class="fas fa-cube text-orange-500"></i>
                        </div>
                        <h2 class="text-base font-bold text-gray-800">基础信息</h2>
                    </div>
                    <button type="button" id="toggleAdvancedBtn" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-full font-medium transition-colors" onclick="openAdvancedSettings()">
                        <i class="fas fa-sliders-h mr-1"></i>高级模式
                    </button>
                </div>

                <div class="form-group mb-4">
                    <label for="simpleMaterialName" class="form-label">材料名称 <span class="text-red-500">*</span></label>
                    <input type="text" id="simpleMaterialName" class="form-input" placeholder="例如：中筋面粉 / 黄油 / 鸡蛋" required>
                </div>

                <div class="form-group mb-4">
                    <label class="form-label">采购规格 <span class="text-red-500">*</span></label>
                    <div class="flex gap-2 mb-2">
                        <input type="number" id="simpleContent" class="form-input flex-1" placeholder="含量" min="0" step="0.01" required>
                        <select id="simpleUnit" class="form-select w-24" required>
                            <option value="g">克(g)</option>
                            <option value="kg">千克(kg)</option>
                            <option value="ml">毫升(ml)</option>
                            <option value="L">升(L)</option>
                            <option value="个">个</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-500 whitespace-nowrap">包装单位(选填):</span>
                        <select id="simpleContainer" class="form-select flex-1">
                            <option value="">无包装</option>
                            <option value="袋">袋</option>
                            <option value="箱">箱</option>
                            <option value="瓶">瓶</option>
                            <option value="罐">罐</option>
                        </select>
                    </div>
                    <div class="mt-2 text-xs text-orange-500 bg-orange-50 px-3 py-2 rounded-lg" id="simpleSpecPreview">
                        <i class="fas fa-info-circle mr-1"></i>示例：1 袋 = 500 g
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label for="simplePurchasePrice" class="form-label">采购价格 <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold">¥</span>
                        <input type="number" id="simplePurchasePrice" class="form-input pl-8" placeholder="0.00" min="0" step="0.01" required>
                    </div>
                </div>

                <!-- 简易成本预览 -->
                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-500">单位成本 (自动计算)</span>
                        <span id="simpleUnitCostDisplay" class="text-sm font-bold text-orange-600">¥0.00 / g</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5 mb-1">
                        <div class="bg-orange-400 h-1.5 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <!-- 高级模式卡片 (默认隐藏) -->
            <div id="advancedMaterialCard" class="card p-5 mb-4 hidden">
                <div class="flex items-center space-x-2 mb-6 pb-3 border-b border-gray-50">
                    <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                        <i class="fas fa-layer-group text-blue-500"></i>
                    </div>
                    <h2 class="text-base font-bold text-gray-800">详细设置</h2>
                </div>

                <!-- 图片上传 -->
                <div class="flex justify-center mb-6">
                    <div class="image-upload w-32 h-32 rounded-xl flex flex-col items-center justify-center cursor-pointer relative overflow-hidden group">
                        <input type="file" id="materialImage" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="previewImage(this)">
                        <img id="imagePreview" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                        <div class="text-center p-2 group-hover:scale-105 transition-transform">
                            <i class="fas fa-camera text-2xl text-gray-300 mb-2"></i>
                            <div class="text-xs text-gray-400">上传图片</div>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label class="form-label">材料分类</label>
                    <select id="materialCategory" class="form-select" onchange="handleCategoryChange()">
                        <option value="">请选择分类...</option>
                        <option value="flour">粉类</option>
                        <option value="oil">油脂类</option>
                        <option value="sugar">糖类</option>
                        <option value="dairy">乳制品</option>
                        <option value="egg">蛋类</option>
                        <option value="fruit">水果类</option>
                        <option value="nut">坚果类</option>
                        <option value="other">其他</option>
                        <option value="new_category" class="text-orange-500 font-bold">+ 新建分类</option>
                    </select>
                </div>

                <!-- 高级规格设置入口 -->
                <div class="form-group mb-4">
                    <label class="form-label">多级单位</label>
                    <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
                        <p class="text-xs text-blue-600 mb-3">设置如：1箱 = 12盒 = 2400g 的复杂换算关系</p>
                        <button type="button" onclick="showMultiLevelUnitSetting()" class="w-full bg-white text-blue-600 border border-blue-200 font-medium py-2 rounded-lg text-sm hover:bg-blue-50 transition-colors shadow-sm">
                            <i class="fas fa-cog mr-1"></i> 配置多级单位
                        </button>
                    </div>
                    <input type="hidden" id="specification">
                </div>

                <!-- 实际可用率 -->
                <div class="form-group mb-4">
                    <label class="form-label flex items-center justify-between">
                        <span>实际可用率</span>
                        <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded">损耗控制</span>
                    </label>
                    <div class="flex items-center gap-3">
                        <div class="relative flex-1">
                            <input type="number" id="simpleYield" class="form-input pr-8" placeholder="100" min="0" max="100" value="100">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">%</span>
                        </div>
                        <div class="text-xs text-gray-400 flex-shrink-0 w-32">
                            例如：鸡蛋去壳后只有85%可用
                        </div>
                    </div>
                </div>
            </div>

            <!-- 其他选项卡片 -->
            <div class="card p-5">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center">
                            <i class="fas fa-store text-purple-500"></i>
                        </div>
                        <div>
                            <h2 class="text-sm font-bold text-gray-800">销售设置</h2>
                            <p class="text-xs text-gray-400">是否允许直接销售此材料</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="simpleCanSell">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-50">
                     <div class="form-group">
                        <label class="form-label text-sm">库存预警阈值</label>
                        <div class="flex gap-2">
                            <input type="number" id="minStock" class="form-input" placeholder="数量">
                            <select id="minStockUnit" class="form-select w-24">
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="个">个</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>

    <!-- 模态框：多级单位设置 (全屏覆盖) -->
    <div id="unitSettingCard" class="fixed inset-0 bg-white z-[60] overflow-y-auto hidden">
        <div class="max-w-2xl mx-auto p-4">
            <div class="flex items-center justify-between mb-6 sticky top-0 bg-white py-2 z-10 border-b border-gray-100">
                <h2 class="text-lg font-bold text-gray-800">多级单位配置</h2>
                <button type="button" onclick="hideUnitSettingCard()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 模板选择 -->
            <div id="unitTemplates" class="mb-6">
                <h3 class="text-sm font-semibold text-gray-600 mb-3">快速模板</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" onclick="applyMultiLevelTemplate('flour')" class="p-3 bg-orange-50 border border-orange-100 rounded-xl text-left hover:bg-orange-100 transition-colors">
                        <div class="font-bold text-orange-700 text-sm mb-1">粉类模板</div>
                        <div class="text-xs text-orange-500">g → 袋(25kg)</div>
                    </button>
                    <button type="button" onclick="applyMultiLevelTemplate('liquid')" class="p-3 bg-blue-50 border border-blue-100 rounded-xl text-left hover:bg-blue-100 transition-colors">
                        <div class="font-bold text-blue-700 text-sm mb-1">液体模板</div>
                        <div class="text-xs text-blue-500">ml → 桶(20L)</div>
                    </button>
                    <button type="button" onclick="applyMultiLevelTemplate('boxPackPiece')" class="p-3 bg-green-50 border border-green-100 rounded-xl text-left hover:bg-green-100 transition-colors">
                        <div class="font-bold text-green-700 text-sm mb-1">零售模板</div>
                        <div class="text-xs text-green-500">个 → 盒 → 箱</div>
                    </button>
                </div>
            </div>

            <!-- 单位层级容器 -->
            <div id="unitLevels" class="space-y-4 mb-8">
                <!-- JS将在这里动态生成层级 -->
            </div>

            <button type="button" onclick="addUnitLevel()" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-medium hover:border-orange-400 hover:text-orange-500 transition-colors mb-6">
                <i class="fas fa-plus mr-1"></i> 添加上级包装单位
            </button>

            <div class="sticky bottom-4">
                <button type="button" onclick="confirmMultiLevelUnitSetting()" class="w-full btn-primary py-3 rounded-xl shadow-lg">
                    完成设置
                </button>
            </div>
        </div>
    </div>

    <!-- 模态框：新建分类 -->
    <div id="addCategoryModal" class="action-sheet">
        <div class="p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">新建分类</h3>
                <button onclick="hideAddCategoryModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="form-label">分类名称</label>
                    <input type="text" id="newCategoryName" class="form-input" placeholder="输入分类名称" oninput="updateCategoryCode()">
                </div>
                <div>
                    <label class="form-label">分类编码 (自动)</label>
                    <input type="text" id="newCategoryCode" class="form-input bg-gray-50" readonly>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="hideAddCategoryModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-medium">取消</button>
                    <button onclick="saveNewCategory()" class="flex-1 py-2.5 btn-primary rounded-xl font-medium">保存</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="categoryOverlay" onclick="hideAddCategoryModal()"></div>

    <!-- 脚本引用 -->
    <!-- 注意：为了保持原有功能，这里保留原有的大部分JS逻辑，但可能需要根据新的ID调整 -->
    <script>
        // ---------------------------------------------------------
        // 核心逻辑保留与适配
        // ---------------------------------------------------------

        // 切换高级模式
        function openAdvancedSettings() {
            document.getElementById('simpleMaterialCard').classList.add('hidden');
            document.getElementById('advancedMaterialCard').classList.remove('hidden');
            // 修改按钮状态或隐藏
            document.getElementById('toggleAdvancedBtn').style.display = 'none';
        }

        // 图片预览
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('imagePreview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ---------------------------------------------------------
        // 多级单位逻辑 (简化版适配)
        // ---------------------------------------------------------
        let multiLevelUnits = [
            { level: 1, name: 'g', ratio: 1, isBase: true, description: '最小计量单位' }
        ];

        function showMultiLevelUnitSetting() {
            document.getElementById('unitSettingCard').classList.remove('hidden');
            renderUnitLevels();
        }

        function hideUnitSettingCard() {
            document.getElementById('unitSettingCard').classList.add('hidden');
        }

        function renderUnitLevels() {
            const container = document.getElementById('unitLevels');
            container.innerHTML = '';

            multiLevelUnits.forEach((unit, index) => {
                const div = document.createElement('div');
                div.className = `unit-level p-4 rounded-xl border ${getBorderColor(unit.level)} bg-white shadow-sm`;
                div.setAttribute('data-level', unit.level);
                
                let content = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold ${getTextColor(unit.level)}">第 ${unit.level} 层级 ${unit.isBase ? '(基础)' : ''}</span>
                        ${!unit.isBase ? `<button onclick="removeUnitLevel(${index})" class="text-red-400 text-xs"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">单位名称</label>
                            ${unit.isBase ? 
                                `<select class="form-select text-sm" onchange="updateUnitData(${index}, 'name', this.value)">
                                    <option value="g" ${unit.name=='g'?'selected':''}>克 (g)</option>
                                    <option value="ml" ${unit.name=='ml'?'selected':''}>毫升 (ml)</option>
                                    <option value="个" ${unit.name=='个'?'selected':''}>个</option>
                                </select>` : 
                                `<input type="text" class="form-input text-sm" value="${unit.name}" placeholder="如：箱" onchange="updateUnitData(${index}, 'name', this.value)">`
                            }
                        </div>
                        ${!unit.isBase ? `
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">含下级数量</label>
                            <div class="flex items-center">
                                <input type="number" class="form-input text-sm" value="${unit.ratio}" onchange="updateUnitData(${index}, 'ratio', this.value)">
                                <span class="ml-2 text-xs text-gray-400">个${multiLevelUnits[index-1].name}</span>
                            </div>
                        </div>` : `
                        <div class="flex items-end pb-2">
                            <span class="text-xs text-gray-400">基础计量单位</span>
                        </div>
                        `}
                    </div>
                `;
                div.innerHTML = content;
                container.appendChild(div);
            });
        }

        function getBorderColor(level) {
            const colors = ['border-blue-200', 'border-green-200', 'border-orange-200', 'border-purple-200'];
            return colors[(level - 1) % colors.length];
        }

        function getTextColor(level) {
            const colors = ['text-blue-600', 'text-green-600', 'text-orange-600', 'text-purple-600'];
            return colors[(level - 1) % colors.length];
        }

        function addUnitLevel() {
            const newLevel = multiLevelUnits.length + 1;
            multiLevelUnits.push({
                level: newLevel,
                name: '',
                ratio: 1,
                isBase: false
            });
            renderUnitLevels();
        }

        function removeUnitLevel(index) {
            multiLevelUnits.splice(index, 1);
            // Re-assign levels
            multiLevelUnits.forEach((u, i) => u.level = i + 1);
            renderUnitLevels();
        }

        function updateUnitData(index, field, value) {
            multiLevelUnits[index][field] = value;
            if (field === 'name' && index < multiLevelUnits.length - 1) {
                renderUnitLevels(); // Re-render to update next level's label
            }
        }

        function applyMultiLevelTemplate(type) {
            if (type === 'flour') {
                multiLevelUnits = [
                    { level: 1, name: 'g', ratio: 1, isBase: true },
                    { level: 2, name: '袋', ratio: 25000, isBase: false }
                ];
            } else if (type === 'liquid') {
                multiLevelUnits = [
                    { level: 1, name: 'ml', ratio: 1, isBase: true },
                    { level: 2, name: '桶', ratio: 20000, isBase: false }
                ];
            } else if (type === 'boxPackPiece') {
                multiLevelUnits = [
                    { level: 1, name: '个', ratio: 1, isBase: true },
                    { level: 2, name: '盒', ratio: 12, isBase: false },
                    { level: 3, name: '箱', ratio: 10, isBase: false }
                ];
            }
            renderUnitLevels();
        }

        function confirmMultiLevelUnitSetting() {
            // 将设置回填到基础表单
            const baseUnit = multiLevelUnits[0].name;
            const topUnit = multiLevelUnits[multiLevelUnits.length - 1];
            
            // 简单的回填逻辑
            document.getElementById('simpleUnit').value = baseUnit;
            if (multiLevelUnits.length > 1) {
                 document.getElementById('simpleContainer').value = topUnit.name;
                 // 还可以计算总含量
                 let total = 1;
                 multiLevelUnits.forEach(u => total *= parseFloat(u.ratio));
                 document.getElementById('simpleContent').value = total;
            }

            hideUnitSettingCard();
        }

        // ---------------------------------------------------------
        // 分类管理
        // ---------------------------------------------------------
        function handleCategoryChange() {
            const select = document.getElementById('materialCategory');
            if (select.value === 'new_category') {
                showAddCategoryModal();
                select.value = ""; // Reset
            }
        }

        function showAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.add('active');
            document.getElementById('categoryOverlay').classList.add('show');
            generateCategoryCode();
        }

        function hideAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('active');
            document.getElementById('categoryOverlay').classList.remove('show');
        }

        function generateCategoryCode() {
            document.getElementById('newCategoryCode').value = 'CAT-' + Math.floor(Math.random() * 10000);
        }

        function updateCategoryCode() {
            // Optional: Dynamic code generation based on name
        }

        function saveNewCategory() {
            const name = document.getElementById('newCategoryName').value;
            const code = document.getElementById('newCategoryCode').value;
            if(name) {
                const select = document.getElementById('materialCategory');
                const option = document.createElement('option');
                option.value = code;
                option.text = name;
                select.add(option, select.options[select.length - 1]);
                select.value = code;
                hideAddCategoryModal();
            }
        }

        // ---------------------------------------------------------
        // 保存逻辑
        // ---------------------------------------------------------
        function saveMaterial(e) {
            e.preventDefault();
            // Collect data
            const name = document.getElementById('simpleMaterialName').value;
            if(!name) return alert('请输入材料名称');

            // Simulate save
            const btn = document.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中';
            btn.disabled = true;

            setTimeout(() => {
                alert('保存成功！');
                window.location.href = 'cailiao-zhuye.html';
            }, 1000);
            return false;
        }

        // 扫码功能 (模拟)
        function startScanCode() {
            alert('调起摄像头扫描条形码...');
        }
    </script>
</body>
</html>
