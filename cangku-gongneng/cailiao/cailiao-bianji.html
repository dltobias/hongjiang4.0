<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑材料 - 烘匠 BakeManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-recipe {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .gradient-message {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .gradient-inventory {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .gradient-order {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .gradient-success {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }
        .gradient-warning {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }
        
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            z-index: 50;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        .bottom-nav-item.active {
            color: #667eea;
        }
        .bottom-nav-item:hover {
            color: #667eea;
            transform: translateY(-1px);
        }
        .bottom-nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        .bottom-nav-item span {
            font-size: 12px;
        }
        .main-content {
            padding-bottom: 20px;
        }
        
        /* 快捷功能区样式 */
        .quick-action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 16px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .quick-action-btn.secondary {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);
        }
        .quick-action-btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(67, 233, 123, 0.4);
        }
        
        /* 单位层级样式 */
        .unit-level {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f9fafb;
            position: relative;
            margin-left: 0;
            transition: all 0.3s ease;
        }
        
        .unit-level[data-level="1"] {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #3b82f6;
            border-width: 2px;
        }
        
        .unit-level[data-level="2"] {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #10b981;
            margin-left: 20px;
        }
        
        .unit-level[data-level="3"] {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
            margin-left: 40px;
        }
        
        .unit-level[data-level="4"] {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border-color: #ec4899;
            margin-left: 60px;
        }
        
        .unit-level:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* 层级连接线 */
        .unit-level:not([data-level="1"]):before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            width: 16px;
            height: 2px;
            background: #d1d5db;
            transform: translateY(-50%);
        }
        
        .unit-level:not([data-level="1"]):after {
            content: '→';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 12px;
        }
        
        /* 换算关系预览 */
        .conversion-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .conversion-chain {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            color: #475569;
        }
        
        .conversion-step {
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 4px 8px;
            white-space: nowrap;
        }
        
        .conversion-arrow {
            color: #64748b;
            font-weight: bold;
        }
        
        /* 成本计算面板 */
        .cost-calculation-panel {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .cost-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0f2fe;
        }
        
        .cost-breakdown-item:last-child {
            border-bottom: none;
            font-weight: 600;
            color: #0369a1;
        }
        
        .cost-label {
            font-size: 13px;
            color: #475569;
        }
        
        .cost-value {
            font-size: 13px;
            font-weight: 500;
            color: #1e293b;
        }
        
        /* 单位层级结构图 */
        .unit-hierarchy-chart {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .hierarchy-node {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            font-size: 13px;
        }
        
        .hierarchy-node.base-unit {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        
        .hierarchy-node.regular-unit {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        
        .hierarchy-connector {
            width: 2px;
            height: 20px;
            background: #cbd5e1;
            margin-left: 20px;
        }
        
        /* 开关样式 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #667eea;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* ActionSheet样式 */
        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
        }
        
        .action-sheet.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        
        .action-sheet::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .action-sheet.active::before {
            opacity: 1;
        }
        
        .action-sheet-content {
            position: relative;
            background: white;
            border-radius: 20px 20px 0 0;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .action-sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 0 20px;
            border-bottom: 1px solid #f3f4f6;
            margin-bottom: 0;
        }
        
        .action-sheet-body {
            padding: 20px;
        }
        
        /* 成本预览样式 */
        .cost-preview {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-weight: 600;
            text-align: center;
            margin-top: 8px;
        }
        

        
        /* 单位模板样式 */
        .unit-templates {
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            border: 1px solid #bae6fd;
        }
        
        .template-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .template-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }
        
        .template-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .template-desc {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .template-example {
            font-size: 11px;
            color: #9ca3af;
            font-style: italic;
        }
        
        /* 引导式设置流程样式 */
        .unit-guide {
            margin-bottom: 20px;
        }
        
        .guide-step {
            display: none;
            padding: 16px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            margin-bottom: 16px;
        }
        
        .guide-step.active {
            display: block;
            border-color: #3b82f6;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
        }
        
        .step-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .step-desc {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .unit-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .unit-option {
            padding: 16px 12px;
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .unit-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .unit-option.selected {
            border-color: #3b82f6;
            background: #dbeafe;
        }
        
        .unit-option i {
            font-size: 20px;
            color: #3b82f6;
            margin-bottom: 8px;
        }
        
        .unit-option span {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .unit-option small {
            font-size: 11px;
            color: #6b7280;
        }
        
        .unit-builder {
            margin-bottom: 16px;
        }
        
        .unit-builder-item {
            padding: 12px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .unit-builder-item.bg-blue-50 {
            background: #eff6ff;
        }
        
        .unit-builder-item.border-blue-200 {
            border-color: #bfdbfe;
        }
        
        .unit-builder-item.bg-green-50 {
            background: #f0fdf4;
        }
        
        .unit-builder-item.border-green-200 {
            border-color: #bbf7d0;
        }
        
        .unit-builder-item.bg-orange-50 {
            background: #fff7ed;
        }
        
        .unit-builder-item.border-orange-200 {
            border-color: #fed7aa;
        }
        
        .w-16 {
            width: 4rem;
        }
        
        .min-w-20 {
            min-width: 5rem;
        }
        
        .flex-wrap {
            flex-wrap: wrap;
        }
        
        .text-xs {
            font-size: 12px;
        }
        
        .text-orange-600 {
            color: #ea580c;
        }
        
        .text-blue-600 {
            color: #2563eb;
        }
        
        .text-blue-700 {
            color: #1d4ed8;
        }
        
        .text-blue-500 {
            color: #3b82f6;
        }
        
        .text-green-600 {
            color: #16a34a;
        }
        
        .hover\:bg-red-100:hover {
            background-color: #fee2e2;
        }
        
        .rounded {
            border-radius: 0.25rem;
        }
        
        .p-1 {
            padding: 0.25rem;
        }
        
        .mt-1 {
            margin-top: 0.25rem;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .mb-3 {
            margin-bottom: 0.75rem;
        }
        
        .py-8 {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        
        .text-3xl {
            font-size: 1.875rem;
            line-height: 2.25rem;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* 快速模板样式 */
        .template-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .template-option {
            padding: 12px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .template-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .template-name {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .template-option small {
            font-size: 12px;
            color: #6b7280;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .unit-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .add-unit-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .add-unit-btn:hover {
            background: #2563eb;
        }
        
        .unit-summary {
            padding: 16px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .guide-actions {
            display: flex;
            gap: 12px;
        }
        
        .confirm-btn {
            flex: 1;
            padding: 12px 16px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .confirm-btn:hover {
            background: #059669;
        }
        
        .reset-btn {
            padding: 12px 16px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .reset-btn:hover {
            background: #4b5563;
        }
        
        /* 实际可用量展开/收起样式 */
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes pulse-help {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
        
        .animate-pulse-help {
            animation: pulse-help 2s ease-in-out infinite;
        }
        
        /* 价格输入和成本预览样式 */
        .price-input-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e9ecef;
        }
        
        .cost-preview-section {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .cost-item:last-child {
            border-bottom: none;
            font-weight: 600;
            background: #f8f9fa;
            margin: 8px -16px -16px;
            padding: 12px 16px;
            border-radius: 0 0 8px 8px;
        }
        
        .cost-label {
            color: #666;
            font-size: 14px;
        }
        
        .cost-value {
            color: #333;
            font-weight: 500;
        }
        
        .cost-value.highlight {
            color: #007bff;
            font-weight: 600;
        }
        
        .flex {
            display: flex;
        }
        
        .flex-1 {
            flex: 1;
        }
        
        .gap-2 {
            gap: 8px;
        }
        
        .mt-3 {
            margin-top: 12px;
        }
        
        .mb-4 {
            margin-bottom: 16px;
        }
        
        .items-center {
            align-items: center;
        }
        
        .text-sm {
            font-size: 14px;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .text-gray-700 {
            color: #374151;
        }
        
        .text-gray-500 {
            color: #6b7280;
        }
        
        .block {
            display: block;
        }
        
        .form-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* 单位关系图样式 */
        .unit-relation-chart {
            margin-bottom: 20px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .test-btn {
            padding: 6px 12px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .test-btn:hover {
            background: #d97706;
        }
        
        .relation-nodes {
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .empty-state {
            text-align: center;
        }
        
        .relation-chain {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .relation-node {
            padding: 12px 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-radius: 8px;
            text-align: center;
            min-width: 80px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .relation-arrow {
            color: #6b7280;
            font-size: 18px;
            text-align: center;
            margin: 8px 0;
        }
        
        .node-unit {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .node-ratio {
            font-size: 11px;
            opacity: 0.9;
        }
        
        .conversion-summary {
            margin-top: 16px;
            padding: 12px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 8px;
        }
        
        .summary-title {
            font-size: 12px;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 6px;
        }
        
        .summary-content {
            text-align: center;
        }
        
        .summary-content .highlight {
            font-size: 14px;
            font-weight: 700;
            color: #0c4a6e;
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            display: inline-block;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* 换算测试器样式 */
        .conversion-tester {
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            border: 1px solid #f59e0b;
        }
        
        .tester-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .tester-title {
            font-size: 14px;
            font-weight: 600;
            color: #92400e;
        }
        
        .close-btn {
            padding: 4px 8px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .tester-content {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .test-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .conversion-arrow {
            color: #92400e;
            font-size: 18px;
        }
        
        .test-result {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-text {
            font-size: 16px;
            font-weight: 600;
            color: #92400e;
            min-width: 60px;
        }
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* 规格设置样式 */
        .specification-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .specification-input-group .form-input,
        .specification-input-group .form-select {
            min-width: 0;
        }
        
        .specification-preview {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
        }
        
        .w-24 {
            width: 6rem;
        }
        
        .w-20 {
            width: 5rem;
        }
        
        /* 图片上传样式 */
        .image-upload {
            position: relative;
            width: 100px;
            height: 100px;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
        }
        .image-upload:hover {
            border-color: #667eea;
        }
        .image-upload input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .image-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        .image-upload.has-image .upload-icon,
        .image-upload.has-image .upload-text {
            display: none;
        }
        .image-upload.has-image img {
            display: block;
        }
        
        /* 必填项标记 */
        .required::after {
            content: '*';
            color: #ef4444;
            margin-left: 0.25rem;
        }
        
        /* 价格设置样式 */
        .price-input-container {
            space-y: 8px;
        }
        
        .price-input-group {
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0;
            transition: all 0.2s;
        }
        
        .price-input-group:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .currency-symbol {
            padding: 12px 8px 12px 12px;
            color: #64748b;
            font-weight: 500;
            background: #f1f5f9;
            border-right: 1px solid #e2e8f0;
        }
        
        .price-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 8px;
            font-size: 16px;
            font-weight: 500;
            outline: none;
        }
        
        .unit-display {
            display: flex;
            align-items: center;
            padding: 12px 12px 12px 8px;
            background: #f1f5f9;
            border-left: 1px solid #e2e8f0;
        }
        
        .unit-text {
            color: #64748b;
            font-size: 14px;
        }
        
        .unit-name {
            color: #3b82f6;
            font-weight: 600;
            font-size: 14px;
        }
        
        .price-help-text {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #64748b;
            font-size: 12px;
            margin-top: 6px;
        }
        
        .price-help-text i {
            color: #94a3b8;
        }
        

        
        .calculator-section {
            margin-bottom: 20px;
        }
        
        .calculator-section:last-child {
            margin-bottom: 0;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .cost-breakdown {
            space-y: 8px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 6px;
        }
        
        .breakdown-item.highlight {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #93c5fd;
        }
        
        .breakdown-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .breakdown-value {
            font-size: 13px;
            color: #111827;
            font-weight: 600;
        }
        
        .breakdown-item.highlight .breakdown-value {
            color: #1d4ed8;
        }
        
        .custom-calc {
            space-y: 12px;
        }
        
        .calc-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .calc-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }
        
        .calc-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .calc-select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            outline: none;
            min-width: 100px;
        }
        
        .calc-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #a7f3d0;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .result-label {
            font-size: 14px;
            color: #065f46;
            font-weight: 500;
        }
        
        .result-value {
            font-size: 16px;
            color: #047857;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 顶部状态栏 -->
    <div class="bg-white px-4 py-3 flex items-center justify-between shadow-sm">
        <div class="flex items-center space-x-3">
            <button onclick="history.back()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">
                <i class="fas fa-chevron-left text-gray-600"></i>
            </button>
            <div>
                <div class="text-lg font-semibold text-gray-800" id="pageTitle">编辑材料</div>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="startScanCode()" class="bg-gradient-to-r from-green-500 to-teal-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:from-green-600 hover:to-teal-700 transition-all shadow-sm">
                <i class="fas fa-qrcode mr-1"></i>扫码
            </button>
            <button type="submit" form="editMaterialForm" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:from-blue-600 hover:to-purple-700 transition-all shadow-sm">
                <i class="fas fa-save mr-1"></i>保存修改
            </button>
        </div>
    </div>



    <!-- 主内容区域 -->
    <div class="main-content p-4">
        <form id="editMaterialForm" onsubmit="return updateMaterial(event)">
            <!-- 基本信息 -->
            <div class="card bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-100">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="w-6 h-6 rounded-lg gradient-primary flex items-center justify-center">
                        <i class="fas fa-info text-white text-xs"></i>
                    </div>
                    <h2 class="text-sm font-semibold text-gray-800">基本信息</h2>
                </div>
                
                <!-- 材料图片 -->
                <div class="form-group flex justify-center mb-6">
                    <div class="image-upload" id="imageUploadContainer">
                        <input type="file" id="materialImage" accept="image/*" onchange="previewImage(this)">
                        <i class="fas fa-camera upload-icon text-gray-400 text-xl mb-1"></i>
                        <span class="upload-text text-xs text-gray-500">上传图片</span>
                        <img id="imagePreview" src="#" alt="材料图片">
                    </div>
                </div>
                
                <!-- 材料名称 -->
                <div class="form-group">
                    <label for="materialName" class="form-label required">材料名称</label>
                    <input type="text" id="materialName" class="form-input" placeholder="请输入材料名称" required>
                </div>
                
                <!-- 所属仓库 -->
                <div class="form-group">
                    <label for="warehouse" class="form-label required">所属仓库</label>
                    <select id="warehouse" class="form-select" required>
                        <option value="">请选择仓库</option>
                        <option value="main">主仓库</option>
                        <option value="raw_material">原料仓库</option>
                        <option value="finished_goods">成品仓库</option>
                        <option value="cold_storage">冷藏仓库</option>
                        <option value="dry_storage">干货仓库</option>
                    </select>
                </div>
                
                <!-- 材料分类 -->
                <div class="form-group">
                    <label for="materialCategory" class="form-label required">材料分类</label>
                    <div class="flex items-center space-x-2">
                        <select id="materialCategory" class="form-select flex-1" required onchange="handleCategoryChange()">
                            <option value="">请选择分类</option>
                            <option value="flour">粉类</option>
                            <option value="oil">油脂类</option>
                            <option value="sugar">糖类</option>
                            <option value="dairy">乳制品</option>
                            <option value="egg">蛋类</option>
                            <option value="fruit">水果类</option>
                            <option value="nut">坚果类</option>
                            <option value="other">其他</option>
                            <option value="new_category">+ 新建分类</option>
                        </select>
                        <button type="button" id="addCategoryBtn" onclick="showAddCategoryModal()" class="bg-green-500 text-white px-3 py-2 rounded-lg text-xs hover:bg-green-600 transition-colors" style="display: none;">
                            <i class="fas fa-plus mr-1"></i>新建
                        </button>
                    </div>
                </div>
                
                <!-- 规格设置 (多层级单位设置) -->
                <div class="form-group">
                    <label for="specification" class="form-label required">规格</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="specificationNumber" class="form-input w-24" placeholder="数量" min="0" step="0.01" value="1" oninput="updateSpecificationDisplay()">
                        <select id="specificationUnit" class="form-select w-20" onchange="updateSpecificationDisplay()">
                            <option value="g" selected>g</option>
                            <option value="kg">kg</option>
                            <option value="ml">ml</option>
                            <option value="L">L</option>
                            <option value="个">个</option>
                            <option value="袋">袋</option>
                            <option value="包">包</option>
                            <option value="盒">盒</option>
                            <option value="箱">箱</option>
                            <option value="瓶">瓶</option>
                            <option value="桶">桶</option>
                        </select>
                        <span class="text-gray-500">/</span>
                        <select id="specificationPackage" class="form-select w-20" onchange="updateSpecificationDisplay(); updateStockUnitOptions();">
                            <option value="">包装</option>
                            <option value="袋">袋</option>
                            <option value="包">包</option>
                            <option value="盒">盒</option>
                            <option value="箱">箱</option>
                            <option value="瓶">瓶</option>
                            <option value="桶">桶</option>
                            <option value="托盘">托盘</option>
                        </select>
                        <button type="button" onclick="showMultiLevelUnitSetting()" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-xs hover:bg-blue-600 transition-colors">
                            <i class="fas fa-cog"></i> 自定义规格
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        <span id="specificationPreview" class="font-medium text-gray-700">请选择数量和单位</span>
                        <br>点击"自定义规格"按钮可配置复杂的多层级单位关系
                    </div>
                    <input type="hidden" id="specification" required>
                </div>
                
                <!-- 采购价格 -->
                <div class="form-group">
                    <label for="purchasePrice" class="form-label required">采购价格</label>
                    <div class="price-input-container">
                        <div class="price-input-group">
                            <span class="currency-symbol">¥</span>
                            <input type="number" id="purchasePrice" class="price-input" placeholder="0.00" min="0" step="0.01" required oninput="updateUsablePortionDisplay()">
                            <div class="unit-display">
                                <span class="unit-text">/ </span>
                                <span id="purchaseUnitName" class="unit-name">采购价格</span>
                            </div>
                        </div>
                        <div class="price-help-text">
                            <i class="fas fa-info-circle"></i>
                            <span>请输入您采购时的实际价格</span>
                        </div>
                    </div>
                </div>
                
                <!-- 可使用部分 -->
                <div class="form-group">
                    <!-- 折叠状态显示 -->
                    <div id="usablePortionCollapsed" class="cursor-pointer mb-4" onclick="expandUsablePortion()">
                        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200 hover:from-green-100 hover:to-emerald-100 transition-all duration-200 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-calculator text-white text-xs"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-800">实际可用量设置</span>
                                    <span class="text-xs text-green-600 ml-2">（选填）</span>
                                    <div class="text-xs text-gray-600 mt-1">请输入可使用材料时的实际成本价格</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span id="usablePortionSummary" class="text-xs text-gray-700 bg-white px-2 py-1 rounded-full">默认100%可用</span>
                                <i id="usablePortionToggleIcon" class="fas fa-chevron-down text-green-600 text-sm transition-transform"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 展开状态填写区域 -->
                    <div id="usablePortionExpanded" class="mt-3" style="display: none;">
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="mb-4">
                                <div class="flex items-center space-x-2 mb-2">
                                    <i class="fas fa-calculator text-blue-600 text-sm"></i>
                                    <span class="text-sm font-semibold text-blue-800">实际可用量计算</span>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 mb-3">
                                    <div class="text-xs text-blue-700 mb-2">
                                        <i class="fas fa-lightbulb mr-1"></i>
                                        <span class="font-medium">功能说明：</span>
                                    </div>
                                    <div class="text-xs text-blue-600 space-y-1">
                                        <div>• 考虑损耗、不可食用部分等因素的实际可使用量</div>
                                        <div>• <span class="font-medium">示例：</span>鸡蛋采购500g，实际蛋液只有350g可用</div>
                                        <div>• 系统将自动调整成本计算，确保配方成本准确</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs font-medium text-gray-700 mb-2 block">
                                        <i class="fas fa-edit mr-1"></i>请输入实际可使用的部分
                                        <span class="text-xs text-blue-600 ml-2">（单位自动同步规格单位）</span>
                                    </label>
                                    <div class="flex items-center space-x-2">
                                                                                 <input type="number" id="usablePortion" class="form-input flex-1" placeholder="如：350（表示350g可用）" min="0" step="0.01" oninput="updateUsablePortionDisplay()" onfocus="showUsablePortionExample(); syncUsablePortionUnit()" onblur="hideUsablePortionExample()">
                                        <select id="usablePortionUnit" class="form-select w-20" onchange="updateUsablePortionDisplay()">
                                            <option value="">单位</option>
                                            <option value="g">g</option>
                                            <option value="kg">kg</option>
                                            <option value="ml">ml</option>
                                            <option value="L">L</option>
                                            <option value="个">个</option>
                                            <option value="袋">袋</option>
                                            <option value="包">包</option>
                                            <option value="盒">盒</option>
                                            <option value="箱">箱</option>
                                            <option value="瓶">瓶</option>
                                            <option value="桶">桶</option>
                                        </select>
                                        <div class="bg-gray-100 px-3 py-2 rounded-lg min-w-20 text-center">
                                            <div class="text-xs text-gray-500">可用率</div>
                                            <div id="usablePortionDisplay" class="font-medium text-blue-600">100%</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-amber-50 p-3 rounded-lg border border-amber-200">
                                    <div class="text-xs text-amber-700">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        <span class="font-medium">提示：</span>
                                        如鸡蛋采购500g，但蛋液只有350g可用，请输入350。留空则按100%计算。
                                    </div>
                                </div>
                                
                                <!-- 动态示例提示 -->
                                <div id="usablePortionExample" class="bg-green-50 p-3 rounded-lg border border-green-200 mt-2" style="display: none;">
                                    <div class="text-xs text-green-700">
                                        <i class="fas fa-lightbulb mr-1"></i>
                                        <span class="font-medium">常见示例：</span>
                                    </div>
                                    <div class="text-xs text-green-600 mt-2 space-y-1">
                                        <div>• 鸡蛋：采购500g → 蛋液350g可用（去壳损耗）</div>
                                        <div>• 鱼类：采购1000g → 鱼肉600g可用（去骨去鳞）</div>
                                        <div>• 水果：采购1000g → 果肉800g可用（去皮去核）</div>
                                        <div>• 面粉：采购1000g → 1000g可用（无损耗）</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 成本影响预览 -->
                            <div id="costImpactPreview" class="p-3 bg-white rounded-lg border border-blue-200 text-xs" style="display: none;">
                                <div class="text-blue-700 font-medium mb-2">
                                    <i class="fas fa-chart-line mr-1"></i>成本调整结果
                                </div>
                                <div class="flex justify-between mb-1">
                                    <span>采购成本：</span>
                                    <span id="originalCostDisplay">¥0.00</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span>实际使用成本：</span>
                                    <span id="adjustedCostDisplay" class="font-medium text-blue-800">¥0.00</span>
                                </div>
                                <div class="flex justify-between border-t border-blue-200 pt-2 mb-1">
                                    <span id="originalCostPerUnitLabel">采购每g成本：</span>
                                    <span id="originalCostPerUnit">¥0.0000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span id="adjustedCostPerUnitLabel">实际每g成本：</span>
                                    <span id="adjustedCostPerUnit" class="font-medium text-blue-800">¥0.0000</span>
                                </div>
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="flex justify-end space-x-2 mt-3">
                                <button type="button" onclick="clearUsablePortion()" class="px-3 py-1 text-xs text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition-colors">
                                    清空
                                </button>
                                <button type="button" onclick="collapseUsablePortion()" class="px-3 py-1 text-xs text-blue-600 bg-blue-100 rounded hover:bg-blue-200 transition-colors">
                                    收起
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 是否可售卖 -->
                <div class="form-group mt-6">
                    <div class="p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-shopping-cart text-blue-500"></i>
                                <label for="canSell" class="form-label mb-0 font-medium text-gray-800">是否可售卖</label>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="canSell">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="text-xs text-gray-600 mt-2 ml-6">开启后该材料可在销售系统中使用</div>
                    </div>
                </div>
            </div>
            


            <!-- 多层级单位设置 -->
            <div id="unitSettingCard" class="card bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-100" style="display: none;">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-6 h-6 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center">
                            <i class="fas fa-layer-group text-white text-xs"></i>
                        </div>
                        <h2 class="text-sm font-semibold text-gray-800">多层级单位设置</h2>
                        <button type="button" onclick="toggleUnitHelp()" class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition-all flex items-center justify-center" title="点击查看帮助说明">
                            <i id="helpIcon" class="fas fa-question text-xs"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button type="button" onclick="addUnitLevel()" class="text-blue-500 text-xs hover:text-blue-700">
                            <i class="fas fa-plus"></i> 添加上级
                        </button>
                        <button type="button" onclick="hideUnitSettingCard()" class="text-red-500 text-xs hover:text-red-700">
                            <i class="fas fa-times"></i> 关闭
                        </button>
                    </div>
                </div>
                
                <!-- 单位设置帮助说明 -->
                <div id="unitHelpPanel" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-4 border border-blue-200 transition-all duration-300">
                    <!-- 关闭提示 -->
                    <div class="flex items-center justify-between mb-3 pb-2 border-b border-blue-200">
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center">
                                <i class="fas fa-lightbulb text-white text-xs"></i>
                            </div>
                            <span class="text-sm font-semibold text-blue-800">功能说明</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-blue-600">再次点击问号收起</span>
                            <div class="w-4 h-4 rounded-full bg-red-100 flex items-center justify-center">
                                <i class="fas fa-times text-red-600 text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0 mt-1">
                            <i class="fas fa-lightbulb text-white text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-blue-800 mb-2">什么是多层级单位？</h4>
                            <p class="text-sm text-blue-700 mb-3">
                                多层级单位让您更灵活地管理材料的不同规格，方便采购、库存和配方使用。
                            </p>
                            <div class="space-y-3">
                                <div class="bg-white rounded-lg p-3 border border-blue-200">
                                    <div class="font-medium text-blue-800 text-sm mb-2 flex items-center">
                                        <i class="fas fa-seedling mr-2"></i>示例：面粉管理
                                    </div>
                                    <div class="text-xs text-blue-600 space-y-1">
                                        <div class="flex items-center">
                                            <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
                                            <span><strong>基础单位：</strong>g（配方中使用）</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                                            <span><strong>包装单位：</strong>500g/袋（便于使用）</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="w-2 h-2 bg-orange-400 rounded-full mr-2"></span>
                                            <span><strong>采购单位：</strong>20袋/箱（便于采购）</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-white rounded-lg p-3 border border-blue-200">
                                    <div class="font-medium text-blue-800 text-sm mb-2 flex items-center">
                                        <i class="fas fa-glass-whiskey mr-2"></i>示例：牛奶管理
                                    </div>
                                    <div class="text-xs text-blue-600 space-y-1">
                                        <div class="flex items-center">
                                            <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
                                            <span><strong>基础单位：</strong>ml（配方中使用）</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                                            <span><strong>包装单位：</strong>1000ml/瓶（使用单位）</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="w-2 h-2 bg-orange-400 rounded-full mr-2"></span>
                                            <span><strong>采购单位：</strong>12瓶/箱（采购单位）</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 grid grid-cols-2 gap-2">
                                <div class="bg-green-50 p-2 rounded-lg border border-green-200">
                                    <div class="text-xs text-green-700">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        <strong>优点：</strong>方便成本核算
                                    </div>
                                </div>
                                <div class="bg-green-50 p-2 rounded-lg border border-green-200">
                                    <div class="text-xs text-green-700">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        <strong>优点：</strong>简化库存管理
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-list-ol text-purple-600 mr-2"></i>
                                    <span class="font-semibold text-purple-800 text-sm">操作步骤指导</span>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-start space-x-2">
                                        <div class="w-5 h-5 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center flex-shrink-0 mt-0.5">1</div>
                                        <div class="text-xs text-purple-700">
                                            <span class="font-medium">选择基础单位：</span>在"基础单位"下拉框中选择最小计量单位（如g、ml等）
                                        </div>
                                    </div>
                                    <div class="flex items-start space-x-2">
                                        <div class="w-5 h-5 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center flex-shrink-0 mt-0.5">2</div>
                                        <div class="text-xs text-purple-700">
                                            <span class="font-medium">添加包装层级：</span>点击"添加上级"按钮，设置包装单位和换算比例
                                        </div>
                                    </div>
                                    <div class="flex items-start space-x-2">
                                        <div class="w-5 h-5 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center flex-shrink-0 mt-0.5">3</div>
                                        <div class="text-xs text-purple-700">
                                            <span class="font-medium">设置换算关系：</span>输入上级单位包含多少个下级单位（如1袋=500g）
                                        </div>
                                    </div>
                                    <div class="flex items-start space-x-2">
                                        <div class="w-5 h-5 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center flex-shrink-0 mt-0.5">4</div>
                                        <div class="text-xs text-purple-700">
                                            <span class="font-medium">完成设置：</span>点击"完成设置"按钮保存多层级单位配置
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3 p-2 bg-white rounded-lg border border-purple-200">
                                    <div class="text-xs text-purple-700">
                                        <i class="fas fa-lightbulb mr-1"></i>
                                        <span class="font-medium">快速上手：</span>
                                        <div class="mt-1 space-y-1">
                                            <div>• 简单材料：只设置基础单位即可</div>
                                            <div>• 复杂材料：基础单位 → 包装单位 → 采购单位</div>
                                            <div>• 系统会自动计算所有层级的成本关系</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center">
                                        <i class="fas fa-play-circle text-green-600 mr-2"></i>
                                        <span class="font-semibold text-green-800 text-sm">操作演示</span>
                                    </div>
                                    <button type="button" onclick="toggleOperationDemo()" class="text-xs text-green-600 hover:text-green-800 transition-colors">
                                        <span id="demoToggleText">展开演示</span>
                                        <i id="demoToggleIcon" class="fas fa-chevron-down ml-1"></i>
                                    </button>
                                </div>
                                <div id="operationDemo" class="hidden space-y-3">
                                    <div class="bg-white rounded-lg p-3 border border-green-200">
                                        <div class="font-medium text-green-800 text-sm mb-2">演示：设置面粉的多层级单位</div>
                                        <div class="space-y-2">
                                            <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                                                <div class="w-6 h-6 rounded-full bg-blue-500 text-white text-xs flex items-center justify-center">1</div>
                                                <div class="text-xs">基础单位选择"g"</div>
                                                <div class="ml-auto bg-blue-100 px-2 py-1 rounded text-xs text-blue-700">g</div>
                                            </div>
                                            <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                                                <div class="w-6 h-6 rounded-full bg-green-500 text-white text-xs flex items-center justify-center">2</div>
                                                <div class="text-xs">添加包装单位"袋"，1袋=500g</div>
                                                <div class="ml-auto bg-green-100 px-2 py-1 rounded text-xs text-green-700">500g/袋</div>
                                            </div>
                                            <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                                                <div class="w-6 h-6 rounded-full bg-orange-500 text-white text-xs flex items-center justify-center">3</div>
                                                <div class="text-xs">添加采购单位"箱"，1箱=20袋</div>
                                                <div class="ml-auto bg-orange-100 px-2 py-1 rounded text-xs text-orange-700">20袋/箱</div>
                                            </div>
                                        </div>
                                        <div class="mt-3 p-2 bg-blue-50 rounded border border-blue-200">
                                            <div class="text-xs text-blue-700">
                                                <i class="fas fa-calculator mr-1"></i>
                                                <span class="font-medium">自动计算结果：</span>
                                                1箱 = 20袋 = 10,000g
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-lg p-3 border border-green-200">
                                        <div class="font-medium text-green-800 text-sm mb-2">常见设置模式</div>
                                        <div class="grid grid-cols-1 gap-2">
                                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                <span class="text-xs text-gray-700">简单模式</span>
                                                <span class="text-xs text-blue-600">只设基础单位</span>
                                            </div>
                                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                <span class="text-xs text-gray-700">标准模式</span>
                                                <span class="text-xs text-green-600">基础+包装单位</span>
                                            </div>
                                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                <span class="text-xs text-gray-700">完整模式</span>
                                                <span class="text-xs text-orange-600">基础+包装+采购</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 p-2 bg-yellow-50 rounded-lg border border-yellow-200">
                                <div class="text-xs text-yellow-700">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <strong>小贴士：</strong>如果您的材料只有一种规格，只需设置基础单位即可！
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 多层级单位录入区域 -->
                <div id="unitLevels" class="mb-4">
                    <!-- 基础单位（第一层级） -->
                    <div class="unit-level" data-level="1">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-blue-700">基础单位（第1层级）</span>
                            <span class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">最小计量单位</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-600 mb-1 block">单位名称</label>
                                <select class="form-select text-sm unit-name" data-level="1" onchange="updateUnitDisplays(); updateConversionPreview();">
                                    <option value="">请选择基础单位</option>
                                    <option value="g">g</option>
                                    <option value="kg">kg</option>
                                    <option value="ml">ml</option>
                                    <option value="L">L</option>
                                    <option value="个">个</option>
                                    <option value="袋">袋</option>
                                    <option value="包">包</option>
                                    <option value="盒">盒</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600 mb-1 block">说明</label>
                                <div class="bg-gray-50 px-3 py-2 rounded text-sm text-gray-600">
                                    配方中使用的最小单位
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 添加层级按钮 -->
                <div class="text-center mb-4">
                    <button type="button" onclick="addUnitLevel()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors mr-2">
                        <i class="fas fa-plus mr-2"></i>添加上级包装单位
                    </button>
                    <button type="button" onclick="confirmMultiLevelUnitSetting()" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600 transition-colors">
                        <i class="fas fa-check mr-2"></i>完成设置
                    </button>
                </div>
                

                
                <!-- 简化的引导式设置流程 -->
                <div id="unitGuide" class="unit-guide" style="display: none;">
                    <!-- 步骤1：选择最小计量单位 -->
                    <div class="guide-step active" id="step1">
                        <div class="step-header">
                            <span class="step-number">1</span>
                            <span class="step-title">选择最小计量单位</span>
                        </div>
                        <div class="step-content">
                            <p class="step-desc">最小计量单位是配方中使用的基础单位，请选择：</p>
                            <div class="unit-options">
                                <div class="unit-option" onclick="selectBaseUnit('g')">
                                    <i class="fas fa-weight"></i>
                                    <span>克(g)</span>
                                    <small>面粉、糖等固体</small>
                                </div>
                                <div class="unit-option" onclick="selectBaseUnit('kg')">
                                    <i class="fas fa-weight-hanging"></i>
                                    <span>千克(kg)</span>
                                    <small>大包装固体</small>
                                </div>
                                <div class="unit-option" onclick="selectBaseUnit('ml')">
                                    <i class="fas fa-tint"></i>
                                    <span>毫升(ml)</span>
                                    <small>牛奶、油等液体</small>
                                </div>
                                <div class="unit-option" onclick="selectBaseUnit('L')">
                                    <i class="fas fa-flask"></i>
                                    <span>升(L)</span>
                                    <small>大桶装液体</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 步骤2：添加包装单位 -->
                    <div class="guide-step" id="step2">
                        <div class="step-header">
                            <span class="step-number">2</span>
                            <span class="step-title">添加包装单位</span>
                        </div>
                        <div class="step-content">
                            <p class="step-desc">添加您使用的包装单位，从小到大设置：</p>
                            
                            <div class="bg-blue-50 p-3 rounded-lg mb-4">
                                <div class="text-blue-700 font-medium mb-1">最小计量单位</div>
                                <div class="text-blue-600" id="baseUnitDisplay">克(g)</div>
                            </div>
                            
                            <div id="unitBuilder" class="space-y-3">
                                <!-- 动态生成单位构建器 -->
                            </div>
                            
                            <button type="button" onclick="addPackagingUnit()" class="mt-3 w-full py-2 bg-blue-500 text-white rounded-lg flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i> 添加包装单位
                            </button>
                            
                            <div class="mt-4 text-center">
                                <button type="button" onclick="proceedToStep3()" class="px-4 py-2 bg-green-500 text-white rounded-lg">
                                    下一步 <i class="fas fa-arrow-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 步骤3：设置采购价格 -->
                    <div class="guide-step" id="step3">
                        <div class="step-header">
                            <span class="step-number">3</span>
                            <span class="step-title">设置采购价格</span>
                        </div>
                        <div class="step-content">
                            <div id="unitSummary" class="bg-gray-50 p-4 rounded-lg mb-4">
                                <!-- 显示单位设置摘要 -->
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">采购价格</label>
                                    <div class="flex items-center">
                                        <span class="bg-gray-100 px-3 py-2 rounded-l-lg text-gray-600">¥</span>
                                        <input type="number" id="purchasePriceInput" class="flex-1 border-l-0 border border-gray-300 rounded-r-lg px-3 py-2" placeholder="0.00" min="0" step="0.01" oninput="updateCostSummary()">
                                        <span class="ml-2 text-gray-600">/ <span id="topUnitDisplay">箱</span></span>
                                    </div>
                                </div>
                                
                                <div id="costSummary" class="bg-blue-50 p-4 rounded-lg">
                                    <div class="text-blue-700 font-medium mb-2">成本计算结果</div>
                                    <div id="costResults" class="space-y-2">
                                        <!-- 成本计算结果将在这里动态显示 -->
                                        <div class="text-center text-gray-500">
                                            请输入采购价格查看计算结果
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 flex justify-between">
                                <button type="button" onclick="showGuideStep(2)" class="px-4 py-2 bg-gray-400 text-white rounded-lg">
                                    <i class="fas fa-arrow-left mr-1"></i> 上一步
                                </button>
                                <button type="button" onclick="confirmUnitSetup()" class="px-4 py-2 bg-green-500 text-white rounded-lg">
                                    完成设置 <i class="fas fa-check ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                

                
                <!-- 实际单位设置（隐藏的技术实现） -->
                <div id="actualUnitLevels" style="display: none;">
                    <!-- 这里存储实际的单位层级数据 -->
                </div>
            </div>
            
            <!-- 其他信息 -->
            <div class="card bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-100">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="w-6 h-6 rounded-lg bg-gradient-to-r from-gray-500 to-gray-600 flex items-center justify-center">
                        <i class="fas fa-info-circle text-white text-xs"></i>
                    </div>
                    <h2 class="text-sm font-semibold text-gray-800">其他信息（选填）</h2>
                </div>
                
                <!-- 条形码 -->
                <div class="form-group">
                    <label for="barcode" class="form-label">条形码</label>
                    <div class="relative">
                        <input type="text" id="barcode" class="form-input pr-10" placeholder="请输入条形码">
                        <button type="button" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400" onclick="scanBarcode()">
                            <i class="fas fa-barcode text-lg"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 材料编码 -->
                <div class="form-group">
                    <label for="materialCode" class="form-label">材料编码</label>
                    <div class="relative">
                        <input type="text" id="materialCode" class="form-input pr-32" placeholder="自动生成" readonly>
                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex items-center space-x-1">
                            <button type="button" onclick="generateMaterialCode()" class="text-green-600 text-xs hover:text-green-800">
                                <i class="fas fa-sync-alt"></i> 生成
                            </button>
                            <button type="button" onclick="toggleCodeEdit()" class="text-blue-500 text-xs hover:text-blue-700">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">格式：MAT+日期+流水号，点击生成可重新生成编码</div>
                </div>
            </div>
            
            <!-- 库存信息 -->
            <div class="card bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-6 h-6 rounded-lg gradient-inventory flex items-center justify-center">
                            <i class="fas fa-boxes text-white text-xs"></i>
                        </div>
                        <h2 class="text-sm font-semibold text-gray-800">库存信息（选填）</h2>
                    </div>
                    <div class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded-full">
                        <i class="fas fa-sync-alt mr-1"></i>单位自动同步
                    </div>
                </div>
                
                <!-- 当前库存 -->
                <div class="form-group">
                    <label for="currentStock" class="form-label">当前库存</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="currentStock" class="form-input flex-1" placeholder="请输入库存数量" min="0" step="0.01">
                        <select id="stockUnit" class="form-select w-20" onchange="updateStockUnitDisplay()">
                            <option value="">单位</option>
                            <option value="g">g</option>
                            <option value="kg">kg</option>
                            <option value="ml">ml</option>
                            <option value="L">L</option>
                            <option value="个">个</option>
                            <option value="袋">袋</option>
                            <option value="包">包</option>
                            <option value="盒">盒</option>
                            <option value="箱">箱</option>
                            <option value="瓶">瓶</option>
                            <option value="桶">桶</option>
                        </select>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>单位默认取规格包装单位，可手动调整
                    </div>
                </div>
                
                <!-- 库存预警值 -->
                <div class="form-group">
                    <label for="minStock" class="form-label">库存预警值</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="minStock" class="form-input flex-1" placeholder="请输入预警值" min="0" step="0.01">
                        <select id="minStockUnit" class="form-select w-20" onchange="updateMinStockUnitDisplay()">
                            <option value="">单位</option>
                            <option value="g">g</option>
                            <option value="kg">kg</option>
                            <option value="ml">ml</option>
                            <option value="L">L</option>
                            <option value="个">个</option>
                            <option value="袋">袋</option>
                            <option value="包">包</option>
                            <option value="盒">盒</option>
                            <option value="箱">箱</option>
                            <option value="瓶">瓶</option>
                            <option value="桶">桶</option>
                        </select>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-bell mr-1"></i>库存低于此值时系统将发出预警提醒
                        <span class="ml-2 text-blue-500">单位与当前库存同步</span>
                    </div>
                </div>
                

            </div>
            
            <!-- 供应商信息 -->
            <div class="card bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-100">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="w-6 h-6 rounded-lg gradient-order flex items-center justify-center">
                        <i class="fas fa-truck text-white text-xs"></i>
                    </div>
                    <h2 class="text-sm font-semibold text-gray-800">供应商信息（选填）</h2>
                </div>
                
                <!-- 品牌 -->
                <div class="form-group">
                    <label for="brand" class="form-label">品牌</label>
                    <input type="text" id="brand" class="form-input" placeholder="请输入品牌名称">
                </div>
                
                <!-- 供应商 -->
                <div class="form-group">
                    <label for="supplier" class="form-label">供应商</label>
                    <input type="text" id="supplier" class="form-input" placeholder="请输入供应商名称">
                </div>
            </div>
            
            <!-- 存储信息 -->
            <div class="card bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-100">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="w-6 h-6 rounded-lg gradient-recipe flex items-center justify-center">
                        <i class="fas fa-thermometer-half text-white text-xs"></i>
                    </div>
                    <h2 class="text-sm font-semibold text-gray-800">存储信息（选填）</h2>
                </div>
                
                <!-- 存储条件 -->
                <div class="form-group">
                    <label for="storageCondition" class="form-label">存储条件</label>
                    <select id="storageCondition" class="form-select">
                        <option value="">请选择存储条件</option>
                        <option value="常温干燥处">常温干燥处</option>
                        <option value="冷藏">冷藏(0-5℃)</option>
                        <option value="冷冻">冷冻(-18℃以下)</option>
                        <option value="阴凉干燥处">阴凉干燥处</option>
                    </select>
                </div>
            </div>
            
            <!-- 备注信息 -->
            <div class="card bg-white rounded-xl shadow-sm p-4 mb-6 border border-gray-100">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="w-6 h-6 rounded-lg gradient-message flex items-center justify-center">
                        <i class="fas fa-sticky-note text-white text-xs"></i>
                    </div>
                    <h2 class="text-sm font-semibold text-gray-800">备注信息（选填）</h2>
                </div>
                
                <!-- 备注 -->
                <div class="form-group">
                    <label for="remarks" class="form-label">备注</label>
                    <textarea id="remarks" class="form-input" rows="3" placeholder="请输入备注信息"></textarea>
                </div>
            </div>
            

            

        </form>
    </div>


    </form>

    <!-- 新建分类模态框 -->
    <div id="addCategoryModal" class="action-sheet">
        <div class="action-sheet-content">
            <div class="action-sheet-header">
                <h3 class="text-lg font-semibold text-gray-800">新建材料分类</h3>
                <button onclick="hideAddCategoryModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="action-sheet-body">
                <div class="form-group">
                    <label for="newCategoryName" class="form-label required">分类名称</label>
                    <input type="text" id="newCategoryName" class="form-input" placeholder="请输入分类名称" maxlength="20" onkeypress="if(event.key==='Enter') saveNewCategory()" oninput="updateCategoryCode()">
                </div>
                
                <div class="form-group">
                    <label for="newCategoryCode" class="form-label">分类编码</label>
                    <input type="text" id="newCategoryCode" class="form-input" placeholder="自动生成" readonly>
                    <div class="text-xs text-gray-500 mt-1">编码将自动生成，用于系统内部识别</div>
                </div>
                
                <div class="form-group">
                    <label for="newCategoryDesc" class="form-label">分类描述</label>
                    <textarea id="newCategoryDesc" class="form-input" rows="2" placeholder="请输入分类描述（选填）"></textarea>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button onclick="hideAddCategoryModal()" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm">
                        取消
                    </button>
                    <button onclick="saveNewCategory()" class="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm">
                        保存并使用
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 材料资源库弹窗 -->
    <div id="materialLibraryModal" class="action-sheet">
        <div class="action-sheet-content max-h-96">
            <div class="action-sheet-header">
                <h3 class="text-lg font-semibold text-gray-800">材料资源库</h3>
                <button onclick="hideMaterialLibrary()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="action-sheet-body">
                <div class="mb-3">
                    <input type="text" id="librarySearch" placeholder="搜索材料..." class="form-input text-sm" oninput="filterMaterialLibrary()">
                </div>
                <div id="materialLibraryList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- 材料列表将通过JavaScript动态生成 -->
                </div>
                <div class="mt-4 flex space-x-3">
                    <button onclick="hideMaterialLibrary()" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm">
                        取消
                    </button>
                    <button onclick="importSelectedMaterials()" class="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm">
                        导入选中材料
                    </button>
                </div>
            </div>
        </div>
    </div>



    <script>
        // 全局变量
        let unitLevelCount = 1;
        let materialLibraryData = [];
        let multiLevelUnits = []; // 存储多层级单位数据
        let customCategories = []; // 存储自定义分类数据
        
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化功能
            initializePage();
            generateMaterialCode();
            loadMaterialLibrary();
            
            // 检查是否是首次使用
            checkFirstTimeUser();
        });
        
        // 页面初始化
        function initializePage() {
            addInputFocusEffects();
            addCardClickFeedback();
            setupUnitChangeListeners();
            
            // 初始化新功能
            initializeUnitSystem();
            
            // 初始化规格显示
            updateSpecificationDisplay();
            
            // 初始化实际可用量的默认单位
            const defaultUnit = document.getElementById('specificationUnit').value || 'g';
            updateUsablePortionDefaultUnit(defaultUnit);
            
            // 初始化实际可用量输入框占位符
            const usablePortionInput = document.getElementById('usablePortion');
            if (usablePortionInput) {
                usablePortionInput.placeholder = `如：350（表示350${defaultUnit}可用）`;
            }
            
            // 初始化库存单位
            updateStockUnitOptions();
            
            // 确保所有必要的元素存在
            console.log('页面初始化完成');
            console.log('unitSettingCard元素:', document.getElementById('unitSettingCard'));
            console.log('multiLevelUnits数组:', multiLevelUnits);
        }
        
        // 初始化单位系统
function initializeUnitSystem() {
    // 隐藏所有面板
    const unitGuide = document.getElementById('unitGuide');
    if (unitGuide) unitGuide.style.display = 'none';
}
        

        
        // 处理分类选择变化
        function handleCategoryChange() {
            const categorySelect = document.getElementById('materialCategory');
            const addCategoryBtn = document.getElementById('addCategoryBtn');
            
            if (categorySelect.value === 'new_category') {
                addCategoryBtn.style.display = 'inline-block';
                showAddCategoryModal();
                // 重置选择
                categorySelect.value = '';
            } else {
                addCategoryBtn.style.display = 'none';
            }
        }
        
        // 显示新建分类模态框
        function showAddCategoryModal() {
            const modal = document.getElementById('addCategoryModal');
            modal.classList.add('active');
            
            // 清空表单
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryCode').value = '';
            document.getElementById('newCategoryDesc').value = '';
            
            // 生成分类编码
            generateCategoryCode();
            
            // 聚焦到名称输入框
            setTimeout(() => {
                document.getElementById('newCategoryName').focus();
            }, 300);
        }
        
        // 隐藏新建分类模态框
        function hideAddCategoryModal() {
            const modal = document.getElementById('addCategoryModal');
            modal.classList.remove('active');
        }
        
        // 生成分类编码
        function generateCategoryCode() {
            const now = new Date();
            const dateStr = now.getFullYear().toString().substr(-2) + 
                           (now.getMonth() + 1).toString().padStart(2, '0') + 
                           now.getDate().toString().padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const code = `CAT${dateStr}${randomNum}`;
            
            document.getElementById('newCategoryCode').value = code;
        }
        
        // 根据分类名称更新编码
        function updateCategoryCode() {
            const name = document.getElementById('newCategoryName').value.trim();
            const codeInput = document.getElementById('newCategoryCode');
            
            if (name.length > 0) {
                // 基于名称生成更有意义的编码
                const pinyin = name.substring(0, 2).toUpperCase(); // 简化处理，取前两个字符
                const now = new Date();
                const dateStr = now.getFullYear().toString().substr(-2) + 
                               (now.getMonth() + 1).toString().padStart(2, '0') + 
                               now.getDate().toString().padStart(2, '0');
                const randomNum = Math.floor(Math.random() * 100).toString().padStart(2, '0');
                const code = `${pinyin}${dateStr}${randomNum}`;
                
                codeInput.value = code;
            } else {
                // 如果名称为空，生成通用编码
                generateCategoryCode();
            }
        }
        
        // 保存新分类
        function saveNewCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const code = document.getElementById('newCategoryCode').value.trim();
            const desc = document.getElementById('newCategoryDesc').value.trim();
            
            if (!name) {
                showToast('请输入分类名称', 'error');
                return;
            }
            
            // 检查分类名称是否重复
            const categorySelect = document.getElementById('materialCategory');
            const existingOptions = Array.from(categorySelect.options);
            const isDuplicate = existingOptions.some(option => 
                option.textContent.toLowerCase() === name.toLowerCase() && 
                option.value !== 'new_category'
            );
            
            if (isDuplicate) {
                showToast('分类名称已存在', 'error');
                return;
            }
            
            // 创建新的分类对象
            const newCategory = {
                code: code,
                name: name,
                desc: desc,
                createdAt: new Date().toISOString()
            };
            
            // 保存到自定义分类数组
            customCategories.push(newCategory);
            
            // 添加到下拉选择框
            const newOption = document.createElement('option');
            newOption.value = code;
            newOption.textContent = name;
            
            // 插入到"其他"选项之前
            const otherOption = categorySelect.querySelector('option[value="other"]');
            categorySelect.insertBefore(newOption, otherOption);
            
            // 选中新创建的分类
            categorySelect.value = code;
            
            // 隐藏模态框
            hideAddCategoryModal();
            
            showToast(`分类"${name}"创建成功！`, 'success');
        }
        
        // 更新规格显示
        function updateSpecificationDisplay() {
            const number = document.getElementById('specificationNumber').value;
            const unit = document.getElementById('specificationUnit').value || 'g'; // 默认为g
            const packageType = document.getElementById('specificationPackage').value;
            const preview = document.getElementById('specificationPreview');
            const hiddenInput = document.getElementById('specification');
            
            if (!number) {
                preview.textContent = '请输入数量';
                hiddenInput.value = '';
                updatePurchaseUnitDisplay('采购价格');
                return;
            }
            
            let specText = '';
            let purchaseUnitText = '';
            
            if (packageType) {
                specText = `${number}${unit}/${packageType}`;
                preview.textContent = `规格：${specText}`;
                purchaseUnitText = packageType;
            } else {
                specText = `${number}${unit}`;
                preview.textContent = `规格：${specText}`;
                purchaseUnitText = unit;
            }
            
            hiddenInput.value = specText;
            updatePurchaseUnitDisplay(purchaseUnitText);
            
            // 同步更新库存单位选项
            updateStockUnitOptions();
            
            // 同步更新实际可用量的默认单位
            updateUsablePortionDefaultUnit(unit);
            
            // 更新实际可用量输入框占位符
            const usablePortionInput = document.getElementById('usablePortion');
            if (usablePortionInput) {
                usablePortionInput.placeholder = `如：350（表示350${unit}可用）`;
            }
        }
        
        // 更新采购单位显示
        function updatePurchaseUnitDisplay(unitName) {
            const purchaseUnitNameElement = document.getElementById('purchaseUnitName');
            if (purchaseUnitNameElement) {
                purchaseUnitNameElement.textContent = unitName;
            }
        }
        
        // 更新库存单位选项
        function updateStockUnitOptions() {
            const specUnit = document.getElementById('specificationUnit').value;
            const specPackage = document.getElementById('specificationPackage').value;
            const stockUnit = document.getElementById('stockUnit');
            const minStockUnit = document.getElementById('minStockUnit');
            
            if (!stockUnit || !minStockUnit) return;
            
            // 优先使用包装单位作为库存单位（如果用户选择了包装单位）
            if (specPackage) {
                // 检查包装单位是否在选项中
                const packageOption = Array.from(stockUnit.options).find(opt => opt.value === specPackage);
                if (packageOption) {
                    // 如果当前库存单位为空或者与之前的规格不匹配，则更新为包装单位
                    if (!stockUnit.value || shouldUpdateStockUnit(stockUnit.value, specPackage, specUnit)) {
                        stockUnit.value = specPackage;
                    }
                }
                
                const packageOptionMin = Array.from(minStockUnit.options).find(opt => opt.value === specPackage);
                if (packageOptionMin) {
                    if (!minStockUnit.value || shouldUpdateStockUnit(minStockUnit.value, specPackage, specUnit)) {
                        minStockUnit.value = specPackage;
                    }
                }
            } else if (specUnit) {
                // 如果没有包装单位，使用规格单位
                if (!stockUnit.value || shouldUpdateStockUnit(stockUnit.value, null, specUnit)) {
                    stockUnit.value = specUnit;
                }
                
                if (!minStockUnit.value || shouldUpdateStockUnit(minStockUnit.value, null, specUnit)) {
                    minStockUnit.value = specUnit;
                }
            }
        }
        
        // 判断是否应该更新库存单位
        function shouldUpdateStockUnit(currentUnit, newPackageUnit, newSpecUnit) {
            // 如果当前单位为空，应该更新
            if (!currentUnit) return true;
            
            // 如果有新的包装单位，且当前单位不是包装单位，应该更新
            if (newPackageUnit && currentUnit !== newPackageUnit) {
                return true;
            }
            
            // 如果没有包装单位，但当前单位不是规格单位，应该更新
            if (!newPackageUnit && newSpecUnit && currentUnit !== newSpecUnit) {
                return true;
            }
            
            return false;
        }
        
        // 更新实际可用量的默认单位
        function updateUsablePortionDefaultUnit(unit) {
            const usablePortionUnit = document.getElementById('usablePortionUnit');
            
            if (usablePortionUnit && unit) {
                // 检查该单位是否在选项中
                const unitOption = Array.from(usablePortionUnit.options).find(opt => opt.value === unit);
                if (unitOption) {
                    // 总是更新为当前规格单位，确保同步
                    const previousUnit = usablePortionUnit.value;
                    usablePortionUnit.value = unit;
                    
                    // 如果单位发生了变化，显示视觉反馈
                    if (previousUnit !== unit) {
                        // 添加视觉反馈
                        usablePortionUnit.style.borderColor = '#10b981';
                        usablePortionUnit.style.backgroundColor = '#f0fdf4';
                        usablePortionUnit.style.transition = 'all 0.3s ease';
                        
                        // 显示同步提示
                        showUnitSyncNotification(unit);
                        
                        setTimeout(() => {
                            usablePortionUnit.style.borderColor = '';
                            usablePortionUnit.style.backgroundColor = '';
                        }, 1500);
                        
                        // 更新相关显示
                        updateUsablePortionDisplay();
                    }
                }
            }
        }
        
        // 显示单位同步通知
        function showUnitSyncNotification(unit) {
            // 创建临时通知元素
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-3 py-2 rounded-lg shadow-lg z-50 text-sm animate-scale-in';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-sync-alt"></i>
                    <span>单位已同步为: ${unit}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后移除通知
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 2000);
        }
        
        // 同步实际可用量单位
        function syncUsablePortionUnit() {
            const currentSpecUnit = document.getElementById('specificationUnit').value;
            if (currentSpecUnit) {
                updateUsablePortionDefaultUnit(currentSpecUnit);
                
                // 更新输入框占位符
                const usablePortionInput = document.getElementById('usablePortion');
                if (usablePortionInput) {
                    usablePortionInput.placeholder = `如：350（表示350${currentSpecUnit}可用）`;
                }
            }
        }
        
        // 显示实际可用量示例
        function showUsablePortionExample() {
            const example = document.getElementById('usablePortionExample');
            if (example) {
                example.style.display = 'block';
                example.style.animation = 'fadeIn 0.3s ease-in-out';
            }
        }
        
        // 隐藏实际可用量示例
        function hideUsablePortionExample() {
            const example = document.getElementById('usablePortionExample');
            if (example) {
                example.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => {
                    example.style.display = 'none';
                }, 300);
            }
        }
        
        // 更新当前库存单位显示
        function updateStockUnitDisplay() {
            const stockUnit = document.getElementById('stockUnit');
            const stockValue = document.getElementById('currentStock');
            
            if (stockUnit && stockValue) {
                // 可以在这里添加单位换算逻辑
                console.log('当前库存单位更新为:', stockUnit.value);
                
                // 添加视觉反馈
                if (stockUnit.value) {
                    stockUnit.style.borderColor = '#10b981';
                    setTimeout(() => {
                        stockUnit.style.borderColor = '';
                    }, 1000);
                }
            }
        }
        
        // 更新库存预警值单位显示
        function updateMinStockUnitDisplay() {
            const minStockUnit = document.getElementById('minStockUnit');
            const minStockValue = document.getElementById('minStock');
            
            if (minStockUnit && minStockValue) {
                // 可以在这里添加单位换算逻辑
                console.log('库存预警值单位更新为:', minStockUnit.value);
                
                // 添加视觉反馈
                if (minStockUnit.value) {
                    minStockUnit.style.borderColor = '#10b981';
                    setTimeout(() => {
                        minStockUnit.style.borderColor = '';
                    }, 1000);
                }
            }
        }
        
        // 展开实际可用量设置
        function expandUsablePortion() {
            const collapsed = document.getElementById('usablePortionCollapsed');
            const expanded = document.getElementById('usablePortionExpanded');
            const toggleIcon = document.getElementById('usablePortionToggleIcon');
            
            if (collapsed && expanded && toggleIcon) {
                collapsed.style.display = 'none';
                expanded.style.display = 'block';
                toggleIcon.classList.add('rotate-180');
                
                // 展开时自动同步规格单位
                const currentSpecUnit = document.getElementById('specificationUnit').value;
                if (currentSpecUnit) {
                    updateUsablePortionDefaultUnit(currentSpecUnit);
                }
            }
        }
        
        // 收起实际可用量设置
        function collapseUsablePortion() {
            const collapsed = document.getElementById('usablePortionCollapsed');
            const expanded = document.getElementById('usablePortionExpanded');
            const toggleIcon = document.getElementById('usablePortionToggleIcon');
            
            if (collapsed && expanded && toggleIcon) {
                collapsed.style.display = 'block';
                expanded.style.display = 'none';
                toggleIcon.classList.remove('rotate-180');
                
                // 更新折叠状态的摘要信息
                updateUsablePortionSummary();
            }
        }
        
        // 清空实际可用量设置
        function clearUsablePortion() {
            const usablePortionInput = document.getElementById('usablePortion');
            const usablePortionUnit = document.getElementById('usablePortionUnit');
            const costImpactPreview = document.getElementById('costImpactPreview');
            
            if (usablePortionInput) usablePortionInput.value = '';
            if (usablePortionUnit) usablePortionUnit.value = '';
            if (costImpactPreview) costImpactPreview.style.display = 'none';
            
            updateUsablePortionDisplay();
            updateUsablePortionSummary();
        }
        
        // 更新折叠状态的摘要信息
        function updateUsablePortionSummary() {
            const summary = document.getElementById('usablePortionSummary');
            const usableAmount = parseFloat(document.getElementById('usablePortion').value) || 0;
            const usableUnit = document.getElementById('usablePortionUnit').value;
            
            if (summary) {
                if (usableAmount > 0 && usableUnit) {
                    const usableRatio = getUsablePortionRatio();
                    const percentage = (usableRatio * 100).toFixed(1);
                    summary.textContent = `实际可用：${usableAmount}${usableUnit}（${percentage}%）`;
                    summary.className = 'text-xs text-green-700 bg-green-100 px-2 py-1 rounded-full font-medium';
                } else {
                    summary.textContent = '默认100%可用';
                    summary.className = 'text-xs text-gray-700 bg-white px-2 py-1 rounded-full';
                }
            }
        }
        
        // 更新可使用部分显示
        function updateUsablePortionDisplay() {
            const usablePortionInput = document.getElementById('usablePortion');
            const usablePortionUnit = document.getElementById('usablePortionUnit');
            const usablePortionDisplay = document.getElementById('usablePortionDisplay');
            const costImpactPreview = document.getElementById('costImpactPreview');
            const originalCostDisplay = document.getElementById('originalCostDisplay');
            const adjustedCostDisplay = document.getElementById('adjustedCostDisplay');
            
            const usableAmount = parseFloat(usablePortionInput.value) || 0;
            const usableUnit = usablePortionUnit.value;
            
            // 计算可用率
            let usableRatio = 1; // 默认100%
            
            if (usableAmount > 0 && usableUnit) {
                // 获取采购规格信息
                const specNumber = parseFloat(document.getElementById('specificationNumber').value) || 0;
                const specUnit = document.getElementById('specificationUnit').value;
                
                if (specNumber > 0 && specUnit) {
                    // 单位换算和计算可用率
                    const totalAmount = convertToSameUnit(specNumber, specUnit, usableUnit);
                    if (totalAmount > 0) {
                        usableRatio = usableAmount / totalAmount;
                    }
                }
            }
            
            // 更新显示
            if (usablePortionDisplay) {
                if (usableAmount > 0 && usableUnit) {
                    const percentage = (usableRatio * 100).toFixed(1);
                    usablePortionDisplay.textContent = `${percentage}%`;
                    
                    // 根据比例改变颜色
                    if (usableRatio >= 0.95) {
                        usablePortionDisplay.className = 'font-medium text-green-600';
                    } else if (usableRatio >= 0.80) {
                        usablePortionDisplay.className = 'font-medium text-blue-600';
                    } else if (usableRatio >= 0.60) {
                        usablePortionDisplay.className = 'font-medium text-orange-600';
                    } else {
                        usablePortionDisplay.className = 'font-medium text-red-600';
                    }
                } else {
                    usablePortionDisplay.textContent = '100%';
                    usablePortionDisplay.className = 'font-medium text-green-600';
                }
            }
            
            // 更新成本影响预览
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            
            if (purchasePrice > 0 && costImpactPreview && originalCostDisplay && adjustedCostDisplay) {
                const adjustedCost = purchasePrice / usableRatio;
                
                originalCostDisplay.textContent = `¥${purchasePrice.toFixed(2)}`;
                adjustedCostDisplay.textContent = `¥${adjustedCost.toFixed(2)}`;
                
                // 计算每单位成本（动态单位）
                const originalCostPerUnitEl = document.getElementById('originalCostPerUnit');
                const adjustedCostPerUnitEl = document.getElementById('adjustedCostPerUnit');
                const originalCostPerUnitLabel = document.getElementById('originalCostPerUnitLabel');
                const adjustedCostPerUnitLabel = document.getElementById('adjustedCostPerUnitLabel');
                
                if (originalCostPerUnitEl && adjustedCostPerUnitEl && originalCostPerUnitLabel && adjustedCostPerUnitLabel) {
                    const specNumber = parseFloat(document.getElementById('specificationNumber').value) || 0;
                    const specUnit = document.getElementById('specificationUnit').value;
                    
                    if (specNumber > 0 && specUnit) {
                        // 计算每基础单位的成本
                        const originalCostPerUnit = purchasePrice / specNumber;
                        const adjustedCostPerUnit = adjustedCost / specNumber;
                        
                        // 更新标签和数值
                        originalCostPerUnitLabel.textContent = `采购每${specUnit}成本：`;
                        adjustedCostPerUnitLabel.textContent = `实际每${specUnit}成本：`;
                        originalCostPerUnitEl.textContent = `¥${originalCostPerUnit.toFixed(4)}`;
                        adjustedCostPerUnitEl.textContent = `¥${adjustedCostPerUnit.toFixed(4)}`;
                    } else {
                        originalCostPerUnitLabel.textContent = '采购每单位成本：';
                        adjustedCostPerUnitLabel.textContent = '实际每单位成本：';
                        originalCostPerUnitEl.textContent = '¥--';
                        adjustedCostPerUnitEl.textContent = '¥--';
                    }
                }
                
                costImpactPreview.style.display = 'block';
            } else if (costImpactPreview) {
                costImpactPreview.style.display = 'none';
            }
            
            // 触发其他相关计算的更新
            updateCostSummary();
            
            // 更新折叠状态的摘要信息
            updateUsablePortionSummary();
        }
        
        // 单位换算辅助函数
        function convertToSameUnit(amount, fromUnit, toUnit) {
            if (fromUnit === toUnit) return amount;
            
            // 重量单位换算
            const weightUnits = {
                'g': 1,
                'kg': 1000
            };
            
            // 体积单位换算
            const volumeUnits = {
                'ml': 1,
                'L': 1000
            };
            
            // 重量单位换算
            if (weightUnits[fromUnit] && weightUnits[toUnit]) {
                return amount * weightUnits[fromUnit] / weightUnits[toUnit];
            }
            
            // 体积单位换算
            if (volumeUnits[fromUnit] && volumeUnits[toUnit]) {
                return amount * volumeUnits[fromUnit] / volumeUnits[toUnit];
            }
            
            // 相同类型单位（个）
            if (fromUnit === '个' && toUnit === '个') {
                return amount;
            }
            
            return 0; // 不同类型单位无法换算
        }
        
        // 将单位转换为克的函数
        function convertToGrams(amount, unit) {
            const conversionRates = {
                'g': 1,
                'kg': 1000,
                'ml': 1, // 假设液体密度为1g/ml
                'L': 1000, // 假设液体密度为1g/ml
                '个': 0 // 个数单位无法直接转换为重量
            };
            
            if (conversionRates[unit] !== undefined && conversionRates[unit] > 0) {
                return amount * conversionRates[unit];
            }
            
            return 0; // 无法转换
        }
        
        // 计算实际成本（考虑可使用部分）
        function calculateActualCost(originalCost) {
            const usableRatio = getUsablePortionRatio();
            return originalCost / usableRatio;
        }
        
        // 获取可使用部分比例
        function getUsablePortionRatio() {
            const usableAmount = parseFloat(document.getElementById('usablePortion').value) || 0;
            const usableUnit = document.getElementById('usablePortionUnit').value;
            
            if (usableAmount > 0 && usableUnit) {
                // 获取采购规格信息
                const specNumber = parseFloat(document.getElementById('specificationNumber').value) || 0;
                const specUnit = document.getElementById('specificationUnit').value;
                
                if (specNumber > 0 && specUnit) {
                    // 单位换算和计算可用率
                    const totalAmount = convertToSameUnit(specNumber, specUnit, usableUnit);
                    if (totalAmount > 0) {
                        return usableAmount / totalAmount;
                    }
                }
            }
            
            return 1; // 默认100%
        }
        
        // 显示多层级单位设置
        function showMultiLevelUnitSetting() {
            try {
                const unitSettingCard = document.getElementById('unitSettingCard');
                const unitTemplates = document.getElementById('unitTemplates');
                const unitGuide = document.getElementById('unitGuide');
                
                if (!unitSettingCard) {
                    console.error('找不到unitSettingCard元素');
                    showToast('系统错误：找不到设置面板', 'error');
                    return;
                }
                
                // 显示单位设置卡片
                unitSettingCard.style.display = 'block';
                if (unitTemplates) unitTemplates.style.display = 'none';
                if (unitGuide) unitGuide.style.display = 'none';
                
                            // 初始化多层级单位系统
            initializeMultiLevelUnits();
                
                // 滚动到设置面板
                unitSettingCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                showToast('已打开自定义规格设置', 'info');
            } catch (error) {
                console.error('显示多层级单位设置时出错:', error);
                showToast('打开设置面板失败，请刷新页面重试', 'error');
            }
        }
        
        // 初始化多层级单位系统
        function initializeMultiLevelUnits() {
            try {
                // 如果还没有基础单位，初始化一个
                if (!multiLevelUnits || multiLevelUnits.length === 0) {
                    multiLevelUnits = [{
                        level: 1,
                        name: '',
                        ratio: 1,
                        isBase: true,
                        description: '配方中使用的最小单位'
                    }];
                }
                
                // 重置层级计数
                unitLevelCount = multiLevelUnits.length;
                
                // 确保基础单位层级存在
                const unitLevels = document.getElementById('unitLevels');
                if (unitLevels && unitLevels.children.length === 0) {
                    // 重新创建基础单位层级
                    const baseDiv = document.createElement('div');
                    baseDiv.className = 'unit-level';
                    baseDiv.setAttribute('data-level', '1');
                    baseDiv.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-blue-700">基础单位（第1层级）</span>
                            <span class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">最小计量单位</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-600 mb-1 block">单位名称</label>
                                <select class="form-select text-sm unit-name" data-level="1" onchange="updateMultiLevelUnits(); updateConversionPreview();">
                                    <option value="">请选择基础单位</option>
                                    <option value="g">克(g)</option>
                                    <option value="kg">千克(kg)</option>
                                    <option value="ml">毫升(ml)</option>
                                    <option value="L">升(L)</option>
                                    <option value="个">个</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600 mb-1 block">说明</label>
                                <div class="bg-gray-50 px-3 py-2 rounded text-sm text-gray-600">
                                    配方中使用的最小单位
                                </div>
                            </div>
                        </div>
                    `;
                    unitLevels.appendChild(baseDiv);
                }
                
                // 更新显示
                updateUnitDisplays();
                updateConversionPreview();
                
                console.log('多层级单位系统初始化完成');
            } catch (error) {
                console.error('初始化多层级单位系统时出错:', error);
                showToast('初始化失败，请刷新页面重试', 'error');
            }
        }
        
        // 显示引导设置
        function showUnitGuide() {
            const templatesDiv = document.getElementById('unitTemplates');
            const guideDiv = document.getElementById('unitGuide');
            const unitSettingCard = document.getElementById('unitSettingCard');
            
            // 始终显示单位设置卡片和引导设置
            guideDiv.style.display = 'block';
            templatesDiv.style.display = 'none';
            unitSettingCard.style.display = 'block';
            showGuideStep(1);
        }
        
        // 隐藏单位设置卡片
        function hideUnitSettingCard() {
            const unitSettingCard = document.getElementById('unitSettingCard');
            const unitGuide = document.getElementById('unitGuide');
            
            unitSettingCard.style.display = 'none';
            unitGuide.style.display = 'none';
        }
        
        // 应用多层级模板
        function applyMultiLevelTemplate(templateType) {
            const templates = {
                flour: {
                    units: [
                        { level: 1, name: 'g', ratio: 1, isBase: true, description: '最小计量单位' },
                        { level: 2, name: '袋', ratio: 25000, isBase: false, description: '袋装单位' },
                        { level: 3, name: '箱', ratio: 20, isBase: false, description: '箱装单位' }
                    ]
                },
                liquid: {
                    units: [
                        { level: 1, name: 'ml', ratio: 1, isBase: true, description: '最小计量单位' },
                        { level: 2, name: '桶', ratio: 20000, isBase: false, description: '桶装单位' },
                        { level: 3, name: '箱', ratio: 4, isBase: false, description: '箱装单位' }
                    ]
                },
                butter: {
                    units: [
                        { level: 1, name: 'g', ratio: 1, isBase: true, description: '最小计量单位' },
                        { level: 2, name: '包', ratio: 500, isBase: false, description: '包装单位' },
                        { level: 3, name: '箱', ratio: 20, isBase: false, description: '箱装单位' }
                    ]
                },
                snack: {
                    units: [
                        { level: 1, name: 'g', ratio: 1, isBase: true, description: '最小计量单位' },
                        { level: 2, name: '袋', ratio: 50, isBase: false, description: '小袋装' },
                        { level: 3, name: '包', ratio: 10, isBase: false, description: '包装单位' },
                        { level: 4, name: '箱', ratio: 10, isBase: false, description: '箱装单位' }
                    ]
                }
            };
            
            const template = templates[templateType];
            if (!template) return;
            
            // 清空现有单位
            clearAllUnits();
            
            // 应用模板数据
            multiLevelUnits = [...template.units];
            unitLevelCount = multiLevelUnits.length;
            
            // 重新生成HTML
            const container = document.getElementById('unitLevels');
            container.innerHTML = '';
            
            multiLevelUnits.forEach((unit, index) => {
                if (index === 0) {
                    // 基础单位
                    const baseDiv = document.createElement('div');
                    baseDiv.className = 'unit-level';
                    baseDiv.setAttribute('data-level', '1');
                    baseDiv.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-blue-700">基础单位（第1层级）</span>
                            <span class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">最小计量单位</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-600 mb-1 block">单位名称</label>
                                <select class="form-select text-sm unit-name" data-level="1" onchange="updateMultiLevelUnits(); updateConversionPreview();">
                                    <option value="">请选择基础单位</option>
                                    <option value="g" ${unit.name === 'g' ? 'selected' : ''}>克(g)</option>
                                    <option value="kg" ${unit.name === 'kg' ? 'selected' : ''}>千克(kg)</option>
                                    <option value="ml" ${unit.name === 'ml' ? 'selected' : ''}>毫升(ml)</option>
                                    <option value="L" ${unit.name === 'L' ? 'selected' : ''}>升(L)</option>
                                    <option value="个" ${unit.name === '个' ? 'selected' : ''}>个</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600 mb-1 block">说明</label>
                                <div class="bg-gray-50 px-3 py-2 rounded text-sm text-gray-600">
                                    配方中使用的最小单位
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(baseDiv);
                } else {
                    // 其他层级
                    createUnitLevelElement(unit, container);
                }
            });
            
            // 更新显示
            updateUnitDisplays();
            updateConversionPreview();
            updateHierarchyChart();
            document.getElementById('unitTemplates').style.display = 'none';
            showToast(`已应用${templateType}模板`, 'success');
        }
        
        // 创建单位层级元素
        function createUnitLevelElement(unit, container) {
            const levelDiv = document.createElement('div');
            levelDiv.className = 'unit-level';
            levelDiv.setAttribute('data-level', unit.level);
            
            // 确定层级颜色和标题
            let levelColor = 'text-gray-700';
            let levelBg = 'bg-gray-50';
            let levelTitle = `第${unit.level}层级`;
            
            if (unit.level === 2) {
                levelColor = 'text-green-700';
                levelBg = 'bg-green-50';
                levelTitle = '包装单位（第2层级）';
            } else if (unit.level === 3) {
                levelColor = 'text-orange-700';
                levelBg = 'bg-orange-50';
                levelTitle = '中包装单位（第3层级）';
            } else if (unit.level === 4) {
                levelColor = 'text-purple-700';
                levelBg = 'bg-purple-50';
                levelTitle = '大包装单位（第4层级）';
            } else if (unit.level === 5) {
                levelColor = 'text-red-700';
                levelBg = 'bg-red-50';
                levelTitle = '最大包装单位（第5层级）';
            }
            
            levelDiv.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-medium ${levelColor}">${levelTitle}</span>
                    <button type="button" onclick="removeUnitLevel(${unit.level})" class="text-red-500 text-xs hover:text-red-700 px-2 py-1 rounded hover:bg-red-100">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-600 mb-1 block">单位名称</label>
                        <input type="text" class="form-input text-sm unit-name" data-level="${unit.level}" placeholder="如：箱、包、袋等" value="${unit.name}" onchange="updateMultiLevelUnits(); updateConversionPreview();">
                    </div>
                    <div>
                        <label class="text-xs text-gray-600 mb-1 block">换算关系</label>
                        <div class="flex items-center space-x-1">
                            <span class="text-xs text-gray-500">1</span>
                            <span class="text-xs font-medium text-blue-600 unit-current">${unit.name}</span>
                            <span class="text-xs text-gray-500">=</span>
                            <input type="number" class="form-input text-sm w-16 unit-ratio" data-level="${unit.level}" placeholder="数量" min="1" step="0.01" value="${unit.ratio}" oninput="updateMultiLevelUnits(); updateConversionPreview();">
                            <span class="text-xs font-medium text-green-600 unit-previous">下级单位</span>
                        </div>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-500 ${levelBg} px-2 py-1 rounded">
                    <i class="fas fa-info-circle"></i> 表示：1个当前单位包含多少个下级单位
                </div>
            `;
            
            container.appendChild(levelDiv);
        }
        
        // 清空所有单位
        function clearAllUnits() {
            const container = document.getElementById('unitLevels');
            // 保留基础单位，清空其他
            const levels = container.querySelectorAll('.unit-level');
            levels.forEach((level, index) => {
                if (index > 0) {
                    level.remove();
                }
            });
            
            // 重置数据
            multiLevelUnits = [{
                level: 1,
                name: '',
                ratio: 1,
                isBase: true,
                description: '配方中使用的最小单位'
            }];
            unitLevelCount = 1;
            
            // 清空基础单位选择
            const baseUnitSelect = container.querySelector('.unit-name');
            if (baseUnitSelect) {
                baseUnitSelect.value = '';
            }
            
            updateUnitDisplays();
            updateConversionPreview();
            showToast('已清空所有单位设置', 'info');
        }
        
        // 应用模板（保留原有功能）
function applyTemplate(templateType) {
    const templates = {
        flour: {
            baseUnit: 'g',
            units: [
                { name: 'g', ratio: 1, desc: '最小计量单位' },
                { name: 'kg', ratio: 1000, desc: '1千克 = 1000克' },
                { name: '袋', ratio: 25000, desc: '1袋 = 25千克' }
            ]
        },
        liquid: {
            baseUnit: 'ml',
            units: [
                { name: 'ml', ratio: 1, desc: '最小计量单位' },
                { name: 'L', ratio: 1000, desc: '1升 = 1000毫升' },
                { name: '桶', ratio: 20000, desc: '1桶 = 20升' }
            ]
        },
        butter: {
            baseUnit: 'g',
            units: [
                { name: 'g', ratio: 1, desc: '最小计量单位' },
                { name: '块', ratio: 500, desc: '1块 = 500克' },
                { name: '箱', ratio: 10000, desc: '1箱 = 20块' }
            ]
        },
        egg: {
            baseUnit: 'g',
            units: [
                { name: 'g', ratio: 1, desc: '最小计量单位' },
                { name: '个', ratio: 60, desc: '1个 = 60克' },
                { name: '箱', ratio: 1800, desc: '1箱 = 30个' }
            ]
        },
        custom: null
    };
    
    if (templateType === 'custom') {
        showUnitGuide();
        return;
    }
    
    const template = templates[templateType];
    if (template) {
        window.currentUnitSystem = template;
        updateUnitRelationChart();
        document.getElementById('unitTemplates').style.display = 'none';
        showToast('模板应用成功！', 'success');
        
        // 更新采购单位显示
        const topUnit = template.units[template.units.length - 1];
        document.getElementById('purchaseUnitName').textContent = topUnit.name;
    }
}
        
        // 显示引导步骤
function showGuideStep(stepNumber) {
    // 隐藏所有步骤
    document.querySelectorAll('.guide-step').forEach(step => {
        step.classList.remove('active');
    });
    
    // 显示指定步骤
    const targetStep = document.getElementById(`step${stepNumber}`);
    if (targetStep) {
        targetStep.classList.add('active');
    }
    
    // 如果显示第三步，更新单位摘要和顶层单位显示
    if (stepNumber === 3) {
        updateUnitSummary();
    }
}
        
        // 选择基本单位
function selectBaseUnit(unit) {
    // 移除之前的选择
    document.querySelectorAll('.unit-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // 添加当前选择
    event.target.closest('.unit-option').classList.add('selected');
    
    // 保存选择
    window.selectedBaseUnit = unit;
    
    // 初始化单位系统
    window.currentUnitSystem = {
        baseUnit: unit,
        units: [{ name: unit, ratio: 1, desc: '最小计量单位' }]
    };
    
    // 更新基础单位显示
    document.getElementById('baseUnitDisplay').textContent = unit === 'g' ? '克(g)' : 
                                                           unit === 'kg' ? '千克(kg)' : 
                                                           unit === 'ml' ? '毫升(ml)' : '升(L)';
    
    // 延迟显示下一步
    setTimeout(() => {
        showGuideStep(2);
        updateUnitBuilder();
    }, 300);
}

// 获取单位显示名称
function getUnitDisplayName(unit) {
    const unitNames = {
        'g': '克(g)',
        'kg': '千克(kg)',
        'ml': '毫升(ml)',
        'L': '升(L)'
    };
    return unitNames[unit] || unit;
}
        
        // 应用快速模板
        function applyTemplate(templateType) {
            const templates = {
                flour: {
                    baseUnit: 'g',
                    units: [
                        { name: 'g', ratio: 1, desc: '基本单位' },
                        { name: '包', ratio: 500, desc: '500克装' },
                        { name: '箱', ratio: 5000, desc: '10包装' }
                    ]
                },
                milk: {
                    baseUnit: 'ml',
                    units: [
                        { name: 'ml', ratio: 1, desc: '基本单位' },
                        { name: '瓶', ratio: 250, desc: '250毫升装' },
                        { name: '箱', ratio: 3000, desc: '12瓶装' }
                    ]
                },
                oil: {
                    baseUnit: 'ml',
                    units: [
                        { name: 'ml', ratio: 1, desc: '基本单位' },
                        { name: '瓶', ratio: 500, desc: '500毫升装' },
                        { name: '箱', ratio: 10000, desc: '20瓶装' }
                    ]
                }
            };
            
            const template = templates[templateType];
            if (!template) return;
            
            // 移除之前的选择
            document.querySelectorAll('.unit-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 选中对应的基本单位
            const targetOption = document.querySelector(`[onclick="selectBaseUnit('${template.baseUnit}')"]`);
            if (targetOption) {
                targetOption.classList.add('selected');
            }
            
            // 应用模板数据
            window.selectedBaseUnit = template.baseUnit;
            window.currentUnitSystem = {
                baseUnit: template.baseUnit,
                units: [...template.units]
            };
            
            // 显示成功提示并跳转到第二步
            showToast(`已应用${templateType === 'flour' ? '面粉类' : templateType === 'milk' ? '液体类' : '食用油'}模板`, 'success');
            
            setTimeout(() => {
                showGuideStep(2);
                updateUnitBuilder();
            }, 800);
        }
        
        // 更新单位构建器
function updateUnitBuilder() {
    const builder = document.getElementById('unitBuilder');
    const units = window.currentUnitSystem.units;
    
    // 清空构建器
    builder.innerHTML = '';
    
    if (units.length === 1) {
        builder.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <p class="text-sm">点击下方按钮添加包装单位</p>
            </div>
        `;
        return;
    }
    
    // 添加已有的包装单位（跳过基本单位）
    for (let i = 1; i < units.length; i++) {
        const unit = units[i];
        const prevUnit = units[i-1];
        const ratio = unit.ratio / prevUnit.ratio;
        const isComplete = unit.name.trim() !== '';
        
        const unitItem = document.createElement('div');
        unitItem.className = `bg-white border ${isComplete ? 'border-green-300' : 'border-orange-300'} rounded-lg p-3 mb-3`;
        unitItem.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <div class="font-medium text-gray-700">包装单位 ${i}</div>
                <button type="button" onclick="removeUnit(${i})" class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-100">
                    <i class="fas fa-trash text-xs"></i>
                </button>
            </div>
            
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500 block mb-1">单位名称</label>
                    <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" 
                           placeholder="如：包、箱、袋" 
                           value="${unit.name}" 
                           onchange="updateUnitName(${i}, this.value)">
                </div>
                
                <div>
                    <label class="text-xs text-gray-500 block mb-1">换算关系</label>
                    <div class="flex items-center gap-2">
                        <div class="bg-gray-100 px-2 py-1 rounded text-sm">1 ${unit.name || '单位'}</div>
                        <div class="text-sm">=</div>
                        <input type="number" class="border border-gray-300 rounded px-3 py-2 text-sm w-20" 
                               placeholder="数量" 
                               value="${ratio}" 
                               onchange="updateUnitRatio(${i}, this.value)" 
                               min="1" step="0.01">
                        <div class="bg-blue-100 px-2 py-1 rounded text-sm text-blue-800">${prevUnit.name}</div>
                    </div>
                </div>
            </div>
            
            ${!isComplete ? '<div class="text-xs text-orange-600 mt-2"><i class="fas fa-exclamation-circle mr-1"></i>请输入单位名称</div>' : ''}
        `;
        
        builder.appendChild(unitItem);
    }
    
    if (builder.innerHTML === '') {
        builder.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <p class="text-sm">点击下方按钮添加包装单位</p>
            </div>
        `;
    }
}
        
        // 添加包装单位
function addPackagingUnit() {
    const units = window.currentUnitSystem.units;
    const lastUnit = units[units.length - 1];
    
    units.push({
        name: '',
        ratio: lastUnit.ratio * 10, // 默认10倍关系
        desc: ''
    });
    
    updateUnitBuilder();
    showToast('已添加新的包装单位，请设置名称和换算关系', 'info');
}
        
        // 更新单位名称
        function updateUnitName(index, name) {
            window.currentUnitSystem.units[index].name = name;
            updateUnitSummary();
        }
        
        // 更新单位比例
function updateUnitRatio(index, ratio) {
    const units = window.currentUnitSystem.units;
    const prevUnit = units[index - 1];
    const newRatio = parseFloat(ratio) || 1;
    
    // 更新当前单位的比例
    units[index].ratio = prevUnit.ratio * newRatio;
    
    // 更新所有更高级别的单位比例
    for (let i = index + 1; i < units.length; i++) {
        const prevRatio = units[i].ratio / units[i-1].ratio;
        units[i].ratio = units[i-1].ratio * prevRatio;
    }
    
    updateUnitSummary();
}
        
        // 移除单位
        function removeUnit(index) {
            window.currentUnitSystem.units.splice(index, 1);
            updateUnitBuilder();
            updateUnitSummary();
        }
        
        // 更新单位摘要
function updateUnitSummary() {
    const summary = document.getElementById('unitSummary');
    const units = window.currentUnitSystem.units;
    
    if (!summary || units.length < 2) {
        if (summary) {
            summary.innerHTML = '<div class="text-center text-gray-500 py-4">请至少添加一个包装单位</div>';
        }
        return;
    }
    
    // 创建单位链
    let unitChain = '';
    let totalConversion = '';
    
    // 从大到小排序单位
    const sortedUnits = [...units].sort((a, b) => b.ratio - a.ratio);
    
    // 构建单位链（从大到小）
    unitChain = sortedUnits.map((unit, index) => {
        if (index === sortedUnits.length - 1) {
            return `<span class="font-medium text-blue-600">${unit.name}</span>`;
        }
        return `<span class="font-medium">${unit.name}</span>`;
    }).join(' → ');
    
    // 构建总体换算关系
    const largestUnit = sortedUnits[0];
    const smallestUnit = sortedUnits[sortedUnits.length - 1];
    totalConversion = `1 ${largestUnit.name} = ${largestUnit.ratio / smallestUnit.ratio} ${smallestUnit.name}`;
    
    // 构建详细换算关系
    let detailedConversions = '';
    for (let i = 0; i < sortedUnits.length - 1; i++) {
        const currentUnit = sortedUnits[i];
        const nextUnit = sortedUnits[i + 1];
        const ratio = currentUnit.ratio / nextUnit.ratio;
        
        detailedConversions += `
            <div class="flex justify-between text-sm">
                <span>1 ${currentUnit.name}</span>
                <span>=</span>
                <span>${ratio} ${nextUnit.name}</span>
            </div>
        `;
    }
    
    summary.innerHTML = `
        <div class="text-center mb-3">
            <div class="text-sm text-gray-500 mb-1">单位链</div>
            <div class="text-lg font-medium">${unitChain}</div>
        </div>
        
        <div class="bg-blue-50 p-3 rounded-lg mb-3">
            <div class="text-blue-700 font-medium text-center">${totalConversion}</div>
        </div>
        
        <div class="space-y-1">
            ${detailedConversions}
        </div>
    `;
    
    // 更新顶层单位显示
    const topUnitDisplay = document.getElementById('topUnitDisplay');
    if (topUnitDisplay) {
        topUnitDisplay.textContent = largestUnit.name;
    }
}
        
        // 进入第三步
        function proceedToStep3() {
            const units = window.currentUnitSystem.units;
            
            if (units.length < 2) {
                showToast('请至少添加一个包装单位', 'error');
                return;
            }
            
            // 检查所有单位是否都有名称
            const hasEmptyNames = units.some(unit => !unit.name.trim());
            if (hasEmptyNames) {
                showToast('请为所有单位设置名称', 'error');
                return;
            }
            
            showGuideStep(3);
            updateStep3Summary();
        }
        
        // 更新第三步的单位摘要
        function updateStep3Summary() {
            const summary = document.getElementById('unitSummary');
            const units = window.currentUnitSystem.units;
            
            // 从大到小排序显示
            const sortedUnits = [...units].sort((a, b) => b.ratio - a.ratio);
            
            const chainHtml = sortedUnits.map((unit, index) => {
                if (index === 0) {
                    return `<div class="flex items-center justify-between p-2 bg-blue-50 rounded">
                        <span class="font-medium text-blue-700">${unit.name}</span>
                        <span class="text-sm text-blue-600">采购单位</span>
                    </div>`;
                } else {
                    const prevUnit = sortedUnits[index - 1];
                    const ratio = prevUnit.ratio / unit.ratio;
                    return `<div class="flex items-center justify-between p-2 border-l-2 border-gray-200 ml-4">
                        <span class="text-gray-700">${unit.name}</span>
                        <span class="text-sm text-gray-500">1${prevUnit.name} = ${ratio}${unit.name}</span>
                    </div>`;
                }
            }).join('');
            
            summary.innerHTML = chainHtml;
            
            // 更新采购单位显示
            const purchaseUnit = document.getElementById('guidePurchaseUnit');
            if (purchaseUnit) {
                purchaseUnit.textContent = sortedUnits[0].name;
            }
        }
        
        // 更新成本摘要
function updateCostSummary() {
    const costResults = document.getElementById('costResults');
    const purchasePrice = parseFloat(document.getElementById('purchasePriceInput').value) || 0;
    
    if (!window.currentUnitSystem || purchasePrice <= 0 || !costResults) {
        if (costResults) {
            costResults.innerHTML = `
                <div class="text-center text-gray-500">
                    请输入有效的采购价格
                </div>
            `;
        }
        return;
    }
    
    const units = window.currentUnitSystem.units;
    
    // 从大到小排序单位
    const sortedUnits = [...units].sort((a, b) => b.ratio - a.ratio);
    
    // 计算各级单位成本
    const costItems = sortedUnits.map(unit => {
        const unitCost = purchasePrice * (unit.ratio / sortedUnits[0].ratio);
        return {
            name: unit.name,
            cost: unitCost.toFixed(4),
            isBase: unit.ratio === 1
        };
    });
    
    // 生成HTML
    let costHtml = '';
    
    // 添加各级单位成本
    costItems.forEach(item => {
        if (item.isBase) {
            costHtml += `
                <div class="bg-green-50 p-3 rounded-lg mb-2">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-green-700">基本单位成本</span>
                        <span class="font-bold text-green-800">¥${item.cost} / ${item.name}</span>
                    </div>
                </div>
            `;
        } else {
            costHtml += `
                <div class="flex justify-between items-center p-2">
                    <span>${item.name}单价</span>
                    <span class="font-medium">¥${item.cost}</span>
                </div>
            `;
        }
    });
    
    // 添加常用量成本示例
    const baseUnit = units.find(u => u.ratio === 1) || units[units.length - 1];
    const baseUnitCost = parseFloat(costItems[costItems.length - 1].cost);
    
    costHtml += `
        <div class="mt-3 pt-3 border-t border-gray-200">
            <div class="text-sm text-gray-600 mb-2">常用量成本示例</div>
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-white p-2 rounded border text-center">
                    <div class="text-xs text-gray-500">100${baseUnit.name}</div>
                    <div class="font-medium">¥${(baseUnitCost * 100).toFixed(2)}</div>
                </div>
                <div class="bg-white p-2 rounded border text-center">
                    <div class="text-xs text-gray-500">500${baseUnit.name}</div>
                    <div class="font-medium">¥${(baseUnitCost * 500).toFixed(2)}</div>
                </div>
                <div class="bg-white p-2 rounded border text-center">
                    <div class="text-xs text-gray-500">1000${baseUnit.name}</div>
                    <div class="font-medium">¥${(baseUnitCost * 1000).toFixed(2)}</div>
                </div>
            </div>
        </div>
    `;
    
    costResults.innerHTML = costHtml;
}
        
        // 确认多层级单位设置
        function confirmMultiLevelUnitSetting() {
            // 检查是否至少有两个层级
            if (!multiLevelUnits || multiLevelUnits.length < 2) {
                showToast('请至少设置一个包装单位', 'error');
                return;
            }
            
            // 检查单位名称是否都已设置
            const hasEmptyNames = multiLevelUnits.some(unit => !unit.name.trim());
            if (hasEmptyNames) {
                showToast('请为所有单位设置名称', 'error');
                return;
            }
            
            // 检查换算比例是否都已设置（除了基础单位）
            const hasEmptyRatios = multiLevelUnits.slice(1).some(unit => !unit.ratio || unit.ratio <= 0);
            if (hasEmptyRatios) {
                showToast('请为所有包装单位设置换算关系', 'error');
                return;
            }
            
            // 保存单位数据到隐藏元素
            const actualLevels = document.getElementById('actualUnitLevels');
            if (actualLevels) {
                actualLevels.dataset.units = JSON.stringify(multiLevelUnits);
            }
            
            // 从大到小排序单位（按层级）
            const sortedUnits = [...multiLevelUnits].sort((a, b) => b.level - a.level);
            const purchaseUnit = sortedUnits[0]; // 最大层级作为采购单位
            const baseUnit = sortedUnits[sortedUnits.length - 1]; // 最小层级作为基础单位
            
            // 更新规格输入框
            const specificationInput = document.getElementById('specification');
            const specificationNumber = document.getElementById('specificationNumber');
            const specificationUnit = document.getElementById('specificationUnit');
            const specificationPackage = document.getElementById('specificationPackage');
            const specificationPreview = document.getElementById('specificationPreview');
            
            if (specificationInput) {
                // 计算总换算比例
                let totalRatio = 1;
                for (let i = 0; i < sortedUnits.length - 1; i++) {
                    totalRatio *= (sortedUnits[i].ratio || 1);
                }
                
                const specText = `${totalRatio}${baseUnit.name}/${purchaseUnit.name}`;
                specificationInput.value = specText;
                
                // 同时更新简单规格显示
                if (specificationNumber) specificationNumber.value = totalRatio;
                if (specificationUnit) specificationUnit.value = baseUnit.name;
                if (specificationPackage) specificationPackage.value = purchaseUnit.name;
                if (specificationPreview) specificationPreview.textContent = `规格：${specText}`;
            }
            
            // 更新库存单位选项（引导设置完成后）
            const stockUnit = document.getElementById('stockUnit');
            const minStockUnit = document.getElementById('minStockUnit');
            
            if (stockUnit && !stockUnit.value) stockUnit.value = baseUnit.name;
            if (minStockUnit && !minStockUnit.value) minStockUnit.value = baseUnit.name;
            
            // 更新价格单位显示
            const purchaseUnitName = document.getElementById('purchaseUnitName');
            if (purchaseUnitName) {
                purchaseUnitName.textContent = purchaseUnit.name;
            }
            
            // 更新图表
            updateUnitRelationChart();
            
            // 隐藏单位设置卡片
            document.getElementById('unitSettingCard').style.display = 'none';
            
            showToast(`多层级单位设置完成！共设置了${multiLevelUnits.length}个层级`, 'success');
        }
        
        // 确认单位设置（保留原有功能）
function confirmUnitSetup() {
    if (!window.currentUnitSystem || window.currentUnitSystem.units.length < 2) {
        showToast('请至少设置一个包装单位', 'error');
        return;
    }
    
    // 检查单位名称是否都已设置
    const hasEmptyNames = window.currentUnitSystem.units.some(unit => !unit.name.trim());
    if (hasEmptyNames) {
        showToast('请为所有单位设置名称', 'error');
        return;
    }
    
    // 检查价格是否已输入
    const priceInput = document.getElementById('purchasePriceInput');
    const price = priceInput ? parseFloat(priceInput.value) : 0;
    
    // 保存单位数据到隐藏元素
    const actualLevels = document.getElementById('actualUnitLevels');
    if (actualLevels) {
        actualLevels.dataset.units = JSON.stringify(window.currentUnitSystem.units);
    }
    
    // 设置采购单位名称显示
    const units = window.currentUnitSystem.units;
    const sortedUnits = [...units].sort((a, b) => b.ratio - a.ratio);
    const purchaseUnit = sortedUnits[0]; // 最大单位作为采购单位
    
    // 更新规格输入框
    const specificationInput = document.getElementById('specification');
    if (specificationInput) {
        // 构建规格字符串，如"25kg/袋"
        let specText = "";
        if (sortedUnits.length >= 2) {
            const ratio = sortedUnits[0].ratio / sortedUnits[sortedUnits.length - 1].ratio;
            specText = `${ratio}${sortedUnits[sortedUnits.length - 1].name}/${sortedUnits[0].name}`;
        } else {
            specText = sortedUnits[0].name;
        }
        specificationInput.value = specText;
    }
    
                // 更新库存单位选项（多层级单位设置完成后）
            const baseUnit = sortedUnits[sortedUnits.length - 1]; // 最小单位
            const stockUnit = document.getElementById('stockUnit');
            const minStockUnit = document.getElementById('minStockUnit');
            
            if (stockUnit && !stockUnit.value) stockUnit.value = baseUnit.name;
            if (minStockUnit && !minStockUnit.value) minStockUnit.value = baseUnit.name;
    
    
    
    // 隐藏引导设置和单位设置卡片
    document.getElementById('unitGuide').style.display = 'none';
    document.getElementById('unitSettingCard').style.display = 'none';
    
    showToast('规格设置完成！', 'success');
}
        
        // 重置单位设置
        function resetUnitSetup() {
            window.currentUnitSystem = null;
            window.selectedBaseUnit = null;
            showGuideStep(1);
            document.querySelectorAll('.unit-option').forEach(option => {
                option.classList.remove('selected');
            });
        }
        

        

        
        // 这个函数已不再使用，可以删除
        
        // 计算换算结果
function calculateConversion() {
    const amount = parseFloat(document.getElementById('testAmount').value) || 0;
    const fromUnit = document.getElementById('testFromUnit').value;
    const toUnit = document.getElementById('testToUnit').value;
    
    if (!window.currentUnitSystem || amount === 0) {
        document.getElementById('testResult').textContent = '0';
        return;
    }
    
    const units = window.currentUnitSystem.units;
    const fromUnitData = units.find(u => u.name === fromUnit);
    const toUnitData = units.find(u => u.name === toUnit);
    
    if (!fromUnitData || !toUnitData) {
        document.getElementById('testResult').textContent = '错误';
        return;
    }
    
    // 计算结果 = 输入数量 × (源单位比例 ÷ 目标单位比例)
    const result = (amount * fromUnitData.ratio) / toUnitData.ratio;
    document.getElementById('testResult').textContent = result.toFixed(2);
}

// 准备单位选项 - 为单位换算测试器提供选项
function prepareUnitOptions(fromSelect, toSelect) {
    if (!window.currentUnitSystem || !window.currentUnitSystem.units) return;
    
    if (!fromSelect || !toSelect) return;
    
    // 清空现有选项
    fromSelect.innerHTML = '';
    toSelect.innerHTML = '';
    
    // 添加所有单位选项
    const units = window.currentUnitSystem.units;
    units.forEach(unit => {
        const fromOption = document.createElement('option');
        fromOption.value = unit.name;
        fromOption.textContent = unit.name;
        
        const toOption = document.createElement('option');
        toOption.value = unit.name;
        toOption.textContent = unit.name;
        
        fromSelect.appendChild(fromOption);
        toSelect.appendChild(toOption);
    });
    
    // 设置默认值：从大单位到小单位
    if (units.length >= 2) {
        const sortedUnits = [...units].sort((a, b) => b.ratio - a.ratio);
        fromSelect.value = sortedUnits[0].name; // 最大单位
        toSelect.value = sortedUnits[sortedUnits.length - 1].name; // 最小单位
    }
    
    // 初始计算
    calculateConversion();
}
        
        // 生成材料编码
        function generateMaterialCode() {
            const now = new Date();
            const dateStr = now.getFullYear().toString().substr(-2) + 
                           (now.getMonth() + 1).toString().padStart(2, '0') + 
                           now.getDate().toString().padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const code = `MAT${dateStr}${randomNum}`;
            
            document.getElementById('materialCode').value = code;
        }
        
        // 切换编码编辑状态
        function toggleCodeEdit() {
            const codeInput = document.getElementById('materialCode');
            const editBtn = codeInput.nextElementSibling;
            
            if (codeInput.readOnly) {
                codeInput.readOnly = false;
                codeInput.focus();
                editBtn.innerHTML = '<i class="fas fa-save"></i> 保存';
                editBtn.classList.remove('text-blue-500', 'hover:text-blue-700');
                editBtn.classList.add('text-green-500', 'hover:text-green-700');
            } else {
                codeInput.readOnly = true;
                editBtn.innerHTML = '<i class="fas fa-edit"></i> 编辑';
                editBtn.classList.remove('text-green-500', 'hover:text-green-700');
                editBtn.classList.add('text-blue-500', 'hover:text-blue-700');
                showToast('编码已保存', 'success');
            }
        }
        
        // 扫码功能
        function startScanCode() {
            showToast('正在启动摄像头扫码...', 'info');
            
            // 模拟扫码过程
            setTimeout(() => {
                const mockBarcode = '6901234567890';
                
                // 模拟检查系统中是否存在该条码
                const existsInSystem = Math.random() > 0.5;
                
                if (existsInSystem) {
                    // 自动填充已有材料信息
                    fillMaterialFromBarcode(mockBarcode);
                    showToast('扫码成功！已自动填充材料信息', 'success');
                } else {
                    // 只填入条码
                    document.getElementById('barcode').value = mockBarcode;
                    showToast('扫码成功！请手动填写材料信息', 'info');
                }
            }, 2000);
        }
        
        // 根据条码填充材料信息
        function fillMaterialFromBarcode(barcode) {
            // 模拟从系统获取材料信息
            const mockData = {
                name: '金龙鱼高筋面粉',
                category: 'flour',
                warehouse: 'raw_material',
                barcode: barcode,
                canSell: true
            };
            
            document.getElementById('materialName').value = mockData.name;
            document.getElementById('materialCategory').value = mockData.category;
            document.getElementById('warehouse').value = mockData.warehouse;
            document.getElementById('barcode').value = mockData.barcode;
            document.getElementById('canSell').checked = mockData.canSell;
        }
        
        // 显示材料资源库
        function showMaterialLibrary() {
            const modal = document.getElementById('materialLibraryModal');
            modal.classList.add('active');
            renderMaterialLibrary();
            
            // 添加点击背景关闭功能
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    hideMaterialLibrary();
                }
            });
        }
        
        // 隐藏材料资源库
        function hideMaterialLibrary() {
            document.getElementById('materialLibraryModal').classList.remove('active');
        }
        
        // 加载材料资源库数据
        function loadMaterialLibrary() {
            materialLibraryData = [
                { id: 1, name: '高筋面粉', category: '粉类', unit: 'kg', price: 8.5, selected: false },
                { id: 2, name: '低筋面粉', category: '粉类', unit: 'kg', price: 7.8, selected: false },
                { id: 3, name: '玉米淀粉', category: '粉类', unit: 'kg', price: 6.2, selected: false },
                { id: 4, name: '黄油', category: '油脂类', unit: 'kg', price: 45.0, selected: false },
                { id: 5, name: '植物油', category: '油脂类', unit: 'L', price: 12.5, selected: false },
                { id: 6, name: '细砂糖', category: '糖类', unit: 'kg', price: 5.5, selected: false },
                { id: 7, name: '红糖', category: '糖类', unit: 'kg', price: 8.0, selected: false },
                { id: 8, name: '牛奶', category: '乳制品', unit: 'L', price: 15.0, selected: false },
                { id: 9, name: '奶油', category: '乳制品', unit: 'L', price: 35.0, selected: false },
                { id: 10, name: '鸡蛋', category: '蛋类', unit: '个', price: 1.2, selected: false }
            ];
        }
        
        // 渲染材料资源库列表
        function renderMaterialLibrary() {
            const container = document.getElementById('materialLibraryList');
            const searchTerm = document.getElementById('librarySearch').value.toLowerCase();
            
            const filteredData = materialLibraryData.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                item.category.toLowerCase().includes(searchTerm)
            );
            
            container.innerHTML = filteredData.map(item => `
                <div class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                    <input type="checkbox" id="material_${item.id}" ${item.selected ? 'checked' : ''} 
                           onchange="toggleMaterialSelection(${item.id})" class="rounded">
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${item.name}</div>
                        <div class="text-sm text-gray-600">${item.category} · ${item.unit} · ¥${item.price}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // 切换材料选择状态
        function toggleMaterialSelection(id) {
            const item = materialLibraryData.find(m => m.id === id);
            if (item) {
                item.selected = !item.selected;
            }
        }
        
        // 过滤材料资源库
        function filterMaterialLibrary() {
            renderMaterialLibrary();
        }
        
        // 导入选中的材料
        function importSelectedMaterials() {
            const selectedMaterials = materialLibraryData.filter(m => m.selected);
            
            if (selectedMaterials.length === 0) {
                showToast('请选择要导入的材料', 'warning');
                return;
            }
            
            showToast(`正在导入${selectedMaterials.length}个材料...`, 'info');
            
            setTimeout(() => {
                showToast(`成功导入${selectedMaterials.length}个材料！`, 'success');
                hideMaterialLibrary();
                // 这里可以添加实际的导入逻辑
            }, 2000);
        }
        
        // 显示成本计算器
        function showCostCalculator() {
            document.getElementById('costCalculator').style.display = 'block';
            updateCostCalculator();
        }
        
        // 隐藏成本计算器
        function hideCostCalculator() {
            document.getElementById('costCalculator').style.display = 'none';
        }
        
        // 更新成本预览
        function updateCostPreview() {
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const purchaseUnit = document.getElementById('purchaseUnit').value || '箱';
            
            // 获取单位数据
            const unitData = getUnitData();
            
            if (unitData.length === 0 || purchasePrice === 0) {
                document.getElementById('costPreviewCard').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-calculator text-3xl mb-2"></i>
                        <p>请先设置包装关系和采购价格</p>
                    </div>
                `;
                return;
            }
            
            // 找到基本单位和采购单位
            const baseUnit = unitData.find(unit => unit.isBase) || unitData[unitData.length - 1];
            const purchaseUnitData = unitData.find(unit => unit.name === purchaseUnit) || unitData[0];
            
            // 计算基本单位成本
            const baseCost = purchasePrice / purchaseUnitData.ratio;
            
            // 计算总体换算关系
            const largestUnit = unitData.reduce((max, unit) => unit.ratio > max.ratio ? unit : max, unitData[0]);
            const smallestUnit = unitData.reduce((min, unit) => unit.ratio < min.ratio ? unit : min, unitData[0]);
            const totalConversion = largestUnit.ratio / smallestUnit.ratio;
            
            // 生成常用量成本示例
            const commonAmounts = [
                { amount: 100, unit: smallestUnit.name },
                { amount: 1000, unit: smallestUnit.name },
                { amount: 1, unit: largestUnit.name }
            ];
            
            const exampleCosts = commonAmounts.map(item => {
                const unitInfo = unitData.find(u => u.name === item.unit);
                const cost = baseCost * unitInfo.ratio * item.amount;
                return {
                    description: `${item.amount}${item.unit}`,
                    cost: cost.toFixed(2)
                };
            });
            
            document.getElementById('costPreviewCard').innerHTML = `
                <div class="space-y-4">
                    <!-- 采购价格 -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                        <div class="text-sm text-blue-600 mb-1">💰 采购价格</div>
                        <div class="text-xl font-bold text-blue-800">¥${purchasePrice} / ${purchaseUnit}</div>
                    </div>
                    
                    <!-- 单位换算 -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
                        <div class="text-sm text-green-600 mb-1">📏 单位换算</div>
                        <div class="text-lg font-bold text-green-800">1${largestUnit.name} = ${totalConversion}${smallestUnit.name}</div>
                    </div>
                    
                    <!-- 基本成本 -->
                    <div class="bg-gradient-to-r from-orange-50 to-amber-50 p-4 rounded-lg border border-orange-200">
                        <div class="text-sm text-orange-600 mb-1">🎯 基本成本</div>
                        <div class="text-xl font-bold text-orange-800">¥${baseCost.toFixed(4)} / ${baseUnit.name}</div>
                    </div>
                    
                    <!-- 常用量成本示例 -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-3">📊 常用量成本参考</div>
                        <div class="grid grid-cols-1 gap-2">
                            ${exampleCosts.map(example => `
                                <div class="flex justify-between items-center py-2 px-3 bg-white rounded border">
                                    <span class="text-sm font-medium">${example.description}</span>
                                    <span class="text-sm font-bold text-gray-800">¥${example.cost}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 更新成本计算器
        function updateCostCalculator() {
            const unitData = getUnitData();
            
            if (unitData.length === 0) {
                document.getElementById('costCalculatorContent').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>请先设置单位关系</p>
                    </div>
                `;
                return;
            }
            
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const baseUnit = unitData.find(unit => unit.isBase) || unitData[unitData.length - 1];
            const baseCost = purchasePrice > 0 ? purchasePrice / unitData[0].ratio : 0;
            
            document.getElementById('costCalculatorContent').innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600 mb-1">采购价格</div>
                            <div class="text-lg font-semibold">¥${purchasePrice}</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-sm text-blue-600 mb-1">基本单位成本</div>
                            <div class="text-lg font-semibold text-blue-800">¥${baseCost.toFixed(4)}/${baseUnit.name}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-3">成本明细</h4>
                        <div class="space-y-2">
                            ${unitData.map(unit => {
                                const cost = baseCost * unit.ratio;
                                return `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="font-medium">${unit.name}</span>
                                        <span class="text-lg">¥${cost.toFixed(4)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-medium mb-3">自定义计算</h4>
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <input type="number" id="customAmount" placeholder="数量" class="form-input">
                            <select id="customFromUnit" class="form-select">
                                ${unitData.map(unit => `<option value="${unit.name}">${unit.name}</option>`).join('')}
                            </select>
                            <button onclick="calculateCustomCost()" class="btn btn-primary">计算</button>
                        </div>
                        <div id="customCostResult" class="text-center text-gray-500">输入数量和单位进行计算</div>
                    </div>
                </div>
            `;
        }
        
        // 计算自定义成本
        function calculateCustomCost() {
            const amount = parseFloat(document.getElementById('customAmount').value);
            const fromUnit = document.getElementById('customFromUnit').value;
            
            if (!amount || amount <= 0) {
                document.getElementById('customCostResult').innerHTML = '<span class="text-red-500">请输入有效数量</span>';
                return;
            }
            
            const unitData = getUnitData();
            const fromUnitData = unitData.find(unit => unit.name === fromUnit);
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            
            if (!fromUnitData || purchasePrice === 0) {
                document.getElementById('customCostResult').innerHTML = '<span class="text-red-500">计算失败</span>';
                return;
            }
            
            const baseCost = purchasePrice / unitData[0].ratio;
            const totalCost = baseCost * fromUnitData.ratio * amount;
            
            document.getElementById('customCostResult').innerHTML = `
                <div class="bg-green-50 p-3 rounded-lg">
                    <div class="text-green-600 text-sm">计算结果</div>
                    <div class="text-green-800 font-bold text-lg">${amount} ${fromUnit} = ¥${totalCost.toFixed(2)}</div>
                </div>
            `;
        }
        
        // 获取单位数据
        function getUnitData() {
            const actualLevels = document.getElementById('actualUnitLevels');
            if (!actualLevels || !actualLevels.dataset.units) {
                return [];
            }
            
            try {
                return JSON.parse(actualLevels.dataset.units);
            } catch (e) {
                return [];
            }
        }
        
        // 添加单位层级
        function addUnitLevel() {
            if (unitLevelCount >= 5) {
                showToast('最多支持5个层级', 'warning');
                return;
            }
            
            unitLevelCount++;
            const container = document.getElementById('unitLevels');
            
            const levelDiv = document.createElement('div');
            levelDiv.className = 'unit-level';
            levelDiv.setAttribute('data-level', unitLevelCount);
            
            // 确定层级颜色和标题
            let levelColor = 'text-gray-700';
            let levelBg = 'bg-gray-50';
            let levelTitle = `第${unitLevelCount}层级`;
            
            if (unitLevelCount === 2) {
                levelColor = 'text-green-700';
                levelBg = 'bg-green-50';
                levelTitle = '包装单位（第2层级）';
            } else if (unitLevelCount === 3) {
                levelColor = 'text-orange-700';
                levelBg = 'bg-orange-50';
                levelTitle = '中包装单位（第3层级）';
            } else if (unitLevelCount === 4) {
                levelColor = 'text-purple-700';
                levelBg = 'bg-purple-50';
                levelTitle = '大包装单位（第4层级）';
            } else if (unitLevelCount === 5) {
                levelColor = 'text-red-700';
                levelBg = 'bg-red-50';
                levelTitle = '最大包装单位（第5层级）';
            }
            
            levelDiv.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-medium ${levelColor}">${levelTitle}</span>
                    <button type="button" onclick="removeUnitLevel(${unitLevelCount})" class="text-red-500 text-xs hover:text-red-700 px-2 py-1 rounded hover:bg-red-100">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-600 mb-1 block">单位名称</label>
                        <input type="text" class="form-input text-sm unit-name" data-level="${unitLevelCount}" placeholder="如：箱、包、袋等" onchange="updateMultiLevelUnits(); updateConversionPreview();">
                    </div>
                    <div>
                        <label class="text-xs text-gray-600 mb-1 block">换算关系</label>
                        <div class="flex items-center space-x-1">
                            <span class="text-xs text-gray-500">1</span>
                            <span class="text-xs font-medium text-blue-600 unit-current">当前单位</span>
                            <span class="text-xs text-gray-500">=</span>
                            <input type="number" class="form-input text-sm w-16 unit-ratio" data-level="${unitLevelCount}" placeholder="数量" min="1" step="0.01" oninput="updateMultiLevelUnits(); updateConversionPreview();">
                            <span class="text-xs font-medium text-green-600 unit-previous">下级单位</span>
                        </div>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-500 ${levelBg} px-2 py-1 rounded">
                    <i class="fas fa-info-circle"></i> 表示：1个当前单位包含多少个下级单位
                </div>
            `;
            
            container.appendChild(levelDiv);
            
            // 添加到多层级单位数组
            multiLevelUnits.push({
                level: unitLevelCount,
                name: '',
                ratio: 1,
                isBase: false,
                description: `第${unitLevelCount}层级包装单位`
            });
            
            updateUnitDisplays();
            updateConversionPreview();
            showToast(`已添加${levelTitle}`, 'success');
        }
        
        // 删除单位层级
        function removeUnitLevel(level) {
            if (level === 1) {
                showToast('基础单位不能删除', 'warning');
                return;
            }
            
            const levelDiv = document.querySelector(`[data-level="${level}"]`);
            if (levelDiv) {
                levelDiv.remove();
                
                // 从多层级单位数组中移除
                multiLevelUnits = multiLevelUnits.filter(unit => unit.level !== level);
                
                // 重新编号层级
                const remainingLevels = document.querySelectorAll('.unit-level');
                remainingLevels.forEach((div, index) => {
                    const newLevel = index + 1;
                    div.setAttribute('data-level', newLevel);
                    div.querySelector('.unit-name').setAttribute('data-level', newLevel);
                    div.querySelector('.unit-ratio').setAttribute('data-level', newLevel);
                    
                    // 更新多层级单位数组中的层级编号
                    if (multiLevelUnits[index]) {
                        multiLevelUnits[index].level = newLevel;
                    }
                });
                
                unitLevelCount = remainingLevels.length;
                updateUnitDisplays();
                updateConversionPreview();
                showToast('已删除单位层级', 'success');
            }
        }
        
        // 更新多层级单位数据
        function updateMultiLevelUnits() {
            const levels = document.querySelectorAll('.unit-level');
            
            levels.forEach((level, index) => {
                const levelNum = parseInt(level.getAttribute('data-level'));
                const nameInput = level.querySelector('.unit-name');
                const ratioInput = level.querySelector('.unit-ratio');
                
                if (multiLevelUnits[index]) {
                    multiLevelUnits[index].name = nameInput.value || '';
                    multiLevelUnits[index].ratio = parseFloat(ratioInput ? ratioInput.value : 1) || 1;
                    multiLevelUnits[index].level = levelNum;
                }
            });
            
            // 更新规格显示
            updateSpecificationDisplay();
        }
        
        // 更新规格显示
        function updateSpecificationDisplay() {
            const specInput = document.getElementById('specification');
            if (!specInput || multiLevelUnits.length < 2) return;
            
            // 找到最大层级和基础单位
            const sortedUnits = [...multiLevelUnits].sort((a, b) => b.level - a.level);
            const maxUnit = sortedUnits[0];
            const baseUnit = sortedUnits[sortedUnits.length - 1];
            
            if (maxUnit.name && baseUnit.name) {
                // 计算总换算比例
                let totalRatio = 1;
                for (let i = 0; i < sortedUnits.length - 1; i++) {
                    totalRatio *= sortedUnits[i].ratio;
                }
                
                specInput.value = `${totalRatio}${baseUnit.name}/${maxUnit.name}`;
            }
        }
        
        // 更新换算关系预览
        function updateConversionPreview() {
            const levels = document.querySelectorAll('.unit-level');
            const conversionPreview = document.getElementById('conversionPreview');
            const conversionChain = document.getElementById('conversionChain');
            
            if (levels.length <= 1) {
                conversionPreview.style.display = 'none';
                return;
            }
            
            let chainHtml = '';
            let totalRatio = 1;
            
            // 从最高层级到基础单位构建换算链
            for (let i = levels.length - 1; i >= 0; i--) {
                const level = levels[i];
                const unitName = level.querySelector('.unit-name').value || `第${i+1}层级单位`;
                
                if (i === levels.length - 1) {
                    // 最高层级
                    chainHtml += `<div class="conversion-step">1 ${unitName}</div>`;
                } else {
                    // 获取换算比例
                    const nextLevel = levels[i + 1];
                    const ratio = parseFloat(nextLevel.querySelector('.unit-ratio').value) || 1;
                    totalRatio *= ratio;
                    
                    chainHtml += `<div class="conversion-arrow">×${ratio}</div>`;
                    chainHtml += `<div class="conversion-step">${totalRatio} ${unitName}</div>`;
                }
            }
            
            conversionChain.innerHTML = chainHtml;
            conversionPreview.style.display = 'block';
        }
        
        // 更新单位层级结构图
        function updateHierarchyChart() {
            const levels = document.querySelectorAll('.unit-level');
            const hierarchyChart = document.getElementById('unitHierarchyChart');
            const hierarchyNodes = document.getElementById('hierarchyNodes');
            
            if (levels.length <= 1) {
                hierarchyChart.style.display = 'none';
                return;
            }
            
            let nodesHtml = '';
            
            levels.forEach((level, index) => {
                const unitName = level.querySelector('.unit-name').value || `第${index+1}层级单位`;
                const isBaseUnit = index === 0;
                const nodeClass = isBaseUnit ? 'base-unit' : 'regular-unit';
                
                if (index > 0) {
                    nodesHtml += '<div class="hierarchy-connector"></div>';
                }
                
                nodesHtml += `
                    <div class="hierarchy-node ${nodeClass}">
                        <span class="text-xs mr-2">${isBaseUnit ? '🏠' : '📦'}</span>
                        <span class="font-medium">${unitName}</span>
                        <span class="ml-auto text-xs">${isBaseUnit ? '基础单位' : `第${index+1}层级`}</span>
                    </div>
                `;
            });
            
            hierarchyNodes.innerHTML = nodesHtml;
            hierarchyChart.style.display = 'block';
        }
        
        // 切换成本计算面板显示
        function toggleCostCalculationPanel() {
            const panel = document.getElementById('costCalculationPanel');
            const simplePreview = document.getElementById('simpleCostPreview');
            const toggleText = document.getElementById('costPanelToggleText');
            
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                simplePreview.style.display = 'none';
                toggleText.textContent = '隐藏详细计算';
                calculateDetailedCost();
            } else {
                panel.style.display = 'none';
                simplePreview.style.display = 'block';
                toggleText.textContent = '查看详细计算';
            }
        }
        
        // 详细成本计算
        function calculateDetailedCost() {
            const topLevelPrice = parseFloat(document.getElementById('topLevelPrice').value) || 0;
            const levels = document.querySelectorAll('.unit-level');
            
            // 更新采购单位价格显示
            const topUnitName = levels.length > 1 ? 
                (levels[levels.length - 1].querySelector('.unit-name').value || '采购单位') : 
                '采购单位';
            document.getElementById('purchaseUnitPrice').textContent = `¥${topLevelPrice.toFixed(2)} / ${topUnitName}`;
            
            if (topLevelPrice === 0 || levels.length === 0) {
                resetCostDisplays();
                return;
            }
            
            // 计算总换算比例
            let totalRatio = 1;
            let conversionText = '';
            
            if (levels.length > 1) {
                for (let i = levels.length - 1; i > 0; i--) {
                    const ratioInput = levels[i].querySelector('.unit-ratio');
                    const ratio = parseFloat(ratioInput.value) || 1;
                    totalRatio *= ratio;
                }
                
                const baseUnitName = levels[0].querySelector('.unit-name').value || '基础单位';
                conversionText = `1 ${topUnitName} = ${totalRatio} ${baseUnitName}`;
            } else {
                conversionText = '1 采购单位 = 1 基础单位';
            }
            
            document.getElementById('totalConversionRatio').textContent = conversionText;
            
            // 获取基础单位和密度系数
            const baseUnitSelect = levels[0].querySelector('.unit-name');
            const baseUnit = baseUnitSelect.value;
            let densityFactor = 1.0;
            let densityText = '1.0000（重量单位）';
            
            if (baseUnit === 'ml' || baseUnit === 'L') {
                densityFactor = 0.8; // 假设液体密度
                densityText = '0.8000（液体密度）';
            }
            
            document.getElementById('densityFactorDisplay').textContent = densityText;
            
            // 计算基础单位成本
            const baseUnitCost = topLevelPrice / totalRatio;
            const baseUnitName = baseUnit || '基础单位';
            document.getElementById('baseUnitCost').textContent = `¥${baseUnitCost.toFixed(4)} / ${baseUnitName}`;
            
            // 计算标准成本（每克）
            let costPerGram = baseUnitCost;
            if (baseUnit === 'kg') {
                costPerGram = baseUnitCost / 1000;
            } else if (baseUnit === 'ml') {
                costPerGram = baseUnitCost * densityFactor / 1000;
            } else if (baseUnit === 'L') {
                costPerGram = baseUnitCost * densityFactor;
            }
            
            document.getElementById('standardCostPerGram').textContent = `¥${costPerGram.toFixed(4)} / 克`;
            
            // 更新简化预览
            document.getElementById('currentCost').textContent = `¥${baseUnitCost.toFixed(4)} / ${baseUnitName}`;
        }
        
        // 更新单位显示
        function updateUnitDisplays() {
            const levels = document.querySelectorAll('.unit-level');
            levels.forEach((level, index) => {
                const currentSpan = level.querySelector('.unit-current');
                const previousSpan = level.querySelector('.unit-previous');
                
                if (currentSpan && previousSpan) {
                    const currentInput = level.querySelector('.unit-name');
                    const currentName = currentInput ? currentInput.value || '当前单位' : '当前单位';
                    
                    currentSpan.textContent = currentName;
                    
                    if (index > 0) {
                        const prevLevel = levels[index - 1];
                        const prevInput = prevLevel.querySelector('.unit-name');
                        const prevName = prevInput ? prevInput.value || '下级单位' : '下级单位';
                        previousSpan.textContent = prevName;
                    } else {
                        previousSpan.textContent = '基础单位';
                    }
                }
            });
            
            // 更新顶层单位显示
            const topLevel = levels[levels.length - 1];
            if (topLevel) {
                const topUnitInput = topLevel.querySelector('.unit-name');
                const topUnitName = topUnitInput ? topUnitInput.value || '顶层单位' : '顶层单位';
                const topLevelDisplay = document.getElementById('topLevelUnitDisplay');
                if (topLevelDisplay) topLevelDisplay.textContent = topUnitName;
            }
            
            // 更新库存单位选项（单位层级更新时）
            const baseLevel = levels[0];
            if (baseLevel) {
                const baseUnitInput = baseLevel.querySelector('.unit-name');
                const baseUnitName = baseUnitInput ? baseUnitInput.value || '基础单位' : '基础单位';
                const stockUnit = document.getElementById('stockUnit');
                const minStockUnit = document.getElementById('minStockUnit');
                if (stockUnit && baseUnitName && !stockUnit.value) stockUnit.value = baseUnitName;
                if (minStockUnit && baseUnitName && !minStockUnit.value) minStockUnit.value = baseUnitName;
            }
        }
        
        // 重置成本显示
        function resetCostDisplays() {
            document.getElementById('purchaseUnitPrice').textContent = '¥0.00 / 采购单位';
            document.getElementById('totalConversionRatio').textContent = '暂无换算关系';
            document.getElementById('densityFactorDisplay').textContent = '1.0000（重量单位）';
            document.getElementById('baseUnitCost').textContent = '¥0.0000 / 基础单位';
            document.getElementById('standardCostPerGram').textContent = '¥0.0000 / 克';
            document.getElementById('currentCost').textContent = '¥0.0000 / 基础单位';
        }
        
        // 设置单位变化监听器
        function setupUnitChangeListeners() {
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('unit-name') || e.target.classList.contains('unit-ratio')) {
                    updateUnitDisplays();
                    updateConversionPreview();
                    updateHierarchyChart();
                    calculateDetailedCost();
                }
            });
        }
        

        
        // 输入框焦点效果
        function addInputFocusEffects() {
            const inputs = document.querySelectorAll('.form-input, .form-select');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('focused');
                });
                
                input.addEventListener('blur', function() {
                    this.parentElement.classList.remove('focused');
                });
            });
        }
        
        // 卡片点击反馈
        function addCardClickFeedback() {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.addEventListener('click', function(e) {
                    if (!e.target.matches('input, select, button, textarea')) {
                        this.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                        }, 150);
                    }
                });
            });
        }
        
        // 模拟材料数据
        const materialDatabase = {
            1: {
                id: 1,
                name: '高筋面粉',
                warehouse: 'main',
                category: 'flour',
                categoryName: '粉类',
                specification: '1000g/包',
                purchasePrice: 6.50,
                usableAmount: '',
                usableUnit: '',
                barcode: '6901234567890',
                code: 'FL-001',
                canSell: false,
                currentStock: 2500,
                stockUnit: 'g',
                minStock: 500,
                minStockUnit: 'g',
                image: 'https://images.unsplash.com/photo-1603566541830-a1f7a7982a1c?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80'
            },
            2: {
                id: 2,
                name: '中筋面粉',
                warehouse: 'main',
                category: 'flour',
                categoryName: '粉类',
                specification: '1000g/包',
                purchasePrice: 5.80,
                usableAmount: '',
                usableUnit: '',
                barcode: '6901234567891',
                code: 'FL-002',
                canSell: false,
                currentStock: 1800,
                stockUnit: 'g',
                minStock: 500,
                minStockUnit: 'g',
                image: 'https://images.unsplash.com/photo-1603566541830-a1f7a7982a1c?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80'
            },
            3: {
                id: 3,
                name: '低筋面粉',
                warehouse: 'main',
                category: 'flour',
                categoryName: '粉类',
                specification: '500g/包',
                purchasePrice: 7.20,
                usableAmount: '',
                usableUnit: '',
                barcode: '6901234567892',
                code: 'FL-003',
                canSell: false,
                currentStock: 300,
                stockUnit: 'g',
                minStock: 500,
                minStockUnit: 'g',
                image: 'https://images.unsplash.com/photo-1603566541830-a1f7a7982a1c?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80'
            }
        };

        let currentMaterialId = null;

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 获取材料ID
            const urlParams = new URLSearchParams(window.location.search);
            currentMaterialId = urlParams.get('id');
            
            if (currentMaterialId && materialDatabase[currentMaterialId]) {
                loadMaterialData(materialDatabase[currentMaterialId]);
            } else {
                showToast('材料不存在', 'error');
                setTimeout(() => {
                    history.back();
                }, 2000);
            }
        });

        // 加载材料数据到表单
        function loadMaterialData(material) {
            document.getElementById('materialName').value = material.name;
            document.getElementById('warehouse').value = material.warehouse;
            document.getElementById('materialCategory').value = material.category;
            document.getElementById('purchasePrice').value = material.purchasePrice;
            document.getElementById('barcode').value = material.barcode || '';
            document.getElementById('materialCode').value = material.code || '';
            document.getElementById('canSell').checked = material.canSell;
            document.getElementById('currentStock').value = material.currentStock;
            document.getElementById('stockUnit').value = material.stockUnit;
            document.getElementById('minStock').value = material.minStock;
            document.getElementById('minStockUnit').value = material.minStockUnit;
            
            if (material.usableAmount) {
                document.getElementById('usablePortion').value = material.usableAmount;
                document.getElementById('usablePortionUnit').value = material.usableUnit;
            }
            
            // 解析规格信息
            if (material.specification) {
                const specMatch = material.specification.match(/^(\d+(?:\.\d+)?)([a-zA-Z\u4e00-\u9fa5]+)(?:\/([a-zA-Z\u4e00-\u9fa5]+))?$/);
                if (specMatch) {
                    document.getElementById('specificationNumber').value = specMatch[1];
                    document.getElementById('specificationUnit').value = specMatch[2];
                    if (specMatch[3]) {
                        document.getElementById('specificationPackage').value = specMatch[3];
                    }
                    updateSpecificationDisplay();
                }
            }
            
            // 加载图片
            if (material.image) {
                const imagePreview = document.getElementById('imagePreview');
                const uploadContainer = document.getElementById('imageUploadContainer');
                imagePreview.src = material.image;
                imagePreview.style.display = 'block';
                uploadContainer.classList.add('has-image');
            }
        }

        // 更新材料
        function updateMaterial(event) {
            event.preventDefault();
            
            showLoading();
            
            // 获取表单数据
            const categoryValue = document.getElementById('materialCategory').value;
            const categoryData = customCategories.find(cat => cat.code === categoryValue);
            
            const formData = {
                id: currentMaterialId,
                name: document.getElementById('materialName').value.trim(),
                warehouse: document.getElementById('warehouse').value,
                category: categoryValue,
                categoryName: categoryData ? categoryData.name : getCategoryName(categoryValue),
                specification: document.getElementById('specification').value.trim(),
                purchasePrice: document.getElementById('purchasePrice').value,
                usableAmount: document.getElementById('usablePortion').value || '',
                usableUnit: document.getElementById('usablePortionUnit').value || '',
                barcode: document.getElementById('barcode').value.trim(),
                code: document.getElementById('materialCode').value.trim(),
                canSell: document.getElementById('canSell').checked,
                currentStock: document.getElementById('currentStock').value,
                stockUnit: document.getElementById('stockUnit').value,
                minStock: document.getElementById('minStock').value,
                minStockUnit: document.getElementById('minStockUnit').value,
                customCategories: customCategories // 包含自定义分类数据
            };
            
            // 表单验证
            if (!validateForm(formData)) {
                hideLoading();
                return false;
            }
            
            // 更新数据库中的材料
            if (materialDatabase[currentMaterialId]) {
                Object.assign(materialDatabase[currentMaterialId], formData);
            }
            
            // 模拟API调用
            setTimeout(() => {
                hideLoading();
                showToast('材料更新成功！', 'success');
                
                setTimeout(() => {
                    history.back();
                }, 1500);
            }, 2000);
            
            return false;
        }
        
        // 获取分类名称
        function getCategoryName(categoryValue) {
            const categoryNames = {
                'flour': '粉类',
                'oil': '油脂类',
                'sugar': '糖类',
                'dairy': '乳制品',
                'egg': '蛋类',
                'fruit': '水果类',
                'nut': '坚果类',
                'other': '其他'
            };
            return categoryNames[categoryValue] || categoryValue;
        }
        
        // 表单验证
        function validateForm(data) {
            if (!data.name) {
                showToast('请输入材料名称', 'error');
                return false;
            }
            
            if (!data.warehouse) {
                showToast('请选择所属仓库', 'error');
                return false;
            }
            
            if (!data.category) {
                showToast('请选择材料分类', 'error');
                return false;
            }
            
            if (!document.getElementById('specification').value) {
                // 如果隐藏的规格字段为空，尝试从简单输入构建规格
                const number = document.getElementById('specificationNumber').value;
                const unit = document.getElementById('specificationUnit').value;
                const packageType = document.getElementById('specificationPackage').value;
                
                if (!number || !unit) {
                    showToast('请输入材料规格', 'error');
                    return false;
                }
                
                // 构建规格字符串并设置到隐藏字段
                let specText = '';
                if (packageType) {
                    specText = `${number}${unit}/${packageType}`;
                } else {
                    specText = `${number}${unit}`;
                }
                document.getElementById('specification').value = specText;
            }
            
            if (!data.purchasePrice || parseFloat(data.purchasePrice) <= 0) {
                showToast('请输入有效的采购价格', 'error');
                return false;
            }
            
            return true;
        }
        

        
        // Toast提示功能
        function showToast(message, type = 'info', duration = 3000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2 animate-slide-down`;
            
            let bgColor, textColor, icon;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    icon = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-white';
                    icon = 'fas fa-exclamation-triangle';
                    break;
                default:
                    bgColor = 'bg-blue-500';
                    textColor = 'text-white';
                    icon = 'fas fa-info-circle';
            }
            
            toast.classList.add(bgColor, textColor);
            toast.innerHTML = `
                <i class="${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('animate-slide-up');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        }
        
        // 显示加载状态
        function showLoading() {
            const loading = document.createElement('div');
            loading.id = 'loadingOverlay';
            loading.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loading.innerHTML = `
                <div class="bg-white rounded-lg p-6 flex flex-col items-center space-y-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <span class="text-gray-700">正在保存...</span>
                </div>
            `;
            document.body.appendChild(loading);
        }
        
        // 隐藏加载状态
        function hideLoading() {
            const loading = document.getElementById('loadingOverlay');
            if (loading) {
                loading.remove();
            }
        }
        
        // 显示单位设置卡片
        function showUnitSettingCard() {
            const unitSettingCard = document.getElementById('unitSettingCard');
            const unitTemplates = document.getElementById('unitTemplates');
            const unitGuide = document.getElementById('unitGuide');
            
            // 显示单位设置卡片
            unitSettingCard.style.display = 'block';
            
            // 初始化隐藏模板和引导
            unitTemplates.style.display = 'none';
            unitGuide.style.display = 'none';
            
            // 显示单位关系图
            updateUnitRelationChart();
        }
        
        // 切换单位帮助面板
        function toggleUnitHelp() {
            const helpPanel = document.getElementById('unitHelpPanel');
            const helpIcon = document.getElementById('helpIcon');
            const helpButton = helpIcon.parentElement;
            const isHidden = helpPanel.classList.contains('hidden');
            
            if (isHidden) {
                // 展开帮助面板
                helpPanel.classList.remove('hidden');
                helpPanel.style.opacity = '0';
                helpPanel.style.transform = 'translateY(-10px)';
                
                // 更新按钮样式和提示
                helpIcon.classList.remove('fa-question');
                helpIcon.classList.add('fa-times');
                helpButton.title = '点击收起帮助说明';
                helpButton.classList.remove('bg-blue-100', 'text-blue-600');
                helpButton.classList.add('bg-red-100', 'text-red-600', 'animate-pulse-help');
                
                // 使用requestAnimationFrame确保动画效果
                requestAnimationFrame(() => {
                    helpPanel.style.transition = 'all 0.3s ease-out';
                    helpPanel.style.opacity = '1';
                    helpPanel.style.transform = 'translateY(0)';
                });
                
                // 5秒后停止按钮动画
                setTimeout(() => {
                    helpButton.classList.remove('animate-pulse-help');
                }, 5000);
            } else {
                // 收起帮助面板
                helpPanel.style.transition = 'all 0.3s ease-in';
                helpPanel.style.opacity = '0';
                helpPanel.style.transform = 'translateY(-10px)';
                
                // 更新按钮样式和提示
                helpIcon.classList.remove('fa-times');
                helpIcon.classList.add('fa-question');
                helpButton.title = '点击查看帮助说明';
                helpButton.classList.remove('bg-red-100', 'text-red-600', 'animate-pulse-help');
                helpButton.classList.add('bg-blue-100', 'text-blue-600');
                
                setTimeout(() => {
                    helpPanel.classList.add('hidden');
                }, 300);
            }
        }
        
        // 检查首次使用用户
        function checkFirstTimeUser() {
            const hasSeenUnitGuide = localStorage.getItem('hasSeenUnitGuide');
            if (!hasSeenUnitGuide) {
                // 显示首次使用提示
                setTimeout(() => {
                    showFirstTimeUnitTip();
                }, 1000);
            }
        }
        
        // 显示首次使用单位设置提示
        function showFirstTimeUnitTip() {
            const tipOverlay = document.createElement('div');
            tipOverlay.id = 'firstTimeTip';
            tipOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            tipOverlay.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-sm w-full animate-scale-in">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-white text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">欢迎使用材料管理系统！</h3>
                        <p class="text-sm text-gray-600">
                            我们为您准备了详细的功能说明，帮助您快速上手。
                        </p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 mb-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-layer-group text-blue-600 mr-2"></i>
                            <span class="font-medium text-blue-800">多层级单位设置</span>
                        </div>
                        <p class="text-xs text-blue-700">
                            点击问号图标 <i class="fas fa-question text-blue-600 mx-1"></i> 查看详细说明和示例
                        </p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="closeFirstTimeTip(false)" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors">
                            跳过
                        </button>
                        <button onclick="closeFirstTimeTip(true)" class="flex-1 py-2 px-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg text-sm font-medium hover:from-blue-600 hover:to-purple-700 transition-all">
                            了解一下
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(tipOverlay);
        }
        
        // 关闭首次使用提示
        function closeFirstTimeTip(showGuide = false) {
            const tipOverlay = document.getElementById('firstTimeTip');
            if (tipOverlay) {
                tipOverlay.remove();
            }
            
            // 标记用户已看过引导
            localStorage.setItem('hasSeenUnitGuide', 'true');
            
            if (showGuide) {
                // 显示多层级单位设置并打开帮助面板
                showUnitSettingCard();
                setTimeout(() => {
                    toggleUnitHelp();
                }, 500);
            }
        }
        
        // 切换操作演示
        function toggleOperationDemo() {
            const demoPanel = document.getElementById('operationDemo');
            const toggleText = document.getElementById('demoToggleText');
            const toggleIcon = document.getElementById('demoToggleIcon');
            
            if (demoPanel.classList.contains('hidden')) {
                demoPanel.classList.remove('hidden');
                toggleText.textContent = '收起演示';
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
                
                // 添加展开动画
                demoPanel.style.opacity = '0';
                demoPanel.style.transform = 'translateY(-10px)';
                
                requestAnimationFrame(() => {
                    demoPanel.style.transition = 'all 0.3s ease-out';
                    demoPanel.style.opacity = '1';
                    demoPanel.style.transform = 'translateY(0)';
                });
            } else {
                demoPanel.style.transition = 'all 0.3s ease-in';
                demoPanel.style.opacity = '0';
                demoPanel.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    demoPanel.classList.add('hidden');
                    toggleText.textContent = '展开演示';
                    toggleIcon.classList.remove('fa-chevron-up');
                    toggleIcon.classList.add('fa-chevron-down');
                }, 300);
            }
        }
        
        // 快速填充演示数据
        function quickFillDemo() {
            document.getElementById('materialName').value = '金龙鱼高筋面粉';
            document.getElementById('materialCategory').value = 'flour';
            document.getElementById('warehouse').value = 'raw_material';
            document.getElementById('specification').value = '25kg/袋';
            document.getElementById('barcode').value = '6901234567890';
            document.getElementById('canSell').checked = true;
            document.getElementById('currentStock').value = '100';
            document.getElementById('minStock').value = '20';

            
            showToast('演示数据填充完成！', 'success');
        }
    </script>
</body>
</html>