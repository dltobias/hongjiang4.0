<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åˆ†é… - çƒ˜åŒ  BakeManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Unified Theme */
        :root {
            --primary-orange: #ff9f43;
            --primary-dark: #ff8c00;
            --secondary-green: #28c76f;
            --secondary-blue: #00cfe8;
            --text-main: #333333;
            --text-sub: #8b8b8b;
            --bg-light: #f7f7f5;
            --bg-white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }

        /* Card & Layout */
        .card {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.03);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Border Left Colors for Order Cards */
        .border-left-blue { border-left: 4px solid #3b82f6; }
        .border-left-green { border-left: 4px solid #10b981; }
        .border-left-orange { border-left: 4px solid #f97316; }

        /* Input Styles */
        .alloc-input {
            border-bottom: 2px solid #e5e7eb;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            width: 60px;
            background: transparent;
            outline: none;
            transition: border-color 0.2s;
        }
        .alloc-input:focus {
            border-color: var(--primary-orange);
        }

        /* Animation */
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#f7f7f5] h-screen flex flex-col">

    <!-- Header -->
    <div class="bg-white px-4 py-3 shadow-sm border-b border-gray-100 z-30 flex-shrink-0">
        <div class="flex items-center space-x-3">
            <a href="peisong-zhuye.html" class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-all text-gray-600">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1 class="text-lg font-bold text-gray-800">å®Œå·¥æ™ºèƒ½åˆ†é…</h1>
        </div>
    </div>

    <!-- Content Area -->
    <div class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4 pb-24">
        
        <!-- Product Info Card -->
        <div class="card p-5 bg-gradient-to-br from-gray-900 to-gray-800 text-white animate-slide-up">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold mb-1">æ³•å¼ç‰›è§’åŒ…</h2>
                    <div class="text-xs text-gray-400">æ‰¹æ¬¡å·: BN231026-01</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-400 mb-1">å®é™…äº§é‡</div>
                    <div class="text-3xl font-bold text-orange-400" id="totalYieldDisplay">50</div>
                </div>
            </div>
            <div class="flex gap-4 text-xs text-gray-400 pt-3 border-t border-gray-700">
                <div class="flex items-center gap-1">
                    <i class="fas fa-calendar-day"></i> ç”Ÿäº§æ—¥æœŸ: 2023-10-26
                </div>
                <div class="flex items-center gap-1">
                    <i class="fas fa-box"></i> è§„æ ¼: 65g/ä¸ª
                </div>
            </div>
        </div>

        <!-- Order List Section -->
        <div>
            <h3 class="font-bold text-gray-800 text-sm mb-3 px-1 flex justify-between items-center">
                <span>ç›¸å…³è®¢å•éœ€æ±‚ (å…±3ä¸ª)</span>
                <button class="text-xs text-blue-600 font-medium" onclick="runAutoAllocate()">
                    <i class="fas fa-magic mr-1"></i> ä¸€é”®æ™ºèƒ½åˆ†é…
                </button>
            </h3>
            
            <div class="space-y-3" id="orderList">
                <!-- Order 1: Branch A -->
                <div class="card p-4 border-left-blue flex flex-col gap-3" data-id="1" data-type="branch" data-demand="30" data-deadline="2023-10-27 10:00">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm">A</div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">å¸‚ä¸­å¿ƒæ——èˆ°åº—</h4>
                                <span class="bg-blue-50 text-blue-600 text-[10px] px-1.5 py-0.5 rounded border border-blue-100">åˆ†åº—è®¢å•</span>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-orange-500 bg-orange-50 px-2 py-1 rounded">ğŸ”¥ æ˜å¤© 10:00</span>
                    </div>
                    
                    <div class="flex justify-between items-end bg-gray-50 p-3 rounded-lg">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">è®¢å•éœ€æ±‚</div>
                            <div class="font-bold text-gray-800">30 <span class="text-xs font-normal text-gray-400">ä¸ª</span></div>
                        </div>
                        <div class="text-right">
                            <label class="text-xs text-gray-500 mb-1 block">åˆ†é…æ•°é‡</label>
                            <div class="flex items-center gap-2 justify-end">
                                <input type="number" value="30" min="0" max="50" class="alloc-input text-gray-800" oninput="updateStats()">
                                <button class="text-xs bg-white border border-gray-200 px-2 py-1 rounded text-gray-500 hover:text-blue-600 hover:border-blue-200 transition-colors" onclick="fillMax(this)">å…¨éƒ¨</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order 2: Branch B -->
                <div class="card p-4 border-left-green flex flex-col gap-3" data-id="2" data-type="branch" data-demand="15" data-deadline="2023-10-27 14:00">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold text-sm">B</div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">ç§‘æŠ€å›­åˆ†åº—</h4>
                                <span class="bg-blue-50 text-blue-600 text-[10px] px-1.5 py-0.5 rounded border border-blue-100">åˆ†åº—è®¢å•</span>
                            </div>
                        </div>
                        <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded">æ˜å¤© 14:00</span>
                    </div>
                    
                    <div class="flex justify-between items-end bg-gray-50 p-3 rounded-lg">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">è®¢å•éœ€æ±‚</div>
                            <div class="font-bold text-gray-800">15 <span class="text-xs font-normal text-gray-400">ä¸ª</span></div>
                        </div>
                        <div class="text-right">
                            <label class="text-xs text-gray-500 mb-1 block">åˆ†é…æ•°é‡</label>
                            <div class="flex items-center gap-2 justify-end">
                                <input type="number" value="15" min="0" max="50" class="alloc-input text-gray-800" oninput="updateStats()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order 3: Local Store -->
                <div class="card p-4 border-left-orange flex flex-col gap-3" data-id="3" data-type="local" data-demand="5" data-deadline="9999-12-31">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center font-bold text-sm">ğŸ </div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">æœ¬åº—å‰å…è¡¥è´§</h4>
                                <span class="bg-orange-50 text-orange-600 text-[10px] px-1.5 py-0.5 rounded border border-orange-100">æœ¬åº—é”€å”®</span>
                            </div>
                        </div>
                        <span class="text-xs font-medium text-gray-400 bg-gray-100 px-2 py-1 rounded">çµæ´»å®‰æ’</span>
                    </div>
                    
                    <div class="flex justify-between items-end bg-gray-50 p-3 rounded-lg">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">å»ºè®®è¡¥è´§</div>
                            <div class="font-bold text-gray-800">5 <span class="text-xs font-normal text-gray-400">ä¸ª (å‰©ä½™)</span></div>
                        </div>
                        <div class="text-right">
                            <label class="text-xs text-gray-500 mb-1 block">åˆ†é…æ•°é‡</label>
                            <div class="flex items-center gap-2 justify-end">
                                <input type="number" value="5" min="0" max="50" class="alloc-input text-gray-800" oninput="updateStats()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Bar -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)] z-40">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-4 text-sm">
                <div class="text-center">
                    <div class="text-xs text-gray-400 mb-0.5">æ€»äº§é‡</div>
                    <div class="font-bold text-gray-800 text-lg" id="footerTotal">50</div>
                </div>
                <div class="w-px h-8 bg-gray-100"></div>
                <div class="text-center">
                    <div class="text-xs text-gray-400 mb-0.5">å·²åˆ†é…</div>
                    <div class="font-bold text-blue-600 text-lg" id="footerAllocated">50</div>
                </div>
                <div class="w-px h-8 bg-gray-100"></div>
                <div class="text-center">
                    <div class="text-xs text-gray-400 mb-0.5">å‰©ä½™</div>
                    <div class="font-bold text-orange-500 text-lg" id="footerRemaining">0</div>
                </div>
            </div>
            <button id="confirmBtn" class="w-full py-3.5 bg-gray-900 text-white rounded-xl font-bold text-sm shadow-lg active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed" onclick="confirmAllocation()">
                ç¡®è®¤åˆ†é…æ–¹æ¡ˆ
            </button>
        </div>
    </div>

    <script>
        const totalYield = 50;

        function updateStats() {
            let totalAllocated = 0;
            const inputs = document.querySelectorAll('.alloc-input');
            const confirmBtn = document.getElementById('confirmBtn');
            const remainingEl = document.getElementById('footerRemaining');
            const allocatedEl = document.getElementById('footerAllocated');

            inputs.forEach(input => {
                let val = parseInt(input.value) || 0;
                if (val < 0) val = 0;
                totalAllocated += val;
            });

            const remaining = totalYield - totalAllocated;

            // Update Footer UI
            allocatedEl.textContent = totalAllocated;
            remainingEl.textContent = remaining;

            // Visual Feedback
            if (remaining < 0) {
                remainingEl.classList.remove('text-orange-500', 'text-gray-400');
                remainingEl.classList.add('text-red-500');
                confirmBtn.disabled = true;
                confirmBtn.textContent = `è¶…å‡ºäº§é‡ ${Math.abs(remaining)} ä¸ªï¼Œè¯·è°ƒæ•´`;
                confirmBtn.classList.add('bg-red-500');
                confirmBtn.classList.remove('bg-gray-900');
            } else {
                remainingEl.classList.remove('text-red-500');
                remainingEl.classList.add(remaining > 0 ? 'text-orange-500' : 'text-gray-400');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ç¡®è®¤åˆ†é…æ–¹æ¡ˆ';
                confirmBtn.classList.remove('bg-red-500');
                confirmBtn.classList.add('bg-gray-900');
            }
        }

        function fillMax(btn) {
            const card = btn.closest('.card');
            const input = card.querySelector('.alloc-input');
            const demand = parseInt(card.getAttribute('data-demand')) || 0;
            
            // Calculate current available
            let currentAllocatedOthers = 0;
            document.querySelectorAll('.alloc-input').forEach(el => {
                if (el !== input) {
                    currentAllocatedOthers += parseInt(el.value) || 0;
                }
            });
            
            const maxAvailable = Math.max(0, totalYield - currentAllocatedOthers);
            // Cap at demand or available
            input.value = Math.min(demand, maxAvailable);
            updateStats();
        }

        function runAutoAllocate() {
            // Get all order cards
            const cards = Array.from(document.querySelectorAll('#orderList .card'));
            
            // Extract data
            let orders = cards.map(card => ({
                element: card,
                input: card.querySelector('.alloc-input'),
                type: card.getAttribute('data-type'),
                demand: parseInt(card.getAttribute('data-demand')),
                deadline: card.getAttribute('data-deadline'),
                id: card.getAttribute('data-id')
            }));

            // 1. Sort by Priority
            orders.sort((a, b) => {
                // Time comparison (string comparison works for ISO-like dates)
                if (a.deadline < b.deadline) return -1;
                if (a.deadline > b.deadline) return 1;
                // Type comparison: branch > local
                if (a.type === 'branch' && b.type === 'local') return -1;
                if (a.type === 'local' && b.type === 'branch') return 1;
                return 0;
            });

            // 2. Allocate Logic
            let remaining = totalYield;
            
            // Reset all first
            orders.forEach(o => o.input.value = 0);

            // First pass: Allocate to branches
            orders.forEach(order => {
                if (order.type === 'branch') {
                    const alloc = Math.min(order.demand, remaining);
                    order.input.value = alloc;
                    remaining -= alloc;
                }
            });

            // Second pass: Allocate remaining to local
            if (remaining > 0) {
                const localOrders = orders.filter(o => o.type === 'local');
                localOrders.forEach(order => {
                    const alloc = Math.min(order.demand + remaining, remaining); // Can over-allocate local if needed? Usually just remaining.
                    // The prompt logic: "Remaining allocated to local"
                    // But usually local demand is flexible. Let's just dump remaining to local.
                    // Or match demand first? Prompt says "Remaining -> Local".
                    // Let's assume local takes whatever is left.
                    order.input.value = remaining; 
                    remaining = 0;
                });
            }

            // Visual feedback
            updateStats();
            
            // Show toast or alert
            alert('å·²æŒ‰ä¼˜å…ˆçº§æ™ºèƒ½åˆ†é…ï¼\nä¼˜å…ˆæ»¡è¶³æ˜æ—¥ä¸Šåˆè®¢å•ã€‚');
        }

        function confirmAllocation() {
            const allocated = parseInt(document.getElementById('footerAllocated').textContent);
            if (allocated > totalYield) return;

            // Logic to simulate backend processing
            if (confirm('ç¡®è®¤ç”Ÿæˆé…é€å•åŠä¸Šæ¶å•ï¼Ÿ')) {
                alert('âœ… åˆ†é…æˆåŠŸï¼\n\nå·²è‡ªåŠ¨ç”Ÿæˆï¼š\nğŸ“¦ 2å¼ å‘è´§å• (å¾…é…é€)\nğŸ·ï¸ 1å¼ ä¸Šæ¶å• (å¾…ä¸Šæ¶)');
                window.location.href = 'shengchan-zhuye.html';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateStats();
        });
    </script>
</body>
</html>
