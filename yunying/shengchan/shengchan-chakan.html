<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>配方详情 (查看)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS Variables for Font Scaling */
        :root {
            --font-scale: 1;
            --base-font-size: 15px;
            --amount-font-size: 16px;
            --percent-font-size: 12px;
            --step-font-size: 14px;
        }

        /* Dynamic Font Sizing Rules */
        .ingredient-name, 
        .sop-card p,
        .sop-card .font-medium, 
        .sop-card .font-bold
        {
            font-size: calc(var(--base-font-size) * var(--text-font-scale, var(--font-scale))) !important;
            line-height: 1.5;
        }

        /* Group titles should scale but maintain hierarchy - scale factor slightly reduced or base increased */
        .group-title {
            font-size: calc(var(--base-font-size) * 1.2 * var(--text-font-scale, var(--font-scale))) !important; /* 20% larger than base */
            line-height: 1.5;
        }
        
        .amount-display,
        .ingredient-amount-col .amount-display,
        #baseDoughWeight, #additionalWeight,
        #variation1DoughWeight, #variation2DoughWeight, #variation3DoughWeight,
        #variation2ChocolateWeight, #variation3CranberryWeight, #variation3WalnutWeight
        {
            font-size: calc(var(--amount-font-size) * var(--number-font-scale, var(--font-scale))) !important;
            font-weight: normal !important;
        }
        
        .ingredient-percent {
            font-size: calc(var(--percent-font-size) * var(--number-font-scale, var(--font-scale))) !important;
        }

        /* Unit Text - Fixed Size, Does NOT Scale */
        .unit-text {
            font-size: 12px !important;
            font-weight: normal !important;
            margin-left: 2px;
            vertical-align: baseline;
            opacity: 0.7;
        }

        /* 基础样式调整 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px; /* Space for sticky footer */
        }

        /* 隐藏滚动条 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* 标签样式 */
        .tag-badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border-radius: 9999px; /* Pill shape */
            font-size: 13px;
            font-weight: 500;
            margin-right: 8px;
            transition: all 0.2s ease;
        }
        .tag-primary { background: #fff7ed; color: #ea580c; border: 1px solid rgba(234, 88, 12, 0.1); }
        .dark .tag-primary { background: rgba(234, 88, 12, 0.15); color: #fb923c; border: none; }
        .tag-gray { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }
        .dark .tag-gray { background: #334155; color: #cbd5e1; border: none; }

        /* Tab样式 */
        .tab-group {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 16px;
            margin-bottom: 24px;
        }
        .dark .tab-group { background: #1e293b; }
        
        .tab-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            border-radius: 12px;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid transparent;
        }
        .dark .tab-item { color: #94a3b8; }

        .tab-item.active {
            background: white;
            color: #ea580c; /* Orange-600 */
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border-color: rgba(0,0,0,0.02);
        }
        .dark .tab-item.active {
            background: #334155;
            color: #fb923c; /* Orange-400 */
        }
        
        .tab-item i { margin-right: 6px; font-size: 14px; }

        /* 材料列表样式 */
        .ingredient-group-card {
            background: white;
            border-radius: 16px;
            padding: 0;
            margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .dark .ingredient-group-card {
            background: #1e293b;
            border-color: #334155;
            box-shadow: none;
        }

        .group-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #ffffff !important;
            border-bottom: 1px solid #f1f5f9;
        }
        .dark .group-header {
            background: #0f172a !important;
            border-color: #334155;
        }

        .group-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 13px;
        }
        .group-title {
            font-weight: 600;
            font-size: 16px;
            color: #1e293b;
            letter-spacing: -0.01em;
        }
        .dark .group-title { color: #f1f5f9; }

        /* 分组颜色 - More pastel/refined */
        .group-flour .group-icon { background: #fff7ed; color: #c2410c; }
        .dark .group-flour .group-icon { background: rgba(154, 52, 18, 0.2); color: #fdba74; }
        
        .group-sponge .group-icon { background: #f0fdf4; color: #15803d; }
        .dark .group-sponge .group-icon { background: rgba(21, 128, 61, 0.2); color: #86efac; }
        
        .group-wet .group-icon { background: #eff6ff; color: #1d4ed8; }
        .dark .group-wet .group-icon { background: rgba(29, 78, 216, 0.2); color: #93c5fd; }
        
        .group-dry .group-icon { background: #f8fafc; color: #475569; }
        .dark .group-dry .group-icon { background: #334155; color: #cbd5e1; }
        
        .group-aux .group-icon { background: #fefce8; color: #a16207; }
        .dark .group-aux .group-icon { background: rgba(161, 98, 7, 0.2); color: #fde047; }

        /* 列表行样式 */
        .list-row {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #f8fafc;
            transition: background-color 0.2s;
        }
        .dark .list-row { border-bottom-color: #334155; }
        .list-row:last-child { border-bottom: none; }
        .list-row:hover { background-color: #f8fafc; }
        .dark .list-row:hover { background-color: #334155; }

        /* 模拟复选框 */
        .fake-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-right: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dark .fake-checkbox { border-color: #4b5563; }
        
        .ingredient-item.checked .fake-checkbox {
            background-color: #f97316;
            border-color: #f97316;
            transform: scale(1.05);
        }
        .ingredient-item.checked .fake-checkbox i {
            display: block;
            color: white;
            font-size: 12px;
        }
        .fake-checkbox i { display: none; }

        .ingredient-name {
            font-weight: 500;
            color: #334151;
            font-size: 15px;
        }
        .dark .ingredient-name { color: #e2e8f0; }
        
        .ingredient-item.checked .ingredient-name {
            color: #94a3b8;
        }

        .ingredient-amount-col { text-align: right; }
        .ingredient-percent { font-size: 12px; color: #9ca3af; margin-top: 2px; }

        /* Status text style - Visible on check */
        .ingredient-status-text {
            display: none; /* Default hidden */
            font-size: 12px;
            color: #16a34a; /* Green-600 */
            margin-left: 8px; /* Corrected to margin-left */
            font-weight: 500;
            background: #dcfce7;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .ingredient-item.checked .ingredient-status-text {
            display: inline-block !important; /* Force visible when checked */
        }
        
        /* Gray out the whole row when checked */
        .ingredient-item.checked {
            background-color: #f3f4f6; /* Gray-100 */
            opacity: 0.7;
        }
        .dark .ingredient-item.checked {
            background-color: #334155; /* Slate-700 */
            opacity: 0.6;
        }
        
        /* Adjust layout for checked state */
        .ingredient-item.checked .ingredient-name,
        .ingredient-item.checked .amount-display {
            color: #94a3b8 !important;
        }

        /* SOP & Steps 样式 - Refined to match new card style */
        .sop-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            margin-bottom: 12px;
            transition: transform 0.2s ease;
        }
        .dark .sop-card {
            background: #1e293b;
            border-color: #334155;
            box-shadow: none;
        }
        .sop-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .sop-icon {
            width: 32px;
            height: 32px;
            background: #fff7ed;
            color: #ea580c;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        .dark .sop-icon {
            background: rgba(234, 88, 12, 0.15);
            color: #fb923c;
        }
        .sop-item-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #f0f0f0;
            font-size: 14px;
        }
        .dark .sop-item-row {
            border-bottom-color: #334155;
        }
        .sop-item-row:last-child { border-bottom: none; }

        .step-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            transition: all 0.3s ease;
            margin-top: 12px;
        }
        .step-images.expanded { 
            grid-template-columns: 1fr; 
        }
        .step-images.expanded img {
            aspect-ratio: 16/9;
            width: 100%;
            height: auto;
        }
        .step-images img {
            border-radius: 8px;
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        /* 动画类 */
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* 强制刷新暗黑模式 */
        .dark-force-refresh {}
    </style>
</head>
<body class="bg-[#f7f7f5] dark:bg-[#0f172a] min-h-screen">

    <!-- 沉浸式头部 -->
    <header class="relative w-full h-72 bg-gray-200">
        <!-- 封面图 -->
        <img src="https://images.unsplash.com/photo-1549931319-a545dcf3bc73?w=1200&h=800&fit=crop&q=90" 
             id="heroImage" 
             class="w-full h-full object-cover transition-transform duration-700 ease-out">
        <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-black/60"></div>

        <!-- 返回按钮 -->
        <button onclick="window.history.back()" class="absolute top-4 left-4 w-10 h-10 bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black/50 transition-colors z-20">
            <i class="fas fa-arrow-left"></i>
        </button>

        <!-- 右上角操作区 -->
        <div class="absolute top-4 right-4 flex space-x-3 z-20">
            <button onclick="toggleMoreMenu()" class="w-10 h-10 bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black/50 transition-colors">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>

        <!-- 更多菜单下拉 (保持原有结构) -->
        <div id="moreMenuDropdown" class="absolute right-4 top-16 bg-white dark:bg-[#334155] rounded-xl shadow-2xl border border-slate-200 dark:border-slate-600 p-2 z-30 hidden min-w-[160px]">
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="togglePercentages()">
                <i class="fas fa-percentage mr-3 text-purple-600 dark:text-purple-400"></i><span id="percentageButtonText">查看百分比</span>
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="printRecipe()">
                <i class="fas fa-print mr-3 text-purple-600 dark:text-purple-400"></i>打印配方
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="showFontSizeModal()">
                <i class="fas fa-text-height mr-3 text-purple-600 dark:text-purple-400"></i>调整字体
            </button>
        </div>
    </header>

    <!-- 主要内容区 (重叠式设计) -->
    <main class="px-5 -mt-6 relative bg-white dark:bg-[#0f172a] rounded-t-3xl z-10 pt-6 min-h-[calc(100vh-280px)]">
        
        <!-- 标题与信息 -->
        <div class="mb-6">
            <div class="flex items-center justify-between mb-3">
                <h1 class="text-2xl font-bold tracking-tight text-gray-900 dark:text-white leading-tight cursor-pointer flex items-center gap-2" onclick="toggleRecipeInfo()">
                    经典白吐司
                    <i id="infoToggleIcon" class="fas fa-chevron-right text-sm text-gray-400 dark:text-gray-500 transition-transform duration-300"></i>
                </h1>
                
                <!-- Action Buttons Removed for View Mode -->
                <div class="flex items-center gap-2 hidden">
                    <!-- Buttons were here -->
                </div>
            </div>


            <!-- Target Weight Adjustment (Removed as per user request) -->
            <!-- Collapsible Info Container (Default Hidden) -->
            <div id="recipeInfoContainer" class="hidden overflow-hidden transition-all duration-300 origin-top">
                <div class="flex flex-wrap gap-2 mb-4 animate-fadeIn">
                    <span class="tag-badge tag-primary" onclick="showCategoryInfo(event)">面包类</span>
                    <span class="tag-badge tag-gray"><i class="far fa-clock mr-1"></i> <span id="dynamicTimeDisplay">4小时</span></span>
                    <span class="tag-badge tag-gray"><i class="fas fa-fire mr-1"></i> <span id="dynamicCalorieDisplay">280千卡</span></span>
                </div>
                <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed animate-fadeIn">经典白吐司，组织细腻，奶香浓郁，适合作为早餐主食。</p>
            </div>
        </div>

        <!-- Split Progress Status Card (Hidden by default) -->
        <div id="splitStatusCard" class="hidden bg-orange-50 dark:bg-orange-900/20 rounded-xl p-4 mb-6 border border-orange-100 dark:border-orange-900/30 animate-fadeIn">
            <!-- Content kept for potential view of status -->
             <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-bold text-orange-800 dark:text-orange-400 flex items-center">
                    <i class="fas fa-chart-pie mr-2"></i>分批生产进度
                </span>
                <span class="text-xs text-orange-600 dark:text-orange-400 bg-orange-100 dark:bg-orange-800/40 px-2 py-1 rounded-lg">
                    剩余待产: <span id="displayRemainingWeight" class="font-bold">0</span>g
                </span>
            </div>
            <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mb-2">
                <span>原计划: <span id="displayOriginalWeight">0</span>g</span>
                <span class="flex-1 border-b border-dashed border-orange-200 dark:border-orange-800 mx-2"></span>
                <span>本批次: <span id="displayCurrentBatchWeight" class="font-bold text-orange-600 dark:text-orange-400">0</span>g</span>
            </div>
            <!-- Progress Bar -->
            <div class="w-full bg-orange-100 dark:bg-orange-900/40 rounded-full h-2 overflow-hidden">
                <div id="splitProgressBar" class="bg-orange-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- 标签切换 -->
        <div class="tab-group" id="tabGroup">
            <div class="tab-item active" id="tab-btn-recipe" onclick="switchTab('recipe')">
                <i class="fas fa-bread-slice"></i> 配方
            </div>
            <div class="tab-item" id="tab-btn-sop" onclick="switchTab('sop')">
                <i class="fas fa-clipboard-list"></i> SOP
            </div>
            <div class="tab-item" id="tab-btn-step" onclick="switchTab('step')">
                <i class="fas fa-list-ol"></i> 步骤
            </div>
        </div>

        <!-- 配方内容区 -->
        <div id="recipe-section" class="pb-20">
            <!-- 面粉分组 -->
            <div class="ingredient-group-card group-flour">
                <div class="group-header">
                    <div class="group-icon"><i class="fas fa-wheat-awn"></i></div>
                    <div class="group-title">面粉</div>
                </div>
                <div class="space-y-0">
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">高筋面粉</div>
                            <div class="ingredient-status-text">已入料</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="500">500<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">100%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 种面分组 -->
            <div class="ingredient-group-card group-sponge">
                <div class="group-header">
                    <div class="group-icon"><i class="fas fa-seedling"></i></div>
                    <div class="group-title">种面</div>
                </div>
                <div class="space-y-0">
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">自制种面</div>
                            <div class="ingredient-status-text">已入料</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="120">120<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">24%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 干料分组 -->
            <div class="ingredient-group-card group-dry">
                <div class="group-header">
                    <div class="group-icon"><i class="fas fa-cube"></i></div>
                    <div class="group-title">干料</div>
                </div>
                <div class="space-y-0">
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">白砂糖</div>
                            <div class="ingredient-status-text">已入料</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="50">50<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">10%</div>
                        </div>
                    </div>
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">盐</div>
                            <div class="ingredient-status-text">已入料</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="8">8<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">1.6%</div>
                        </div>
                    </div>
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">干酵母</div>
                            <div class="ingredient-status-text">已入料</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="5">5<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">1%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 湿料分组 -->
            <div class="ingredient-group-card group-wet">
                <div class="group-header">
                    <div class="group-icon"><i class="fas fa-droplet"></i></div>
                    <div class="group-title">湿料</div>
                </div>
                <div class="space-y-0">
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">牛奶</div>
                            <div class="ingredient-status-text">已入料</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="300">300<span class="unit-text">ml</span></div>
                            <div class="ingredient-percent percentage-text">60%</div>
                        </div>
                    </div>
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">鸡蛋</div>
                            <div class="ingredient-status-text">已入料</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="50">50<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">10%</div>
                        </div>
                    </div>
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">糖浆配方</div>
                            <div class="ingredient-status-text">已入料</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="80">80<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">16%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 辅料分组 -->
            <div class="ingredient-group-card group-aux">
                <div class="group-header">
                    <div class="group-icon"><i class="fas fa-mortar-pestle"></i></div>
                    <div class="group-title">辅料</div>
                </div>
                <div class="space-y-0">
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">黄油</div>
                            <div class="ingredient-status-text">已入料</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="30">30<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">6%</div>
                        </div>
                    </div>
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">芝麻</div>
                            <div class="ingredient-status-text">已入料</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="10">10<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">2%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 基础面团 (Custom Card) -->
            <div id="card-base" class="ingredient-group-card border-l-4 border-l-orange-500">
                <div class="group-header justify-between">
                    <div class="flex items-center">
                        <div class="group-icon bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400"><i class="fas fa-bread-slice"></i></div>
                        <div class="group-title">基础面团</div>
                    </div>
                    <div id="baseCardControls" class="flex items-center gap-2 hidden">
                        <!-- Controls hidden for view mode -->
                    </div>
                </div>
                <div class="space-y-0">
                    <div class="list-row">
                        <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">基础面团</span>
                        <div class="text-right">
                            <div class="amount-display text-gray-900 dark:text-white" id="baseDoughWeight">943<span class="unit-text">g</span></div>
                            <div class="text-xs text-gray-400">成本: ￥<span id="baseDoughCost">4.20</span></div>
                        </div>
                    </div>
                    <div class="list-row">
                        <span class="flex-1 font-medium text-gray-700 dark:text-gray-300 flex items-center">
                            酥菠萝皮
                        </span>
                        <div class="text-right">
                            <div class="amount-display text-gray-900 dark:text-white" id="additionalWeight">150<span class="unit-text">g</span></div>
                            <div class="text-xs text-gray-400">成本: ￥<span id="additionalCost">2.80</span></div>
                        </div>
                    </div>
                    <!-- Unified Footer -->
                    <div class="p-4 bg-gray-50 dark:bg-slate-800/50 flex justify-between items-center border-t border-gray-100 dark:border-slate-700">
                        <div>
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">总成本</div>
                            <div class="flex items-baseline gap-1">
                                 <span class="text-xl font-bold text-orange-600 dark:text-orange-400 leading-none" id="baseTotalCost">7.00</span>
                                 <span class="text-xs text-orange-600 dark:text-orange-400 font-medium">¥</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">总重量</div>
                            <div class="text-lg font-bold text-gray-700 dark:text-gray-200"><span id="baseTotalWeight">1090</span><span class="text-xs font-normal ml-0.5 text-gray-400">g</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 变化款1 -->
            <div id="card-var1" class="ingredient-group-card border-l-4 border-l-orange-500">
                <div class="group-header justify-between">
                    <div class="flex items-center">
                        <div class="group-title text-gray-900 dark:text-white">经典白吐司砖</div>
                    </div>
                    <div class="flex items-center gap-2 hidden">
                        <!-- Controls hidden -->
                    </div>
                </div>
                <div class="space-y-0">
                    <div class="list-row">
                        <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">基础面团</span>
                        <div class="text-right">
                            <div class="amount-display text-gray-900 dark:text-white" id="variation1DoughWeight">500<span class="unit-text">g</span></div>
                            <div class="text-xs text-gray-400">成本: ￥<span id="variation1DoughCost">2.22</span></div>
                        </div>
                    </div>
                    <!-- Unified Footer -->
                    <div class="p-4 bg-gray-50 dark:bg-slate-800/50 flex justify-between items-center border-t border-gray-100 dark:border-slate-700">
                        <div>
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">总成本</div>
                            <div class="flex items-baseline gap-1">
                                 <span class="text-xl font-bold text-orange-600 dark:text-orange-400 leading-none" id="variation1TotalCost">4.44</span>
                                 <span class="text-xs text-orange-600 dark:text-orange-400 font-medium">¥</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">总重量</div>
                            <div class="text-lg font-bold text-gray-700 dark:text-gray-200"><span id="variation1TotalWeight">1000</span><span class="text-xs font-normal ml-0.5 text-gray-400">g</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 变化款2 -->
            <div id="card-var2" class="ingredient-group-card border-l-4 border-l-orange-500">
                <div class="group-header justify-between">
                    <div class="flex items-center">
                        <div class="group-title text-gray-900 dark:text-white">巧克力吐司</div>
                    </div>
                    <div class="flex items-center gap-2 hidden">
                         <!-- Controls hidden -->
                    </div>
                </div>
                <div class="space-y-0">
                    <div class="list-row">
                        <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">基础面团</span>
                        <div class="text-right">
                            <div class="amount-display text-gray-900 dark:text-white" id="variation2DoughWeight">350<span class="unit-text">g</span></div>
                            <div class="text-xs text-gray-400">成本: ￥<span id="variation2DoughCost">1.55</span></div>
                        </div>
                    </div>
                    <div class="list-row">
                        <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">巧克力粒</span>
                        <div class="text-right">
                            <div class="amount-display text-gray-900 dark:text-white" id="variation2ChocolateWeight">50<span class="unit-text">g</span></div>
                            <div class="text-xs text-gray-400">成本: ￥<span id="variation2ChocolateCost">1.20</span></div>
                        </div>
                    </div>
                    <!-- Unified Footer -->
                    <div class="p-4 bg-gray-50 dark:bg-slate-800/50 flex justify-between items-center border-t border-gray-100 dark:border-slate-700">
                        <div>
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">总成本</div>
                            <div class="flex items-baseline gap-1">
                                 <span class="text-xl font-bold text-orange-600 dark:text-orange-400 leading-none" id="variation2TotalCost">8.25</span>
                                 <span class="text-xs text-orange-600 dark:text-orange-400 font-medium">¥</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">总重量</div>
                            <div class="text-lg font-bold text-gray-700 dark:text-gray-200"><span id="variation2TotalWeight">1200</span><span class="text-xs font-normal ml-0.5 text-gray-400">g</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 变化款3 -->
            <div id="card-var3" class="ingredient-group-card border-l-4 border-l-orange-500">
                <div class="group-header justify-between">
                    <div class="flex items-center">
                        <div class="group-title text-gray-900 dark:text-white">蔓越莓吐司</div>
                    </div>
                    <div class="flex items-center gap-2 hidden">
                         <!-- Controls hidden -->
                    </div>
                </div>
                <div class="space-y-0">
                    <div class="list-row">
                        <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">基础面团</span>
                        <div class="text-right">
                            <div class="amount-display text-gray-900 dark:text-white" id="variation3DoughWeight">480<span class="unit-text">g</span></div>
                            <div class="text-xs text-gray-400">成本: ￥<span id="variation3DoughCost">2.13</span></div>
                        </div>
                    </div>
                    <div class="list-row">
                        <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">蔓越莓干</span>
                        <div class="text-right">
                            <div class="amount-display text-gray-900 dark:text-white" id="variation3CranberryWeight">80<span class="unit-text">g</span></div>
                            <div class="text-xs text-gray-400">成本: ￥<span id="variation3CranberryCost">3.60</span></div>
                        </div>
                    </div>
                    <div class="list-row">
                        <span class="flex-1 font-medium text-gray-700 dark:text-gray-300 flex items-center">
                            核桃配方
                        </span>
                        <div class="text-right">
                            <div class="amount-display text-gray-900 dark:text-white" id="variation3WalnutWeight">40<span class="unit-text">g</span></div>
                            <div class="text-xs text-gray-400">成本: ￥<span id="variation3WalnutCost">2.40</span></div>
                        </div>
                    </div>
                    <!-- Unified Footer -->
                    <div class="p-4 bg-gray-50 dark:bg-slate-800/50 flex justify-between items-center border-t border-gray-100 dark:border-slate-700">
                        <div>
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">总成本</div>
                            <div class="flex items-baseline gap-1">
                                 <span class="text-xl font-bold text-orange-600 dark:text-orange-400 leading-none" id="variation3TotalCost">8.13</span>
                                 <span class="text-xs text-orange-600 dark:text-orange-400 font-medium">¥</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">总重量</div>
                            <div class="text-lg font-bold text-gray-700 dark:text-gray-200"><span id="variation3TotalWeight">600</span><span class="text-xs font-normal ml-0.5 text-gray-400">g</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SOP Section -->
        <div id="sop-section" class="hidden pb-20">
             <!-- SOP Content Same as before -->
             <div class="space-y-4">
                 <div class="sop-card"><div class="sop-header"><div class="sop-icon"><i class="fas fa-cog"></i></div><span class="font-bold text-gray-800 dark:text-white">和面标准</span></div><div class="space-y-1"><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">水温</span><span class="font-medium text-gray-900 dark:text-white">4-6℃</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">初始慢速</span><span class="font-medium text-gray-900 dark:text-white">3-5分钟</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">中速揉面</span><span class="font-medium text-gray-900 dark:text-white">5-8分钟</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">出面温度</span><span class="font-medium text-gray-900 dark:text-white">24-26℃</span></div></div></div>
                 <div class="sop-card"><div class="sop-header"><div class="sop-icon"><i class="fas fa-hand-holding"></i></div><span class="font-bold text-gray-800 dark:text-white">成型标准</span></div><div class="space-y-1"><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">分割重量</span><span class="font-medium text-gray-900 dark:text-white">60g/个</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">松弛时间</span><span class="font-medium text-gray-900 dark:text-white">15-20分钟</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">预整形</span><span class="font-medium text-gray-900 dark:text-white">滚圆</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">包馅</span><span class="font-medium text-gray-900 dark:text-white">20g/个</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">最终成型</span><span class="font-medium text-gray-900 dark:text-white">橄榄形</span></div></div></div>
                 <div class="sop-card"><div class="sop-header"><div class="sop-icon"><i class="fas fa-seedling"></i></div><span class="font-bold text-gray-800 dark:text-white">发酵标准</span></div><div class="space-y-1"><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">温度</span><span class="font-medium text-gray-900 dark:text-white">28-30℃</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">湿度</span><span class="font-medium text-gray-900 dark:text-white">75-80%</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">时间</span><span class="font-medium text-gray-900 dark:text-white">60-90分钟</span></div></div></div>
                 <div class="sop-card"><div class="sop-header"><div class="sop-icon"><i class="fas fa-fire"></i></div><span class="font-bold text-gray-800 dark:text-white">烤制标准</span></div><div class="space-y-1"><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">预热温度</span><span class="font-medium text-gray-900 dark:text-white">200℃</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">上火温度</span><span class="font-medium text-gray-900 dark:text-white">210℃</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">下火温度</span><span class="font-medium text-gray-900 dark:text-white">190℃</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">开关风门</span><span class="font-medium text-gray-900 dark:text-white">关闭</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">烤制时间</span><span class="font-medium text-gray-900 dark:text-white">35-40分钟</span></div></div></div>
                 <div class="sop-card"><div class="sop-header"><div class="sop-icon"><i class="fas fa-magic"></i></div><span class="font-bold text-gray-800 dark:text-white">烤后装饰</span></div><div class="space-y-1"><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">表面处理</span><span class="font-medium text-gray-900 dark:text-white">刷黄油</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">保湿</span><span class="font-medium text-gray-900 dark:text-white">喷水</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">装饰</span><span class="font-medium text-gray-900 dark:text-white">撒糖粉</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">冷却</span><span class="font-medium text-gray-900 dark:text-white">网架晾凉</span></div></div></div>
                 <div class="sop-card"><div class="sop-header"><div class="sop-icon"><i class="fas fa-utensils"></i></div><span class="font-bold text-gray-800 dark:text-white">二次加工</span></div><div class="space-y-1"><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">去皮</span><span class="font-medium text-gray-900 dark:text-white">切除四边</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">夹馅</span><span class="font-medium text-gray-900 dark:text-white">涂抹果酱</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">注馅</span><span class="font-medium text-gray-900 dark:text-white">注入奶油</span></div></div></div>
                 <div class="sop-card"><div class="sop-header"><div class="fas fa-box-open"></div><span class="font-bold text-gray-800 dark:text-white">包装标准</span></div><div class="space-y-1"><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">袋子尺寸</span><span class="font-medium text-gray-900 dark:text-white">15x20cm</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">包装方式</span><span class="font-medium text-gray-900 dark:text-white">真空包装</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">保鲜气体</span><span class="font-medium text-gray-900 dark:text-white">充氮气</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">保鲜剂</span><span class="font-medium text-gray-900 dark:text-white">脱氧剂</span></div><div class="sop-item-row"><span class="text-gray-500 dark:text-gray-400">装箱规格</span><span class="font-medium text-gray-900 dark:text-white">20袋/箱</span></div></div></div>
             </div>
        </div>

        <!-- Step Section (Abbreviated for brevity but structurally present) -->
        <div id="step-section" class="hidden pb-20">
             <div class="space-y-4">
                 <div class="sop-card">
                     <div class="flex items-center justify-between mb-3"><h3 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2"><div class="w-8 h-8 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-lg flex items-center justify-center text-sm font-bold">1</div>和面</h3></div>
                     <div class="step-content"><p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-3">将面粉、糖、盐放入搅拌缸，加入牛奶和鸡蛋，搅拌至无干粉。</p></div>
                 </div>
                 <!-- Other steps omitted for brevity -->
             </div>
        </div>

    </main>

    <!-- 底部统计条 (Sticky) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md dark:bg-[#1e293b]/90 border-t border-gray-100 dark:border-slate-700 p-4 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)]">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-100 to-orange-50 dark:from-orange-900/30 dark:to-orange-800/20 text-orange-500 flex items-center justify-center shadow-sm">
                    <i class="fas fa-coins text-xl"></i>
                </div>
                <div>
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-0.5">预估成本</div>
                    <div class="flex items-baseline gap-0.5">
                        <span class="amount-display text-2xl font-bold text-orange-600 dark:text-orange-400 leading-none" id="totalCost">11.44</span>
                        <span class="text-sm font-medium text-orange-600 dark:text-orange-400">¥</span>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-0.5">总重量</div>
                <div class="amount-display text-xl text-gray-900 dark:text-white font-medium" id="overallTotalWeight">2090<span class="unit-text text-sm text-gray-500 ml-1">g</span></div>
            </div>
        </div>
    </div>

    <!-- Font Size Adjustment Modal (Kept) -->
    <div id="fontSizeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 hidden transition-opacity duration-300" onclick="if(event.target === this) closeFontSizeModal()">
        <div class="bg-white dark:bg-[#1E293B] w-full sm:w-[400px] sm:rounded-2xl rounded-t-2xl p-6 shadow-2xl transform transition-transform duration-300 translate-y-full sm:translate-y-0" id="fontSizeModalContent">
            <!-- Content same as original -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">调整字体大小</h3>
                <button onclick="closeFontSizeModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-700 flex items-center justify-center text-gray-500 hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <!-- Sliders and buttons -->
            <div class="mb-6">
                <div class="flex justify-between items-end mb-3 px-2">
                    <span class="text-sm font-bold text-gray-700 dark:text-gray-300">文字大小</span>
                    <span class="text-sm font-bold text-orange-600 dark:text-orange-400" id="currentTextSizeLabel">标准</span>
                </div>
                <input type="range" min="1" max="6" value="1" step="1" id="textSizeSlider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500 dark:bg-gray-700" oninput="previewTextSize(this.value)">
            </div>
            <div class="mb-8">
                <div class="flex justify-between items-end mb-3 px-2">
                    <span class="text-sm font-bold text-gray-700 dark:text-gray-300">数字大小</span>
                    <span class="text-sm font-bold text-orange-600 dark:text-orange-400" id="currentNumberSizeLabel">标准</span>
                </div>
                <input type="range" min="1" max="6" value="1" step="1" id="numberSizeSlider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500 dark:bg-gray-700" oninput="previewNumberSize(this.value)">
            </div>
            <button onclick="saveFontSize()" class="w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-bold shadow-lg shadow-orange-200 dark:shadow-none hover:from-orange-600 hover:to-orange-700 transition-all">确认调整</button>
        </div>
    </div>

    <!-- Original JS Scripts -->
    <script>
        // Check mode from URL (View Mode vs Execution Mode)
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            // Default to 'completed' record view mode for demonstration purposes
            // unless explicitly told otherwise (e.g. status=normal)
            // Or just force it if no status is present, to meet user request "show it directly"
            let status = urlParams.get('status');
            if (!status) {
                status = 'completed'; // Force completed view by default
            }
            
            const isRecordView = status === 'completed'; // If completed, we show the record
            
            if (isRecordView) {
                document.title = '生产记录详情';
                
                // Add "Historical Record" Banner
                const banner = document.createElement('div');
                banner.className = 'bg-blue-50 border-b border-blue-100 text-blue-800 px-4 py-3 text-center text-sm font-bold sticky top-0 z-[60] flex items-center justify-center gap-2';
                banner.innerHTML = '<i class="fas fa-history"></i> 历史生产记录 (只读)';
                document.body.prepend(banner);
                
                // Adjust header top position
                const header = document.querySelector('header');
                if(header) header.classList.remove('top-0');

                // Try to load from LocalStorage OR use Simulation Data if missing
                const savedRecord = localStorage.getItem('production_record_last');
                let checkedIngredientsSet = null;
                
                if (savedRecord) {
                    try {
                        const record = JSON.parse(savedRecord);
                        if (record && record.checkedIngredients) {
                             checkedIngredientsSet = new Set(record.checkedIngredients);
                             console.log('Loaded record:', record);
                        }
                    } catch (e) {
                        console.error('Failed to parse record', e);
                    }
                } else {
                    // Simulation Data for Demo (User Request: Show directly)
                    // Simulate that 'Salt' and 'Sugar' were missed
                    console.log('No saved record found, using simulation data.');
                    // Create a set that includes most items but excludes a few for demo
                    checkedIngredientsSet = new Set([
                        '高筋面粉', '自制种面', '干酵母', // Dry - missed sugar, salt
                        '牛奶', '鸡蛋', '糖浆配方', // Wet
                        '黄油', '芝麻' // Aux
                        // Variations omitted or assumed checked if not listed? 
                        // The logic below checks exact name match.
                    ]);
                }

                const items = document.querySelectorAll('.ingredient-item');
                let checkedCount = 0;
                const totalItems = items.length;
                const missingItemNames = [];

                items.forEach((item, index) => {
                    // Disable click
                    item.onclick = null;
                    item.style.cursor = 'default';
                    
                    const name = item.querySelector('.ingredient-name')?.textContent.trim() || '';
                    let isChecked = false;
                    
                    if (checkedIngredientsSet) {
                         // Use saved/simulated data
                         isChecked = checkedIngredientsSet.has(name);
                    } else {
                         // Fallback logic if set is somehow null (should not happen with above logic)
                         const isMissed = name.includes('芝麻'); 
                         isChecked = !isMissed;
                    }
                    
                    if (isChecked) {
                        item.classList.add('checked');
                    } else {
                        item.classList.remove('checked');
                        missingItemNames.push(name);
                    }

                    
                    if (isChecked) {
                        // GREEN: Confirmed Added
                        const statusText = item.querySelector('.ingredient-status-text');
                        if (statusText) {
                            statusText.textContent = '已入料';
                            statusText.className = 'ingredient-status-text text-green-600 bg-green-100 px-2 py-0.5 rounded text-xs ml-2 inline-block';
                            statusText.style.display = 'inline-block';
                        }
                        // Add green tint row
                        item.classList.add('bg-green-50/50', 'dark:bg-green-900/10');
                        // Add Check Icon to checkbox
                        const cb = item.querySelector('.fake-checkbox');
                        if(cb) {
                            cb.classList.add('bg-green-500', 'border-green-500');
                            cb.innerHTML = '<i class="fas fa-check text-white text-xs"></i>';
                        }
                        checkedCount++;
                    } else {
                        // RED: Missed Operation
                        // This fulfills "Manager can see if they clicked"
                        const statusText = item.querySelector('.ingredient-status-text');
                        // If status text element exists, reuse it, otherwise append
                        if (statusText) {
                            statusText.textContent = '未操作';
                            statusText.className = 'ingredient-status-text text-red-600 bg-red-100 px-2 py-0.5 rounded text-xs ml-2 inline-block font-bold';
                            statusText.style.display = 'inline-block';
                        } else {
                            const nameContainer = item.querySelector('.flex-1.flex.items-center');
                            if (nameContainer) {
                                const badge = document.createElement('span');
                                badge.className = 'text-red-600 bg-red-100 px-2 py-0.5 rounded text-xs ml-2 inline-block font-bold';
                                badge.textContent = '未操作';
                                nameContainer.appendChild(badge);
                            }
                        }
                        
                        // Red tint row
                        item.classList.add('bg-red-50', 'dark:bg-red-900/20');
                        item.classList.add('border-l-4', 'border-red-500'); // Add prominent border
                        
                        // Warning Icon in checkbox
                        const cb = item.querySelector('.fake-checkbox');
                        if(cb) {
                            cb.classList.add('border-red-300', 'bg-red-50');
                            cb.innerHTML = '<i class="fas fa-exclamation text-red-500 text-xs"></i>';
                        }
                    }
                });

                // Add Summary Banner (Assessment of Rigor)
                const mainContent = document.querySelector('main');
                const summaryBanner = document.createElement('div');
                const isPerfect = checkedCount === totalItems;
                
                const bannerColor = isPerfect ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-50 text-red-800 border-red-200';
                const icon = isPerfect ? 'fa-check-circle' : 'fa-exclamation-triangle';
                const titleText = isPerfect ? '操作评级：优秀' : '操作评级：存在疏漏';
                
                let descText = '';
                if (isPerfect) {
                    descText = '操作严谨：师傅已确认所有原料入料，符合SOP规范。';
                } else {
                    descText = `
                        <div class="mb-2">操作预警：发现 <strong>${totalItems - checkedCount}</strong> 项原料未点击确认。</div>
                        <div class="bg-white/50 p-2 rounded text-xs border border-red-100">
                            <div class="font-bold mb-1">未确认入料清单：</div>
                            <ul class="list-disc list-inside text-red-700">
                                ${missingItemNames.map(n => `<li>${n}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                summaryBanner.className = `mx-0 mb-6 p-4 rounded-xl border flex items-start gap-3 shadow-sm ${bannerColor}`;
                summaryBanner.innerHTML = `
                    <div class="mt-0.5"><i class="fas ${icon} text-xl"></i></div>
                    <div class="flex-1">
                        <div class="font-bold text-base mb-1">${titleText}</div>
                        <div class="text-sm opacity-90 leading-relaxed">${descText}</div>
                    </div>
                `;
                
                // Insert after header
                // Find where to insert. Main content starts with title.
                // Let's insert before the title container.
                const titleContainer = document.querySelector('.mb-6');
                if(titleContainer) {
                    titleContainer.parentNode.insertBefore(summaryBanner, titleContainer);
                }
            } else {
                // Standard View Mode (Reference Only)
                // Keep it clean, no status
                document.title = '配方详情 (标准)';
                const items = document.querySelectorAll('.ingredient-item');
                items.forEach(item => {
                    item.onclick = null;
                    item.style.cursor = 'default';
                });
            }
        });

        // --- UI Helper Functions (Toast & Modal) ---
        // (Simplified or kept same)
        function showToast(message, type = 'success') { /* ... */ }
        function showDialog(options) { /* ... */ }
        function closeDialog() { /* ... */ }
        function toggleMoreMenu() { document.getElementById('moreMenuDropdown').classList.toggle('hidden'); }
        function togglePercentages() {
            const showPercentages = document.getElementById('percentageButtonText').textContent === '查看百分比';
            const btnText = document.getElementById('percentageButtonText');
            document.querySelectorAll('.percentage-text').forEach(el => {
                el.style.display = showPercentages ? 'block' : 'none';
            });
            btnText.textContent = showPercentages ? '隐藏百分比' : '查看百分比';
            toggleMoreMenu();
        }

        // Font Size Logic
        function showFontSizeModal() {
             document.getElementById('fontSizeModal').classList.remove('hidden');
             setTimeout(() => document.getElementById('fontSizeModalContent').classList.remove('translate-y-full'), 10);
        }
        function closeFontSizeModal() {
             document.getElementById('fontSizeModalContent').classList.add('translate-y-full');
             setTimeout(() => document.getElementById('fontSizeModal').classList.add('hidden'), 300);
        }
        function saveFontSize() { closeFontSizeModal(); } // simplified
        function previewTextSize(level) {
            document.getElementById('currentTextSizeLabel').textContent = ['标准','中','大','加大','特大'][level-1]||'标准';
            document.documentElement.style.setProperty('--text-font-scale', 1 + (level-1)*0.1);
        }
        function previewNumberSize(level) {
             document.getElementById('currentNumberSizeLabel').textContent = ['标准','中','大','加大','特大'][level-1]||'标准';
             document.documentElement.style.setProperty('--number-font-scale', 1 + (level-1)*0.1);
        }

        // Tab Switcher
        function switchTab(tab) {
            ['recipe', 'sop', 'step'].forEach(t => {
                const btn = document.getElementById(`tab-btn-${t}`);
                const section = document.getElementById(`${t}-section`);
                if (t === tab) {
                    btn.classList.add('active');
                    section.classList.remove('hidden');
                } else {
                    btn.classList.remove('active');
                    section.classList.add('hidden');
                }
            });
        }
        
        // Initial Logic
        document.addEventListener('DOMContentLoaded', () => {
             // Init scaling if needed, or just let static values be
        });

        function toggleRecipeInfo() {
             const container = document.getElementById('recipeInfoContainer');
             container.classList.toggle('hidden');
             const icon = document.getElementById('infoToggleIcon');
             icon.classList.toggle('fa-chevron-right');
             icon.classList.toggle('fa-chevron-down');
        }
        
        // Disable ingredient status toggle for view mode
        function toggleIngredientStatus(element) {
            // Read-only
            console.log('Read-only mode');
        }
    </script>
</body>
</html>
