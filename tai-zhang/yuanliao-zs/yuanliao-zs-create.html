<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新建原料记录 - 烘匠 BakeManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-green: #10b981;
            --primary-dark: #059669;
            --bg-light: #f7f7f5;
            --bg-white: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            -webkit-tap-highlight-color: transparent;
        }
        .form-input {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: var(--primary-green);
        }
        .section-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-title::before {
            content: '';
            width: 4px;
            height: 1rem;
            background-color: var(--primary-green);
            border-radius: 2px;
        }
    </style>
</head>
<body class="pb-20">

    <!-- Header -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="px-4 h-14 flex items-center justify-between">
            <a href="yuanliao-zs-list.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-all text-gray-600">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1 class="text-lg font-bold text-gray-800">新建原料记录</h1>
            <div class="w-10"></div>
        </div>
    </nav>

    <!-- Form -->
    <form id="createForm" class="p-4 space-y-4">
        
        <!-- Basic Info -->
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <h3 class="section-title">基本信息</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">入库批次号 (自动生成)</label>
                    <input type="text" id="batchId" class="form-input bg-gray-50 text-gray-500" readonly>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">原料名称 *</label>
                    <input type="text" id="materialName" class="form-input" placeholder="例如：高筋面粉" required>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">供应商 *</label>
                    <input type="text" id="supplier" class="form-input" placeholder="请输入供应商名称" required>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">入库日期 *</label>
                    <input type="date" id="inboundDate" class="form-input" required>
                </div>
            </div>
        </div>

        <!-- Inventory Info -->
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <h3 class="section-title">库存信息</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">入库数量 *</label>
                    <input type="number" id="amount" class="form-input" placeholder="0" required>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">单位 *</label>
                    <select id="unit" class="form-input bg-white">
                        <option value="kg">kg</option>
                        <option value="g">g</option>
                        <option value="L">L</option>
                        <option value="ml">ml</option>
                        <option value="个">个</option>
                        <option value="包">包</option>
                        <option value="箱">箱</option>
                    </select>
                </div>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">保质期至</label>
                    <input type="date" id="expiryDate" class="form-input">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">存放位置</label>
                    <input type="text" id="location" class="form-input" placeholder="例如：常温库 A区">
                </div>
            </div>
        </div>

    </form>

    <!-- Bottom Actions -->
    <div class="fixed bottom-0 left-0 right-0 bg-white p-4 border-t border-gray-100 flex gap-3 z-50">
        <button onclick="history.back()" class="flex-1 py-3 bg-white border border-gray-200 text-gray-600 rounded-xl font-bold text-sm">取消</button>
        <button onclick="saveRecord()" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-green-200">保存记录</button>
    </div>

    <script src="../js/common.js"></script>
    <script src="../js/select-modal.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const id = LedgerUtils.getQueryParam('id');
            if (id) {
                document.querySelector('h1').textContent = '编辑原料记录';
                loadRecordForEdit(id);
            } else {
                document.getElementById('batchId').value = LedgerUtils.generateBatchId('MAT');
                document.getElementById('inboundDate').value = LedgerUtils.getLocalDateStr();
                
                // Factory Presets (Priority 3)
                const presets = LedgerUtils.SafeStorage.get('factoryPresets', {});
                if (presets.defaultSupplier) {
                    document.getElementById('supplier').value = presets.defaultSupplier;
                    document.getElementById('supplierDisplay').textContent = presets.defaultSupplier;
                    document.getElementById('supplierDisplay').classList.remove('text-gray-500');
                    document.getElementById('supplierDisplay').classList.add('text-gray-800');
                }
            }
        });

        function selectSupplier() {
            showSupplierSelector((s) => {
                document.getElementById('supplier').value = s.name;
                document.getElementById('supplierDisplay').textContent = s.name;
                document.getElementById('supplierDisplay').classList.remove('text-gray-500');
                document.getElementById('supplierDisplay').classList.add('text-gray-800');
            });
        }

        function loadRecordForEdit(id) {
            const ledgers = LedgerUtils.SafeStorage.get('ledger_material', []);
            const record = ledgers.find(l => l.id === id);
            
            if (!record) {
                LedgerUtils.showToast('记录不存在', 'error');
                setTimeout(() => window.location.href = 'yuanliao-zs-list.html', 1500);
                return;
            }

            document.getElementById('batchId').value = record.id;
            document.getElementById('materialName').value = record.materialName;
            document.getElementById('supplier').value = record.supplier;
            document.getElementById('supplierDisplay').textContent = record.supplier;
            document.getElementById('supplierDisplay').classList.remove('text-gray-500');
            document.getElementById('supplierDisplay').classList.add('text-gray-800');
            document.getElementById('inboundDate').value = record.inboundDate;
            
            // Parse amount and unit
            // Assuming format "100kg"
            const amountStr = record.amount;
            const match = amountStr.match(/([\d\.]+)(.*)/);
            if (match) {
                document.getElementById('amount').value = match[1];
                document.getElementById('unit').value = match[2] || 'kg';
            } else {
                document.getElementById('amount').value = parseFloat(amountStr) || 0;
            }

            document.getElementById('expiryDate').value = record.expiryDate || '';
            document.getElementById('location').value = record.location || '';
        }

        function saveRecord() {
            const form = document.getElementById('createForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const amount = document.getElementById('amount').value;
            const unit = document.getElementById('unit').value;
            
            const recordData = {
                id: document.getElementById('batchId').value,
                materialName: document.getElementById('materialName').value,
                supplier: document.getElementById('supplier').value,
                inboundDate: document.getElementById('inboundDate').value,
                amount: `${amount}${unit}`,
                expiryDate: document.getElementById('expiryDate').value,
                location: document.getElementById('location').value,
                type: 'ingredient',
                timestamp: new Date().getTime()
            };

            const validation = LedgerUtils.validateMaterialRecord(recordData);
            if (!validation.valid) {
                LedgerUtils.showToast(validation.errors.join('；'), 'error');
                return;
            }

            try {
                let ledgers = LedgerUtils.SafeStorage.get('ledger_material', []);
                
                // Check if updating
                const id = recordData.id;
                const existingIndex = ledgers.findIndex(l => l.id === id);
                
                if (existingIndex >= 0) {
                    recordData.timestamp = ledgers[existingIndex].timestamp;
                    ledgers[existingIndex] = recordData;
                    LedgerUtils.showToast('更新成功');
                } else {
                    ledgers.unshift(recordData);
                    LedgerUtils.showToast('保存成功');
                }
                
                LedgerUtils.SafeStorage.set('ledger_material', ledgers);
                
                setTimeout(() => window.location.href = 'yuanliao-zs-list.html', 1000);
            } catch (e) {
                console.error(e);
                LedgerUtils.showToast('保存失败', 'error');
            }
        }
    </script>
</body>
</html>
