<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快速录入 - 烘匠 BakeManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #ff9f43;
            --bg-light: #f7f7f5;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
        }
        .form-input {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            outline: none;
        }
        .form-input:focus {
            border-color: var(--primary-orange);
        }
    </style>
</head>
<body class="pb-20">
    <!-- Header -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="px-4 h-14 flex items-center justify-between">
            <a href="shengchan-taizhang-list.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-all text-gray-600">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1 class="text-lg font-bold text-gray-800">快速录入</h1>
            <button onclick="addNewRow()" class="w-10 h-10 flex items-center justify-center rounded-full bg-orange-500 text-white hover:bg-orange-600">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </nav>
    <!-- 批量设置区域 -->
    <div class="p-4 bg-white border-b border-gray-100">
        <div class="bg-orange-50 rounded-lg p-3 mb-3">
            <div class="text-xs font-bold text-orange-600 mb-2">批量设置（应用到所有记录）</div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="text-xs text-gray-500 mb-1 block">生产日期</label>
                    <input type="date" id="batchDate" class="form-input text-xs" onchange="applyBatchSetting('date', this.value)">
                </div>
                <div>
                    <label class="text-xs text-gray-500 mb-1 block">操作人员</label>
                    <button type="button" onclick="selectBatchOperator()" class="form-input text-left flex items-center justify-between bg-white text-xs">
                        <span id="batchOperatorDisplay" class="truncate text-gray-500">选择人员</span>
                        <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                    </button>
                    <input type="hidden" id="batchOperator">
                </div>
            </div>
        </div>
    </div>
    <!-- 表单区域 -->
    <form id="quickForm" class="p-4 space-y-3">
        <div id="recordsContainer">
            <!-- 动态生成的记录行 -->
        </div>
    </form>
    <!-- 底部操作栏 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white p-4 border-t border-gray-100 flex gap-3 z-50">
        <button onclick="history.back()" class="flex-1 py-3 bg-white border border-gray-200 text-gray-600 rounded-xl font-bold text-sm">取消</button>
        <button onclick="saveAllRecords()" class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-orange-200">
            <i class="fas fa-save mr-1"></i> 保存全部
        </button>
    </div>
    <script src="../../js/common.js"></script>
    <script src="../../js/select-modal.js"></script>
    <script>
        let records = [];
        let batchSettings = {
            date: LedgerUtils.getLocalDateStr(),
            operator: ''
        };
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('batchDate').value = batchSettings.date;
            addNewRow();
        });
        function addNewRow() {
            const index = records.length;
            const record = {
                id: LedgerUtils.generateBatchId(),
                productName: '',
                planAmount: '',
                actualAmount: '',
                operator: batchSettings.operator,
                productionDate: batchSettings.date,
                materials: [],
                equipment: []
            };
            records.push(record);
            renderRecords();
        }
        function renderRecords() {
            const container = document.getElementById('recordsContainer');
            container.innerHTML = records.map((record, index) => `
                <div class="bg-white rounded-xl p-4 shadow-sm border-2 border-gray-100" data-index="${index}">
                    <div class="flex justify-between items-center mb-3">
                        <div class="text-xs font-bold text-orange-500">${record.id}</div>
                        <button type="button" onclick="removeRecord(${index})" class="text-red-500 text-xs">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">产品名称 *</label>
                            <input type="text" class="form-input" placeholder="例如：法式牛角包"
                                value="${record.productName}"
                                onchange="updateRecord(${index}, 'productName', this.value)"
                                list="productSuggestions${index}">
                            <datalist id="productSuggestions${index}"></datalist>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">计划数量</label>
                                <input type="number" class="form-input" placeholder="0"
                                    value="${record.planAmount}"
                                    onchange="updateRecord(${index}, 'planAmount', this.value)">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">实际数量</label>
                                <input type="number" class="form-input" placeholder="0"
                                    value="${record.actualAmount}"
                                    onchange="updateRecord(${index}, 'actualAmount', this.value)">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">生产日期</label>
                                <input type="date" class="form-input"
                                    value="${record.productionDate}"
                                    onchange="updateRecord(${index}, 'productionDate', this.value)">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">操作人员</label>
                                <button type="button" onclick="selectOperator(${index})" class="form-input text-left flex items-center justify-between bg-white text-xs">
                                    <span id="operatorDisplay${index}" class="truncate ${record.operator ? 'text-gray-800' : 'text-gray-500'}">${record.operator || '选择人员'}</span>
                                    <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                                </button>
                                <input type="hidden" id="operator${index}" value="${record.operator}">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" onclick="addMaterial(${index})" class="flex-1 py-1.5 border border-dashed border-gray-300 rounded text-xs text-gray-500">
                                <i class="fas fa-plus mr-1"></i> 原料
                            </button>
                            <button type="button" onclick="addEquipment(${index})" class="flex-1 py-1.5 border border-dashed border-gray-300 rounded text-xs text-gray-500">
                                <i class="fas fa-plus mr-1"></i> 设备
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            // 加载产品名称建议
            records.forEach((record, index) => {
                const history = LedgerUtils.InputHistory.get('productName');
                const datalist = document.getElementById(`productSuggestions${index}`);
                if (history && datalist) {
                    datalist.innerHTML = history.map(item => 
                        `<option value="${item}">${item}</option>`
                    ).join('');
                }
            });
        }
        function updateRecord(index, field, value) {
            if (records[index]) {
                records[index][field] = value;
            }
        }
        function removeRecord(index) {
            if (records.length <= 1) {
                LedgerUtils.showToast('至少保留一条记录', 'error');
                return;
            }
            records.splice(index, 1);
            renderRecords();
        }
        function selectOperator(index) {
            showPersonnelSelector((p) => {
                records[index].operator = p.name;
                document.getElementById(`operator${index}`).value = p.name;
                document.getElementById(`operatorDisplay${index}`).textContent = p.name;
                document.getElementById(`operatorDisplay${index}`).classList.remove('text-gray-500');
                document.getElementById(`operatorDisplay${index}`).classList.add('text-gray-800');
            });
        }
        function selectBatchOperator() {
            showPersonnelSelector((p) => {
                batchSettings.operator = p.name;
                document.getElementById('batchOperator').value = p.name;
                document.getElementById('batchOperatorDisplay').textContent = p.name;
                document.getElementById('batchOperatorDisplay').classList.remove('text-gray-500');
                document.getElementById('batchOperatorDisplay').classList.add('text-gray-800');
                // 应用到所有记录
                records.forEach((record, index) => {
                    record.operator = p.name;
                    const display = document.getElementById(`operatorDisplay${index}`);
                    if (display) {
                        display.textContent = p.name;
                        display.classList.remove('text-gray-500');
                        display.classList.add('text-gray-800');
                    }
                });
            });
        }
        function applyBatchSetting(field, value) {
            batchSettings[field] = value;
            records.forEach(record => {
                record[field] = value;
            });
            renderRecords();
        }
        function addMaterial(index) {
            showMaterialSelector((material) => {
                if (!records[index].materials) {
                    records[index].materials = [];
                }
                if (!records[index].materials.some(m => m.id === material.id)) {
                    records[index].materials.push(material);
                    LedgerUtils.showToast('已添加原料');
                } else {
                    LedgerUtils.showToast('该原料已添加', 'error');
                }
            });
        }
        function addEquipment(index) {
            showEquipmentSelector((equipment) => {
                if (!records[index].equipment) {
                    records[index].equipment = [];
                }
                if (!records[index].equipment.some(e => e.name === equipment.name)) {
                    records[index].equipment.push(equipment);
                    LedgerUtils.showToast('已添加设备');
                } else {
                    LedgerUtils.showToast('该设备已添加', 'error');
                }
            });
        }
        function saveAllRecords() {
            // 验证所有记录
            const invalidRecords = records.filter(r => !r.productName || !r.operator);
            if (invalidRecords.length > 0) {
                LedgerUtils.showToast(`有 ${invalidRecords.length} 条记录未填写完整`, 'error');
                return;
            }
            try {
                const ledgers = LedgerUtils.SafeStorage.get('ledger_production', []);
                
                records.forEach(record => {
                    const recordData = {
                        id: record.id,
                        productName: record.productName,
                        productionDate: record.productionDate,
                        operator: record.operator,
                        planAmount: `${record.planAmount || 0}kg`,
                        actualAmount: `${record.actualAmount || 0}kg`,
                        status: parseFloat(record.planAmount) === parseFloat(record.actualAmount) ? 'qualified' : 'diff',
                        materials: record.materials || [],
                        equipment: record.equipment || [],
                        timestamp: new Date().getTime()
                    };
                    
                    // 保存输入历史
                    LedgerUtils.InputHistory.save('productName', record.productName);
                    
                    ledgers.unshift(recordData);
                });
                
                LedgerUtils.SafeStorage.set('ledger_production', ledgers);
                LedgerUtils.showToast(`成功保存 ${records.length} 条记录`);
                
                setTimeout(() => {
                    window.location.href = 'shengchan-taizhang-list.html';
                }, 1500);
            } catch (e) {
                console.error(e);
                LedgerUtils.showToast('保存失败', 'error');
            }
        }
    </script>
</body>
</html>