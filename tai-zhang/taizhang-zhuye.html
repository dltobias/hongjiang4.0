<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台账管理 - 烘匠 BakeManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .card-hover { transition: all 0.2s; }
        .card-hover:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-gray-50 pb-20">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="px-4 h-14 flex items-center justify-between">
            <a href="../cangku-gongneng/erp-zhuye-canku.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-all text-gray-600">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1 class="text-lg font-bold text-gray-800">台账管理</h1>
            <div class="flex gap-2">
                <button class="w-10 h-10 flex items-center justify-center text-gray-600 rounded-full hover:bg-gray-100" onclick="refreshData(this)" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                </button>
                 <button class="w-10 h-10 flex items-center justify-center text-gray-600 relative" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Notification Panel (Hidden) -->
    <div id="notifPanel" class="hidden fixed inset-0 z-40" onclick="toggleNotifications()">
        <div class="absolute top-14 right-4 w-72 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden" onclick="event.stopPropagation()">
            <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center">
                <span class="text-xs font-bold text-gray-700">消息通知</span>
                <span class="text-[10px] text-blue-500 cursor-pointer">全部标为已读</span>
            </div>
            <div class="max-h-64 overflow-y-auto">
                <div class="p-3 border-b border-gray-50 hover:bg-gray-50 cursor-pointer">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-bold text-gray-800">审批通过</span>
                        <span class="text-[10px] text-gray-400">10分钟前</span>
                    </div>
                    <p class="text-xs text-gray-600">生产经理已批准 BATCH20231026001 的修正申请。</p>
                </div>
                <div class="p-3 border-b border-gray-50 hover:bg-gray-50 cursor-pointer">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-bold text-red-500">召回审批</span>
                        <span class="text-[10px] text-gray-400">1小时前</span>
                    </div>
                    <p class="text-xs text-gray-600">质检部发起一项新的召回请求，请尽快处理。</p>
                </div>
                <div class="p-3 hover:bg-gray-50 cursor-pointer">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-bold text-blue-500">法规更新</span>
                        <span class="text-[10px] text-gray-400">昨天</span>
                    </div>
                    <p class="text-xs text-gray-600">新的《食品标签管理办法》已发布。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 智能洞察 (New Section) -->
    <div class="px-4 mt-4">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-sm font-bold text-gray-700"><i class="fas fa-magic text-purple-500 mr-1"></i> 智能洞察</h3>
            <span class="text-[10px] text-gray-400">AI实时分析</span>
        </div>
        <div class="space-y-3" id="insights-container">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- 统计卡片区域 -->
    <div class="p-4 grid grid-cols-3 gap-3 md:grid-cols-3">
        <div class="bg-white rounded-xl p-3 shadow-sm text-center border-l-4 border-orange-500">
            <div class="text-xs text-gray-500 mb-1">今日台账</div>
            <div class="text-2xl font-bold text-orange-500" id="stat-today">12</div>
            <div class="text-[10px] text-gray-400 mt-1" id="stat-today-trend">↑ 比昨日 --</div>
        </div>
        <div class="bg-white rounded-xl p-3 shadow-sm text-center border-l-4 border-blue-500">
            <div class="text-xs text-gray-500 mb-1">本月台账</div>
            <div class="text-2xl font-bold text-blue-500" id="stat-month">345</div>
            <div class="text-[10px] text-gray-400 mt-1" id="stat-month-trend">↑ 环比 --%</div>
        </div>
        <div class="bg-white rounded-xl p-3 shadow-sm text-center border-l-4 border-red-500">
            <div class="text-xs text-gray-500 mb-1">待处理</div>
            <div class="text-2xl font-bold text-red-500" id="stat-pending">3</div>
            <div class="text-[10px] text-gray-400 mt-1">需立即关注</div>
        </div>
    </div>

    <!-- 数据可视化区域 (New) -->
    <div class="px-4 mb-4 space-y-4">
        <!-- 趋势图 -->
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-sm font-bold text-gray-700">台账数量趋势</h3>
                <div class="flex gap-2 items-center">
                    <a href="tongji-baobiao.html" class="text-xs text-orange-500 font-bold border border-orange-200 px-2 py-1 rounded bg-orange-50 hover:bg-orange-100 transition-colors">
                        <i class="fas fa-chart-pie mr-1"></i>详细报表
                    </a>
                    <select id="trend-range-select" class="text-xs border rounded p-1 bg-gray-50">
                        <option value="7days">近7天</option>
                        <option value="month">本月</option>
                    </select>
                </div>
            </div>
            <div class="h-40">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- 质量分析 -->
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <h3 class="text-sm font-bold text-gray-700 mb-3">批次质量分析</h3>
            <div class="flex items-center">
                <div class="w-1/2 h-32 relative">
                    <canvas id="qualityChart"></canvas>
                </div>
                <div class="w-1/2 pl-4 space-y-2">
                    <div class="flex justify-between items-center text-xs">
                        <span class="flex items-center gap-1"><i class="fas fa-circle text-green-500 text-[8px]"></i> 合格</span>
                        <span class="font-bold">92%</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="flex items-center gap-1"><i class="fas fa-circle text-red-500 text-[8px]"></i> 异常</span>
                        <span class="font-bold">8%</span>
                    </div>
                    <div class="pt-2 border-t border-gray-100">
                         <p class="text-[10px] text-gray-400" id="quality-main-issue">主要问题: --</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 成本分析 (New) -->
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <h3 class="text-sm font-bold text-gray-700 mb-3">原料成本趋势 (元/kg)</h3>
            <div class="h-40">
                <canvas id="costChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 功能入口区域 -->
    <div class="px-4 mb-6 space-y-6">
        <!-- 记录类 -->
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 ml-1">记录管理</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <a href="shengchan-JL/shengchan-taizhang-list.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center mb-2">
                        <i class="fas fa-industry text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">生产记录</span>
                </a>
                <!-- New Template Entry -->
                <a href="shengchan-JL/shengchan-taizhang-quick-create.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mb-2">
                        <i class="fas fa-bolt text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">快速录入</span>
                </a>
                <a href="zhiliang-jy/zhiliang-jy-list.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center mb-2">
                        <i class="fas fa-clipboard-check text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">质检台账</span>
                </a>
                <a href="shebei-taizhang/shebei-taizhang-list.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center mb-2">
                        <i class="fas fa-blender text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">设备台账</span>
                </a>
            </div>
        </div>

        <!-- 追溯类 -->
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 ml-1">追溯查询</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <a href="zhuisu-taizhang.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-2">
                        <i class="fas fa-search text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">追溯查询</span>
                </a>
                <a href="yuanliao-zs/yuanliao-zs-list.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-2">
                        <i class="fas fa-seedling text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">原料追溯</span>
                </a>
                <a href="xiaoshou-ZS/xiaoshou-zs-query.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-2">
                        <i class="fas fa-shipping-fast text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">销售追溯</span>
                </a>
            </div>
        </div>

        <!-- 检验类 -->
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 ml-1">质量检验</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <a href="zhiliang-jy/zhiliang-jy-list.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-2">
                        <i class="fas fa-microscope text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">质量检验</span>
                </a>
            </div>
        </div>

        <!-- 基础配置 -->
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 ml-1">基础配置</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <a href="gongchang-SZ/gongchang-sz-list.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center mb-2">
                        <i class="fas fa-cogs text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">工厂设置</span>
                </a>
            </div>
        </div>

        <!-- 导出类 -->
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 ml-1">数据导出</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <a href="taizhang-daochu.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center mb-2">
                        <i class="fas fa-file-export text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">年检导出</span>
                </a>
                <a href="taizhang-DC/taizhang-dc-list.html" class="bg-white rounded-xl p-4 shadow-sm card-hover flex flex-col items-center justify-center h-24">
                    <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center mb-2">
                        <i class="fas fa-file-export text-lg"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-800">台账导出</span>
                </a>
            </div>
        </div>
    </div>

    <!-- 最近台账预览 -->
    <div class="px-4 pb-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-700">最近台账</h3>
            <a href="shengchan-JL/shengchan-taizhang-list.html" class="text-xs text-gray-500">查看全部</a>
        </div>
        
        <div class="space-y-3" id="recent-list">
            <!-- 动态生成 -->
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="inline-block px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded mb-1">生产</span>
                        <h4 class="font-bold text-gray-800">法式牛角包</h4>
                    </div>
                    <span class="text-xs text-gray-400">10-26 14:30</span>
                </div>
                <div class="text-xs text-gray-500 flex justify-between items-center">
                    <span>批次: BATCH20231026001</span>
                    <button class="text-blue-500 font-medium">查看</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 首次使用引导遮罩 -->
    <div id="first-time-guide" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50">
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl p-6 w-80 max-w-[90vw]">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-lightbulb text-2xl text-orange-500"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">欢迎使用台账管理</h3>
                <p class="text-sm text-gray-600 mb-4">3步快速上手</p>
            </div>
            <div class="space-y-3 mb-6">
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-orange-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">1</div>
                    <div class="text-sm text-gray-700">
                        <div class="font-bold">创建生产记录</div>
                        <div class="text-xs text-gray-500 mt-1">点击"生产记录"开始记录</div>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-orange-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">2</div>
                    <div class="text-sm text-gray-700">
                        <div class="font-bold">填写基本信息</div>
                        <div class="text-xs text-gray-500 mt-1">产品名称、日期、操作人员</div>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-orange-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">3</div>
                    <div class="text-sm text-gray-700">
                        <div class="font-bold">保存完成</div>
                        <div class="text-xs text-gray-500 mt-1">系统会自动生成批次号</div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="skipGuide()" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold">跳过</button>
                <button onclick="startGuide()" class="flex-1 py-2 bg-orange-500 text-white rounded-lg text-sm font-bold">开始体验</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        function skipGuide() {
            localStorage.setItem('ledger_guide_seen', 'true');
            document.getElementById('first-time-guide').classList.add('hidden');
        }

        function startGuide() {
            localStorage.setItem('ledger_guide_seen', 'true');
            document.getElementById('first-time-guide').classList.add('hidden');
            // 可以跳转到创建页面或显示高亮引导
            window.location.href = 'shengchan-JL/shengchan-taizhang-create.html';
        }

        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global Error:', error);
            if (typeof LedgerUtils.showToast === 'function') {
                LedgerUtils.showToast('系统发生错误，请刷新重试', 'error');
            }
            return false;
        };

        let trendChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            const hasSeenGuide = localStorage.getItem('ledger_guide_seen');
            if (!hasSeenGuide) {
                document.getElementById('first-time-guide').classList.remove('hidden');
            }

            loadRecentLedgers();
            generateInsights();
            initCharts('7days');
            
            document.getElementById('trend-range-select').addEventListener('change', function(e) {
                changeTimeRange(e.target.value);
                initCharts(e.target.value);
            });
        });

        function toggleNotifications() {
            const panel = document.getElementById('notifPanel');
            panel.classList.toggle('hidden');
        }

        function generateInsights() {
            const prod = LedgerUtils.SafeStorage.get('ledger_production', []);
            const quality = LedgerUtils.SafeStorage.get('ledger_quality', []);
            const equipments = LedgerUtils.SafeStorage.get('ledger_equipment', []);
            const container = document.getElementById('insights-container');
            const insights = [];

            // 1. 异常批次检测
            const abnormalProd = prod.filter(p => p.status === 'diff');
            if (abnormalProd.length > 0) {
                insights.push({
                    type: 'production',
                    title: '产量异常',
                    message: `发现 ${abnormalProd.length} 个批次实际产量与计划不符`,
                    priority: 'medium',
                    icon: 'fa-chart-line',
                    color: 'orange'
                });
            }

            // 2. 质量趋势分析
            if (quality.length > 0) {
                const unqualifiedRate = quality.filter(q => q.status === 'unqualified').length / quality.length;
                if (unqualifiedRate > 0.1) { // 不合格率超过10%
                    insights.push({
                        type: 'quality',
                        title: '质量预警',
                        message: `近期不合格率 ${(unqualifiedRate * 100).toFixed(1)}%，请关注生产工艺`,
                        priority: 'high',
                        icon: 'fa-exclamation-triangle',
                        color: 'red'
                    });
                }
            }

            // 3. 设备维护提醒
            const now = new Date();
            const needMaintenance = equipments.filter(e => {
                if (!e.nextMaintenance) return false;
                const nextDate = new Date(e.nextMaintenance);
                const daysUntil = Math.ceil((nextDate - now) / (1000 * 60 * 60 * 24));
                return daysUntil <= 7 && daysUntil >= 0;
            });

            if (needMaintenance.length > 0) {
                insights.push({
                    type: 'maintenance',
                    title: '设备维护提醒',
                    message: `有 ${needMaintenance.length} 台设备即将需要维护`,
                    priority: 'medium',
                    icon: 'fa-tools',
                    color: 'blue'
                });
            }

            // Render
            if (insights.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-xl p-4 shadow-sm flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-500">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">运行平稳</h4>
                            <p class="text-xs text-gray-500">暂无异常风险</p>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = insights.map(item => `
                    <div class="bg-white rounded-xl p-4 shadow-sm flex items-center gap-3 border-l-4 border-${item.color}-500">
                        <div class="w-10 h-10 rounded-full bg-${item.color}-100 flex items-center justify-center text-${item.color}-500">
                            <i class="fas ${item.icon}"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">${item.title}</h4>
                            <p class="text-xs text-gray-500">${item.message}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        function initCharts(range = '7days') {
            const prod = LedgerUtils.SafeStorage.get('ledger_production', []);
            
            // 1. Trend Chart
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (trendChart) {
                trendChart.destroy();
            }

            let labels, data;
            if (range === 'month') {
                // 按周统计
                const weeks = ['第1周', '第2周', '第3周', '第4周'];
                const weekData = [0, 0, 0, 0];
                
                prod.forEach(item => {
                    const date = new Date(item.productionDate);
                    // Simple week approximation for demo
                    const week = Math.floor(date.getDate() / 7);
                    if (week < 4) weekData[week]++;
                });
                
                labels = weeks;
                data = weekData;
            } else {
                // 近7天
                const days = [];
                const dayData = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    days.push(dateStr);
                    
                    const count = prod.filter(p => {
                        const pDate = new Date(p.productionDate);
                        // Compare YYYY-MM-DD
                        const pDateStr = pDate.toISOString().split('T')[0];
                        const currDateStr = date.toISOString().split('T')[0];
                        return pDateStr === currDateStr;
                    }).length;
                    dayData.push(count);
                }
                labels = days;
                data = dayData;
            }

            trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '生成数量',
                        data: data,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: true, borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Empty State for Trend Chart
            if (data.every(d => d === 0)) {
                const chartContainer = document.getElementById('trendChart').parentElement;
                // Check if we already appended a message to avoid duplicates or clearing canvas context unexpectedly
                // Ideally, we overlay or replace. Let's overlay.
                const existingOverlay = chartContainer.querySelector('.empty-chart-overlay');
                if (!existingOverlay) {
                    const overlay = document.createElement('div');
                    overlay.className = 'empty-chart-overlay absolute inset-0 flex flex-col items-center justify-center bg-white bg-opacity-80';
                    overlay.innerHTML = `
                        <div class="text-gray-300 text-center">
                            <i class="fas fa-chart-line text-3xl mb-2"></i>
                            <p class="text-xs">暂无趋势数据</p>
                        </div>
                    `;
                    // Ensure container is relative
                    chartContainer.classList.add('relative');
                    chartContainer.appendChild(overlay);
                }
            } else {
                 const chartContainer = document.getElementById('trendChart').parentElement;
                 const existingOverlay = chartContainer.querySelector('.empty-chart-overlay');
                 if(existingOverlay) existingOverlay.remove();
            }

            // 2. Quality Chart
            const ctxQuality = document.getElementById('qualityChart').getContext('2d');
            // Check if chart instance exists on canvas
            if (Chart.getChart(ctxQuality)) {
                 Chart.getChart(ctxQuality)?.destroy();
            }
            
            // Calculate quality stats
            const qualityRecords = LedgerUtils.SafeStorage.get('ledger_quality', []);
            const qualified = qualityRecords.filter(r => r.status === 'qualified').length;
            const totalQuality = qualityRecords.length;
            const qualifiedRate = totalQuality > 0 ? Math.round((qualified / totalQuality) * 100) : 100;
            const unqualifiedRate = 100 - qualifiedRate;

            // Dynamic Main Issue Calculation
            const unqualifiedReasons = qualityRecords
                .filter(r => r.status === 'unqualified' || r.status === 'scrap')
                .map(r => r.reason || r.unqualifiedReason) // Support different field names
                .filter(Boolean);
            
            const reasonCounts = {};
            unqualifiedReasons.forEach(reason => {
                reasonCounts[reason] = (reasonCounts[reason] || 0) + 1;
            });
            
            const mainIssue = Object.keys(reasonCounts).length > 0 
                ? Object.keys(reasonCounts).reduce((a, b) => reasonCounts[a] > reasonCounts[b] ? a : b) 
                : '无异常';
            
            const qualityTextEl = document.getElementById('quality-main-issue');
            if (qualityTextEl) {
                qualityTextEl.textContent = `主要问题: ${mainIssue}`;
            }

            // Update Qualified Rate Text
            const rateContainers = document.querySelectorAll('.w-1\\/2.pl-4.space-y-2 .flex.justify-between.items-center .font-bold');
            if(rateContainers.length >= 2) {
                 rateContainers[0].innerText = `${qualifiedRate}%`;
                 rateContainers[1].innerText = `${unqualifiedRate}%`;
            }

            new Chart(ctxQuality, {
                type: 'doughnut',
                data: {
                    labels: ['合格', '异常'],
                    datasets: [{
                        data: [qualifiedRate, unqualifiedRate],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { display: false } }
                }
            });

            // 3. Cost Chart (Simulated Dynamic)
            const ctxCost = document.getElementById('costChart').getContext('2d');
             if (Chart.getChart(ctxCost)) {
                 Chart.getChart(ctxCost)?.destroy();
            }
            
            // Base prices
            const materials = ['高筋面粉', '黄油', '淡奶油', '糖', '酵母'];
            const basePrices = [4.5, 45, 38, 6.2, 85];
            
            // Simulate slight variation for "Current Month" vs "Last Month"
            const todaySeed = new Date().getDate(); 
            const currentPrices = basePrices.map((p, i) => parseFloat((p * (0.95 + (todaySeed % 10 + i)/100)).toFixed(1))); 
            const lastMonthPrices = basePrices.map((p, i) => parseFloat((p * (0.95 + ((todaySeed + 5) % 10 + i)/100)).toFixed(1)));

            new Chart(ctxCost, {
                type: 'bar',
                data: {
                    labels: materials,
                    datasets: [{
                        label: '本月均价',
                        data: currentPrices,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }, {
                        label: '上月均价',
                        data: lastMonthPrices,
                        backgroundColor: '#e5e7eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 8, font: { size: 10 } } } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: true, borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function loadRecentLedgers() {
            // Merge ledgers from various sources
            const prod = LedgerUtils.SafeStorage.get('ledger_production', []);
            const trace = LedgerUtils.SafeStorage.get('ledger_material', []);
            const quality = LedgerUtils.SafeStorage.get('ledger_quality', []);
            
            // Normalize data formats
            const allProd = prod.map(i => ({...i, type: '生产', date: i.productionDate, batchNo: i.id}));
            const allTrace = trace.map(i => ({...i, type: '追溯', date: i.inboundDate, productName: i.materialName, batchNo: i.id}));
            
            // Combine and sort
            let all = [...allProd, ...allTrace].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            // 1. Daily Stats
            const todayCount = all.filter(i => i.date === todayStr).length;
            const yesterdayCount = all.filter(i => i.date === yesterdayStr).length;
            const dailyDiff = todayCount - yesterdayCount;
            const dailyTrendSign = dailyDiff >= 0 ? '+' : '';
            
            document.getElementById('stat-today').innerText = todayCount;
            const todayTrendEl = document.getElementById('stat-today-trend');
            
            if (todayCount === 0 && yesterdayCount === 0) {
                 if (todayTrendEl) {
                    todayTrendEl.innerText = '暂无数据';
                    todayTrendEl.className = 'text-[10px] text-gray-400 mt-1';
                 }
            } else if (todayTrendEl) {
                const dailyTrendIcon = dailyDiff >= 0 ? '↑' : '↓';
                const dailyTrendColor = dailyDiff >= 0 ? 'text-green-500' : 'text-red-500';
                todayTrendEl.innerHTML = `<span class="${dailyTrendColor}">${dailyTrendIcon} 比昨日 ${dailyTrendSign}${Math.abs(dailyDiff)}</span>`;
            }

            // 2. Monthly Stats
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const lastMonthDate = new Date(now);
            lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
            const lastMonth = lastMonthDate.getMonth();
            const lastMonthYear = lastMonthDate.getFullYear();

            const monthCount = all.filter(i => {
                const d = new Date(i.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            }).length;

            const lastMonthCount = all.filter(i => {
                const d = new Date(i.date);
                return d.getMonth() === lastMonth && d.getFullYear() === lastMonthYear;
            }).length;

            let monthTrendPercent = 0;
            if (lastMonthCount > 0) {
                monthTrendPercent = Math.round(((monthCount - lastMonthCount) / lastMonthCount) * 100);
            } else if (monthCount > 0) {
                monthTrendPercent = 100;
            }

            const monthTrendSign = monthTrendPercent >= 0 ? '+' : '';

            document.getElementById('stat-month').innerText = monthCount;
            const monthTrendEl = document.getElementById('stat-month-trend');
            
            if (monthCount === 0 && lastMonthCount === 0) {
                 if (monthTrendEl) {
                     monthTrendEl.innerText = '暂无数据';
                     monthTrendEl.className = 'text-[10px] text-gray-400 mt-1';
                 }
            } else if (monthTrendEl) {
                const monthTrendIcon = monthTrendPercent >= 0 ? '↑' : '↓';
                const monthTrendColor = monthTrendPercent >= 0 ? 'text-green-500' : 'text-red-500';
                monthTrendEl.innerHTML = `<span class="${monthTrendColor}">${monthTrendIcon} 环比 ${monthTrendSign}${Math.abs(monthTrendPercent)}%</span>`;
            }
            
            // 3. Pending Count (Production diff + Quality unqualified)
            const pendingCount = prod.filter(i => i.status === 'diff').length + 
                                 quality.filter(i => i.status === 'unqualified' || i.status === 'scrap').length;

            // Update Stats Cards
            document.getElementById('stat-pending').innerText = pendingCount;

            // Take top 3 for list
            const recent = all.slice(0, 3);
            
            const container = document.getElementById('recent-list');
            if (recent.length > 0) {
                container.innerHTML = recent.map(item => `
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="inline-block px-2 py-0.5 ${item.type === '生产' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'} text-xs rounded mb-1">${item.type}</span>
                                <h4 class="font-bold text-gray-800">${item.productName || item.materialName || '未知'}</h4>
                            </div>
                            <span class="text-xs text-gray-400">${formatDate(item.date)}</span>
                        </div>
                        <div class="text-xs text-gray-500 flex justify-between items-center">
                            <span>批次: <span class="font-mono">${item.batchNo}</span></span>
                            <button onclick="viewLedgerDetail('${item.batchNo}', '${item.type}')" class="text-blue-500 font-medium">查看</button>
                        </div>
                    </div>
                `).join('');
            } else {
                 container.innerHTML = `
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center py-8">
                        <i class="fas fa-inbox text-3xl text-gray-300 mb-2"></i>
                        <p class="text-gray-400 text-sm">暂无最近台账</p>
                    </div>
                `;
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}-${day}`;
        }

        function generateInsights() {
            const prod = LedgerUtils.SafeStorage.get('ledger_production', []);
            const insights = [];
            
            // 1. Anomaly Detection
            if (prod.length > 0) {
                const avgYield = prod.reduce((sum, p) => {
                    // Extract numbers from strings like "80kg", "50个"
                    const plan = parseFloat(p.planAmount) || 0;
                    const actual = parseFloat(p.actualAmount) || 0;
                    return sum + (plan > 0 ? actual / plan : 0);
                }, 0) / prod.length;
                
                const anomalies = prod.filter(p => {
                    const plan = parseFloat(p.planAmount) || 0;
                    const actual = parseFloat(p.actualAmount) || 0;
                    const yieldVal = plan > 0 ? actual / plan : 0;
                    return yieldVal < avgYield * 0.85; // 15% below average
                });
                
                if (anomalies.length > 0) {
                    const latest = anomalies[0];
                    const plan = parseFloat(latest.planAmount) || 1;
                    const actual = parseFloat(latest.actualAmount) || 0;
                    const diffPercent = Math.round((1 - (actual / plan)) * 100);
                    
                    insights.push({
                        type: 'anomaly',
                        title: '发现异常批次',
                        message: `批次 ${latest.id} 的得率比历史平均值低 ${diffPercent}%`,
                        batchNo: latest.id,
                        priority: 'high'
                    });
                }
            }
            
            // 2. Pending Tasks
            const pending = prod.filter(p => p.status === 'diff').length;
            if (pending > 0) {
                insights.push({
                    type: 'pending',
                    title: '待处理记录',
                    message: `有 ${pending} 条生产记录存在差异，需要处理`,
                    priority: 'medium'
                });
            }
            
            renderInsights(insights);
        }

        function renderInsights(insights) {
            const container = document.getElementById('insights-container');
            if (!container) return;
            
            if (insights.length === 0) {
                container.innerHTML = `
                    <div class="bg-gradient-to-r from-green-50 to-white p-3 rounded-xl border border-green-100 flex items-center gap-3">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <p class="text-xs text-gray-600">一切正常，暂无异常</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = insights.map(insight => {
                const colors = {
                    high: { bg: 'from-red-50', border: 'border-red-100', icon: 'bg-red-100 text-red-500', iconClass: 'fa-exclamation-triangle' },
                    medium: { bg: 'from-yellow-50', border: 'border-yellow-100', icon: 'bg-yellow-100 text-yellow-500', iconClass: 'fa-exclamation-circle' },
                    low: { bg: 'from-blue-50', border: 'border-blue-100', icon: 'bg-blue-100 text-blue-500', iconClass: 'fa-info-circle' }
                };
                const color = colors[insight.priority] || colors.low;
                
                return `
                    <div class="bg-gradient-to-r ${color.bg} to-white p-3 rounded-xl border ${color.border} flex items-start gap-3 shadow-sm">
                        <div class="w-8 h-8 rounded-full ${color.icon} flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas ${color.iconClass} text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-xs font-bold text-gray-800 mb-0.5">${insight.title}</h4>
                            <p class="text-[10px] text-gray-600 leading-relaxed">${insight.message}</p>
                        </div>
                        ${insight.batchNo ? `<button onclick="viewLedgerDetail('${insight.batchNo}', '生产')" class="text-[10px] bg-white border border-gray-200 px-2 py-1 rounded text-gray-500 hover:bg-gray-50 transition-colors">查看</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        function refreshData(btn) {
            const icon = btn.querySelector('i');
            icon.classList.add('fa-spin');
            
            loadRecentLedgers();
            generateInsights();
            initCharts(document.getElementById('trend-range-select').value);
            
            setTimeout(() => {
                icon.classList.remove('fa-spin');
                LedgerUtils.showToast('刷新成功');
            }, 1000);
        }

        function viewLedgerDetail(batchNo, type) {
            if (type === '生产') {
                window.location.href = `shengchan-JL/shengchan-taizhang-detail.html?id=${batchNo}`;
            } else if (type === '追溯') {
                window.location.href = `yuanliao-zs/yuanliao-zs-detail.html?id=${batchNo}`;
            }
        }

        function viewAnomaly() {
            window.location.href = 'shengchan-JL/shengchan-taizhang-list.html?filter=anomaly';
        }

        function viewCostOptimization() {
            LedgerUtils.showToast('成本优化详情功能开发中', 'info');
        }

        function changeTimeRange(range) {
            // In a real app, this would fetch new data
            console.log('Changing time range to:', range);
            // Simulate chart update if needed
        }
    </script>
</body>
</html> }

        function viewLedgerDetail(batchNo, type) {
            if (type === '生产') {
                window.location.href = `shengchan-JL/shengchan-taizhang-detail.html?id=${batchNo}`;
            } else if (type === '追溯') {
                window.location.href = `yuanliao-zs/yuanliao-zs-detail.html?id=${batchNo}`;
            }
        }

        function viewAnomaly() {
            window.location.href = 'shengchan-JL/shengchan-taizhang-list.html?filter=anomaly';
        }

        function viewCostOptimization() {
            LedgerUtils.showToast('成本优化详情功能开发中', 'info');
        }

        function changeTimeRange(range) {
            // In a real app, this would fetch new data
            console.log('Changing time range to:', range);
            // Simulate chart update if needed
        }
    </script>
</body>
</html>