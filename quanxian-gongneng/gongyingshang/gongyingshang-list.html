<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>供应商管理 - 烘匠 BakeManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .card-shadow { box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-gray-50 pb-20">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="px-4 h-14 flex items-center justify-between">
            <a href="../../tai-zhang/taizhang-zhuye.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-all text-gray-600">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1 class="text-lg font-bold text-gray-800">供应商管理</h1>
            <button onclick="navigateToAdd()" class="w-10 h-10 flex items-center justify-center text-orange-500">
                <i class="fas fa-plus text-lg"></i>
            </button>
        </div>
    </nav>

    <!-- 搜索和筛选 -->
    <div class="sticky top-14 z-40 bg-gray-50 pt-4 pb-2 px-4">
        <!-- 搜索框 -->
        <div class="relative mb-3">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="searchInput" placeholder="搜索供应商名称..." class="w-full bg-white border border-gray-200 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:border-orange-500 shadow-sm">
        </div>
        
        <!-- 筛选按钮 -->
        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
            <button onclick="filterList('all')" class="filter-btn active px-4 py-1.5 rounded-full text-sm font-medium bg-orange-500 text-white whitespace-nowrap" data-type="all">全部</button>
            <button onclick="filterList('valid')" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-white text-gray-600 border border-gray-200 whitespace-nowrap" data-type="valid">有效</button>
            <button onclick="filterList('expiring')" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-white text-gray-600 border border-gray-200 whitespace-nowrap" data-type="expiring">即将到期</button>
            <button onclick="filterList('expired')" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-white text-gray-600 border border-gray-200 whitespace-nowrap" data-type="expired">已过期</button>
        </div>
    </div>

    <!-- 供应商列表 -->
    <div class="px-4 space-y-3" id="supplierList">
        <!-- Dynamic Content -->
    </div>

    <!-- 底部操作区 -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-100 z-50 hidden" id="batchActions">
        <button onclick="exportSelected()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg transition-colors flex items-center justify-center">
            <i class="fas fa-file-export mr-2"></i> 批量导出
        </button>
    </div>

    <script>
        let suppliers = [];
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            loadSuppliers();
            renderList();

            document.getElementById('searchInput').addEventListener('input', (e) => {
                renderList(e.target.value);
            });
        });

        function loadSuppliers() {
            // Priority: factoryPresets -> suppliers -> preset_supplier
            const factoryPresets = JSON.parse(localStorage.getItem('factoryPresets') || '{}');
            const separateSuppliers = JSON.parse(localStorage.getItem('suppliers') || '[]');
            const legacySuppliers = JSON.parse(localStorage.getItem('preset_supplier') || '[]');

            if (factoryPresets.suppliers && factoryPresets.suppliers.length > 0) {
                suppliers = factoryPresets.suppliers;
            } else if (separateSuppliers.length > 0) {
                suppliers = separateSuppliers;
            } else if (legacySuppliers.length > 0) {
                suppliers = legacySuppliers;
            } else {
                // Default demo data if nothing exists
                suppliers = [
                    { id: 'SUP001', name: '益海嘉里', type: '生产商', license: '91110000MA01234567', contact: '13800138000', status: 'valid', rating: 4.5, lastPurchase: '2023-10-25' },
                    { id: 'SUP002', name: '安佳', type: '品牌方', license: '913100006072899999', contact: '021-66668888', status: 'valid', rating: 4.8, lastPurchase: '2023-10-20' }
                ];
            }
        }

        function filterList(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.type === type) {
                    btn.className = 'filter-btn active px-4 py-1.5 rounded-full text-sm font-medium bg-orange-500 text-white whitespace-nowrap';
                } else {
                    btn.className = 'filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-white text-gray-600 border border-gray-200 whitespace-nowrap';
                }
            });
            renderList(document.getElementById('searchInput').value);
        }

        function renderList(keyword = '') {
            const container = document.getElementById('supplierList');
            const filtered = suppliers.filter(s => {
                const matchKeyword = s.name.toLowerCase().includes(keyword.toLowerCase());
                const matchFilter = currentFilter === 'all' || s.status === currentFilter; // Note: 'status' needs to be calculated if not present
                return matchKeyword && matchFilter;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 text-gray-400">
                        <i class="fas fa-box-open text-4xl mb-3"></i>
                        <p>暂无相关供应商</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(item => {
                // Calculate status if not explicit (mock logic for demo)
                const status = item.status || 'valid'; 
                let statusColor = 'text-green-500 bg-green-50';
                let statusText = '有效';
                
                if (status === 'expiring') {
                    statusColor = 'text-yellow-500 bg-yellow-50';
                    statusText = '即将到期';
                } else if (status === 'expired') {
                    statusColor = 'text-red-500 bg-red-50';
                    statusText = '已过期';
                }

                const ratingStars = getStarRating(item.rating || 5);

                return `
                    <div class="bg-white rounded-xl p-4 card-shadow" onclick="viewDetail('${item.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${item.name}</h3>
                                <p class="text-xs text-gray-500 mt-0.5">编号: ${item.id}</p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-medium ${statusColor}">${statusText}</span>
                        </div>
                        
                        <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                            <div class="flex items-center">
                                <span class="text-yellow-400 mr-1">${ratingStars}</span>
                                <span class="text-xs text-gray-400">${item.rating || 5.0}分</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center text-xs text-gray-500 border-t border-gray-50 pt-2">
                            <span>最近采购: ${item.lastPurchase || '无记录'}</span>
                            <div class="flex gap-2">
                                <button class="p-1.5 text-blue-500 bg-blue-50 rounded" onclick="event.stopPropagation(); editSupplier('${item.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="p-1.5 text-orange-500 bg-orange-50 rounded" onclick="event.stopPropagation(); evaluateSupplier('${item.id}')">
                                    <i class="fas fa-star"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStarRating(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            let html = '';
            for(let i=0; i<fullStars; i++) html += '<i class="fas fa-star"></i>';
            if(halfStar) html += '<i class="fas fa-star-half-alt"></i>';
            const emptyStars = 5 - Math.ceil(rating);
            for(let i=0; i<emptyStars; i++) html += '<i class="far fa-star"></i>';
            return html;
        }

        function navigateToAdd() {
            // For now, redirect to detail page with 'new' param or just use factory preset modal?
            // The user wants a full management page.
            window.location.href = 'gongyingshang-detail.html?id=new';
        }

        function viewDetail(id) {
            window.location.href = `gongyingshang-detail.html?id=${id}`;
        }

        function editSupplier(id) {
            window.location.href = `gongyingshang-detail.html?id=${id}&edit=true`;
        }
        
        function evaluateSupplier(id) {
             window.location.href = `gongyingshang-detail.html?id=${id}&tab=evaluation`;
        }

        function exportSelected() {
            alert('导出功能开发中...');
        }
    </script>
</body>
</html>