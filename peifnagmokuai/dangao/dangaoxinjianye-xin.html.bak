<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å»ºé…æ–¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet">
    <style>
        /* æ¸å˜è‰²å½©å®šä¹‰ - ä¸é¦–é¡µä¿æŒä¸€è‡´ */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-recipe {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .gradient-message {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .gradient-inventory {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .gradient-order {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        /* å¼ºåˆ¶åˆ·æ–°æš—é»‘æ¨¡å¼çš„è¾…åŠ©ç±» */
        .dark-force-refresh {}
        .dark-handle {}
        
        /* ä¸»é¢˜åŸºç¡€å˜é‡ */
        :root {
            /* Light Theme */
            --light-bg: #f9fafb;
            --light-card-bg: #FFFFFF;
            --light-text: #1E293B;
            --light-border: #e5e7eb;
            --light-hover: #f3f4f6;
            
            /* Dark Theme */
            --dark-bg: #0F172A;
            --dark-card-bg: #1E293B;
            --dark-text: #F1F5F9;
            --dark-border: #334155;
            --dark-hover: #1E3A8A;
            
            /* Japanese Theme */
            --jp-bg: #F7F6F2;
            --jp-card-bg: #FFFCF7;
            --jp-text: #2C2C2C;
            --jp-border: #E5E2D9;
            --jp-accent: #D64F45;
            --jp-hover: #FFF1EC;
            
            /* Korean Theme */
            --kr-bg: #F3F7F6;
            --kr-card-bg: #FFFFFF;
            --kr-text: #363B3A;
            --kr-border: #DDE7E5;
            --kr-accent: #98C6BE;
            --kr-hover: #E8F3F1;
        }

        /* ä¸»é¢˜åˆ‡æ¢å™¨æ ·å¼ */
        .theme-switcher {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            border-radius: 1rem;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            border: 1px solid var(--light-border);
        }

        .theme-option {
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-option:hover {
            transform: scale(1.1);
        }

        .theme-option.active {
            box-shadow: 0 0 0 2px var(--light-border);
        }

        /* Light Theme */
        .theme-light {
            background: var(--light-bg);
            color: var(--light-text);
        }

        .theme-light .card {
            background: var(--light-card-bg);
            border-color: var(--light-border);
        }

        /* Dark Theme */
        .theme-dark {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        .theme-dark .card {
            background: var(--dark-card-bg);
            border-color: var(--dark-border);
        }

        /* Japanese Theme */
        .theme-jp {
            background: var(--jp-bg);
            color: var(--jp-text);
        }

        .theme-jp .card {
            background: var(--jp-card-bg);
            border-color: var(--jp-border);
        }

        .theme-jp .btn-primary {
            background: var(--jp-accent);
        }

        /* Korean Theme */
        .theme-kr {
            background: var(--kr-bg);
            color: var(--kr-text);
        }

        .theme-kr .card {
            background: var(--kr-card-bg);
            border-color: var(--kr-border);
        }

        .theme-kr .btn-primary {
            background: var(--kr-accent);
        }

        /* åŸºç¡€ä¸»é¢˜æ ·å¼ */
        html, body { 
            background: #f9fafb; 
            transition: all 0.3s ease;
        }
        .dark html, .dark body { 
            background: #0F172A; 
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { 
            border-radius: 12px; 
            box-shadow: 0 4px 12px 0 rgba(0,0,0,0.1); 
            background: #FFFFFF; 
            border: 1px solid #e5e7eb; 
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .dark .card { 
            background: #1E293B; 
            box-shadow: 0 4px 20px 0 rgba(0,0,0,0.25); 
            border: 1px solid #334155; 
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        #themeToggleBtn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: white;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .dark #themeToggleBtn {
            background: #334155;
            border-color: #475569;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        #themeToggleBtn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .dark #themeToggleBtn:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* æ–‡æœ¬é¢œè‰² */
        .text-primary {
            color: #1E293B;
            transition: color 0.3s ease;
        }
        .dark .text-primary {
            color: #F1F5F9;
        }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        input, textarea {
            transition: all 0.3s ease;
        }
        .dark input, .dark textarea {
            background: #1E293B;
            color: #F1F5F9;
            border-color: #475569;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn-primary {
            transition: all 0.3s ease;
        }
        .dark .btn-primary {
            background: linear-gradient(135deg, #8B5CF6, #A855F7);
            color: #F1F5F9;
        }

        /* æ­¥éª¤å¡ç‰‡æ ·å¼ */
        .step-card {
            transition: all 0.3s ease;
        }
        .dark .step-card {
            background: #1E293B;
            border-color: #334155;
        }

        .input-shadow:focus { box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); border-color: #667eea; }
        .tab-active { color: #667eea !important; }
        .tab-inactive { color: #6b7280 !important; }
        .tab-bg-active { background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)) !important; border: 1px solid #667eea; }
        .tab-bg-inactive { background: #FFFFFF !important; border: 1px solid #e5e7eb; }
        .dark .tab-bg-active { background: #1E3A8A !important; border: 1px solid #667eea; }
        .dark .tab-bg-inactive { background: #1E293B !important; border: 1px solid #334155; }
        
        /* Tabå›¾æ ‡å®¹å™¨æ ·å¼ */
        .tab-icon-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tab-active .tab-icon-container {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            border-color: #667eea !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3) !important;
            transform: translateY(-1px) scale(1.05);
        }
        .tab-inactive .tab-icon-container {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0) !important;
            border-color: #cbd5e1 !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transform: translateY(0) scale(1);
        }
        .dark .tab-active .tab-icon-container {
            background: linear-gradient(135deg, #667eea, #8b5cf6) !important;
            border-color: #667eea !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4) !important;
        }
        .dark .tab-inactive .tab-icon-container {
            background: linear-gradient(135deg, #334155, #475569) !important;
            border-color: #64748b !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
        }
        .tab-active .tab-icon-container i {
            color: #ffffff !important;
        }
        .tab-inactive .tab-icon-container i {
            color: #64748b !important;
        }
        .dark .tab-inactive .tab-icon-container i {
            color: #94a3b8 !important;
        }
        .transition-all { transition: all 0.2s cubic-bezier(.4,0,.2,1); }
        .bottom-bar { border-radius: 24px 24px 0 0; }
        .group-blue { background: #E8F0FE; }
        .group-yellow { background: #FFF7E0; }
        .group-pink { background: #FDE7EF; }
        .group-green { background: #E6F6EC; }
        .group-gray { background: #F3F4F6; }
        .dark .group-blue { background: #22304a; }
        .dark .group-yellow { background: #4a3e22; }
        .dark .group-pink { background: #4a2230; }
        .dark .group-green { background: #224a30; }
        .dark .group-gray { background: #23272f; }

        .step-row { transition: all 0.3s ease; background: #FFFFFF !important; border: 1px solid #E2E8F0 !important; }
        .step-row:hover { background: #F8FAFC !important; border-color: #CBD5E1 !important; transform: translateY(-1px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .dark .step-row { background: #1E293B !important; border: 1px solid #334155 !important; }
        .dark .step-row:hover { background: #0F172A !important; border-color: #475569 !important; }
        .media-upload-area { transition: all 0.2s ease; background: #F1F5F9; border: 2px dashed #CBD5E1; }
        .media-upload-area:hover { border-color: #8B5CF6 !important; background: rgba(139, 92, 246, 0.05) !important; }
        .dark .media-upload-area { background: #0F172A; border-color: #475569; }
        .media-preview { position: relative; overflow: hidden; }
        .media-preview .remove-btn { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); }
        .step-number { background: linear-gradient(135deg, #667eea, #764ba2); }
        .video-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .crop-container { max-width: 100%; max-height: 400px; }
        .crop-preview { width: 120px; height: 120px; border-radius: 12px; overflow: hidden; border: 2px solid #E2E8F0; }
        .dark .crop-preview { border-color: #334155; }
        
        /* æ­¥éª¤å›¾ç‰‡æ¨ªå‘æ»šåŠ¨æ ·å¼ */
        .snap-x {
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .snap-x::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        .snap-center {
            scroll-snap-align: center;
        }
        


        /* æ·»åŠ å·¦æ»‘åˆ é™¤ç›¸å…³æ ·å¼ */
        .ingredient-item {
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
            transform: translateX(0);
            transition: transform 0.3s ease;
            width: 100%;
        }

        .ingredient-item .delete-action {
            position: absolute;
            right: -80px; /* åˆå§‹æ—¶å®Œå…¨åœ¨è§†å›¾å¤– */
            top: 0;
            bottom: 0;
            width: 80px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            z-index: 10; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
            font-size: 14px;
            text-align: center;
            border-radius: 0 12px 12px 0;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .ingredient-item .delete-action:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: scale(1.05);
        }
        
        .ingredient-item .delete-action:active {
            transform: scale(0.95);
        }

        /* ææ–™è¾“å…¥æ¡†å®¹å™¨æ ·å¼ - ä¸ºçŠ¶æ€æ–‡å­—é¢„ç•™ç©ºé—´ */
        .ingredient-item .flex-1.min-w-\[90px\].relative {
            margin-bottom: 24px;
        }
        
        /* åŒæ­¥çŠ¶æ€æ–‡å­—æ ·å¼ - ä¼˜åŒ–æ˜¾ç¤º */
        .sync-status-text {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 6px;
            border-radius: 6px;
            margin-top: 4px;
            z-index: 15;
            white-space: nowrap;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(4px);
        }
        
        .synced-text {
            color: #059669;
            background: rgba(5, 150, 105, 0.15);
            border: 1px solid rgba(5, 150, 105, 0.2);
        }
        
        .not-synced-text {
            color: #d97706;
            background: rgba(217, 119, 6, 0.15);
            border: 1px solid rgba(217, 119, 6, 0.2);
        }
        
        .dark .synced-text {
            color: #34d399;
            background: rgba(52, 211, 153, 0.2);
            border: 1px solid rgba(52, 211, 153, 0.3);
        }
        
        .dark .not-synced-text {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        
        .dark .base-dough-tip {
            color: #fb923c !important;
            background: rgba(251, 146, 60, 0.2) !important;
            border: 1px solid rgba(251, 146, 60, 0.3) !important;
        }

        .ingredient-item.swiping {
            transition: none;
        }

        /* åŒæ­¥çŠ¶æ€çš„æ ·å¼ */
        .name-input {
            transition: all 0.3s ease;
        }

        .name-input.synced {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.05);
            position: relative;
        }

        .name-input.synced::before {
            content: 'âœ“';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #4CAF50;
            font-weight: bold;
            font-size: 12px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .name-input.not-synced {
            border-color: #F44336;
            background-color: rgba(244, 67, 54, 0.05);
            position: relative;
        }

        .name-input.not-synced::before {
            content: '!';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #F44336;
            font-weight: bold;
            font-size: 12px;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            transition: all 0.3s ease;
        }

        .sync-indicator.synced {
            background-color: #4CAF50;
        }

        .sync-indicator.not-synced {
            background-color: #F44336;
        }



        /* æ–°æ‰‹å¼•å¯¼æ ·å¼ */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
            backdrop-filter: blur(2px);
        }

        .tutorial-highlight {
            position: absolute;
            border: 3px solid #3B82F6;
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 20px rgba(59, 130, 246, 0.8);
            z-index: 10000;
            transition: all 0.3s ease;
            animation: tutorialPulse 2s infinite;
        }

        @keyframes tutorialPulse {
            0%, 100% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 20px rgba(59, 130, 246, 0.8); }
            50% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 30px rgba(59, 130, 246, 1); }
        }

        .tutorial-popup {
            position: fixed;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            max-width: 320px;
            min-width: 280px;
            border: 2px solid #3B82F6;
        }

        .dark .tutorial-popup {
            background: #1E293B;
            color: #F1F5F9;
            border-color: #3B82F6;
        }

        .tutorial-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border: 12px solid transparent;
        }

        .tutorial-arrow.top {
            border-bottom-color: #3B82F6;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
        }

        .tutorial-arrow.bottom {
            border-top-color: #3B82F6;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
        }

        .tutorial-arrow.left {
            border-right-color: #3B82F6;
            left: -24px;
            top: 50%;
            transform: translateY(-50%);
        }

        .tutorial-arrow.right {
            border-left-color: #3B82F6;
            right: -24px;
            top: 50%;
            transform: translateY(-50%);
        }

        .tutorial-step-indicator {
            display: flex;
            gap: 8px;
            margin: 16px 0;
        }

        .tutorial-step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #E5E7EB;
            transition: all 0.3s ease;
        }

        .tutorial-step-dot.active {
            background: #3B82F6;
            transform: scale(1.2);
        }

        .tutorial-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .tutorial-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .tutorial-btn-primary {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            color: white;
        }

        .tutorial-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .tutorial-btn-secondary {
            background: #F3F4F6;
            color: #6B7280;
            border: 1px solid #E5E7EB;
        }

        .tutorial-btn-secondary:hover {
            background: #E5E7EB;
        }

        .dark .tutorial-btn-secondary {
            background: #374151;
            color: #D1D5DB;
            border-color: #4B5563;
        }

        .dark .tutorial-btn-secondary:hover {
            background: #4B5563;
        }

        .tutorial-skip {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #6B7280;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .tutorial-skip:hover {
            color: #374151;
            background: #F3F4F6;
        }

        .dark .tutorial-skip {
            color: #9CA3AF;
        }

        .dark .tutorial-skip:hover {
            color: #D1D5DB;
            background: #374151;
        }
        
        /* ææ–™å¼¹çª—æ ·å¼ */
        .material-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .material-popup-content {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 900px;
            width: 900px;
            height: 600px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
        }
        
        .dark .material-popup-content {
            background: #1e293b;
            border: 1px solid #334155;
        }
        
        .popup-main-content {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        
        .popup-sidebar {
            width: 220px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            padding: 20px 16px;
        }
        
        .dark .popup-sidebar {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-right: 1px solid #334155;
        }
        
        .popup-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        }
        
        .dark .popup-content-area {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        .category-item {
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .category-item:hover {
            background-color: #e0e7ff;
        }
        
        .dark .category-item:hover {
            background-color: #312e81;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-[#0F172A] text-gray-800 dark:text-slate-100">
    <div class="max-w-md mx-auto min-h-screen flex flex-col bg-gray-50 dark:bg-[#0F172A]">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="sticky top-0 z-50 bg-white dark:bg-[#1E293B] flex items-center justify-between px-4 py-3 card border-b border-gray-200 dark:border-slate-600">
            <a href="../../ERPSHOUJI/shouye/shouye-mobile.html" class="text-gray-500 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-[#334155] active:scale-95 transition rounded-full p-2 flex items-center justify-center">
                <i class="fas fa-arrow-left"></i>
            </a>
            <span class="text-lg font-bold flex-1 text-center text-gray-800 dark:text-slate-100 tracking-wide">æ–°å»ºé…æ–¹</span>
            <div class="flex gap-2 items-center">
                <button id="tutorialBtn" class="text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-full p-2 transition" title="æ–°æ‰‹æŒ‡å¼•" onclick="startTutorial()">
                    <i class="fas fa-question-circle"></i>
                </button>
                <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-full p-2 transition" title="æ‹ç…§è¯†åˆ«" onclick="openCamera()"><i class="fas fa-camera-retro"></i></button>
                <!-- è¿˜åŸä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
                <button id="themeToggleBtn" class="ml-2 text-xl hover:bg-gray-100 dark:hover:bg-[#334155] active:scale-90 rounded-full p-2 transition" onclick="toggleTheme()">
                    <span id="themeIcon">ğŸŒ™</span>
                </button>
            </div>
        </div>
        <!-- å›¾ç‰‡ä¸Šä¼ åŒº -->
        <div class="relative mx-4 mt-4 mb-2">
            <input type="file" id="coverImage" class="hidden" accept="image/*">
            <label for="coverImage" class="block w-full h-40 card flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-purple-500 hover:border-purple-600 transition-all">
                <div id="imagePreview" class="w-full h-full flex flex-col items-center justify-center text-purple-600 dark:text-purple-400">
                    <i class="fas fa-camera text-3xl mb-2"></i>
                    <span>ç‚¹å‡»ä¸Šä¼ å°é¢å›¾ç‰‡</span>
                </div>
            </label>
        </div>
        <!-- Tabåˆ‡æ¢åŒº -->
        <div class="flex bg-white dark:bg-[#1E293B] rounded-xl mx-4 mt-2 mb-4 overflow-hidden card">
            <button id="tab-btn-recipe" class="flex-1 flex flex-col items-center py-3 text-center font-semibold tab-btn tab-active tab-bg-active gap-1.5 hover:bg-[#EFF6FF] dark:hover:bg-[#1E3A8A] active:scale-95 transition-all" onclick="switchTab('recipe')">
                <div class="tab-icon-container w-7 h-7 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-sm border border-purple-400">
                    <i class="fas fa-bread-slice text-white text-xs"></i>
                </div>
                <span class="text-xs font-medium">é…æ–¹</span>
            </button>

            <button id="tab-btn-step" class="flex-1 flex flex-col items-center py-3 text-center font-semibold tab-btn tab-inactive tab-bg-inactive gap-1.5 hover:bg-[#EFF6FF] dark:hover:bg-[#1E3A8A] active:scale-95 transition-all" onclick="switchTab('step')">
                <div class="tab-icon-container w-7 h-7 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center shadow-sm border border-green-400">
                    <i class="fas fa-list-ol text-white text-xs"></i>
                </div>
                <span class="text-xs font-medium">æ­¥éª¤</span>
            </button>
        </div>
        <!-- é…æ–¹åŸºç¡€ä¿¡æ¯åŒºï¼ˆä¼˜åŒ–è®¾è®¡ï¼‰ -->
        <div id="recipe-meta-section" class="mx-4 mb-4">
            <div class="card p-4 space-y-4">
                <!-- é…æ–¹åç§°è¾“å…¥ -->
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-gradient-to-br from-purple-500 to-purple-600 rounded-md flex items-center justify-center">
                            <i class="fas fa-signature text-white text-xs"></i>
                        </div>
                        <label class="text-sm font-medium text-gray-800 dark:text-slate-100">é…æ–¹åç§° <span class="text-red-500">*</span></label>
                    </div>
                    <div class="relative">
                        <input type="text" placeholder="è¯·è¾“å…¥é…æ–¹åç§°..." class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 dark:border-slate-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 outline-none bg-white dark:bg-[#1E293B] text-gray-800 dark:text-slate-100 placeholder-gray-400 dark:placeholder-slate-500 transition-all duration-200 hover:border-gray-300 dark:hover:border-slate-500">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">
                            <i class="fas fa-edit text-sm"></i>
                        </div>
                    </div>
                </div>
                
                <!-- åˆ†ç±»é€‰æ‹© -->
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-gradient-to-br from-blue-500 to-blue-600 rounded-md flex items-center justify-center">
                            <i class="fas fa-tags text-white text-xs"></i>
                        </div>
                        <label class="text-sm font-medium text-gray-800 dark:text-slate-100">é€‰æ‹©åˆ†ç±» <span class="text-red-500">*</span></label>
                    </div>
                    <div class="relative">
                        <select id="categorySelect" class="w-full pl-10 pr-12 py-3 rounded-xl border border-gray-200 dark:border-slate-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 outline-none bg-white dark:bg-[#1E293B] text-gray-800 dark:text-slate-100 appearance-none cursor-pointer transition-all duration-200 hover:border-gray-300 dark:hover:border-slate-500">
                            <option value="" class="text-gray-400">è¯·é€‰æ‹©é…æ–¹åˆ†ç±»...</option>
                            <option value="bread">ğŸ é¢åŒ…ç±»</option>
                            <option value="cake">ğŸ‚ è›‹ç³•ç±»</option>
                            <option value="drink">ğŸ¥¤ é¥®å“ç±»</option>
                            <option value="pastry">ğŸ¥ ç³•ç‚¹ç±»</option>
                            <option value="dessert">ğŸ® ç”œå“ç±»</option>
                            <option value="other">ğŸ“¦ å…¶ä»–ç±»</option>
                        </select>
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">
                            <i class="fas fa-layer-group text-sm"></i>
                        </div>

                        <button onclick="openCategoryModal()" class="absolute right-2 top-1/2 -translate-y-1/2 w-7 h-7 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl hover:shadow-lg active:scale-95 transition-all duration-200 flex items-center justify-center" title="æ–°å»ºåˆ†ç±»">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- åŸæ–™åˆ†ç»„åŒºï¼ˆç»Ÿä¸€è®¾è®¡é£æ ¼ï¼‰ -->
        <div class="space-y-3 flex-1 overflow-y-auto px-4 pb-32" id="recipe-section">
            <!-- é…æ–¹è¯´æ˜å¡ç‰‡ -->
            <div class="mt-2 mb-3">
                <div class="card p-3">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-6 h-6 gradient-primary rounded-full flex items-center justify-center">
                            <i class="fas fa-bread-slice text-white text-xs"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 dark:text-slate-100 text-sm">é…æ–¹ç»„æˆ</h3>
                    </div>
                    <p class="text-xs text-gray-600 dark:text-slate-400">æŒ‰åˆ†ç»„ç®¡ç†åŸæ–™é…æ¯”ï¼Œæ”¯æŒç™¾åˆ†æ¯”è®¡ç®—å’Œæˆæœ¬æ ¸ç®—</p>
                </div>
            </div>

            <div class="card p-3 bg-gradient-to-br from-white via-gray-50/30 to-white dark:from-[#1E293B] dark:via-gray-900/10 dark:to-[#1E293B] border-gray-200/50 dark:border-gray-800/30">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <div class="w-7 h-7 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center mr-2 shadow-sm">
                            <i class="fas fa-mortar-pestle text-white text-xs"></i>
                        </div>
                        <div>
                            <input type="text" value="æ­¥éª¤ä¸€" class="font-semibold text-gray-800 dark:text-slate-100 text-sm bg-transparent border-none outline-none focus:bg-white dark:focus:bg-slate-700 focus:border focus:border-gray-300 dark:focus:border-gray-600 rounded px-1 py-0.5 transition-all" maxlength="20">
                            <p class="text-xs text-gray-600 dark:text-gray-400 font-medium">è°ƒå‘³å¢é¦™</p>
                        </div>
                    </div>
                    <button class="bg-gradient-to-r from-gray-500 to-gray-600 text-white hover:shadow-lg active:scale-95 rounded-lg px-3 py-1.5 transition-all flex items-center text-xs font-medium" onclick="addIngredient('aux')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ </span>
                    </button>
                </div>
                <div id="auxIngredients" class="space-y-2"></div>
            </div>

            <div class="card p-3 bg-gradient-to-br from-white via-pink-50/30 to-white dark:from-[#1E293B] dark:via-pink-900/10 dark:to-[#1E293B] border-pink-200/50 dark:border-pink-800/30">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg flex items-center justify-center mr-2 shadow-sm">
                            <i class="fas fa-magic text-white text-xs"></i>
                        </div>
                        <div>
                            <input type="text" value="å˜åŒ–æ¬¾" class="font-semibold text-gray-800 dark:text-slate-100 text-sm bg-transparent border-none outline-none focus:bg-white dark:focus:bg-slate-700 focus:border focus:border-pink-300 dark:focus:border-pink-600 rounded px-1 py-0.5 transition-all" maxlength="20">
                            <p class="text-xs text-pink-600 dark:text-pink-400 font-medium">åˆ›æ„å»¶ä¼¸</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button class="bg-gradient-to-r from-pink-500 to-pink-600 text-white hover:shadow-lg active:scale-95 rounded-lg px-2 py-1 transition-all flex items-center text-xs font-medium" onclick="addIngredient('base2')">
                            <i class="fas fa-plus mr-1"></i>
                            <span>æ·»åŠ </span>
                        </button>
                        <button class="bg-gradient-to-r from-red-500 to-red-600 text-white hover:shadow-lg active:scale-95 rounded-lg px-2 py-1 transition-all flex items-center text-xs font-medium" onclick="removeVariationModule(this)">
                            <i class="fas fa-trash mr-1"></i>
                            <span>åˆ é™¤</span>
                        </button>
                    </div>
                </div>
                <div id="base2Ingredients" class="space-y-2"></div>
                <!-- å˜åŒ–æ¬¾å•ä¸ªé‡é‡å’Œæˆæœ¬æ˜¾ç¤º -->
                <div id="base2SingleStats" class="mt-3 pt-3 border-t border-pink-200 dark:border-pink-800 hidden">
                    <div class="flex items-center justify-between text-xs">
                        <div class="flex items-center gap-4">
                            <div id="base2SingleWeightDiv" class="flex items-center gap-1">
                                <span class="text-gray-600 dark:text-gray-400">å•ä¸ªæ€»é‡:</span>
                                <span id="base2SingleWeight" class="font-semibold text-pink-600 dark:text-pink-400">0g</span>
                            </div>
                            <div id="base2SingleCostDiv" class="flex items-center gap-1">
                                <span class="text-gray-600 dark:text-gray-400">å•ä¸ªæˆæœ¬:</span>
                                <span id="base2SingleCost" class="font-semibold text-green-600 dark:text-green-400">Â¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- æ·»åŠ å˜åŒ–æ¬¾æŒ‰é’® - ç‹¬ç«‹åœ¨å˜åŒ–æ¬¾å¡ç‰‡å¤–é¢ -->
            <div class="mx-4 mt-3">
                <button id="addVariationGroupBtn" class="w-full bg-gradient-to-r from-pink-500 to-pink-600 text-white hover:shadow-lg active:scale-95 rounded-lg px-3 py-2 transition-all flex items-center justify-center text-xs font-medium border border-pink-300 dark:border-pink-700">
                    <i class="fas fa-plus mr-2"></i>
                    <span>æ·»åŠ å˜åŒ–æ¬¾</span>
                </button>
            </div>
        </div>
        

        
        <!-- æ­¥éª¤ç¼–è¾‘åŒºï¼ˆç»Ÿä¸€è®¾è®¡é£æ ¼ï¼‰ -->
        <div class="flex-1 flex flex-col pb-32 hidden" id="step-section">
            <!-- æ­¥éª¤æ“ä½œè¯´æ˜å¡ç‰‡ -->
            <div class="mx-4 mt-2 mb-3">
                <div class="card p-3">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-6 h-6 gradient-primary rounded-full flex items-center justify-center">
                            <i class="fas fa-tasks text-white text-xs"></i>
                        </div>
                        <h3 class="font-semibold text-[#1E293B] dark:text-slate-100 text-sm">åˆ¶ä½œæ­¥éª¤</h3>
                    </div>
                    <p class="text-xs text-slate-600 dark:text-slate-400">è¯¦ç»†è®°å½•æ¯ä¸ªåˆ¶ä½œç¯èŠ‚ï¼Œæ”¯æŒå›¾ç‰‡å’Œè§†é¢‘è¯´æ˜</p>
                </div>
            </div>
            
            <!-- æç¤ºä¿¡æ¯ -->
            <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-2.5 mx-4 mb-3 flex items-center">
                <i class="fas fa-info-circle text-purple-500 mr-2 text-xs"></i>
                <p class="text-xs text-purple-700 dark:text-purple-300">ç‚¹å‡»å›¾ç‰‡æˆ–<i class="fas fa-search-plus mx-1"></i>å›¾æ ‡å¯æŸ¥çœ‹å¤§å›¾</p>
            </div>
            
            <!-- æ­¥éª¤åˆ—è¡¨ -->
            <div id="stepsList" class="px-4 space-y-4"></div>
            
            <!-- æ·»åŠ æ­¥éª¤æŒ‰é’® -->
            <div class="px-4 mt-3">
                <button class="w-full py-2.5 rounded-lg card text-purple-600 dark:text-purple-400 font-medium hover:bg-purple-50 dark:hover:bg-purple-900/20 active:scale-95 transition-all border border-slate-200 dark:border-slate-600 text-sm" onclick="addStep()">
                    <i class="fas fa-plus mr-2 text-xs"></i> æ·»åŠ æ­¥éª¤
                </button>
            </div>
        </div>
        <!-- åº•éƒ¨å›ºå®šæ ï¼šæ€»é‡å¡ç‰‡+æ€»æˆæœ¬å¡ç‰‡+ä¿å­˜æŒ‰é’®å¹¶åˆ— -->
        <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-[#1E293B] py-2 px-4 z-50 card bottom-bar border-t border-gray-200 dark:border-slate-600">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="rounded-lg border border-gray-200 dark:border-slate-600 bg-gray-50 dark:bg-[#0F172A] px-2.5 py-1.5 flex flex-col items-center">
                        <div class="text-gray-600 dark:text-slate-400 text-xs">é¢å›¢æ€»é‡</div>
                        <div class="text-xs font-bold text-purple-600 dark:text-purple-400"><span id="totalWeight">0</span></div>
                    </div>
                    <div class="rounded-lg border border-gray-200 dark:border-slate-600 bg-gray-50 dark:bg-[#0F172A] px-2.5 py-1.5 flex flex-col items-center">
                        <div class="text-gray-600 dark:text-slate-400 text-xs">æ€»æˆæœ¬</div>
                        <div class="text-xs font-bold text-green-600 dark:text-green-400">Â¥<span id="totalCost">0.00</span></div>
                    </div>
                </div>
                <button id="saveBtn" class="gradient-primary hover:from-[#764ba2] hover:to-[#667eea] active:scale-95 text-white px-3 py-1.5 rounded-lg font-medium text-xs shadow-md transition-all">ä¿å­˜é…æ–¹</button>
            </div>
        </div>
        
        <!-- å›¾ç‰‡å…¨å±é¢„è§ˆ -->
        <div id="fullImageModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden" onclick="this.classList.add('hidden')">
            <img src="" alt="å›¾ç‰‡å¤§å›¾" class="max-w-[90vw] max-h-[90vh] object-contain rounded-xl">
            <button class="absolute top-4 right-4 bg-white bg-opacity-20 text-white rounded-full p-3 hover:bg-opacity-40 transition-all" onclick="event.stopPropagation(); this.parentElement.classList.add('hidden')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- å•ä½é€‰æ‹©å¼¹çª—ï¼ˆå¸¸é©»DOMï¼Œé»˜è®¤hiddenï¼‰ -->
        <div id="unit-popup" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm transition-all hidden">
            <div class="bg-white dark:bg-[#1E293B] rounded-2xl p-6 min-w-[300px] max-w-[90vw] shadow-2xl border border-slate-200 dark:border-slate-600 transform transition-all">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-slate-100">é€‰æ‹©å•ä½</h3>
                    <button onclick="closeUnitSelect()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                        <i class="fas fa-times"></i>
                    </button>
            </div>
                
                <!-- Tabåˆ‡æ¢æŒ‰é’®ç»„ -->
                <div class="flex gap-2 mb-6 bg-slate-100 dark:bg-slate-800 p-1 rounded-xl" id="unit-tab-btns">
                    <!-- TabæŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
                
                <!-- å•ä½åˆ—è¡¨å®¹å™¨ -->
                <div id="unit-popup-list" class="grid grid-cols-3 gap-2 max-h-[40vh] overflow-y-auto pr-2 mb-4">
                    <!-- å•ä½é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ææ–™åç§°æ£€ç´¢å¼¹çª—ï¼ˆå¸¸é©»DOMï¼Œé»˜è®¤hiddenï¼‰ -->
        <div id="material-popup" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 backdrop-blur-sm hidden">
            <div class="bg-white dark:bg-[#1E293B] rounded-2xl p-4 max-w-4xl w-full mx-4 border border-slate-200 dark:border-slate-600 shadow-2xl max-h-[70vh] flex flex-col overflow-hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 gradient-primary rounded-lg flex items-center justify-center shadow-lg">
                            <i class="fas fa-search text-white text-sm"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-800 dark:text-slate-100">é€‰æ‹©ææ–™æˆ–é…æ–¹</h2>
                    </div>
                    <button onclick="closeMaterialSearch()" class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-slate-400 hover:bg-gray-200 dark:hover:bg-slate-600 hover:text-gray-700 dark:hover:text-slate-200 active:scale-95 transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
                
                <!-- æœç´¢å’Œè‡ªå®šä¹‰ææ–™è¾“å…¥åŒºåŸŸ -->
                <div class="mb-4 p-3 bg-gradient-to-r from-purple-50 to-amber-50 dark:from-purple-900/20 dark:to-amber-900/20 rounded-xl border border-purple-200/50 dark:border-purple-800/50 shadow-sm">
                    <div class="flex items-start gap-2 mb-2">
                        <div class="w-6 h-6 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-amber-600 dark:text-amber-400 text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs font-semibold text-amber-700 dark:text-amber-300 mb-1">
                                è‡ªå®šä¹‰ææ–™æç¤º
                            </div>
                            <div class="text-xs text-amber-600 dark:text-amber-400 leading-relaxed">
                                è‡ªå®šä¹‰ææ–™ä¸ä¼šåŒæ­¥ææ–™åº“çš„æˆæœ¬æ•°æ®ï¼Œé…æ–¹è®¡ç®—æ—¶æ­¤ææ–™æˆæœ¬ä¸º0
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1 relative">
                            <input type="text" id="custom-material-input" placeholder="æœç´¢ææ–™æˆ–è¾“å…¥è‡ªå®šä¹‰ææ–™åç§°..." 
                                   class="w-full pl-10 pr-3 py-2.5 rounded-lg border border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 outline-none bg-white dark:bg-[#0F172A] text-gray-800 dark:text-slate-100 placeholder-gray-400 dark:placeholder-slate-500 transition-all duration-200 shadow-sm text-sm"
                                   oninput="filterMaterialAndRecipes(this.value)">
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-slate-500">
                                <i class="fas fa-search text-xs"></i>
                            </div>
                        </div>
                        <button onclick="confirmCustomMaterial()" class="px-4 py-2.5 gradient-primary hover:from-[#764ba2] hover:to-[#667eea] text-white rounded-lg font-semibold transition-all active:scale-95 shadow-lg flex items-center gap-1 text-sm">
                            <i class="fas fa-check text-xs"></i>
                            <span>ç¡®è®¤</span>
                        </button>
                    </div>
                </div>
                
                <!-- åˆ†åŒºæ ‡ç­¾ -->
                <div class="flex mb-4 bg-gray-100 dark:bg-slate-700 rounded-lg p-1 shadow-inner">
                    <button id="materials-tab" class="flex-1 py-2 px-3 rounded-md text-sm font-semibold transition-all duration-200 bg-white dark:bg-slate-600 text-purple-600 dark:text-purple-400 shadow-md" onclick="switchMaterialTab('materials')">
                        <i class="fas fa-seedling mr-1 text-xs"></i>ææ–™
                    </button>
                    <button id="recipes-tab" class="flex-1 py-2 px-3 rounded-md text-sm font-semibold transition-all duration-200 text-gray-600 dark:text-slate-400 hover:text-gray-800 dark:hover:text-slate-200 hover:bg-white/50 dark:hover:bg-slate-600/50" onclick="switchMaterialTab('recipes')">
                        <i class="fas fa-book mr-1 text-xs"></i>é…æ–¹
                    </button>
                </div>
                
                <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
                <div class="flex-1 flex gap-4 min-h-0">
                    <!-- ææ–™åŒºåŸŸ -->
                    <div id="materials-section" class="flex gap-4 w-full">
                        <!-- å·¦ä¾§ç±»åˆ«åˆ—è¡¨ -->
                        <div class="w-[30%] flex-shrink-0">
                            <div class="bg-gradient-to-b from-gray-50 to-gray-100 dark:from-slate-800 dark:to-slate-900 rounded-xl p-3 h-full flex flex-col shadow-sm border border-gray-200/50 dark:border-slate-700/50">
                                <div class="text-sm font-semibold text-gray-700 dark:text-slate-300 mb-3 px-1 flex items-center gap-2">
                                    <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                    <span>ç±»åˆ«</span>
                                </div>
                                <div id="material-category-list" class="space-y-1 overflow-y-auto flex-1 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-slate-600">
                                    <!-- åŠ¨æ€ç”Ÿæˆçš„ç±»åˆ«åˆ—è¡¨ -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ææ–™åˆ—è¡¨ -->
                        <div class="w-[70%] min-w-0">
                            <div class="bg-gradient-to-b from-gray-50/50 to-white dark:from-slate-800/50 dark:to-slate-900 rounded-xl p-3 h-full border border-gray-200/50 dark:border-slate-700/50 shadow-sm">
                                <div id="material-popup-list" class="flex flex-col gap-2 pr-2 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-slate-600 max-h-full overflow-y-auto">
                                    <!-- åŠ¨æ€ç”Ÿæˆçš„ææ–™åˆ—è¡¨ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é…æ–¹åŒºåŸŸ -->
                    <div id="recipes-section" class="flex gap-4 w-full hidden">
                        <!-- å·¦ä¾§ç±»åˆ«åˆ—è¡¨ -->
                        <div class="w-[30%] flex-shrink-0">
                            <div class="bg-gradient-to-b from-gray-50 to-gray-100 dark:from-slate-800 dark:to-slate-900 rounded-xl p-3 h-full flex flex-col shadow-sm border border-gray-200/50 dark:border-slate-700/50">
                                <div class="text-sm font-semibold text-gray-700 dark:text-slate-300 mb-3 px-1 flex items-center gap-2">
                                    <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                    <span>ç±»åˆ«</span>
                                </div>
                                <div id="recipe-category-list" class="space-y-1 overflow-y-auto flex-1 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-slate-600">
                                    <!-- åŠ¨æ€ç”Ÿæˆçš„ç±»åˆ«åˆ—è¡¨ -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§é…æ–¹åˆ—è¡¨ -->
                        <div class="w-[70%] min-w-0">
                            <div class="bg-gradient-to-b from-gray-50/50 to-white dark:from-slate-800/50 dark:to-slate-900 rounded-xl p-3 h-full border border-gray-200/50 dark:border-slate-700/50 shadow-sm">
                                <div id="recipe-popup-list" class="flex flex-col gap-2 pr-2 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-slate-600 max-h-full overflow-y-auto">
                                    <!-- åŠ¨æ€ç”Ÿæˆçš„é…æ–¹åˆ—è¡¨ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-t border-gray-200/50 dark:border-slate-600/50">
                    <div class="flex justify-center">
                        <button onclick="closeMaterialSearch()" class="px-6 py-2 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all font-semibold shadow-sm border border-gray-200 dark:border-slate-600 text-sm">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å•ä½é€‰æ‹©å¼¹çª— -->
        <div id="unit-selector-popup" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-30 hidden">
            <div class="bg-white dark:bg-[#1E293B] card p-4 min-w-[200px] border border-gray-200 dark:border-slate-600">
                <div class="font-semibold mb-3 text-gray-800 dark:text-slate-100">é€‰æ‹©å•ä½</div>
                <div id="unit-selector-list" class="grid grid-cols-3 gap-2 mb-3"></div>
                <button onclick="closeUnitSelector()" class="w-full py-1 rounded bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
            </div>
        </div>
        <!-- æ–°å»ºç±»åˆ«å¼¹çª— -->
        <div id="categoryModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-30 hidden">
            <div class="bg-white dark:bg-[#1E293B] card p-6 min-w-[220px] border border-slate-200 dark:border-slate-600">
                <div class="font-semibold mb-2 text-gray-800 dark:text-slate-100">æ–°å»ºç±»åˆ«</div>
                <input id="newCategoryInput" class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-slate-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 outline-none bg-white dark:bg-[#0F172A] text-gray-800 dark:text-slate-100 mb-3" placeholder="è¾“å…¥æ–°ç±»åˆ«åç§°">
                <div class="flex gap-2">
                    <button onclick="closeCategoryModal()" class="flex-1 py-2 rounded bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
                    <button onclick="addNewCategory()" class="flex-1 py-2 rounded gradient-primary text-white font-semibold hover:from-[#764ba2] hover:to-[#667eea] active:scale-95 transition-all">ç¡®å®š</button>
                </div>
            </div>
        </div>
        

        
        <!-- æ­¥éª¤æ“ä½œèœå•å¼¹çª— -->
        <div id="stepMenuModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white dark:bg-white rounded-2xl shadow-2xl p-0 max-w-xs w-full mx-4 overflow-hidden">
                <button id="stepMenuDelete" class="w-full px-6 py-4 text-red-600 text-lg font-medium hover:bg-red-50 active:bg-red-100 transition border-b border-gray-200">
                    åˆ é™¤
                </button>
                <button id="stepMenuAdd" class="w-full px-6 py-4 text-purple-600 text-lg font-medium hover:bg-purple-50 active:bg-purple-100 transition border-b border-gray-200">
                    æ·»åŠ ä¸€è¡Œ
                </button>
                <button onclick="closeStepMenuModal()" class="w-full px-6 py-4 text-gray-600 text-lg font-medium hover:bg-gray-50 active:bg-gray-100 transition">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
        
        <!-- åª’ä½“ä¸Šä¼ é€‰æ‹©å¼¹çª— -->
        <div id="mediaUploadModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white dark:bg-white rounded-2xl shadow-2xl p-0 max-w-xs w-full mx-4 overflow-hidden">
                <button onclick="selectImage()" class="w-full px-6 py-4 text-purple-600 text-lg font-medium hover:bg-purple-50 active:bg-purple-100 transition border-b border-gray-200">
                    <i class="fas fa-image mr-2"></i>é€‰æ‹©å›¾ç‰‡
                </button>
                <button onclick="selectVideo()" class="w-full px-6 py-4 text-green-600 text-lg font-medium hover:bg-green-50 active:bg-green-100 transition border-b border-gray-200">
                    <i class="fas fa-video mr-2"></i>é€‰æ‹©è§†é¢‘
                </button>
                <button onclick="captureMedia()" class="w-full px-6 py-4 text-purple-600 text-lg font-medium hover:bg-purple-50 active:bg-purple-100 transition border-b border-gray-200">
                    <i class="fas fa-camera mr-2"></i>æ‹ç…§/å½•åƒ
                </button>
                <button onclick="closeMediaUploadModal()" class="w-full px-6 py-4 text-gray-600 text-lg font-medium hover:bg-gray-50 active:bg-gray-100 transition">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
        
        <!-- å›¾ç‰‡è£å‰ªå¼¹çª— -->
        <div id="cropModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white dark:bg-[#1E293B] rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 border border-slate-200 dark:border-slate-600">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-gray-800 dark:text-slate-100 font-semibold text-lg">è£å‰ªå›¾ç‰‡</h3>
                    <button onclick="closeCropModal()" class="text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xl active:scale-90 transition">Ã—</button>
                </div>
                
                <div class="space-y-4">
                    <!-- è£å‰ªåŒºåŸŸ -->
                    <div class="crop-container">
                        <img id="cropImage" style="max-width: 100%; display: block;">
                    </div>
                    
                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-slate-600 dark:text-slate-400">é¢„è§ˆæ•ˆæœï¼š</div>
                        <div class="crop-preview" id="cropPreview"></div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex gap-3">
                        <button onclick="closeCropModal()" class="flex-1 py-2 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
                        <button onclick="confirmCrop()" class="flex-1 py-2 rounded-lg gradient-primary text-white font-semibold hover:from-[#764ba2] hover:to-[#667eea] active:scale-95 transition-all">ç¡®å®šè£å‰ª</button>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- åˆ†äº«å¼¹çª— -->
    <div id="shareModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white dark:bg-[#1E293B] rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 border border-slate-200 dark:border-slate-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-gray-800 dark:text-slate-100 font-semibold text-2xl">åˆ†äº«é£Ÿè°±</h3>
                <button onclick="closeShareModal()" class="text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xl active:scale-90 transition">Ã—</button>
            </div>
            
            <div class="mb-8">
                <p class="text-slate-600 dark:text-slate-400 mb-2">é€‰æ‹©åˆ†äº«å¹³å°</p>
                
                <!-- å›½å†…å¹³å° -->
                <div class="mainland-platforms">
                    <h4 class="text-xl font-medium mb-4">å›½å†…</h4>
                    <div class="grid grid-cols-4 gap-6">
                        <!-- å¾®ä¿¡æœ‹å‹åœˆ -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('wechat')">
                            <div class="w-14 h-14 bg-[#4CCA5A] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-weixin text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">å¾®ä¿¡æœ‹å‹åœˆ</span>
                        </div>
                        <!-- æŠ–éŸ³ -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('douyin')">
                            <div class="w-14 h-14 bg-black rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-tiktok text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">æŠ–éŸ³</span>
                        </div>
                        <!-- å°çº¢ä¹¦ -->
                        <div class="flex flex-col items-center" onclick="openXiaohongshuModal()">
                            <div class="w-14 h-14 bg-[#FE2C55] rounded-full flex items-center justify-center mb-2">
                                <i class="fas fa-book text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">å°çº¢ä¹¦</span>
                        </div>
                        <!-- çƒ˜åŒ å¹³å° -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('hongjang')">
                            <div class="w-14 h-14 bg-[#FF9F2E] rounded-full flex items-center justify-center mb-2">
                                <i class="fas fa-bread-slice text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">çƒ˜åŒ å¹³å°</span>
                        </div>
                    </div>
                </div>
                
                <!-- å›½å¤–å¹³å° -->
                <div class="foreign-platforms hidden">
                    <h4 class="text-xl font-medium mb-4 mt-6">å›½å¤–</h4>
                    <div class="grid grid-cols-4 gap-6">
                        <!-- Instagram -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('instagram')">
                            <div class="w-14 h-14 bg-gradient-to-tr from-[#FF8A00] via-[#DD2A7B] to-[#8134AF] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-instagram text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">Instagram</span>
                        </div>
                        <!-- Facebook -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('facebook')">
                            <div class="w-14 h-14 bg-[#1877F2] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-facebook-f text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">Facebook</span>
                        </div>
                        <!-- LINE -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('line')">
                            <div class="w-14 h-14 bg-[#06C755] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-line text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">LINE</span>
                        </div>
                        <!-- Twitter -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('twitter')">
                            <div class="w-14 h-14 bg-[#1DA1F2] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-twitter text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">Twitter</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-6 mt-6">
                        <!-- Telegram -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('telegram')">
                            <div class="w-14 h-14 bg-[#0088CC] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-telegram-plane text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">Telegram</span>
                        </div>
                        <!-- KakaoTalk -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('kakaotalk')">
                            <div class="w-14 h-14 bg-[#FEE500] rounded-full flex items-center justify-center mb-2">
                                <i class="fas fa-comment text-black text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">KakaoTalk</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å–æ¶ˆæŒ‰é’® -->
            <div class="w-full">
                <button onclick="closeShareModal()" class="w-full py-4 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-medium text-lg hover:bg-gray-200 dark:hover:bg-gray-700 active:scale-95 transition-all">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    
    <!-- å°çº¢ä¹¦åˆ†äº«ç•Œé¢ -->
    <div id="xiaohongshuShareModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white dark:bg-[#1E293B] rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 border border-slate-200 dark:border-slate-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-gray-800 dark:text-slate-100 font-semibold text-2xl">åˆ†äº«åˆ°å°çº¢ä¹¦</h3>
                <button onclick="closeXiaohongshuModal()" class="text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xl active:scale-90 transition">Ã—</button>
            </div>
            
            <div class="space-y-6">
                <!-- ç”¨æˆ·IDå’Œçƒ˜åŒ APPæ¨å¹¿ä¿¡æ¯ -->
                <div class="bg-[#FFF9F9] dark:bg-[#2D1B1B] p-4 rounded-lg border border-[#FFDED8] dark:border-[#4D2D2A]">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-[#FE2C55] rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500 dark:text-slate-400">ç”¨æˆ·ID</p>
                            <p class="font-semibold" id="shareUserId">YJ238961</p>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-slate-400">
                        åˆ†äº«æ­¤é…æ–¹ï¼Œé‚€è¯·æœ‹å‹ä¸€èµ·ä½¿ç”¨<span class="text-[#FE2C55] font-bold">ã€çƒ˜åŒ APPã€‘</span>åˆ¶ä½œç¾é£Ÿï¼
                    </div>
                </div>
                
                <!-- åˆ†äº«å†…å®¹é¢„è§ˆ -->
                <div class="border border-slate-200 dark:border-slate-600 rounded-lg p-4">
                    <h4 class="font-medium mb-2">åˆ†äº«å†…å®¹é¢„è§ˆ</h4>
                    <div class="flex items-start">
                        <div class="w-20 h-20 bg-slate-100 dark:bg-slate-700 rounded-lg overflow-hidden flex-shrink-0 mr-3">
                            <img src="" alt="é…æ–¹å°é¢" id="sharePreviewImage" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <p class="font-medium mb-1" id="shareRecipeTitle">ç»å…¸åå¸é¢åŒ…é…æ–¹</p>
                            <p class="text-sm text-gray-600 dark:text-slate-400 line-clamp-2" id="shareRecipeDesc">æ¾è½¯é¦™ç”œçš„ç»å…¸åå¸ï¼Œå†…éƒ¨ç»„ç»‡ç»†è…»ï¼Œå…¥å£å³åŒ–ï¼Œé…æ–¹ç®€å•æ˜“ä¸Šæ‰‹ï¼</p>
                        </div>
                    </div>
                </div>
                
                <!-- æ¨å¹¿æ–‡æ¡ˆè¾“å…¥ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">æ·»åŠ æ¨å¹¿æ–‡æ¡ˆ</label>
                    <textarea class="w-full p-3 rounded-lg border border-gray-200 dark:border-slate-600 bg-white dark:bg-[#1E293B] text-gray-900 dark:text-slate-100 placeholder-gray-400" rows="3" placeholder="æ·»åŠ æ–‡æ¡ˆï¼Œè®©æ›´å¤šäººçœ‹åˆ°ä½ çš„ä½œå“...">ä»Šå¤©åˆ†äº«ä¸€æ¬¾è¶…å¥½åƒçš„é¢åŒ…é…æ–¹ï¼Œåœ¨çƒ˜åŒ APPä¸Šæ‰¾åˆ°çš„ï¼æ¨èå¤§å®¶éƒ½æ¥è¯•è¯•~ #çƒ˜ç„™ #é¢åŒ… #çƒ˜åŒ APP</textarea>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex gap-3">
                    <button onclick="closeXiaohongshuModal()" class="flex-1 py-3 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 font-medium hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
                    <button onclick="confirmXiaohongshuShare()" class="flex-1 py-3 rounded-lg bg-[#FE2C55] text-white font-medium hover:bg-[#E82147] active:scale-95 transition-all">åˆ†äº«åˆ°å°çº¢ä¹¦</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ‹ç…§è¯†åˆ«ç•Œé¢ -->
    <div id="cameraModal" class="fixed z-50 left-0 top-0 w-full h-full bg-black flex flex-col hidden">
        <!-- ç›¸æœºé¢„è§ˆåŒºåŸŸ -->
        <div id="cameraPreview" class="flex-1 bg-black hidden">
            <!-- å®é™…åº”ç”¨ä¸­è¿™é‡Œä¼šæ˜¾ç¤ºç›¸æœºé¢„è§ˆ -->
            <div class="w-full h-full relative overflow-hidden">
                <!-- æ¨¡æ‹Ÿç›¸æœºç•Œé¢ -->
                <div class="absolute inset-0 bg-gradient-to-b from-gray-700 to-gray-900 flex items-center justify-center">
                    <div class="text-white text-5xl opacity-30">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                
                <!-- æ‹ç…§é—ªå…‰æ•ˆæœ -->
                <div id="cameraFlash" class="absolute inset-0 bg-white hidden opacity-0 transition-opacity duration-200"></div>
                
                <!-- ç›¸æœºç½‘æ ¼å’Œå¯¹ç„¦å›¾æ ‡ -->
                <div class="absolute inset-0 grid grid-cols-3 grid-rows-3 pointer-events-none">
                    <div class="border-r border-b border-white/20"></div>
                    <div class="border-r border-l border-b border-white/20"></div>
                    <div class="border-l border-b border-white/20"></div>
                    <div class="border-r border-t border-b border-white/20"></div>
                    <div class="border-r border-l border-t border-b border-white/20 flex items-center justify-center">
                        <div class="w-12 h-12 border-2 border-purple-400 rounded-full opacity-50"></div>
                    </div>
                    <div class="border-l border-t border-b border-white/20"></div>
                    <div class="border-r border-t border-white/20"></div>
                    <div class="border-r border-l border-t border-white/20"></div>
                    <div class="border-l border-t border-white/20"></div>
                </div>
            </div>
        </div>
        
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="absolute top-0 left-0 right-0 p-4">
            <button class="text-white hover:bg-black/30 active:scale-95 transition rounded-full p-2" onclick="closeCamera()">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
        </div>
        
        <!-- åº•éƒ¨æ“ä½œåŒº -->
        <div class="bg-black py-6 px-4">
            <!-- è¯´æ˜æ–‡å­— -->
            <div class="text-white text-center mb-6">
                <p class="text-sm">æ‰‹å†™/ç”µå­é…æ–¹æœ¬ è‡ªåŠ¨è¯†åˆ«å¯å¿«é€Ÿåˆ›å»ºé…æ–¹</p>
            </div>
            
            <!-- æ‹ç…§æŒ‰é’® -->
            <div class="flex justify-center items-center">
                <button class="w-16 h-16 rounded-full bg-white flex items-center justify-center active:scale-95 transition" onclick="takePhoto()">
                    <div class="w-14 h-14 border-2 border-gray-300 rounded-full"></div>
                </button>
            </div>
        </div>
    </div>
    </div>
    <script>
        // åˆå§‹åŒ–æ‹–æ‹½æ’åº
        document.querySelectorAll('[id$="Ingredients"]').forEach(el => {
            new Sortable(el, {
                handle: '.drag-handle',
                animation: 150
            });

        // æ–°æ‰‹å¼•å¯¼åŠŸèƒ½
        let currentTutorialStep = 0;
        let tutorialSteps = [
            {
                target: '#coverImage',
                title: 'ä¸Šä¼ é…æ–¹å°é¢',
                content: 'ç‚¹å‡»è¿™é‡Œå¯ä»¥ä¸ºæ‚¨çš„é…æ–¹æ·»åŠ ä¸€å¼ ç²¾ç¾çš„å°é¢å›¾ç‰‡ï¼Œè®©é…æ–¹æ›´åŠ ç”ŸåŠ¨æœ‰è¶£ï¼',
                position: 'bottom'
            },
            {
                target: '.flex.bg-white.dark\\:bg-\\[\\#1E293B\\].rounded-xl.mx-4.mt-2.mb-4',
                title: 'é€‰æ‹©ç¼–è¾‘æ¨¡å¼',
                content: 'è¿™é‡Œæœ‰ä¸¤ä¸ªæ ‡ç­¾é¡µï¼šé…æ–¹ç”¨äºæ·»åŠ åŸæ–™ï¼Œæ­¥éª¤ç”¨äºè¯¦ç»†åˆ¶ä½œè¯´æ˜ã€‚',
                position: 'bottom'
            },
            {
                target: '#recipe-meta-section',
                title: 'å¡«å†™åŸºæœ¬ä¿¡æ¯',
                content: 'åœ¨è¿™é‡Œè¾“å…¥é…æ–¹åç§°å¹¶é€‰æ‹©åˆé€‚çš„åˆ†ç±»ï¼Œè¿™äº›ä¿¡æ¯æœ‰åŠ©äºæ›´å¥½åœ°ç®¡ç†æ‚¨çš„é…æ–¹ã€‚',
                position: 'bottom'
            },


            {
                target: '#tab-btn-step',
                title: 'åˆ¶ä½œæ­¥éª¤',
                content: 'åœ¨æ­¥éª¤æ ‡ç­¾é¡µä¸­ï¼Œæ‚¨å¯ä»¥æ·»åŠ è¯¦ç»†çš„åˆ¶ä½œæ­¥éª¤ï¼ŒåŒ…æ‹¬æ–‡å­—è¯´æ˜ã€å›¾ç‰‡å’Œè§†é¢‘ã€‚',
                position: 'bottom'
            },
            {
                target: '#saveBtn',
                title: 'ä¿å­˜é…æ–¹',
                content: 'å®Œæˆé…æ–¹ç¼–è¾‘åï¼Œç‚¹å‡»ä¿å­˜æŒ‰é’®å°†æ‚¨çš„é…æ–¹ä¿å­˜åˆ°ç³»ç»Ÿä¸­ã€‚æ­å–œæ‚¨å®Œæˆäº†æ–°æ‰‹å¼•å¯¼ï¼',
                position: 'top'
            },
            {
                target: '#photoCreateBtn',
                title: 'æ‹ç…§å¿«é€Ÿåˆ›å»ºé…æ–¹',
                content: 'é€šè¿‡æ‹ç…§è¯†åˆ«åŠŸèƒ½ï¼Œå¿«é€Ÿåˆ›å»ºæ‚¨çš„é…æ–¹ï¼ŒèŠ‚çœè¾“å…¥æ—¶é—´ã€‚',
                position: 'bottom'
            },
            {
                target: '#recipeNameInput',
                title: 'é…æ–¹æ–°å»º - åå­—',
                content: 'åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„é…æ–¹åç§°ï¼Œä¾¿äºç®¡ç†å’ŒæŸ¥æ‰¾ã€‚',
                position: 'right'
            },
            {
                target: '#categorySelect',
                title: 'é€‰æ‹©ç±»åˆ«',
                content: 'é€‰æ‹©é…æ–¹æ‰€å±çš„ç±»åˆ«ï¼Œæ–¹ä¾¿åˆ†ç±»ç®¡ç†ã€‚',
                position: 'right'
            },

        ];

        function startTutorial() {
            currentTutorialStep = 0;
            document.getElementById('tutorialOverlay').style.display = 'block';
            showTutorialStep();
            generateStepIndicator();
        }

        function endTutorial() {
            document.getElementById('tutorialOverlay').style.display = 'none';
            currentTutorialStep = 0;
        }

        function nextTutorialStep() {
            if (currentTutorialStep < tutorialSteps.length - 1) {
                currentTutorialStep++;
                showTutorialStep();
                updateStepIndicator();
            } else {
                endTutorial();
            }
        }

        function previousTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                showTutorialStep();
                updateStepIndicator();
            }
        }

        function showTutorialStep() {
            const step = tutorialSteps[currentTutorialStep];
            const targetElement = document.querySelector(step.target);
            
            if (!targetElement) {
                console.warn('Tutorial target not found:', step.target);
                return;
            }

            // æ›´æ–°å¼•å¯¼å†…å®¹
            document.getElementById('tutorialTitle').textContent = step.title;
            document.getElementById('tutorialContent').textContent = step.content;

            // é«˜äº®ç›®æ ‡å…ƒç´ 
            highlightElement(targetElement);

            // å®šä½å¼¹çª—
            positionTutorialPopup(targetElement, step.position);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateTutorialButtons();
        }

        function highlightElement(element) {
            const rect = element.getBoundingClientRect();
            const highlight = document.getElementById('tutorialHighlight');
            
            // æ·»åŠ ä¸€äº›å†…è¾¹è·ä½¿é«˜äº®åŒºåŸŸæ›´å¤§
            const padding = 8;
            
            highlight.style.left = (rect.left - padding) + 'px';
            highlight.style.top = (rect.top - padding) + 'px';
            highlight.style.width = (rect.width + padding * 2) + 'px';
            highlight.style.height = (rect.height + padding * 2) + 'px';
        }

        function positionTutorialPopup(targetElement, position) {
            const popup = document.getElementById('tutorialPopup');
            const arrow = document.getElementById('tutorialArrow');
            const rect = targetElement.getBoundingClientRect();
            const popupRect = popup.getBoundingClientRect();
            
            // æ¸…é™¤ä¹‹å‰çš„ç®­å¤´ç±»
            arrow.className = 'tutorial-arrow';
            
            let left, top;
            
            switch (position) {
                case 'top':
                    left = rect.left + rect.width / 2 - popupRect.width / 2;
                    top = rect.top - popupRect.height - 30;
                    arrow.classList.add('bottom');
                    break;
                case 'bottom':
                    left = rect.left + rect.width / 2 - popupRect.width / 2;
                    top = rect.bottom + 30;
                    arrow.classList.add('top');
                    break;
                case 'left':
                    left = rect.left - popupRect.width - 30;
                    top = rect.top + rect.height / 2 - popupRect.height / 2;
                    arrow.classList.add('right');
                    break;
                case 'right':
                    left = rect.right + 30;
                    top = rect.top + rect.height / 2 - popupRect.height / 2;
                    arrow.classList.add('left');
                    break;
                default:
                    left = rect.left + rect.width / 2 - popupRect.width / 2;
                    top = rect.bottom + 30;
                    arrow.classList.add('top');
            }
            
            // ç¡®ä¿å¼¹çª—ä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç•Œ
            const margin = 20;
            left = Math.max(margin, Math.min(left, window.innerWidth - popupRect.width - margin));
            top = Math.max(margin, Math.min(top, window.innerHeight - popupRect.height - margin));
            
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
        }

        function generateStepIndicator() {
            const indicator = document.getElementById('tutorialStepIndicator');
            indicator.innerHTML = '';
            
            for (let i = 0; i < tutorialSteps.length; i++) {
                const dot = document.createElement('div');
                dot.className = 'tutorial-step-dot';
                if (i === currentTutorialStep) {
                    dot.classList.add('active');
                }
                indicator.appendChild(dot);
            }
        }

        function updateStepIndicator() {
            const dots = document.querySelectorAll('.tutorial-step-dot');
            dots.forEach((dot, index) => {
                if (index === currentTutorialStep) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        function updateTutorialButtons() {
            const prevBtn = document.getElementById('tutorialPrevBtn');
            const nextBtn = document.getElementById('tutorialNextBtn');
            const finishBtn = document.getElementById('tutorialFinishBtn');
            
            // æ˜¾ç¤º/éšè—ä¸Šä¸€æ­¥æŒ‰é’®
            if (currentTutorialStep > 0) {
                prevBtn.style.display = 'block';
            } else {
                prevBtn.style.display = 'none';
            }
            
            // æ˜¾ç¤º/éšè—ä¸‹ä¸€æ­¥å’Œå®ŒæˆæŒ‰é’®
            if (currentTutorialStep === tutorialSteps.length - 1) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                finishBtn.style.display = 'none';
            }
        }

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°å®šä½å¼¹çª—
        window.addEventListener('resize', function() {
            if (document.getElementById('tutorialOverlay').style.display === 'block') {
                showTutorialStep();
            }
        });

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œé‡æ–°å®šä½å¼¹çª—
        window.addEventListener('scroll', function() {
            if (document.getElementById('tutorialOverlay').style.display === 'block') {
                showTutorialStep();
            }
        });
        });

        // å•ä½é€‰æ‹©å¼¹çª—ï¼ˆåˆ†åŒºtabï¼‰
        const unitTabs = [
            {name:'è´¨é‡å•ä½', icon:'fa-weight', list:['g','kg','mg','lb','oz']},
            {name:'ä½“ç§¯å•ä½', icon:'fa-flask', list:['ml','L','cup','tsp','tbsp']},
            {name:'è‡ªå®šä¹‰å•ä½', icon:'fa-edit', list:['è‡ªå®šä¹‰']}
        ];
        
        let currentUnitTab = 0;
        let currentUnitBtn = null;
        
        function showUnitSelect(btn) {
            currentUnitBtn = btn;
            document.getElementById('unit-popup').classList.remove('hidden');
            renderUnitTabBtns();
            renderUnitList();
        }
        
        function renderUnitTabBtns() {
            const tabBtns = document.getElementById('unit-tab-btns');
            tabBtns.innerHTML = '';
            unitTabs.forEach((tab, idx) => {
                const b = document.createElement('button');
                b.className = `flex-1 flex items-center justify-center gap-2 py-2 px-4 rounded-lg transition-all ${
                    currentUnitTab === idx 
                    ? 'bg-white dark:bg-slate-700 text-purple-600 dark:text-purple-400 shadow-sm' 
                    : 'text-gray-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50'
                }`;
                b.innerHTML = `<i class="fas ${tab.icon}"></i><span>${tab.name}</span>`;
                b.onclick = () => { 
                    currentUnitTab = idx; 
                    renderUnitTabBtns(); 
                    renderUnitList(); 
                };
                tabBtns.appendChild(b);
            });
        }
        
        function renderUnitList() {
            const list = document.getElementById('unit-popup-list');
            list.innerHTML = '';
            
            if(unitTabs[currentUnitTab].name === 'è‡ªå®šä¹‰å•ä½') {
                list.className = 'px-2';
                const wrap = document.createElement('div');
                wrap.className = 'flex flex-col items-center gap-4 w-full py-4';
                wrap.innerHTML = `
                    <div class="relative w-full">
                        <input id="customUnitInput" 
                               class="w-full px-4 py-3 bg-gray-50 dark:bg-[#0F172A] text-gray-800 dark:text-slate-100 
                                      border border-gray-200 dark:border-slate-600 rounded-xl outline-none 
                                      placeholder-gray-400 transition-all
                                      focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900" 
                               placeholder="è¾“å…¥è‡ªå®šä¹‰å•ä½">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    <button class="w-full py-3 px-6 gradient-primary 
                                 hover:from-[#764ba2] hover:to-[#667eea] active:scale-95
                                 text-white font-semibold rounded-xl transition-all shadow-lg
                                 flex items-center justify-center gap-2"
                            onclick="setCustomUnit()">
                        <i class="fas fa-check"></i>
                        <span>ç¡®å®š</span>
                    </button>
                `;
                list.appendChild(wrap);
            } else {
                list.className = 'grid grid-cols-3 gap-2 max-h-[40vh] overflow-y-auto pr-2';
                unitTabs[currentUnitTab].list.forEach(u => {
                    const b = document.createElement('button');
                    b.className = `w-full py-3 px-4 rounded-xl transition-all
                                 bg-gray-50 dark:bg-[#0F172A] 
                                 border border-gray-200 dark:border-slate-600
                                 hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20
                                 active:scale-95 text-center
                                 text-gray-800 dark:text-slate-100`;
                    b.textContent = u;
                    b.onclick = () => {
                        currentUnitBtn.textContent = u;
                        closeUnitSelect();
                    };
                    list.appendChild(b);
                });
            }
        }
        
        function setCustomUnit() {
            const val = document.getElementById('customUnitInput').value.trim();
            if(val) {
                currentUnitBtn.textContent = val;
                closeUnitSelect();
            } else {
                // æ·»åŠ è¾“å…¥ä¸ºç©ºçš„æç¤ºåŠ¨ç”»
                const input = document.getElementById('customUnitInput');
                input.classList.add('ring-2', 'ring-red-400');
                setTimeout(() => {
                    input.classList.remove('ring-2', 'ring-red-400');
                }, 800);
            }
        }
        
        function closeUnitSelect() {
            document.getElementById('unit-popup').classList.add('hidden');
        }

        // ææ–™åç§°è‡ªåŠ¨æ£€ç´¢å¼¹çª—ï¼ˆè¾“å…¥ç¬¬ä¸€ä¸ªå­—æ‰å¼¹å‡ºï¼‰
        // ææ–™åˆ—è¡¨ç°åœ¨ä»materialPricesåŠ¨æ€è·å–
        
        // é…æ–¹æ•°æ®åº“
        const savedRecipes = {
            // åå¸ç±»
            'ç»å…¸ç™½åå¸': {
                description: 'æ¾è½¯é¦™ç”œçš„ç»å…¸ç™½åå¸',
                category: 'åå¸ç±»',
                image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 500, unit: 'g' },
                    { name: 'ç‰›å¥¶', amount: 300, unit: 'ml' },
                    { name: 'é»„æ²¹', amount: 30, unit: 'g' },
                    { name: 'ç™½ç ‚ç³–', amount: 50, unit: 'g' },
                    { name: 'ç›', amount: 8, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 5, unit: 'g' }
                ]
            },
            'å…¨éº¦åå¸': {
                description: 'å¥åº·è¥å…»çš„å…¨éº¦åå¸',
                category: 'åå¸ç±»',
                image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'å…¨éº¦ç²‰', amount: 400, unit: 'g' },
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 100, unit: 'g' },
                    { name: 'ç‰›å¥¶', amount: 320, unit: 'ml' },
                    { name: 'èœ‚èœœ', amount: 40, unit: 'g' },
                    { name: 'é»„æ²¹', amount: 35, unit: 'g' },
                    { name: 'ç›', amount: 8, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 6, unit: 'g' }
                ]
            },
            'ç´«è–¯åå¸': {
                description: 'é¢œå€¼è¶…é«˜çš„ç´«è–¯åå¸',
                category: 'åå¸ç±»',
                image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 450, unit: 'g' },
                    { name: 'ç´«è–¯æ³¥', amount: 100, unit: 'g' },
                    { name: 'ç‰›å¥¶', amount: 280, unit: 'ml' },
                    { name: 'é»„æ²¹', amount: 40, unit: 'g' },
                    { name: 'ç™½ç ‚ç³–', amount: 60, unit: 'g' },
                    { name: 'ç›', amount: 7, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 5, unit: 'g' }
                ]
            },
            
            // æ¬§å¼é¢åŒ…
            'æ³•å¼é•¿æ£': {
                description: 'å¤–é…¥å†…è½¯çš„æ³•å¼é•¿æ£é¢åŒ…',
                category: 'æ¬§å¼é¢åŒ…',
                image: 'https://images.unsplash.com/photo-1555507036-ab1f4038808a?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 500, unit: 'g' },
                    { name: 'æ°´', amount: 350, unit: 'ml' },
                    { name: 'ç›', amount: 10, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 3, unit: 'g' }
                ]
            },
            'å¾·å¼é»‘éº¦é¢åŒ…': {
                description: 'æµ“éƒéº¦é¦™çš„å¾·å¼é»‘éº¦é¢åŒ…',
                category: 'æ¬§å¼é¢åŒ…',
                image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é»‘éº¦ç²‰', amount: 300, unit: 'g' },
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 200, unit: 'g' },
                    { name: 'æ°´', amount: 380, unit: 'ml' },
                    { name: 'èœ‚èœœ', amount: 25, unit: 'g' },
                    { name: 'ç›', amount: 12, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 4, unit: 'g' },
                    { name: 'è‘µèŠ±ç±½', amount: 50, unit: 'g' }
                ]
            },
            'æ„å¼ä½›å¡å¤': {
                description: 'é¦™è‰æ©„æ¦„æ²¹é¦™å‘³çš„æ„å¼é¢åŒ…',
                category: 'æ¬§å¼é¢åŒ…',
                image: 'https://images.unsplash.com/photo-1555507036-ab1f4038808a?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 500, unit: 'g' },
                    { name: 'æ°´', amount: 350, unit: 'ml' },
                    { name: 'æ©„æ¦„æ²¹', amount: 60, unit: 'ml' },
                    { name: 'ç›', amount: 10, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 5, unit: 'g' },
                    { name: 'è¿·è¿­é¦™', amount: 5, unit: 'g' }
                ]
            },
            
            // ç”œé¢åŒ…
            'å·§å…‹åŠ›é¢åŒ…': {
                description: 'é¦™æµ“å·§å…‹åŠ›å‘³çš„ç”œé¢åŒ…',
                category: 'ç”œé¢åŒ…',
                image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 450, unit: 'g' },
                    { name: 'å¯å¯ç²‰', amount: 50, unit: 'g' },
                    { name: 'ç‰›å¥¶', amount: 280, unit: 'ml' },
                    { name: 'é»„æ²¹', amount: 50, unit: 'g' },
                    { name: 'ç™½ç ‚ç³–', amount: 80, unit: 'g' },
                    { name: 'é¸¡è›‹', amount: 1, unit: 'ä¸ª' },
                    { name: 'ç›', amount: 6, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 5, unit: 'g' },
                    { name: 'é»‘å·§å…‹åŠ›', amount: 100, unit: 'g' }
                ]
            },
            'è‚‰æ¡‚å·': {
                description: 'é¦™ç”œè‚‰æ¡‚å‘³çš„èºæ—‹é¢åŒ…',
                category: 'ç”œé¢åŒ…',
                image: 'https://images.unsplash.com/photo-1571115764595-644a1f56a55c?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 400, unit: 'g' },
                    { name: 'ç‰›å¥¶', amount: 250, unit: 'ml' },
                    { name: 'é»„æ²¹', amount: 60, unit: 'g' },
                    { name: 'ç™½ç ‚ç³–', amount: 60, unit: 'g' },
                    { name: 'é¸¡è›‹', amount: 1, unit: 'ä¸ª' },
                    { name: 'ç›', amount: 6, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 5, unit: 'g' },
                    { name: 'è‚‰æ¡‚ç²‰', amount: 10, unit: 'g' },
                    { name: 'çº¢ç³–', amount: 80, unit: 'g' }
                ]
            },
            'èœ‚èœœå°é¤åŒ…': {
                description: 'é¦™ç”œæŸ”è½¯çš„èœ‚èœœå°é¤åŒ…',
                category: 'ç”œé¢åŒ…',
                image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 500, unit: 'g' },
                    { name: 'ç‰›å¥¶', amount: 280, unit: 'ml' },
                    { name: 'èœ‚èœœ', amount: 60, unit: 'g' },
                    { name: 'é»„æ²¹', amount: 45, unit: 'g' },
                    { name: 'é¸¡è›‹', amount: 1, unit: 'ä¸ª' },
                    { name: 'ç›', amount: 6, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 5, unit: 'g' }
                ]
            },
            'çº¢è±†é¢åŒ…': {
                description: 'é¦™ç”œçº¢è±†é¦…çš„æ—¥å¼é¢åŒ…',
                category: 'ç”œé¢åŒ…',
                image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 450, unit: 'g' },
                    { name: 'ç‰›å¥¶', amount: 270, unit: 'ml' },
                    { name: 'é»„æ²¹', amount: 40, unit: 'g' },
                    { name: 'ç™½ç ‚ç³–', amount: 50, unit: 'g' },
                    { name: 'é¸¡è›‹', amount: 1, unit: 'ä¸ª' },
                    { name: 'ç›', amount: 6, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 5, unit: 'g' },
                    { name: 'çº¢è±†æ²™', amount: 200, unit: 'g' }
                ]
            },
            
            // å¥åº·é¢åŒ…
            'å…¨éº¦é¢åŒ…': {
                description: 'å¥åº·è¥å…»çš„å…¨éº¦é¢åŒ…',
                category: 'å¥åº·é¢åŒ…',
                image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'å…¨éº¦ç²‰', amount: 400, unit: 'g' },
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 100, unit: 'g' },
                    { name: 'æ°´', amount: 350, unit: 'ml' },
                    { name: 'èœ‚èœœ', amount: 30, unit: 'g' },
                    { name: 'æ©„æ¦„æ²¹', amount: 20, unit: 'ml' },
                    { name: 'ç›', amount: 8, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 6, unit: 'g' }
                ]
            },
            'ç‡•éº¦é¢åŒ…': {
                description: 'å¯Œå«çº¤ç»´çš„ç‡•éº¦é¢åŒ…',
                category: 'å¥åº·é¢åŒ…',
                image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'ç‡•éº¦ç²‰', amount: 200, unit: 'g' },
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 300, unit: 'g' },
                    { name: 'æ°´', amount: 360, unit: 'ml' },
                    { name: 'èœ‚èœœ', amount: 35, unit: 'g' },
                    { name: 'æ©„æ¦„æ²¹', amount: 25, unit: 'ml' },
                    { name: 'ç›', amount: 8, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 6, unit: 'g' },
                    { name: 'ç‡•éº¦ç‰‡', amount: 50, unit: 'g' }
                ]
            },
            'äºšéº»ç±½é¢åŒ…': {
                description: 'å¯Œå«Omega-3çš„äºšéº»ç±½é¢åŒ…',
                category: 'å¥åº·é¢åŒ…',
                image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'å…¨éº¦ç²‰', amount: 350, unit: 'g' },
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 150, unit: 'g' },
                    { name: 'æ°´', amount: 370, unit: 'ml' },
                    { name: 'èœ‚èœœ', amount: 25, unit: 'g' },
                    { name: 'æ©„æ¦„æ²¹', amount: 30, unit: 'ml' },
                    { name: 'ç›', amount: 9, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 6, unit: 'g' },
                    { name: 'äºšéº»ç±½', amount: 40, unit: 'g' }
                ]
            },
            
            // ç‰¹è‰²é¢åŒ…
            'æŠ¹èŒ¶çº¢è±†é¢åŒ…': {
                description: 'æ—¥å¼æŠ¹èŒ¶ä¸çº¢è±†çš„å®Œç¾ç»“åˆ',
                category: 'ç‰¹è‰²é¢åŒ…',
                image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 450, unit: 'g' },
                    { name: 'æŠ¹èŒ¶ç²‰', amount: 15, unit: 'g' },
                    { name: 'ç‰›å¥¶', amount: 280, unit: 'ml' },
                    { name: 'é»„æ²¹', amount: 45, unit: 'g' },
                    { name: 'ç™½ç ‚ç³–', amount: 55, unit: 'g' },
                    { name: 'é¸¡è›‹', amount: 1, unit: 'ä¸ª' },
                    { name: 'ç›', amount: 6, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 5, unit: 'g' },
                    { name: 'çº¢è±†æ²™', amount: 180, unit: 'g' }
                ]
            },
            'èŠå£«åŸ¹æ ¹é¢åŒ…': {
                description: 'å’¸é¦™èŠå£«åŸ¹æ ¹çš„æ¬§å¼é¢åŒ…',
                category: 'ç‰¹è‰²é¢åŒ…',
                image: 'https://images.unsplash.com/photo-1555507036-ab1f4038808a?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 500, unit: 'g' },
                    { name: 'æ°´', amount: 320, unit: 'ml' },
                    { name: 'æ©„æ¦„æ²¹', amount: 30, unit: 'ml' },
                    { name: 'ç›', amount: 10, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 5, unit: 'g' },
                    { name: 'èŠå£«', amount: 120, unit: 'g' },
                    { name: 'åŸ¹æ ¹', amount: 100, unit: 'g' },
                    { name: 'é»‘èƒ¡æ¤’', amount: 2, unit: 'g' }
                ]
            },
            'æ ¸æ¡ƒè‘¡è„å¹²é¢åŒ…': {
                description: 'è¥å…»ä¸°å¯Œçš„æ ¸æ¡ƒè‘¡è„å¹²é¢åŒ…',
                category: 'ç‰¹è‰²é¢åŒ…',
                image: 'https://images.unsplash.com/photo-1555507036-ab1f4038808a?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'é«˜ç­‹é¢ç²‰', amount: 450, unit: 'g' },
                    { name: 'å…¨éº¦ç²‰', amount: 50, unit: 'g' },
                    { name: 'æ°´', amount: 340, unit: 'ml' },
                    { name: 'èœ‚èœœ', amount: 40, unit: 'g' },
                    { name: 'æ©„æ¦„æ²¹', amount: 25, unit: 'ml' },
                    { name: 'ç›', amount: 8, unit: 'g' },
                    { name: 'å¹²é…µæ¯', amount: 5, unit: 'g' },
                    { name: 'æ ¸æ¡ƒ', amount: 80, unit: 'g' },
                    { name: 'è‘¡è„å¹²', amount: 60, unit: 'g' }
                ]
            }
        };

        // ææ–™ä»·æ ¼æ•°æ®åº“ï¼ˆæ¯100gçš„ä»·æ ¼ï¼‰
        const materialPrices = {
            // é¢ç²‰ç±»
            'é«˜ç­‹é¢ç²‰': { price: 0.8, units: ['g', 'kg', 'æ–¤'], category: 'é¢ç²‰ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ä½ç­‹é¢ç²‰': { price: 0.9, units: ['g', 'kg', 'æ–¤'], category: 'é¢ç²‰ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ä¸­ç­‹é¢ç²‰': { price: 0.7, units: ['g', 'kg', 'æ–¤'], category: 'é¢ç²‰ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å…¨éº¦ç²‰': { price: 1.2, units: ['g', 'kg', 'æ–¤'], category: 'é¢ç²‰ç±»', image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é»‘éº¦ç²‰': { price: 1.5, units: ['g', 'kg', 'æ–¤'], category: 'é¢ç²‰ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç‰ç±³ç²‰': { price: 0.6, units: ['g', 'kg', 'æ–¤'], category: 'é¢ç²‰ç±»', image: 'https://images.unsplash.com/photo-1551106652-a5bcf4b29ab6?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç‡•éº¦ç²‰': { price: 1.8, units: ['g', 'kg', 'æ–¤'], category: 'é¢ç²‰ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æä»ç²‰': { price: 12.0, units: ['g', 'kg'], category: 'é¢ç²‰ç±»', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¤°å­ç²‰': { price: 8.5, units: ['g', 'kg'], category: 'é¢ç²‰ç±»', image: 'https://images.unsplash.com/photo-1520637836862-4d197d17c90a?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // å‘é…µå‰‚ç±»
            'å¹²é…µæ¯': { price: 2.5, units: ['g', 'kg'], category: 'å‘é…µå‰‚ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ–°é²œé…µæ¯': { price: 3.0, units: ['g', 'kg'], category: 'å‘é…µå‰‚ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ³¡æ‰“ç²‰': { price: 1.8, units: ['g', 'kg'], category: 'å‘é…µå‰‚ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å°è‹æ‰“': { price: 0.5, units: ['g', 'kg'], category: 'å‘é…µå‰‚ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // ç³–ç±»
            'ç™½ç ‚ç³–': { price: 0.6, units: ['g', 'kg', 'æ–¤'], category: 'ç³–ç±»', image: 'https://images.unsplash.com/photo-1582049165295-519d5ea5a7c8?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'çº¢ç³–': { price: 0.8, units: ['g', 'kg', 'æ–¤'], category: 'ç³–ç±»', image: 'https://images.unsplash.com/photo-1582049165295-519d5ea5a7c8?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å†°ç³–': { price: 1.0, units: ['g', 'kg', 'æ–¤'], category: 'ç³–ç±»', image: 'https://images.unsplash.com/photo-1582049165295-519d5ea5a7c8?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'èœ‚èœœ': { price: 3.5, units: ['g', 'ml', 'L'], category: 'ç³–ç±»', image: 'https://images.unsplash.com/photo-1587049352846-4a222e784d38?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ«ç³–æµ†': { price: 8.0, units: ['ml', 'L'], category: 'ç³–ç±»', image: 'https://images.unsplash.com/photo-1587049352846-4a222e784d38?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç³–ç²‰': { price: 1.2, units: ['g', 'kg'], category: 'ç³–ç±»', image: 'https://images.unsplash.com/photo-1582049165295-519d5ea5a7c8?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¤°ç³–': { price: 4.5, units: ['g', 'kg'], category: 'ç³–ç±»', image: 'https://images.unsplash.com/photo-1582049165295-519d5ea5a7c8?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // è°ƒå‘³æ–™
            'ç›': { price: 0.3, units: ['g', 'kg', 'æ–¤'], category: 'è°ƒå‘³æ–™', image: 'https://images.unsplash.com/photo-1582049165295-519d5ea5a7c8?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é¦™è‰ç²¾': { price: 15.0, units: ['ml'], category: 'è°ƒå‘³æ–™', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æŸ æª¬æ±': { price: 2.0, units: ['ml', 'L'], category: 'è°ƒå‘³æ–™', image: 'https://images.unsplash.com/photo-1590502593747-42a996133562?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æŸ æª¬çš®å±‘': { price: 5.0, units: ['g'], category: 'è°ƒå‘³æ–™', image: 'https://images.unsplash.com/photo-1590502593747-42a996133562?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è‚‰æ¡‚ç²‰': { price: 8.0, units: ['g'], category: 'è°ƒå‘³æ–™', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å¯å¯ç²‰': { price: 6.5, units: ['g', 'kg'], category: 'è°ƒå‘³æ–™', image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // æ²¹è„‚ç±»
            'é»„æ²¹': { price: 4.5, units: ['g', 'kg'], category: 'æ²¹è„‚ç±»', image: 'https://images.unsplash.com/photo-1589985270826-4b7bb135bc9d?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¤ç‰©æ²¹': { price: 1.5, units: ['ml', 'L'], category: 'æ²¹è„‚ç±»', image: 'https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ©„æ¦„æ²¹': { price: 2.8, units: ['ml', 'L'], category: 'æ²¹è„‚ç±»', image: 'https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¤°å­æ²¹': { price: 3.5, units: ['ml', 'L'], category: 'æ²¹è„‚ç±»', image: 'https://images.unsplash.com/photo-1520637836862-4d197d17c90a?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'èŠéº»æ²¹': { price: 4.0, units: ['ml', 'L'], category: 'æ²¹è„‚ç±»', image: 'https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // æ¶²ä½“ç±»
            'ç‰›å¥¶': { price: 1.2, units: ['ml', 'L'], category: 'æ¶²ä½“ç±»', image: 'https://images.unsplash.com/photo-1550583724-b2692b85b150?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ·¡å¥¶æ²¹': { price: 3.8, units: ['ml', 'L'], category: 'æ¶²ä½“ç±»', image: 'https://images.unsplash.com/photo-1550583724-b2692b85b150?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é…¸å¥¶': { price: 2.0, units: ['ml', 'L'], category: 'æ¶²ä½“ç±»', image: 'https://images.unsplash.com/photo-1550583724-b2692b85b150?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¤°æµ†': { price: 4.5, units: ['ml', 'L'], category: 'æ¶²ä½“ç±»', image: 'https://images.unsplash.com/photo-1520637836862-4d197d17c90a?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ°´': { price: 0.01, units: ['ml', 'L'], category: 'æ¶²ä½“ç±»', image: 'https://images.unsplash.com/photo-1548839140-29a749e1cf4d?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è±†æµ†': { price: 1.8, units: ['ml', 'L'], category: 'æ¶²ä½“ç±»', image: 'https://images.unsplash.com/photo-1550583724-b2692b85b150?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // è›‹ç™½è´¨ç±»
            'é¸¡è›‹': { price: 1.8, units: ['ä¸ª', 'g'], category: 'è›‹ç™½è´¨ç±»', image: 'https://images.unsplash.com/photo-1518569656558-1f25e69d93d7?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è›‹é»„': { price: 2.5, units: ['ä¸ª', 'g'], category: 'è›‹ç™½è´¨ç±»', image: 'https://images.unsplash.com/photo-1518569656558-1f25e69d93d7?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è›‹ç™½': { price: 2.0, units: ['ä¸ª', 'g'], category: 'è›‹ç™½è´¨ç±»', image: 'https://images.unsplash.com/photo-1518569656558-1f25e69d93d7?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å¥¶ç²‰': { price: 3.2, units: ['g', 'kg'], category: 'è›‹ç™½è´¨ç±»', image: 'https://images.unsplash.com/photo-1550583724-b2692b85b150?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // åšæœç±»
            'æ ¸æ¡ƒ': { price: 6.5, units: ['g', 'kg'], category: 'åšæœç±»', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æä»': { price: 8.0, units: ['g', 'kg'], category: 'åšæœç±»', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¦›å­': { price: 12.0, units: ['g', 'kg'], category: 'åšæœç±»', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è…°æœ': { price: 10.0, units: ['g', 'kg'], category: 'åšæœç±»', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'èŠ±ç”Ÿ': { price: 3.5, units: ['g', 'kg'], category: 'åšæœç±»', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¾å­': { price: 15.0, units: ['g', 'kg'], category: 'åšæœç±»', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'èŠéº»': { price: 4.0, units: ['g', 'kg'], category: 'åšæœç±»', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // å¹²æœç±»
            'è‘¡è„å¹²': { price: 2.0, units: ['g', 'kg'], category: 'å¹²æœç±»', image: 'https://images.unsplash.com/photo-1577003833619-76bbd7f82948?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è”“è¶Šè“å¹²': { price: 4.5, units: ['g', 'kg'], category: 'å¹²æœç±»', image: 'https://images.unsplash.com/photo-1577003833619-76bbd7f82948?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ— èŠ±æœå¹²': { price: 6.0, units: ['g', 'kg'], category: 'å¹²æœç±»', image: 'https://images.unsplash.com/photo-1577003833619-76bbd7f82948?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¤°ä¸': { price: 3.5, units: ['g', 'kg'], category: 'å¹²æœç±»', image: 'https://images.unsplash.com/photo-1520637836862-4d197d17c90a?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¸æ': { price: 8.0, units: ['g', 'kg'], category: 'å¹²æœç±»', image: 'https://images.unsplash.com/photo-1577003833619-76bbd7f82948?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // å¥¶åˆ¶å“
            'èŠå£«': { price: 8.0, units: ['g', 'kg'], category: 'å¥¶åˆ¶å“', image: 'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å¥¶æ²¹å¥¶é…ª': { price: 12.0, units: ['g', 'kg'], category: 'å¥¶åˆ¶å“', image: 'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é©¬æ–¯å¡å½­': { price: 15.0, units: ['g', 'kg'], category: 'å¥¶åˆ¶å“', image: 'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é…¸å¥¶æ²¹': { price: 6.0, units: ['g', 'kg'], category: 'å¥¶åˆ¶å“', image: 'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // å·§å…‹åŠ›ç±»
            'é»‘å·§å…‹åŠ›': { price: 18.0, units: ['g', 'kg'], category: 'å·§å…‹åŠ›ç±»', image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç‰›å¥¶å·§å…‹åŠ›': { price: 15.0, units: ['g', 'kg'], category: 'å·§å…‹åŠ›ç±»', image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç™½å·§å…‹åŠ›': { price: 20.0, units: ['g', 'kg'], category: 'å·§å…‹åŠ›ç±»', image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å·§å…‹åŠ›è±†': { price: 12.0, units: ['g', 'kg'], category: 'å·§å…‹åŠ›ç±»', image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // å…¶ä»–æ·»åŠ å‰‚
            'æ˜èƒ¶': { price: 25.0, units: ['g'], category: 'å…¶ä»–æ·»åŠ å‰‚', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç¼è„‚': { price: 30.0, units: ['g'], category: 'å…¶ä»–æ·»åŠ å‰‚', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å¡”å¡”ç²‰': { price: 8.0, units: ['g'], category: 'å…¶ä»–æ·»åŠ å‰‚', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç‰ç±³æ·€ç²‰': { price: 0.8, units: ['g', 'kg'], category: 'å…¶ä»–æ·»åŠ å‰‚', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å‰åˆ©ä¸ç‰‡': { price: 2.0, units: ['ç‰‡', 'g'], category: 'å…¶ä»–æ·»åŠ å‰‚', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ”¹è‰¯å‰‚': { price: 12.0, units: ['g'], category: 'å…¶ä»–æ·»åŠ å‰‚', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é¢åŒ…æ”¹è‰¯å‰‚': { price: 15.0, units: ['g'], category: 'å…¶ä»–æ·»åŠ å‰‚', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // æ°´æœç±»
            'è‹¹æœ': { price: 0.8, units: ['ä¸ª', 'g'], category: 'æ°´æœç±»', image: 'https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é¦™è•‰': { price: 0.6, units: ['æ ¹', 'g'], category: 'æ°´æœç±»', image: 'https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è“è“': { price: 3.5, units: ['g', 'kg'], category: 'æ°´æœç±»', image: 'https://images.unsplash.com/photo-1498557850523-fd3d118b962e?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è‰è“': { price: 2.8, units: ['ä¸ª', 'g'], category: 'æ°´æœç±»', image: 'https://images.unsplash.com/photo-1464965911861-746a04b4bca6?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æŸ æª¬': { price: 1.5, units: ['ä¸ª', 'g'], category: 'æ°´æœç±»', image: 'https://images.unsplash.com/photo-1590502593747-42a996133562?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ©™å­': { price: 1.2, units: ['ä¸ª', 'g'], category: 'æ°´æœç±»', image: 'https://images.unsplash.com/photo-1547036967-23d11aacaee0?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¨±æ¡ƒ': { price: 4.0, units: ['ä¸ª', 'g'], category: 'æ°´æœç±»', image: 'https://images.unsplash.com/photo-1528821128474-27f963b062bf?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æ¡ƒå­': { price: 1.8, units: ['ä¸ª', 'g'], category: 'æ°´æœç±»', image: 'https://images.unsplash.com/photo-1629828874514-d8e6d0a1b611?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // è”¬èœç±»
            'èƒ¡èåœ': { price: 0.5, units: ['æ ¹', 'g'], category: 'è”¬èœç±»', image: 'https://images.unsplash.com/photo-1445282768818-728615cc910a?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å—ç“œ': { price: 0.4, units: ['g', 'kg'], category: 'è”¬èœç±»', image: 'https://images.unsplash.com/photo-1570197788417-0e82375c9371?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç´«è–¯': { price: 0.6, units: ['ä¸ª', 'g'], category: 'è”¬èœç±»', image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'çº¢è–¯': { price: 0.5, units: ['ä¸ª', 'g'], category: 'è”¬èœç±»', image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'åœŸè±†': { price: 0.4, units: ['ä¸ª', 'g'], category: 'è”¬èœç±»', image: 'https://images.unsplash.com/photo-1518977676601-b53f82aba655?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è èœ': { price: 0.8, units: ['g', 'kg'], category: 'è”¬èœç±»', image: 'https://images.unsplash.com/photo-1576045057995-568f588f82fb?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // è±†ç±»
            'çº¢è±†': { price: 1.2, units: ['g', 'kg'], category: 'è±†ç±»', image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç»¿è±†': { price: 1.0, units: ['g', 'kg'], category: 'è±†ç±»', image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é»‘è±†': { price: 1.5, units: ['g', 'kg'], category: 'è±†ç±»', image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é»„è±†': { price: 0.8, units: ['g', 'kg'], category: 'è±†ç±»', image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'çº¢è±†æ²™': { price: 2.5, units: ['g', 'kg'], category: 'è±†ç±»', image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç»¿è±†æ²™': { price: 2.8, units: ['g', 'kg'], category: 'è±†ç±»', image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // é¦™æ–™ç±»
            'é¦™è‰è±†': { price: 50.0, units: ['æ ¹'], category: 'é¦™æ–™ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å…«è§’': { price: 3.0, units: ['ä¸ª', 'g'], category: 'é¦™æ–™ç±»', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ä¸é¦™': { price: 8.0, units: ['g'], category: 'é¦™æ–™ç±»', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è±†è”»': { price: 12.0, units: ['g'], category: 'é¦™æ–™ç±»', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è¿·è¿­é¦™': { price: 6.0, units: ['g'], category: 'é¦™æ–™ç±»', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç™¾é‡Œé¦™': { price: 5.5, units: ['g'], category: 'é¦™æ–™ç±»', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç½—å‹’': { price: 4.0, units: ['g'], category: 'é¦™æ–™ç±»', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'æŠ¹èŒ¶ç²‰': { price: 25.0, units: ['g'], category: 'é¦™æ–™ç±»', image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // è‚‰ç±»
            'åŸ¹æ ¹': { price: 3.5, units: ['ç‰‡', 'g'], category: 'è‚‰ç±»', image: 'https://images.unsplash.com/photo-1528607929212-2636ec44b982?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'ç«è…¿': { price: 4.0, units: ['ç‰‡', 'g'], category: 'è‚‰ç±»', image: 'https://images.unsplash.com/photo-1528607929212-2636ec44b982?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é¦™è‚ ': { price: 2.8, units: ['æ ¹', 'g'], category: 'è‚‰ç±»', image: 'https://images.unsplash.com/photo-1528607929212-2636ec44b982?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'é¸¡èƒ¸è‚‰': { price: 2.2, units: ['g', 'kg'], category: 'è‚‰ç±»', image: 'https://images.unsplash.com/photo-1528607929212-2636ec44b982?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            
            // è°·ç‰©ç±»
            'ç‡•éº¦ç‰‡': { price: 1.2, units: ['g', 'kg'], category: 'è°·ç‰©ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å°éº¦èƒšèŠ½': { price: 3.5, units: ['g', 'kg'], category: 'è°·ç‰©ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'éº¦éº¸': { price: 1.8, units: ['g', 'kg'], category: 'è°·ç‰©ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è—œéº¦': { price: 8.0, units: ['g', 'kg'], category: 'è°·ç‰©ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'äºšéº»ç±½': { price: 4.5, units: ['g', 'kg'], category: 'è°·ç‰©ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å¥‡äºšç±½': { price: 12.0, units: ['g', 'kg'], category: 'è°·ç‰©ç±»', image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'è‘µèŠ±ç±½': { price: 2.5, units: ['g', 'kg'], category: 'è°·ç‰©ç±»', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' },
            'å—ç“œç±½': { price: 3.8, units: ['g', 'kg'], category: 'è°·ç‰©ç±»', image: 'https://images.unsplash.com/photo-1508747703725-719777637510?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80' }
        };
        let currentNameInput = null;
        let currentActiveTab = 'materials';
        
        function showMaterialSearch(input) {
            currentNameInput = input;
            // ç›´æ¥æ˜¾ç¤ºå¼¹çª—ï¼Œä¸éœ€è¦è¾“å…¥å€¼
            document.getElementById('material-popup').classList.remove('hidden');
            // æ¸…ç©ºæœç´¢æ¡†
            document.getElementById('custom-material-input').value = '';
            // é»˜è®¤æ˜¾ç¤ºææ–™åˆ†åŒº
            switchMaterialTab('materials');
            // åˆå§‹åŒ–æ˜¾ç¤ºæ‰€æœ‰ææ–™
            updateMaterialSearch('');
            
            // è®©è‡ªå®šä¹‰ææ–™è¾“å…¥æ¡†é»˜è®¤è·å¾—ç„¦ç‚¹ï¼Œå»¶è¿Ÿç¡®ä¿DOMæ¸²æŸ“å®Œæˆ
            setTimeout(() => {
                const customInput = document.getElementById('custom-material-input');
                if (customInput) {
                    customInput.focus();
                    // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šç¡®ä¿é”®ç›˜å¼¹å‡º
                    customInput.click();
                }
            }, 100);
        }
        function updateMaterialSearch(keyword) {
            const list = document.getElementById('material-popup-list');
            const categoriesList = document.getElementById('material-category-list');
            list.innerHTML = '';
            categoriesList.innerHTML = '';
            
            // è·å–æ‰€æœ‰ç±»åˆ«
            const categories = [...new Set(Object.values(materialPrices).map(data => data.category))];
            
            // åˆ›å»ºç±»åˆ«åˆ—è¡¨
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item px-3 py-2.5 cursor-pointer text-sm text-gray-700 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-700 hover:shadow-sm rounded-xl transition-all duration-200 border border-transparent hover:border-purple-200 dark:hover:border-purple-800';
                categoryItem.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${category}</span>
                    </div>
                `;
                categoryItem.onclick = () => filterMaterialsByCategory(category);
                categoriesList.appendChild(categoryItem);
            });
            
            // ä½¿ç”¨materialPricesä½œä¸ºæ•°æ®æºè¿›è¡Œæ¨¡ç³Šæœç´¢
            const materials = Object.keys(materialPrices);
            const filteredMaterials = materials.filter(m => 
                m.toLowerCase().includes(keyword.toLowerCase()) || 
                keyword.toLowerCase().includes(m.toLowerCase())
            );
            
            // æŒ‰åŒ¹é…åº¦æ’åºï¼šå®Œå…¨åŒ¹é… > å¼€å¤´åŒ¹é… > åŒ…å«åŒ¹é…
            filteredMaterials.sort((a, b) => {
                const aLower = a.toLowerCase();
                const bLower = b.toLowerCase();
                const keywordLower = keyword.toLowerCase();
                
                if (aLower === keywordLower) return -1;
                if (bLower === keywordLower) return 1;
                if (aLower.startsWith(keywordLower)) return -1;
                if (bLower.startsWith(keywordLower)) return 1;
                return 0;
            });
            
            // é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…åˆ—è¡¨è¿‡é•¿ï¼ˆæœç´¢æ—¶é™åˆ¶8ä¸ªï¼Œæ— æœç´¢æ—¶æ˜¾ç¤ºæ›´å¤šï¼‰
            const displayMaterials = keyword ? filteredMaterials.slice(0, 8) : filteredMaterials.slice(0, 20);
            
            displayMaterials.forEach(m => {
                const materialData = materialPrices[m];
                const b = document.createElement('button');
                b.className = 'material-card flex items-center w-full px-4 py-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm text-gray-800 dark:text-slate-200 hover:bg-white dark:hover:bg-slate-700 text-left transition-all duration-300 border border-gray-200/50 dark:border-slate-600/50 mb-2 hover:shadow-lg hover:shadow-purple-500/10 hover:border-purple-300 dark:hover:border-purple-500/50 hover:scale-[1.02]';
                
                // ä¸ä½¿ç”¨é«˜äº®ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹åç§°
                const highlightedName = m;
                
                b.innerHTML = `
                    <div class="flex items-center w-full">
                        <div class="font-medium text-gray-900 dark:text-slate-100 text-sm truncate">${highlightedName}</div>
                    </div>
                `;
                
                b.onclick = () => {
                    currentNameInput.value = m;
                    // åŒæ­¥çŠ¶æ€å˜ç»¿
                    const nameInput = currentNameInput;
                    nameInput.classList.remove('not-synced');
                    nameInput.classList.add('synced');
                    updateSyncStatusDisplay(nameInput);
                    
                    // è®¾ç½®é»˜è®¤å•ä½å’Œæ˜¾ç¤ºé‡‘é¢
                    const row = nameInput.closest('.ingredient-item');
                    const unitBtn = row.querySelector('.unit-btn');
                    const costField = row.querySelector('.cost-field');
                    
                    // æ ¹æ®ææ–™è®¾ç½®é»˜è®¤å•ä½
                    if (materialData && materialData.units.length > 0) {
                        unitBtn.textContent = materialData.units[0];
                    }
                    
                    closeMaterialSearch();
                    updateAutoFields(currentNameInput);
                };
                list.appendChild(b);
            });
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…ç»“æœï¼Œæ˜¾ç¤ºæç¤º
            if (displayMaterials.length === 0) {
                const noResult = document.createElement('div');
                noResult.className = 'px-4 py-3 text-center text-gray-500 dark:text-slate-400 text-sm';
                noResult.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„ææ–™';
                list.appendChild(noResult);
            }
        }
        
        function filterMaterialsByCategory(category) {
            const list = document.getElementById('material-popup-list');
            list.innerHTML = '';
            
            const filteredMaterials = Object.entries(materialPrices).filter(([name, data]) => 
                data.category === category
            );
            
            filteredMaterials.forEach(([m, materialData]) => {
                const b = document.createElement('button');
                b.className = 'material-card flex items-center w-full px-4 py-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm text-gray-800 dark:text-slate-200 hover:bg-white dark:hover:bg-slate-700 text-left transition-all duration-300 border border-gray-200/50 dark:border-slate-600/50 mb-2 hover:shadow-lg hover:shadow-purple-500/10 hover:border-purple-300 dark:hover:border-purple-500/50 hover:scale-[1.02]';
                
                b.innerHTML = `
                    <div class="flex items-center w-full">
                        <div class="font-medium text-gray-900 dark:text-slate-100 text-sm truncate">${m}</div>
                    </div>
                `;
                
                b.onclick = () => {
                    currentNameInput.value = m;
                    // åŒæ­¥çŠ¶æ€å˜ç»¿
                    const nameInput = currentNameInput;
                    nameInput.classList.remove('not-synced');
                    nameInput.classList.add('synced');
                    updateSyncStatusDisplay(nameInput);
                    
                    // è®¾ç½®é»˜è®¤å•ä½å’Œæ˜¾ç¤ºé‡‘é¢
                    const row = nameInput.closest('.ingredient-item');
                    const unitBtn = row.querySelector('.unit-btn');
                    const costField = row.querySelector('.cost-field');
                    
                    // æ ¹æ®ææ–™è®¾ç½®é»˜è®¤å•ä½
                    if (materialData && materialData.units.length > 0) {
                        unitBtn.textContent = materialData.units[0];
                    }
                    
                    closeMaterialSearch();
                    updateAutoFields(currentNameInput);
                };
                list.appendChild(b);
            });
         }
         
         function filterRecipesByCategory(category) {
             const list = document.getElementById('recipe-popup-list');
             list.innerHTML = '';
             
             const filteredRecipes = Object.entries(savedRecipes).filter(([name, data]) => 
                 data.category === category
             );
             
             filteredRecipes.forEach(([r, recipeData]) => {
                 const b = document.createElement('button');
                 b.className = 'recipe-card flex items-center w-full px-4 py-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm text-gray-800 dark:text-slate-200 hover:bg-white dark:hover:bg-slate-700 text-left transition-all duration-300 border border-gray-200/50 dark:border-slate-600/50 mb-2 hover:shadow-lg hover:shadow-purple-500/10 hover:border-purple-300 dark:hover:border-purple-500/50 hover:scale-[1.02]';
                 
                 b.innerHTML = `
                     <div class="flex items-center w-full">
                         <div class="font-medium text-gray-900 dark:text-slate-100 text-sm truncate">${r}</div>
                     </div>
                 `;
                 
                 b.onclick = () => {
                     selectRecipe(r, recipeData);
                 };
                 list.appendChild(b);
             });
         }
         
         function closeMaterialSearch() {
            document.getElementById('material-popup').classList.add('hidden');
        }
        
        function confirmCustomMaterial() {
            const customInput = document.getElementById('custom-material-input');
            const customMaterialName = customInput.value.trim();
            
            if (!customMaterialName) {
                alert('è¯·è¾“å…¥ææ–™åç§°');
                return;
            }
            
            if (currentNameInput) {
                // è®¾ç½®è‡ªå®šä¹‰ææ–™åç§°
                currentNameInput.value = customMaterialName;
                
                // è®¾ç½®ä¸ºæœªåŒæ­¥çŠ¶æ€ï¼ˆçº¢è‰²è¾¹æ¡†ï¼‰
                currentNameInput.classList.remove('synced');
                currentNameInput.classList.add('not-synced');
                updateSyncStatusDisplay(currentNameInput);
                
                // æ¸…ç©ºæˆæœ¬æ˜¾ç¤º
                const row = currentNameInput.closest('.ingredient-item');
                const costField = row.querySelector('.cost-field');
                if (costField) {
                    costField.textContent = 'Â¥0.00';
                }
                
                // æ¸…ç©ºè‡ªå®šä¹‰è¾“å…¥æ¡†
                customInput.value = '';
            }
            
            // å…³é—­å¼¹çª—
            closeMaterialSearch();
        }
        
        // åˆ†åŒºåˆ‡æ¢åŠŸèƒ½
        function switchMaterialTab(tab) {
            currentActiveTab = tab;
            const materialsTab = document.getElementById('materials-tab');
            const recipesTab = document.getElementById('recipes-tab');
            const materialsSection = document.getElementById('materials-section');
            const recipesSection = document.getElementById('recipes-section');
            
            if (tab === 'materials') {
                // æ¿€æ´»ææ–™æ ‡ç­¾
                materialsTab.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all duration-200 bg-white dark:bg-slate-600 text-purple-600 dark:text-purple-400 shadow-sm';
                recipesTab.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all duration-200 text-gray-600 dark:text-slate-400 hover:text-gray-800 dark:hover:text-slate-200';
                // æ˜¾ç¤ºææ–™åŒºåŸŸï¼Œéšè—é…æ–¹åŒºåŸŸ
                materialsSection.classList.remove('hidden');
                recipesSection.classList.add('hidden');
                // æ›´æ–°ææ–™åˆ—è¡¨
                const searchValue = document.getElementById('custom-material-input').value;
                updateMaterialSearch(searchValue);
            } else {
                // æ¿€æ´»é…æ–¹æ ‡ç­¾
                recipesTab.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all duration-200 bg-white dark:bg-slate-600 text-purple-600 dark:text-purple-400 shadow-sm';
                materialsTab.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all duration-200 text-gray-600 dark:text-slate-400 hover:text-gray-800 dark:hover:text-slate-200';
                // æ˜¾ç¤ºé…æ–¹åŒºåŸŸï¼Œéšè—ææ–™åŒºåŸŸ
                recipesSection.classList.remove('hidden');
                materialsSection.classList.add('hidden');
                // æ›´æ–°é…æ–¹åˆ—è¡¨
                const searchValue = document.getElementById('custom-material-input').value;
                updateRecipeSearch(searchValue);
            }
        }
        
        // ç»Ÿä¸€æœç´¢è¿‡æ»¤åŠŸèƒ½
        function filterMaterialAndRecipes(keyword) {
            if (currentActiveTab === 'materials') {
                updateMaterialSearch(keyword);
            } else {
                updateRecipeSearch(keyword);
            }
        }
        
        // é…æ–¹æœç´¢æ›´æ–°åŠŸèƒ½
        function updateRecipeSearch(keyword) {
            const list = document.getElementById('recipe-popup-list');
            const categoriesList = document.getElementById('recipe-category-list');
            list.innerHTML = '';
            categoriesList.innerHTML = '';
            
            // è·å–æ‰€æœ‰é…æ–¹ç±»åˆ«
            const categories = [...new Set(Object.values(savedRecipes).map(data => data.category))];
            
            // åˆ›å»ºç±»åˆ«åˆ—è¡¨
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item px-3 py-2.5 cursor-pointer text-sm text-gray-700 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-700 hover:shadow-sm rounded-xl transition-all duration-200 border border-transparent hover:border-purple-200 dark:hover:border-purple-800';
                categoryItem.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${category}</span>
                    </div>
                `;
                categoryItem.onclick = () => filterRecipesByCategory(category);
                categoriesList.appendChild(categoryItem);
            });
            
            // ä½¿ç”¨savedRecipesä½œä¸ºæ•°æ®æºè¿›è¡Œæ¨¡ç³Šæœç´¢
            const recipes = Object.keys(savedRecipes);
            const filteredRecipes = recipes.filter(r => 
                r.toLowerCase().includes(keyword.toLowerCase()) || 
                keyword.toLowerCase().includes(r.toLowerCase()) ||
                savedRecipes[r].category.toLowerCase().includes(keyword.toLowerCase()) ||
                savedRecipes[r].description.toLowerCase().includes(keyword.toLowerCase())
            );
            
            // æŒ‰åŒ¹é…åº¦æ’åº
            filteredRecipes.sort((a, b) => {
                const aLower = a.toLowerCase();
                const bLower = b.toLowerCase();
                const keywordLower = keyword.toLowerCase();
                
                if (aLower === keywordLower) return -1;
                if (bLower === keywordLower) return 1;
                if (aLower.startsWith(keywordLower)) return -1;
                if (bLower.startsWith(keywordLower)) return 1;
                return 0;
            });
            
            // é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼ˆæœç´¢æ—¶é™åˆ¶8ä¸ªï¼Œæ— æœç´¢æ—¶æ˜¾ç¤ºæ›´å¤šï¼‰
            const displayRecipes = keyword ? filteredRecipes.slice(0, 8) : filteredRecipes.slice(0, 20);
            
            displayRecipes.forEach(r => {
                const recipeData = savedRecipes[r];
                const b = document.createElement('button');
                b.className = 'recipe-card flex items-center w-full px-4 py-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm text-gray-800 dark:text-slate-200 hover:bg-white dark:hover:bg-slate-700 text-left transition-all duration-300 border border-gray-200/50 dark:border-slate-600/50 mb-2 hover:shadow-lg hover:shadow-purple-500/10 hover:border-purple-300 dark:hover:border-purple-500/50 hover:scale-[1.02]';
                
                // ä¸ä½¿ç”¨é«˜äº®ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹åç§°
                const highlightedName = r;
                
                b.innerHTML = `
                    <div class="flex items-center w-full">
                        <div class="font-medium text-gray-900 dark:text-slate-100 text-sm truncate">${highlightedName}</div>
                    </div>
                `;
                
                b.onclick = () => {
                    selectRecipe(r, recipeData);
                };
                list.appendChild(b);
            });
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…ç»“æœï¼Œæ˜¾ç¤ºæç¤º
            if (displayRecipes.length === 0) {
                const noResult = document.createElement('div');
                noResult.className = 'px-4 py-3 text-center text-gray-500 dark:text-slate-400 text-sm';
                noResult.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„é…æ–¹';
                list.appendChild(noResult);
            }
        }
        
        // é€‰æ‹©é…æ–¹åŠŸèƒ½
        function selectRecipe(recipeName, recipeData) {
            // ç¡®è®¤æ˜¯å¦è¦å¯¼å…¥é…æ–¹
            if (confirm(`ç¡®å®šè¦å¯¼å…¥é…æ–¹"${recipeName}"å—ï¼Ÿè¿™å°†æ¸…ç©ºå½“å‰çš„ææ–™åˆ—è¡¨ã€‚`)) {
                // æ¸…ç©ºå½“å‰ææ–™åˆ—è¡¨ - ä½¿ç”¨å˜åŒ–æ¬¾é¢å›¢å®¹å™¨
                const base2Ingredients = document.getElementById('base2Ingredients');
                if (base2Ingredients) {
                    base2Ingredients.innerHTML = '';
                }
                
                // æ·»åŠ é…æ–¹ä¸­çš„æ‰€æœ‰ææ–™åˆ°å˜åŒ–æ¬¾é¢å›¢
                recipeData.ingredients.forEach(ingredient => {
                    addIngredientFromRecipe('base2', ingredient);
                });
                
                // æ›´æ–°é…æ–¹åç§°
                const recipeNameInput = document.querySelector('input[placeholder="è¯·è¾“å…¥é…æ–¹åç§°..."]');
                if (recipeNameInput && !recipeNameInput.value) {
                    recipeNameInput.value = recipeName;
                }
                
                closeMaterialSearch();
                updateAllAutoFields();
            }
        }
        
        // ä»é…æ–¹æ·»åŠ ææ–™çš„åŠŸèƒ½
        function addIngredientFromRecipe(type, ingredient) {
            const container = document.getElementById(`${type}Ingredients`);
            if (!container) return; // å¦‚æœå®¹å™¨ä¸å­˜åœ¨åˆ™è¿”å›
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 bg-gradient-to-r from-white to-gray-50 dark:from-[#1E293B] dark:to-[#334155] rounded-lg p-2.5 shadow-sm border border-slate-200/50 dark:border-slate-600/50 ingredient-item hover:shadow-md transition-all duration-200';
            div.setAttribute('data-open', 'false');
            div.innerHTML = `
                <div class="drag-handle p-1.5 rounded-full hover:bg-[#F1F5F9] dark:hover:bg-[#334155] cursor-grab text-slate-400 dark:text-slate-500 transition" title="æ‹–æ‹½æ’åº">
                    <i class="fas fa-grip-lines"></i>
                </div>
                <div class="flex-1 min-w-[90px] relative">
                    <input type="text" placeholder="åç§°" class="name-input w-full px-2 py-2 text-sm border-none outline-none bg-transparent text-gray-800 dark:text-slate-100 synced" value="${ingredient.name}" onclick="if(!this.readOnly){showMaterialSearch(this);}" oninput="updateAutoFields(this)">
                    <div class="synced-text sync-status-text" style="display: none;">âœ“ å·²åŒæ­¥ææ–™åº“</div>
                    <div class="not-synced-text sync-status-text" style="display: none;">! è‡ªå»ºææ–™</div>
                </div>
                <div class="w-24 relative flex items-center">
                    <input type="text" inputmode="decimal" placeholder="ç”¨é‡" class="w-full px-1 py-2 text-sm text-center border-none outline-none bg-transparent text-gray-800 dark:text-slate-100" value="${ingredient.amount}" oninput="updateAutoFields(this)">
                    <button class="unit-btn ml-1 px-1.5 py-0.5 text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded hover:bg-purple-200 dark:hover:bg-purple-900/50 active:scale-95 transition-all" onclick="showUnitSelector(this)">${ingredient.unit}</button>
                </div>
                <div class="flex flex-col gap-1 min-w-[50px]">
                    <div class="cost-field text-emerald-600 dark:text-emerald-400 select-none text-xs font-medium bg-emerald-50 dark:bg-emerald-900/20 px-1 py-0.5 rounded text-center">Â¥0.00</div>
                    <span class="percent-field text-slate-500 dark:text-slate-400 select-none text-xs font-medium bg-slate-50 dark:bg-slate-800/50 px-1 py-0.5 rounded text-center">0%</span>
                </div>
                <div class="delete-action"><i class="fas fa-trash-alt mr-1"></i> åˆ é™¤</div>
            `;
            container.appendChild(div);
            
            // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
            const nameInput = div.querySelector('.name-input');
            if (nameInput) {
                updateSyncStatusDisplay(nameInput);
            }
            
            initSwipeDelete(div);
            updateSortable();
            updateVariationTotal();
        }

        // æ·»åŠ åŸæ–™è¡Œï¼ˆæ‰€æœ‰æŒ‰é’®/å›¾æ ‡åŠ ç‚¹å‡»æ•ˆæœï¼ŒåŸºç¡€é¢å›¢å’Œå˜åŒ–æ¬¾é‡Œçš„é¢å›¢éƒ½è®¡å…¥æ€»é‡ï¼Œåç§°ä¸å¯ç¼–è¾‘ï¼‰
        function addIngredient(type) {
            let container;
            if(type.startsWith('variation')) {
                container = document.getElementById(`${type}Ingredients`);
            } else {
                container = document.getElementById(`${type}Ingredients`);
            }
            let nameValue = '';
            let nameReadOnly = false;
            // ç§»é™¤åŸºç¡€é¢å›¢ç›¸å…³é€»è¾‘
            if(type==='base2' && container.children.length===0) {
                nameValue = 'å˜åŒ–æ¬¾é¢å›¢';
                nameReadOnly = true; // å˜åŒ–æ¬¾é¢å›¢åç§°ä¸å¯ç¼–è¾‘
            } else if(type.startsWith('base') && type !== 'base' && type !== 'base2' && container.children.length===0) {
                nameValue = 'å˜åŒ–æ¬¾é¢å›¢';
                nameReadOnly = true; // æ–°å˜åŒ–æ¬¾é¢å›¢åç§°ä¸å¯ç¼–è¾‘
            }
            // å˜åŒ–æ¬¾é‡Œçš„è¾“å…¥æ¡†éƒ½æ˜¯æ­£å¸¸å¯ç¼–è¾‘çš„ï¼Œä¸å†é»˜è®¤ä¸ºåŸºç¡€é¢å›¢
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 bg-gradient-to-r from-white to-gray-50 dark:from-[#1E293B] dark:to-[#334155] rounded-lg p-2.5 shadow-sm border border-slate-200/50 dark:border-slate-600/50 ingredient-item hover:shadow-md transition-all duration-200';
            div.setAttribute('data-open', 'false');
            div.innerHTML = `
                <div class="drag-handle p-1.5 rounded-full hover:bg-[#F1F5F9] dark:hover:bg-[#334155] cursor-grab text-slate-400 dark:text-slate-500 transition" title="æ‹–æ‹½æ’åº">
                    <i class="fas fa-grip-lines"></i>
                </div>
                <div class="flex-1 min-w-[90px] relative">
                    <input type="text" placeholder="åç§°" class="name-input w-full px-2 py-2 text-sm border-none outline-none ${nameReadOnly?'bg-gray-100 dark:bg-slate-600 cursor-not-allowed text-gray-500 dark:text-slate-400':'bg-white/80 dark:bg-slate-700/50 text-gray-800 dark:text-slate-100'} rounded-lg not-synced" value="${nameValue}" ${nameReadOnly?'readonly':''} onclick="if(!this.readOnly){showMaterialSearch(this);}" oninput="updateAutoFields(this)">
                    <div class="synced-text sync-status-text" style="display: none;">âœ“ å·²åŒæ­¥ææ–™åº“</div>
                    <div class="not-synced-text sync-status-text" style="display: none;">! è‡ªå»ºææ–™</div>
                    ${nameValue === 'åŸºç¡€é¢å›¢' ? '<div class="base-dough-tip sync-status-text" style="display: block; color: #ea580c; background: rgba(234, 88, 12, 0.15); border: 1px solid rgba(234, 88, 12, 0.2);"><i class="fas fa-lock mr-1"></i>é»˜è®¤é¢å›¢ä¸å¯ç¼–è¾‘</div>' : ''}
                    ${nameValue === 'å˜åŒ–æ¬¾é¢å›¢' ? '<div class="variation-dough-tip sync-status-text" style="display: block; color: #ec4899; background: rgba(236, 72, 153, 0.15); border: 1px solid rgba(236, 72, 153, 0.2);"><i class="fas fa-lock mr-1"></i>é»˜è®¤é…æ–¹ä¸å¯ç¼–è¾‘</div>' : ''}
                </div>
                <div class="w-24 relative flex items-center">
                    <input type="text" inputmode="decimal" placeholder="ç”¨é‡" class="w-full px-1 py-2 text-sm text-center border-none outline-none bg-white/80 dark:bg-slate-700/50 rounded-lg text-gray-800 dark:text-slate-100" oninput="updateAutoFields(this)">
                    <button class="unit-btn ml-1 px-1.5 py-0.5 text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded hover:bg-purple-200 dark:hover:bg-purple-900/50 active:scale-95 transition-all" onclick="showUnitSelector(this)">g</button>
                </div>
                <div class="flex flex-col gap-1 min-w-[50px]">
                    <div class="cost-field text-emerald-600 dark:text-emerald-400 select-none text-xs font-medium bg-emerald-50 dark:bg-emerald-900/20 px-1 py-0.5 rounded text-center">Â¥0.00</div>
                    <span class="percent-field text-slate-500 dark:text-slate-400 select-none text-xs font-medium bg-slate-50 dark:bg-slate-800/50 px-1 py-0.5 rounded text-center">0%</span>
                </div>
                <div class="delete-action"><i class="fas fa-trash-alt mr-1"></i> åˆ é™¤</div>
            `;
            container.appendChild(div);
            initSwipeDelete(div);
            updateSortable();
            updateVariationTotal();
            // æ›´æ–°ç»Ÿè®¡
            if (type === 'base2') {
                updateBase2SingleStats();
            } else if (type.startsWith('base') && type !== 'base' && type !== 'base2') {
                // ä¸ºæ–°çš„å˜åŒ–æ¬¾æ¨¡å—è°ƒç”¨ç›¸åº”çš„ç»Ÿè®¡å‡½æ•°
                updateVariationSingleStats(type);
            }
        }

        // æ‹–æ‹½æ’åºåˆå§‹åŒ–
        function updateSortable() {
            document.querySelectorAll('.ingredients-group').forEach(el => {
                if (!el.sortable) {
                    el.sortable = new Sortable(el, {
                        group: { name: 'ingredients', pull: true, put: true },
                        handle: '.drag-handle',
                        animation: 180,
                        ghostClass: 'bg-purple-100',
                        chosenClass: 'ring-2 ring-purple-400',
                        onEnd: function() {
                            updateAllAutoFields();
                        }
                    });
                }
            });
        }

        // æ‹–æ‹½ååˆ·æ–°æ‰€æœ‰åˆ†ç»„è‡ªåŠ¨å­—æ®µ
        function updateAllAutoFields() {
            document.querySelectorAll('.ingredients-group').forEach(group => {
                Array.from(group.children).forEach(row => {
                    updateAutoFields(row.querySelector('input[type="number"]') || row.querySelector('input[type="text"]'));
                });
            });
        }

        // å•ä½é€‰æ‹©å™¨åŠŸèƒ½
        let currentUnitButton = null;
        
        function showUnitSelector(button) {
            currentUnitButton = button;
            const row = button.closest('.ingredient-item');
            const nameInput = row.querySelector('.name-input');
            const materialName = nameInput.value;
            
            // è·å–è¯¥ææ–™æ”¯æŒçš„å•ä½
            const materialData = materialPrices[materialName];
            const availableUnits = materialData ? materialData.units : ['g', 'kg'];
            
            // ç”Ÿæˆå•ä½é€‰é¡¹
            const unitList = document.getElementById('unit-selector-list');
            unitList.innerHTML = '';
            
            availableUnits.forEach(unit => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-400 hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-all text-sm font-medium';
                btn.textContent = unit;
                btn.onclick = () => selectUnit(unit);
                unitList.appendChild(btn);
            });
            
            document.getElementById('unit-selector-popup').classList.remove('hidden');
        }
        
        function selectUnit(unit) {
            if (!currentUnitButton) return;
            
            const input = currentUnitButton.parentElement.querySelector('input');
            const currentValue = parseFloat(input.value) || 0;
            const currentUnit = currentUnitButton.textContent;
            
            // å•ä½è½¬æ¢é€»è¾‘
            if (currentValue > 0) {
                let newValue = currentValue;
                
                // ä»å½“å‰å•ä½è½¬æ¢ä¸ºæ ‡å‡†å•ä½ï¼ˆgæˆ–mlï¼‰
                if (currentUnit === 'kg') newValue *= 1000;
                else if (currentUnit === 'æ–¤') newValue *= 500;
                else if (currentUnit === 'L') newValue *= 1000;
                
                // ä»æ ‡å‡†å•ä½è½¬æ¢ä¸ºç›®æ ‡å•ä½
                if (unit === 'kg') newValue /= 1000;
                else if (unit === 'æ–¤') newValue /= 500;
                else if (unit === 'L') newValue /= 1000;
                
                input.value = newValue.toFixed(unit === 'g' || unit === 'ml' || unit === 'ä¸ª' ? 0 : 3);
            }
            
            currentUnitButton.textContent = unit;
            closeUnitSelector();
            updateAutoFields(input);
        }
        
        function closeUnitSelector() {
            document.getElementById('unit-selector-popup').classList.add('hidden');
            currentUnitButton = null;
        }
        
        // è·å–æ ‡å‡†åŒ–é‡é‡ï¼ˆç»Ÿä¸€è½¬æ¢ä¸ºå…‹ï¼‰
        function getStandardWeight(input) {
            const value = parseFloat(input.value) || 0;
            const unitBtn = input.parentElement.querySelector('.unit-btn');
            const unit = unitBtn ? unitBtn.textContent : 'g';
            return unit === 'kg' ? value * 1000 : value;
        }

        // ç™¾åˆ†æ¯”ä»¥é¢ç²‰ä¸ºåŸºå‡†ï¼Œè®¡ç®—é‡‘é¢
        function updateAutoFields(input) {
            const row = input.closest('.flex');
            // ç”±äºé¢ç²‰æ¨¡å—å·²åˆ é™¤ï¼Œç™¾åˆ†æ¯”è®¡ç®—æš‚æ—¶è®¾ä¸º0
            let flourTotal = 0;
            // å½“å‰åˆ†ç»„
            const container = row.parentElement;
            const allRows = Array.from(container.children);
            allRows.forEach(r => {
                const qty = r.querySelector('input[placeholder="ç”¨é‡"]');
                const percent = r.querySelector('.percent-field');
                const costField = r.querySelector('.cost-field');
                const nameInput = r.querySelector('.name-input');
                
                if (!qty || !nameInput) return; // è·³è¿‡æ— æ•ˆçš„è¡Œ
                
                const val = getStandardWeight(qty);
                
                // ç™¾åˆ†æ¯”åŠŸèƒ½å·²ç§»é™¤
                if (percent) {
                    percent.textContent = '0.00%';
                }
                
                // è®¡ç®—é‡‘é¢
                if (costField) {
                    if (nameInput.value) {
                        const materialData = materialPrices[nameInput.value];
                        if (materialData && val > 0) {
                            // ä»·æ ¼æ˜¯æ¯100gçš„ä»·æ ¼ï¼Œè½¬æ¢ä¸ºå®é™…ç”¨é‡çš„ä»·æ ¼
                            const cost = (val / 100) * materialData.price;
                            costField.textContent = 'Â¥' + cost.toFixed(2);
                        } else {
                            costField.textContent = 'Â¥0.00';
                        }
                    } else {
                        costField.textContent = 'Â¥0.00';
                    }
                    // æˆæœ¬å­—æ®µå§‹ç»ˆæ˜¾ç¤ºï¼Œä¸å†éšè—
                }
                
                // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
                if (nameInput && nameInput.classList.contains('name-input')) {
                    updateSyncStatusDisplay(nameInput);
                }
            });
            updateTotalWeight();
            updateVariationTotal();
            updateTotalCost();
            // å¦‚æœæ˜¯åŸºç¡€é¢å›¢åˆ†ç»„çš„é…æ–™å˜åŒ–ï¼Œæ›´æ–°å•ä¸ªç»Ÿè®¡
            // åŸºç¡€é¢å›¢æ¨¡å—å·²åˆ é™¤
             if (container && container.id === 'base2Ingredients') {
                 updateBase2SingleStats();
             } else if (container && container.id && container.id.endsWith('Ingredients')) {
                const moduleId = container.id.replace('Ingredients', '');
                if (moduleId.startsWith('base') && moduleId !== 'base' && moduleId !== 'base2') {
                    updateVariationSingleStats(moduleId);
                }
            }
        }

        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatusDisplay(nameInput) {
            if (!nameInput) return;
            
            const container = nameInput.closest('.relative');
            if (!container) return;
            
            const syncedText = container.querySelector('.synced-text');
            const notSyncedText = container.querySelector('.not-synced-text');
            
            // å¦‚æœææ–™åç§°ä¸ºç©ºï¼Œéšè—æ‰€æœ‰çŠ¶æ€æ–‡å­—
            if (!nameInput.value || nameInput.value.trim() === '') {
                if (syncedText) syncedText.style.display = 'none';
                if (notSyncedText) notSyncedText.style.display = 'none';
                return;
            }
            
            // æœ‰ææ–™åç§°æ—¶ï¼Œæ ¹æ®åŒæ­¥çŠ¶æ€æ˜¾ç¤ºç›¸åº”æ–‡å­—
            if (nameInput.classList.contains('synced')) {
                if (syncedText) syncedText.style.display = 'block';
                if (notSyncedText) notSyncedText.style.display = 'none';
            } else {
                if (syncedText) syncedText.style.display = 'none';
                if (notSyncedText) notSyncedText.style.display = 'block';
            }
        }

        // åŒæ­¥çŠ¶æ€åˆ‡æ¢
        function toggleSync(element) {
            if (!element) return;
            
            const ingredientItem = element.closest('.ingredient-item');
            if (!ingredientItem) return;
            
            const nameInput = ingredientItem.querySelector('.name-input');
            if (!nameInput) return;
            
            if (nameInput.classList.contains('synced')) {
                nameInput.classList.remove('synced');
                nameInput.classList.add('not-synced');
            } else {
                nameInput.classList.remove('not-synced');
                nameInput.classList.add('synced');
            }
            updateSyncStatusDisplay(nameInput);
            updateAutoFields(nameInput);
        }

        // æ€»é‡=åŸºç¡€é¢å›¢+æ‰€æœ‰å˜åŒ–æ¬¾é‡Œçš„é¢å›¢ï¼Œè¶…5ä½è‡ªåŠ¨åˆ‡kg
        function updateTotalWeight() {
            let total = 0;
            // åŸºç¡€é¢å›¢æ¨¡å—å·²åˆ é™¤
        // document.querySelectorAll(`#baseIngredients input[placeholder="ç”¨é‡"]`).forEach(input => {
        //        total += getStandardWeight(input);
        //    });
            document.querySelectorAll('.variation-group').forEach(group => {
                group.querySelectorAll('input[placeholder="ç”¨é‡"]').forEach(input => {
                    total += getStandardWeight(input);
                });
            });
            let display = '';
            if(total>=100000) {
                display = (total/1000).toFixed(2)+' kg';
            } else {
                display = total.toFixed(2)+' g';
            }
            document.getElementById('totalWeight').textContent = display;
        }

        // è®¡ç®—æ€»æˆæœ¬
        function updateTotalCost() {
            let totalCost = 0;
            
            // è®¡ç®—æ‰€æœ‰åˆ†ç»„çš„æˆæœ¬
            document.querySelectorAll('.ingredient-item').forEach(row => {
                const nameInput = row.querySelector('.name-input');
                const qtyInput = row.querySelector('input[placeholder="ç”¨é‡"]');
                
                if (nameInput && nameInput.value && qtyInput && qtyInput.value) {
                    const materialData = materialPrices[nameInput.value];
                    if (materialData) {
                        const val = getStandardWeight(qtyInput);
                        const cost = (val / 100) * materialData.price;
                        totalCost += cost;
                    }
                }
            });
            
            // æ›´æ–°æ€»æˆæœ¬æ˜¾ç¤º
            const totalCostElement = document.getElementById('totalCost');
            if (totalCostElement) {
                totalCostElement.textContent = 'Â¥' + totalCost.toFixed(2);
            }
        }
        
        // åŸºç¡€é¢å›¢æ¨¡å—å·²åˆ é™¤
        // è®¡ç®—åŸºç¡€é¢å›¢å•ä¸ªé‡é‡å’Œæˆæœ¬
        // function updateBaseSingleStats() {
        //     const baseContainer = document.getElementById('baseIngredients');
        //     const baseSingleStats = document.getElementById('baseSingleStats');
        //     const baseSingleWeight = document.getElementById('baseSingleWeight');
        //     const baseSingleCost = document.getElementById('baseSingleCost');
        //     
        //     if (!baseContainer || !baseSingleStats) return;
        //     
        //     let totalWeight = 0;
        //     let totalCost = 0;
        //     let hasOtherIngredients = false;
        //     
        //     // è®¡ç®—åŸºç¡€é¢å›¢ä¸­æ‰€æœ‰é…æ–™çš„é‡é‡å’Œæˆæœ¬
        //     const ingredientItems = baseContainer.querySelectorAll('.ingredient-item');
        //     ingredientItems.forEach((item, index) => {
        //         const nameInput = item.querySelector('.name-input');
        //         const qtyInput = item.querySelector('input[placeholder="ç”¨é‡"]');
        //         
        //         if (nameInput && nameInput.value && qtyInput && qtyInput.value) {
        //             const weight = getStandardWeight(qtyInput);
        //             totalWeight += weight;
        //             
        //             // è®¡ç®—æˆæœ¬
        //             const materialData = materialPrices[nameInput.value];
        //             if (materialData) {
        //                 const cost = (weight / 100) * materialData.price;
        //                 totalCost += cost;
        //             }
        //             
        //             // æ£€æŸ¥æ˜¯å¦æœ‰é™¤ç¬¬ä¸€ä¸ªï¼ˆåŸºç¡€é¢å›¢ï¼‰å¤–çš„å…¶ä»–é…æ–™
        //             if (index > 0) {
        //                 hasOtherIngredients = true;
        //             }
        //         }
        //     });
        //     
        //     // æ›´æ–°æ˜¾ç¤º
        //     if (baseSingleWeight) {
        //         baseSingleWeight.textContent = totalWeight.toFixed(1) + 'g';
        //     }
        //     if (baseSingleCost) {
        //         baseSingleCost.textContent = 'Â¥' + totalCost.toFixed(2);
        //     }
        //     
        //     // æ ¹æ®æ˜¯å¦æœ‰å…¶ä»–é…æ–™å†³å®šæ˜¾ç¤ºå†…å®¹
        //      const weightDiv = document.getElementById('baseSingleWeightDiv');
        //      const costDiv = document.getElementById('baseSingleCostDiv');
        //      
        //      if (ingredientItems.length > 0) {
        //          // æœ‰é…æ–™æ—¶æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸ
        //          baseSingleStats.classList.remove('hidden');
        //          
        //          if (hasOtherIngredients) {
        //              // æœ‰å…¶ä»–é…æ–™æ—¶æ˜¾ç¤ºå•ä¸ªæ€»é‡å’Œå•ä¸ªæˆæœ¬
        //              if (weightDiv) weightDiv.style.display = 'flex';
        //              if (costDiv) costDiv.style.display = 'flex';
        //          } else {
        //              // åªæœ‰åŸºç¡€é¢å›¢æ—¶åªæ˜¾ç¤ºå•ä¸ªæˆæœ¬ï¼Œéšè—å•ä¸ªæ€»é‡
        //              if (weightDiv) weightDiv.style.display = 'none';
        //              if (costDiv) costDiv.style.display = 'flex';
        //          }
        //      } else {
        //          // æ²¡æœ‰ä»»ä½•é…æ–™æ—¶éšè—æ•´ä¸ªç»Ÿè®¡åŒºåŸŸ
        //          baseSingleStats.classList.add('hidden');
        //      }
        // }
        
        // æ›´æ–°åŸºç¡€é¢å›¢2å•ä¸ªç»Ÿè®¡
        function updateBase2SingleStats() {
            const base2Container = document.getElementById('base2Ingredients');
            const base2SingleStats = document.getElementById('base2SingleStats');
            const base2SingleWeight = document.getElementById('base2SingleWeight');
            const base2SingleCost = document.getElementById('base2SingleCost');
            
            if (!base2Container || !base2SingleStats) return;
            
            let totalWeight = 0;
            let totalCost = 0;
            let hasOtherIngredients = false;
            
            // è®¡ç®—åŸºç¡€é¢å›¢2ä¸­æ‰€æœ‰é…æ–™çš„é‡é‡å’Œæˆæœ¬
            const ingredientItems = base2Container.querySelectorAll('.ingredient-item');
            ingredientItems.forEach((item, index) => {
                const nameInput = item.querySelector('.name-input');
                const qtyInput = item.querySelector('input[placeholder="ç”¨é‡"]');
                
                if (nameInput && nameInput.value && qtyInput && qtyInput.value) {
                    const weight = getStandardWeight(qtyInput);
                    totalWeight += weight;
                    
                    // è®¡ç®—æˆæœ¬
                    const materialData = materialPrices[nameInput.value];
                    if (materialData) {
                        const cost = (weight / 100) * materialData.price;
                        totalCost += cost;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰é™¤ç¬¬ä¸€ä¸ªï¼ˆåŸºç¡€é¢å›¢2ï¼‰å¤–çš„å…¶ä»–é…æ–™
                    if (index > 0) {
                        hasOtherIngredients = true;
                    }
                }
            });
            
            // æ›´æ–°æ˜¾ç¤º
            if (base2SingleWeight) {
                base2SingleWeight.textContent = totalWeight.toFixed(1) + 'g';
            }
            if (base2SingleCost) {
                base2SingleCost.textContent = 'Â¥' + totalCost.toFixed(2);
            }
            
            // æ ¹æ®æ˜¯å¦æœ‰å…¶ä»–é…æ–™å†³å®šæ˜¾ç¤ºå†…å®¹
             const weightDiv = document.getElementById('base2SingleWeightDiv');
             const costDiv = document.getElementById('base2SingleCostDiv');
             
             if (ingredientItems.length > 0) {
                 // æœ‰é…æ–™æ—¶æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸ
                 base2SingleStats.classList.remove('hidden');
                 
                 if (hasOtherIngredients) {
                     // æœ‰å…¶ä»–é…æ–™æ—¶æ˜¾ç¤ºå•ä¸ªæ€»é‡å’Œå•ä¸ªæˆæœ¬
                     if (weightDiv) weightDiv.style.display = 'flex';
                     if (costDiv) costDiv.style.display = 'flex';
                 } else {
                     // åªæœ‰åŸºç¡€é¢å›¢2æ—¶åªæ˜¾ç¤ºå•ä¸ªæˆæœ¬ï¼Œéšè—å•ä¸ªæ€»é‡
                     if (weightDiv) weightDiv.style.display = 'none';
                     if (costDiv) costDiv.style.display = 'flex';
                 }
             } else {
                 // æ²¡æœ‰ä»»ä½•é…æ–™æ—¶éšè—æ•´ä¸ªç»Ÿè®¡åŒºåŸŸ
                 base2SingleStats.classList.add('hidden');
             }
        }
        
        // æ›´æ–°æ–°å˜åŒ–æ¬¾æ¨¡å—å•ä¸ªç»Ÿè®¡
        function updateVariationSingleStats(moduleId) {
            const container = document.getElementById(`${moduleId}Ingredients`);
            const singleStats = document.getElementById(`${moduleId}SingleStats`);
            const singleWeight = document.getElementById(`${moduleId}SingleWeight`);
            const singleCost = document.getElementById(`${moduleId}SingleCost`);
            
            if (!container || !singleStats) return;
            
            let totalWeight = 0;
            let totalCost = 0;
            let hasOtherIngredients = false;
            
            // è®¡ç®—è¯¥å˜åŒ–æ¬¾æ¨¡å—ä¸­æ‰€æœ‰é…æ–™çš„é‡é‡å’Œæˆæœ¬
            const ingredientItems = container.querySelectorAll('.ingredient-item');
            ingredientItems.forEach((item, index) => {
                const nameInput = item.querySelector('.name-input');
                const qtyInput = item.querySelector('input[placeholder="ç”¨é‡"]');
                
                if (nameInput && nameInput.value && qtyInput && qtyInput.value) {
                    const weight = getStandardWeight(qtyInput);
                    totalWeight += weight;
                    
                    // è®¡ç®—æˆæœ¬
                    const materialData = materialPrices[nameInput.value];
                    if (materialData) {
                        const cost = (weight / 100) * materialData.price;
                        totalCost += cost;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰é™¤ç¬¬ä¸€ä¸ªï¼ˆå˜åŒ–æ¬¾é¢å›¢ï¼‰å¤–çš„å…¶ä»–é…æ–™
                    if (index > 0) {
                        hasOtherIngredients = true;
                    }
                }
            });
            
            // æ›´æ–°æ˜¾ç¤º
            if (singleWeight) {
                singleWeight.textContent = totalWeight.toFixed(1) + 'g';
            }
            if (singleCost) {
                singleCost.textContent = 'Â¥' + totalCost.toFixed(2);
            }
            
            // æ ¹æ®æ˜¯å¦æœ‰å…¶ä»–é…æ–™å†³å®šæ˜¾ç¤ºå†…å®¹
            const weightDiv = document.getElementById(`${moduleId}SingleWeightDiv`);
            const costDiv = document.getElementById(`${moduleId}SingleCostDiv`);
            
            if (ingredientItems.length > 0) {
                // æœ‰é…æ–™æ—¶æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸ
                singleStats.classList.remove('hidden');
                
                if (hasOtherIngredients) {
                    // æœ‰å…¶ä»–é…æ–™æ—¶æ˜¾ç¤ºå•ä¸ªæ€»é‡å’Œå•ä¸ªæˆæœ¬
                    if (weightDiv) weightDiv.style.display = 'flex';
                    if (costDiv) costDiv.style.display = 'flex';
                } else {
                    // åªæœ‰å˜åŒ–æ¬¾é¢å›¢æ—¶åªæ˜¾ç¤ºå•ä¸ªæˆæœ¬ï¼Œéšè—å•ä¸ªæ€»é‡
                    if (weightDiv) weightDiv.style.display = 'none';
                    if (costDiv) costDiv.style.display = 'flex';
                }
            } else {
                // æ²¡æœ‰ä»»ä½•é…æ–™æ—¶éšè—æ•´ä¸ªç»Ÿè®¡åŒºåŸŸ
                singleStats.classList.add('hidden');
            }
        }
        
        // ç›‘å¬ç”¨é‡è¾“å…¥å˜åŒ–
        document.addEventListener('input', function(e) {
            if (e.target.placeholder === 'ç”¨é‡') {
                updateTotalWeight();
                updateTotalCost();
                // updateBaseSingleStats(); // åŸºç¡€é¢å›¢æ¨¡å—å·²åˆ é™¤
                updateBase2SingleStats();
                
                // æ›´æ–°æ‰€æœ‰æ–°å˜åŒ–æ¬¾æ¨¡å—çš„ç»Ÿè®¡
                const container = e.target.closest('[id$="Ingredients"]');
                if (container) {
                    const moduleId = container.id.replace('Ingredients', '');
                    if (moduleId.startsWith('base') && moduleId !== 'base' && moduleId !== 'base2') {
                        updateVariationSingleStats(moduleId);
                    }
                }
            }
        });
        
        // ç›‘å¬é…æ–™åç§°å˜åŒ–
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('name-input')) {
                // updateBaseSingleStats(); // åŸºç¡€é¢å›¢æ¨¡å—å·²åˆ é™¤
                updateBase2SingleStats();
                
                // æ›´æ–°æ‰€æœ‰æ–°å˜åŒ–æ¬¾æ¨¡å—çš„ç»Ÿè®¡
                const container = e.target.closest('[id$="Ingredients"]');
                if (container) {
                    const moduleId = container.id.replace('Ingredients', '');
                    if (moduleId.startsWith('base') && moduleId !== 'base' && moduleId !== 'base2') {
                        updateVariationSingleStats(moduleId);
                    }
                }
            }
        });

        // å›¾ç‰‡è£å‰ªç›¸å…³å˜é‡
        let cropper = null;
        let currentImageFile = null;

        // å›¾ç‰‡ä¸Šä¼ é¢„è§ˆï¼ˆæ”¯æŒè£å‰ªï¼‰
        document.getElementById('coverImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                    return;
                }
                currentImageFile = file;
                openCropModal(file);
            }
        });

        // æ‰“å¼€è£å‰ªå¼¹çª—
        function openCropModal(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const cropImage = document.getElementById('cropImage');
                cropImage.src = e.target.result;
                
                // æ˜¾ç¤ºå¼¹çª—
                document.getElementById('cropModal').classList.remove('hidden');
                
                // åˆå§‹åŒ–è£å‰ªå™¨ï¼ˆæ­£æ–¹å½¢è£å‰ªï¼‰
                setTimeout(() => {
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(cropImage, {
                        aspectRatio: 1, // æ­£æ–¹å½¢æ¯”ä¾‹
                        viewMode: 1,
                        guides: true,
                        center: true,
                        autoCropArea: 0.8,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        preview: '#cropPreview',
                        ready: function() {
                            // è£å‰ªå™¨åˆå§‹åŒ–å®Œæˆ
                        }
                    });
                }, 100);
            };
            reader.readAsDataURL(file);
        }

        // å…³é—­è£å‰ªå¼¹çª—
        function closeCropModal() {
            document.getElementById('cropModal').classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            document.getElementById('coverImage').value = '';
        }

        // ç¡®è®¤è£å‰ª
        function confirmCrop() {
            if (!cropper) return;
            
            // è·å–è£å‰ªåçš„ç”»å¸ƒ
            const canvas = cropper.getCroppedCanvas({
                width: 400, // è¾“å‡ºå°ºå¯¸ï¼š400x400åƒç´ ï¼Œä¿è¯è´¨é‡
                height: 400,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            // è½¬æ¢ä¸ºé«˜è´¨é‡çš„å›¾ç‰‡
            const croppedImageDataUrl = canvas.toDataURL('image/jpeg', 0.9); // 90%è´¨é‡
            
            // æ›´æ–°é¢„è§ˆ
            document.getElementById('imagePreview').innerHTML = `
                <img src="${croppedImageDataUrl}" class="w-full h-full object-cover rounded-xl">
            `;
            
            // å…³é—­å¼¹çª—
            closeCropModal();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showNotification('âœ… å›¾ç‰‡è£å‰ªå®Œæˆ');
        }

        // Tabåˆ‡æ¢åŠŸèƒ½
        function switchTab(tab) {
            console.log('switchTab called with:', tab);
            // æ›´æ–°TabæŒ‰é’®çŠ¶æ€
            const tabs = ['recipe', 'step'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-btn-${t}`);
                const section = document.getElementById(`${t}-section`);
                
                if (t === tab) {
                    btn.classList.add('tab-active', 'tab-bg-active');
                    btn.classList.remove('tab-inactive', 'tab-bg-inactive');
                    section.classList.remove('hidden');
                } else {
                    btn.classList.remove('tab-active', 'tab-bg-active');
                    btn.classList.add('tab-inactive', 'tab-bg-inactive');
                    section.classList.add('hidden');
                }
            });
            
            // åˆ‡æ¢é…æ–¹ä¿¡æ¯æ˜¾ç¤ºï¼ˆé…æ–¹åç§°å’Œåˆ†ç±»é€‰æ‹©ä»…åœ¨é…æ–¹é¡µé¢æ˜¾ç¤ºï¼‰
            const recipeMetaSection = document.getElementById('recipe-meta-section');
            if (recipeMetaSection) {
                if (tab === 'recipe') {
                    recipeMetaSection.classList.remove('hidden');
                } else {
                    recipeMetaSection.classList.add('hidden');
                }
            }
            
            // æ›´æ–°åº•éƒ¨æ æ˜¾ç¤º
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                const totalWeightCard = saveBtn.parentElement.querySelector('.flex.items-center');
                if(tab==='step') {
                    saveBtn.textContent = 'ä¿å­˜';
                    if (totalWeightCard) totalWeightCard.classList.add('hidden');
                    saveBtn.classList.add('w-full');
                } else {
                    saveBtn.textContent = 'ä¿å­˜';
                    if (totalWeightCard) totalWeightCard.classList.remove('hidden');
                    saveBtn.classList.remove('w-full');
                }
            }
            
            // æ­¥éª¤é¦–æ¬¡æ‰“å¼€æ—¶åˆå§‹åŒ–æ•°æ®
            if(tab==='step' && document.getElementById('stepsList') && document.getElementById('stepsList').children.length === 0) {
                initSteps();
            }
        }

        // å˜åŒ–æ¬¾æ¨¡å—åŠ¨æ€æ·»åŠ 
        let variationCount = 1; // ä»1å¼€å§‹ï¼Œå› ä¸ºå·²æœ‰ä¸€ä¸ªå˜åŒ–æ¬¾æ¨¡å—
        function addVariationGroup() {
            variationCount++;
            const id = `base${variationCount + 1}`; // base3, base4, etc.
            
            // åˆ›å»ºæ–°çš„å˜åŒ–æ¬¾æ¨¡å—
            const newVariationModule = document.createElement('div');
            newVariationModule.className = 'card p-3 bg-gradient-to-br from-white via-pink-50/30 to-white dark:from-[#1E293B] dark:via-pink-900/10 dark:to-[#1E293B] border-pink-200/50 dark:border-pink-800/30';
            newVariationModule.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg flex items-center justify-center mr-2 shadow-sm">
                            <i class="fas fa-magic text-white text-xs"></i>
                        </div>
                        <div>
                            <input type="text" value="å˜åŒ–æ¬¾${variationCount}" class="font-semibold text-gray-800 dark:text-slate-100 text-sm bg-transparent border-none outline-none focus:bg-white dark:focus:bg-slate-700 focus:border focus:border-pink-300 dark:focus:border-pink-600 rounded px-1 py-0.5 transition-all" maxlength="20">
                            <p class="text-xs text-pink-600 dark:text-pink-400 font-medium">åˆ›æ„å»¶ä¼¸</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button class="bg-gradient-to-r from-pink-500 to-pink-600 text-white hover:shadow-lg active:scale-95 rounded-lg px-2 py-1 transition-all flex items-center text-xs font-medium" onclick="addIngredient('${id}')">
                            <i class="fas fa-plus mr-1"></i>
                            <span>æ·»åŠ </span>
                        </button>
                        <button class="bg-gradient-to-r from-red-500 to-red-600 text-white hover:shadow-lg active:scale-95 rounded-lg px-2 py-1 transition-all flex items-center text-xs font-medium" onclick="removeVariationModule(this)">
                            <i class="fas fa-trash mr-1"></i>
                            <span>åˆ é™¤</span>
                        </button>
                    </div>
                </div>
                <div id="${id}Ingredients" class="space-y-2"></div>
                <!-- å˜åŒ–æ¬¾å•ä¸ªé‡é‡å’Œæˆæœ¬æ˜¾ç¤º -->
                <div id="${id}SingleStats" class="mt-3 pt-3 border-t border-pink-200 dark:border-pink-800 hidden">
                    <div class="flex items-center justify-between text-xs">
                        <div class="flex items-center gap-4">
                            <div id="${id}SingleWeightDiv" class="flex items-center gap-1">
                                <span class="text-gray-600 dark:text-gray-400">å•ä¸ªæ€»é‡:</span>
                                <span id="${id}SingleWeight" class="font-semibold text-pink-600 dark:text-pink-400">0g</span>
                            </div>
                            <div id="${id}SingleCostDiv" class="flex items-center gap-1">
                                <span class="text-gray-600 dark:text-gray-400">å•ä¸ªæˆæœ¬:</span>
                                <span id="${id}SingleCost" class="font-semibold text-green-600 dark:text-green-400">Â¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ‰¾åˆ°æ·»åŠ å˜åŒ–æ¬¾æŒ‰é’®çš„å®¹å™¨ï¼Œåœ¨å®ƒä¹‹å‰æ’å…¥æ–°æ¨¡å—
            const addButtonContainer = document.querySelector('#addVariationGroupBtn').parentElement;
            addButtonContainer.parentElement.insertBefore(newVariationModule, addButtonContainer);
        }
        
        // åˆ é™¤å˜åŒ–æ¬¾æ¨¡å—
        function removeVariationModule(button) {
            const module = button.closest('.card');
            if (module) {
                module.remove();
                updateTotalWeight();
                updateTotalCost();
            }
        }
        
        // ç§»é™¤é‡å¤çš„äº‹ä»¶ç»‘å®šï¼Œç»Ÿä¸€åœ¨DOMContentLoadedä¸­å¤„ç†

        // æ›´æ–°å˜åŒ–æ¬¾åˆ†ç»„æ€»é‡
        function updateVariationTotal() {
            // æ—§çš„å˜åŒ–æ¬¾åˆ†ç»„
            const old = document.getElementById('variationIngredients');
            if(old) {
                const allRows = Array.from(old.children);
                let total = 0;
                allRows.forEach(r => {
                    const qty = r.querySelector('input[type="number"]');
                    total += parseFloat(qty?.value) || 0;
                });
                const totalDiv = document.getElementById('variationTotal');
                if(allRows.length>1 && total>0){
                    totalDiv.textContent = 'å˜åŒ–æ¬¾æ€»é‡ï¼š' + total + 'g';
                    totalDiv.classList.remove('hidden');
                }else{
                    totalDiv.classList.add('hidden');
                }
            }
            // æ–°çš„åŠ¨æ€å˜åŒ–æ¬¾åˆ†ç»„
            document.querySelectorAll('.variation-group').forEach(group => {
                const container = group.querySelector('.ingredients-group');
                const totalDiv = group.querySelector('div[id$="Total"]');
                const allRows = Array.from(container.children);
                let total = 0;
                allRows.forEach(r => {
                    const qty = r.querySelector('input[type="number"]');
                    total += parseFloat(qty?.value) || 0;
                });
                if(allRows.length>1 && total>0){
                    totalDiv.textContent = 'å˜åŒ–æ¬¾æ€»é‡ï¼š' + total + 'g';
                    totalDiv.classList.remove('hidden');
                }else{
                    totalDiv.classList.add('hidden');
                }
            });
        }

        // åŸºç¡€é¢å›¢å¿…å¡«æ ¡éªŒ
        function validateBase() {
            const baseRows = document.getElementById('baseIngredients').children;
            if(baseRows.length===0){
                alert('åŸºç¡€é¢å›¢ä¸ºå¿…å¡«é¡¹ï¼');
                return false;
            }
            return true;
        }

        // æ‹ç…§/æ‰«æäº¤äº’å¼¹çª—
        function openCamera() {
            document.getElementById('cameraModal').classList.remove('hidden');
            // åœ¨çœŸå®ç¯å¢ƒä¸­è¿™é‡Œä¼šåˆå§‹åŒ–ç›¸æœº
            setTimeout(() => {
                document.getElementById('cameraPreview').classList.remove('hidden');
            }, 300);
        }
        
        function closeCamera() {
            document.getElementById('cameraModal').classList.add('hidden');
            document.getElementById('cameraPreview').classList.add('hidden');
        }
        
        function takePhoto() {
            // æ¨¡æ‹Ÿæ‹ç…§æ•ˆæœ
            const flashEffect = document.getElementById('cameraFlash');
            flashEffect.classList.remove('hidden');
            flashEffect.classList.add('opacity-100');
            
            setTimeout(() => {
                flashEffect.classList.remove('opacity-100');
                flashEffect.classList.add('opacity-0');
            }, 100);
            
            setTimeout(() => {
                flashEffect.classList.add('hidden');
                flashEffect.classList.remove('opacity-0');
                showNotification('âœ… å·²è‡ªåŠ¨è¯†åˆ«é…æ–¹å†…å®¹');
                closeCamera();
            }, 500);
        }
        
        function openScan() {
            alert('æ¨¡æ‹Ÿæ‰‹å†™é…æ–¹è¯†åˆ«ç•Œé¢ï¼Œè¯†åˆ«åè‡ªåŠ¨å¡«å……åˆ°é…æ–¹ï¼ˆåç»­å¯å¯¹æ¥APIï¼‰');
        }

        // æ–°å»ºç±»åˆ«å¼¹çª—äº¤äº’
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.remove('hidden');
            document.getElementById('newCategoryInput').value = '';
            setTimeout(()=>{document.getElementById('newCategoryInput').focus();},100);
        }
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
        }
        function addNewCategory() {
            const val = document.getElementById('newCategoryInput').value.trim();
            if(val) {
                const select = document.getElementById('categorySelect');
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                select.appendChild(opt);
                select.value = val;
                closeCategoryModal();
            }
        }

        // æ­¥éª¤ç®¡ç†ï¼ˆä¸“ä¸šUIè®¾è®¡ï¼‰
        let stepCount = 0;
        let currentStepRow = null;
        let currentMediaSlot = null;
        
        function initSteps() {
            // åˆå§‹åŒ–3ä¸ªç¤ºä¾‹æ­¥éª¤ï¼Œåˆ†åˆ«å±•ç¤º1å¼ ã€2å¼ å’Œ3å¼ å›¾ç‰‡çš„å¸ƒå±€
            const defaultSteps = [
                { title: 'æ­¥éª¤1ï¼ˆä¸€å¼ å›¾ç‰‡ç¤ºä¾‹ï¼‰', content: 'å’Œé¢ï¼šå°†æ‰€æœ‰å¹²æ€§åŸæ–™æ··åˆï¼Œæ…¢æ…¢åŠ å…¥æ¶²ä½“åŸæ–™ï¼Œæ…æ‹Œè‡³é¢å›¢å…‰æ»‘ï¼Œæ³¨æ„æ§åˆ¶åŠ æ°´é€Ÿåº¦' },
                { title: 'æ­¥éª¤2ï¼ˆä¸¤å¼ å›¾ç‰‡ç¤ºä¾‹ï¼‰', content: 'å‘é…µï¼šå°†é¢å›¢æ”¾å…¥å‘é…µç®±ï¼Œæ¸©åº¦28â„ƒï¼Œæ¹¿åº¦75%ï¼Œå‘é…µ90åˆ†é’Ÿï¼Œç›´è‡³é¢å›¢ä½“ç§¯å¢å¤§ä¸€å€' },
                { title: 'æ­¥éª¤3ï¼ˆä¸‰å¼ å›¾ç‰‡ç¤ºä¾‹ï¼‰', content: 'æ•´å½¢ï¼šå°†å‘é…µå¥½çš„é¢å›¢åˆ†å‰²ï¼Œæ“€å¹³ï¼Œå·èµ·ï¼Œæ”¾å…¥æ¨¡å…·ä¸­è¿›è¡ŒäºŒæ¬¡å‘é…µï¼Œæ³¨æ„ä¿æŒé€‚å½“æ¾å¼›æ—¶é—´' }
            ];
            
            // åˆ›å»ºæ­¥éª¤å¹¶æ·»åŠ ç¤ºä¾‹å›¾ç‰‡
            defaultSteps.forEach((step, index) => {
                const stepElement = addStep(step.title, step.content);
                
                // æ ¹æ®æ­¥éª¤ç¼–å·æ·»åŠ ä¸åŒæ•°é‡çš„ç¤ºä¾‹å›¾ç‰‡
                const imageCount = index + 1; // æ­¥éª¤1æ·»åŠ 1å¼ å›¾ï¼Œæ­¥éª¤2æ·»åŠ 2å¼ å›¾ï¼Œæ­¥éª¤3æ·»åŠ 3å¼ å›¾
                addExampleImages(stepElement, imageCount);
            });
            
            updateStepSortable();
        }
        
        function addExampleImages(stepElement, count) {
            // ç¤ºä¾‹å›¾ç‰‡URLæ•°ç»„
            const sampleImageUrls = [
                'https://images.unsplash.com/photo-1506459225024-1428097a7e18?w=600&h=400&fit=crop',
                'https://images.unsplash.com/photo-1589367920969-ab8e050bbb04?w=600&h=400&fit=crop',
                'https://images.unsplash.com/photo-1600326145552-327f74b9c189?w=600&h=400&fit=crop',
                'https://images.unsplash.com/photo-1612200058850-8e661d819ded?w=600&h=400&fit=crop',
                'https://images.unsplash.com/photo-1509440159596-0249088772ff?w=600&h=400&fit=crop'
            ];
            
            // æ‰¾åˆ°åª’ä½“åŒºåŸŸå®¹å™¨
            const mediaContainer = stepElement.querySelector('.flex.overflow-x-auto');
            
            // åªæ¸…ç©ºåª’ä½“æ§½ï¼Œä¸å½±å“å…¶ä»–å†…å®¹
            mediaContainer.innerHTML = '';
            
            // æ·»åŠ æŒ‡å®šæ•°é‡çš„ç¤ºä¾‹å›¾ç‰‡
            for (let i = 0; i < count; i++) {
                const mediaSlot = document.createElement('div');
                mediaSlot.className = 'flex-none w-[70%] snap-center relative';
                
                // ä½¿ç”¨ç¤ºä¾‹å›¾ç‰‡URLï¼ˆå¾ªç¯ä½¿ç”¨ï¼‰
                const imageUrl = sampleImageUrls[i % sampleImageUrls.length];
                
                mediaSlot.innerHTML = `
                    <img src="${imageUrl}" alt="ç¤ºä¾‹å›¾ç‰‡${i+1}" class="rounded-lg w-full h-auto" onclick="showFullImage(this)">
                    <div class="absolute bottom-3 right-3 bg-black bg-opacity-60 text-white rounded-full p-2 hover:bg-opacity-80 transition-all" onclick="showFullImage(this.parentElement)">
                        <i class="fas fa-search-plus"></i>
                    </div>
                `;
                
                mediaContainer.appendChild(mediaSlot);
            }
            
            // å§‹ç»ˆæ·»åŠ ä¸€ä¸ªç©ºçš„ä¸Šä¼ æ§½
            const emptySlot = document.createElement('div');
            emptySlot.className = 'media-slot flex-none w-[70%] snap-center relative';
            emptySlot.innerHTML = `
                <div class="media-upload-area w-full h-20 rounded-lg flex items-center justify-center cursor-pointer transition-all border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-purple-500 hover:bg-gray-50 dark:hover:bg-slate-800" onclick="openMediaUpload(this)">
                    <div class="text-center text-slate-400 dark:text-slate-500">
                        <i class="fas fa-plus text-lg mb-1"></i>
                        <div class="text-xs">æ·»åŠ å›¾ç‰‡/è§†é¢‘</div>
                    </div>
                </div>
            `;
            mediaContainer.appendChild(emptySlot);
        }
        
        function addStep(stepTitle = '', stepContent = '') {
            stepCount++;
            const container = document.getElementById('stepsList');
            const div = document.createElement('div');
            div.className = 'step-row card';
             
            div.innerHTML = `
                <div class="flex items-center p-4 border-b border-slate-100 dark:border-slate-700">
                    <div class="w-10 h-10 gradient-primary text-white rounded-full flex items-center justify-center text-lg font-bold mr-3 step-number">
                        ${stepCount}
                        </div>
                    <input type="text" class="bg-transparent text-[#1E293B] dark:text-slate-100 font-bold border-none outline-none placeholder-slate-400 text-xl focus:bg-[#F8FAFC] dark:focus:bg-[#0F172A] rounded px-2 py-1" 
                           value="${stepTitle || 'æ­¥éª¤' + stepCount}" placeholder="æ­¥éª¤æ ‡é¢˜" />
                    <div class="flex items-center gap-2 ml-auto">
                        <button class="step-menu-btn text-gray-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-purple-400 active:scale-90 transition text-lg p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700" onclick="openStepMenu(this)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        <div class="step-drag-handle p-1.5 rounded-full hover:bg-[#F1F5F9] dark:hover:bg-[#334155] cursor-grab text-slate-400 dark:text-slate-500 transition" title="æ‹–æ‹½æ’åº">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                        </div>
                    </div>
                
                <div class="p-4">
                    <!-- æ­¥éª¤å†…å®¹è¾“å…¥ -->
                    <textarea class="w-full px-4 py-3 bg-gray-50 dark:bg-slate-800 text-gray-800 dark:text-slate-100 border border-slate-200 dark:border-slate-600 rounded-xl outline-none resize-none placeholder-slate-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 transition text-sm leading-relaxed mb-4" 
                              placeholder="è¯·è¾“å…¥è¯¦ç»†çš„åˆ¶ä½œæ­¥éª¤è¯´æ˜..." rows="3">${stepContent}</textarea>
                    
                    <!-- åª’ä½“ä¸Šä¼ åŒº -->
                    <div class="flex overflow-x-auto gap-3 pb-2 mb-2 snap-x">
                        <div class="media-slot flex-none w-[70%] snap-center relative">
                            <div class="media-upload-area w-full h-20 rounded-lg flex items-center justify-center cursor-pointer transition-all border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-purple-500 hover:bg-gray-50 dark:hover:bg-slate-800" onclick="openMediaUpload(this)">
                                <div class="text-center text-slate-400 dark:text-slate-500">
                                    <i class="fas fa-plus text-lg mb-1"></i>
                                    <div class="text-xs">æ·»åŠ å›¾ç‰‡/è§†é¢‘</div>
                </div>
                    </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            updateStepNumbers();
            return div;
        }
        

        
        // æ•°é‡è°ƒæ•´å‡½æ•°ï¼ˆç§»åŠ¨ç«¯å‹å¥½çš„æ­¥è¿›å™¨ï¼‰
        function adjustQuantity(btn, delta) {
            const input = btn.parentElement.querySelector('input[type="number"]');
            const currentValue = parseFloat(input.value) || 0;
            const step = parseFloat(input.step) || 1;
            const newValue = Math.max(0, currentValue + (delta * step));
            input.value = newValue;
            updateAutoFields(input);
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­æ‰€æœ‰èœå•å’Œå¼¹çª—
        document.addEventListener('click', function(e) {
            // å…³é—­æ­¥éª¤èœå•å¼¹çª—
            if(!e.target.closest('#stepMenuModal > div') && !e.target.closest('.step-menu-btn')) {
                const modal = document.getElementById('stepMenuModal');
                if(modal && !modal.classList.contains('hidden')) {
                    closeStepMenuModal();
                }
            }
            // å…³é—­åª’ä½“ä¸Šä¼ å¼¹çª—
            if(!e.target.closest('#mediaUploadModal > div') && !e.target.closest('.media-upload-area')) {
                const modal = document.getElementById('mediaUploadModal');
                if(modal && !modal.classList.contains('hidden')) {
                    closeMediaUploadModal();
                }
            }
            // å…³é—­å›¾ç‰‡è£å‰ªå¼¹çª—
            if(!e.target.closest('#cropModal > div') && !e.target.closest('#coverImage')) {
                const modal = document.getElementById('cropModal');
                if(modal && !modal.classList.contains('hidden')) {
                    closeCropModal();
                }
            }
        });
        
        function updateStepNumbers() {
            const steps = document.querySelectorAll('#stepsList .step-row');
            steps.forEach((step, index) => {
                const numberEl = step.querySelector('.step-number');
                if(numberEl) {
                    numberEl.textContent = index + 1;
                }
            });
        }
        
        function updateStepSortable() {
            const container = document.getElementById('stepsList');
            if (container && !container.sortable) {
                container.sortable = new Sortable(container, {
                    handle: '.step-drag-handle',
                    animation: 300,
                    ghostClass: 'opacity-50',
                    chosenClass: 'ring-2 ring-purple-400 scale-105',
                    easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                    onEnd: function() {
                        updateStepNumbers();
                    }
                });
            }
        }
        
        // æ­¥éª¤èœå•æ“ä½œ
        function openStepMenu(btn) {
            currentStepRow = btn.closest('.step-row');
            document.getElementById('stepMenuModal').classList.remove('hidden');
            
            // ç»‘å®šèœå•æ“ä½œ
            document.getElementById('stepMenuDelete').onclick = function() {
                if(document.getElementById('stepsList').children.length <= 1) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ­¥éª¤');
                    return;
                }
                currentStepRow.remove();
                updateStepNumbers();
                closeStepMenuModal();
            };
            
            document.getElementById('stepMenuAdd').onclick = function() {
                addStep();
                const container = document.getElementById('stepsList');
                const newRow = container.lastElementChild;
                container.insertBefore(newRow, currentStepRow.nextSibling);
                updateStepNumbers();
                updateStepSortable();
                closeStepMenuModal();
            };
        }
        
        function closeStepMenuModal() {
            document.getElementById('stepMenuModal').classList.add('hidden');
            currentStepRow = null;
        }
        
        // åª’ä½“ä¸Šä¼ åŠŸèƒ½
        function openMediaUpload(slot) {
            currentMediaSlot = slot;
            document.getElementById('mediaUploadModal').classList.remove('hidden');
        }
        
        function closeMediaUploadModal() {
            document.getElementById('mediaUploadModal').classList.add('hidden');
            currentMediaSlot = null;
        }
        
        function selectImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = false;
            input.onchange = function(e) {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        showMediaPreview(e.target.result, 'image', file.name);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
            closeMediaUploadModal();
        }
        
        function selectVideo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'video/*';
            input.multiple = false;
            input.onchange = function(e) {
                const file = e.target.files[0];
                if(file) {
                    // è§†é¢‘è‡ªåŠ¨å¤„ç†æ¨¡æ‹Ÿ
                    setTimeout(() => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            showMediaPreview(e.target.result, 'video', file.name);
                            // æ¨¡æ‹Ÿè§†é¢‘è‡ªåŠ¨å¤„ç†å®Œæˆ
                            showNotification('âœ… è§†é¢‘å·²è‡ªåŠ¨å‹ç¼©ä¼˜åŒ–');
                        };
                        reader.readAsDataURL(file);
                    }, 1000);
                    showNotification('ğŸ”„ æ­£åœ¨è‡ªåŠ¨å¤„ç†è§†é¢‘...');
                }
            };
            input.click();
            closeMediaUploadModal();
        }
        
        function captureMedia() {
            // æ¨¡æ‹Ÿæ‹ç…§/å½•åƒåŠŸèƒ½
            showNotification('ğŸ“· æ¨¡æ‹Ÿè°ƒç”¨æ‘„åƒå¤´åŠŸèƒ½');
            closeMediaUploadModal();
        }
        
        function showMediaPreview(src, type, filename) {
            if(!currentMediaSlot) return;
            
            const isVideo = type === 'video';
            const preview = document.createElement('div');
            preview.className = 'media-preview w-full h-full relative rounded-lg overflow-hidden';
            
            if(isVideo) {
                preview.innerHTML = `
                    <video class="w-full h-full object-cover" controls>
                        <source src="${src}" type="video/mp4">
                    </video>
                    <div class="video-indicator text-white text-xs bg-black bg-opacity-50 px-2 py-1 rounded">
                        <i class="fas fa-play mr-1"></i>è§†é¢‘
                    </div>
                    <button class="remove-btn w-6 h-6 rounded-full text-white text-xs hover:bg-red-600 transition flex items-center justify-center" onclick="removeMedia(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            } else {
                preview.innerHTML = `
                    <img src="${src}" class="w-full h-full object-cover" alt="${filename}" onclick="showFullImage(this)">
                    <div class="absolute bottom-3 right-3 bg-black bg-opacity-60 text-white rounded-full p-2 hover:bg-opacity-80 transition-all" onclick="showFullImage(this.parentElement)">
                        <i class="fas fa-search-plus"></i>
                    </div>
                    <button class="remove-btn w-6 h-6 rounded-full text-white text-xs hover:bg-red-600 transition flex items-center justify-center" onclick="removeMedia(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            }
            
            currentMediaSlot.innerHTML = '';
            currentMediaSlot.appendChild(preview);
        }
        
        function showNotification(message) {
            // ç®€å•çš„é€šçŸ¥æ˜¾ç¤º
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-80 text-white px-4 py-2 rounded-xl z-50 text-sm';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // æ­¥éª¤å¤‡æ³¨å­—ç¬¦è®¡æ•°
        document.addEventListener('DOMContentLoaded', function() {
            const stepRemark = document.getElementById('stepRemark');
            const stepRemarkCount = document.getElementById('stepRemarkCount');
            
            if(stepRemark && stepRemarkCount) {
                stepRemark.addEventListener('input', function() {
                    const count = this.value.length;
                    stepRemarkCount.textContent = `${count}/120`;
                    if(count >= 110) {
                        stepRemarkCount.classList.add('text-red-500');
                    } else {
                        stepRemarkCount.classList.remove('text-red-500');
                    }
                });
            }
        });
        
        // å›¾ç‰‡å…¨å±é¢„è§ˆåŠŸèƒ½
        function showFullImage(container) {
            const img = container.querySelector('img');
            const modal = document.getElementById('fullImageModal');
            const modalImg = modal.querySelector('img');
            
            if (img) {
                // è·å–åŸå§‹å›¾ç‰‡URLï¼Œæ˜¾ç¤ºé«˜æ¸…å¤§å›¾
                modalImg.src = img.src;
                modal.classList.remove('hidden');
            }
        }
        
        // åˆ†äº«åŠŸèƒ½ç›¸å…³
        function openShareModal() {
            document.getElementById('shareModal').classList.remove('hidden');
            
            // æ ¹æ®ç”¨æˆ·IPåˆ¤æ–­æ˜¾ç¤ºå›½å†…è¿˜æ˜¯å›½å¤–å¹³å°
            // è¿™é‡Œæ¨¡æ‹Ÿä½¿ç”¨GeolocationAPIæˆ–IPæŸ¥è¯¢æœåŠ¡
            checkUserRegion();
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
        }
        
        function checkUserRegion() {
            // æ¨¡æ‹Ÿæ£€æµ‹ç”¨æˆ·æ‰€åœ¨åœ°åŒº
            // å®é™…ç”Ÿäº§ç¯å¢ƒåº”è¯¥ä½¿ç”¨IPåœ°å€æŸ¥è¯¢æœåŠ¡æˆ–HTML5 Geolocation API
            
            // è·å–æµè§ˆå™¨è¯­è¨€ä½œä¸ºç®€å•åˆ¤æ–­ä¾æ®
            const userLanguage = navigator.language || navigator.userLanguage;
            const mainlandPlatforms = document.querySelector('.mainland-platforms');
            const foreignPlatforms = document.querySelector('.foreign-platforms');
            
            // å¦‚æœæ˜¯ä¸­æ–‡ï¼Œæ˜¾ç¤ºå›½å†…å¹³å°
            if (userLanguage.startsWith('zh')) {
                mainlandPlatforms.classList.remove('hidden');
                foreignPlatforms.classList.add('hidden');
            } else {
                // éä¸­æ–‡ï¼Œæ˜¾ç¤ºå›½å¤–å¹³å°
                mainlandPlatforms.classList.add('hidden');
                foreignPlatforms.classList.remove('hidden');
            }
            
            // ä¹Ÿå¯ä»¥æ·»åŠ ä¸€ä¸ªåˆ‡æ¢æŒ‰é’®ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢
        }
        
        function shareToSpecificPlatform(platform) {
            // å…³é—­åˆ†äº«å¹³å°é€‰æ‹©å¼¹çª—
            closeShareModal();
            
            // è·å–å½“å‰é…æ–¹ä¿¡æ¯
            const recipeName = document.querySelector('input[placeholder="é…æ–¹åç§° *"]').value || 'æœªå‘½åé…æ–¹';
            const imagePreview = document.getElementById('imagePreview');
            const imageUrl = imagePreview.querySelector('img')?.src || '';
            
            // æ ¹æ®ä¸åŒå¹³å°å¤„ç†åˆ†äº«é€»è¾‘
            switch(platform) {
                case 'xiaohongshu':
                    openXiaohongshuModal(recipeName, imageUrl);
                    break;
                case 'wechat':
                    showNotification('å·²å‡†å¤‡åˆ†äº«è‡³å¾®ä¿¡æœ‹å‹åœˆ');
                    // å®é™…åº”ç”¨ä¸­è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡åˆ†äº«SDK
                    break;
                case 'douyin':
                    showNotification('å·²å‡†å¤‡åˆ†äº«è‡³æŠ–éŸ³');
                    // å®é™…åº”ç”¨ä¸­è¿™é‡Œåº”è¯¥è°ƒç”¨æŠ–éŸ³åˆ†äº«SDK
                    break;
                case 'hongjang':
                    showNotification('å·²åˆ†äº«è‡³çƒ˜åŒ å¹³å°');
                    break;
                case 'instagram':
                case 'facebook':
                case 'line':
                case 'twitter':
                case 'telegram':
                case 'kakaotalk':
                    showNotification(`å·²å‡†å¤‡åˆ†äº«è‡³${platform}`);
                    // å®é™…åº”ç”¨ä¸­è¿™é‡Œåº”è¯¥è°ƒç”¨ç›¸åº”çš„åˆ†äº«SDK
                    break;
                default:
                    showNotification('åˆ†äº«åŠŸèƒ½æš‚æœªå®ç°');
            }
        }
        
        // å°çº¢ä¹¦åˆ†äº«å¼¹çª—åŠŸèƒ½
        function openXiaohongshuModal(recipeName, imageUrl) {
            const modal = document.getElementById('xiaohongshuShareModal');
            
            // å¦‚æœæ²¡æœ‰ä¼ å‚ï¼Œåˆ™è‡ªåŠ¨è·å–å½“å‰é…æ–¹ä¿¡æ¯
            if (!recipeName) {
                recipeName = document.querySelector('input[placeholder="é…æ–¹åç§° *"]').value || 'ç»å…¸åå¸é¢åŒ…é…æ–¹';
            }
            
            if (!imageUrl) {
                const imagePreview = document.getElementById('imagePreview');
                imageUrl = imagePreview.querySelector('img')?.src || '';
            }
            
            const sharePreviewImage = document.getElementById('sharePreviewImage');
            const shareRecipeTitle = document.getElementById('shareRecipeTitle');
            
            // è®¾ç½®åˆ†äº«é¢„è§ˆä¿¡æ¯
            if (sharePreviewImage) {
                if (imageUrl) {
                    sharePreviewImage.src = imageUrl;
                } else {
                    // ä½¿ç”¨é»˜è®¤å›¾ç‰‡
                    sharePreviewImage.src = "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=600&h=400&fit=crop";
                }
            }
            
            if (shareRecipeTitle) {
                shareRecipeTitle.textContent = recipeName;
            }
            
            // è®¾ç½®ç”¨æˆ·ID (å®é™…åº”ç”¨ä¸­ä»ç”¨æˆ·ç³»ç»Ÿè·å–)
            const userId = 'HJ' + Math.floor(100000 + Math.random() * 900000); // ç”ŸæˆéšæœºIDä½œç¤ºä¾‹
            document.getElementById('shareUserId').textContent = userId;
            
            // ç¡®ä¿æ¨¡æ€çª—å£æ˜¾ç¤º
            modal.classList.remove('hidden');
            // å…³é—­ä¹‹å‰çš„åˆ†äº«çª—å£
            closeShareModal();
        }
        
        function closeXiaohongshuModal() {
            document.getElementById('xiaohongshuShareModal').classList.add('hidden');
        }
        
        function confirmXiaohongshuShare() {
            // è¿™é‡Œåº”è°ƒç”¨å°çº¢ä¹¦åˆ†äº«SDKæˆ–API
            // ç›®å‰ä»…åšæ¨¡æ‹Ÿ
            showNotification('âœ… å·²æˆåŠŸåˆ†äº«è‡³å°çº¢ä¹¦');
            closeXiaohongshuModal();
        }

        // é¡µé¢åŠ è½½æ—¶æ¯ä¸ªåˆ†ç»„è‡ªåŠ¨æ·»åŠ ä¸€æ¡è¾“å…¥è¡Œ
        window.addEventListener('DOMContentLoaded', function() {
            ['flour','starter','dry','wet','aux','base2'].forEach(type => {
                addIngredient(type);
            });
            
            // ç»‘å®šæ·»åŠ å˜åŒ–æ¬¾æŒ‰é’®äº‹ä»¶
            const addVariationGroupBtn = document.getElementById('addVariationGroupBtn');
            if(addVariationGroupBtn && !addVariationGroupBtn.hasAttribute('data-bound')) {
                addVariationGroupBtn.addEventListener('click', function() {
                    addVariationGroup();
                });
                addVariationGroupBtn.setAttribute('data-bound', 'true');
            }
            
            // åˆå§‹åŒ–åŸºç¡€é¢å›¢ç»Ÿè®¡
            // setTimeout(() => {
            //     updateBaseSingleStats(); // åŸºç¡€é¢å›¢æ¨¡å—å·²åˆ é™¤
            // }, 100);
        });

        function removeMedia(button) {
            const mediaSlot = button.closest('.media-slot');
            if (mediaSlot) {
                mediaSlot.innerHTML = `
                    <div class="media-upload-area w-full h-20 rounded-lg flex items-center justify-center cursor-pointer transition-all border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-purple-500 hover:bg-gray-50 dark:hover:bg-slate-800" onclick="openMediaUpload(this)">
                        <div class="text-center text-slate-400 dark:text-slate-500">
                            <i class="fas fa-plus text-lg mb-1"></i>
                            <div class="text-xs">å›¾ç‰‡/è§†é¢‘</div>
                        </div>
                    </div>
                `;
            }
        }
        
        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const themeOptions = document.querySelectorAll('.theme-option');
            const html = document.documentElement;
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¸»é¢˜
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            // ä¸»é¢˜åˆ‡æ¢äº‹ä»¶ç›‘å¬
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.dataset.theme;
                    setTheme(theme);
                });
            });
            
            // è®¾ç½®ä¸»é¢˜å‡½æ•°
            function setTheme(theme) {
                // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
                html.classList.remove('theme-light', 'theme-dark', 'theme-jp', 'theme-kr');
                // æ·»åŠ æ–°ä¸»é¢˜ç±»
                html.classList.add(`theme-${theme}`);
                // æ›´æ–°æ´»åŠ¨çŠ¶æ€
                themeOptions.forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.theme === theme);
                });
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('theme', theme);
            }
        });



        

        



        // æš—è‰²æ¨¡å¼åˆ‡æ¢
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            if(html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme','light');
            } else {
                html.classList.add('dark');
                icon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme','dark');
            }
            
            // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å…ƒç´ çš„æš—è‰²æ¨¡å¼æ ·å¼
            refreshDarkModeStyles();
        }
        
        // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å…ƒç´ çš„æš—è‰²æ¨¡å¼æ ·å¼
        function refreshDarkModeStyles() {
            // è·å–æ‰€æœ‰å¯èƒ½éœ€è¦æ›´æ–°çš„å…ƒç´ 
            const elementsToRefresh = [
                '.card', '.step-images', '.bg-white', '.bg-slate-50', '.bg-slate-100',
                '.text-slate-800', '.text-slate-600', '.text-slate-500', '.text-slate-400',
                '.border-slate-100', '.border-slate-200', '.border-slate-300',
                '.hover\\:bg-slate-50', '.hover\\:bg-slate-100',
                '.media-upload-area', '.step-row'
            ].join(',');
            
            const allElements = document.querySelectorAll(elementsToRefresh);
            
            // å…ˆç§»é™¤å†æ·»åŠ æ‰€æœ‰å…ƒç´ çš„classï¼Œå¼ºåˆ¶æµè§ˆå™¨é‡æ–°åº”ç”¨æ ·å¼
            allElements.forEach(el => {
                el.classList.remove('dark-force-refresh');
                setTimeout(() => {
                    el.classList.add('dark-force-refresh');
                    setTimeout(() => {
                        el.classList.remove('dark-force-refresh');
                    }, 10);
                }, 5);
            });
            
            // æ‹–åŠ¨å›¾æ ‡æ ·å¼å·²ç»Ÿä¸€ï¼Œæ— éœ€ç‰¹åˆ«å¤„ç†
            
            // é‡æ–°åº”ç”¨æ‰€æœ‰å¡ç‰‡çš„æš—è‰²æ¨¡å¼
            document.querySelectorAll('.card').forEach(el => {
                if(html.classList.contains('dark')) {
                    el.style.background = '#1E293B';
                    el.style.borderColor = '#334155';
                } else {
                    el.style.background = '#FFFFFF';
                    el.style.borderColor = '#E2E8F0';
                }
            });
        }

        // è‡ªåŠ¨è¯»å–ä¸»é¢˜
        (function(){
            if(localStorage.getItem('theme')==='dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
                // ç¡®ä¿åœ¨åŠ è½½æ—¶å°±åº”ç”¨æ‰€æœ‰æš—è‰²æ¨¡å¼æ ·å¼
                setTimeout(refreshDarkModeStyles, 100);
            }
        })();

        // åˆå§‹åŒ–å·¦æ»‘åˆ é™¤åŠŸèƒ½
        function initSwipeDelete(element) {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            let dragThreshold = 15; // å¢åŠ æ‹–æ‹½é˜ˆå€¼ï¼Œé¿å…è¯¯è§¦å‘
            
            // æ·»åŠ é¼ æ ‡äº‹ä»¶æ”¯æŒï¼ˆä¸ºäº†åœ¨æ¡Œé¢ç«¯æµ‹è¯•ï¼‰
            function handleMouseDown(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯è¾“å…¥æ¡†æˆ–æŒ‰é’®ï¼Œä¸è§¦å‘å·¦æ»‘åˆ é™¤
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                startX = e.clientX;
                isDragging = false; // åˆå§‹ä¸è®¾ä¸ºæ‹–æ‹½çŠ¶æ€
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                e.preventDefault();
            }
            
            function handleMouseMove(e) {
                currentX = e.clientX;
                const diffX = currentX - startX;
                
                // åªæœ‰å½“ç§»åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼æ—¶æ‰å¼€å§‹æ‹–æ‹½
                if (!isDragging && Math.abs(diffX) > dragThreshold) {
                    isDragging = true;
                    element.classList.add('swiping');
                }
                
                if (!isDragging) return;
                
                // åªå…è®¸å‘å·¦æ»‘åŠ¨
                if (diffX <= 0) {
                    // é™åˆ¶æœ€å¤§æ»‘åŠ¨è·ç¦»ä¸º80px
                    const translateX = Math.max(-80, diffX);
                    element.style.transform = `translateX(${translateX}px)`;
                    // å¦‚æœæ»‘åŠ¨è¶…è¿‡20pxï¼Œå°±æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    if (translateX < -20) {
                        element.querySelector('.delete-action').style.right = '0';
                    } else {
                        element.querySelector('.delete-action').style.right = '-80px';
                    }
                } else {
                    // å¦‚æœå·²ç»æ‰“å¼€äº†åˆ é™¤æŒ‰é’®ï¼Œåˆ™å…è®¸å‘å³æ»‘åŠ¨å…³é—­
                    if (element.getAttribute('data-open') === 'true') {
                        const translateX = Math.min(0, diffX - 80);
                        element.style.transform = `translateX(${translateX}px)`;
                        if (translateX > -40) {
                            element.querySelector('.delete-action').style.right = '-80px';
                        }
                    } else {
                        element.style.transform = 'translateX(0)';
                    }
                }
                
                e.preventDefault();
            }
            
            function handleMouseUp(e) {
                if (!isDragging) return;
                isDragging = false;
                element.classList.remove('swiping');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                
                // åˆ¤æ–­æ»‘åŠ¨è·ç¦»æ˜¯å¦è¶³å¤Ÿæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                const diffX = currentX - startX;
                
                if (diffX < -40) {
                    // æ‰“å¼€åˆ é™¤æŒ‰é’®
                    element.style.transform = 'translateX(-80px)';
                    element.setAttribute('data-open', 'true');
                    element.querySelector('.delete-action').style.right = '0';
                } else {
                    // å…³é—­åˆ é™¤æŒ‰é’®
                    element.style.transform = 'translateX(0)';
                    element.setAttribute('data-open', 'false');
                    element.querySelector('.delete-action').style.right = '-80px';
                }
            }
            
            function handleTouchStart(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯è¾“å…¥æ¡†æˆ–æŒ‰é’®ï¼Œä¸è§¦å‘å·¦æ»‘åˆ é™¤
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                startX = e.touches[0].clientX;
                isDragging = false; // åˆå§‹ä¸è®¾ä¸ºæ‹–æ‹½çŠ¶æ€
                
                // é˜»æ­¢å…¶ä»–è§¦æ‘¸äº‹ä»¶
                e.stopPropagation();
            }
            
            function handleTouchMove(e) {
                currentX = e.touches[0].clientX;
                const diffX = currentX - startX;
                
                // åªæœ‰å½“ç§»åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼æ—¶æ‰å¼€å§‹æ‹–æ‹½
                if (!isDragging && Math.abs(diffX) > dragThreshold) {
                    isDragging = true;
                    element.classList.add('swiping');
                }
                
                if (!isDragging) return;
                
                // åªå…è®¸å‘å·¦æ»‘åŠ¨
                if (diffX <= 0) {
                    // é™åˆ¶æœ€å¤§æ»‘åŠ¨è·ç¦»ä¸º80px
                    const translateX = Math.max(-80, diffX);
                    element.style.transform = `translateX(${translateX}px)`;
                    // å¦‚æœæ»‘åŠ¨è¶…è¿‡20pxï¼Œå°±æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    if (translateX < -20) {
                        element.querySelector('.delete-action').style.right = '0';
                    } else {
                        element.querySelector('.delete-action').style.right = '-80px';
                    }
                } else {
                    // å¦‚æœå·²ç»æ‰“å¼€äº†åˆ é™¤æŒ‰é’®ï¼Œåˆ™å…è®¸å‘å³æ»‘åŠ¨å…³é—­
                    if (element.getAttribute('data-open') === 'true') {
                        const translateX = Math.min(0, diffX - 80);
                        element.style.transform = `translateX(${translateX}px)`;
                        if (translateX > -40) {
                            element.querySelector('.delete-action').style.right = '-80px';
                        }
                    } else {
                        element.style.transform = 'translateX(0)';
                    }
                }
                
                // é˜»æ­¢æ»šåŠ¨
                e.preventDefault();
            }
            
            function handleTouchEnd() {
                if (!isDragging) return;
                isDragging = false;
                element.classList.remove('swiping');
                
                // åˆ¤æ–­æ»‘åŠ¨è·ç¦»æ˜¯å¦è¶³å¤Ÿæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                const diffX = currentX - startX;
                
                if (diffX < -40) {
                    // æ‰“å¼€åˆ é™¤æŒ‰é’®
                    element.style.transform = 'translateX(-80px)';
                    element.setAttribute('data-open', 'true');
                    element.querySelector('.delete-action').style.right = '0';
                } else {
                    // å…³é—­åˆ é™¤æŒ‰é’®
                    element.style.transform = 'translateX(0)';
                    element.setAttribute('data-open', 'false');
                    element.querySelector('.delete-action').style.right = '-80px';
                }
            }
            
            function handleDeleteClick() {
                element.remove();
                updateTotalWeight();
                updateVariationTotal();
                // updateBaseSingleStats(); // åŸºç¡€é¢å›¢æ¨¡å—å·²åˆ é™¤
            }
            
            element.addEventListener('touchstart', handleTouchStart, { passive: false });
            element.addEventListener('touchmove', handleTouchMove, { passive: false });
            element.addEventListener('touchend', handleTouchEnd);
            
            // æ·»åŠ é¼ æ ‡äº‹ä»¶æ”¯æŒï¼ˆä¸ºäº†åœ¨æ¡Œé¢ç«¯æµ‹è¯•ï¼‰
            element.addEventListener('mousedown', handleMouseDown);
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const deleteBtn = element.querySelector('.delete-action');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', handleDeleteClick);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ‰€æœ‰çš„å·¦æ»‘åˆ é™¤åŠŸèƒ½
        window.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–é»˜è®¤æ·»åŠ çš„ææ–™ï¼ˆåªä¿ç•™ç°æœ‰çš„æ¨¡å—ï¼‰
            ['base2','step1'].forEach(type => {
                // æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨å†æ·»åŠ 
                const container = document.getElementById(`${type}Ingredients`);
                if (container) {
                    addIngredient(type);
                }
            });
            
            // æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬
            document.addEventListener('click', function(e) {
                // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶å…³é—­æ‰€æœ‰æ‰“å¼€çš„åˆ é™¤æŒ‰é’®
                const openItems = document.querySelectorAll('.ingredient-item[data-open="true"]');
                if (openItems.length > 0 && !e.target.closest('.delete-action')) {
                    openItems.forEach(item => {
                        item.style.transform = 'translateX(0)';
                        item.setAttribute('data-open', 'false');
                    });
                }
            });
        });

        // æ–°æ‰‹å¼•å¯¼åŠŸèƒ½
        function endTutorial() {
            const overlay = document.getElementById('tutorialOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function previousTutorialStep() {
            // å®ç°ä¸Šä¸€æ­¥é€»è¾‘
            console.log('ä¸Šä¸€æ­¥');
        }

        function nextTutorialStep() {
            // å®ç°ä¸‹ä¸€æ­¥é€»è¾‘
            console.log('ä¸‹ä¸€æ­¥');
        }
    </script>
    <!-- æ–°æ‰‹å¼•å¯¼é®ç½©å±‚ -->
    <div id="tutorialOverlay" class="tutorial-overlay">
        <!-- é«˜äº®åŒºåŸŸ -->
        <div id="tutorialHighlight" class="tutorial-highlight"></div>
        
        <!-- å¼•å¯¼å¼¹çª— -->
        <div id="tutorialPopup" class="tutorial-popup">
            <!-- è·³è¿‡æŒ‰é’® -->
            <button class="tutorial-skip" onclick="endTutorial()">
                <i class="fas fa-times"></i>
            </button>
            
            <!-- å¼•å¯¼å†…å®¹ -->
            <div class="mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-lightbulb text-white text-sm"></i>
                    </div>
                    <h3 id="tutorialTitle" class="font-bold text-lg text-gray-800 dark:text-slate-100">æ¬¢è¿ä½¿ç”¨æ–°å»ºé…æ–¹</h3>
                </div>
                <p id="tutorialContent" class="text-gray-600 dark:text-slate-300 text-sm leading-relaxed">
                    è®©æˆ‘ä»¬ä¸€èµ·äº†è§£å¦‚ä½•åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„é¢åŒ…é…æ–¹å§ï¼
                </p>
            </div>
            
            <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
            <div class="tutorial-step-indicator" id="tutorialStepIndicator">
                <!-- åŠ¨æ€ç”Ÿæˆæ­¥éª¤ç‚¹ -->
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="tutorial-buttons">
                <button id="tutorialPrevBtn" class="tutorial-btn tutorial-btn-secondary" onclick="previousTutorialStep()" style="display: none;">
                    <i class="fas fa-chevron-left mr-1"></i>
                    ä¸Šä¸€æ­¥
                </button>
                <button id="tutorialNextBtn" class="tutorial-btn tutorial-btn-primary" onclick="nextTutorialStep()">
                    ä¸‹ä¸€æ­¥
                    <i class="fas fa-chevron-right ml-1"></i>
                </button>
                <button id="tutorialFinishBtn" class="tutorial-btn tutorial-btn-primary" onclick="endTutorial()" style="display: none;">
                    <i class="fas fa-check mr-1"></i>
                    å®Œæˆå¼•å¯¼
                </button>
            </div>
            
            <!-- ç®­å¤´æŒ‡ç¤ºå™¨ -->
            <div id="tutorialArrow" class="tutorial-arrow"></div>
        </div>
    </div>

</body>
</html>