<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å»ºé…æ–¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet">
    <style>
        /* å¼ºåˆ¶åˆ·æ–°æš—é»‘æ¨¡å¼çš„è¾…åŠ©ç±» */
        .dark-force-refresh {}
        .dark-handle {}
        
        /* æ¸å˜è‰²å½©å®šä¹‰ - ä¸é¦–é¡µä¿æŒä¸€è‡´ */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-recipe {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .gradient-message {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .gradient-inventory {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .gradient-order {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        /* ä¸»é¢˜åŸºç¡€å˜é‡ */
        :root {
            /* Light Theme */
            --light-bg: #f9fafb;
            --light-card-bg: #FFFFFF;
            --light-text: #1E293B;
            --light-border: #e5e7eb;
            --light-hover: #f3f4f6;
            
            /* Dark Theme */
            --dark-bg: #0F172A;
            --dark-card-bg: #1E293B;
            --dark-text: #F1F5F9;
            --dark-border: #334155;
            --dark-hover: #1E3A8A;
            
            /* Japanese Theme */
            --jp-bg: #F7F6F2;
            --jp-card-bg: #FFFCF7;
            --jp-text: #2C2C2C;
            --jp-border: #E5E2D9;
            --jp-accent: #D64F45;
            --jp-hover: #FFF1EC;
            
            /* Korean Theme */
            --kr-bg: #F3F7F6;
            --kr-card-bg: #FFFFFF;
            --kr-text: #363B3A;
            --kr-border: #DDE7E5;
            --kr-accent: #98C6BE;
            --kr-hover: #E8F3F1;
        }

        /* ä¸»é¢˜åˆ‡æ¢å™¨æ ·å¼ */
        .theme-switcher {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            border-radius: 1rem;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            border: 1px solid var(--light-border);
        }

        .theme-option {
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-option:hover {
            transform: scale(1.1);
        }

        .theme-option.active {
            box-shadow: 0 0 0 2px var(--light-border);
        }

        /* Light Theme */
        .theme-light {
            background: var(--light-bg);
            color: var(--light-text);
        }

        .theme-light .card {
            background: var(--light-card-bg);
            border-color: var(--light-border);
        }

        /* Dark Theme */
        .theme-dark {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        .theme-dark .card {
            background: var(--dark-card-bg);
            border-color: var(--dark-border);
        }

        /* Japanese Theme */
        .theme-jp {
            background: var(--jp-bg);
            color: var(--jp-text);
        }

        .theme-jp .card {
            background: var(--jp-card-bg);
            border-color: var(--jp-border);
        }

        .theme-jp .btn-primary {
            background: var(--jp-accent);
        }

        /* Korean Theme */
        .theme-kr {
            background: var(--kr-bg);
            color: var(--kr-text);
        }

        .theme-kr .card {
            background: var(--kr-card-bg);
            border-color: var(--kr-border);
        }

        .theme-kr .btn-primary {
            background: var(--kr-accent);
        }

        /* åŸºç¡€ä¸»é¢˜æ ·å¼ */
        html, body { 
            background: #f9fafb; 
            transition: all 0.3s ease;
        }
        .dark html, .dark body { 
            background: #0F172A; 
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { 
            border-radius: 12px; 
            box-shadow: 0 4px 12px 0 rgba(0,0,0,0.1); 
            background: #FFFFFF; 
            border: 1px solid #e5e7eb; 
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .dark .card { 
            background: #1E293B; 
            box-shadow: 0 4px 20px 0 rgba(0,0,0,0.25); 
            border: 1px solid #334155; 
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        #themeToggleBtn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: white;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .dark #themeToggleBtn {
            background: #334155;
            border-color: #475569;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        #themeToggleBtn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .dark #themeToggleBtn:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* æ–‡æœ¬é¢œè‰² */
        .text-primary {
            color: #1E293B;
            transition: color 0.3s ease;
        }
        .dark .text-primary {
            color: #F1F5F9;
        }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        input, textarea {
            transition: all 0.3s ease;
        }
        .dark input, .dark textarea {
            background: #1E293B;
            color: #F1F5F9;
            border-color: #475569;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn-primary {
            transition: all 0.3s ease;
        }
        .dark .btn-primary {
            background: linear-gradient(135deg, #8B5CF6, #A855F7);
            color: #F1F5F9;
        }

        /* æ­¥éª¤å¡ç‰‡æ ·å¼ */
        .step-card {
            transition: all 0.3s ease;
        }
        .dark .step-card {
            background: #1E293B;
            border-color: #334155;
        }

        .input-shadow:focus { box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); border-color: #667eea; }
        .tab-active { color: #667eea !important; }
        .tab-inactive { color: #6b7280 !important; }
        .tab-bg-active { background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)) !important; border: 1px solid #667eea; }
        .tab-bg-inactive { background: #FFFFFF !important; border: 1px solid #e5e7eb; }
        .dark .tab-bg-active { background: #1E3A8A !important; border: 1px solid #667eea; }
        .dark .tab-bg-inactive { background: #1E293B !important; border: 1px solid #334155; }
        
        /* Tabå›¾æ ‡å®¹å™¨æ ·å¼ */
        .tab-icon-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tab-active .tab-icon-container {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            border-color: #667eea !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3) !important;
            transform: translateY(-1px) scale(1.05);
        }
        .tab-inactive .tab-icon-container {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0) !important;
            border-color: #cbd5e1 !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transform: translateY(0) scale(1);
        }
        .dark .tab-active .tab-icon-container {
            background: linear-gradient(135deg, #667eea, #8b5cf6) !important;
            border-color: #667eea !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4) !important;
        }
        .dark .tab-inactive .tab-icon-container {
            background: linear-gradient(135deg, #334155, #475569) !important;
            border-color: #64748b !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
        }
        .tab-active .tab-icon-container i {
            color: #ffffff !important;
        }
        .tab-inactive .tab-icon-container i {
            color: #64748b !important;
        }
        .dark .tab-inactive .tab-icon-container i {
            color: #94a3b8 !important;
        }
        .transition-all { transition: all 0.2s cubic-bezier(.4,0,.2,1); }
        .bottom-bar { border-radius: 24px 24px 0 0; }
        .group-blue { background: #E8F0FE; }
        .group-yellow { background: #FFF7E0; }
        .group-pink { background: #FDE7EF; }
        .group-green { background: #E6F6EC; }
        .group-gray { background: #F3F4F6; }
        .dark .group-blue { background: #22304a; }
        .dark .group-yellow { background: #4a3e22; }
        .dark .group-pink { background: #4a2230; }
        .dark .group-green { background: #224a30; }
        .dark .group-gray { background: #23272f; }
        .sop-step-row { transition: all 0.2s ease; }
        .sop-step-row:hover { background: #2a2f3a !important; }
        .dark .sop-step-row:hover { background: #2a2f3a !important; }
        .sop-menu-dropdown { min-width: 100px; }
        .sop-drag-handle:active { cursor: grabbing !important; }
        .sop-type-modal { backdrop-filter: blur(8px); }
        .sop-type-grid { max-height: 60vh; }
        .sop-type-item { transition: all 0.15s ease; }
        .sop-type-item:hover { background: rgba(139, 92, 246, 0.1) !important; transform: translateY(-1px); }
        .sop-step-input { background: rgba(255,255,255,0.05) !important; }
        .sop-step-input:focus { background: rgba(255,255,255,0.1) !important; }
        .step-row { transition: all 0.3s ease; background: #FFFFFF !important; border: 1px solid #E2E8F0 !important; }
        .step-row:hover { background: #F8FAFC !important; border-color: #CBD5E1 !important; transform: translateY(-1px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .dark .step-row { background: #1E293B !important; border: 1px solid #334155 !important; }
        .dark .step-row:hover { background: #0F172A !important; border-color: #475569 !important; }
        .media-upload-area { transition: all 0.2s ease; background: #F1F5F9; border: 2px dashed #CBD5E1; }
        .media-upload-area:hover { border-color: #8B5CF6 !important; background: rgba(139, 92, 246, 0.05) !important; }
        .dark .media-upload-area { background: #0F172A; border-color: #475569; }
        .media-preview { position: relative; overflow: hidden; }
        .media-preview .remove-btn { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); }
        .step-number { background: linear-gradient(135deg, #667eea, #764ba2); }
        .video-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .crop-container { max-width: 100%; max-height: 400px; }
        .crop-preview { width: 120px; height: 120px; border-radius: 12px; overflow: hidden; border: 2px solid #E2E8F0; }
        .dark .crop-preview { border-color: #334155; }
        
        /* æ­¥éª¤å›¾ç‰‡æ¨ªå‘æ»šåŠ¨æ ·å¼ */
        .snap-x {
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .snap-x::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        .snap-center {
            scroll-snap-align: center;
        }
        
        /* æ‹–åŠ¨å›¾æ ‡æ ·å¼å·²ç»Ÿä¸€ä¸ºSOPæ ·å¼ */
        .sop-step-enhanced { 
            background: #FFFFFF !important; 
            border: 1px solid #E2E8F0 !important; 
            transition: all 0.3s ease;
        }
        .sop-step-enhanced:hover { 
            background: #F8FAFC !important; 
            border-color: #CBD5E1 !important; 
            transform: translateY(-1px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .dark .sop-step-enhanced { 
            background: #1E293B !important; 
            border: 1px solid #334155 !important; 
        }
        .dark .sop-step-enhanced:hover { 
            background: #0F172A !important; 
            border-color: #475569 !important; 
        }

        /* æ·»åŠ å·¦æ»‘åˆ é™¤ç›¸å…³æ ·å¼ */
        .ingredient-item {
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
            transform: translateX(0);
            transition: transform 0.3s ease;
            width: 100%;
        }

        .ingredient-item .delete-action {
            position: absolute;
            right: -80px; /* åˆå§‹æ—¶å®Œå…¨åœ¨è§†å›¾å¤– */
            top: 0;
            bottom: 0;
            width: 80px;
            background-color: #F44336;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            z-index: 10; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
            font-size: 16px;
            text-align: center;
        }

        .ingredient-item.swiping {
            transition: none;
        }

        /* åŒæ­¥çŠ¶æ€çš„æ ·å¼ */
        .name-input {
            transition: all 0.3s ease;
        }

        .name-input.synced {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.05);
        }

        .name-input.not-synced {
            border-color: #F44336;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            transition: all 0.3s ease;
        }

        .sync-indicator.synced {
            background-color: #4CAF50;
        }

        .sync-indicator.not-synced {
            background-color: #F44336;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-[#0F172A] text-gray-800 dark:text-slate-100">
    <div class="max-w-md mx-auto min-h-screen flex flex-col bg-gray-50 dark:bg-[#0F172A]">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="sticky top-0 z-50 bg-white dark:bg-[#1E293B] flex items-center justify-between px-4 py-3 card rounded-b-2xl border-b border-slate-200 dark:border-slate-600">
            <button class="text-gray-500 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-[#334155] active:scale-95 transition rounded-full p-2" onclick="checkExitConfirmation()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <span class="text-lg font-bold flex-1 text-center text-gray-800 dark:text-slate-100 tracking-wide">æ–°å»ºé…æ–¹</span>
            <div class="flex gap-2 items-center">
                <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-full p-2 transition" title="æ‹ç…§è¯†åˆ«" onclick="openCamera()"><i class="fas fa-camera-retro"></i></button>
                <!-- è¿˜åŸä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
                <button id="themeToggleBtn" class="ml-2 text-xl hover:bg-gray-100 dark:hover:bg-[#334155] active:scale-90 rounded-full p-2 transition" onclick="toggleTheme()">
                    <span id="themeIcon">ğŸŒ™</span>
                </button>
            </div>
        </div>
        <!-- å›¾ç‰‡ä¸Šä¼ åŒº -->
        <div class="relative mx-4 mt-4 mb-2">
            <input type="file" id="coverImage" class="hidden" accept="image/*">
            <label for="coverImage" class="block w-full h-40 card flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-purple-600 hover:border-purple-700 transition-all">
                <div id="imagePreview" class="w-full h-full flex flex-col items-center justify-center text-purple-600 dark:text-purple-400">
                    <i class="fas fa-camera text-3xl mb-2"></i>
                    <span>ç‚¹å‡»ä¸Šä¼ å°é¢å›¾ç‰‡</span>
                </div>
            </label>
        </div>
        <!-- Tabåˆ‡æ¢åŒº -->
        <div class="flex bg-white dark:bg-[#1E293B] rounded-xl mx-4 mt-2 mb-4 overflow-hidden card">
            <button id="tab-btn-recipe" class="flex-1 flex flex-col items-center py-3 text-center font-semibold tab-btn tab-active tab-bg-active gap-1 hover:bg-gray-100 dark:hover:bg-[#1E3A8A] active:scale-95 transition-all" onclick="switchTab('recipe')">
                <i class="fas fa-utensils text-lg mb-1"></i>
                <span class="mt-1">é…æ–¹</span>
            </button>
            <button id="tab-btn-step" class="flex-1 flex flex-col items-center py-3 text-center font-semibold tab-btn tab-inactive tab-bg-inactive gap-1 hover:bg-gray-100 dark:hover:bg-[#1E3A8A] active:scale-95 transition-all" onclick="switchTab('step')">
                <i class="fas fa-tasks text-lg mb-1"></i>
                <span class="mt-1">æ­¥éª¤</span>
            </button>
        </div>
        <!-- é…æ–¹åŸºç¡€ä¿¡æ¯åŒºï¼ˆä¼˜åŒ–è®¾è®¡ï¼‰ -->
        <div id="recipe-meta-section" class="mx-4 mb-4">
            <div class="card p-4 space-y-4">
                <!-- é…æ–¹åç§°è¾“å…¥ -->
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-gradient-to-br from-purple-500 to-purple-600 rounded-md flex items-center justify-center">
                            <i class="fas fa-signature text-white text-xs"></i>
                        </div>
                        <label class="text-sm font-medium text-gray-800 dark:text-slate-100">é…æ–¹åç§° <span class="text-red-500">*</span></label>
                    </div>
                    <div class="relative">
                        <input type="text" placeholder="è¯·è¾“å…¥é…æ–¹åç§°..." class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 dark:border-slate-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 outline-none bg-white dark:bg-[#1E293B] text-gray-800 dark:text-slate-100 placeholder-gray-400 dark:placeholder-slate-500 transition-all duration-200 hover:border-gray-300 dark:hover:border-slate-500">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">
                            <i class="fas fa-edit text-sm"></i>
                        </div>
                    </div>
                </div>
                
                <!-- åˆ†ç±»é€‰æ‹© -->
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-gradient-to-br from-blue-500 to-blue-600 rounded-md flex items-center justify-center">
                            <i class="fas fa-tags text-white text-xs"></i>
                        </div>
                        <label class="text-sm font-medium text-gray-800 dark:text-slate-100">é€‰æ‹©åˆ†ç±» <span class="text-red-500">*</span></label>
                    </div>
                    <div class="relative">
                        <select id="categorySelect" class="w-full pl-10 pr-12 py-3 rounded-xl border border-gray-200 dark:border-slate-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 outline-none bg-white dark:bg-[#1E293B] text-gray-800 dark:text-slate-100 appearance-none cursor-pointer transition-all duration-200 hover:border-gray-300 dark:hover:border-slate-500">
                            <option value="" class="text-gray-400">è¯·é€‰æ‹©é…æ–¹åˆ†ç±»...</option>
                            <option value="bread">ğŸ é¢åŒ…ç±»</option>
                            <option value="cake">ğŸ‚ è›‹ç³•ç±»</option>
                            <option value="drink">ğŸ¥¤ é¥®å“ç±»</option>
                            <option value="pastry">ğŸ¥ ç³•ç‚¹ç±»</option>
                            <option value="dessert">ğŸ® ç”œå“ç±»</option>
                            <option value="other">ğŸ“¦ å…¶ä»–ç±»</option>
                        </select>
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">
                            <i class="fas fa-layer-group text-sm"></i>
                        </div>

                        <button onclick="openCategoryModal()" class="absolute right-2 top-1/2 -translate-y-1/2 w-7 h-7 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl hover:shadow-lg active:scale-95 transition-all duration-200 flex items-center justify-center" title="æ–°å»ºåˆ†ç±»">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- åŸæ–™åˆ†ç»„åŒºï¼ˆç»Ÿä¸€è®¾è®¡é£æ ¼ï¼‰ -->
        <div class="space-y-4 flex-1 overflow-y-auto px-4 pb-32" id="recipe-section">
            <!-- é…æ–¹è¯´æ˜å¡ç‰‡ - ç§»é™¤æ–‡å­—å’Œè¯´æ˜ -->
            <div class="mt-4 mb-4">
                <div class="card p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-600 to-purple-700 rounded-full flex items-center justify-center">
                            <i class="fas fa-utensils text-white text-sm"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 dark:text-slate-100">é…æ–¹ç»„æˆ</h3>
                    </div>
                    <p class="text-sm text-slate-600 dark:text-slate-400">å¯é€‰åŸæ–™å¯å¥—ç”¨å­é…æ–¹ï¼Œæ”¯æŒå¤šå±‚çº§é…æ–¹</p>
                </div>
            </div>
            <div class="card p-4">
                <div class="flex justify-between items-center mb-3 bg-gray-50 dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gray-50 dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-tasks text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 contenteditable="true" class="font-semibold text-gray-800 dark:text-slate-100 outline-none border-b border-transparent focus:border-purple-600 px-1">æ­¥éª¤ä¸€</h3>
                    </div>
                </div>
                <div id="stepOneIngredients" class="ingredients-group space-y-2"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('stepOne')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ ææ–™</span>
                    </button>
                </div>
            </div>
            <div class="px-4 mt-4">
                <button class="w-full py-3 rounded-xl card text-purple-600 dark:text-purple-400 font-semibold hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-95 transition-all border border-slate-200 dark:border-slate-600" onclick="addStepInRecipe()">
                    <i class="fas fa-plus mr-2"></i> æ·»åŠ æ­¥éª¤
                </button>
            </div>
            <div class="card p-4">
                <div class="flex justify-between items-center mb-3 bg-[#F8FAFC] dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-[#F8FAFC] dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-cube text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 contenteditable="true" class="font-semibold text-[#1E293B] dark:text-slate-100 outline-none border-b border-transparent focus:border-purple-600 px-1">åŸºç¡€äº§å“ <span class="text-red-500 dark:text-red-400">*</span></h3>
                    </div>
                </div>
                <div id="baseIngredients" class="ingredients-group space-y-2"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('base')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ åŸºç¡€äº§å“</span>
                    </button>
                </div>
            </div>
            <div id="variationList"></div>
            <div class="px-4 mt-4">
                <button id="addVariationBtn" class="w-full py-3 rounded-xl card text-purple-600 dark:text-purple-400 font-semibold hover:bg-purple-50 dark:hover:bg-purple-900/20 active:scale-95 transition-all border border-slate-200 dark:border-slate-600">
                    <i class="fas fa-plus mr-2"></i> æ·»åŠ å…¶ä»–äº§å“
                </button>
            </div>
        </div>
        

        
        <!-- æ­¥éª¤ç¼–è¾‘åŒºï¼ˆç»Ÿä¸€è®¾è®¡é£æ ¼ï¼‰ -->
        <div class="flex-1 flex flex-col pb-32 hidden" id="step-section">
            <!-- æ­¥éª¤æ“ä½œè¯´æ˜å¡ç‰‡ -->
            <div class="mx-4 mt-4 mb-4">
                <div class="card p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-600 to-purple-700 rounded-full flex items-center justify-center">
                            <i class="fas fa-utensils text-white text-sm"></i>
                        </div>
                        <h3 class="font-semibold text-[#1E293B] dark:text-slate-100">åˆ¶ä½œæ­¥éª¤</h3>
                    </div>
                    <p class="text-sm text-slate-600 dark:text-slate-400">è¯¦ç»†è®°å½•æ¯ä¸ªåˆ¶ä½œç¯èŠ‚ï¼Œæ”¯æŒå›¾ç‰‡å’Œè§†é¢‘è¯´æ˜</p>
                </div>
            </div>
            
            <!-- æç¤ºä¿¡æ¯ -->
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-3 mx-4 mb-4 flex items-center">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                <p class="text-sm text-blue-700 dark:text-blue-300">ç‚¹å‡»å›¾ç‰‡æˆ–<i class="fas fa-search-plus mx-1"></i>å›¾æ ‡å¯æŸ¥çœ‹å¤§å›¾</p>
            </div>
            
            <!-- æ­¥éª¤åˆ—è¡¨ -->
            <div id="stepsList" class="px-4 space-y-8"></div>
            
            <!-- æ·»åŠ æ­¥éª¤æŒ‰é’® -->
            <div class="px-4 mt-4">
                <button class="w-full py-3 rounded-xl card text-purple-600 dark:text-purple-400 font-semibold hover:bg-purple-50 dark:hover:bg-purple-900/20 active:scale-95 transition-all border border-slate-200 dark:border-slate-600" onclick="addStep()">
                    <i class="fas fa-plus mr-2"></i> æ·»åŠ æ­¥éª¤
                </button>
            </div>
        </div>
        <!-- åº•éƒ¨å›ºå®šæ ï¼šæ€»é‡å¡ç‰‡+ä¿å­˜æŒ‰é’®å¹¶åˆ— -->
        <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-[#1E293B] py-3 px-4 z-50 card bottom-bar border-t border-slate-200 dark:border-slate-600">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <div class="flex items-center">
                    <div class="rounded-lg border border-slate-200 dark:border-slate-600 bg-[#F8FAFC] dark:bg-[#0F172A] px-3 py-2 flex flex-col items-center">
                        <div class="text-[#64748B] dark:text-slate-400 text-xs">æ€»é‡</div>
                        <div class="text-sm font-bold text-purple-600 dark:text-purple-400"><span id="totalWeight">0</span></div>
                    </div>
                </div>
                <button id="saveBtn" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 active:scale-95 text-white px-4 py-2 rounded-lg font-medium text-sm shadow-md transition-all">ä¿å­˜é…æ–¹</button>
            </div>
        </div>
        
        <!-- å›¾ç‰‡å…¨å±é¢„è§ˆ -->
        <div id="fullImageModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden" onclick="this.classList.add('hidden')">
            <img src="" alt="å›¾ç‰‡å¤§å›¾" class="max-w-[90vw] max-h-[90vh] object-contain rounded-xl">
            <button class="absolute top-4 right-4 bg-white bg-opacity-20 text-white rounded-full p-3 hover:bg-opacity-40 transition-all" onclick="event.stopPropagation(); this.parentElement.classList.add('hidden')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- å•ä½é€‰æ‹©å¼¹çª—ï¼ˆå¸¸é©»DOMï¼Œé»˜è®¤hiddenï¼‰ -->
        <div id="unit-popup" class="fixed z-50 left-0 top-0 w-full h-full bg-black bg-opacity-50 backdrop-blur-sm transition-all hidden">
            <div class="bg-white dark:bg-[#1E293B] rounded-2xl p-6 min-w-[300px] max-w-[90vw] shadow-2xl border border-slate-200 dark:border-slate-600 transform transition-all" style="position: absolute;">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-[#1E293B] dark:text-slate-100">é€‰æ‹©å•ä½</h3>
                    <button onclick="closeUnitSelector()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                        <i class="fas fa-times"></i>
                    </button>
            </div>
                
                <!-- Tabåˆ‡æ¢æŒ‰é’®ç»„ -->
                <div class="flex gap-2 mb-6 bg-slate-100 dark:bg-slate-800 p-1 rounded-xl" id="unit-tab-btns">
                    <!-- TabæŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
                
                <!-- å•ä½åˆ—è¡¨å®¹å™¨ -->
                <div id="unit-popup-list" class="grid grid-cols-3 gap-2 max-h-[40vh] overflow-y-auto pr-2 mb-4">
                    <!-- å•ä½é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ææ–™åç§°æ£€ç´¢å¼¹çª—ï¼ˆå¸¸é©»DOMï¼Œé»˜è®¤hiddenï¼‰ -->
        <div id="material-popup" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 backdrop-blur-sm hidden">
            <div class="bg-white dark:bg-[#1E293B] rounded-2xl p-4 max-w-4xl w-full mx-4 border border-slate-200 dark:border-slate-600 shadow-2xl max-h-[70vh] flex flex-col overflow-hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 gradient-primary rounded-lg flex items-center justify-center shadow-lg">
                            <i class="fas fa-search text-white text-sm"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-800 dark:text-slate-100">é€‰æ‹©ææ–™æˆ–é…æ–¹</h2>
                    </div>
                    <button onclick="closeMaterialSearch()" class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-slate-400 hover:bg-gray-200 dark:hover:bg-slate-600 hover:text-gray-700 dark:hover:text-slate-200 active:scale-95 transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
                
                <!-- æœç´¢å’Œè‡ªå®šä¹‰ææ–™è¾“å…¥åŒºåŸŸ -->
                <div class="mb-4 p-3 bg-gradient-to-r from-purple-50 to-amber-50 dark:from-purple-900/20 dark:to-amber-900/20 rounded-xl border border-purple-200/50 dark:border-purple-800/50 shadow-sm">
                    <div class="flex items-start gap-2 mb-2">
                        <div class="w-6 h-6 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-amber-600 dark:text-amber-400 text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs font-semibold text-amber-700 dark:text-amber-300 mb-1">
                                è‡ªå®šä¹‰ææ–™æç¤º
                            </div>
                            <div class="text-xs text-amber-600 dark:text-amber-400 leading-relaxed">
                                è‡ªå®šä¹‰ææ–™ä¸ä¼šåŒæ­¥ææ–™åº“çš„æˆæœ¬æ•°æ®ï¼Œé…æ–¹è®¡ç®—æ—¶æ­¤ææ–™æˆæœ¬ä¸º0
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1 relative">
                            <input type="text" id="custom-material-input" placeholder="æœç´¢ææ–™æˆ–è¾“å…¥è‡ªå®šä¹‰ææ–™åç§°..." 
                                   class="w-full pl-10 pr-3 py-2.5 rounded-lg border border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 outline-none bg-white dark:bg-[#0F172A] text-gray-800 dark:text-slate-100 placeholder-gray-400 dark:placeholder-slate-500 transition-all duration-200 shadow-sm text-sm"
                                   oninput="filterMaterialAndRecipes(this.value)">
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-slate-500">
                                <i class="fas fa-search text-xs"></i>
                            </div>
                        </div>
                        <button onclick="confirmCustomMaterial()" class="px-4 py-2.5 gradient-primary hover:from-[#764ba2] hover:to-[#667eea] text-white rounded-lg font-semibold transition-all active:scale-95 shadow-lg flex items-center gap-1 text-sm">
                            <i class="fas fa-check text-xs"></i>
                            <span>ç¡®è®¤</span>
                        </button>
                    </div>
                </div>
                
                <!-- åˆ†åŒºæ ‡ç­¾ -->
                <div class="flex mb-4 bg-gray-100 dark:bg-slate-700 rounded-lg p-1 shadow-inner">
                    <button id="materials-tab" class="flex-1 py-2 px-3 rounded-md text-sm font-semibold transition-all duration-200 bg-white dark:bg-slate-600 text-purple-600 dark:text-purple-400 shadow-md" onclick="switchMaterialTab('materials')">
                        <i class="fas fa-seedling mr-1 text-xs"></i>ææ–™
                    </button>
                    <button id="recipes-tab" class="flex-1 py-2 px-3 rounded-md text-sm font-semibold transition-all duration-200 text-gray-600 dark:text-slate-400 hover:text-gray-800 dark:hover:text-slate-200 hover:bg-white/50 dark:hover:bg-slate-600/50" onclick="switchMaterialTab('recipes')">
                        <i class="fas fa-book mr-1 text-xs"></i>é…æ–¹
                    </button>
                </div>
                
                <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
                <div class="flex-1 flex gap-4 min-h-0">
                    <!-- ææ–™åŒºåŸŸ -->
                    <div id="materials-section" class="flex gap-4 w-full">
                        <!-- å·¦ä¾§ç±»åˆ«åˆ—è¡¨ -->
                        <div class="w-[30%] flex-shrink-0">
                            <div class="bg-gradient-to-b from-gray-50 to-gray-100 dark:from-slate-800 dark:to-slate-900 rounded-xl p-3 h-full flex flex-col shadow-sm border border-gray-200/50 dark:border-slate-700/50">
                                <div class="text-sm font-semibold text-gray-700 dark:text-slate-300 mb-3 px-1 flex items-center gap-2">
                                    <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                    <span>ç±»åˆ«</span>
                                </div>
                                <div id="material-category-list" class="space-y-1 overflow-y-auto flex-1 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-slate-600">
                                    <!-- åŠ¨æ€ç”Ÿæˆçš„ç±»åˆ«åˆ—è¡¨ -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ææ–™åˆ—è¡¨ -->
                        <div class="w-[70%] min-w-0">
                            <div class="bg-gradient-to-b from-gray-50/50 to-white dark:from-slate-800/50 dark:to-slate-900 rounded-xl p-3 h-full border border-gray-200/50 dark:border-slate-700/50 shadow-sm">
                                <div id="material-popup-list" class="flex flex-col gap-2 pr-2 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-slate-600 max-h-full overflow-y-auto">
                                    <!-- åŠ¨æ€ç”Ÿæˆçš„ææ–™åˆ—è¡¨ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é…æ–¹åŒºåŸŸ -->
                    <div id="recipes-section" class="flex gap-4 w-full hidden">
                        <!-- å·¦ä¾§ç±»åˆ«åˆ—è¡¨ -->
                        <div class="w-[30%] flex-shrink-0">
                            <div class="bg-gradient-to-b from-gray-50 to-gray-100 dark:from-slate-800 dark:to-slate-900 rounded-xl p-3 h-full flex flex-col shadow-sm border border-gray-200/50 dark:border-slate-700/50">
                                <div class="text-sm font-semibold text-gray-700 dark:text-slate-300 mb-3 px-1 flex items-center gap-2">
                                    <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                    <span>ç±»åˆ«</span>
                                </div>
                                <div id="recipe-category-list" class="space-y-1 overflow-y-auto flex-1 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-slate-600">
                                    <!-- åŠ¨æ€ç”Ÿæˆçš„ç±»åˆ«åˆ—è¡¨ -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§é…æ–¹åˆ—è¡¨ -->
                        <div class="w-[70%] min-w-0">
                            <div class="bg-gradient-to-b from-gray-50/50 to-white dark:from-slate-800/50 dark:to-slate-900 rounded-xl p-3 h-full border border-gray-200/50 dark:border-slate-700/50 shadow-sm">
                                <div id="recipe-popup-list" class="flex flex-col gap-2 pr-2 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-slate-600 max-h-full overflow-y-auto">
                                    <!-- åŠ¨æ€ç”Ÿæˆçš„é…æ–¹åˆ—è¡¨ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-t border-gray-200/50 dark:border-slate-600/50">
                    <div class="flex justify-center">
                        <button onclick="closeMaterialSearch()" class="px-6 py-2 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all font-semibold shadow-sm border border-gray-200 dark:border-slate-600 text-sm">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å•ä½é€‰æ‹©å¼¹çª— -->
        <div id="unit-selector-popup" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-30 hidden">
            <div class="bg-white dark:bg-[#1E293B] card p-4 min-w-[200px] border border-gray-200 dark:border-slate-600">
                <div class="font-semibold mb-3 text-gray-800 dark:text-slate-100">é€‰æ‹©å•ä½</div>
                <div id="unit-selector-list" class="grid grid-cols-3 gap-2 mb-3"></div>
                <button onclick="closeUnitSelector()" class="w-full py-1 rounded bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
            </div>
        </div>
        <!-- æ–°å»ºç±»åˆ«å¼¹çª— -->
        <div id="categoryModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-30 hidden">
            <div class="bg-white dark:bg-[#1E293B] card p-6 min-w-[220px] border border-slate-200 dark:border-slate-600">
                <div class="font-semibold mb-2 text-[#1E293B] dark:text-slate-100">æ–°å»ºç±»åˆ«</div>
                <input id="newCategoryInput" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 focus:border-purple-600 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 outline-none bg-white dark:bg-[#0F172A] text-[#1E293B] dark:text-slate-100 mb-3" placeholder="è¾“å…¥æ–°ç±»åˆ«åç§°">
                <div class="flex gap-2">
                    <button onclick="closeCategoryModal()" class="flex-1 py-2 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
                    <button onclick="addNewCategory()" class="flex-1 py-2 rounded bg-gradient-to-r from-purple-600 to-purple-700 text-white font-semibold hover:from-purple-700 hover:to-purple-800 active:scale-95 transition-all">ç¡®å®š</button>
                </div>
            </div>
        </div>
        

        
        <!-- æ­¥éª¤æ“ä½œèœå•å¼¹çª— -->
        <div id="stepMenuModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white dark:bg-white rounded-2xl shadow-2xl p-0 max-w-xs w-full mx-4 overflow-hidden">
                <button id="stepMenuDelete" class="w-full px-6 py-4 text-red-600 text-lg font-medium hover:bg-red-50 active:bg-red-100 transition border-b border-gray-200">
                    åˆ é™¤
                </button>
                <button id="stepMenuAdd" class="w-full px-6 py-4 text-blue-600 text-lg font-medium hover:bg-blue-50 active:bg-blue-100 transition border-b border-gray-200">
                    æ·»åŠ ä¸€è¡Œ
                </button>
                <button onclick="closeStepMenuModal()" class="w-full px-6 py-4 text-gray-600 text-lg font-medium hover:bg-gray-50 active:bg-gray-100 transition">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
        
        <!-- åª’ä½“ä¸Šä¼ é€‰æ‹©å¼¹çª— -->
        <div id="mediaUploadModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white dark:bg-white rounded-2xl shadow-2xl p-0 max-w-xs w-full mx-4 overflow-hidden">
                <button onclick="selectImage()" class="w-full px-6 py-4 text-blue-600 text-lg font-medium hover:bg-blue-50 active:bg-blue-100 transition border-b border-gray-200">
                    <i class="fas fa-image mr-2"></i>é€‰æ‹©å›¾ç‰‡
                </button>
                <button onclick="selectVideo()" class="w-full px-6 py-4 text-green-600 text-lg font-medium hover:bg-green-50 active:bg-green-100 transition border-b border-gray-200">
                    <i class="fas fa-video mr-2"></i>é€‰æ‹©è§†é¢‘
                </button>
                <button onclick="captureMedia()" class="w-full px-6 py-4 text-purple-600 text-lg font-medium hover:bg-purple-50 active:bg-purple-100 transition border-b border-gray-200">
                    <i class="fas fa-camera mr-2"></i>æ‹ç…§/å½•åƒ
                </button>
                <button onclick="closeMediaUploadModal()" class="w-full px-6 py-4 text-gray-600 text-lg font-medium hover:bg-gray-50 active:bg-gray-100 transition">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
        
        <!-- å›¾ç‰‡è£å‰ªå¼¹çª— -->
        <div id="cropModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white dark:bg-[#1E293B] rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 border border-slate-200 dark:border-slate-600">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[#1E293B] dark:text-slate-100 font-semibold text-lg">è£å‰ªå›¾ç‰‡</h3>
                    <button onclick="closeCropModal()" class="text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xl active:scale-90 transition">Ã—</button>
                </div>
                
                <div class="space-y-4">
                    <!-- è£å‰ªåŒºåŸŸ -->
                    <div class="crop-container">
                        <img id="cropImage" style="max-width: 100%; display: block;">
                    </div>
                    
                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-slate-600 dark:text-slate-400">é¢„è§ˆæ•ˆæœï¼š</div>
                        <div class="crop-preview" id="cropPreview"></div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex gap-3">
                        <button onclick="closeCropModal()" class="flex-1 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
                        <button onclick="confirmCrop()" class="flex-1 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-purple-700 text-white font-semibold hover:from-purple-700 hover:to-purple-800 active:scale-95 transition-all">ç¡®å®šè£å‰ª</button>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- åˆ†äº«å¼¹çª— -->
    <div id="shareModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white dark:bg-[#1E293B] rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 border border-slate-200 dark:border-slate-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[#1E293B] dark:text-slate-100 font-semibold text-2xl">åˆ†äº«é£Ÿè°±</h3>
                <button onclick="document.getElementById('shareModal').classList.add('hidden')" class="text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xl active:scale-90 transition">Ã—</button>
            </div>
            
            <div class="mb-8">
                <p class="text-slate-600 dark:text-slate-400 mb-2">é€‰æ‹©åˆ†äº«å¹³å°</p>
                
                <!-- åˆ†äº«åŠŸèƒ½å·²ç§»é™¤ -->
                <div class="text-center py-8">
                    <div class="text-slate-400 dark:text-slate-500">
                        <i class="fas fa-info-circle text-3xl mb-3"></i>
                        <p class="text-lg mb-2">åˆ†äº«åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨</p>
                        <p class="text-sm">è¯¥åŠŸèƒ½æ­£åœ¨ç»´æŠ¤ä¸­ï¼Œæ•¬è¯·è°…è§£</p>
                    </div>
                </div>
            </div>
            
            <!-- å–æ¶ˆæŒ‰é’® -->
            <div class="w-full">
                <button onclick="document.getElementById('shareModal').classList.add('hidden')" class="w-full py-4 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-medium text-lg hover:bg-gray-200 dark:hover:bg-gray-700 active:scale-95 transition-all">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    

    
    <!-- é€€å‡ºç¡®è®¤å¼¹çª— -->
    <div id="exitConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-[#1E293B] rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-save text-blue-500 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-[#1E293B] dark:text-slate-100 mb-2">ä¿å­˜é…æ–¹è¿›åº¦</h3>
                <p class="text-slate-600 dark:text-slate-400 text-sm mb-6">æ£€æµ‹åˆ°æ‚¨æ­£åœ¨ç¼–è¾‘é…æ–¹ï¼Œæ˜¯å¦ä¿å­˜å½“å‰è¿›åº¦ï¼Ÿ</p>
                <div class="flex gap-3">
                    <button class="flex-1 px-4 py-2 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition" onclick="exitWithoutSaving()">ä¸ä¿å­˜</button>
                    <button class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl hover:from-blue-600 hover:to-indigo-600 transition" onclick="saveAndExit()">ä¿å­˜å¹¶é€€å‡º</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ‹ç…§è¯†åˆ«ç•Œé¢ -->
    <div id="cameraModal" class="fixed z-50 left-0 top-0 w-full h-full bg-black flex flex-col hidden">
        <!-- ç›¸æœºé¢„è§ˆåŒºåŸŸ -->
        <div id="cameraPreview" class="flex-1 bg-black hidden">
            <!-- å®é™…åº”ç”¨ä¸­è¿™é‡Œä¼šæ˜¾ç¤ºç›¸æœºé¢„è§ˆ -->
            <div class="w-full h-full relative overflow-hidden">
                <!-- æ¨¡æ‹Ÿç›¸æœºç•Œé¢ -->
                <div class="absolute inset-0 bg-gradient-to-b from-gray-700 to-gray-900 flex items-center justify-center">
                    <div class="text-white text-5xl opacity-30">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                
                <!-- æ‹ç…§é—ªå…‰æ•ˆæœ -->
                <div id="cameraFlash" class="absolute inset-0 bg-white hidden opacity-0 transition-opacity duration-200"></div>
                
                <!-- ç›¸æœºç½‘æ ¼å’Œå¯¹ç„¦å›¾æ ‡ -->
                <div class="absolute inset-0 grid grid-cols-3 grid-rows-3 pointer-events-none">
                    <div class="border-r border-b border-white/20"></div>
                    <div class="border-r border-l border-b border-white/20"></div>
                    <div class="border-l border-b border-white/20"></div>
                    <div class="border-r border-t border-b border-white/20"></div>
                    <div class="border-r border-l border-t border-b border-white/20 flex items-center justify-center">
                        <div class="w-12 h-12 border-2 border-blue-400 rounded-full opacity-50"></div>
                    </div>
                    <div class="border-l border-t border-b border-white/20"></div>
                    <div class="border-r border-t border-white/20"></div>
                    <div class="border-r border-l border-t border-white/20"></div>
                    <div class="border-l border-t border-white/20"></div>
                </div>
            </div>
        </div>
        
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="absolute top-0 left-0 right-0 p-4">
            <button class="text-white hover:bg-black/30 active:scale-95 transition rounded-full p-2" onclick="closeCamera()">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
        </div>
        
        <!-- åº•éƒ¨æ“ä½œåŒº -->
        <div class="bg-black py-6 px-4">
            <!-- è¯´æ˜æ–‡å­— -->
            <div class="text-white text-center mb-6">
                <p class="text-sm">æ‰‹å†™/ç”µå­é…æ–¹æœ¬ è‡ªåŠ¨è¯†åˆ«å¯å¿«é€Ÿåˆ›å»ºé…æ–¹</p>
            </div>
            
            <!-- æ‹ç…§æŒ‰é’® -->
            <div class="flex justify-center items-center">
                <button class="w-16 h-16 rounded-full bg-white flex items-center justify-center active:scale-95 transition" onclick="takePhoto()">
                    <div class="w-14 h-14 border-2 border-gray-300 rounded-full"></div>
                </button>
            </div>
        </div>
    </div>
    </div>
    <script>
        // å…¨å±€å˜é‡
        let hasModifiedIngredients = false;
        
        // å®šä¹‰savedRecipeså¯¹è±¡ï¼Œç”¨äºé…æ–¹æœç´¢å’Œå¯¼å…¥
        const savedRecipes = {
            // è›‹ç³•ç±»ç¤ºä¾‹æ•°æ®
            'ç»å…¸æˆšé£è›‹ç³•': {
                description: 'æ¾è½¯ç»µå¯†çš„ç»å…¸æˆšé£è›‹ç³•',
                category: 'è›‹ç³•ç±»',
                image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'ä½ç­‹é¢ç²‰', amount: 100, unit: 'g' },
                    { name: 'é¸¡è›‹', amount: 5, unit: 'ä¸ª' },
                    { name: 'ç»†ç ‚ç³–', amount: 80, unit: 'g' },
                    { name: 'ç‰ç±³æ²¹', amount: 40, unit: 'ml' },
                    { name: 'ç‰›å¥¶', amount: 50, unit: 'ml' }
                ]
            },
            'å·§å…‹åŠ›è›‹ç³•': {
                description: 'æµ“éƒé¦™é†‡çš„å·§å…‹åŠ›è›‹ç³•',
                category: 'è›‹ç³•ç±»',
                image: 'https://images.unsplash.com/photo-1586444248902-2f64eddc13df?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&q=80',
                ingredients: [
                    { name: 'ä½ç­‹é¢ç²‰', amount: 100, unit: 'g' },
                    { name: 'å¯å¯ç²‰', amount: 30, unit: 'g' },
                    { name: 'é¸¡è›‹', amount: 4, unit: 'ä¸ª' },
                    { name: 'ç»†ç ‚ç³–', amount: 90, unit: 'g' },
                    { name: 'é»„æ²¹', amount: 50, unit: 'g' },
                    { name: 'ç‰›å¥¶', amount: 60, unit: 'ml' }
                ]
            }
        };
        
        // é¡µé¢é€€å‡ºç¡®è®¤ç›¸å…³å‡½æ•°
        function checkExitConfirmation() {
            if (hasModifiedIngredients) {
                document.getElementById('exitConfirmModal').classList.remove('hidden');
            } else {
                window.history.back();
            }
        }
        
        // Tabåˆ‡æ¢åŠŸèƒ½ - ä¿®å¤æœªå®šä¹‰çš„switchTabå‡½æ•°
        function switchTab(tab) {
            console.log('åˆ‡æ¢åˆ°æ ‡ç­¾:', tab);
            // æ›´æ–°TabæŒ‰é’®çŠ¶æ€
            const tabs = ['recipe', 'step'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-btn-${t}`);
                const section = document.getElementById(`${t}-section`);
                
                if (t === tab) {
                    btn.classList.add('tab-active', 'tab-bg-active');
                    btn.classList.remove('tab-inactive', 'tab-bg-inactive');
                    if (section) section.classList.remove('hidden');
                } else {
                    btn.classList.remove('tab-active', 'tab-bg-active');
                    btn.classList.add('tab-inactive', 'tab-bg-inactive');
                    if (section) section.classList.add('hidden');
                }
            });
            
            // åˆ‡æ¢é…æ–¹ä¿¡æ¯æ˜¾ç¤ºï¼ˆé…æ–¹åç§°å’Œåˆ†ç±»é€‰æ‹©ä»…åœ¨é…æ–¹é¡µé¢æ˜¾ç¤ºï¼‰
            const recipeMetaSection = document.getElementById('recipe-meta-section');
            if (recipeMetaSection) {
                if (tab === 'recipe') {
                    recipeMetaSection.classList.remove('hidden');
                } else {
                    recipeMetaSection.classList.add('hidden');
                }
            }
            
            // æ›´æ–°åº•éƒ¨æ æ˜¾ç¤º
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                const totalWeightCard = saveBtn.parentElement.querySelector('.flex.items-center');
                if(tab==='step') {
                    saveBtn.textContent = 'ä¿å­˜æ­¥éª¤';
                    if (totalWeightCard) totalWeightCard.classList.add('hidden');
                    saveBtn.classList.add('w-full');
                } else {
                    saveBtn.textContent = 'ä¿å­˜é…æ–¹';
                    if (totalWeightCard) totalWeightCard.classList.remove('hidden');
                    saveBtn.classList.remove('w-full');
                }
            }
            
            // æ­¥éª¤é¦–æ¬¡æ‰“å¼€æ—¶åˆå§‹åŒ–æ•°æ®
            if(tab==='step' && document.getElementById('stepsList') && document.getElementById('stepsList').children.length === 0) {
                initSteps();
            }
        }
        
        // æ–°å»ºç±»åˆ«å¼¹çª— - ä¿®å¤æœªå®šä¹‰çš„openCategoryModalå‡½æ•°
        function openCategoryModal() {
            console.log('æ‰“å¼€æ–°å»ºç±»åˆ«å¼¹çª—');
            const modal = document.getElementById('categoryModal');
            if (modal) {
                modal.classList.remove('hidden');
                const inputField = document.getElementById('newCategoryInput');
                if (inputField) {
                    inputField.value = '';
                    setTimeout(() => {
                        inputField.focus();
                    }, 100);
                }
            } else {
                console.error('æ‰¾ä¸åˆ°categoryModalå…ƒç´ ');
            }
        }
        
        function closeCategoryModal() {
            const modal = document.getElementById('categoryModal');
            if (modal) modal.classList.add('hidden');
        }
        
        function addNewCategory() {
            const input = document.getElementById('newCategoryInput');
            const val = input ? input.value.trim() : '';
            if (val) {
                const select = document.getElementById('categorySelect');
                if (select) {
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = val;
                    select.appendChild(opt);
                    select.value = val;
                }
                closeCategoryModal();
            }
        }
        
        // æ·»åŠ åŸæ–™è¡Œ - ä¿®å¤æœªå®šä¹‰çš„addIngredientå‡½æ•°
        function addIngredient(type) {
            console.log('æ·»åŠ ææ–™ï¼Œç±»å‹:', type);
            // æ ‡è®°ä¸ºå·²ä¿®æ”¹
            hasModifiedIngredients = true;
            
            // è·å–å®¹å™¨å…ƒç´ 
            const containerId = `${type}Ingredients`;
            const container = document.getElementById(containerId);
            
            if (!container) {
                console.error(`æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
                alert(`æ·»åŠ ææ–™æ—¶å‡ºé”™: æ‰¾ä¸åˆ°å®¹å™¨ ${containerId}`);
                return;
            }
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºå˜åŒ–æ¬¾ä¸­çš„åŸºç¡€äº§å“
            let nameValue = '';
            let nameReadOnly = false;
            if (type.startsWith('variation')) {
                nameValue = 'åŸºç¡€äº§å“';
                nameReadOnly = true;
            }
            
            // åˆ›å»ºææ–™è¡Œå…ƒç´ 
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 bg-white dark:bg-[#1E293B] rounded-lg p-2.5 shadow-sm border border-slate-200 dark:border-slate-600 ingredient-item';
            div.setAttribute('data-open', 'false');
            div.innerHTML = `
                <div class="drag-handle p-1.5 rounded-full hover:bg-[#F1F5F9] dark:hover:bg-[#334155] cursor-grab text-slate-400 dark:text-slate-500 transition" title="æ‹–æ‹½æ’åº">
                    <i class="fas fa-grip-lines"></i>
                </div>
                <div class="flex-1 min-w-[90px] relative">
                    <input type="text" placeholder="åç§°" class="name-input w-full px-2 py-2 text-sm border-none outline-none ${nameReadOnly?'bg-gray-100 dark:bg-slate-600 cursor-not-allowed text-gray-500 dark:text-slate-400':'bg-white/80 dark:bg-slate-700/50 text-gray-800 dark:text-slate-100'} rounded-lg not-synced" value="${nameValue}" ${nameReadOnly?'readonly':''} onclick="if(!this.readOnly){showMaterialSearch(this);}" oninput="updateAutoFields(this)">
                    <div class="synced-text sync-status-text" style="display: none;">âœ“ å·²åŒæ­¥ææ–™åº“</div>
                    <div class="not-synced-text sync-status-text" style="display: none;">! è‡ªå»ºææ–™</div>
                </div>
                <div class="w-24 relative flex items-center">
                    <input type="text" inputmode="decimal" placeholder="ç”¨é‡" class="w-full px-1 py-2 text-sm text-center border-none outline-none bg-white/80 dark:bg-slate-700/50 rounded-lg text-gray-800 dark:text-slate-100" oninput="updateAutoFields(this)">
                    <button class="unit-btn ml-1 px-1.5 py-0.5 text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded hover:bg-purple-200 dark:hover:bg-purple-900/50 active:scale-95 transition-all" onclick="showUnitSelector(this)">g</button>
                </div>
                <div class="flex flex-col gap-1 min-w-[50px]">
                    <div class="cost-field text-emerald-600 dark:text-emerald-400 select-none text-xs font-medium bg-emerald-50 dark:bg-emerald-900/20 px-1 py-0.5 rounded text-center">Â¥0.00</div>
                    <span class="percent-field text-slate-500 dark:text-slate-400 select-none text-xs font-medium bg-slate-50 dark:bg-slate-800/50 px-1 py-0.5 rounded text-center">0%</span>
                </div>
                <div class="delete-action"><i class="fas fa-trash-alt mr-1"></i> åˆ é™¤</div>
            `;
            
            // æ·»åŠ åˆ°å®¹å™¨
            container.appendChild(div);
            
            // ä¸ºæ–°æ·»åŠ çš„åç§°è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const nameInput = div.querySelector('.name-input');
            if (nameInput && !nameInput.readOnly && !nameInput.hasAttribute('data-listener-added')) {
                nameInput.addEventListener('click', function() {
                    showMaterialSearch(this);
                });
                nameInput.addEventListener('input', function() {
                    if (this.value) {
                        showMaterialSearch(this);
                    } else {
                        closeMaterialSearch();
                    }
                });
                nameInput.setAttribute('data-listener-added', 'true');
            }
            
            // åˆå§‹åŒ–å·¦æ»‘åˆ é™¤åŠŸèƒ½
            if (typeof initSwipeDelete === 'function') {
                initSwipeDelete(div);
            }
            
            // æ›´æ–°æ’åºå’Œå˜åŒ–æ¬¾æ€»é‡
            if (typeof updateSortable === 'function') {
                updateSortable();
            }
            if (typeof updateVariationTotal === 'function') {
                updateVariationTotal();
            }
        }
        
        // æ·»åŠ æ­¥éª¤ - ä¿®å¤æœªå®šä¹‰çš„addStepInRecipeå‡½æ•°
        function addStepInRecipe() {
            console.log('æ·»åŠ é…æ–¹æ­¥éª¤');
            // æ ‡è®°ä¸ºå·²ä¿®æ”¹
            hasModifiedIngredients = true;
            
            // è·å–å½“å‰æ­¥éª¤æ•°é‡
            const stepCards = document.querySelectorAll('.card:has([id$="Ingredients"])');
            const stepCount = stepCards.length > 0 ? stepCards.length - 1 : 0; // å‡å»åŸºç¡€äº§å“
            
            // åˆ›å»ºæ–°æ­¥éª¤IDå’Œåç§°
            const stepName = `æ­¥éª¤${stepCount + 1}`;
            const stepId = `step${stepCount + 1}`;
            
            // åˆ›å»ºæ­¥éª¤å¡ç‰‡å…ƒç´ 
            const div = document.createElement('div');
            div.className = 'card p-4';
            div.innerHTML = `
                <div class="flex justify-between items-center mb-3 bg-[#F8FAFC] dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-[#F8FAFC] dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-tasks text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 class="font-semibold text-[#1E293B] dark:text-slate-100">${stepName}</h3>
                    </div>
                </div>
                <div id="${stepId}Ingredients" class="ingredients-group space-y-2"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('${stepId}')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ ææ–™</span>
                    </button>
                </div>
            `;
            
            // è·å–æ·»åŠ æ­¥éª¤æŒ‰é’®å’Œæ’å…¥æ–°æ­¥éª¤
            const addStepButton = document.querySelector('button[onclick="addStepInRecipe()"]');
            if (addStepButton && addStepButton.parentElement) {
                addStepButton.parentElement.parentNode.insertBefore(div, addStepButton.parentElement);
                
                // åˆå§‹åŒ–æ–°æ­¥éª¤çš„æ’åº
                if (typeof Sortable !== 'undefined') {
                    new Sortable(document.getElementById(`${stepId}Ingredients`), {
                        handle: '.drag-handle',
                        animation: 150
                    });
                }
            } else {
                console.error('æ‰¾ä¸åˆ°æ·»åŠ æ­¥éª¤æŒ‰é’®');
                // å°è¯•æ·»åŠ åˆ°variationListä¹‹å‰
                const variationList = document.getElementById('variationList');
                if (variationList) {
                    variationList.parentNode.insertBefore(div, variationList);
                } else {
                    // å°è¯•æ·»åŠ åˆ°recipe-sectionæœ«å°¾
                    const recipeSection = document.getElementById('recipe-section');
                    if (recipeSection) {
                        recipeSection.appendChild(div);
                    } else {
                        console.error('æ‰¾ä¸åˆ°é€‚åˆçš„ä½ç½®æ’å…¥æ–°æ­¥éª¤');
                    }
                }
            }
        }
        
        // æ·»åŠ å…¶ä»–å¿…è¦å‡½æ•°çš„å­˜æ ¹ä»¥é¿å…é”™è¯¯
        function initSteps() {
            console.log('åˆå§‹åŒ–æ­¥éª¤');
            // å®ç°æ­¥éª¤åˆå§‹åŒ–é€»è¾‘
        }
        
        function showUnitSelector(button) {
            console.log('æ˜¾ç¤ºå•ä½é€‰æ‹©å™¨');
            // å®ç°å•ä½é€‰æ‹©å™¨æ˜¾ç¤ºé€»è¾‘
        }
        
        function updateAutoFields(input) {
            console.log('æ›´æ–°è‡ªåŠ¨å­—æ®µ');
            // å®ç°æ›´æ–°è‡ªåŠ¨å­—æ®µé€»è¾‘
        }
        
        function updateSortable() {
            console.log('æ›´æ–°æ’åº');
            // å®ç°æ›´æ–°æ’åºé€»è¾‘
        }
        
        function updateVariationTotal() {
            console.log('æ›´æ–°å˜åŒ–æ¬¾æ€»é‡');
            // å®ç°æ›´æ–°å˜åŒ–æ¬¾æ€»é‡é€»è¾‘
        }
        
        // ææ–™åˆ—è¡¨å®šä¹‰
        const materialList = [
            'ä½ç­‹é¢ç²‰', 'é«˜ç­‹é¢ç²‰', 'ä¸­ç­‹é¢ç²‰', 'å…¨éº¦ç²‰', 'ç‰ç±³æ·€ç²‰', 'æ³¡æ‰“ç²‰',
            'é¸¡è›‹', 'è›‹é»„', 'è›‹ç™½', 'ç‰›å¥¶', 'æ·¡å¥¶æ²¹', 'é…¸å¥¶', 'ç‚¼ä¹³',
            'ç»†ç ‚ç³–', 'ç»µç™½ç³–', 'çº¢ç³–', 'ç³–ç²‰', 'èœ‚èœœ', 'æ«ç³–æµ†',
            'é»„æ²¹', 'æ¤ç‰©æ²¹', 'ç‰ç±³æ²¹', 'æ©„æ¦„æ²¹', 'æ¤°å­æ²¹',
            'é¦™è‰ç²¾', 'æŸ æª¬æ±', 'æŸ æª¬çš®å±‘', 'å¯å¯ç²‰', 'å·§å…‹åŠ›',
            'å¥¶æ²¹å¥¶é…ª', 'é©¬æ–¯å¡å½­', 'é…¸å¥¶æ²¹', 'å‰åˆ©ä¸', 'æ˜è† ç²‰',
            'æä»ç²‰', 'æ¤°è“‰', 'æ ¸æ¡ƒ', 'æä»', 'å¼€å¿ƒæœ', 'è”“è¶Šè“', 'è‘¡è„å¹²'
        ];
        
        let currentNameInput = null;
        
        function showMaterialSearch(input) {
            console.log('æ˜¾ç¤ºææ–™æœç´¢', input);
            currentNameInput = input;
            if (!input.value) {
                closeMaterialSearch();
                return;
            }
            updateMaterialSearch(input.value);
            document.getElementById('material-popup').classList.remove('hidden');
        }
        
        function updateMaterialSearch(keyword) {
            const list = document.getElementById('material-popup-list');
            list.innerHTML = '';
            
            // è¿‡æ»¤åŒ¹é…çš„ææ–™
            const filteredMaterials = materialList.filter(m => m.includes(keyword));
            
            if (filteredMaterials.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 dark:text-slate-400 py-4">æœªæ‰¾åˆ°åŒ¹é…çš„ææ–™</div>';
                return;
            }
            
            filteredMaterials.forEach(m => {
                const button = document.createElement('button');
                button.className = 'px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-400 hover:bg-purple-100 dark:hover:bg-purple-900/30 text-left transition-all w-full';
                button.textContent = m;
                button.onclick = () => {
                    currentNameInput.value = m;
                    // åŒæ­¥çŠ¶æ€å˜ç»¿
                    const nameInput = currentNameInput;
                    nameInput.classList.remove('not-synced');
                    nameInput.classList.add('synced');
                    
                    closeMaterialSearch();
                    updateAutoFields(currentNameInput);
                };
                list.appendChild(button);
            });
        }
        
        function closeMaterialSearch() {
            document.getElementById('material-popup').classList.add('hidden');
        }
        
        // ä¸ºåç§°è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        function addNameInputListeners() {
            const nameInputs = document.querySelectorAll('input[placeholder="ææ–™åç§°"]');
            nameInputs.forEach(input => {
                if (!input.hasAttribute('data-listener-added')) {
                    input.addEventListener('click', function() {
                        showMaterialSearch(this);
                    });
                    input.addEventListener('input', function() {
                        if (this.value) {
                            showMaterialSearch(this);
                        } else {
                            closeMaterialSearch();
                        }
                    });
                    input.setAttribute('data-listener-added', 'true');
                }
            });
        }
        
        function initSwipeDelete(element) {
            console.log('åˆå§‹åŒ–å·¦æ»‘åˆ é™¤');
            // å®ç°å·¦æ»‘åˆ é™¤åˆå§‹åŒ–é€»è¾‘
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-80 text-white px-4 py-2 rounded-xl z-50 text-sm';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            try {
                // åˆå§‹åŒ–æ·»åŠ ä¸€äº›é»˜è®¤ææ–™
                ['stepOne', 'base'].forEach(type => {
                    try {
                        addIngredient(type);
                    } catch (error) {
                        console.error(`åˆå§‹åŒ–ææ–™å¤±è´¥ (${type}):`, error);
                    }
                });
                
                // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
                document.addEventListener('click', function(e) {
                    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶å…³é—­æ‰€æœ‰æ‰“å¼€çš„åˆ é™¤æŒ‰é’®
                    const openItems = document.querySelectorAll('.ingredient-item[data-open="true"]');
                    if (openItems.length > 0 && !e.target.closest('.delete-action')) {
                        openItems.forEach(item => {
                            item.style.transform = 'translateX(0)';
                            item.setAttribute('data-open', 'false');
                        });
                    }
                });
                
                // ç»‘å®šå˜åŒ–æ¬¾æ·»åŠ æŒ‰é’®äº‹ä»¶
                const addVariationBtn = document.getElementById('addVariationBtn');
                if (addVariationBtn) {
                    addVariationBtn.onclick = addVariationGroup;
                }
                
                // ä¸ºç°æœ‰çš„åç§°è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                addNameInputListeners();
                
                // è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
                console.log('åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–å‡ºé”™:', error);
            }
        });
        
        // æ·»åŠ å˜åŒ–æ¬¾åˆ†ç»„å‡½æ•°
        function addVariationGroup() {
            // æ ‡è®°ä¸ºå·²ä¿®æ”¹
            hasModifiedIngredients = true;
            
            console.log('æ·»åŠ å˜åŒ–æ¬¾åˆ†ç»„');
            // è·å–å˜åŒ–æ¬¾è®¡æ•°å¹¶é€’å¢
            window.variationCount = (window.variationCount || 0) + 1;
            const id = `variation${window.variationCount}`;
            
            // åˆ›å»ºå˜åŒ–æ¬¾åˆ†ç»„å…ƒç´ 
            const div = document.createElement('div');
            div.className = 'card p-4 mb-4 variation-group';
            div.innerHTML = `
                <div class="flex justify-between items-center mb-3 bg-[#F8FAFC] dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-[#F8FAFC] dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-cubes text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 class="font-semibold text-[#1E293B] dark:text-slate-100">å…¶ä»–äº§å“</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/30 active:scale-90 transition rounded-full p-1" onclick="this.closest('.variation-group').remove(); updateAllAutoFields();"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div id="${id}Ingredients" class="space-y-2 ingredients-group"></div>
                <div id="${id}Total" class="mt-3 text-right text-sm text-purple-700 dark:text-purple-300 font-semibold bg-purple-100/50 dark:bg-purple-900/20 rounded-lg px-3 py-1 hidden"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('${id}')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ ä¸€è¡Œ</span>
                    </button>
                </div>
            `;
            
            // æ·»åŠ åˆ°å˜åŒ–æ¬¾åˆ—è¡¨
            const variationList = document.getElementById('variationList');
            if (variationList) {
                variationList.appendChild(div);
                
                // åˆå§‹åŒ–æ’åº
                if (typeof updateSortable === 'function') {
                    updateSortable();
                }
            } else {
                console.error('æ‰¾ä¸åˆ°variationListå…ƒç´ ');
            }
        }
        
        // æ·»åŠ æ‹–æ‹½ååˆ·æ–°æ‰€æœ‰åˆ†ç»„è‡ªåŠ¨å­—æ®µ
        function updateAllAutoFields() {
            document.querySelectorAll('.ingredients-group').forEach(group => {
                Array.from(group.children).forEach(row => {
                    updateAutoFields(row.querySelector('input[type="number"]') || row.querySelector('input[type="text"]'));
                });
            });
        }
        
        // æš—è‰²æ¨¡å¼åˆ‡æ¢
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            if(html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme','light');
            } else {
                html.classList.add('dark');
                icon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme','dark');
            }
            
            // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å…ƒç´ çš„æš—è‰²æ¨¡å¼æ ·å¼
            refreshDarkModeStyles();
        }
        
        // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å…ƒç´ çš„æš—è‰²æ¨¡å¼æ ·å¼
        function refreshDarkModeStyles() {
            // è·å–æ‰€æœ‰å¯èƒ½éœ€è¦æ›´æ–°çš„å…ƒç´ 
            const elementsToRefresh = [
                '.card', '.step-images', '.bg-white', '.bg-slate-50', '.bg-slate-100',
                '.text-slate-800', '.text-slate-600', '.text-slate-500', '.text-slate-400',
                '.border-slate-100', '.border-slate-200', '.border-slate-300',
                '.hover\\:bg-slate-50', '.hover\\:bg-slate-100',
                '.sop-step-enhanced', '.sop-step-row', '.sop-step-input',
                '.sop-type-item', '.media-upload-area', '.step-row'
            ].join(',');
            
            const allElements = document.querySelectorAll(elementsToRefresh);
            
            // å…ˆç§»é™¤å†æ·»åŠ æ‰€æœ‰å…ƒç´ çš„classï¼Œå¼ºåˆ¶æµè§ˆå™¨é‡æ–°åº”ç”¨æ ·å¼
            allElements.forEach(el => {
                el.classList.remove('dark-force-refresh');
                setTimeout(() => {
                    el.classList.add('dark-force-refresh');
                    setTimeout(() => {
                        el.classList.remove('dark-force-refresh');
                    }, 10);
                }, 5);
            });
        }
        
        // è‡ªåŠ¨è¯»å–ä¸»é¢˜
        (function(){
            if(localStorage.getItem('theme')==='dark') {
                document.documentElement.classList.add('dark');
                if (document.getElementById('themeIcon')) {
                    document.getElementById('themeIcon').textContent = 'â˜€ï¸';
                }
            }
        })();

        // æ·»åŠ æ­¥éª¤å‡½æ•°
        function addStep(stepTitle = '', stepContent = '') {
            console.log('æ·»åŠ æ­¥éª¤');
            const container = document.getElementById('stepsList');
            const div = document.createElement('div');
            div.className = 'step-row card p-4 mb-4 relative';
            
            // åˆ›å»ºæ­¥éª¤ç¼–å·
            const stepNum = document.querySelectorAll('#stepsList .step-row').length + 1;
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center">
                        <div class="step-number w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-semibold mr-3">
                            ${stepNum}
                        </div>
                        <input type="text" class="bg-transparent border-b border-slate-200 dark:border-slate-600 outline-none focus:border-purple-500 text-gray-800 dark:text-slate-100 font-semibold" placeholder="æ­¥éª¤æ ‡é¢˜" value="${stepTitle}">
                    </div>
                    <div class="flex gap-1">
                        <button class="text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 p-1.5 rounded-full transition-all" onclick="openStepMenu(this)">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="step-drag-handle p-1.5 rounded-full hover:bg-[#F1F5F9] dark:hover:bg-[#334155] cursor-grab text-slate-400 dark:text-slate-500 transition" title="æ‹–æ‹½æ’åº">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                    </div>
                </div>
                
                <div class="p-4">
                    <!-- æ­¥éª¤å†…å®¹è¾“å…¥ -->
                    <textarea class="w-full px-4 py-3 bg-gray-50 dark:bg-slate-800 text-gray-800 dark:text-slate-100 border border-slate-200 dark:border-slate-600 rounded-xl outline-none resize-none placeholder-slate-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 transition text-sm leading-relaxed mb-4" 
                              placeholder="è¯·è¾“å…¥è¯¦ç»†çš„åˆ¶ä½œæ­¥éª¤è¯´æ˜..." rows="3">${stepContent}</textarea>
                    
                    <!-- åª’ä½“ä¸Šä¼ åŒº -->
                    <div class="flex overflow-x-auto gap-3 pb-2 mb-2 snap-x">
                        <div class="media-slot flex-none w-[70%] snap-center relative">
                            <div class="media-upload-area w-full h-20 rounded-lg flex items-center justify-center cursor-pointer transition-all border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-purple-500 hover:bg-gray-50 dark:hover:bg-slate-800" onclick="openMediaUpload(this)">
                                <div class="text-center text-slate-400 dark:text-slate-500">
                                    <i class="fas fa-plus text-lg mb-1"></i>
                                    <div class="text-xs">æ·»åŠ å›¾ç‰‡/è§†é¢‘</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // è®¾ç½®æ­¥éª¤ç¼–å·æ ·å¼
            const stepNumber = div.querySelector('.step-number');
            stepNumber.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            
            container.appendChild(div);
            updateStepNumbers();
            return div;
        }

        // æ›´æ–°æ­¥éª¤ç¼–å·
        function updateStepNumbers() {
            const steps = document.querySelectorAll('#stepsList .step-row');
            steps.forEach((step, index) => {
                const numberElement = step.querySelector('.step-number');
                if (numberElement) {
                    numberElement.textContent = index + 1;
                }
            });
        }

        // åˆå§‹åŒ–æ­¥éª¤æ•°æ®
        function initSteps() {
            // åˆå§‹åŒ–3ä¸ªç¤ºä¾‹æ­¥éª¤ï¼Œåˆ†åˆ«å±•ç¤ºä¸åŒçš„å†…å®¹
            const defaultSteps = [
                { title: 'æ­¥éª¤1ï¼ˆè›‹é»„æ‰“å‘ï¼‰', content: 'å°†è›‹é»„å’Œä¸€åŠçš„ç³–æ”¾å…¥æ…æ‹Œç¢—ä¸­ï¼Œç”¨ç”µåŠ¨æ‰“è›‹å™¨ä¸­é€Ÿæ‰“å‘è‡³é¢œè‰²å˜æµ…ï¼Œè´¨åœ°å˜åš' },
                { title: 'æ­¥éª¤2ï¼ˆè›‹ç™½æ‰“å‘ï¼‰', content: 'å°†è›‹ç™½å’Œå‰©ä½™çš„ç³–åˆ†3æ¬¡åŠ å…¥ï¼Œæ‰“å‘è‡³æ¹¿æ€§å‘æ³¡ï¼Œç”¨æ‰“è›‹å™¨æèµ·å¯ä»¥å½¢æˆå°–è§’' },
                { title: 'æ­¥éª¤3ï¼ˆæ··åˆé¢ç²‰ï¼‰', content: 'å°†ç­›è¿‡çš„ä½ç­‹é¢ç²‰åˆ†3æ¬¡åŠ å…¥è›‹é»„ç³Šä¸­ï¼Œç”¨æ©¡çš®åˆ®åˆ€ä»¥åˆ‡æ‹Œæ–¹å¼æ··åˆï¼Œæ³¨æ„ä¸è¦è¿‡åº¦æ…æ‹Œ' }
            ];
            
            // åˆ›å»ºæ­¥éª¤
            defaultSteps.forEach((step) => {
                addStep(step.title, step.content);
            });
            
            updateStepSortable();
        }
        
        // æ›´æ–°æ­¥éª¤çš„æ‹–æ‹½æ’åºåŠŸèƒ½
        function updateStepSortable() {
            const container = document.getElementById('stepsList');
            if (container && typeof Sortable !== 'undefined') {
                new Sortable(container, {
                    handle: '.step-drag-handle', // ä½¿ç”¨ä¸“é—¨çš„æ‹–åŠ¨æŠŠæ‰‹
                    animation: 150,
                    ghostClass: 'bg-purple-50 dark:bg-purple-900/20',
                    onEnd: function() {
                        updateStepNumbers();
                    }
                });
            }
        }
        
        // æ­¥éª¤èœå•åŠŸèƒ½
        let currentStepRow = null;
        let currentMediaSlot = null;
        
        function openStepMenu(btn) {
            currentStepRow = btn.closest('.step-row');
            document.getElementById('stepMenuModal').classList.remove('hidden');
            
            // ç»‘å®šèœå•æ“ä½œ
            document.getElementById('stepMenuDelete').onclick = function() {
                if(document.getElementById('stepsList').children.length <= 1) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ­¥éª¤');
                    return;
                }
                currentStepRow.remove();
                updateStepNumbers();
                closeStepMenuModal();
            };
            
            document.getElementById('stepMenuAdd').onclick = function() {
                addStep();
                const container = document.getElementById('stepsList');
                const newRow = container.lastElementChild;
                container.insertBefore(newRow, currentStepRow.nextSibling);
                updateStepNumbers();
                updateStepSortable();
                closeStepMenuModal();
            };
        }
        
        function closeStepMenuModal() {
            document.getElementById('stepMenuModal').classList.add('hidden');
            currentStepRow = null;
        }
        
        // åª’ä½“ä¸Šä¼ åŠŸèƒ½
        function openMediaUpload(slot) {
            currentMediaSlot = slot;
            document.getElementById('mediaUploadModal').classList.remove('hidden');
        }
        
        function closeMediaUploadModal() {
            document.getElementById('mediaUploadModal').classList.add('hidden');
            currentMediaSlot = null;
        }
        
        function selectImage() {
            // æ¨¡æ‹Ÿé€‰æ‹©å›¾ç‰‡
            closeMediaUploadModal();
            if (currentMediaSlot) {
                const mediaSlot = currentMediaSlot.closest('.media-slot');
                mediaSlot.innerHTML = `
                    <div class="media-preview w-full h-20 rounded-lg overflow-hidden relative">
                        <img src="https://images.unsplash.com/photo-1464305795204-6f5bbfc7fb81?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" class="w-full h-full object-cover">
                        <button class="remove-btn w-6 h-6 rounded-full flex items-center justify-center text-white text-xs" onclick="removeMedia(this)">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 p-1.5 bg-gradient-to-t from-black/70 to-transparent">
                            <div class="flex justify-between items-center">
                                <button class="text-white hover:text-purple-300 transition" onclick="showFullImage(this.closest('.media-preview'))">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <span class="text-white text-xs">å›¾ç‰‡</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ ä¸€ä¸ªæ–°çš„ç©ºç™½åª’ä½“æ§½
                addEmptyMediaSlot(mediaSlot.parentElement);
            }
        }
        
        function selectVideo() {
            // æ¨¡æ‹Ÿé€‰æ‹©è§†é¢‘
            closeMediaUploadModal();
            if (currentMediaSlot) {
                const mediaSlot = currentMediaSlot.closest('.media-slot');
                mediaSlot.innerHTML = `
                    <div class="media-preview w-full h-20 rounded-lg overflow-hidden relative">
                        <img src="https://images.unsplash.com/photo-1527529482837-4698179dc6ce?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" class="w-full h-full object-cover">
                        <div class="video-indicator w-8 h-8 rounded-full bg-black/50 flex items-center justify-center">
                            <i class="fas fa-play text-white"></i>
                        </div>
                        <button class="remove-btn w-6 h-6 rounded-full flex items-center justify-center text-white text-xs" onclick="removeMedia(this)">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 p-1.5 bg-gradient-to-t from-black/70 to-transparent">
                            <div class="flex justify-between items-center">
                                <button class="text-white hover:text-purple-300 transition" onclick="showFullImage(this.closest('.media-preview'))">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <span class="text-white text-xs">è§†é¢‘</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ ä¸€ä¸ªæ–°çš„ç©ºç™½åª’ä½“æ§½
                addEmptyMediaSlot(mediaSlot.parentElement);
            }
        }
        
        function addEmptyMediaSlot(mediaContainer) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç©ºç™½çš„åª’ä½“æ§½
            const existingEmptySlots = mediaContainer.querySelectorAll('.media-upload-area').length;
            if (existingEmptySlots > 0) {
                return; // å·²ç»æœ‰ç©ºç™½åª’ä½“æ§½ï¼Œä¸éœ€è¦å†æ·»åŠ 
            }
            
            // åˆ›å»ºæ–°çš„ç©ºç™½åª’ä½“æ§½
            const emptySlot = document.createElement('div');
            emptySlot.className = 'media-slot flex-none w-[70%] snap-center relative';
            emptySlot.innerHTML = `
                <div class="media-upload-area w-full h-20 rounded-lg flex items-center justify-center cursor-pointer transition-all border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-purple-500 hover:bg-gray-50 dark:hover:bg-slate-800" onclick="openMediaUpload(this)">
                    <div class="text-center text-slate-400 dark:text-slate-500">
                        <i class="fas fa-plus text-lg mb-1"></i>
                        <div class="text-xs">å›¾ç‰‡/è§†é¢‘</div>
                    </div>
                </div>
            `;
            mediaContainer.appendChild(emptySlot);
        }
        
        function captureMedia() {
            // æ‰“å¼€ç›¸æœºç•Œé¢
            closeMediaUploadModal();
            document.getElementById('cameraModal').classList.remove('hidden');
            document.getElementById('cameraPreview').classList.remove('hidden');
        }
        
        function closeCamera() {
            document.getElementById('cameraModal').classList.add('hidden');
            document.getElementById('cameraPreview').classList.add('hidden');
        }
        
        function takePhoto() {
            // æ¨¡æ‹Ÿæ‹ç…§æ•ˆæœ
            const flashEffect = document.getElementById('cameraFlash');
            flashEffect.classList.remove('hidden');
            flashEffect.style.opacity = '1';
            
            setTimeout(() => {
                flashEffect.style.opacity = '0';
                setTimeout(() => {
                    flashEffect.classList.add('hidden');
                    showNotification('âœ… å·²è‡ªåŠ¨è¯†åˆ«é…æ–¹å†…å®¹');
                    closeCamera();
                }, 300);
            }, 100);
        }
        
        // å›¾ç‰‡å…¨å±é¢„è§ˆåŠŸèƒ½
        function showFullImage(container) {
            const img = container.querySelector('img');
            const modal = document.getElementById('fullImageModal');
            const modalImg = modal.querySelector('img');
            
            if (img) {
                // è·å–åŸå§‹å›¾ç‰‡URLï¼Œæ˜¾ç¤ºé«˜æ¸…å¤§å›¾
                modalImg.src = img.src;
                modal.classList.remove('hidden');
            }
        }
        

        
        // åˆ†äº«ç›¸å…³å‡½æ•°å·²ç§»é™¤
        
        // é€šçŸ¥æ˜¾ç¤ºå‡½æ•°
        function showNotification(message) {
            console.log('é€šçŸ¥:', message);
            // åˆ›å»ºä¸´æ—¶é€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    </script>
</body>
</html>