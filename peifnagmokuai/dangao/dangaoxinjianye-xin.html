<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新建蛋糕配方</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet">
    <style>
        /* --- 核心样式 (来自面包详情页) --- */
        :root {
            --font-scale: 1;
            --base-font-size: 15px;
            --amount-font-size: 16px;
            --percent-font-size: 12px;
            --step-font-size: 14px;
        }

        /* Dynamic Font Sizing Rules */
        .ingredient-name, 
        .sop-card p,
        .sop-card .font-medium, 
        .sop-card .font-bold,
        .clean-input
        {
            font-size: calc(var(--base-font-size) * var(--text-font-scale, var(--font-scale))) !important;
            line-height: 1.5;
        }

        .group-title {
            font-size: calc(var(--base-font-size) * 1.2 * var(--text-font-scale, var(--font-scale))) !important;
            line-height: 1.5;
        }
        
        .amount-display,
        .amount-input,
        #totalWeight,
        #totalCost
        {
            font-size: calc(var(--amount-font-size) * var(--number-font-scale, var(--font-scale))) !important;
        }
        
        .ingredient-percent {
            font-size: calc(var(--percent-font-size) * var(--number-font-scale, var(--font-scale))) !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* 标签样式 */
        .tag-badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 500;
            margin-right: 8px;
            transition: all 0.2s ease;
        }
        .tag-primary { background: #fff7ed; color: #ea580c; border: 1px solid rgba(234, 88, 12, 0.1); }
        .dark .tag-primary { background: rgba(234, 88, 12, 0.15); color: #fb923c; border: none; }
        .tag-gray { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }
        .dark .tag-gray { background: #334155; color: #cbd5e1; border: none; }

        /* Tab样式 */
        .tab-group {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 16px;
            margin-bottom: 24px;
        }
        .dark .tab-group { background: #1e293b; }
        
        .tab-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            border-radius: 12px;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid transparent;
        }
        .dark .tab-item { color: #94a3b8; }

        .tab-item.active {
            background: white;
            color: #ea580c;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border-color: rgba(0,0,0,0.02);
        }
        .dark .tab-item.active {
            background: #334155;
            color: #fb923c;
        }
        
        .tab-item i { margin-right: 6px; font-size: 14px; }

        /* 卡片与列表 */
        .ingredient-group-card {
            background: white;
            border-radius: 16px;
            padding: 0;
            margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .dark .ingredient-group-card {
            background: #1e293b;
            border-color: #334155;
            box-shadow: none;
        }

        .group-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #ffffff !important;
            border-bottom: 1px solid #f1f5f9;
            justify-content: space-between;
        }
        .dark .group-header {
            background: #0f172a !important;
            border-color: #334155;
        }

        .group-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 13px;
        }
        .group-title {
            font-weight: 600;
            font-size: 16px;
            color: #1e293b;
            letter-spacing: -0.01em;
        }
        .dark .group-title { color: #f1f5f9; }

        /* 分组颜色 - 适配蛋糕 */
        .group-main .group-icon { background: #fff7ed; color: #c2410c; }
        .dark .group-main .group-icon { background: rgba(154, 52, 18, 0.2); color: #fdba74; }
        
        .group-wet .group-icon { background: #eff6ff; color: #1d4ed8; }
        .dark .group-wet .group-icon { background: rgba(29, 78, 216, 0.2); color: #93c5fd; }
        
        .group-aux .group-icon { background: #fefce8; color: #a16207; }
        .dark .group-aux .group-icon { background: rgba(161, 98, 7, 0.2); color: #fde047; }

        /* 列表行与输入 */
        .list-row {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #f8fafc;
            transition: background-color 0.2s;
            position: relative;
            background: white;
        }
        .dark .list-row { 
            border-bottom-color: #334155; 
            background: #1e293b;
        }
        .list-row:last-child { border-bottom: none; }
        .list-row:hover { background-color: #f8fafc; }
        .dark .list-row:hover { background-color: #334155; }

        .clean-input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
            color: inherit;
            font-weight: 500;
            font-size: 15px;
        }
        .clean-input::placeholder { color: #94a3b8; font-weight: normal; }
        .clean-input:focus { 
            border-bottom: 1px solid #ea580c; 
            border-radius: 0; 
        }

        .amount-input {
            background: transparent;
            border: none;
            outline: none;
            text-align: right;
            color: inherit;
            font-weight: normal;
        }
        .amount-input::placeholder { color: #cbd5e1; }
        .amount-input:focus { border-bottom: 1px solid #ea580c; border-radius: 0; }

        /* 功能样式 */
        .tutorial-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; display: none;
        }
        .tutorial-overlay.active { display: block; }
        .tutorial-highlight {
            position: absolute; 
            border: 2px solid #ea580c; 
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75); 
            z-index: 10000;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            pointer-events: none;
        }
        .tutorial-popup {
            position: absolute; 
            background: white; 
            border-radius: 16px; 
            padding: 24px;
            z-index: 10001; 
            width: 280px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            opacity: 0;
            transform: translateY(10px);
        }
        .tutorial-popup.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .dark .tutorial-popup { background: #1E293B; color: #F1F5F9; border: 1px solid #334155; }
        
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.4), 0 0 0 9999px rgba(0, 0, 0, 0.75); }
            70% { box-shadow: 0 0 0 10px rgba(234, 88, 12, 0), 0 0 0 9999px rgba(0, 0, 0, 0.75); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0), 0 0 0 9999px rgba(0, 0, 0, 0.75); }
        }
        .tutorial-highlight.active {
            animation: pulse-border 2s infinite;
        }
        
        /* 拖拽与滑动删除 */
        .ingredient-item { touch-action: pan-y; overflow: hidden; }
        .ingredient-item .delete-action {
            position: absolute; right: -80px; top: 0; bottom: 0; width: 80px;
            background: #ef4444; color: white; display: flex; align-items: center;
            justify-content: center; transition: all 0.2s ease; cursor: pointer;
            z-index: 10;
        }
        .ingredient-item[data-open="true"] .delete-action { right: 0; }
        .ingredient-item[data-open="true"] .list-content { transform: translateX(-80px); }
        .list-content {
            display: flex; align-items: center; width: 100%; transition: transform 0.2s ease;
        }

        /* 同步状态 */
        .sync-status-text {
            font-size: 10px; padding: 1px 4px; border-radius: 4px; margin-top: 2px; display: inline-block;
        }
        .synced-text { color: #16a34a; background: #dcfce7; }
        .not-synced-text { color: #ea580c; background: #ffedd5; }
        .dark .synced-text { background: rgba(22, 163, 74, 0.2); }
        .dark .not-synced-text { background: rgba(234, 88, 12, 0.2); }

        /* 图片裁剪 */
        .crop-container { max-width: 100%; max-height: 400px; }
        .crop-preview { width: 120px; height: 120px; border-radius: 12px; overflow: hidden; }

        .step-images {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        .step-images img {
            width: 100%;
            height: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .dashed-border {
            border: 1px dashed #e2e8f0;
        }
        .dark .dashed-border { border-color: #475569; }

        .unit-text {
            font-size: 12px !important;
            font-weight: normal !important;
            margin-left: 2px;
            vertical-align: baseline;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-[#f7f7f5] dark:bg-[#0f172a] min-h-screen">

    <!-- 沉浸式头部 (Hero Header) -->
    <header class="relative w-full h-72 bg-gray-200 group">
        <!-- 封面图/上传触发 -->
        <div class="w-full h-full relative cursor-pointer" onclick="document.getElementById('coverImage').click()">
            <img src="https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=1200&h=800&fit=crop&q=90" 
                 id="heroImage" 
                 class="w-full h-full object-cover transition-transform duration-700 ease-out">
            <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-black/60"></div>
            <!-- 上传提示 (无图或Hover时显示) -->
            <div class="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity">
                <div class="text-white text-center backdrop-blur-sm bg-black/30 p-3 rounded-xl">
                    <i class="fas fa-camera text-2xl mb-1"></i>
                    <div class="text-sm font-medium">更换封面</div>
                </div>
            </div>
        </div>
        <input type="file" id="coverImage" class="hidden" accept="image/*">

        <!-- 顶部浮动按钮 -->
        <button onclick="window.location.href='../../../ERPSHOUJI/shouye/shouye-mobile.html'" class="absolute top-4 left-4 w-10 h-10 bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black/50 transition-colors z-20">
            <i class="fas fa-arrow-left"></i>
        </button>

        <div class="absolute top-4 right-4 flex space-x-3 z-20">
            <button onclick="startTutorial()" class="w-10 h-10 bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black/50 transition-colors" title="新手引导">
                <i class="fas fa-info"></i>
            </button>
            <button onclick="openCamera()" class="w-10 h-10 bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black/50 transition-colors" title="拍照识别">
                <i class="fas fa-camera-retro"></i>
            </button>
        </div>
    </header>

    <!-- 主要内容区 (重叠式设计) -->
    <main class="px-5 -mt-6 relative bg-white dark:bg-[#0f172a] rounded-t-3xl z-10 pt-6 min-h-[calc(100vh-280px)]">
        
        <!-- 标题与分类 (可编辑) -->
        <div id="recipe-meta-section" class="mb-6">
            <div class="mb-3">
                <input type="text" id="recipeNameInput" placeholder="请输入蛋糕名称" class="w-full text-2xl font-bold tracking-tight text-gray-900 dark:text-white bg-transparent border-b border-transparent focus:border-orange-500 outline-none pb-1 placeholder-gray-300 transition-colors" value="新建蛋糕配方">
            </div>
            <div class="flex flex-wrap gap-2 items-center justify-between">
                <div class="relative">
                    <select id="categorySelect" onchange="handleCategoryChange(this)" class="tag-badge bg-orange-50 text-orange-600 border border-orange-100 dark:bg-orange-900/20 dark:text-orange-400 dark:border-none outline-none appearance-none pr-8 cursor-pointer shadow-sm">
                        <option value="">选择分类</option>
                        <option value="cake" selected>蛋糕类</option>
                        <option value="bread">面包类</option>
                        <option value="drink">饮品类</option>
                        <option value="other">其他类别</option>
                        <option value="new_category" class="font-bold text-orange-500 bg-orange-50">+ 新建分类</option>
                    </select>
                    <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-orange-400 pointer-events-none"></i>
                </div>
                
                <!-- 模式切换开关 -->
                <button id="modeToggleBtn" class="tag-badge bg-orange-50 text-orange-600 border border-orange-200 dark:bg-orange-900/20 dark:text-orange-400 dark:border-none transition-colors" onclick="toggleInputMode()">
                    <i class="fas fa-box-open mr-1"></i> <span>关联库存</span>
                </button>
            </div>
        </div>

        <!-- 标签切换 (无SOP) -->
        <div class="tab-group" id="tabGroup">
            <div class="tab-item active" id="tab-btn-recipe" onclick="switchTab('recipe')">
                <i class="fas fa-birthday-cake"></i> 配方
            </div>
            <div class="tab-item" id="tab-btn-step" onclick="switchTab('step')">
                <i class="fas fa-list-ol"></i> 步骤
            </div>
        </div>

        <!-- 配方内容区 -->
        <div id="recipe-section" class="pb-24">
            <!-- 动态生成的分组容器 -->
            
            <!-- 步骤一 -->
            <div class="ingredient-group-card group-main">
                <div class="group-header">
                    <div class="flex items-center">
                        <div class="group-icon"><i class="fas fa-cheese"></i></div>
                        <input type="text" class="group-title bg-transparent border-b border-transparent focus:border-orange-500 outline-none w-40 transition-colors placeholder-gray-400 font-bold" value="步骤一" placeholder="输入分组名称" onclick="this.select()">
                    </div>
                    <button class="text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/20 px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-orange-100 transition" onclick="addIngredient('main')">
                        <i class="fas fa-plus mr-1"></i>添加
                    </button>
                </div>
                <div id="mainIngredients" class="space-y-0"></div>
            </div>

            <!-- 步骤二 -->
            <div class="ingredient-group-card group-wet">
                <div class="group-header">
                    <div class="flex items-center">
                        <div class="group-icon"><i class="fas fa-tint"></i></div>
                        <input type="text" class="group-title bg-transparent border-b border-transparent focus:border-orange-500 outline-none w-40 transition-colors placeholder-gray-400 font-bold" value="步骤二" placeholder="输入分组名称" onclick="this.select()">
                    </div>
                    <button class="text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-blue-100 transition" onclick="addIngredient('wet')">
                        <i class="fas fa-plus mr-1"></i>添加
                    </button>
                </div>
                <div id="wetIngredients" class="space-y-0"></div>
            </div>

            <!-- 变化款添加按钮 -->
            <button id="addVariationGroupBtn" class="w-full py-3 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-xl text-gray-500 hover:border-orange-500 hover:text-orange-500 transition flex items-center justify-center font-medium" onclick="createVariationGroup()">
                <i class="fas fa-plus-circle mr-2"></i> 添加变化款
            </button>
        </div>

        <!-- Step Section -->
        <div id="step-section" class="hidden pb-24">
            <div id="stepsList" class="space-y-4"></div>
            <button class="w-full mt-4 py-3 bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 rounded-xl font-medium flex items-center justify-center hover:bg-orange-100 transition" onclick="addStep()">
                <i class="fas fa-plus mr-2"></i> 添加制作步骤
            </button>
        </div>
    </main>

    <!-- 底部固定栏 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-[#1e293b] border-t border-gray-100 dark:border-slate-700 p-4 z-50 flex items-center justify-between shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="flex items-center gap-4">
            <div>
                <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">总成本</div>
                <div class="flex items-baseline gap-1">
                    <span class="text-xl font-bold text-orange-600 dark:text-orange-400 leading-none" id="totalCost">0.00</span>
                    <span class="text-xs text-orange-600 dark:text-orange-400 font-medium">¥</span>
                </div>
            </div>
            <div class="h-8 w-px bg-gray-200 dark:bg-slate-600"></div>
            <div>
                <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">总重量</div>
                <div class="text-lg font-bold text-gray-800 dark:text-white leading-none"><span id="totalWeight">0</span><span class="text-xs font-normal ml-0.5 text-gray-400">g</span></div>
            </div>
        </div>
        <button id="saveBtn" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-orange-500/30 active:scale-95 transition-transform">
            保存配方
        </button>
    </div>

    <!-- 模态框 (保持功能但更新样式) -->
    <!-- 材料搜索 -->
    <div id="material-popup" class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col h-[80vh]">
            <!-- Header -->
            <div class="p-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center bg-white dark:bg-[#1e293b] z-10">
                <h3 class="font-bold text-lg text-gray-800 dark:text-white">选择配料</h3>
                <button onclick="closeMaterialSearch()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-700 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- Search Bar -->
            <div class="p-4 bg-gray-50 dark:bg-slate-800/50">
                <div class="relative flex gap-2">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="custom-material-input" placeholder="搜索材料..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border-none outline-none bg-white dark:bg-slate-700 shadow-sm" oninput="filterMaterialAndRecipes(this.value)">
                    </div>
                    <button id="external-new-material-btn" onclick="window.location.href='/Users/tobias/Desktop/yuanixngtu/ERPSHOUJI/cailiao/cailiao-xinjianye.html?from=recipe_creation'" class="hidden px-3 py-2 bg-orange-50 text-orange-600 rounded-xl text-sm font-medium hover:bg-orange-100 whitespace-nowrap transition-colors border border-orange-100 dark:border-none dark:bg-orange-900/20 dark:text-orange-400">
                        <i class="fas fa-plus mr-1"></i>新建材料
                    </button>
                </div>
            </div>

            <!-- Content Area (Sidebar + List) -->
            <div class="flex flex-1 overflow-hidden relative">
                <!-- Sidebar (Categories) -->
                <div class="w-24 bg-gray-50 dark:bg-slate-800 overflow-y-auto border-r border-gray-100 dark:border-slate-700 flex-shrink-0" id="material-category-list">
                    <!-- Categories injected by JS -->
                </div>
                
                <!-- Main List -->
                <div class="flex-1 overflow-y-auto bg-white dark:bg-[#1e293b] relative" id="material-popup-list">
                    <!-- Items injected by JS -->
                </div>
            </div>

            <!-- Bottom Tabs -->
            <div class="flex border-t border-gray-100 dark:border-slate-700 bg-white dark:bg-[#1e293b]">
                <button id="materials-tab" class="flex-1 py-3 text-sm font-medium text-orange-600 border-t-2 border-orange-600 bg-orange-50/50 dark:bg-orange-900/10 transition-colors" onclick="switchMaterialTab('materials')">
                    <i class="fas fa-cubes mr-1"></i> 材料库
                </button>
                <button id="recipes-tab" class="flex-1 py-3 text-sm font-medium text-gray-500 border-t-2 border-transparent hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors" onclick="switchMaterialTab('recipes')">
                    <i class="fas fa-book-open mr-1"></i> 引用配方
                </button>
            </div>
        </div>
    </div>

    <!-- 单位选择 -->
    <div id="unit-selector-popup" class="fixed inset-0 z-50 bg-black/30 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-[#1e293b] p-4 rounded-xl shadow-xl min-w-[200px]">
            <div class="font-bold mb-3 text-center text-gray-800 dark:text-white">选择单位</div>
            <div id="unit-selector-list" class="grid grid-cols-3 gap-2 mb-3"></div>
            <button onclick="closeUnitSelector()" class="w-full py-2 bg-gray-100 dark:bg-slate-700 rounded-lg text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-200 transition">取消</button>
        </div>
    </div>

    <!-- 裁剪弹窗 -->
    <div id="cropModal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-lg rounded-2xl p-4">
            <div class="crop-container mb-4 bg-black rounded-lg overflow-hidden flex justify-center items-center h-64">
                <img id="cropImage" class="max-w-full max-h-full">
            </div>
            <div class="flex gap-3">
                <button onclick="closeCropModal()" class="flex-1 py-2 bg-gray-100 dark:bg-slate-700 rounded-lg text-gray-600 dark:text-gray-300">取消</button>
                <button onclick="confirmCrop()" class="flex-1 py-2 bg-orange-500 text-white rounded-lg">确认裁剪</button>
            </div>
        </div>
    </div>

    <!-- 百分比编辑弹窗 -->
    <div id="percentEditModal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-xs rounded-2xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center text-gray-800 dark:text-white">修改百分比</h3>
            <div class="relative mb-6">
                <input id="percentInput" type="number" class="w-full text-center text-3xl font-bold text-orange-600 bg-transparent border-b-2 border-orange-100 focus:border-orange-500 outline-none pb-2" placeholder="0">
                <span class="absolute right-4 bottom-3 text-gray-400 font-bold">%</span>
            </div>
            <div class="flex gap-3">
                <button onclick="closePercentModal()" class="flex-1 py-2.5 bg-gray-100 dark:bg-slate-700 rounded-xl text-gray-600 dark:text-gray-300">取消</button>
                <button onclick="confirmPercentChange()" class="flex-1 py-2.5 bg-orange-500 text-white rounded-xl font-medium shadow-lg shadow-orange-500/30">确认</button>
            </div>
        </div>
    </div>

    <!-- 引导 & 其他辅助元素 (Overlay) -->
    <div id="tutorialOverlay" class="tutorial-overlay">
        <div id="tutorialHighlight" class="tutorial-highlight active"></div>
        <div id="tutorialPopup" class="tutorial-popup">
            <div class="flex justify-between items-start mb-4">
                <h3 id="tutorialTitle" class="font-bold text-lg text-gray-900 dark:text-white leading-tight"></h3>
                <span id="tutorialStepIndicator" class="text-xs font-medium text-orange-500 bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded-full whitespace-nowrap ml-2"></span>
            </div>
            
            <p id="tutorialContent" class="text-sm text-gray-600 dark:text-gray-300 mb-6 leading-relaxed"></p>
            
            <div class="flex gap-3">
                <button id="tutorialPrevBtn" class="px-4 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white transition-colors" onclick="previousTutorialStep()">上一步</button>
                <button id="tutorialNextBtn" class="flex-1 px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white text-sm font-bold rounded-xl shadow-lg shadow-orange-500/30 hover:shadow-orange-500/40 active:scale-95 transition-all" onclick="nextTutorialStep()">下一步</button>
                <button id="tutorialFinishBtn" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-sm font-bold rounded-xl shadow-lg shadow-green-500/30 hover:shadow-green-500/40 active:scale-95 transition-all hidden" onclick="endTutorial()">开始使用</button>
            </div>
            
            <button class="absolute top-0 right-0 p-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" onclick="endTutorial()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // --- 核心数据 ---
        const savedRecipes = {
            '戚风蛋糕': { category: '蛋糕类', ingredients: [{name:'低筋面粉',amount:100,unit:'g'},{name:'鸡蛋',amount:5,unit:'个'},{name:'牛奶',amount:50,unit:'ml'}] },
            '海绵蛋糕': { category: '蛋糕类', ingredients: [{name:'低筋面粉',amount:120,unit:'g'},{name:'鸡蛋',amount:4,unit:'个'},{name:'黄油',amount:30,unit:'g'}] }
        };
        
        const materialPrices = {
            '低筋面粉': { price: 0.9, units: ['g','kg'], category: '粉类', spec: '25kg', packPrice: 225 },
            '高筋面粉': { price: 0.8, units: ['g','kg'], category: '粉类', spec: '25kg', packPrice: 200 },
            '牛奶': { price: 1.2, units: ['ml','L'], category: '液体类', spec: '1L', packPrice: 12 },
            '鸡蛋': { price: 1.5, units: ['g','个'], category: '液体类', spec: '30个', packPrice: 45 },
            '白砂糖': { price: 0.6, units: ['g','kg'], category: '辅料', spec: '5kg', packPrice: 30 },
            '黄油': { price: 8.0, units: ['g','kg'], category: '油脂类', spec: '25kg', packPrice: 2000 },
            '淡奶油': { price: 3.5, units: ['ml','L'], category: '液体类', spec: '1L', packPrice: 35 },
            '可可粉': { price: 6.0, units: ['g','kg'], category: '粉类', spec: '1kg', packPrice: 60 },
        };
        
        const materialCategories = ['粉类', '液体类', '油脂类', '辅料', '其他'];
        const standardUnits = ['g', 'ml', 'kg', 'L', '个', 'tsp', 'tbsp'];

        // --- 全局状态 ---
        let currentEditingInput = null;
        let currentEditingUnitBtn = null;
        let cropper = null;
        let currentEditingPercentField = null; 
        let isLibraryMode = true; 

        // --- 核心渲染函数 ---

        // 添加原料行
        function addIngredient(type) {
            let container = null;
            if(type === 'main') container = document.getElementById('mainIngredients');
            else if(type === 'wet') container = document.getElementById('wetIngredients');
            else if(type.startsWith('base')) container = document.getElementById(type + 'Ingredients');
            
            if(!container) return; // Error handling

            let nameValue = '';
            let nameReadOnly = false;
            // 基础面团和变化款面团的第一行默认值
            if((type.startsWith('base')) && container.children.length===0) {
                nameValue = '基础蛋糕体';
                nameReadOnly = true;
            }

            // Determine percentage field style
            let percentClass = 'percent-field text-[10px] text-orange-500/70 font-medium cursor-pointer hover:text-orange-600 hover:bg-orange-50 px-1 rounded transition-all';
            let percentAttrs = 'onclick="editPercent(this)" title="点击修改百分比"';

            // Main group usually has the 100% base
            if (type === 'main' || type.startsWith('base')) {
                // percentClass = 'percent-field text-[10px] text-gray-400 font-medium px-1';
                // percentAttrs = '';
                // 蛋糕逻辑：允许修改所有百分比，或者第一项自动100%? 暂时保持灵活
            }

            const div = document.createElement('div');
            div.className = 'list-row ingredient-item group relative overflow-hidden';
            div.setAttribute('data-open', 'false');
            
            div.innerHTML = `
                <div class="list-content w-full flex items-center">
                    <div class="drag-handle text-gray-300 mr-2 cursor-grab active:cursor-grabbing hover:text-orange-500 transition-colors flex items-center justify-center w-6 py-2">
                        <i class="fas fa-grip-vertical text-xs"></i>
                    </div>
                    
                    <div class="flex-1 relative mr-2">
                        <input type="text" class="clean-input name-input ${nameReadOnly?'text-gray-500 cursor-not-allowed':''}" 
                               placeholder="材料名称" value="${nameValue}" 
                               ${nameReadOnly?'readonly':''} 
                               onclick="handleInputClick(this)"
                               oninput="updateAutoFields(this)"
                               readonly> 
                        <div class="sync-status-text synced-text hidden">已同步</div>
                        <div class="sync-status-text not-synced-text hidden">未同步</div>
                    </div>

                    <div class="flex items-center justify-end gap-2">
                        <input type="number" class="amount-input w-20" placeholder="0" oninput="updateAutoFields(this)">
                        <button class="unit-btn text-xs font-medium bg-gray-100 text-gray-600 dark:bg-slate-700 dark:text-gray-300 px-2 h-7 min-w-[32px] rounded-lg flex items-center justify-center hover:bg-orange-100 hover:text-orange-600 dark:hover:bg-slate-600 transition" onclick="showUnitSelector(this)">g <i class="fas fa-caret-down ml-1 text-[10px] opacity-50"></i></button>
                    </div>

                    <div class="text-right min-w-[50px] ml-2">
                        <div class="cost-field text-xs font-medium text-gray-400">¥0.00</div>
                        <div class="${percentClass}" ${percentAttrs}>0%</div>
                    </div>
                </div>

                <!-- 滑动删除按钮 -->
                <div class="delete-action" onclick="deleteIngredientItem(this)">
                    <i class="fas fa-trash-alt text-lg"></i>
                </div>
            `;
            
            container.appendChild(div);
            initSwipeDelete(div);
            
            if(container.sortable) container.sortable.destroy();
            container.sortable = new Sortable(container, { 
                group: 'ingredients', 
                handle: '.drag-handle', 
                animation: 150, 
                ghostClass: 'bg-gray-50',
                onEnd: updateAllAutoFields 
            });
            
            const input = div.querySelector('.name-input');
            if(input) {
                if(nameReadOnly) {
                    input.readOnly = true;
                } else {
                    input.readOnly = isLibraryMode; 
                }
            }
        }

        function toggleInputMode() {
            isLibraryMode = !isLibraryMode;
            const btn = document.getElementById('modeToggleBtn');
            const span = btn.querySelector('span');
            const icon = btn.querySelector('i');
            
            if(isLibraryMode) {
                btn.classList.remove('bg-gray-100', 'text-gray-500', 'border-gray-200');
                btn.classList.add('bg-orange-50', 'text-orange-600', 'border-orange-200');
                span.innerText = '关联库存';
                icon.className = 'fas fa-box-open mr-1';
            } else {
                btn.classList.add('bg-gray-100', 'text-gray-500', 'border-gray-200');
                btn.classList.remove('bg-orange-50', 'text-orange-600', 'border-orange-200');
                span.innerText = '自由录入';
                icon.className = 'fas fa-edit mr-1';
            }
            
            document.querySelectorAll('.name-input').forEach(input => {
                if(input.value === '基础蛋糕体' || input.value === '变化款面团') return;
                input.readOnly = isLibraryMode;
            });
        }
        
        function handleInputClick(input) {
            if(input.value === '基础蛋糕体' || input.value === '变化款面团') return;
            if(isLibraryMode) showMaterialSearch(input);
        }

        function createVariationGroup() {
            const timestamp = Date.now();
            const type = `base_variation_${timestamp}`;
            const containerId = `${type}Ingredients`;
            
            const btn = document.getElementById('addVariationGroupBtn');
            const wrapper = document.createElement('div');
            wrapper.className = 'ingredient-group-card border-l-4 border-l-orange-500 relative group/card';
            
            wrapper.innerHTML = `
                <div class="group-header">
                    <div class="flex items-center">
                        <div class="group-icon bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400">
                            <i class="fas fa-birthday-cake"></i>
                        </div>
                        <input type="text" class="group-title bg-transparent border-b border-transparent focus:border-orange-500 outline-none w-40 transition-colors placeholder-gray-400" value="变化款蛋糕" placeholder="输入分组名称" onclick="this.select()">
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/20 px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-orange-100 transition" onclick="addIngredient('${type}')">
                            <i class="fas fa-plus mr-1"></i>添加
                        </button>
                    </div>
                </div>
                <div id="${containerId}" class="space-y-0"></div>
            `;
            
            btn.parentNode.insertBefore(wrapper, btn);
            addIngredient(type);
        }

        // --- 逻辑功能 ---

        function updateAutoFields(input) {
            const row = input.closest('.list-row');
            const qtyInput = row.querySelector('input[type="number"]');
            const nameInput = row.querySelector('.name-input');
            const costField = row.querySelector('.cost-field');
            const unitBtn = row.querySelector('.unit-btn');

            const qty = parseFloat(qtyInput.value) || 0;
            const unit = unitBtn.innerText.trim();
            const name = nameInput.value.trim();

            let cost = 0;
            if (materialPrices[name]) {
                const priceInfo = materialPrices[name];
                let weightInG = qty;
                if(unit === 'kg') weightInG = qty * 1000;
                cost = (weightInG / 100) * priceInfo.price;
            }
            costField.innerText = '¥' + cost.toFixed(2);

            updateTotalWeight();
            updatePercentages();
        }
        
        function updateAllAutoFields() {
            document.querySelectorAll('.ingredient-item').forEach(row => {
                const input = row.querySelector('input[type="number"]');
                if(input) updateAutoFields(input);
            });
        }

        function updateTotalWeight() {
            let total = 0;
            let totalCost = 0;
            document.querySelectorAll('.ingredient-item').forEach(row => {
                const qtyInput = row.querySelector('input[type="number"]');
                const costField = row.querySelector('.cost-field');
                const unitBtn = row.querySelector('.unit-btn');
                
                if (qtyInput) {
                    let qty = parseFloat(qtyInput.value) || 0;
                    if(unitBtn.innerText.trim() === 'kg') qty *= 1000; 
                    total += qty;
                }
                if (costField) {
                    totalCost += parseFloat(costField.innerText.replace('¥','')) || 0;
                }
            });
            document.getElementById('totalWeight').textContent = total.toFixed(0);
            document.getElementById('totalCost').textContent = totalCost.toFixed(2);
        }

        function updatePercentages() {
            // 蛋糕逻辑：以主料组(Main)的总重作为100% (Baker's %)
            // 如果主料组为空，则尝试以总重量为100%? 或者第一项为100%
            
            let baseTotal = 0;
            const mainContainer = document.getElementById('mainIngredients');
            if(mainContainer) {
                mainContainer.querySelectorAll('.ingredient-item').forEach(row => {
                    const qtyInput = row.querySelector('input[type="number"]');
                    const unitBtn = row.querySelector('.unit-btn');
                    if(qtyInput) {
                        let qty = parseFloat(qtyInput.value) || 0;
                        if(unitBtn && unitBtn.innerText.trim() === 'kg') qty *= 1000;
                        baseTotal += qty;
                    }
                });
            }

            const standardGroupIds = ['mainIngredients', 'wetIngredients', 'auxIngredients'];
            standardGroupIds.forEach(id => {
                const container = document.getElementById(id);
                if(!container) return;
                
                container.querySelectorAll('.ingredient-item').forEach(row => {
                     const qtyInput = row.querySelector('input[type="number"]');
                     const percentField = row.querySelector('.percent-field');
                     const unitBtn = row.querySelector('.unit-btn');
                     
                     if(qtyInput && percentField) {
                         if (baseTotal > 0) {
                             let qty = parseFloat(qtyInput.value) || 0;
                             if(unitBtn.innerText.trim() === 'kg') qty *= 1000;
                             const pct = (qty / baseTotal * 100).toFixed(1);
                             percentField.innerText = pct + '%';
                         } else {
                             percentField.innerText = '0%';
                         }
                     }
                });
            });

            // 变化款组逻辑：自包含
            document.querySelectorAll('.ingredient-group-card').forEach(card => {
                const container = card.querySelector('[id$="Ingredients"]');
                if(!container) return;
                const containerId = container.id;
                if(standardGroupIds.includes(containerId)) return;
                
                const rows = container.querySelectorAll('.ingredient-item');
                if(rows.length === 0) return;
                
                let groupBaseWeight = 0;
                const firstRow = rows[0];
                const firstQtyInput = firstRow.querySelector('input[type="number"]');
                const firstUnitBtn = firstRow.querySelector('.unit-btn');
                
                if(firstQtyInput) {
                     groupBaseWeight = parseFloat(firstQtyInput.value) || 0;
                     if(firstUnitBtn && firstUnitBtn.innerText.trim() === 'kg') groupBaseWeight *= 1000;
                }
                
                rows.forEach(row => {
                     const qtyInput = row.querySelector('input[type="number"]');
                     const percentField = row.querySelector('.percent-field');
                     const unitBtn = row.querySelector('.unit-btn');
                     
                     if(qtyInput && percentField) {
                         if (groupBaseWeight > 0) {
                             let qty = parseFloat(qtyInput.value) || 0;
                             if(unitBtn.innerText.trim() === 'kg') qty *= 1000;
                             const pct = (qty / groupBaseWeight * 100).toFixed(1);
                             percentField.innerText = pct + '%';
                         } else {
                             percentField.innerText = '0%';
                         }
                     }
                });
            });
        }

        function editPercent(el) {
            // 蛋糕允许修改百分比反算，但逻辑复杂，暂时保留UI
            currentEditingPercentField = el;
            const currentVal = parseFloat(el.innerText) || 0;
            document.getElementById('percentInput').value = currentVal;
            document.getElementById('percentEditModal').classList.remove('hidden');
            document.getElementById('percentInput').focus();
        }
        
        function closePercentModal() {
            document.getElementById('percentEditModal').classList.add('hidden');
            currentEditingPercentField = null;
        }
        
        function confirmPercentChange() {
            if(!currentEditingPercentField) return;
            const newPercent = parseFloat(document.getElementById('percentInput').value);
            // 简单反算逻辑：假设 Base Total 不变，计算当前项的重量
            // ... (Full implementation omitted for brevity but structure is here)
            closePercentModal();
        }

        // --- 辅助功能 (Tab, Modal, Swipe) ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-btn-${tab}`).classList.add('active');
            
            document.getElementById('recipe-section').classList.add('hidden');
            document.getElementById('step-section').classList.add('hidden');
            document.getElementById(`${tab}-section`).classList.remove('hidden');
        }

        // Material Search Logic (Same as Bread)
        function showMaterialSearch(input) {
            currentEditingInput = input;
            document.getElementById('material-popup').classList.remove('hidden');
            
            // Check active tab and set initial state of new button
            const isRecipeTab = document.getElementById('recipes-tab').classList.contains('text-orange-600');
            switchMaterialTab(isRecipeTab ? 'recipes' : 'materials');
        }
        
        function closeMaterialSearch() {
            document.getElementById('material-popup').classList.add('hidden');
        }
        
        function renderMaterialCategories() {
            const list = document.getElementById('material-category-list');
            list.innerHTML = '';
            materialCategories.forEach(c => {
                const div = document.createElement('div');
                div.className = 'p-3 text-xs font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 cursor-pointer text-center';
                div.innerText = c;
                div.onclick = () => filterMaterials(c);
                list.appendChild(div);
            });
        }
        
        function renderMaterialItems() {
             const list = document.getElementById('material-popup-list');
             list.innerHTML = '';
             Object.keys(materialPrices).forEach(name => {
                 const div = document.createElement('div');
                 div.className = 'p-4 border-b border-gray-50 hover:bg-gray-50 dark:hover:bg-slate-800 cursor-pointer flex justify-between items-center';
                 div.innerHTML = `<span class="font-medium text-gray-800 dark:text-white">${name}</span><span class="text-xs text-orange-500">¥${materialPrices[name].price}/100g</span>`;
                 div.onclick = () => selectMaterial(name);
                 list.appendChild(div);
             });
        }
        
        function selectMaterial(name) {
            if(currentEditingInput) {
                currentEditingInput.value = name;
                updateAutoFields(currentEditingInput);
                
                // Add sync status effect
                const row = currentEditingInput.closest('.list-row');
                const syncText = row.querySelector('.synced-text');
                if(syncText) {
                    syncText.classList.remove('hidden');
                    setTimeout(() => syncText.classList.add('hidden'), 2000);
                }
            }
            closeMaterialSearch();
        }

        // --- Recipe Reference Logic ---
        function switchMaterialTab(tab) {
            const materialsTab = document.getElementById('materials-tab');
            const recipesTab = document.getElementById('recipes-tab');
            const catList = document.getElementById('material-category-list');
            const itemList = document.getElementById('material-popup-list');
            const newBtn = document.getElementById('external-new-material-btn');

            if (tab === 'materials') {
                materialsTab.classList.add('text-orange-600', 'border-orange-600', 'bg-orange-50/50', 'dark:bg-orange-900/10');
                materialsTab.classList.remove('text-gray-500', 'border-transparent', 'hover:bg-gray-50', 'dark:hover:bg-slate-800');
                
                recipesTab.classList.remove('text-orange-600', 'border-orange-600', 'bg-orange-50/50', 'dark:bg-orange-900/10');
                recipesTab.classList.add('text-gray-500', 'border-transparent', 'hover:bg-gray-50', 'dark:hover:bg-slate-800');

                if(newBtn) newBtn.classList.remove('hidden');

                renderMaterialCategories();
                renderMaterialItems();
            } else {
                recipesTab.classList.add('text-orange-600', 'border-orange-600', 'bg-orange-50/50', 'dark:bg-orange-900/10');
                recipesTab.classList.remove('text-gray-500', 'border-transparent', 'hover:bg-gray-50', 'dark:hover:bg-slate-800');
                
                materialsTab.classList.remove('text-orange-600', 'border-orange-600', 'bg-orange-50/50', 'dark:bg-orange-900/10');
                materialsTab.classList.add('text-gray-500', 'border-transparent', 'hover:bg-gray-50', 'dark:hover:bg-slate-800');

                if(newBtn) newBtn.classList.add('hidden');

                renderRecipeCategories();
                renderRecipeItems();
            }
        }

        function renderRecipeCategories() {
            const list = document.getElementById('material-category-list');
            list.innerHTML = '';
            
            const categories = [...new Set(Object.values(savedRecipes).map(r => r.category))];
            
            // All Recipes option
            const allDiv = document.createElement('div');
            allDiv.className = 'p-3 text-xs font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 cursor-pointer text-center';
            allDiv.innerText = '全部';
            allDiv.onclick = () => renderRecipeItems();
            list.appendChild(allDiv);

            categories.forEach(c => {
                const div = document.createElement('div');
                div.className = 'p-3 text-xs font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 cursor-pointer text-center';
                div.innerText = c;
                div.onclick = () => filterRecipes(c);
                list.appendChild(div);
            });
        }

        function renderRecipeItems(filterCategory = null) {
             const list = document.getElementById('material-popup-list');
             list.innerHTML = '';
             
             Object.entries(savedRecipes).forEach(([name, data]) => {
                 if (filterCategory && data.category !== filterCategory) return;
                 
                 const div = document.createElement('div');
                 div.className = 'p-4 border-b border-gray-50 hover:bg-gray-50 dark:hover:bg-slate-800 cursor-pointer flex justify-between items-center';
                 div.innerHTML = `
                    <div>
                        <div class="font-medium text-gray-800 dark:text-white">${name}</div>
                        <div class="text-[10px] text-gray-400">${data.ingredients.length} 种原料</div>
                    </div>
                    <span class="text-xs text-orange-500 bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded">引用</span>
                 `;
                 div.onclick = () => selectMaterial(name); // Treat recipe as a material name
                 list.appendChild(div);
             });
        }
        
        function filterRecipes(category) {
            renderRecipeItems(category);
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Default Ingredients
            addIngredient('main'); // Flour
            addIngredient('wet'); // Milk
        });

        // --- Swipe Delete Logic ---
        let touchStartX = 0;
        let currentSwipeItem = null;

        function initSwipeDelete(element) {
            element.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
                currentSwipeItem = element;
            }, {passive: true});

            element.addEventListener('touchmove', e => {
                if (!currentSwipeItem) return;
                const touchX = e.touches[0].clientX;
                const diff = touchStartX - touchX;
                
                if (diff > 40) { // Swipe Left
                    element.setAttribute('data-open', 'true');
                } else if (diff < -40) { // Swipe Right
                    element.setAttribute('data-open', 'false');
                }
            }, {passive: true});
        }
        
        function deleteIngredientItem(btn) {
            const row = btn.closest('.ingredient-item');
            const container = row.parentNode;
            row.remove();
            
            // 如果是变化款且删除了最后一条数据，自动删除整个分组
            if (container && container.children.length === 0) {
                if (container.id && container.id.startsWith('base_variation_')) {
                    const groupCard = container.closest('.ingredient-group-card');
                    if (groupCard) groupCard.remove();
                }
            }

            updateTotalWeight();
            updatePercentages();
        }

        // Unit Selector
        function showUnitSelector(btn) {
            currentEditingUnitBtn = btn;
            const list = document.getElementById('unit-selector-list');
            list.innerHTML = '';
            standardUnits.forEach(u => {
                const b = document.createElement('button');
                b.className = 'py-2 bg-gray-50 dark:bg-slate-700 rounded-lg text-sm hover:bg-orange-50 hover:text-orange-600 transition';
                b.innerText = u;
                b.onclick = () => {
                    currentEditingUnitBtn.innerHTML = `${u} <i class="fas fa-caret-down ml-1 text-[10px] opacity-50"></i>`;
                    document.getElementById('unit-selector-popup').classList.add('hidden');
                    updateAutoFields(currentEditingUnitBtn);
                };
                list.appendChild(b);
            });
            document.getElementById('unit-selector-popup').classList.remove('hidden');
        }
        function closeUnitSelector() {
            document.getElementById('unit-selector-popup').classList.add('hidden');
        }

        // 图片处理 (Cover Image)
        document.getElementById('coverImage').addEventListener('change', function(e){
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('cropImage').src = e.target.result;
                    document.getElementById('cropModal').classList.remove('hidden');
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(document.getElementById('cropImage'), { aspectRatio: 3/2, viewMode: 1 });
                };
                reader.readAsDataURL(file);
            }
        });
        function closeCropModal() { document.getElementById('cropModal').classList.add('hidden'); }
        function confirmCrop() {
            if(cropper) {
                const canvas = cropper.getCroppedCanvas();
                document.getElementById('heroImage').src = canvas.toDataURL();
                closeCropModal();
            }
        }

        // 步骤逻辑
        function addStep(data = null) {
            const list = document.getElementById('stepsList');
            const stepNum = list.children.length + 1;
            const div = document.createElement('div');
            div.className = 'ingredient-group-card p-4 group'; // Use generic card style
            
            const titlePlaceholder = data ? data.title : '步骤名称 (如:打发蛋白)';
            const contentPlaceholder = data ? data.content : '在此描述制作步骤细节...';
            
            div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2 flex-1">
                        <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-lg flex items-center justify-center text-sm font-bold">${stepNum}</div>
                        <input class="bg-transparent outline-none border-b border-transparent focus:border-orange-500 transition-colors w-full font-semibold" placeholder="${titlePlaceholder}">
                    </h3>
                    <div class="flex items-center gap-2">
                        <button onclick="this.closest('.ingredient-group-card').remove(); updateStepNumbers();" class="text-red-400 hover:text-red-600 p-1 opacity-0 group-hover:opacity-100 transition-opacity" title="删除步骤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <textarea class="w-full bg-gray-50 dark:bg-slate-800/50 p-3 rounded-xl border-none outline-none resize-none text-sm min-h-[80px] mb-3 text-gray-600 dark:text-gray-300" placeholder="${contentPlaceholder}"></textarea>
                    <div class="step-images grid grid-cols-4 gap-2">
                        <button class="aspect-square bg-gray-50 dark:bg-slate-800 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:text-orange-500 hover:bg-orange-50 dark:hover:bg-orange-900/20 border-2 border-dashed border-gray-200 dark:border-slate-600 transition-all" onclick="triggerStepImageUpload(this)">
                            <i class="fas fa-camera mb-1"></i>
                            <span class="text-[10px]">添加图片</span>
                        </button>
                    </div>
                    <input type="file" class="hidden" accept="image/*" onchange="handleStepImageUpload(this)">
                </div>
            `;
            list.appendChild(div);
        }

        function updateStepNumbers() {
            const list = document.getElementById('stepsList');
            Array.from(list.children).forEach((card, index) => {
                const numBadge = card.querySelector('.w-8.h-8');
                if(numBadge) numBadge.innerText = index + 1;
            });
        }

        function triggerStepImageUpload(btn) {
            const fileInput = btn.closest('.step-content').querySelector('input[type="file"]');
            fileInput.click();
        }

        function handleStepImageUpload(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'relative aspect-square group/img';
                    imgContainer.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">
                        <button onclick="this.closest('div').remove()" class="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-xs opacity-0 group-hover/img:opacity-100 transition-opacity">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    const btn = input.previousElementSibling.querySelector('button');
                    input.previousElementSibling.insertBefore(imgContainer, btn);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // 分类管理
        let lastSelectedCategory = 'cake'; // Default selected

        function handleCategoryChange(select) {
             if(select.value === 'new_category') {
                 document.getElementById('newCategoryModal').classList.remove('hidden');
                 document.getElementById('newCategoryName').value = '';
                 document.getElementById('newCategoryName').focus();
                 // Reset select to previous value until confirmed
                 select.value = lastSelectedCategory; 
             } else {
                 lastSelectedCategory = select.value;
             }
        }

        function closeNewCategoryModal() {
            document.getElementById('newCategoryModal').classList.add('hidden');
        }

        function confirmNewCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if(name) {
                const select = document.getElementById('categorySelect');
                // Check if already exists
                let exists = false;
                for(let i=0; i<select.options.length; i++) {
                    if(select.options[i].text === name) {
                        exists = true;
                        select.value = select.options[i].value;
                        lastSelectedCategory = select.value;
                        break;
                    }
                }
                
                if(!exists) {
                    const option = new Option(name, name);
                    // Insert before "New Category" option (last one)
                    select.add(option, select.length - 1);
                    select.value = name;
                    lastSelectedCategory = name;
                }
                closeNewCategoryModal();
            } else {
                alert('请输入分类名称');
            }
        }
        
        // Tutorial Logic
        let currentTutorialIndex = 0;
        const tutorialSteps = [
            {
                target: 'header',
                title: '设置封面',
                content: '点击顶部区域上传一张诱人的蛋糕成品图，支持缩放和裁剪，让您的配方更具吸引力。'
            },
            {
                target: '#recipeNameInput',
                title: '配方名称',
                content: '给您的蛋糕起个好听的名字（必填），方便日后在列表中快速查找。'
            },
            {
                target: '#categorySelect',
                title: '配方分类',
                content: '选择蛋糕种类（如戚风、海绵等），此为必填项，便于后续管理和筛选。'
            },
            {
                target: '#modeToggleBtn',
                title: '关联库存模式',
                content: '开启后可直接选择库存中的材料，系统将自动计算精准成本；关闭则为自由录入模式，适合快速记录。'
            },
            {
                target: '#tabGroup',
                title: '功能切换',
                content: '在这里切换“配方原料”和“制作步骤”，全面管理您的配方细节。'
            },
            {
                target: '.ingredient-group-card.group-main',
                title: '步骤一 (主料)',
                content: '点击“步骤一”分组右上角的“添加”按钮，快速增加所需的原料。标题也可点击修改哦！'
            },
            {
                target: '.unit-btn',
                title: '单位切换',
                content: '点击数字后面的单位（如g），可以切换为kg、ml、个等，系统会自动换算价格。'
            },
            {
                target: '.drag-handle',
                title: '自由排序',
                content: '长按列表项左侧的“拖拽图标”，上下拖动即可调整原料顺序，方便您整理配方结构。'
            },
            {
                target: '.ingredient-item',
                title: '快捷删除',
                content: '在原料行上“向左滑动”，即可显示删除按钮，快速移除不需要的原料。'
            },
            {
                target: '.percent-field',
                title: '百分比反算',
                content: '点击百分比数字，可以直接输入新的百分比，系统会自动反算所需的原料重量，研发调整更高效！'
            }
        ];

        function startTutorial() {
            currentTutorialIndex = 0;
            document.getElementById('tutorialOverlay').classList.add('active');
            updateTutorialState();
        }

        function endTutorial() {
            document.getElementById('tutorialOverlay').classList.remove('active');
        }

        function previousTutorialStep() { 
            if(currentTutorialIndex > 0) {
                currentTutorialIndex--; 
                updateTutorialState(); 
            }
        }

        function nextTutorialStep() { 
            if(currentTutorialIndex < tutorialSteps.length - 1) {
                currentTutorialIndex++; 
                updateTutorialState();
            } else {
                endTutorial();
            }
        }

        function updateTutorialState() {
             const step = tutorialSteps[currentTutorialIndex];
             let target = document.querySelector(step.target);
             
             // Fallback if target doesn't exist (e.g., no ingredients yet)
             if(!target && step.target === '.unit-btn') target = document.querySelector('.ingredient-group-card');
             if(!target && step.target === '.drag-handle') target = document.querySelector('.ingredient-group-card');
             if(!target && step.target === '.ingredient-item') target = document.querySelector('.ingredient-group-card');
             if(!target && step.target === '.percent-field') target = document.querySelector('.ingredient-group-card');

             if(target) {
                 const rect = target.getBoundingClientRect();
                 const highlight = document.getElementById('tutorialHighlight');
                 
                 // Add some padding to highlight
                 const padding = 4;
                 highlight.style.top = (rect.top - padding) + 'px';
                 highlight.style.left = (rect.left - padding) + 'px';
                 highlight.style.width = (rect.width + padding*2) + 'px';
                 highlight.style.height = (rect.height + padding*2) + 'px';
                 
                 document.getElementById('tutorialTitle').innerText = step.title;
                 document.getElementById('tutorialContent').innerText = step.content;
                 document.getElementById('tutorialStepIndicator').innerText = (currentTutorialIndex+1) + '/' + tutorialSteps.length;
                 
                 // Show popup
                 document.getElementById('tutorialPopup').classList.add('visible');
                 
                 // Button visibility
                 const prevBtn = document.getElementById('tutorialPrevBtn');
                 const nextBtn = document.getElementById('tutorialNextBtn');
                 const finishBtn = document.getElementById('tutorialFinishBtn');
                 
                 prevBtn.style.visibility = currentTutorialIndex === 0 ? 'hidden' : 'visible';
                 
                 if(currentTutorialIndex === tutorialSteps.length - 1) {
                     nextBtn.classList.add('hidden');
                     finishBtn.classList.remove('hidden');
                 } else {
                     nextBtn.classList.remove('hidden');
                     finishBtn.classList.add('hidden');
                 }
             }
        }
        
        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Default Ingredients
            addIngredient('main'); // Flour
            addIngredient('wet'); // Milk
            
            // Default Step
            addStep({title: '准备工作', content: '准备好所有原材料，烤箱预热至...'});
        });
    </script>
</body>
</html>
