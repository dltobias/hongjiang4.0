<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é…æ–¹è¯¦æƒ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS Variables for Font Scaling */
        :root {
            --font-scale: 1;
            --base-font-size: 15px;
            --amount-font-size: 16px;
            --percent-font-size: 12px;
            --step-font-size: 14px;
        }

        /* Dynamic Font Sizing Rules */
        .ingredient-name, 
        .sop-card p,
        .sop-card .font-medium, 
        .sop-card .font-bold
        {
            font-size: calc(var(--base-font-size) * var(--text-font-scale, var(--font-scale))) !important;
            line-height: 1.5;
        }

        /* Group titles should scale but maintain hierarchy - scale factor slightly reduced or base increased */
        .group-title {
            font-size: calc(var(--base-font-size) * 1.2 * var(--text-font-scale, var(--font-scale))) !important; /* 20% larger than base */
            line-height: 1.5;
        }
        
        .amount-display,
        .ingredient-amount-col .amount-display,
        #baseDoughWeight, #additionalWeight,
        #variation1DoughWeight, #variation2DoughWeight, #variation3DoughWeight,
        #variation2ChocolateWeight, #variation3CranberryWeight, #variation3WalnutWeight
        {
            font-size: calc(var(--amount-font-size) * var(--number-font-scale, var(--font-scale))) !important;
            font-weight: normal !important;
        }
        
        .ingredient-percent {
            font-size: calc(var(--percent-font-size) * var(--number-font-scale, var(--font-scale))) !important;
        }

        /* Unit Text - Fixed Size, Does NOT Scale */
        .unit-text {
            font-size: 12px !important;
            font-weight: normal !important;
            margin-left: 2px;
            vertical-align: baseline;
            opacity: 0.7;
        }

        /* åŸºç¡€æ ·å¼è°ƒæ•´ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px; /* Space for sticky footer */
        }

        /* éšè—æ»šåŠ¨æ¡ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* æ ‡ç­¾æ ·å¼ */
        .tag-badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border-radius: 9999px; /* Pill shape */
            font-size: 13px;
            font-weight: 500;
            margin-right: 8px;
            transition: all 0.2s ease;
        }
        .tag-primary { background: #fff7ed; color: #ea580c; border: 1px solid rgba(234, 88, 12, 0.1); }
        .dark .tag-primary { background: rgba(234, 88, 12, 0.15); color: #fb923c; border: none; }
        .tag-gray { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }
        .dark .tag-gray { background: #334155; color: #cbd5e1; border: none; }

        /* Tabæ ·å¼ */
        .tab-group {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 16px;
            margin-bottom: 24px;
        }
        .dark .tab-group { background: #1e293b; }
        
        .tab-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            border-radius: 12px;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid transparent;
        }
        .dark .tab-item { color: #94a3b8; }

        .tab-item.active {
            background: white;
            color: #ea580c; /* Orange-600 */
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border-color: rgba(0,0,0,0.02);
        }
        .dark .tab-item.active {
            background: #334155;
            color: #fb923c; /* Orange-400 */
        }
        
        .tab-item i { margin-right: 6px; font-size: 14px; }

        /* ææ–™åˆ—è¡¨æ ·å¼ */
        .ingredient-group-card {
            background: white;
            border-radius: 16px;
            padding: 0;
            margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .dark .ingredient-group-card {
            background: #1e293b;
            border-color: #334155;
            box-shadow: none;
        }

        .group-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #ffffff !important;
            border-bottom: 1px solid #f1f5f9;
        }
        .dark .group-header {
            background: #0f172a !important;
            border-color: #334155;
        }

        .group-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 13px;
        }
        .group-title {
            font-weight: 600;
            font-size: 16px;
            color: #1e293b;
            letter-spacing: -0.01em;
        }
        .dark .group-title { color: #f1f5f9; }

        /* åˆ†ç»„é¢œè‰² - More pastel/refined */
        .group-flour .group-icon { background: #fff7ed; color: #c2410c; }
        .dark .group-flour .group-icon { background: rgba(154, 52, 18, 0.2); color: #fdba74; }
        
        .group-sponge .group-icon { background: #f0fdf4; color: #15803d; }
        .dark .group-sponge .group-icon { background: rgba(21, 128, 61, 0.2); color: #86efac; }
        
        .group-wet .group-icon { background: #eff6ff; color: #1d4ed8; }
        .dark .group-wet .group-icon { background: rgba(29, 78, 216, 0.2); color: #93c5fd; }
        
        .group-dry .group-icon { background: #f8fafc; color: #475569; }
        .dark .group-dry .group-icon { background: #334155; color: #cbd5e1; }
        
        .group-aux .group-icon { background: #fefce8; color: #a16207; }
        .dark .group-aux .group-icon { background: rgba(161, 98, 7, 0.2); color: #fde047; }

        /* åˆ—è¡¨è¡Œæ ·å¼ */
        .list-row {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #f8fafc;
            transition: background-color 0.2s;
        }
        .dark .list-row { border-bottom-color: #334155; }
        .list-row:last-child { border-bottom: none; }
        .list-row:hover { background-color: #f8fafc; }
        .dark .list-row:hover { background-color: #334155; }

        /* æ¨¡æ‹Ÿå¤é€‰æ¡† */
        .fake-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-right: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dark .fake-checkbox { border-color: #4b5563; }
        
        .ingredient-item.checked .fake-checkbox {
            background-color: #f97316;
            border-color: #f97316;
            transform: scale(1.05);
        }
        .ingredient-item.checked .fake-checkbox i {
            display: block;
            color: white;
            font-size: 12px;
        }
        .fake-checkbox i { display: none; }

        .ingredient-name {
            font-weight: 500;
            color: #334151;
            font-size: 15px;
        }
        .dark .ingredient-name { color: #e2e8f0; }
        
        .ingredient-item.checked .ingredient-name {
            color: #94a3b8;
        }

        .ingredient-amount-col { text-align: right; }
        .ingredient-percent { font-size: 12px; color: #9ca3af; margin-top: 2px; }

        /* Status text style - Visible on check */
        .ingredient-status-text {
            display: none; /* Default hidden */
            font-size: 12px;
            color: #16a34a; /* Green-600 */
            margin-left: 8px; /* Corrected to margin-left */
            font-weight: 500;
            background: #dcfce7;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .ingredient-item.checked .ingredient-status-text {
            display: inline-block !important; /* Force visible when checked */
        }
        
        /* Gray out the whole row when checked */
        .ingredient-item.checked {
            background-color: #f3f4f6; /* Gray-100 */
            opacity: 0.7;
        }
        .dark .ingredient-item.checked {
            background-color: #334155; /* Slate-700 */
            opacity: 0.6;
        }
        
        /* Adjust layout for checked state */
        .ingredient-item.checked .ingredient-name,
        .ingredient-item.checked .amount-display {
            color: #94a3b8 !important;
        }

        /* SOP & Steps æ ·å¼ - Refined to match new card style */
        .sop-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            margin-bottom: 12px;
            transition: transform 0.2s ease;
        }
        .dark .sop-card {
            background: #1e293b;
            border-color: #334155;
            box-shadow: none;
        }
        .sop-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .sop-icon {
            width: 32px;
            height: 32px;
            background: #fff7ed;
            color: #ea580c;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        .dark .sop-icon {
            background: rgba(234, 88, 12, 0.15);
            color: #fb923c;
        }
        .sop-item-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #f0f0f0;
            font-size: 14px;
        }
        .dark .sop-item-row {
            border-bottom-color: #334155;
        }
        .sop-item-row:last-child { border-bottom: none; }

        .step-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            transition: all 0.3s ease;
            margin-top: 12px;
        }
        .step-images.expanded { 
            grid-template-columns: 1fr; 
        }
        .step-images.expanded img {
            aspect-ratio: 16/9;
            width: 100%;
            height: auto;
        }
        .step-images img {
            border-radius: 8px;
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        /* åŠ¨ç”»ç±» */
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å¼ºåˆ¶åˆ·æ–°æš—é»‘æ¨¡å¼ */
        .dark-force-refresh {}
    </style>
</head>
<body class="bg-[#f7f7f5] dark:bg-[#0f172a] min-h-screen">

    <!-- æ²‰æµ¸å¼å¤´éƒ¨ -->
    <header class="relative w-full h-72 bg-gray-200">
        <!-- å°é¢å›¾ -->
        <img src="https://images.unsplash.com/photo-1623428187969-5da2dcea5ebf?w=1200&h=800&fit=crop&q=90" 
             id="heroImage" 
             class="w-full h-full object-cover transition-transform duration-700 ease-out">
        <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-black/60"></div>

        <!-- è¿”å›æŒ‰é’® -->
        <button onclick="checkExitConfirmation()" class="absolute top-4 left-4 w-10 h-10 bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black/50 transition-colors z-20">
            <i class="fas fa-arrow-left"></i>
        </button>

        <!-- å³ä¸Šè§’æ“ä½œåŒº -->
        <div class="absolute top-4 right-4 flex space-x-3 z-20">
            <div class="relative">
                <button onclick="toggleShareMenu()" class="w-10 h-10 bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black/50 transition-colors">
                    <i class="fas fa-share-alt"></i>
                </button>
                <!-- åˆ†äº«èœå•ä¸‹æ‹‰ -->
                <div id="shareMenuDropdown" class="absolute right-0 top-12 bg-white dark:bg-[#334155] rounded-xl shadow-2xl border border-slate-200 dark:border-slate-600 p-2 z-30 hidden min-w-[160px]">
                    <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="publishToResources()">
                        <i class="fas fa-globe-asia mr-3 text-orange-500"></i>åˆ†äº«åˆ°ç¤¾åŒº
                    </button>
                    <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="shareToWeChat()">
                        <i class="fab fa-weixin mr-3 text-green-500"></i>åˆ†äº«åˆ°å¾®ä¿¡
                    </button>
                </div>
            </div>
            <button onclick="toggleMoreMenu()" class="w-10 h-10 bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black/50 transition-colors">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>

        <!-- æ›´å¤šèœå•ä¸‹æ‹‰ (ä¿æŒåŸæœ‰ç»“æ„) -->
        <div id="moreMenuDropdown" class="absolute right-4 top-16 bg-white dark:bg-[#334155] rounded-xl shadow-2xl border border-slate-200 dark:border-slate-600 p-2 z-30 hidden min-w-[160px]">
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="togglePercentages()">
                <i class="fas fa-percentage mr-3 text-purple-600 dark:text-purple-400"></i><span id="percentageButtonText">æŸ¥çœ‹ç™¾åˆ†æ¯”</span>
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="editRecipe()">
                <i class="fas fa-edit mr-3 text-purple-600 dark:text-purple-400"></i>ç¼–è¾‘é…æ–¹
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="duplicateRecipe()">
                <i class="fas fa-copy mr-3 text-purple-600 dark:text-purple-400"></i>å¤åˆ¶é…æ–¹
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="printRecipe()">
                <i class="fas fa-print mr-3 text-purple-600 dark:text-purple-400"></i>æ‰“å°é…æ–¹
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="toggleVariationMode()">
                <i class="fas fa-layer-group mr-3 text-purple-600 dark:text-purple-400"></i>åˆ‡æ¢å˜åŒ–æ¬¾æ¨¡å¼
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="showAutoStockOutModal()">
                <i class="fas fa-dolly mr-3 text-purple-600 dark:text-purple-400"></i>ç”Ÿäº§åˆ¶ä½œ
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 text-sm flex items-center transition mt-1" onclick="deleteRecipe()">
                <i class="fas fa-trash mr-3"></i>åˆ é™¤é…æ–¹
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="showFontSizeModal()">
                <i class="fas fa-text-height mr-3 text-purple-600 dark:text-purple-400"></i>è°ƒæ•´å­—ä½“
            </button>
            <div class="border-t border-gray-100 dark:border-gray-600 my-1"></div>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#475569] text-gray-800 dark:text-slate-100 text-sm flex items-center transition" onclick="toggleTheme()">
                <span id="themeIcon" class="mr-3 text-lg w-4 text-center">ğŸŒ™</span>åˆ‡æ¢ä¸»é¢˜
            </button>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒº (é‡å å¼è®¾è®¡) -->
    <main class="px-5 -mt-6 relative bg-white dark:bg-[#0f172a] rounded-t-3xl z-10 pt-6 min-h-[calc(100vh-280px)]">
        
        <!-- æ ‡é¢˜ä¸ä¿¡æ¯ -->
        <div class="mb-6">
            <div class="flex items-center justify-between mb-3">
                <h1 class="text-2xl font-bold tracking-tight text-gray-900 dark:text-white leading-tight cursor-pointer flex items-center gap-2" onclick="toggleRecipeInfo()">
                    ç»å…¸æˆšé£è›‹ç³•
                    <i id="infoToggleIcon" class="fas fa-chevron-right text-sm text-gray-400 dark:text-gray-500 transition-transform duration-300"></i>
                </h1>
                
                <div class="flex items-center gap-2">
                    <!-- Title Stepper (Hidden by default) -->
                    <div id="titleStepper" class="hidden items-center bg-gray-100 dark:bg-slate-700 rounded-lg p-1 animate-fadeIn">
                        <button class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-orange-600 dark:text-gray-400" onclick="adjustProduction('base', -1)">
                            <i class="fas fa-minus text-xs"></i>
                        </button>
                        <span id="titleProductionDisplay" class="w-8 text-center font-bold text-gray-900 dark:text-white text-sm">1</span>
                        <button class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-orange-600 dark:text-gray-400" onclick="adjustProduction('base', 1)">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Collapsible Info Container (Default Hidden) -->
            <div id="recipeInfoContainer" class="hidden overflow-hidden transition-all duration-300 origin-top">
                <div class="flex flex-wrap gap-2 mb-4 animate-fadeIn">
                    <span class="tag-badge tag-primary" onclick="showCategoryInfo(event)">è›‹ç³•ç±»</span>
                    <span class="tag-badge tag-gray"><i class="far fa-clock mr-1"></i> <span id="dynamicTimeDisplay">4å°æ—¶</span></span>
                    <span class="tag-badge tag-gray"><i class="fas fa-fire mr-1"></i> <span id="dynamicCalorieDisplay">280åƒå¡</span></span>
                </div>
                <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed animate-fadeIn">ç»å…¸æˆšé£è›‹ç³•ï¼Œç»„ç»‡ç»†è…»ï¼Œå£æ„Ÿç»µè½¯ï¼Œé€‚åˆä½œä¸ºåŸºç¡€è›‹ç³•èƒšã€‚</p>
            </div>
        </div>

        <!-- æ ‡ç­¾åˆ‡æ¢ -->
        <div class="tab-group" id="tabGroup">
            <div class="tab-item active" id="tab-btn-recipe" onclick="switchTab('recipe')">
                <i class="fas fa-birthday-cake"></i> é…æ–¹
            </div>
            <div class="tab-item" id="tab-btn-step" onclick="switchTab('step')">
                <i class="fas fa-list-ol"></i> æ­¥éª¤
            </div>
        </div>

        <!-- é…æ–¹å†…å®¹åŒº -->
        <div id="recipe-section" class="pb-20">
            <!-- æ­¥éª¤ä¸€ -->
            <div class="ingredient-group-card group-main">
                <div class="group-header">
                    <div class="group-icon"><i class="fas fa-cheese"></i></div>
                    <div class="group-title">æ­¥éª¤ä¸€</div>
                </div>
                <div class="space-y-0">
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">ä½ç­‹é¢ç²‰</div>
                            <div class="ingredient-status-text">å·²å…¥æ–™</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="100">100<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">100%</div>
                        </div>
                    </div>
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">ç»†ç ‚ç³–</div>
                            <div class="ingredient-status-text">å·²å…¥æ–™</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="80">80<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">80%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤äºŒ -->
            <div class="ingredient-group-card group-wet">
                <div class="group-header">
                    <div class="group-icon"><i class="fas fa-tint"></i></div>
                    <div class="group-title">æ­¥éª¤äºŒ</div>
                </div>
                <div class="space-y-0">
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">ç‰›å¥¶</div>
                            <div class="ingredient-status-text">å·²å…¥æ–™</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="50">50<span class="unit-text">ml</span></div>
                            <div class="ingredient-percent percentage-text">50%</div>
                        </div>
                    </div>
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">é¸¡è›‹</div>
                            <div class="ingredient-status-text">å·²å…¥æ–™</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="150">150<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">150%</div>
                        </div>
                    </div>
                    <div class="list-row ingredient-item cursor-pointer" onclick="toggleIngredientStatus(this)">
                        <div class="fake-checkbox"><i class="fas fa-check"></i></div>
                        <div class="flex-1 flex items-center">
                            <div class="ingredient-name mr-2">è‰²æ‹‰æ²¹</div>
                            <div class="ingredient-status-text">å·²å…¥æ–™</div>
                        </div>
                        <div class="ingredient-amount-col">
                            <div class="amount-display text-gray-900 dark:text-white" data-base-amount="40">40<span class="unit-text">g</span></div>
                            <div class="ingredient-percent percentage-text">40%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å˜åŒ–æ¬¾å®¹å™¨ (ç”±JSæ§åˆ¶æ˜¾ç¤º) -->
            <div id="variations-section" class="hidden space-y-4 mt-6 border-t border-gray-100 pt-6">
                <div class="flex items-center justify-between mb-2 px-1">
                    <h3 class="font-bold text-gray-800 dark:text-white text-lg">åˆ¶ä½œåˆ—è¡¨</h3>
                </div>

                <!-- å˜åŒ–æ¬¾1 -->
                <div id="card-var1" class="ingredient-group-card border-l-4 border-l-orange-500">
                    <div class="group-header justify-between">
                        <div class="flex items-center">
                            <div class="group-title text-gray-900 dark:text-white">ç»å…¸åŸå‘³</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">æ•°é‡:</span>
                            <div class="flex items-center bg-white dark:bg-slate-700 rounded border border-gray-200 dark:border-slate-600">
                                <button class="px-2 py-0.5 text-gray-400 hover:text-orange-600" onclick="adjustProduction('var1', -1)">-</button>
                                <span id="var1Production" class="px-1 text-sm font-bold min-w-[20px] text-center">1</span>
                                <button class="px-2 py-0.5 text-gray-400 hover:text-orange-600" onclick="adjustProduction('var1', 1)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-0">
                        <div class="list-row">
                            <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">åŸºç¡€é¢ç³Š</span>
                            <div class="text-right">
                                <div class="amount-display text-gray-900 dark:text-white">420<span class="unit-text">g</span></div>
                            </div>
                        </div>
                        <div class="list-row">
                            <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">å¡ä»•è¾¾é…±</span>
                            <div class="text-right">
                                <div class="amount-display text-gray-900 dark:text-white">50<span class="unit-text">g</span></div>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-slate-800/50 flex justify-between items-center border-t border-gray-100 dark:border-slate-700">
                            <div>
                                <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">æ€»æˆæœ¬</div>
                                <div class="flex items-baseline gap-1">
                                     <span class="text-xl font-bold text-orange-600 dark:text-orange-400 leading-none" id="var1TotalCost">11.44</span>
                                     <span class="text-xs text-orange-600 dark:text-orange-400 font-medium">Â¥</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">æ€»é‡é‡</div>
                                <div class="text-lg font-bold text-gray-700 dark:text-gray-200"><span id="var1TotalWeight">470</span><span class="text-xs font-normal ml-0.5 text-gray-400">g</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å˜åŒ–æ¬¾2 -->
                <div id="card-var2" class="ingredient-group-card border-l-4 border-l-orange-500">
                    <div class="group-header justify-between">
                        <div class="flex items-center">
                            <div class="group-title text-gray-900 dark:text-white">å¯å¯é£å‘³</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">æ•°é‡:</span>
                            <div class="flex items-center bg-white dark:bg-slate-700 rounded border border-gray-200 dark:border-slate-600">
                                <button class="px-2 py-0.5 text-gray-400 hover:text-orange-600" onclick="adjustProduction('var2', -1)">-</button>
                                <span id="var2Production" class="px-1 text-sm font-bold min-w-[20px] text-center">1</span>
                                <button class="px-2 py-0.5 text-gray-400 hover:text-orange-600" onclick="adjustProduction('var2', 1)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-0">
                        <div class="list-row">
                            <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">åŸºç¡€é¢ç³Š</span>
                            <div class="text-right">
                                <div class="amount-display text-gray-900 dark:text-white">400<span class="unit-text">g</span></div>
                            </div>
                        </div>
                        <div class="list-row">
                            <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">å¯å¯ç²‰</span>
                            <div class="text-right">
                                <div class="amount-display text-gray-900 dark:text-white">20<span class="unit-text">g</span></div>
                            </div>
                        </div>
                        <div class="list-row">
                            <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">å·§å…‹åŠ›è±†</span>
                            <div class="text-right">
                                <div class="amount-display text-gray-900 dark:text-white">30<span class="unit-text">g</span></div>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-slate-800/50 flex justify-between items-center border-t border-gray-100 dark:border-slate-700">
                            <div>
                                <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">æ€»æˆæœ¬</div>
                                <div class="flex items-baseline gap-1">
                                     <span class="text-xl font-bold text-orange-600 dark:text-orange-400 leading-none" id="var2TotalCost">12.50</span>
                                     <span class="text-xs text-orange-600 dark:text-orange-400 font-medium">Â¥</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">æ€»é‡é‡</div>
                                <div class="text-lg font-bold text-gray-700 dark:text-gray-200"><span id="var2TotalWeight">450</span><span class="text-xs font-normal ml-0.5 text-gray-400">g</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step Section -->
        <div id="step-section" class="hidden pb-20">
             <div class="space-y-4">
                 <!-- Step 1 -->
                 <div class="sop-card">
                     <div class="flex items-center justify-between mb-3">
                         <h3 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                             <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-lg flex items-center justify-center text-sm font-bold">1</div>
                             è›‹é»„ç³Šåˆ¶ä½œ
                         </h3>
                         <div class="flex items-center gap-2">
                             <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-1" onclick="toggleStepImages(this)" title="å±•å¼€/æ”¶èµ·å›¾ç‰‡">
                                 <i class="fas fa-list"></i>
                             </button>
                         </div>
                     </div>
                     <div class="step-content">
                         <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-3">å°†ç‰›å¥¶ã€è‰²æ‹‰æ²¹ã€ç»†ç ‚ç³–æ··åˆä¹³åŒ–ï¼Œç­›å…¥ä½ç­‹é¢ç²‰æ…æ‹Œå‡åŒ€ï¼Œæœ€ååŠ å…¥è›‹é»„æ…æ‹Œè‡³é¡ºæ»‘ã€‚</p>
                         <div class="step-images expanded">
                             <div class="relative">
                                 <img src="https://images.unsplash.com/photo-1626202022723-26d506342777?w=400&h=400&fit=crop" class="rounded-lg object-cover">
                                 <button class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white rounded-full p-2 hover:bg-opacity-80 transition-all w-8 h-8 flex items-center justify-center" onclick="showStepImage(this)">
                                     <i class="fas fa-search-plus text-xs"></i>
                                 </button>
                             </div>
                         </div>
                     </div>
                 </div>

                 <!-- Step 2 -->
                 <div class="sop-card">
                     <div class="flex items-center justify-between mb-3">
                         <h3 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                             <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-lg flex items-center justify-center text-sm font-bold">2</div>
                             è›‹ç™½æ‰“å‘
                         </h3>
                         <div class="flex items-center gap-2">
                             <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-1" onclick="toggleStepImages(this)" title="å±•å¼€/æ”¶èµ·å›¾ç‰‡">
                                 <i class="fas fa-list"></i>
                             </button>
                         </div>
                     </div>
                     <div class="step-content">
                         <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-3">è›‹ç™½åˆ†ä¸‰æ¬¡åŠ å…¥ç»†ç ‚ç³–ï¼Œæ‰“å‘è‡³å¹²æ€§å‘æ³¡ï¼ˆæèµ·æ‰“è›‹å¤´æœ‰ç›´ç«‹å°å°–è§’ï¼‰ã€‚</p>
                         <div class="step-images expanded">
                             <div class="relative">
                                 <img src="https://images.unsplash.com/photo-1579306194872-64d3b7bac4c2?w=400&h=400&fit=crop" class="rounded-lg object-cover">
                                 <button class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white rounded-full p-2 hover:bg-opacity-80 transition-all w-8 h-8 flex items-center justify-center" onclick="showStepImage(this)">
                                     <i class="fas fa-search-plus text-xs"></i>
                                 </button>
                             </div>
                         </div>
                     </div>
                 </div>

                 <!-- Step 3 -->
                 <div class="sop-card">
                     <div class="flex items-center justify-between mb-3">
                         <h3 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                             <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-lg flex items-center justify-center text-sm font-bold">3</div>
                             æ··åˆæ…æ‹Œ
                         </h3>
                         <div class="flex items-center gap-2">
                             <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-1" onclick="toggleStepImages(this)" title="å±•å¼€/æ”¶èµ·å›¾ç‰‡">
                                 <i class="fas fa-list"></i>
                             </button>
                         </div>
                     </div>
                     <div class="step-content">
                         <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-3">å–ä¸‰åˆ†ä¹‹ä¸€è›‹ç™½éœœåŠ å…¥è›‹é»„ç³Šç¿»æ‹Œå‡åŒ€ï¼Œå†å€’å›å‰©ä½™è›‹ç™½éœœä¸­ç¿»æ‹Œå‡åŒ€ã€‚</p>
                         <div class="step-images expanded">
                             <div class="relative">
                                 <img src="https://images.unsplash.com/photo-1606890737304-57a1ca8a5b62?w=400&h=400&fit=crop" class="rounded-lg object-cover">
                                 <button class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white rounded-full p-2 hover:bg-opacity-80 transition-all w-8 h-8 flex items-center justify-center" onclick="showStepImage(this)">
                                     <i class="fas fa-search-plus text-xs"></i>
                                 </button>
                             </div>
                         </div>
                     </div>
                 </div>
                 
                 <!-- Step 4 -->
                 <div class="sop-card">
                     <div class="flex items-center justify-between mb-3">
                         <h3 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                             <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-lg flex items-center justify-center text-sm font-bold">4</div>
                             çƒ˜çƒ¤è„±æ¨¡
                         </h3>
                         <div class="flex items-center gap-2">
                             <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-1" onclick="toggleStepImages(this)" title="å±•å¼€/æ”¶èµ·å›¾ç‰‡">
                                 <i class="fas fa-list"></i>
                             </button>
                         </div>
                     </div>
                     <div class="step-content">
                         <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-3">å…¥ç‚‰150åº¦çƒ˜çƒ¤50åˆ†é’Ÿï¼Œå‡ºç‚‰éœ‡å‡ºçƒ­æ°”ï¼Œå€’æ‰£æ™¾å‡‰åè„±æ¨¡ã€‚</p>
                         <div class="step-images expanded">
                             <div class="relative">
                                 <img src="https://images.unsplash.com/photo-1464349095431-e9a21285b5f3?w=400&h=400&fit=crop" class="rounded-lg object-cover">
                                 <button class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white rounded-full p-2 hover:bg-opacity-80 transition-all w-8 h-8 flex items-center justify-center" onclick="showStepImage(this)">
                                     <i class="fas fa-search-plus text-xs"></i>
                                 </button>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>

    </main>

    <!-- åº•éƒ¨ç»Ÿè®¡æ¡ (Sticky) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md dark:bg-[#1e293b]/90 border-t border-gray-100 dark:border-slate-700 p-4 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)]">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-100 to-orange-50 dark:from-orange-900/30 dark:to-orange-800/20 text-orange-500 flex items-center justify-center shadow-sm">
                    <i class="fas fa-coins text-xl"></i>
                </div>
                <div>
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-0.5">é¢„ä¼°æˆæœ¬</div>
                    <div class="flex items-baseline gap-0.5">
                        <span class="amount-display text-2xl font-bold text-orange-600 dark:text-orange-400 leading-none" id="totalCost">11.44</span>
                        <span class="text-sm font-medium text-orange-600 dark:text-orange-400">Â¥</span>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-0.5">æ€»é‡é‡</div>
                <div class="amount-display text-xl text-gray-900 dark:text-white font-medium" id="overallTotalWeight">2090<span class="unit-text text-sm text-gray-500 ml-1">g</span></div>
            </div>
        </div>
    </div>

    <!-- Font Size Adjustment Modal -->
    <div id="fontSizeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 hidden transition-opacity duration-300" onclick="if(event.target === this) closeFontSizeModal()">
        <div class="bg-white dark:bg-[#1E293B] w-full sm:w-[400px] sm:rounded-2xl rounded-t-2xl p-6 shadow-2xl transform transition-transform duration-300 translate-y-full sm:translate-y-0" id="fontSizeModalContent">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">è°ƒæ•´å­—ä½“å¤§å°</h3>
                <button onclick="closeFontSizeModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-700 flex items-center justify-center text-gray-500 hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Text Size Slider -->
            <div class="mb-6">
                <div class="flex justify-between items-end mb-3 px-2">
                    <span class="text-sm font-bold text-gray-700 dark:text-gray-300">æ–‡å­—å¤§å°</span>
                    <span class="text-sm font-bold text-orange-600 dark:text-orange-400" id="currentTextSizeLabel">æ ‡å‡†</span>
                </div>
                <input type="range" min="1" max="6" value="1" step="1" id="textSizeSlider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500 dark:bg-gray-700" oninput="previewTextSize(this.value)">
                <div class="flex justify-between mt-2 px-1">
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                </div>
            </div>

            <!-- Number Size Slider -->
            <div class="mb-8">
                <div class="flex justify-between items-end mb-3 px-2">
                    <span class="text-sm font-bold text-gray-700 dark:text-gray-300">æ•°å­—å¤§å°</span>
                    <span class="text-sm font-bold text-orange-600 dark:text-orange-400" id="currentNumberSizeLabel">æ ‡å‡†</span>
                </div>
                <input type="range" min="1" max="6" value="1" step="1" id="numberSizeSlider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500 dark:bg-gray-700" oninput="previewNumberSize(this.value)">
                <div class="flex justify-between mt-2 px-1">
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <div class="w-1 h-2 bg-gray-300 dark:bg-gray-600 rounded"></div>
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-slate-800 rounded-xl p-4 mb-6">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">é¢„è§ˆæ•ˆæœï¼š</p>
                <div class="flex items-center justify-between py-2 border-b border-dashed border-gray-200 dark:border-slate-700">
                    <span class="flex-1 font-medium text-gray-700 dark:text-gray-300 ingredient-name-preview transition-all duration-200">é«˜ç­‹é¢ç²‰</span>
                    <div class="text-right">
                        <div class="amount-display text-gray-900 dark:text-white ingredient-amount-preview transition-all duration-200">500<span class="unit-text">g</span></div>
                    </div>
                </div>
            </div>

            <button onclick="saveFontSize()" class="w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-bold shadow-lg shadow-orange-200 dark:shadow-none hover:from-orange-600 hover:to-orange-700 transition-all">
                ç¡®è®¤è°ƒæ•´
            </button>
        </div>
    </div>

    <!-- Modals (Original) -->
    <div id="shareConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-[#1E293B] rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-orange-500 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-[#1E293B] dark:text-slate-100 mb-2">åˆ†äº«é…æ–¹è‡³å¹³å°</h3>
                <p class="text-slate-600 dark:text-slate-400 text-sm mb-6">å°†æ‚¨çš„ç²¾å¿ƒé…æ–¹åˆ†äº«ç»™æ›´å¤šçƒ˜ç„™çˆ±å¥½è€…ï¼Œè·å¾—ç‚¹èµå’Œå…³æ³¨ã€‚</p>
                <div class="flex gap-3">
                    <button class="flex-1 px-4 py-2 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition" onclick="closeShareConfirm()">å–æ¶ˆ</button>
                    <button class="flex-1 px-4 py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl hover:from-orange-600 hover:to-red-600 transition" onclick="confirmShare()">ç¡®è®¤åˆ†äº«</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="shareToFriendModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-[#1E293B] rounded-2xl p-6 max-w-md mx-4 w-[90%] shadow-2xl">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-[#1E293B] dark:text-slate-100">åˆ†äº«é…æ–¹</h3>
                <button class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xl" onclick="closeShareToFriend()"><i class="fas fa-times"></i></button>
            </div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mb-6" id="share-description">é€‰æ‹©è¦åˆ†äº«åˆ°çš„å¹³å°</p>
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="flex flex-col items-center gap-1 cursor-pointer hover:scale-110 transition-all" onclick="shareViaMethod('wechat')">
                    <div class="w-14 h-14 bg-green-500 rounded-full flex items-center justify-center text-white"><i class="fab fa-weixin text-xl"></i></div>
                    <span class="text-xs text-slate-600 dark:text-slate-400">å¾®ä¿¡</span>
                </div>
                <div class="flex flex-col items-center gap-1 cursor-pointer hover:scale-110 transition-all" onclick="shareViaMethod('link')">
                    <div class="w-14 h-14 bg-gray-500 rounded-full flex items-center justify-center text-white"><i class="fas fa-link text-xl"></i></div>
                    <span class="text-xs text-slate-600 dark:text-slate-400">å¤åˆ¶é“¾æ¥</span>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡å…¨å±é¢„è§ˆ -->
    <div id="fullImageModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden" onclick="this.classList.add('hidden')">
        <img src="" alt="é…æ–¹å¤§å›¾" class="max-w-[90vw] max-h-[90vh] object-contain rounded-xl">
        <button class="absolute top-4 right-4 bg-white bg-opacity-20 text-white rounded-full p-3 hover:bg-opacity-40 transition-all" onclick="event.stopPropagation(); this.parentElement.classList.add('hidden')">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Original JS Scripts -->
    <script>
        // æ­¥éª¤å›¾ç‰‡äº¤äº’é€»è¾‘
        function toggleStepImages(btn) {
            const card = btn.closest('.sop-card');
            const imagesGrid = card.querySelector('.step-images');
            
            if (imagesGrid) {
                imagesGrid.classList.toggle('expanded');
                const icon = btn.querySelector('i');
                if (imagesGrid.classList.contains('expanded')) {
                    icon.classList.remove('fa-th-large');
                    icon.classList.add('fa-list');
                } else {
                    icon.classList.remove('fa-list');
                    icon.classList.add('fa-th-large');
                }
            }
        }

        function showStepImage(btn) {
            const img = btn.previousElementSibling; 
            const src = img.src;
            const modal = document.getElementById('fullImageModal');
            const modalImg = modal.querySelector('img');
            
            modalImg.src = src;
            modal.classList.remove('hidden');
        }

        // Font Size Adjustment Logic
        let initialTextLevel = 1;
        let initialNumberLevel = 1;

        function showFontSizeModal() {
            const modal = document.getElementById('fontSizeModal');
            const content = document.getElementById('fontSizeModalContent');
            const savedText = parseInt(localStorage.getItem('recipeTextSizeLevel') || '1');
            const savedNumber = parseInt(localStorage.getItem('recipeNumberSizeLevel') || '1');
            
            initialTextLevel = savedText;
            initialNumberLevel = savedNumber;
            
            document.getElementById('textSizeSlider').value = savedText;
            document.getElementById('numberSizeSlider').value = savedNumber;
            
            previewTextSize(savedText);
            previewNumberSize(savedNumber);
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('translate-y-full');
            }, 10);
            
            // Close menu if open
            if (!document.getElementById('moreMenuDropdown').classList.contains('hidden')) {
                toggleMoreMenu();
            }
        }

        function closeFontSizeModal() {
            const modal = document.getElementById('fontSizeModal');
            const content = document.getElementById('fontSizeModalContent');
            
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
                // Revert to initial if not saved (assuming saveFontSize handles the save)
                // Actually, since we update live, we should revert if not saved.
                // But saveFontSize calls this function too.
                // So we need to check if we should revert.
                // Simplified approach: Always revert to what's in localStorage when closing without saving?
                // But saveFontSize updates localStorage before calling this.
                // So we can just re-apply from localStorage.
                const savedText = parseInt(localStorage.getItem('recipeTextSizeLevel') || '1');
                const savedNumber = parseInt(localStorage.getItem('recipeNumberSizeLevel') || '1');
                applyTextSize(savedText);
                applyNumberSize(savedNumber);
            }, 300);
        }

        function getLevelLabel(level) {
            const labels = ['æ ‡å‡†', 'ä¸­', 'å¤§', 'åŠ å¤§', 'ç‰¹å¤§', 'æœ€å¤§'];
            return labels[level - 1] || 'æ ‡å‡†';
        }

        function previewTextSize(level) {
            document.getElementById('currentTextSizeLabel').textContent = getLevelLabel(level);
            const scale = 1 + (level - 1) * 0.1;
            
            // Update preview
            const previewName = document.querySelector('.ingredient-name-preview');
            if (previewName) previewName.style.fontSize = `calc(15px * ${scale})`;
            
            // Live update
            document.documentElement.style.setProperty('--text-font-scale', scale);
        }

        function previewNumberSize(level) {
            document.getElementById('currentNumberSizeLabel').textContent = getLevelLabel(level);
            const scale = 1 + (level - 1) * 0.1;
            
            // Update preview
            const previewAmount = document.querySelector('.ingredient-amount-preview');
            if (previewAmount) previewAmount.style.fontSize = `calc(16px * ${scale})`;
            
            // Live update
            document.documentElement.style.setProperty('--number-font-scale', scale);
        }

        function saveFontSize() {
            const textLevel = document.getElementById('textSizeSlider').value;
            const numberLevel = document.getElementById('numberSizeSlider').value;
            
            localStorage.setItem('recipeTextSizeLevel', textLevel);
            localStorage.setItem('recipeNumberSizeLevel', numberLevel);
            
            closeFontSizeModal();
        }
        
        function applyTextSize(level) {
            const scale = 1 + (level - 1) * 0.1;
            document.documentElement.style.setProperty('--text-font-scale', scale);
        }

        function applyNumberSize(level) {
            const scale = 1 + (level - 1) * 0.1;
            document.documentElement.style.setProperty('--number-font-scale', scale);
        }

        // Initialize Font Size on Load
        document.addEventListener('DOMContentLoaded', () => {
            const savedText = parseInt(localStorage.getItem('recipeTextSizeLevel') || '1');
            const savedNumber = parseInt(localStorage.getItem('recipeNumberSizeLevel') || '1');
            applyTextSize(savedText);
            applyNumberSize(savedNumber);
        });

        // Global State
        let hasModifiedIngredients = false;
        let moreMenuOpen = false;
        let showPercentages = false;
        
        // Tab Switcher
        function switchTab(tab) {
            const tabs = ['recipe', 'step'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-btn-${t}`);
                const section = document.getElementById(`${t}-section`);
                
                if (btn && section) {
                    if (t === tab) {
                        btn.classList.add('active');
                        section.classList.remove('hidden');
                    } else {
                        btn.classList.remove('active');
                        section.classList.add('hidden');
                    }
                }
            });
        }

        // Toggle Ingredient Status (Modified for new UI)
        function toggleIngredientStatus(element) {
            // Find checkbox and status text
            const checkbox = element.querySelector('.fake-checkbox');
            const statusText = element.querySelector('.ingredient-status-text');
            const name = element.querySelector('.ingredient-name');
            
            // Toggle 'checked' class on the parent row
            if (element.classList.contains('checked')) {
                element.classList.remove('checked');
                // Hide status text (logic)
                if(statusText) statusText.classList.remove('visible');
            } else {
                element.classList.add('checked');
                // Show status text (logic)
                if(statusText) statusText.classList.add('visible');
            }
        }

        function updateOverallSummary() {
            let totalWeight = 0;
            
            // Sum up all ingredient amounts
            document.querySelectorAll('.ingredient-amount-col .amount-display').forEach(el => {
                const amount = parseFloat(el.getAttribute('data-base-amount') || el.innerText);
                if (!isNaN(amount)) {
                    totalWeight += amount;
                }
            });
            
            const weightEl = document.getElementById('overallTotalWeight');
            if(weightEl) weightEl.innerHTML = Math.round(totalWeight) + '<span class="unit-text text-sm text-gray-500 ml-1">g</span>';
            
            // Cost is not calculated in this static view
            const costEl = document.getElementById('totalCost');
            if(costEl) costEl.textContent = "0.00"; 
        }

        function formatWeight(weight) {
            // Always return grams as per user request
            return Math.round(weight) + 'g';
        }

        function toggleMoreMenu() {
            const dropdown = document.getElementById('moreMenuDropdown');
            dropdown.classList.toggle('hidden');
            // Close share menu if open
            if (!document.getElementById('shareMenuDropdown').classList.contains('hidden')) {
                toggleShareMenu();
            }
        }

        function toggleShareMenu() {
            const dropdown = document.getElementById('shareMenuDropdown');
            dropdown.classList.toggle('hidden');
            // Close more menu if open
            if (!document.getElementById('moreMenuDropdown').classList.contains('hidden')) {
                toggleMoreMenu();
            }
        }

        function shareToWeChat() {
            // Mock WeChat share
            alert('æ­£åœ¨è°ƒèµ·å¾®ä¿¡åˆ†äº«...');
            toggleShareMenu();
        }

        // Toggle Percentages
        function togglePercentages() {
            showPercentages = !showPercentages;
            const btnText = document.getElementById('percentageButtonText');
            
            document.querySelectorAll('.percentage-text').forEach(el => {
                el.style.display = showPercentages ? 'block' : 'none';
            });
            
            if(showPercentages) {
                btnText.textContent = 'éšè—ç™¾åˆ†æ¯”';
            } else {
                btnText.textContent = 'æŸ¥çœ‹ç™¾åˆ†æ¯”';
            }
            toggleMoreMenu();
        }

        // Theme Toggle
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
        }

        // Navigation
        function checkExitConfirmation() {
            history.back();
        }

        // Mock Share
        function shareRecipe() {
            document.getElementById('shareToFriendModal').classList.remove('hidden');
        }
        function closeShareToFriend() {
            document.getElementById('shareToFriendModal').classList.add('hidden');
        }
        function shareViaMethod(method) {
            closeShareToFriend();
        }

        // Auto Stock Out Mock
        function showAutoStockOutModal() {
            alert('ç”Ÿäº§åˆ¶ä½œåŠŸèƒ½æ¨¡å—');
        }
        
        // Initial State
        document.addEventListener('DOMContentLoaded', () => {
             updateOverallSummary();
             calculateRecipeCalories(); // Calculate calories on load
             // Hide percentages initially
             document.querySelectorAll('.percentage-text').forEach(el => el.style.display = 'none');
        });

        // Calorie Calculation Logic
        // Database of kcal per 100g
        const calorieDB = {
            'é«˜ç­‹é¢ç²‰': 364,
            'ä½ç­‹é¢ç²‰': 364,
            'å…¨éº¦ç²‰': 352,
            'è‡ªåˆ¶ç§é¢': 200, // Estimated (flour+water)
            'ç‰›å¥¶': 65,
            'é¸¡è›‹': 143,
            'ç³–æµ†é…æ–¹': 300, // Estimated
            'ç™½ç ‚ç³–': 400,
            'ç›': 0,
            'å¹²é…µæ¯': 325,
            'é»„æ²¹': 717,
            'èŠéº»': 573,
            'é…¥è èçš®': 450, // Estimated
            'å·§å…‹åŠ›ç²’': 500,
            'è”“è¶Šè“å¹²': 320,
            'æ ¸æ¡ƒé…æ–¹': 654
        };

        function calculateRecipeCalories() {
            let totalCalories = 0;
            let totalRawWeight = 0;
            
            // Scan all ingredient rows
            const ingredientRows = document.querySelectorAll('.ingredient-item, .list-row');
            
            ingredientRows.forEach(row => {
                const nameEl = row.querySelector('.ingredient-name, .font-medium');
                const amountEl = row.querySelector('.amount-display');
                
                if (nameEl && amountEl) {
                    // Extract name (remove extra whitespace)
                    let name = nameEl.textContent.trim();
                    // Handle complex names or children
                    if (name.includes('åŸºç¡€é¢å›¢')) return; // Skip composite summaries to avoid double counting if individual ingredients are listed. 
                    // Wait, this page lists base ingredients separately.
                    // But "Base Dough" card lists summary.
                    // Actually, the structure has:
                    // 1. Flour/Sponge/Wet/Dry/Aux groups (Individual ingredients for Base Dough)
                    // 2. "Base Dough" card (Summary)
                    // 3. Variations (Summary + Add-ons)
                    
                    // We should ONLY count the Raw Ingredients from the groups (Flour, Sponge, Wet, Dry, Aux).
                    // And IF variations are active, add their add-ons.
                    // BUT, the current page structure lists ingredients for "Base Dough".
                    // The "Variations" are separate cards that imply "Base Dough + Add-ons".
                    // If we want "280kcal" (per 100g), it should be relatively constant for the base dough.
                    // Let's calculate for the currently displayed ingredients in the Groups.
                    
                    // Filter: Only process rows inside .ingredient-group-card that are NOT the summary cards
                    // The summary cards have id="card-base", "card-var1", etc.
                    // The raw ingredient groups are "group-flour", "group-sponge", etc.
                    const parentCard = row.closest('.ingredient-group-card');
                    if (!parentCard) return;
                    
                    if (parentCard.id && parentCard.id.startsWith('card-')) return; // Skip summary cards
                    
                    // Get base amount (from data attribute to avoid parsed/scaled values drifting)
                    const baseAmount = parseFloat(amountEl.getAttribute('data-base-amount')) || 0;
                    
                    // Lookup calories
                    // Try exact match or partial
                    let kcalPer100 = 0;
                    for (const [key, val] of Object.entries(calorieDB)) {
                        if (name.includes(key)) {
                            kcalPer100 = val;
                            break;
                        }
                    }
                    
                    // Fallback for unknown
                    if (kcalPer100 === 0 && baseAmount > 0) {
                        console.warn('Unknown ingredient for calories:', name);
                        kcalPer100 = 200; // Default fallback
                    }
                    
                    totalCalories += (baseAmount * kcalPer100) / 100;
                    totalRawWeight += baseAmount;
                }
            });
            
            if (totalRawWeight > 0) {
                // Baking loss ~10-15%. Cooked weight is less than raw weight.
                // Energy is conserved (mostly).
                // So Kcal/100g Cooked = Total Kcal / (Raw Weight * 0.9) * 100
                const cookedWeight = totalRawWeight * 0.9;
                const kcalPer100g = (totalCalories / cookedWeight) * 100;
                
                const display = document.getElementById('dynamicCalorieDisplay');
                if(display) display.textContent = Math.round(kcalPer100g) + 'åƒå¡';
            }
        }

        // Variation Logic & Stepper Implementation
        // Initial state: 2 variations to demonstrate the UI layout as requested
        let variations = [
            { id: 'var1', name: 'ç»å…¸åŸå‘³', count: 1, baseWeight: 470, baseCost: 11.44 },
            { id: 'var2', name: 'å¯å¯é£å‘³', count: 1, baseWeight: 450, baseCost: 12.50 }
        ];

        function initVariationDisplay() {
            const titleStepper = document.getElementById('titleStepper');
            const variationsSection = document.getElementById('variations-section');
            
            // Logic: If 1 variation -> Show Top Stepper. If >1 -> Hide Top Stepper (and show bottom cards if they existed)
            if (variations.length === 1) {
                titleStepper.classList.remove('hidden');
                titleStepper.classList.add('flex');
                if(variationsSection) variationsSection.classList.add('hidden');
                
                // Update top stepper display
                const display = document.getElementById('titleProductionDisplay');
                if(display) display.textContent = variations[0].count;
            } else {
                titleStepper.classList.add('hidden');
                titleStepper.classList.remove('flex');
                if(variationsSection) variationsSection.classList.remove('hidden');
            }
            
            updateOverallSummary();
        }

        function adjustProduction(id, delta) {
            // Handle 'base' from Top Stepper (maps to first variation)
            let variation;
            if (id === 'base') {
                variation = variations[0];
            } else {
                variation = variations.find(v => v.id === id);
            }
            
            if (!variation) return;
            
            const newCount = Math.max(0, variation.count + delta);
            variation.count = newCount;
            
            // Update Displays
            // 1. Top Stepper (if visible/mapped)
            if (id === 'base' || variations.length === 1) {
                const topDisplay = document.getElementById('titleProductionDisplay');
                if(topDisplay) topDisplay.textContent = newCount;
            }
            
            // 2. Card Display (if visible)
            const cardDisplay = document.getElementById(`${variation.id}Production`);
            if(cardDisplay) cardDisplay.textContent = newCount;
            
            // 3. Card Totals
            const weightEl = document.getElementById(`${variation.id}TotalWeight`);
            if(weightEl) weightEl.textContent = Math.round(variation.baseWeight * newCount);
            
            const costEl = document.getElementById(`${variation.id}TotalCost`);
            if(costEl) costEl.textContent = (variation.baseCost * newCount).toFixed(2);
            
            // Scale & Summary
            scaleIngredients();
            updateOverallSummary();
        }

        function scaleIngredients() {
            // Scale based on TOTAL count of all variations
            let totalCount = 0;
            variations.forEach(v => totalCount += v.count);
            
            // Avoid 0 multiplier for base ingredients? Or allow it? 
            // If user sets all to 0, ingredients needed is 0.
            const multiplier = totalCount;
            
            document.querySelectorAll('.ingredient-amount-col .amount-display').forEach(el => {
                const base = parseFloat(el.getAttribute('data-base-amount'));
                if (!isNaN(base)) {
                    // Update the text node, preserve the span unit
                    // Check if childNodes[0] is text
                    if (el.firstChild && el.firstChild.nodeType === 3) {
                         el.firstChild.nodeValue = Math.round(base * multiplier);
                    } else {
                         el.innerText = Math.round(base * multiplier); // Fallback
                         // Re-add unit if lost (simple way)
                         // But better to preserve structure.
                         // The structure is: textNode + span.unit-text
                    }
                }
            });
        }

        // Override/Update updateOverallSummary to respect multiplier
        function updateOverallSummary() {
            let totalWeight = 0;
            let totalCost = 0;

            variations.forEach(v => {
                totalWeight += v.baseWeight * v.count;
                totalCost += v.baseCost * v.count;
            });
            
            const weightEl = document.getElementById('overallTotalWeight');
            if(weightEl) weightEl.innerHTML = Math.round(totalWeight) + '<span class="unit-text text-sm text-gray-500 ml-1">g</span>';
            
            // Update Cost
            const costEl = document.getElementById('totalCost');
            if(costEl) costEl.textContent = totalCost.toFixed(2);
        }

        // Toggle Recipe Info Logic
        function toggleRecipeInfo() {
            const container = document.getElementById('recipeInfoContainer');
            const icon = document.getElementById('infoToggleIcon');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                icon.classList.replace('fa-chevron-right', 'fa-chevron-down');
            } else {
                container.classList.add('hidden');
                icon.classList.replace('fa-chevron-down', 'fa-chevron-right');
            }
        }

        function toggleVariationMode() {
            if (variations.length === 1) {
                // Switch to 2 variations
                variations = [
                    { id: 'var1', name: 'ç»å…¸åŸå‘³', count: 1, baseWeight: 470, baseCost: 11.44 },
                    { id: 'var2', name: 'å¯å¯é£å‘³', count: 1, baseWeight: 450, baseCost: 12.50 }
                ];
            } else {
                // Switch to 1 variation
                variations = [
                    { id: 'base', name: 'ç»å…¸è›‹ç³•', count: 1, baseWeight: 420, baseCost: 11.44 }
                ];
            }
            initVariationDisplay();
            scaleIngredients();
            toggleMoreMenu();
        }

        // Initialize Variation Logic
        document.addEventListener('DOMContentLoaded', () => {
            initVariationDisplay();
        });
    </script>
</body>
</html>