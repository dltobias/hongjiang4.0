<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å»ºé…æ–¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet">
    <style>
        /* æ¸å˜è‰²å½©å®šä¹‰ - ä¸é¦–é¡µä¿æŒä¸€è‡´ */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-recipe {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .gradient-message {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .gradient-inventory {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .gradient-order {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        /* å¼ºåˆ¶åˆ·æ–°æš—é»‘æ¨¡å¼çš„è¾…åŠ©ç±» */
        .dark-force-refresh {}
        .dark-handle {}
        
        /* ä¸»é¢˜åŸºç¡€å˜é‡ */
        :root {
            /* Light Theme */
            --light-bg: #f9fafb;
            --light-card-bg: #FFFFFF;
            --light-text: #1E293B;
            --light-border: #e5e7eb;
            --light-hover: #f3f4f6;
            
            /* Dark Theme */
            --dark-bg: #0F172A;
            --dark-card-bg: #1E293B;
            --dark-text: #F1F5F9;
            --dark-border: #334155;
            --dark-hover: #1E3A8A;
            
            /* Japanese Theme */
            --jp-bg: #F7F6F2;
            --jp-card-bg: #FFFCF7;
            --jp-text: #2C2C2C;
            --jp-border: #E5E2D9;
            --jp-accent: #D64F45;
            --jp-hover: #FFF1EC;
            
            /* Korean Theme */
            --kr-bg: #F3F7F6;
            --kr-card-bg: #FFFFFF;
            --kr-text: #363B3A;
            --kr-border: #DDE7E5;
            --kr-accent: #98C6BE;
            --kr-hover: #E8F3F1;
        }

        /* ä¸»é¢˜åˆ‡æ¢å™¨æ ·å¼ */
        .theme-switcher {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            border-radius: 1rem;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            border: 1px solid var(--light-border);
        }

        .theme-option {
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-option:hover {
            transform: scale(1.1);
        }

        .theme-option.active {
            box-shadow: 0 0 0 2px var(--light-border);
        }

        /* Light Theme */
        .theme-light {
            background: var(--light-bg);
            color: var(--light-text);
        }

        .theme-light .card {
            background: var(--light-card-bg);
            border-color: var(--light-border);
        }

        /* Dark Theme */
        .theme-dark {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        .theme-dark .card {
            background: var(--dark-card-bg);
            border-color: var(--dark-border);
        }

        /* Japanese Theme */
        .theme-jp {
            background: var(--jp-bg);
            color: var(--jp-text);
        }

        .theme-jp .card {
            background: var(--jp-card-bg);
            border-color: var(--jp-border);
        }

        .theme-jp .btn-primary {
            background: var(--jp-accent);
        }

        /* Korean Theme */
        .theme-kr {
            background: var(--kr-bg);
            color: var(--kr-text);
        }

        .theme-kr .card {
            background: var(--kr-card-bg);
            border-color: var(--kr-border);
        }

        .theme-kr .btn-primary {
            background: var(--kr-accent);
        }

        /* åŸºç¡€ä¸»é¢˜æ ·å¼ */
        html, body { 
            background: #f9fafb; 
            transition: all 0.3s ease;
        }
        .dark html, .dark body { 
            background: #0F172A; 
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { 
            border-radius: 12px; 
            box-shadow: 0 4px 12px 0 rgba(0,0,0,0.1); 
            background: #FFFFFF; 
            border: 1px solid #e5e7eb; 
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .dark .card { 
            background: #1E293B; 
            box-shadow: 0 4px 20px 0 rgba(0,0,0,0.25); 
            border: 1px solid #334155; 
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        #themeToggleBtn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: white;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .dark #themeToggleBtn {
            background: #334155;
            border-color: #475569;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        #themeToggleBtn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .dark #themeToggleBtn:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* æ–‡æœ¬é¢œè‰² */
        .text-primary {
            color: #1E293B;
            transition: color 0.3s ease;
        }
        .dark .text-primary {
            color: #F1F5F9;
        }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        input, textarea {
            transition: all 0.3s ease;
        }
        .dark input, .dark textarea {
            background: #1E293B;
            color: #F1F5F9;
            border-color: #475569;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn-primary {
            transition: all 0.3s ease;
        }
        .dark .btn-primary {
            background: linear-gradient(135deg, #8B5CF6, #A855F7);
            color: #F1F5F9;
        }

        /* æ­¥éª¤å¡ç‰‡æ ·å¼ */
        .step-card {
            transition: all 0.3s ease;
        }
        .dark .step-card {
            background: #1E293B;
            border-color: #334155;
        }

        .input-shadow:focus { box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); border-color: #667eea; }
        .tab-active { color: #667eea !important; }
        .tab-inactive { color: #6b7280 !important; }
        .tab-bg-active { background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)) !important; border: 1px solid #667eea; }
        .tab-bg-inactive { background: #FFFFFF !important; border: 1px solid #e5e7eb; }
        .dark .tab-bg-active { background: #1E3A8A !important; border: 1px solid #667eea; }
        .dark .tab-bg-inactive { background: #1E293B !important; border: 1px solid #334155; }
        .transition-all { transition: all 0.2s cubic-bezier(.4,0,.2,1); }
        .bottom-bar { border-radius: 24px 24px 0 0; }
        .group-blue { background: #E8F0FE; }
        .group-yellow { background: #FFF7E0; }
        .group-pink { background: #FDE7EF; }
        .group-green { background: #E6F6EC; }
        .group-gray { background: #F3F4F6; }
        .dark .group-blue { background: #22304a; }
        .dark .group-yellow { background: #4a3e22; }
        .dark .group-pink { background: #4a2230; }
        .dark .group-green { background: #224a30; }
        .dark .group-gray { background: #23272f; }
        .sop-step-row { transition: all 0.2s ease; }
        .sop-step-row:hover { background: #2a2f3a !important; }
        .dark .sop-step-row:hover { background: #2a2f3a !important; }
        .sop-menu-dropdown { min-width: 100px; }
        .sop-drag-handle:active { cursor: grabbing !important; }
        .sop-type-modal { backdrop-filter: blur(8px); }
        .sop-type-grid { max-height: 60vh; }
        .sop-type-item { transition: all 0.15s ease; }
        .sop-type-item:hover { background: rgba(59, 130, 246, 0.1) !important; transform: translateY(-1px); }
        .sop-step-input { background: rgba(255,255,255,0.05) !important; }
        .sop-step-input:focus { background: rgba(255,255,255,0.1) !important; }
        .step-row { transition: all 0.3s ease; background: #FFFFFF !important; border: 1px solid #E2E8F0 !important; }
        .step-row:hover { background: #F8FAFC !important; border-color: #CBD5E1 !important; transform: translateY(-1px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .dark .step-row { background: #1E293B !important; border: 1px solid #334155 !important; }
        .dark .step-row:hover { background: #0F172A !important; border-color: #475569 !important; }
        .media-upload-area { transition: all 0.2s ease; background: #F1F5F9; border: 2px dashed #CBD5E1; }
        .media-upload-area:hover { border-color: #8B5CF6 !important; background: rgba(139, 92, 246, 0.05) !important; }
        .dark .media-upload-area { background: #0F172A; border-color: #475569; }
        .media-preview { position: relative; overflow: hidden; }
        .media-preview .remove-btn { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); }
        .step-number { background: linear-gradient(135deg, #667eea, #764ba2); }
        .video-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .crop-container { max-width: 100%; max-height: 400px; }
        .crop-preview { width: 120px; height: 120px; border-radius: 12px; overflow: hidden; border: 2px solid #E2E8F0; }
        .dark .crop-preview { border-color: #334155; }
        
        /* æ­¥éª¤å›¾ç‰‡æ¨ªå‘æ»šåŠ¨æ ·å¼ */
        .snap-x {
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .snap-x::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        .snap-center {
            scroll-snap-align: center;
        }
        
        .drag-handle-enhanced { 
            background: linear-gradient(135deg, #E2E8F0, #CBD5E1); 
            border-radius: 8px; 
            padding: 8px; 
            cursor: grab; 
            transition: all 0.2s ease;
            border: 1px solid #94A3B8;
        }
        .drag-handle-enhanced:hover { 
            background: linear-gradient(135deg, #CBD5E1, #94A3B8); 
            transform: scale(1.05); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .drag-handle-enhanced:active { cursor: grabbing; transform: scale(0.95); }
        .dark .drag-handle-enhanced { 
            background: linear-gradient(135deg, #334155, #475569); 
            border-color: #64748B;
        }
        .dark .drag-handle-enhanced:hover { 
            background: linear-gradient(135deg, #475569, #64748B); 
        }
        .sop-step-enhanced { 
            background: #FFFFFF !important; 
            border: 1px solid #E2E8F0 !important; 
            transition: all 0.3s ease;
        }
        .sop-step-enhanced:hover { 
            background: #F8FAFC !important; 
            border-color: #CBD5E1 !important; 
            transform: translateY(-1px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .dark .sop-step-enhanced { 
            background: #1E293B !important; 
            border: 1px solid #334155 !important; 
        }
        .dark .sop-step-enhanced:hover { 
            background: #0F172A !important; 
            border-color: #475569 !important; 
        }

        /* æ·»åŠ å·¦æ»‘åˆ é™¤ç›¸å…³æ ·å¼ */
        .ingredient-item {
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
            transform: translateX(0);
            transition: transform 0.3s ease;
            width: 100%;
        }

        .ingredient-item .delete-action {
            position: absolute;
            right: -80px; /* åˆå§‹æ—¶å®Œå…¨åœ¨è§†å›¾å¤– */
            top: 0;
            bottom: 0;
            width: 80px;
            background-color: #F44336;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            z-index: 10; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
            font-size: 16px;
            text-align: center;
        }

        .ingredient-item.swiping {
            transition: none;
        }

        /* åŒæ­¥çŠ¶æ€çš„æ ·å¼ */
        .name-input {
            transition: all 0.3s ease;
        }

        .name-input.synced {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.05);
        }

        .name-input.not-synced {
            border-color: #F44336;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            transition: all 0.3s ease;
        }

        .sync-indicator.synced {
            background-color: #4CAF50;
        }

        .sync-indicator.not-synced {
            background-color: #F44336;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-[#0F172A] text-gray-800 dark:text-slate-100">
    <div class="max-w-md mx-auto min-h-screen flex flex-col bg-gray-50 dark:bg-[#0F172A]">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="sticky top-0 z-50 bg-white dark:bg-[#1E293B] flex items-center justify-between px-4 py-3 card border-b border-gray-200 dark:border-slate-600">
            <button class="text-gray-500 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-[#334155] active:scale-95 transition rounded-full p-2" onclick="checkExitConfirmation()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <span class="text-lg font-bold flex-1 text-center text-gray-800 dark:text-slate-100 tracking-wide">æ–°å»ºé…æ–¹</span>
            <div class="flex gap-2 items-center">
                <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-full p-2 transition" title="æ‹ç…§è¯†åˆ«" onclick="openCamera()"><i class="fas fa-camera-retro"></i></button>
                <!-- è¿˜åŸä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
                <button id="themeToggleBtn" class="ml-2 text-xl hover:bg-gray-100 dark:hover:bg-[#334155] active:scale-90 rounded-full p-2 transition" onclick="toggleTheme()">
                    <span id="themeIcon">ğŸŒ™</span>
                </button>
            </div>
        </div>
        <!-- å›¾ç‰‡ä¸Šä¼ åŒº -->
        <div class="relative mx-4 mt-4 mb-2">
            <input type="file" id="coverImage" class="hidden" accept="image/*">
            <label for="coverImage" class="block w-full h-40 card flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-purple-500 hover:border-purple-600 transition-all">
                <div id="imagePreview" class="w-full h-full flex flex-col items-center justify-center text-purple-600 dark:text-purple-400">
                    <i class="fas fa-camera text-3xl mb-2"></i>
                    <span>ç‚¹å‡»ä¸Šä¼ å°é¢å›¾ç‰‡</span>
                </div>
            </label>
        </div>
        <!-- Tabåˆ‡æ¢åŒº -->
        <div class="flex bg-white dark:bg-[#1E293B] rounded-xl mx-4 mt-2 mb-4 overflow-hidden card">
            <button id="tab-btn-recipe" class="flex-1 flex flex-col items-center py-3 text-center font-semibold tab-btn tab-active tab-bg-active gap-1 hover:bg-[#EFF6FF] dark:hover:bg-[#1E3A8A] active:scale-95 transition-all" onclick="switchTab('recipe')">
                <i class="fas fa-bread-slice text-lg mb-1"></i>
                <span class="mt-1">é…æ–¹</span>
            </button>
            <button id="tab-btn-sop" class="flex-1 flex flex-col items-center py-3 text-center font-semibold tab-btn tab-inactive tab-bg-inactive gap-1 hover:bg-[#EFF6FF] dark:hover:bg-[#1E3A8A] active:scale-95 transition-all" onclick="switchTab('sop')">
                <i class="fas fa-list-alt text-lg mb-1"></i>
                <span class="mt-1">SOP</span>
            </button>
            <button id="tab-btn-step" class="flex-1 flex flex-col items-center py-3 text-center font-semibold tab-btn tab-inactive tab-bg-inactive gap-1 hover:bg-[#EFF6FF] dark:hover:bg-[#1E3A8A] active:scale-95 transition-all" onclick="switchTab('step')">
                <i class="fas fa-tasks text-lg mb-1"></i>
                <span class="mt-1">æ­¥éª¤</span>
            </button>
        </div>
        <!-- åˆ†ç±»é€‰æ‹©ï¼ˆä»…åœ¨é…æ–¹é¡µé¢æ˜¾ç¤ºï¼‰ -->
        <div id="recipe-meta-section" class="space-y-2 mb-4 px-4">
            <input type="text" placeholder="é…æ–¹åç§° *" class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-slate-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-500 outline-none bg-white dark:bg-[#1E293B] text-gray-600 dark:text-slate-400 input-shadow">
            <div class="relative">
                <select id="categorySelect" class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-slate-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-500 outline-none bg-white dark:bg-[#1E293B] text-gray-600 dark:text-slate-400 appearance-none cursor-pointer">
                    <option value="">é€‰æ‹©åˆ†ç±» *</option>
                    <option value="bread">é¢åŒ…</option>
                    <option value="cake">è›‹ç³•</option>
                    <option value="drink">é¥®å“</option>
                    <option value="other">å…¶ä»–</option>
                </select>
                <button onclick="openCategoryModal()" class="absolute right-2 top-1/2 -translate-y-1/2 text-purple-600 dark:text-purple-400 text-lg hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-full p-1 transition-all" title="æ–°å»ºç±»åˆ«"><i class="fas fa-plus-circle"></i></button>
            </div>
        </div>
        <!-- åŸæ–™åˆ†ç»„åŒºï¼ˆç»Ÿä¸€è®¾è®¡é£æ ¼ï¼‰ -->
        <div class="space-y-4 flex-1 overflow-y-auto px-4 pb-32" id="recipe-section">
            <!-- é…æ–¹è¯´æ˜å¡ç‰‡ -->
            <div class="mt-4 mb-4">
                <div class="card p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 gradient-primary rounded-full flex items-center justify-center">
                            <i class="fas fa-bread-slice text-white text-sm"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 dark:text-slate-100">é…æ–¹ç»„æˆ</h3>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-slate-400">æŒ‰åˆ†ç»„ç®¡ç†åŸæ–™é…æ¯”ï¼Œæ”¯æŒç™¾åˆ†æ¯”è®¡ç®—å’Œæˆæœ¬æ ¸ç®—</p>
                </div>
            </div>
            <div class="card p-4">
                <div class="flex justify-between items-center mb-3 bg-gray-50 dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gray-50 dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-bread-slice text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 dark:text-slate-100">é¢ç²‰ (åŸºå‡†100%)</h3>
                    </div>
                </div>
                <div id="flourIngredients" class="space-y-2"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('flour')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ é¢ç²‰</span>
                    </button>
                </div>
            </div>
            <div class="card p-4">
                <div class="flex justify-between items-center mb-3 bg-gray-50 dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gray-50 dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-seedling text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 dark:text-slate-100">ç§é¢</h3>
                    </div>
                </div>
                <div id="starterIngredients" class="space-y-2"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('starter')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ ç§é¢</span>
                    </button>
                </div>
            </div>
            <div class="card p-4">
                <div class="flex justify-between items-center mb-3 bg-gray-50 dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gray-50 dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-prescription-bottle text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 dark:text-slate-100">å¹²æ–™</h3>
                    </div>
                </div>
                <div id="dryIngredients" class="space-y-2"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('dry')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ å¹²æ–™</span>
                    </button>
                </div>
            </div>
            <div class="card p-4">
                <div class="flex justify-between items-center mb-3 bg-gray-50 dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gray-50 dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-tint text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 dark:text-slate-100">æ¹¿æ–™</h3>
                    </div>
                </div>
                <div id="wetIngredients" class="space-y-2"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('wet')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ æ¹¿æ–™</span>
                    </button>
                </div>
            </div>
            <div class="card p-4">
                <div class="flex justify-between items-center mb-3 bg-gray-50 dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gray-50 dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-mortar-pestle text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 dark:text-slate-100">è¾…æ–™</h3>
                    </div>
                </div>
                <div id="auxIngredients" class="space-y-2"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('aux')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ è¾…æ–™</span>
                    </button>
                </div>
            </div>
            <div class="card p-4">
                <div class="flex justify-between items-center mb-3 bg-gray-50 dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gray-50 dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-bread-slice text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 dark:text-slate-100">åŸºç¡€é¢å›¢ <span class="text-red-500 dark:text-red-400">*</span></h3>
                    </div>
                </div>
                <div id="baseIngredients" class="space-y-2"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('base')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ åŸºç¡€é¢å›¢</span>
                    </button>
                </div>
            </div>
            <div id="variationList"></div>
            <div class="flex justify-end mt-3">
                <button id="addVariationBtn" class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm">
                    <i class="fas fa-plus mr-1"></i>
                    <span>æ·»åŠ å˜åŒ–æ¬¾</span>
                </button>
            </div>
        </div>
        
        <!-- SOPæ­¥éª¤åˆ—è¡¨åŒºï¼ˆç»Ÿä¸€è®¾è®¡é£æ ¼ï¼‰ -->
        <div class="flex-1 flex flex-col pb-32 hidden" id="sop-section">
            <!-- SOPæ“ä½œè¯´æ˜å¡ç‰‡ -->
            <div class="mx-4 mt-4 mb-4">
                <div class="card p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 gradient-primary rounded-full flex items-center justify-center">
                            <i class="fas fa-list-alt text-white text-sm"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 dark:text-slate-100">æ ‡å‡†ä½œä¸šç¨‹åº</h3>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-slate-400">è®¾å®šæ¯ä¸ªæ­¥éª¤çš„å…·ä½“å‚æ•°å’Œè¦æ±‚ï¼Œç¡®ä¿åˆ¶ä½œæ ‡å‡†åŒ–</p>
                </div>
            </div>
            <!-- SOPæ­¥éª¤åˆ—è¡¨ -->
            <div class="flex-1 flex flex-col gap-3 px-4 py-2 overflow-y-auto" id="sopStepsList">
                <!-- SOPæ­¥éª¤è¡Œå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <!-- æ·»åŠ SOPæ­¥éª¤æŒ‰é’® -->
            <div class="mx-4 my-4">
                <button id="addSopStepBtn" class="w-full py-3 rounded-xl card text-purple-600 dark:text-purple-400 font-semibold hover:bg-purple-50 dark:hover:bg-[#1E3A8A] active:scale-95 transition-all border border-gray-200 dark:border-slate-600 flex items-center justify-center gap-2" onclick="addSopStep()">
                    <i class="fas fa-plus"></i>
                    <span>æ·»åŠ SOPæ­¥éª¤</span>
                </button>
            </div>
            <!-- å¤‡æ³¨åŒºåŸŸ -->
            <div class="mx-4 mb-4">
                <div class="card p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-sticky-note text-purple-600 dark:text-purple-400"></i>
                        <h4 class="font-medium text-gray-800 dark:text-slate-100">SOPå¤‡æ³¨</h4>
                    </div>
                    <div class="relative">
                        <textarea id="sopRemark" class="w-full px-4 py-3 text-sm bg-gray-50 dark:bg-[#0F172A] border border-gray-200 dark:border-slate-600 rounded-xl outline-none resize-none text-gray-800 dark:text-slate-100 placeholder-gray-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 transition" placeholder="è¯·è¾“å…¥SOPç›¸å…³å¤‡æ³¨..." maxlength="100" rows="3"></textarea>
                        <div class="absolute bottom-2 right-3 text-xs text-slate-500 dark:text-slate-400" id="sopRemarkCount">0/100</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ­¥éª¤ç¼–è¾‘åŒºï¼ˆç»Ÿä¸€è®¾è®¡é£æ ¼ï¼‰ -->
        <div class="flex-1 flex flex-col pb-32 hidden" id="step-section">
            <!-- æ­¥éª¤æ“ä½œè¯´æ˜å¡ç‰‡ -->
            <div class="mx-4 mt-4 mb-4">
                <div class="card p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 gradient-primary rounded-full flex items-center justify-center">
                            <i class="fas fa-tasks text-white text-sm"></i>
                        </div>
                        <h3 class="font-semibold text-[#1E293B] dark:text-slate-100">åˆ¶ä½œæ­¥éª¤</h3>
                    </div>
                    <p class="text-sm text-slate-600 dark:text-slate-400">è¯¦ç»†è®°å½•æ¯ä¸ªåˆ¶ä½œç¯èŠ‚ï¼Œæ”¯æŒå›¾ç‰‡å’Œè§†é¢‘è¯´æ˜</p>
                </div>
            </div>
            
            <!-- æç¤ºä¿¡æ¯ -->
            <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-3 mx-4 mb-4 flex items-center">
                <i class="fas fa-info-circle text-purple-500 mr-2"></i>
                <p class="text-sm text-purple-700 dark:text-purple-300">ç‚¹å‡»å›¾ç‰‡æˆ–<i class="fas fa-search-plus mx-1"></i>å›¾æ ‡å¯æŸ¥çœ‹å¤§å›¾</p>
            </div>
            
            <!-- æ­¥éª¤åˆ—è¡¨ -->
            <div id="stepsList" class="px-4 space-y-8"></div>
            
            <!-- æ·»åŠ æ­¥éª¤æŒ‰é’® -->
            <div class="px-4 mt-4">
                <button class="w-full py-3 rounded-xl card text-purple-600 dark:text-purple-400 font-semibold hover:bg-purple-50 dark:hover:bg-purple-900/20 active:scale-95 transition-all border border-slate-200 dark:border-slate-600" onclick="addStep()">
                    <i class="fas fa-plus mr-2"></i> æ·»åŠ æ­¥éª¤
                </button>
            </div>
        </div>
        <!-- åº•éƒ¨å›ºå®šæ ï¼šæ€»é‡å¡ç‰‡+ä¿å­˜æŒ‰é’®å¹¶åˆ— -->
        <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-[#1E293B] py-3 px-4 z-50 card bottom-bar border-t border-gray-200 dark:border-slate-600">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <div class="flex items-center">
                    <div class="rounded-lg border border-gray-200 dark:border-slate-600 bg-gray-50 dark:bg-[#0F172A] px-3 py-2 flex flex-col items-center">
                        <div class="text-gray-600 dark:text-slate-400 text-xs">é¢å›¢æ€»é‡</div>
                        <div class="text-sm font-bold text-purple-600 dark:text-purple-400"><span id="totalWeight">0</span></div>
                    </div>
                </div>
                <button id="saveBtn" class="gradient-primary hover:from-[#764ba2] hover:to-[#667eea] active:scale-95 text-white px-4 py-2 rounded-lg font-medium text-sm shadow-md transition-all">ä¿å­˜é…æ–¹</button>
            </div>
        </div>
        
        <!-- å›¾ç‰‡å…¨å±é¢„è§ˆ -->
        <div id="fullImageModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden" onclick="this.classList.add('hidden')">
            <img src="" alt="å›¾ç‰‡å¤§å›¾" class="max-w-[90vw] max-h-[90vh] object-contain rounded-xl">
            <button class="absolute top-4 right-4 bg-white bg-opacity-20 text-white rounded-full p-3 hover:bg-opacity-40 transition-all" onclick="event.stopPropagation(); this.parentElement.classList.add('hidden')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- å•ä½é€‰æ‹©å¼¹çª—ï¼ˆå¸¸é©»DOMï¼Œé»˜è®¤hiddenï¼‰ -->
        <div id="unit-popup" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm transition-all">
            <div class="bg-white dark:bg-[#1E293B] rounded-2xl p-6 min-w-[300px] max-w-[90vw] shadow-2xl border border-slate-200 dark:border-slate-600 transform transition-all">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-slate-100">é€‰æ‹©å•ä½</h3>
                    <button onclick="closeUnitSelect()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                        <i class="fas fa-times"></i>
                    </button>
            </div>
                
                <!-- Tabåˆ‡æ¢æŒ‰é’®ç»„ -->
                <div class="flex gap-2 mb-6 bg-slate-100 dark:bg-slate-800 p-1 rounded-xl" id="unit-tab-btns">
                    <!-- TabæŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
                
                <!-- å•ä½åˆ—è¡¨å®¹å™¨ -->
                <div id="unit-popup-list" class="grid grid-cols-3 gap-2 max-h-[40vh] overflow-y-auto pr-2 mb-4">
                    <!-- å•ä½é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ææ–™åç§°æ£€ç´¢å¼¹çª—ï¼ˆå¸¸é©»DOMï¼Œé»˜è®¤hiddenï¼‰ -->
        <div id="material-popup" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-30 hidden">
            <div class="bg-white dark:bg-[#1E293B] card p-4 min-w-[220px] border border-gray-200 dark:border-slate-600">
                <div class="font-semibold mb-2 text-gray-800 dark:text-slate-100">é€‰æ‹©ææ–™</div>
                <div id="material-popup-list" class="flex flex-col gap-2 max-h-60 overflow-y-auto"></div>
                <button onclick="closeMaterialSearch()" class="mt-3 w-full py-1 rounded bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
            </div>
        </div>
        <!-- æ–°å»ºç±»åˆ«å¼¹çª— -->
        <div id="categoryModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-30 hidden">
            <div class="bg-white dark:bg-[#1E293B] card p-6 min-w-[220px] border border-slate-200 dark:border-slate-600">
                <div class="font-semibold mb-2 text-gray-800 dark:text-slate-100">æ–°å»ºç±»åˆ«</div>
                <input id="newCategoryInput" class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-slate-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 outline-none bg-white dark:bg-[#0F172A] text-gray-800 dark:text-slate-100 mb-3" placeholder="è¾“å…¥æ–°ç±»åˆ«åç§°">
                <div class="flex gap-2">
                    <button onclick="closeCategoryModal()" class="flex-1 py-2 rounded bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
                    <button onclick="addNewCategory()" class="flex-1 py-2 rounded gradient-primary text-white font-semibold hover:from-[#764ba2] hover:to-[#667eea] active:scale-95 transition-all">ç¡®å®š</button>
                </div>
            </div>
        </div>
        
        <!-- SOPç±»å‹é€‰æ‹©å¼¹çª— -->
        <div id="sopTypeModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-70 sop-type-modal hidden">
            <div class="bg-white dark:bg-[#1E293B] rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 border border-slate-200 dark:border-slate-600">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-gray-800 dark:text-slate-100 font-semibold text-xl">SOPæ­¥éª¤ç±»å‹é¢„è§ˆ</h3>
                    <button onclick="closeSopTypeModal()" class="text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xl active:scale-90 transition">Ã—</button>
                </div>
                <div id="sopTypeList">
                    <!-- SOPç±»å‹åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- æ­¥éª¤æ“ä½œèœå•å¼¹çª— -->
        <div id="stepMenuModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white dark:bg-white rounded-2xl shadow-2xl p-0 max-w-xs w-full mx-4 overflow-hidden">
                <button id="stepMenuDelete" class="w-full px-6 py-4 text-red-600 text-lg font-medium hover:bg-red-50 active:bg-red-100 transition border-b border-gray-200">
                    åˆ é™¤
                </button>
                <button id="stepMenuAdd" class="w-full px-6 py-4 text-purple-600 text-lg font-medium hover:bg-purple-50 active:bg-purple-100 transition border-b border-gray-200">
                    æ·»åŠ ä¸€è¡Œ
                </button>
                <button onclick="closeStepMenuModal()" class="w-full px-6 py-4 text-gray-600 text-lg font-medium hover:bg-gray-50 active:bg-gray-100 transition">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
        
        <!-- åª’ä½“ä¸Šä¼ é€‰æ‹©å¼¹çª— -->
        <div id="mediaUploadModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white dark:bg-white rounded-2xl shadow-2xl p-0 max-w-xs w-full mx-4 overflow-hidden">
                <button onclick="selectImage()" class="w-full px-6 py-4 text-purple-600 text-lg font-medium hover:bg-purple-50 active:bg-purple-100 transition border-b border-gray-200">
                    <i class="fas fa-image mr-2"></i>é€‰æ‹©å›¾ç‰‡
                </button>
                <button onclick="selectVideo()" class="w-full px-6 py-4 text-green-600 text-lg font-medium hover:bg-green-50 active:bg-green-100 transition border-b border-gray-200">
                    <i class="fas fa-video mr-2"></i>é€‰æ‹©è§†é¢‘
                </button>
                <button onclick="captureMedia()" class="w-full px-6 py-4 text-purple-600 text-lg font-medium hover:bg-purple-50 active:bg-purple-100 transition border-b border-gray-200">
                    <i class="fas fa-camera mr-2"></i>æ‹ç…§/å½•åƒ
                </button>
                <button onclick="closeMediaUploadModal()" class="w-full px-6 py-4 text-gray-600 text-lg font-medium hover:bg-gray-50 active:bg-gray-100 transition">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
        
        <!-- å›¾ç‰‡è£å‰ªå¼¹çª— -->
        <div id="cropModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white dark:bg-[#1E293B] rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 border border-slate-200 dark:border-slate-600">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-gray-800 dark:text-slate-100 font-semibold text-lg">è£å‰ªå›¾ç‰‡</h3>
                    <button onclick="closeCropModal()" class="text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xl active:scale-90 transition">Ã—</button>
                </div>
                
                <div class="space-y-4">
                    <!-- è£å‰ªåŒºåŸŸ -->
                    <div class="crop-container">
                        <img id="cropImage" style="max-width: 100%; display: block;">
                    </div>
                    
                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-slate-600 dark:text-slate-400">é¢„è§ˆæ•ˆæœï¼š</div>
                        <div class="crop-preview" id="cropPreview"></div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex gap-3">
                        <button onclick="closeCropModal()" class="flex-1 py-2 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
                        <button onclick="confirmCrop()" class="flex-1 py-2 rounded-lg gradient-primary text-white font-semibold hover:from-[#764ba2] hover:to-[#667eea] active:scale-95 transition-all">ç¡®å®šè£å‰ª</button>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- åˆ†äº«å¼¹çª— -->
    <div id="shareModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white dark:bg-[#1E293B] rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 border border-slate-200 dark:border-slate-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-gray-800 dark:text-slate-100 font-semibold text-2xl">åˆ†äº«é£Ÿè°±</h3>
                <button onclick="closeShareModal()" class="text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xl active:scale-90 transition">Ã—</button>
            </div>
            
            <div class="mb-8">
                <p class="text-slate-600 dark:text-slate-400 mb-2">é€‰æ‹©åˆ†äº«å¹³å°</p>
                
                <!-- å›½å†…å¹³å° -->
                <div class="mainland-platforms">
                    <h4 class="text-xl font-medium mb-4">å›½å†…</h4>
                    <div class="grid grid-cols-4 gap-6">
                        <!-- å¾®ä¿¡æœ‹å‹åœˆ -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('wechat')">
                            <div class="w-14 h-14 bg-[#4CCA5A] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-weixin text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">å¾®ä¿¡æœ‹å‹åœˆ</span>
                        </div>
                        <!-- æŠ–éŸ³ -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('douyin')">
                            <div class="w-14 h-14 bg-black rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-tiktok text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">æŠ–éŸ³</span>
                        </div>
                        <!-- å°çº¢ä¹¦ -->
                        <div class="flex flex-col items-center" onclick="openXiaohongshuModal()">
                            <div class="w-14 h-14 bg-[#FE2C55] rounded-full flex items-center justify-center mb-2">
                                <i class="fas fa-book text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">å°çº¢ä¹¦</span>
                        </div>
                        <!-- çƒ˜åŒ å¹³å° -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('hongjang')">
                            <div class="w-14 h-14 bg-[#FF9F2E] rounded-full flex items-center justify-center mb-2">
                                <i class="fas fa-bread-slice text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">çƒ˜åŒ å¹³å°</span>
                        </div>
                    </div>
                </div>
                
                <!-- å›½å¤–å¹³å° -->
                <div class="foreign-platforms hidden">
                    <h4 class="text-xl font-medium mb-4 mt-6">å›½å¤–</h4>
                    <div class="grid grid-cols-4 gap-6">
                        <!-- Instagram -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('instagram')">
                            <div class="w-14 h-14 bg-gradient-to-tr from-[#FF8A00] via-[#DD2A7B] to-[#8134AF] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-instagram text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">Instagram</span>
                        </div>
                        <!-- Facebook -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('facebook')">
                            <div class="w-14 h-14 bg-[#1877F2] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-facebook-f text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">Facebook</span>
                        </div>
                        <!-- LINE -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('line')">
                            <div class="w-14 h-14 bg-[#06C755] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-line text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">LINE</span>
                        </div>
                        <!-- Twitter -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('twitter')">
                            <div class="w-14 h-14 bg-[#1DA1F2] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-twitter text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">Twitter</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-6 mt-6">
                        <!-- Telegram -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('telegram')">
                            <div class="w-14 h-14 bg-[#0088CC] rounded-full flex items-center justify-center mb-2">
                                <i class="fab fa-telegram-plane text-white text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">Telegram</span>
                        </div>
                        <!-- KakaoTalk -->
                        <div class="flex flex-col items-center" onclick="shareToSpecificPlatform('kakaotalk')">
                            <div class="w-14 h-14 bg-[#FEE500] rounded-full flex items-center justify-center mb-2">
                                <i class="fas fa-comment text-black text-2xl"></i>
                            </div>
                            <span class="text-sm text-center">KakaoTalk</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å–æ¶ˆæŒ‰é’® -->
            <div class="w-full">
                <button onclick="closeShareModal()" class="w-full py-4 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-medium text-lg hover:bg-gray-200 dark:hover:bg-gray-700 active:scale-95 transition-all">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    
    <!-- å°çº¢ä¹¦åˆ†äº«ç•Œé¢ -->
    <div id="xiaohongshuShareModal" class="fixed z-50 left-0 top-0 w-full h-full flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white dark:bg-[#1E293B] rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 border border-slate-200 dark:border-slate-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-gray-800 dark:text-slate-100 font-semibold text-2xl">åˆ†äº«åˆ°å°çº¢ä¹¦</h3>
                <button onclick="closeXiaohongshuModal()" class="text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xl active:scale-90 transition">Ã—</button>
            </div>
            
            <div class="space-y-6">
                <!-- ç”¨æˆ·IDå’Œçƒ˜åŒ APPæ¨å¹¿ä¿¡æ¯ -->
                <div class="bg-[#FFF9F9] dark:bg-[#2D1B1B] p-4 rounded-lg border border-[#FFDED8] dark:border-[#4D2D2A]">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-[#FE2C55] rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500 dark:text-slate-400">ç”¨æˆ·ID</p>
                            <p class="font-semibold" id="shareUserId">YJ238961</p>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-slate-400">
                        åˆ†äº«æ­¤é…æ–¹ï¼Œé‚€è¯·æœ‹å‹ä¸€èµ·ä½¿ç”¨<span class="text-[#FE2C55] font-bold">ã€çƒ˜åŒ APPã€‘</span>åˆ¶ä½œç¾é£Ÿï¼
                    </div>
                </div>
                
                <!-- åˆ†äº«å†…å®¹é¢„è§ˆ -->
                <div class="border border-slate-200 dark:border-slate-600 rounded-lg p-4">
                    <h4 class="font-medium mb-2">åˆ†äº«å†…å®¹é¢„è§ˆ</h4>
                    <div class="flex items-start">
                        <div class="w-20 h-20 bg-slate-100 dark:bg-slate-700 rounded-lg overflow-hidden flex-shrink-0 mr-3">
                            <img src="" alt="é…æ–¹å°é¢" id="sharePreviewImage" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <p class="font-medium mb-1" id="shareRecipeTitle">ç»å…¸åå¸é¢åŒ…é…æ–¹</p>
                            <p class="text-sm text-gray-600 dark:text-slate-400 line-clamp-2" id="shareRecipeDesc">æ¾è½¯é¦™ç”œçš„ç»å…¸åå¸ï¼Œå†…éƒ¨ç»„ç»‡ç»†è…»ï¼Œå…¥å£å³åŒ–ï¼Œé…æ–¹ç®€å•æ˜“ä¸Šæ‰‹ï¼</p>
                        </div>
                    </div>
                </div>
                
                <!-- æ¨å¹¿æ–‡æ¡ˆè¾“å…¥ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">æ·»åŠ æ¨å¹¿æ–‡æ¡ˆ</label>
                    <textarea class="w-full p-3 rounded-lg border border-gray-200 dark:border-slate-600 bg-white dark:bg-[#1E293B] text-gray-900 dark:text-slate-100 placeholder-gray-400" rows="3" placeholder="æ·»åŠ æ–‡æ¡ˆï¼Œè®©æ›´å¤šäººçœ‹åˆ°ä½ çš„ä½œå“...">ä»Šå¤©åˆ†äº«ä¸€æ¬¾è¶…å¥½åƒçš„é¢åŒ…é…æ–¹ï¼Œåœ¨çƒ˜åŒ APPä¸Šæ‰¾åˆ°çš„ï¼æ¨èå¤§å®¶éƒ½æ¥è¯•è¯•~ #çƒ˜ç„™ #é¢åŒ… #çƒ˜åŒ APP</textarea>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex gap-3">
                    <button onclick="closeXiaohongshuModal()" class="flex-1 py-3 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 font-medium hover:bg-gray-200 dark:hover:bg-slate-600 active:scale-95 transition-all">å–æ¶ˆ</button>
                    <button onclick="confirmXiaohongshuShare()" class="flex-1 py-3 rounded-lg bg-[#FE2C55] text-white font-medium hover:bg-[#E82147] active:scale-95 transition-all">åˆ†äº«åˆ°å°çº¢ä¹¦</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ‹ç…§è¯†åˆ«ç•Œé¢ -->
    <div id="cameraModal" class="fixed z-50 left-0 top-0 w-full h-full bg-black flex flex-col hidden">
        <!-- ç›¸æœºé¢„è§ˆåŒºåŸŸ -->
        <div id="cameraPreview" class="flex-1 bg-black hidden">
            <!-- å®é™…åº”ç”¨ä¸­è¿™é‡Œä¼šæ˜¾ç¤ºç›¸æœºé¢„è§ˆ -->
            <div class="w-full h-full relative overflow-hidden">
                <!-- æ¨¡æ‹Ÿç›¸æœºç•Œé¢ -->
                <div class="absolute inset-0 bg-gradient-to-b from-gray-700 to-gray-900 flex items-center justify-center">
                    <div class="text-white text-5xl opacity-30">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                
                <!-- æ‹ç…§é—ªå…‰æ•ˆæœ -->
                <div id="cameraFlash" class="absolute inset-0 bg-white hidden opacity-0 transition-opacity duration-200"></div>
                
                <!-- ç›¸æœºç½‘æ ¼å’Œå¯¹ç„¦å›¾æ ‡ -->
                <div class="absolute inset-0 grid grid-cols-3 grid-rows-3 pointer-events-none">
                    <div class="border-r border-b border-white/20"></div>
                    <div class="border-r border-l border-b border-white/20"></div>
                    <div class="border-l border-b border-white/20"></div>
                    <div class="border-r border-t border-b border-white/20"></div>
                    <div class="border-r border-l border-t border-b border-white/20 flex items-center justify-center">
                        <div class="w-12 h-12 border-2 border-purple-400 rounded-full opacity-50"></div>
                    </div>
                    <div class="border-l border-t border-b border-white/20"></div>
                    <div class="border-r border-t border-white/20"></div>
                    <div class="border-r border-l border-t border-white/20"></div>
                    <div class="border-l border-t border-white/20"></div>
                </div>
            </div>
        </div>
        
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="absolute top-0 left-0 right-0 p-4">
            <button class="text-white hover:bg-black/30 active:scale-95 transition rounded-full p-2" onclick="closeCamera()">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
        </div>
        
        <!-- åº•éƒ¨æ“ä½œåŒº -->
        <div class="bg-black py-6 px-4">
            <!-- è¯´æ˜æ–‡å­— -->
            <div class="text-white text-center mb-6">
                <p class="text-sm">æ‰‹å†™/ç”µå­é…æ–¹æœ¬ è‡ªåŠ¨è¯†åˆ«å¯å¿«é€Ÿåˆ›å»ºé…æ–¹</p>
            </div>
            
            <!-- æ‹ç…§æŒ‰é’® -->
            <div class="flex justify-center items-center">
                <button class="w-16 h-16 rounded-full bg-white flex items-center justify-center active:scale-95 transition" onclick="takePhoto()">
                    <div class="w-14 h-14 border-2 border-gray-300 rounded-full"></div>
                </button>
            </div>
        </div>
    </div>
    </div>
    <script>
        // åˆå§‹åŒ–æ‹–æ‹½æ’åº
        document.querySelectorAll('[id$="Ingredients"]').forEach(el => {
            new Sortable(el, {
                handle: '.drag-handle',
                animation: 150
            });
        });

        // å•ä½é€‰æ‹©å¼¹çª—ï¼ˆåˆ†åŒºtabï¼‰
        const unitTabs = [
            {name:'è´¨é‡å•ä½', icon:'fa-weight', list:['g','kg','mg','lb','oz']},
            {name:'ä½“ç§¯å•ä½', icon:'fa-flask', list:['ml','L','cup','tsp','tbsp']},
            {name:'è‡ªå®šä¹‰å•ä½', icon:'fa-edit', list:['è‡ªå®šä¹‰']}
        ];
        
        let currentUnitTab = 0;
        let currentUnitBtn = null;
        
        function showUnitSelect(btn) {
            currentUnitBtn = btn;
            document.getElementById('unit-popup').classList.remove('hidden');
            renderUnitTabBtns();
            renderUnitList();
        }
        
        function renderUnitTabBtns() {
            const tabBtns = document.getElementById('unit-tab-btns');
            tabBtns.innerHTML = '';
            unitTabs.forEach((tab, idx) => {
                const b = document.createElement('button');
                b.className = `flex-1 flex items-center justify-center gap-2 py-2 px-4 rounded-lg transition-all ${
                    currentUnitTab === idx 
                    ? 'bg-white dark:bg-slate-700 text-purple-600 dark:text-purple-400 shadow-sm' 
                    : 'text-gray-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50'
                }`;
                b.innerHTML = `<i class="fas ${tab.icon}"></i><span>${tab.name}</span>`;
                b.onclick = () => { 
                    currentUnitTab = idx; 
                    renderUnitTabBtns(); 
                    renderUnitList(); 
                };
                tabBtns.appendChild(b);
            });
        }
        
        function renderUnitList() {
            const list = document.getElementById('unit-popup-list');
            list.innerHTML = '';
            
            if(unitTabs[currentUnitTab].name === 'è‡ªå®šä¹‰å•ä½') {
                list.className = 'px-2';
                const wrap = document.createElement('div');
                wrap.className = 'flex flex-col items-center gap-4 w-full py-4';
                wrap.innerHTML = `
                    <div class="relative w-full">
                        <input id="customUnitInput" 
                               class="w-full px-4 py-3 bg-gray-50 dark:bg-[#0F172A] text-gray-800 dark:text-slate-100 
                                      border border-gray-200 dark:border-slate-600 rounded-xl outline-none 
                                      placeholder-gray-400 transition-all
                                      focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900" 
                               placeholder="è¾“å…¥è‡ªå®šä¹‰å•ä½">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    <button class="w-full py-3 px-6 gradient-primary 
                                 hover:from-[#764ba2] hover:to-[#667eea] active:scale-95
                                 text-white font-semibold rounded-xl transition-all shadow-lg
                                 flex items-center justify-center gap-2"
                            onclick="setCustomUnit()">
                        <i class="fas fa-check"></i>
                        <span>ç¡®å®š</span>
                    </button>
                `;
                list.appendChild(wrap);
            } else {
                list.className = 'grid grid-cols-3 gap-2 max-h-[40vh] overflow-y-auto pr-2';
                unitTabs[currentUnitTab].list.forEach(u => {
                    const b = document.createElement('button');
                    b.className = `w-full py-3 px-4 rounded-xl transition-all
                                 bg-gray-50 dark:bg-[#0F172A] 
                                 border border-gray-200 dark:border-slate-600
                                 hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20
                                 active:scale-95 text-center
                                 text-gray-800 dark:text-slate-100`;
                    b.textContent = u;
                    b.onclick = () => {
                        currentUnitBtn.textContent = u;
                        closeUnitSelect();
                    };
                    list.appendChild(b);
                });
            }
        }
        
        function setCustomUnit() {
            const val = document.getElementById('customUnitInput').value.trim();
            if(val) {
                currentUnitBtn.textContent = val;
                closeUnitSelect();
            } else {
                // æ·»åŠ è¾“å…¥ä¸ºç©ºçš„æç¤ºåŠ¨ç”»
                const input = document.getElementById('customUnitInput');
                input.classList.add('ring-2', 'ring-red-400');
                setTimeout(() => {
                    input.classList.remove('ring-2', 'ring-red-400');
                }, 800);
            }
        }
        
        function closeUnitSelect() {
            document.getElementById('unit-popup').classList.add('hidden');
        }

        // ææ–™åç§°è‡ªåŠ¨æ£€ç´¢å¼¹çª—ï¼ˆè¾“å…¥ç¬¬ä¸€ä¸ªå­—æ‰å¼¹å‡ºï¼‰
        const materialList = ['é«˜ç­‹é¢ç²‰','ä½ç­‹é¢ç²‰','å…¨éº¦ç²‰','é…µæ¯','ç™½ç ‚ç³–','ç›','é»„æ²¹','ç‰›å¥¶','é¸¡è›‹','æ°´','å¥¶ç²‰','æ©„æ¦„æ²¹','è‘¡è„å¹²','æ ¸æ¡ƒ','èŠå£«'];
        let currentNameInput = null;
        function showMaterialSearch(input) {
            currentNameInput = input;
            if(!input.value) { closeMaterialSearch(); return; }
            updateMaterialSearch(input.value);
            document.getElementById('material-popup').classList.remove('hidden');
        }
        function updateMaterialSearch(keyword) {
            const list = document.getElementById('material-popup-list');
            list.innerHTML = '';
            materialList.filter(m => m.includes(keyword)).forEach(m => {
                const b = document.createElement('button');
                b.className = 'px-3 py-1 rounded bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-400 hover:bg-purple-100 dark:hover:bg-purple-900/30 text-left transition';
                b.textContent = m;
                b.onclick = () => {
                    currentNameInput.value = m;
                    // åŒæ­¥çŠ¶æ€å˜ç»¿
                    const nameInput = currentNameInput;
                    nameInput.classList.remove('not-synced');
                    nameInput.classList.add('synced');
                    
                    closeMaterialSearch();
                    updateAutoFields(currentNameInput);
                };
                list.appendChild(b);
            });
        }
        function closeMaterialSearch() {
            document.getElementById('material-popup').classList.add('hidden');
        }

        // æ·»åŠ åŸæ–™è¡Œï¼ˆæ‰€æœ‰æŒ‰é’®/å›¾æ ‡åŠ ç‚¹å‡»æ•ˆæœï¼ŒåŸºç¡€é¢å›¢å’Œå˜åŒ–æ¬¾é‡Œçš„é¢å›¢éƒ½è®¡å…¥æ€»é‡ï¼Œåç§°ä¸å¯ç¼–è¾‘ï¼‰
        function addIngredient(type) {
            let container;
            if(type.startsWith('variation')) {
                container = document.getElementById(`${type}Ingredients`);
            } else {
                container = document.getElementById(`${type}Ingredients`);
            }
            let nameValue = '';
            let nameReadOnly = false;
            if(type==='base' && container.children.length===0) {
                const recipeName = document.querySelector('input[placeholder="é…æ–¹åç§°"]')?.value || '';
                nameValue = recipeName;
                nameReadOnly = true;
            }
            // å˜åŒ–æ¬¾é‡Œçš„é¢å›¢åç§°ä¸å¯ç¼–è¾‘
            if(type.startsWith('variation')) {
                nameValue = 'åŸºç¡€é¢å›¢';
                nameReadOnly = true;
            }
            const div = document.createElement('div');
            div.className = 'flex flex-wrap items-center gap-3 bg-white dark:bg-[#1E293B] rounded-lg p-2 shadow-sm border border-slate-200 dark:border-slate-600 ingredient-item';
            div.setAttribute('data-open', 'false');
            div.innerHTML = `
                <div class="drag-handle text-slate-400 dark:text-slate-500 cursor-move pr-1 active:scale-90 transition hover:text-purple-600 dark:hover:text-purple-400">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                <div class="flex-1 min-w-[80px] border-b border-slate-300 dark:border-slate-600 relative">
                    <input type="text" placeholder="åç§°" class="name-input w-full px-2 py-2 border-none outline-none bg-transparent text-gray-800 dark:text-slate-100 not-synced ${nameReadOnly?'cursor-not-allowed':''}" value="${nameValue}" ${nameReadOnly?'readonly':''} oninput="if(this.value.length>0&&!this.readOnly){showMaterialSearch(this);}else{closeMaterialSearch();}updateAutoFields(this)">
                </div>
                <div class="w-20 border-b border-slate-300 dark:border-slate-600 relative">
                    <input type="text" inputmode="decimal" placeholder="è§„æ ¼" class="w-full px-2 py-2 text-center border-none outline-none bg-transparent text-gray-800 dark:text-slate-100" oninput="updateAutoFields(this)">
                </div>
                <div class="w-20 border-b border-slate-300 dark:border-slate-600 relative">
                    <input type="text" inputmode="decimal" placeholder="ç”¨é‡" class="w-full px-2 py-2 text-center border-none outline-none bg-transparent text-gray-800 dark:text-slate-100" oninput="updateAutoFields(this)">
                </div>
                <div class="w-20 border-b border-slate-300 dark:border-slate-600 relative">
                    <input type="text" inputmode="decimal" placeholder="æˆæœ¬" class="w-full px-2 py-2 text-center border-none outline-none bg-transparent text-gray-800 dark:text-slate-100" oninput="updateAutoFields(this)">
                </div>
                <div class="border-b border-slate-300 dark:border-slate-600 min-w-[30px] text-center">
                    <button type="button" class="unit-btn px-2 py-2 text-purple-600 dark:text-purple-400 hover:text-purple-700 active:scale-90 transition bg-transparent border-none cursor-pointer" onclick="showUnitSelect(this)">g</button>
                </div>
                <span class="percent-field text-slate-500 dark:text-slate-400 select-none ml-1">0%</span>
                <span class="price-field text-slate-500 dark:text-slate-400 select-none ml-1">ï¿¥0.00</span>
                <div class="delete-action"><i class="fas fa-trash-alt mr-1"></i> åˆ é™¤</div>
            `;
            container.appendChild(div);
            initSwipeDelete(div);
            updateSortable();
            updateVariationTotal();
        }

        // æ‹–æ‹½æ’åºåˆå§‹åŒ–
        function updateSortable() {
            document.querySelectorAll('.ingredients-group').forEach(el => {
                if (!el.sortable) {
                    el.sortable = new Sortable(el, {
                        group: { name: 'ingredients', pull: true, put: true },
                        handle: '.drag-handle',
                        animation: 180,
                        ghostClass: 'bg-purple-100',
                        chosenClass: 'ring-2 ring-purple-400',
                        onEnd: function() {
                            updateAllAutoFields();
                        }
                    });
                }
            });
        }

        // æ‹–æ‹½ååˆ·æ–°æ‰€æœ‰åˆ†ç»„è‡ªåŠ¨å­—æ®µ
        function updateAllAutoFields() {
            document.querySelectorAll('.ingredients-group').forEach(group => {
                Array.from(group.children).forEach(row => {
                    updateAutoFields(row.querySelector('input[type="number"]') || row.querySelector('input[type="text"]'));
                });
            });
        }

        // ç™¾åˆ†æ¯”ä»¥é¢ç²‰ä¸ºåŸºå‡†
        function updateAutoFields(input) {
            const row = input.closest('.flex');
            // æ‰¾åˆ°æ‰€æœ‰é¢ç²‰åˆ†ç»„çš„æ€»é‡
            let flourTotal = 0;
            document.querySelectorAll('#flourIngredients input[placeholder="è§„æ ¼"]').forEach(f => {
                flourTotal += parseFloat(f.value) || 0;
            });
            // å½“å‰åˆ†ç»„
            const container = row.parentElement;
            const allRows = Array.from(container.children);
            allRows.forEach(r => {
                const qty = r.querySelector('input[placeholder="è§„æ ¼"]');
                const percent = r.querySelector('.percent-field');
                const price = r.querySelector('.price-field');
                const val = parseFloat(qty?.value) || 0;
                // ç™¾åˆ†æ¯”ä»¥é¢ç²‰ä¸ºåŸºå‡†
                percent.textContent = flourTotal ? ((val / flourTotal * 100).toFixed(2)) + '%' : '0.00%';
                // é‡‘é¢ï¼ˆå‡è®¾åŒæ­¥çŠ¶æ€ä¸ºç»¿è‰²æ—¶æœ‰æˆæœ¬ï¼Œç¤ºä¾‹ï¼šæ•°é‡*0.03ï¼‰
                const sync = r.querySelector('.sync-btn i');
                if (sync && sync.classList.contains('text-green-500')) {
                    price.textContent = 'ï¿¥' + (val * 0.03).toFixed(2);
                } else {
                    price.textContent = 'ï¿¥0.00';
                }
            });
            updateTotalWeight();
            updateVariationTotal();
        }

        // åŒæ­¥çŠ¶æ€åˆ‡æ¢
        function toggleSync(element) {
            const nameInput = element.closest('.ingredient-item').querySelector('.name-input');
            
            if (nameInput.classList.contains('synced')) {
                nameInput.classList.remove('synced');
                nameInput.classList.add('not-synced');
            } else {
                nameInput.classList.remove('not-synced');
                nameInput.classList.add('synced');
            }
            updateAutoFields(nameInput);
        }

        // æ€»é‡=åŸºç¡€é¢å›¢+æ‰€æœ‰å˜åŒ–æ¬¾é‡Œçš„é¢å›¢ï¼Œè¶…5ä½è‡ªåŠ¨åˆ‡kg
        function updateTotalWeight() {
            let total = 0;
            document.querySelectorAll(`#baseIngredients input[type="number"]`).forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.querySelectorAll('.variation-group').forEach(group => {
                group.querySelectorAll('input[type="number"]').forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
            });
            let display = '';
            if(total>=100000) {
                display = (total/1000).toFixed(2)+' kg';
            } else {
                display = total.toFixed(2)+' g';
            }
            document.getElementById('totalWeight').textContent = display;
        }

        // ç›‘å¬é‡é‡è¾“å…¥å˜åŒ–
        document.addEventListener('input', function(e) {
            if (e.target.placeholder === 'é‡é‡') {
                updateTotalWeight();
            }
        });

        // å›¾ç‰‡è£å‰ªç›¸å…³å˜é‡
        let cropper = null;
        let currentImageFile = null;

        // å›¾ç‰‡ä¸Šä¼ é¢„è§ˆï¼ˆæ”¯æŒè£å‰ªï¼‰
        document.getElementById('coverImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                    return;
                }
                currentImageFile = file;
                openCropModal(file);
            }
        });

        // æ‰“å¼€è£å‰ªå¼¹çª—
        function openCropModal(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const cropImage = document.getElementById('cropImage');
                cropImage.src = e.target.result;
                
                // æ˜¾ç¤ºå¼¹çª—
                document.getElementById('cropModal').classList.remove('hidden');
                
                // åˆå§‹åŒ–è£å‰ªå™¨ï¼ˆæ­£æ–¹å½¢è£å‰ªï¼‰
                setTimeout(() => {
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(cropImage, {
                        aspectRatio: 1, // æ­£æ–¹å½¢æ¯”ä¾‹
                        viewMode: 1,
                        guides: true,
                        center: true,
                        autoCropArea: 0.8,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        preview: '#cropPreview',
                        ready: function() {
                            // è£å‰ªå™¨åˆå§‹åŒ–å®Œæˆ
                        }
                    });
                }, 100);
            };
            reader.readAsDataURL(file);
        }

        // å…³é—­è£å‰ªå¼¹çª—
        function closeCropModal() {
            document.getElementById('cropModal').classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            document.getElementById('coverImage').value = '';
        }

        // ç¡®è®¤è£å‰ª
        function confirmCrop() {
            if (!cropper) return;
            
            // è·å–è£å‰ªåçš„ç”»å¸ƒ
            const canvas = cropper.getCroppedCanvas({
                width: 400, // è¾“å‡ºå°ºå¯¸ï¼š400x400åƒç´ ï¼Œä¿è¯è´¨é‡
                height: 400,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            // è½¬æ¢ä¸ºé«˜è´¨é‡çš„å›¾ç‰‡
            const croppedImageDataUrl = canvas.toDataURL('image/jpeg', 0.9); // 90%è´¨é‡
            
            // æ›´æ–°é¢„è§ˆ
            document.getElementById('imagePreview').innerHTML = `
                <img src="${croppedImageDataUrl}" class="w-full h-full object-cover rounded-xl">
            `;
            
            // å…³é—­å¼¹çª—
            closeCropModal();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showNotification('âœ… å›¾ç‰‡è£å‰ªå®Œæˆ');
        }

        // Tabåˆ‡æ¢åŠŸèƒ½
        function switchTab(tab) {
            // æ›´æ–°TabæŒ‰é’®çŠ¶æ€
            const tabs = ['recipe', 'sop', 'step'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-btn-${t}`);
                const section = document.getElementById(`${t}-section`);
                
                if (t === tab) {
                    btn.classList.add('tab-active', 'tab-bg-active');
                    btn.classList.remove('tab-inactive', 'tab-bg-inactive');
                    section.classList.remove('hidden');
                } else {
                    btn.classList.remove('tab-active', 'tab-bg-active');
                    btn.classList.add('tab-inactive', 'tab-bg-inactive');
                    section.classList.add('hidden');
                }
            });
            
            // åˆ‡æ¢é…æ–¹ä¿¡æ¯æ˜¾ç¤ºï¼ˆé…æ–¹åç§°å’Œåˆ†ç±»é€‰æ‹©ä»…åœ¨é…æ–¹é¡µé¢æ˜¾ç¤ºï¼‰
            const recipeMetaSection = document.getElementById('recipe-meta-section');
            if (recipeMetaSection) {
                if (tab === 'recipe') {
                    recipeMetaSection.classList.remove('hidden');
                } else {
                    recipeMetaSection.classList.add('hidden');
                }
            }
            
            // æ›´æ–°åº•éƒ¨æ æ˜¾ç¤º
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                const totalWeightCard = saveBtn.parentElement.querySelector('.flex.items-center');
                if(tab==='sop') {
                    saveBtn.textContent = 'ä¿å­˜SOP';
                    if (totalWeightCard) totalWeightCard.classList.add('hidden');
                    saveBtn.classList.add('w-full');
                } else if(tab==='step') {
                    saveBtn.textContent = 'ä¿å­˜æ­¥éª¤';
                    if (totalWeightCard) totalWeightCard.classList.add('hidden');
                    saveBtn.classList.add('w-full');
                } else {
                    saveBtn.textContent = 'ä¿å­˜é…æ–¹';
                    if (totalWeightCard) totalWeightCard.classList.remove('hidden');
                    saveBtn.classList.remove('w-full');
                }
            }
            
            // SOPé¦–æ¬¡æ‰“å¼€æ—¶åˆå§‹åŒ–æ•°æ®
            if(tab==='sop' && document.getElementById('sopStepsList') && document.getElementById('sopStepsList').children.length === 0) {
                initSopSteps();
            }
            // æ­¥éª¤é¦–æ¬¡æ‰“å¼€æ—¶åˆå§‹åŒ–æ•°æ®
            if(tab==='step' && document.getElementById('stepsList') && document.getElementById('stepsList').children.length === 0) {
                initSteps();
            }
        }

        // å˜åŒ–æ¬¾åˆ†ç»„åŠ¨æ€æ·»åŠ /åˆ é™¤
        let variationCount = 0;
                    function addVariationGroup() {
            variationCount++;
            const id = `variation${variationCount}`;
            const div = document.createElement('div');
            div.className = 'card p-4 mb-4 variation-group';
            div.innerHTML = `
                <div class="flex justify-between items-center mb-3 bg-[#F8FAFC] dark:bg-[#0F172A] p-2 rounded-lg w-full">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-[#F8FAFC] dark:bg-[#0F172A] flex items-center justify-center mr-3">
                            <i class="fas fa-layer-group text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 class="font-semibold text-[#1E293B] dark:text-slate-100">å˜åŒ–æ¬¾</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/30 active:scale-90 transition rounded-full p-1" onclick="this.closest('.variation-group').remove(); updateAllAutoFields();"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div id="${id}Ingredients" class="space-y-2 ingredients-group"></div>
                <div id="${id}Total" class="mt-3 text-right text-sm text-purple-700 dark:text-purple-300 font-semibold bg-purple-100/50 dark:bg-purple-900/20 rounded-lg px-3 py-1 hidden"></div>
                <div class="flex justify-end mt-3">
                    <button class="text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 active:scale-90 rounded-lg px-3 py-2 transition-all flex items-center text-sm" onclick="addIngredient('${id}')">
                        <i class="fas fa-plus mr-1"></i>
                        <span>æ·»åŠ ä¸€è¡Œ</span>
                    </button>
                </div>
            `;
            document.getElementById('variationList').appendChild(div);
            updateSortable();
        }
        document.getElementById('addVariationBtn').onclick = addVariationGroup;

        // æ›´æ–°å˜åŒ–æ¬¾åˆ†ç»„æ€»é‡
        function updateVariationTotal() {
            // æ—§çš„å˜åŒ–æ¬¾åˆ†ç»„
            const old = document.getElementById('variationIngredients');
            if(old) {
                const allRows = Array.from(old.children);
                let total = 0;
                allRows.forEach(r => {
                    const qty = r.querySelector('input[type="number"]');
                    total += parseFloat(qty?.value) || 0;
                });
                const totalDiv = document.getElementById('variationTotal');
                if(allRows.length>1 && total>0){
                    totalDiv.textContent = 'å˜åŒ–æ¬¾æ€»é‡ï¼š' + total + 'g';
                    totalDiv.classList.remove('hidden');
                }else{
                    totalDiv.classList.add('hidden');
                }
            }
            // æ–°çš„åŠ¨æ€å˜åŒ–æ¬¾åˆ†ç»„
            document.querySelectorAll('.variation-group').forEach(group => {
                const container = group.querySelector('.ingredients-group');
                const totalDiv = group.querySelector('div[id$="Total"]');
                const allRows = Array.from(container.children);
                let total = 0;
                allRows.forEach(r => {
                    const qty = r.querySelector('input[type="number"]');
                    total += parseFloat(qty?.value) || 0;
                });
                if(allRows.length>1 && total>0){
                    totalDiv.textContent = 'å˜åŒ–æ¬¾æ€»é‡ï¼š' + total + 'g';
                    totalDiv.classList.remove('hidden');
                }else{
                    totalDiv.classList.add('hidden');
                }
            });
        }

        // åŸºç¡€é¢å›¢å¿…å¡«æ ¡éªŒ
        function validateBase() {
            const baseRows = document.getElementById('baseIngredients').children;
            if(baseRows.length===0){
                alert('åŸºç¡€é¢å›¢ä¸ºå¿…å¡«é¡¹ï¼');
                return false;
            }
            return true;
        }

        // æ‹ç…§/æ‰«æäº¤äº’å¼¹çª—
        function openCamera() {
            document.getElementById('cameraModal').classList.remove('hidden');
            // åœ¨çœŸå®ç¯å¢ƒä¸­è¿™é‡Œä¼šåˆå§‹åŒ–ç›¸æœº
            setTimeout(() => {
                document.getElementById('cameraPreview').classList.remove('hidden');
            }, 300);
        }
        
        function closeCamera() {
            document.getElementById('cameraModal').classList.add('hidden');
            document.getElementById('cameraPreview').classList.add('hidden');
        }
        
        function takePhoto() {
            // æ¨¡æ‹Ÿæ‹ç…§æ•ˆæœ
            const flashEffect = document.getElementById('cameraFlash');
            flashEffect.classList.remove('hidden');
            flashEffect.classList.add('opacity-100');
            
            setTimeout(() => {
                flashEffect.classList.remove('opacity-100');
                flashEffect.classList.add('opacity-0');
            }, 100);
            
            setTimeout(() => {
                flashEffect.classList.add('hidden');
                flashEffect.classList.remove('opacity-0');
                showNotification('âœ… å·²è‡ªåŠ¨è¯†åˆ«é…æ–¹å†…å®¹');
                closeCamera();
            }, 500);
        }
        
        function openScan() {
            alert('æ¨¡æ‹Ÿæ‰‹å†™é…æ–¹è¯†åˆ«ç•Œé¢ï¼Œè¯†åˆ«åè‡ªåŠ¨å¡«å……åˆ°é…æ–¹ï¼ˆåç»­å¯å¯¹æ¥APIï¼‰');
        }

        // æ–°å»ºç±»åˆ«å¼¹çª—äº¤äº’
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.remove('hidden');
            document.getElementById('newCategoryInput').value = '';
            setTimeout(()=>{document.getElementById('newCategoryInput').focus();},100);
        }
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
        }
        function addNewCategory() {
            const val = document.getElementById('newCategoryInput').value.trim();
            if(val) {
                const select = document.getElementById('categorySelect');
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                select.appendChild(opt);
                select.value = val;
                closeCategoryModal();
            }
        }

        // æ­¥éª¤ç®¡ç†ï¼ˆä¸“ä¸šUIè®¾è®¡ï¼‰
        let stepCount = 0;
        let currentStepRow = null;
        let currentMediaSlot = null;
        
        function initSteps() {
            // åˆå§‹åŒ–3ä¸ªç¤ºä¾‹æ­¥éª¤ï¼Œåˆ†åˆ«å±•ç¤º1å¼ ã€2å¼ å’Œ3å¼ å›¾ç‰‡çš„å¸ƒå±€
            const defaultSteps = [
                { title: 'æ­¥éª¤1ï¼ˆä¸€å¼ å›¾ç‰‡ç¤ºä¾‹ï¼‰', content: 'å’Œé¢ï¼šå°†æ‰€æœ‰å¹²æ€§åŸæ–™æ··åˆï¼Œæ…¢æ…¢åŠ å…¥æ¶²ä½“åŸæ–™ï¼Œæ…æ‹Œè‡³é¢å›¢å…‰æ»‘ï¼Œæ³¨æ„æ§åˆ¶åŠ æ°´é€Ÿåº¦' },
                { title: 'æ­¥éª¤2ï¼ˆä¸¤å¼ å›¾ç‰‡ç¤ºä¾‹ï¼‰', content: 'å‘é…µï¼šå°†é¢å›¢æ”¾å…¥å‘é…µç®±ï¼Œæ¸©åº¦28â„ƒï¼Œæ¹¿åº¦75%ï¼Œå‘é…µ90åˆ†é’Ÿï¼Œç›´è‡³é¢å›¢ä½“ç§¯å¢å¤§ä¸€å€' },
                { title: 'æ­¥éª¤3ï¼ˆä¸‰å¼ å›¾ç‰‡ç¤ºä¾‹ï¼‰', content: 'æ•´å½¢ï¼šå°†å‘é…µå¥½çš„é¢å›¢åˆ†å‰²ï¼Œæ“€å¹³ï¼Œå·èµ·ï¼Œæ”¾å…¥æ¨¡å…·ä¸­è¿›è¡ŒäºŒæ¬¡å‘é…µï¼Œæ³¨æ„ä¿æŒé€‚å½“æ¾å¼›æ—¶é—´' }
            ];
            
            // åˆ›å»ºæ­¥éª¤å¹¶æ·»åŠ ç¤ºä¾‹å›¾ç‰‡
            defaultSteps.forEach((step, index) => {
                const stepElement = addStep(step.title, step.content);
                
                // æ ¹æ®æ­¥éª¤ç¼–å·æ·»åŠ ä¸åŒæ•°é‡çš„ç¤ºä¾‹å›¾ç‰‡
                const imageCount = index + 1; // æ­¥éª¤1æ·»åŠ 1å¼ å›¾ï¼Œæ­¥éª¤2æ·»åŠ 2å¼ å›¾ï¼Œæ­¥éª¤3æ·»åŠ 3å¼ å›¾
                addExampleImages(stepElement, imageCount);
            });
            
            updateStepSortable();
        }
        
        function addExampleImages(stepElement, count) {
            // ç¤ºä¾‹å›¾ç‰‡URLæ•°ç»„
            const sampleImageUrls = [
                'https://images.unsplash.com/photo-1506459225024-1428097a7e18?w=600&h=400&fit=crop',
                'https://images.unsplash.com/photo-1589367920969-ab8e050bbb04?w=600&h=400&fit=crop',
                'https://images.unsplash.com/photo-1600326145552-327f74b9c189?w=600&h=400&fit=crop',
                'https://images.unsplash.com/photo-1612200058850-8e661d819ded?w=600&h=400&fit=crop',
                'https://images.unsplash.com/photo-1509440159596-0249088772ff?w=600&h=400&fit=crop'
            ];
            
            // æ‰¾åˆ°åª’ä½“åŒºåŸŸå®¹å™¨
            const mediaContainer = stepElement.querySelector('.flex.overflow-x-auto');
            
            // æ¸…ç©ºé»˜è®¤çš„ç©ºç™½åª’ä½“æ§½
            mediaContainer.innerHTML = '';
            
            // æ·»åŠ æŒ‡å®šæ•°é‡çš„ç¤ºä¾‹å›¾ç‰‡
            for (let i = 0; i < count; i++) {
                const mediaSlot = document.createElement('div');
                mediaSlot.className = 'flex-none w-[70%] snap-center relative';
                
                // ä½¿ç”¨ç¤ºä¾‹å›¾ç‰‡URLï¼ˆå¾ªç¯ä½¿ç”¨ï¼‰
                const imageUrl = sampleImageUrls[i % sampleImageUrls.length];
                
                mediaSlot.innerHTML = `
                    <img src="${imageUrl}" alt="ç¤ºä¾‹å›¾ç‰‡${i+1}" class="rounded-lg w-full h-auto" onclick="showFullImage(this)">
                    <div class="absolute bottom-3 right-3 bg-black bg-opacity-60 text-white rounded-full p-2 hover:bg-opacity-80 transition-all" onclick="showFullImage(this.parentElement)">
                        <i class="fas fa-search-plus"></i>
                    </div>
                `;
                
                mediaContainer.appendChild(mediaSlot);
            }
            
            // å§‹ç»ˆæ·»åŠ ä¸€ä¸ªç©ºçš„ä¸Šä¼ æ§½
            const emptySlot = document.createElement('div');
            emptySlot.className = 'media-slot flex-none w-[70%] snap-center relative';
            emptySlot.innerHTML = `
                <div class="media-upload-area w-full h-20 rounded-lg flex items-center justify-center cursor-pointer transition-all border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-purple-500 hover:bg-gray-50 dark:hover:bg-slate-800" onclick="openMediaUpload(this)">
                    <div class="text-center text-slate-400 dark:text-slate-500">
                        <i class="fas fa-plus text-lg mb-1"></i>
                        <div class="text-xs">æ·»åŠ å›¾ç‰‡/è§†é¢‘</div>
                    </div>
                </div>
            `;
            mediaContainer.appendChild(emptySlot);
        }
        
        function addStep(stepTitle = '', stepContent = '') {
            stepCount++;
            const container = document.getElementById('stepsList');
            const div = document.createElement('div');
            div.className = 'card';
             
            div.innerHTML = `
                <div class="flex items-center p-4 border-b border-slate-100 dark:border-slate-700">
                    <div class="w-10 h-10 gradient-primary text-white rounded-full flex items-center justify-center text-lg font-bold mr-3 step-number">
                        ${stepCount}
                        </div>
                    <input type="text" class="bg-transparent text-[#1E293B] dark:text-slate-100 font-bold border-none outline-none placeholder-slate-400 text-xl focus:bg-[#F8FAFC] dark:focus:bg-[#0F172A] rounded px-2 py-1" 
                           value="${stepTitle || 'æ­¥éª¤' + stepCount}" placeholder="æ­¥éª¤æ ‡é¢˜" />
                    <div class="flex items-center gap-2 ml-auto">
                        <button class="step-menu-btn text-gray-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-purple-400 active:scale-90 transition text-lg p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700" onclick="openStepMenu(this)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        <div class="step-drag-handle drag-handle-enhanced cursor-grab" title="æ‹–æ‹½æ’åº">
                            <i class="fas fa-grip-vertical text-[#64748B] dark:text-slate-400"></i>
                            </div>
                        </div>
                    </div>
                
                <div class="p-4">
                    <!-- æ­¥éª¤å†…å®¹è¾“å…¥ -->
                    <textarea class="w-full px-4 py-3 bg-gray-50 dark:bg-slate-800 text-gray-800 dark:text-slate-100 border border-slate-200 dark:border-slate-600 rounded-xl outline-none resize-none placeholder-slate-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900 transition text-sm leading-relaxed mb-4" 
                              placeholder="è¯·è¾“å…¥è¯¦ç»†çš„åˆ¶ä½œæ­¥éª¤è¯´æ˜..." rows="3">${stepContent}</textarea>
                    
                    <!-- åª’ä½“ä¸Šä¼ åŒº -->
                    <div class="flex overflow-x-auto gap-3 pb-2 mb-2 snap-x">
                        <div class="media-slot flex-none w-[70%] snap-center relative">
                            <div class="media-upload-area w-full h-20 rounded-lg flex items-center justify-center cursor-pointer transition-all border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-purple-500 hover:bg-gray-50 dark:hover:bg-slate-800" onclick="openMediaUpload(this)">
                                <div class="text-center text-slate-400 dark:text-slate-500">
                                    <i class="fas fa-plus text-lg mb-1"></i>
                                    <div class="text-xs">æ·»åŠ å›¾ç‰‡/è§†é¢‘</div>
                </div>
                    </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            updateStepNumbers();
            return div;
        }
        
        // å¤‡æ³¨å­—ç¬¦è®¡æ•°
        document.addEventListener('DOMContentLoaded', function() {
            const sopRemark = document.getElementById('sopRemark');
            const sopRemarkCount = document.getElementById('sopRemarkCount');
            
            sopRemark.addEventListener('input', function() {
                const count = this.value.length;
                sopRemarkCount.textContent = `${count}/100`;
                if(count >= 90) {
                    sopRemarkCount.classList.add('text-red-500');
                } else {
                    sopRemarkCount.classList.remove('text-red-500');
                }
            });
        });
        
        // æ•°é‡è°ƒæ•´å‡½æ•°ï¼ˆç§»åŠ¨ç«¯å‹å¥½çš„æ­¥è¿›å™¨ï¼‰
        function adjustQuantity(btn, delta) {
            const input = btn.parentElement.querySelector('input[type="number"]');
            const currentValue = parseFloat(input.value) || 0;
            const step = parseFloat(input.step) || 1;
            const newValue = Math.max(0, currentValue + (delta * step));
            input.value = newValue;
            updateAutoFields(input);
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­æ‰€æœ‰èœå•å’Œå¼¹çª—
        document.addEventListener('click', function(e) {
            // å…³é—­SOPä¸‰ç‚¹èœå•
            if(!e.target.closest('.sop-step-menu')) {
                document.querySelectorAll('.sop-menu-dropdown').forEach(d => d.classList.add('hidden'));
            }
            // å…³é—­SOPç±»å‹é€‰æ‹©å¼¹çª—
            if(!e.target.closest('.sop-type-modal > div') && !e.target.closest('.sop-icon-btn')) {
                const modal = document.getElementById('sopTypeModal');
                if(modal && !modal.classList.contains('hidden')) {
                    closeSopTypeModal();
                }
            }
            // å…³é—­æ­¥éª¤èœå•å¼¹çª—
            if(!e.target.closest('#stepMenuModal > div') && !e.target.closest('.step-menu-btn')) {
                const modal = document.getElementById('stepMenuModal');
                if(modal && !modal.classList.contains('hidden')) {
                    closeStepMenuModal();
                }
            }
            // å…³é—­åª’ä½“ä¸Šä¼ å¼¹çª—
            if(!e.target.closest('#mediaUploadModal > div') && !e.target.closest('.media-upload-area')) {
                const modal = document.getElementById('mediaUploadModal');
                if(modal && !modal.classList.contains('hidden')) {
                    closeMediaUploadModal();
                }
            }
            // å…³é—­å›¾ç‰‡è£å‰ªå¼¹çª—
            if(!e.target.closest('#cropModal > div') && !e.target.closest('#coverImage')) {
                const modal = document.getElementById('cropModal');
                if(modal && !modal.classList.contains('hidden')) {
                    closeCropModal();
                }
            }
        });
        
        function updateStepNumbers() {
            const steps = document.querySelectorAll('#stepsList .step-row');
            steps.forEach((step, index) => {
                const numberEl = step.querySelector('.step-number');
                if(numberEl) {
                    numberEl.textContent = index + 1;
                }
            });
        }
        
        function updateStepSortable() {
            const container = document.getElementById('stepsList');
            if (container && !container.sortable) {
                container.sortable = new Sortable(container, {
                    handle: '.step-drag-handle',
                    animation: 300,
                    ghostClass: 'opacity-50',
                    chosenClass: 'ring-2 ring-purple-400 scale-105',
                    easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                    onEnd: function() {
                        updateStepNumbers();
                    }
                });
            }
        }
        
        // æ­¥éª¤èœå•æ“ä½œ
        function openStepMenu(btn) {
            currentStepRow = btn.closest('.step-row');
            document.getElementById('stepMenuModal').classList.remove('hidden');
            
            // ç»‘å®šèœå•æ“ä½œ
            document.getElementById('stepMenuDelete').onclick = function() {
                if(document.getElementById('stepsList').children.length <= 1) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ­¥éª¤');
                    return;
                }
                currentStepRow.remove();
                updateStepNumbers();
                closeStepMenuModal();
            };
            
            document.getElementById('stepMenuAdd').onclick = function() {
                addStep();
                const container = document.getElementById('stepsList');
                const newRow = container.lastElementChild;
                container.insertBefore(newRow, currentStepRow.nextSibling);
                updateStepNumbers();
                updateStepSortable();
                closeStepMenuModal();
            };
        }
        
        function closeStepMenuModal() {
            document.getElementById('stepMenuModal').classList.add('hidden');
            currentStepRow = null;
        }
        
        // åª’ä½“ä¸Šä¼ åŠŸèƒ½
        function openMediaUpload(slot) {
            currentMediaSlot = slot;
            document.getElementById('mediaUploadModal').classList.remove('hidden');
        }
        
        function closeMediaUploadModal() {
            document.getElementById('mediaUploadModal').classList.add('hidden');
            currentMediaSlot = null;
        }
        
        function selectImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = false;
            input.onchange = function(e) {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        showMediaPreview(e.target.result, 'image', file.name);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
            closeMediaUploadModal();
        }
        
        function selectVideo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'video/*';
            input.multiple = false;
            input.onchange = function(e) {
                const file = e.target.files[0];
                if(file) {
                    // è§†é¢‘è‡ªåŠ¨å¤„ç†æ¨¡æ‹Ÿ
                    setTimeout(() => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            showMediaPreview(e.target.result, 'video', file.name);
                            // æ¨¡æ‹Ÿè§†é¢‘è‡ªåŠ¨å¤„ç†å®Œæˆ
                            showNotification('âœ… è§†é¢‘å·²è‡ªåŠ¨å‹ç¼©ä¼˜åŒ–');
                        };
                        reader.readAsDataURL(file);
                    }, 1000);
                    showNotification('ğŸ”„ æ­£åœ¨è‡ªåŠ¨å¤„ç†è§†é¢‘...');
                }
            };
            input.click();
            closeMediaUploadModal();
        }
        
        function captureMedia() {
            // æ¨¡æ‹Ÿæ‹ç…§/å½•åƒåŠŸèƒ½
            showNotification('ğŸ“· æ¨¡æ‹Ÿè°ƒç”¨æ‘„åƒå¤´åŠŸèƒ½');
            closeMediaUploadModal();
        }
        
        function showMediaPreview(src, type, filename) {
            if(!currentMediaSlot) return;
            
            const isVideo = type === 'video';
            const preview = document.createElement('div');
            preview.className = 'media-preview w-full h-full relative rounded-lg overflow-hidden';
            
            if(isVideo) {
                preview.innerHTML = `
                    <video class="w-full h-full object-cover" controls>
                        <source src="${src}" type="video/mp4">
                    </video>
                    <div class="video-indicator text-white text-xs bg-black bg-opacity-50 px-2 py-1 rounded">
                        <i class="fas fa-play mr-1"></i>è§†é¢‘
                    </div>
                    <button class="remove-btn w-6 h-6 rounded-full text-white text-xs hover:bg-red-600 transition flex items-center justify-center" onclick="removeMedia(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            } else {
                preview.innerHTML = `
                    <img src="${src}" class="w-full h-full object-cover" alt="${filename}" onclick="showFullImage(this)">
                    <div class="absolute bottom-3 right-3 bg-black bg-opacity-60 text-white rounded-full p-2 hover:bg-opacity-80 transition-all" onclick="showFullImage(this.parentElement)">
                        <i class="fas fa-search-plus"></i>
                    </div>
                    <button class="remove-btn w-6 h-6 rounded-full text-white text-xs hover:bg-red-600 transition flex items-center justify-center" onclick="removeMedia(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            }
            
            currentMediaSlot.innerHTML = '';
            currentMediaSlot.appendChild(preview);
        }
        
        function showNotification(message) {
            // ç®€å•çš„é€šçŸ¥æ˜¾ç¤º
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-80 text-white px-4 py-2 rounded-xl z-50 text-sm';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // æ­¥éª¤å¤‡æ³¨å­—ç¬¦è®¡æ•°
        document.addEventListener('DOMContentLoaded', function() {
            const stepRemark = document.getElementById('stepRemark');
            const stepRemarkCount = document.getElementById('stepRemarkCount');
            
            if(stepRemark && stepRemarkCount) {
                stepRemark.addEventListener('input', function() {
                    const count = this.value.length;
                    stepRemarkCount.textContent = `${count}/120`;
                    if(count >= 110) {
                        stepRemarkCount.classList.add('text-red-500');
                    } else {
                        stepRemarkCount.classList.remove('text-red-500');
                    }
                });
            }
        });
        
        // å›¾ç‰‡å…¨å±é¢„è§ˆåŠŸèƒ½
        function showFullImage(container) {
            const img = container.querySelector('img');
            const modal = document.getElementById('fullImageModal');
            const modalImg = modal.querySelector('img');
            
            if (img) {
                // è·å–åŸå§‹å›¾ç‰‡URLï¼Œæ˜¾ç¤ºé«˜æ¸…å¤§å›¾
                modalImg.src = img.src;
                modal.classList.remove('hidden');
            }
        }
        
        // åˆ†äº«åŠŸèƒ½ç›¸å…³
        function openShareModal() {
            document.getElementById('shareModal').classList.remove('hidden');
            
            // æ ¹æ®ç”¨æˆ·IPåˆ¤æ–­æ˜¾ç¤ºå›½å†…è¿˜æ˜¯å›½å¤–å¹³å°
            // è¿™é‡Œæ¨¡æ‹Ÿä½¿ç”¨GeolocationAPIæˆ–IPæŸ¥è¯¢æœåŠ¡
            checkUserRegion();
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
        }
        
        function checkUserRegion() {
            // æ¨¡æ‹Ÿæ£€æµ‹ç”¨æˆ·æ‰€åœ¨åœ°åŒº
            // å®é™…ç”Ÿäº§ç¯å¢ƒåº”è¯¥ä½¿ç”¨IPåœ°å€æŸ¥è¯¢æœåŠ¡æˆ–HTML5 Geolocation API
            
            // è·å–æµè§ˆå™¨è¯­è¨€ä½œä¸ºç®€å•åˆ¤æ–­ä¾æ®
            const userLanguage = navigator.language || navigator.userLanguage;
            const mainlandPlatforms = document.querySelector('.mainland-platforms');
            const foreignPlatforms = document.querySelector('.foreign-platforms');
            
            // å¦‚æœæ˜¯ä¸­æ–‡ï¼Œæ˜¾ç¤ºå›½å†…å¹³å°
            if (userLanguage.startsWith('zh')) {
                mainlandPlatforms.classList.remove('hidden');
                foreignPlatforms.classList.add('hidden');
            } else {
                // éä¸­æ–‡ï¼Œæ˜¾ç¤ºå›½å¤–å¹³å°
                mainlandPlatforms.classList.add('hidden');
                foreignPlatforms.classList.remove('hidden');
            }
            
            // ä¹Ÿå¯ä»¥æ·»åŠ ä¸€ä¸ªåˆ‡æ¢æŒ‰é’®ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢
        }
        
        function shareToSpecificPlatform(platform) {
            // å…³é—­åˆ†äº«å¹³å°é€‰æ‹©å¼¹çª—
            closeShareModal();
            
            // è·å–å½“å‰é…æ–¹ä¿¡æ¯
            const recipeName = document.querySelector('input[placeholder="é…æ–¹åç§° *"]').value || 'æœªå‘½åé…æ–¹';
            const imagePreview = document.getElementById('imagePreview');
            const imageUrl = imagePreview.querySelector('img')?.src || '';
            
            // æ ¹æ®ä¸åŒå¹³å°å¤„ç†åˆ†äº«é€»è¾‘
            switch(platform) {
                case 'xiaohongshu':
                    openXiaohongshuModal(recipeName, imageUrl);
                    break;
                case 'wechat':
                    showNotification('å·²å‡†å¤‡åˆ†äº«è‡³å¾®ä¿¡æœ‹å‹åœˆ');
                    // å®é™…åº”ç”¨ä¸­è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡åˆ†äº«SDK
                    break;
                case 'douyin':
                    showNotification('å·²å‡†å¤‡åˆ†äº«è‡³æŠ–éŸ³');
                    // å®é™…åº”ç”¨ä¸­è¿™é‡Œåº”è¯¥è°ƒç”¨æŠ–éŸ³åˆ†äº«SDK
                    break;
                case 'hongjang':
                    showNotification('å·²åˆ†äº«è‡³çƒ˜åŒ å¹³å°');
                    break;
                case 'instagram':
                case 'facebook':
                case 'line':
                case 'twitter':
                case 'telegram':
                case 'kakaotalk':
                    showNotification(`å·²å‡†å¤‡åˆ†äº«è‡³${platform}`);
                    // å®é™…åº”ç”¨ä¸­è¿™é‡Œåº”è¯¥è°ƒç”¨ç›¸åº”çš„åˆ†äº«SDK
                    break;
                default:
                    showNotification('åˆ†äº«åŠŸèƒ½æš‚æœªå®ç°');
            }
        }
        
        // å°çº¢ä¹¦åˆ†äº«å¼¹çª—åŠŸèƒ½
        function openXiaohongshuModal(recipeName, imageUrl) {
            const modal = document.getElementById('xiaohongshuShareModal');
            
            // å¦‚æœæ²¡æœ‰ä¼ å‚ï¼Œåˆ™è‡ªåŠ¨è·å–å½“å‰é…æ–¹ä¿¡æ¯
            if (!recipeName) {
                recipeName = document.querySelector('input[placeholder="é…æ–¹åç§° *"]').value || 'ç»å…¸åå¸é¢åŒ…é…æ–¹';
            }
            
            if (!imageUrl) {
                const imagePreview = document.getElementById('imagePreview');
                imageUrl = imagePreview.querySelector('img')?.src || '';
            }
            
            const sharePreviewImage = document.getElementById('sharePreviewImage');
            const shareRecipeTitle = document.getElementById('shareRecipeTitle');
            
            // è®¾ç½®åˆ†äº«é¢„è§ˆä¿¡æ¯
            if (sharePreviewImage) {
                if (imageUrl) {
                    sharePreviewImage.src = imageUrl;
                } else {
                    // ä½¿ç”¨é»˜è®¤å›¾ç‰‡
                    sharePreviewImage.src = "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=600&h=400&fit=crop";
                }
            }
            
            if (shareRecipeTitle) {
                shareRecipeTitle.textContent = recipeName;
            }
            
            // è®¾ç½®ç”¨æˆ·ID (å®é™…åº”ç”¨ä¸­ä»ç”¨æˆ·ç³»ç»Ÿè·å–)
            const userId = 'HJ' + Math.floor(100000 + Math.random() * 900000); // ç”ŸæˆéšæœºIDä½œç¤ºä¾‹
            document.getElementById('shareUserId').textContent = userId;
            
            // ç¡®ä¿æ¨¡æ€çª—å£æ˜¾ç¤º
            modal.classList.remove('hidden');
            // å…³é—­ä¹‹å‰çš„åˆ†äº«çª—å£
            closeShareModal();
        }
        
        function closeXiaohongshuModal() {
            document.getElementById('xiaohongshuShareModal').classList.add('hidden');
        }
        
        function confirmXiaohongshuShare() {
            // è¿™é‡Œåº”è°ƒç”¨å°çº¢ä¹¦åˆ†äº«SDKæˆ–API
            // ç›®å‰ä»…åšæ¨¡æ‹Ÿ
            showNotification('âœ… å·²æˆåŠŸåˆ†äº«è‡³å°çº¢ä¹¦');
            closeXiaohongshuModal();
        }

        // é¡µé¢åŠ è½½æ—¶æ¯ä¸ªåˆ†ç»„è‡ªåŠ¨æ·»åŠ ä¸€æ¡è¾“å…¥è¡Œ
        window.addEventListener('DOMContentLoaded', function() {
            ['flour','starter','dry','wet','aux','base'].forEach(type => {
                addIngredient(type);
            });
            
            // è‡ªåŠ¨æ˜¾ç¤ºSOPç±»å‹å¼¹çª—ä»¥ä¾›æŸ¥çœ‹
            setTimeout(() => {
                document.getElementById('sopTypeModal').classList.remove('hidden');
                renderSopTypeList();
            }, 500);
        });

        function removeMedia(button) {
            const mediaSlot = button.closest('.media-slot');
            if (mediaSlot) {
                mediaSlot.innerHTML = `
                    <div class="media-upload-area w-full h-20 rounded-lg flex items-center justify-center cursor-pointer transition-all border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-purple-500 hover:bg-gray-50 dark:hover:bg-slate-800" onclick="openMediaUpload(this)">
                        <div class="text-center text-slate-400 dark:text-slate-500">
                            <i class="fas fa-plus text-lg mb-1"></i>
                            <div class="text-xs">å›¾ç‰‡/è§†é¢‘</div>
                        </div>
                    </div>
                `;
            }
        }
        
        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const themeOptions = document.querySelectorAll('.theme-option');
            const html = document.documentElement;
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¸»é¢˜
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            // ä¸»é¢˜åˆ‡æ¢äº‹ä»¶ç›‘å¬
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.dataset.theme;
                    setTheme(theme);
                });
            });
            
            // è®¾ç½®ä¸»é¢˜å‡½æ•°
            function setTheme(theme) {
                // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
                html.classList.remove('theme-light', 'theme-dark', 'theme-jp', 'theme-kr');
                // æ·»åŠ æ–°ä¸»é¢˜ç±»
                html.classList.add(`theme-${theme}`);
                // æ›´æ–°æ´»åŠ¨çŠ¶æ€
                themeOptions.forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.theme === theme);
                });
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('theme', theme);
            }
        });

        // SOPæ­¥éª¤ç®¡ç†ï¼ˆå®Œæ•´ç±»å‹åˆ—è¡¨ï¼Œä¸¥æ ¼æŒ‰æˆªå›¾é¡ºåºï¼‰
        const sopStepTypes = [
            {name: 'æ…æ‹Œ', icon: 'fa-cog', color: '#8B5CF6'},
                {name: 'æ°´æ¸©', icon: 'fa-thermometer-empty', color: '#A855F7'},
            {name: 'é¢æ¸©', icon: 'fa-thermometer-half', color: '#FB7185'},
            {name: 'åˆé†’', icon: 'fa-clock', color: '#8B5CF6'},
            {name: 'æ—¶é—´', icon: 'fa-clock', color: '#A3A3A3'},
            {name: 'å‘é…µ', icon: 'fa-seedling', color: '#10B981'},
            {name: 'é£é—¨', icon: 'fa-wind', color: '#94A3B8'},
            {name: 'çƒ˜çƒ¤', icon: 'fa-fire', color: '#F97316'},
            {name: 'æ¸©åº¦', icon: 'fa-thermometer-half', color: '#EF4444'},
            {name: 'æ¹¿åº¦', icon: 'fa-tint', color: '#38BDF8'},
            {name: 'é‡é‡', icon: 'fa-weight', color: '#34D399'},
            {name: 'æ¾å¼›', icon: 'fa-bed', color: '#A78BFA'},
            {name: 'ç¿»é¢', icon: 'fa-hand-paper', color: '#FB923C'},
            {name: 'åˆ†å‰²', icon: 'fa-cut', color: '#EC4899'},
            {name: 'æ•´å½¢', icon: 'fa-shapes', color: '#F59E0B'},
            {name: 'å·¥è‰º', icon: 'fa-cogs', color: '#6366F1'},
            {name: 'å†·è—', icon: 'fa-snowflake', color: '#38BDF8'},
            {name: 'å†·å†»', icon: 'fa-snowflake', color: '#7C3AED'},
            {name: 'PHå€¼', icon: 'fa-flask', color: '#EC4899'},
            {name: 'åŒ…æ²¹', icon: 'fa-oil-can', color: '#F59E0B'},
            {name: 'åŒ…é¦…', icon: 'fa-cookie-bite', color: '#D97706'},
            {name: 'å‰²å£', icon: 'fa-cut', color: '#DC2626'},
            {name: 'è£…é¥°', icon: 'fa-paint-brush', color: '#8B5CF6'},
            {name: 'ä¸Šç«', icon: 'fa-fire', color: '#F43F5E'},
            {name: 'ä¸‹ç«', icon: 'fa-fire', color: '#9F1239'},
            {name: 'è’¸æ±½', icon: 'fa-cloud', color: '#7DD3FC'}
        ];
        
        function initSopSteps() {
            // åˆ›å»ºæ‰€æœ‰26ç§SOPæ­¥éª¤ç±»å‹çš„æ¨¡æ¿å†…å®¹
            const templates = {
                'æ…æ‹Œ': {
                        water_temp: 'æ°´æ¸© (4-6â„ƒ)',
                    first_slow: 'åˆå§‹æ…¢é€Ÿ (3-5åˆ†é’Ÿ)',
                    medium: 'ä¸­é€Ÿ (5-8åˆ†é’Ÿ)',
                    fast: 'å¿«é€Ÿ (2-3åˆ†é’Ÿ)',
                    final_slow: 'æœ€ç»ˆæ…¢é€Ÿ (1-2åˆ†é’Ÿ)',
                        dough_temp: 'å‡ºé¢æ¸©åº¦ (24-26â„ƒ)'
                },
                'æ°´æ¸©': {
                    min_temp: 'æœ€ä½æ¸©åº¦ (â„ƒ)',
                    max_temp: 'æœ€é«˜æ¸©åº¦ (â„ƒ)',
                    target_temp: 'ç†æƒ³æ¸©åº¦ (â„ƒ)',
                    notes: 'æ¸©åº¦è¦æ±‚å¤‡æ³¨'
                },
                'é¢æ¸©': {
                    min_temp: 'æœ€ä½æ¸©åº¦ (â„ƒ)',
                    max_temp: 'æœ€é«˜æ¸©åº¦ (â„ƒ)',
                    target_temp: 'ç†æƒ³æ¸©åº¦ (â„ƒ)',
                    notes: 'é¢å›¢æ¸©åº¦è¦æ±‚'
                },
                'åˆé†’': {
                    temperature: 'æ¸©åº¦ (26-28â„ƒ)',
                    humidity: 'æ¹¿åº¦ (70-75%)',
                    time: 'æ—¶é—´ (15-20åˆ†é’Ÿ)',
                    notes: 'åˆé†’è¦æ±‚'
                },
                'æ—¶é—´': {
                    duration: 'æŒç»­æ—¶é—´',
                    start_time: 'å¼€å§‹æ—¶é—´',
                    end_time: 'ç»“æŸæ—¶é—´',
                    notes: 'æ—¶é—´è¦æ±‚'
                },
                'å‘é…µ': {
                        temperature: 'æ¸©åº¦ (28-30â„ƒ)',
                        humidity: 'æ¹¿åº¦ (75-80%)',
                        time: 'æ—¶é—´ (60-90åˆ†é’Ÿ)',
                        volume: 'ä½“ç§¯ (2-2.5å€å¤§)'
                },
                'é£é—¨': {
                    opening: 'å¼€åº¦ (%)',
                    time: 'å¼€å¯æ—¶é—´',
                    position: 'ä½ç½®',
                    notes: 'é£é—¨è°ƒèŠ‚è¦æ±‚'
                },
                'çƒ˜çƒ¤': {
                    pre_temp: 'é¢„çƒ­æ¸©åº¦ (180-200â„ƒ)',
                    bake_time: 'çƒ¤åˆ¶æ—¶é—´ (35-40åˆ†é’Ÿ)',
                    steam: 'è’¸æ±½é‡ (100-150ml)',
                    color: 'æˆå“é¢œè‰² (é‡‘é»„è‰²)'
                },
                'æ¸©åº¦': {
                    min_temp: 'æœ€ä½æ¸©åº¦ (â„ƒ)',
                    max_temp: 'æœ€é«˜æ¸©åº¦ (â„ƒ)',
                    target_temp: 'ç›®æ ‡æ¸©åº¦ (â„ƒ)',
                    notes: 'æ¸©åº¦è¦æ±‚å¤‡æ³¨'
                },
                'æ¹¿åº¦': {
                    min_humid: 'æœ€ä½æ¹¿åº¦ (%)',
                    max_humid: 'æœ€é«˜æ¹¿åº¦ (%)',
                    target_humid: 'ç›®æ ‡æ¹¿åº¦ (%)',
                    notes: 'æ¹¿åº¦è¦æ±‚å¤‡æ³¨'
                },
                'é‡é‡': {
                    min_weight: 'æœ€å°é‡é‡ (g)',
                    max_weight: 'æœ€å¤§é‡é‡ (g)',
                    target_weight: 'ç›®æ ‡é‡é‡ (g)',
                    tolerance: 'è¯¯å·®èŒƒå›´ (Â±g)'
                },
                'æ¾å¼›': {
                    temperature: 'æ¸©åº¦ (24-26â„ƒ)',
                    humidity: 'æ¹¿åº¦ (70-75%)',
                    time: 'æ—¶é—´ (15-20åˆ†é’Ÿ)',
                    cover: 'æ˜¯å¦éœ€è¦è¦†ç›–'
                },
                'ç¿»é¢': {
                    frequency: 'ç¿»é¢æ¬¡æ•°',
                    interval: 'é—´éš”æ—¶é—´',
                    technique: 'ç¿»é¢æ‰‹æ³•',
                    notes: 'ç¿»é¢æ³¨æ„äº‹é¡¹'
                },
                'åˆ†å‰²': {
                        weight: 'é‡é‡ (æ¯ä»½å…‹æ•°)',
                        rest_time: 'æ¾å¼›æ—¶é—´ (15-20åˆ†é’Ÿ)',
                        shape: 'æˆå‹æ–¹å¼',
                        temp_req: 'æ“ä½œæ¸©åº¦ (24-26â„ƒ)'
                },
                'æ•´å½¢': {
                    technique: 'æ•´å½¢æ‰‹æ³•',
                    final_shape: 'æœ€ç»ˆå½¢çŠ¶',
                    difficulty: 'éš¾åº¦ç­‰çº§',
                    notes: 'æ•´å½¢æ³¨æ„äº‹é¡¹'
                },
                'å·¥è‰º': {
                    method: 'å·¥è‰ºæ–¹æ³•',
                    equipment: 'æ‰€éœ€è®¾å¤‡',
                    skill_level: 'æŠ€èƒ½è¦æ±‚',
                    notes: 'å·¥è‰ºæ³¨æ„äº‹é¡¹'
                },
                'å†·è—': {
                    temperature: 'æ¸©åº¦ (2-6â„ƒ)',
                    humidity: 'æ¹¿åº¦ (80-85%)',
                    time: 'æ—¶é—´ (å°æ—¶)',
                    cover: 'æ˜¯å¦éœ€è¦è¦†ç›–'
                },
                'å†·å†»': {
                    temperature: 'æ¸©åº¦ (-18â„ƒä»¥ä¸‹)',
                    time: 'å†·å†»æ—¶é—´ (å°æ—¶)',
                    packaging: 'åŒ…è£…è¦æ±‚',
                    thaw_method: 'è§£å†»æ–¹æ³•'
                },
                'PHå€¼': {
                    min_ph: 'æœ€å°PHå€¼',
                    max_ph: 'æœ€å¤§PHå€¼',
                    target_ph: 'ç›®æ ‡PHå€¼',
                    measurement: 'æµ‹é‡æ–¹æ³•'
                },
                'åŒ…æ²¹': {
                    oil_type: 'æ²¹è„‚ç±»å‹',
                    oil_temp: 'æ²¹è„‚æ¸©åº¦ (â„ƒ)',
                    technique: 'åŒ…è£¹æ‰‹æ³•',
                    rest_time: 'é™ç½®æ—¶é—´ (åˆ†é’Ÿ)'
                },
                'åŒ…é¦…': {
                    filling_type: 'é¦…æ–™ç±»å‹',
                    filling_temp: 'é¦…æ–™æ¸©åº¦ (â„ƒ)',
                    ratio: 'é¢é¦…æ¯”ä¾‹',
                    sealing: 'æ”¶å£æ–¹æ³•'
                },
                'å‰²å£': {
                    pattern: 'å‰²çº¹å›¾æ¡ˆ',
                    depth: 'å‰²çº¹æ·±åº¦ (mm)',
                    angle: 'å‰²çº¹è§’åº¦ (Â°)',
                    tool: 'ä½¿ç”¨å·¥å…·'
                },
                'è£…é¥°': {
                    material: 'è£…é¥°ææ–™',
                    technique: 'è£…é¥°æ‰‹æ³•',
                    position: 'è£…é¥°ä½ç½®',
                    timing: 'è£…é¥°æ—¶æœº'
                },
                'ä¸Šç«': {
                    temperature: 'æ¸©åº¦ (â„ƒ)',
                    duration: 'æ—¶é—´ (åˆ†é’Ÿ)',
                    position: 'ç‚‰å†…ä½ç½®',
                    notes: 'ç«åŠ›è°ƒèŠ‚'
                },
                'ä¸‹ç«': {
                    temperature: 'æ¸©åº¦ (â„ƒ)',
                    duration: 'æ—¶é—´ (åˆ†é’Ÿ)',
                    position: 'ç‚‰å†…ä½ç½®',
                    notes: 'ç«åŠ›è°ƒèŠ‚'
                },
                'é†’å‘': {
                        temperature: 'æ¸©åº¦ (28-32â„ƒ)',
                        humidity: 'æ¹¿åº¦ (75-85%)',
                        time: 'æ—¶é—´ (45-60åˆ†é’Ÿ)',
                        proofing: 'è†¨èƒ€ç¨‹åº¦ (80-85%)'
                },
                'è’¸æ±½': {
                    amount: 'è’¸æ±½é‡ (ml)',
                    injection: 'æ³¨å…¥æ—¶æœº',
                    duration: 'è’¸æ±½æŒç»­æ—¶é—´',
                    notes: 'è’¸æ±½æ³¨æ„äº‹é¡¹'
                    }
            };

            const sopStepsList = document.getElementById('sopStepsList');
            sopStepsList.innerHTML = '';
            
            // æ·»åŠ æ‰€æœ‰26ç§SOPæ­¥éª¤ç±»å‹
            sopStepTypes.forEach((type) => {
                // ä¸ºæ¯ç§ç±»å‹æ‰¾åˆ°å¯¹åº”çš„æ¨¡æ¿
                let template = templates[type.name] || null;
                addSopStep(type.name, type.icon, type.name, template);
            });
            
            updateSopSortable();
        }
        
        // æ·»åŠ SOPæ­¥éª¤
        function addSopStep(name = 'æ–°æ­¥éª¤', icon = 'fa-clock', type = 'æ—¶é—´', template = null) {
            const container = document.getElementById('sopStepsList');
            const stepId = 'sop-step-' + Date.now();
                const div = document.createElement('div');
            div.className = 'sop-step-enhanced sop-step-row p-4 rounded-xl relative flex flex-col';
            div.id = stepId;
            
            // æ­¥éª¤å¤´éƒ¨
            let headerHTML = `
                <div class="flex items-center mb-3">
                    <button class="sop-icon-btn w-10 h-10 rounded-lg flex items-center justify-center text-lg mr-3 transition hover:bg-purple-50 dark:hover:bg-purple-900/20" onclick="openSopTypeModal(this)" title="SOPç±»å‹ï¼š${type}" data-type="${type}">
                        <i class="fas ${icon}"></i>
                    </button>
                    <input type="text" class="flex-1 bg-transparent text-[#1E293B] dark:text-slate-100 font-medium border-none outline-none focus:bg-[#F8FAFC] dark:focus:bg-[#0F172A] rounded px-2 py-1" value="${name}" placeholder="æ­¥éª¤åç§°">
                    <div class="flex items-center gap-1">
                        <button class="sop-step-menu p-2 rounded-full hover:bg-[#F1F5F9] dark:hover:bg-[#334155] active:scale-90 text-slate-400 dark:text-slate-500 transition" onclick="toggleSopMenu(this)">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="sop-menu-dropdown absolute right-4 top-12 bg-white dark:bg-[#1E293B] rounded-lg shadow-xl border border-slate-200 dark:border-slate-600 p-1 z-10 hidden">
                            <button class="w-full text-left px-3 py-1.5 rounded hover:bg-[#F1F5F9] dark:hover:bg-[#334155] text-[#1E293B] dark:text-slate-100 transition flex items-center gap-2" onclick="addSopStepAfter(this)">
                                <i class="fas fa-plus text-xs"></i>
                                <span class="text-sm">æ·»åŠ åç»­æ­¥éª¤</span>
                            </button>
                            <button class="w-full text-left px-3 py-1.5 rounded hover:bg-[#F1F5F9] dark:hover:bg-[#334155] text-red-500 transition flex items-center gap-2" onclick="deleteSopStep(this)">
                                <i class="fas fa-trash text-xs"></i>
                                <span class="text-sm">åˆ é™¤</span>
                            </button>
                        </div>
                        <div class="sop-drag-handle p-1.5 rounded-full hover:bg-[#F1F5F9] dark:hover:bg-[#334155] cursor-grab text-slate-400 dark:text-slate-500 transition" title="æ‹–æ‹½æ’åº">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                    </div>
                </div>
            `;
            
            // åˆ›å»ºæ¨¡æ¿å†…å®¹
            let contentHTML = '';
            if (template) {
                contentHTML = `
                    <div class="grid grid-cols-2 gap-3 sop-step-form">
                        ${Object.entries(template).map(([key, placeholder]) => `
                                <div class="relative">
                                    <input type="text" 
                                    class="w-full px-3 py-2 bg-gray-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg text-sm text-gray-800 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 sop-step-input focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900/20 transition-all" 
                                        placeholder="${placeholder}">
                                </div>
                            `).join('')}
                        </div>
                    `;
            } else {
                // é»˜è®¤çš„å››ä¸ªè¾“å…¥æ¡†
                contentHTML = `
                    <div class="grid grid-cols-2 gap-3 sop-step-form">
                        <div class="relative">
                            <input type="text" 
                                class="w-full px-3 py-2 bg-gray-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg text-sm text-gray-800 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 sop-step-input focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900/20 transition-all" 
                                placeholder="å‚æ•°1">
                    </div>
                        <div class="relative">
                            <input type="text" 
                                class="w-full px-3 py-2 bg-gray-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg text-sm text-gray-800 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 sop-step-input focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900/20 transition-all"
                placeholder="å‚æ•°2">
        </div>
        <div class="relative">
            <input type="text" 
                class="w-full px-3 py-2 bg-gray-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg text-sm text-gray-800 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 sop-step-input focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900/20 transition-all"
                placeholder="å‚æ•°3">
        </div>
        <div class="relative">
            <input type="text" 
                class="w-full px-3 py-2 bg-gray-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg text-sm text-gray-800 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 sop-step-input focus:border-purple-500 focus:ring-2 focus:ring-purple-100 dark:focus:ring-purple-900/20 transition-all" 
                                placeholder="å‚æ•°4">
                        </div>
                    </div>
                `;
            }
            
            div.innerHTML = headerHTML + contentHTML;
            container.appendChild(div);
            
            return div;
        }
        
        function toggleSopMenu(btn) {
            const dropdown = btn.nextElementSibling;
            const allDropdowns = document.querySelectorAll('.sop-menu-dropdown');
            allDropdowns.forEach(d => {
                if(d !== dropdown) d.classList.add('hidden');
            });
            dropdown.classList.toggle('hidden');
        }
        
        function addSopStepAfter(btn) {
            const row = btn.closest('.sop-step-row');
            const container = document.getElementById('sopStepsList');
            addSopStep('æ–°æ­¥éª¤', 'fa-clock', 'æ—¶é—´');
            const newRow = container.lastElementChild;
            container.insertBefore(newRow, row.nextSibling);
            btn.closest('.sop-menu-dropdown').classList.add('hidden');
            updateSopSortable();
        }
        
        function deleteSopStep(btn) {
            if(document.getElementById('sopStepsList').children.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ­¥éª¤');
                return;
            }
            btn.closest('.sop-step-row').remove();
            btn.closest('.sop-menu-dropdown').classList.add('hidden');
        }
        
        // SOPç±»å‹é€‰æ‹©å¼¹çª—ç®¡ç†
        let currentSopIconBtn = null;
        
        function openSopTypeModal(btn) {
            currentSopIconBtn = btn;
            renderSopTypeList();
            document.getElementById('sopTypeModal').classList.remove('hidden');
        }
        
        function closeSopTypeModal() {
            document.getElementById('sopTypeModal').classList.add('hidden');
            currentSopIconBtn = null;
        }
        
        function renderSopTypeList() {
            const container = document.getElementById('sopTypeList');
            container.innerHTML = '';
            
            // æ·»åŠ æ ‡é¢˜å’Œè¯´æ˜
            const header = document.createElement('div');
            header.className = 'mb-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg text-center';
                header.innerHTML = `
                    <h3 class="text-purple-700 dark:text-purple-300 font-bold mb-1">SOPæ­¥éª¤ç±»å‹é¢„è§ˆ</h3>
                    <p class="text-purple-600 dark:text-purple-400 text-sm">ä»¥ä¸‹æ˜¯æ‰€æœ‰å¯ç”¨çš„SOPæ­¥éª¤ç±»å‹</p>
            `;
            container.appendChild(header);
            
            // åˆ›å»ºåŒ…å«æ‰€æœ‰ç±»å‹çš„ç½‘æ ¼å¸ƒå±€
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto pb-4';
            
            sopStepTypes.forEach(type => {
                const div = document.createElement('div');
                div.className = 'sop-type-item flex items-center justify-between p-3 rounded-lg cursor-pointer border border-slate-200 dark:border-slate-600 hover:border-purple-500 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: ${type.color}20;">
                    <i class="fas ${type.icon} text-lg" style="color: ${type.color}"></i>
                        </div>
                        <span class="text-[#1E293B] dark:text-slate-100 text-sm font-medium">${type.name}</span>
                    </div>
                `;
                div.onclick = () => selectSopType(type);
                grid.appendChild(div);
            });
            
            container.appendChild(grid);
            
            // æ·»åŠ ä½¿ç”¨è¯´æ˜
            const footer = document.createElement('div');
            footer.className = 'mt-4 p-3 bg-slate-100 dark:bg-slate-800/50 rounded-lg';
            footer.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-slate-500 dark:text-slate-400 text-sm">ç‚¹å‡»ä»»æ„ç±»å‹å¯ä»¥é€‰æ‹©</span>
                    <button class="px-4 py-2 gradient-primary text-white rounded-lg text-sm" onclick="closeSopTypeModal()">å…³é—­é¢„è§ˆ</button>
                </div>
            `;
            container.appendChild(footer);
        }
        
        function selectSopType(type) {
            if(currentSopIconBtn) {
                const icon = currentSopIconBtn.querySelector('i');
                icon.className = `fas ${type.icon}`;
                icon.style.color = type.color;
                currentSopIconBtn.setAttribute('data-type', type.name);
                currentSopIconBtn.title = `SOPç±»å‹ï¼š${type.name}`;
            }
            closeSopTypeModal();
        }
        
        function updateSopSortable() {
            const container = document.getElementById('sopStepsList');
            if (container && !container.sortable) {
                container.sortable = new Sortable(container, {
                    handle: '.sop-drag-handle',
                    animation: 250,
                    ghostClass: 'opacity-50',
                    chosenClass: 'ring-2 ring-purple-400 scale-105',
                    easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                    onStart: function() {
                        document.querySelectorAll('.sop-menu-dropdown').forEach(d => d.classList.add('hidden'));
                    }
                });
            }
        }

        // æš—è‰²æ¨¡å¼åˆ‡æ¢
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            if(html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme','light');
            } else {
                html.classList.add('dark');
                icon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme','dark');
            }
            
            // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å…ƒç´ çš„æš—è‰²æ¨¡å¼æ ·å¼
            refreshDarkModeStyles();
        }
        
        // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å…ƒç´ çš„æš—è‰²æ¨¡å¼æ ·å¼
        function refreshDarkModeStyles() {
            // è·å–æ‰€æœ‰å¯èƒ½éœ€è¦æ›´æ–°çš„å…ƒç´ 
            const elementsToRefresh = [
                '.card', '.step-images', '.bg-white', '.bg-slate-50', '.bg-slate-100',
                '.text-slate-800', '.text-slate-600', '.text-slate-500', '.text-slate-400',
                '.border-slate-100', '.border-slate-200', '.border-slate-300',
                '.hover\\:bg-slate-50', '.hover\\:bg-slate-100',
                '.sop-step-enhanced', '.sop-step-row', '.sop-step-input',
                '.sop-type-item', '.media-upload-area', '.step-row'
            ].join(',');
            
            const allElements = document.querySelectorAll(elementsToRefresh);
            
            // å…ˆç§»é™¤å†æ·»åŠ æ‰€æœ‰å…ƒç´ çš„classï¼Œå¼ºåˆ¶æµè§ˆå™¨é‡æ–°åº”ç”¨æ ·å¼
            allElements.forEach(el => {
                el.classList.remove('dark-force-refresh');
                setTimeout(() => {
                    el.classList.add('dark-force-refresh');
                    setTimeout(() => {
                        el.classList.remove('dark-force-refresh');
                    }, 10);
                }, 5);
            });
            
            // ç‰¹åˆ«å¤„ç†ä¸€äº›ç‰¹å®šå…ƒç´ 
            document.querySelectorAll('.drag-handle-enhanced').forEach(el => {
                if(html.classList.contains('dark')) {
                    el.classList.add('dark-handle');
                } else {
                    el.classList.remove('dark-handle');
                }
            });
            
            // é‡æ–°åº”ç”¨æ‰€æœ‰å¡ç‰‡çš„æš—è‰²æ¨¡å¼
            document.querySelectorAll('.card').forEach(el => {
                if(html.classList.contains('dark')) {
                    el.style.background = '#1E293B';
                    el.style.borderColor = '#334155';
                } else {
                    el.style.background = '#FFFFFF';
                    el.style.borderColor = '#E2E8F0';
                }
            });
        }

        // è‡ªåŠ¨è¯»å–ä¸»é¢˜
        (function(){
            if(localStorage.getItem('theme')==='dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
                // ç¡®ä¿åœ¨åŠ è½½æ—¶å°±åº”ç”¨æ‰€æœ‰æš—è‰²æ¨¡å¼æ ·å¼
                setTimeout(refreshDarkModeStyles, 100);
            }
        })();

        // åˆå§‹åŒ–å·¦æ»‘åˆ é™¤åŠŸèƒ½
        function initSwipeDelete(element) {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            
            // æ·»åŠ é¼ æ ‡äº‹ä»¶æ”¯æŒï¼ˆä¸ºäº†åœ¨æ¡Œé¢ç«¯æµ‹è¯•ï¼‰
            function handleMouseDown(e) {
                startX = e.clientX;
                isDragging = true;
                element.classList.add('swiping');
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                e.preventDefault();
            }
            
            function handleMouseMove(e) {
                if (!isDragging) return;
                
                currentX = e.clientX;
                const diffX = currentX - startX;
                
                // åªå…è®¸å‘å·¦æ»‘åŠ¨
                if (diffX <= 0) {
                    // é™åˆ¶æœ€å¤§æ»‘åŠ¨è·ç¦»ä¸º80px
                    const translateX = Math.max(-80, diffX);
                    element.style.transform = `translateX(${translateX}px)`;
                    // å¦‚æœæ»‘åŠ¨è¶…è¿‡20pxï¼Œå°±æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    if (translateX < -20) {
                        element.querySelector('.delete-action').style.right = '0';
                    } else {
                        element.querySelector('.delete-action').style.right = '-80px';
                    }
                } else {
                    // å¦‚æœå·²ç»æ‰“å¼€äº†åˆ é™¤æŒ‰é’®ï¼Œåˆ™å…è®¸å‘å³æ»‘åŠ¨å…³é—­
                    if (element.getAttribute('data-open') === 'true') {
                        const translateX = Math.min(0, diffX - 80);
                        element.style.transform = `translateX(${translateX}px)`;
                        if (translateX > -40) {
                            element.querySelector('.delete-action').style.right = '-80px';
                        }
                    } else {
                        element.style.transform = 'translateX(0)';
                    }
                }
                
                e.preventDefault();
            }
            
            function handleMouseUp(e) {
                if (!isDragging) return;
                isDragging = false;
                element.classList.remove('swiping');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                
                // åˆ¤æ–­æ»‘åŠ¨è·ç¦»æ˜¯å¦è¶³å¤Ÿæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                const diffX = currentX - startX;
                
                if (diffX < -40) {
                    // æ‰“å¼€åˆ é™¤æŒ‰é’®
                    element.style.transform = 'translateX(-80px)';
                    element.setAttribute('data-open', 'true');
                    element.querySelector('.delete-action').style.right = '0';
                } else {
                    // å…³é—­åˆ é™¤æŒ‰é’®
                    element.style.transform = 'translateX(0)';
                    element.setAttribute('data-open', 'false');
                    element.querySelector('.delete-action').style.right = '-80px';
                }
            }
            
            function handleTouchStart(e) {
                startX = e.touches[0].clientX;
                isDragging = true;
                element.classList.add('swiping');
                
                // é˜»æ­¢å…¶ä»–è§¦æ‘¸äº‹ä»¶
                e.stopPropagation();
            }
            
            function handleTouchMove(e) {
                if (!isDragging) return;
                
                currentX = e.touches[0].clientX;
                const diffX = currentX - startX;
                
                // åªå…è®¸å‘å·¦æ»‘åŠ¨
                if (diffX <= 0) {
                    // é™åˆ¶æœ€å¤§æ»‘åŠ¨è·ç¦»ä¸º80px
                    const translateX = Math.max(-80, diffX);
                    element.style.transform = `translateX(${translateX}px)`;
                    // å¦‚æœæ»‘åŠ¨è¶…è¿‡20pxï¼Œå°±æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    if (translateX < -20) {
                        element.querySelector('.delete-action').style.right = '0';
                    } else {
                        element.querySelector('.delete-action').style.right = '-80px';
                    }
                } else {
                    // å¦‚æœå·²ç»æ‰“å¼€äº†åˆ é™¤æŒ‰é’®ï¼Œåˆ™å…è®¸å‘å³æ»‘åŠ¨å…³é—­
                    if (element.getAttribute('data-open') === 'true') {
                        const translateX = Math.min(0, diffX - 80);
                        element.style.transform = `translateX(${translateX}px)`;
                        if (translateX > -40) {
                            element.querySelector('.delete-action').style.right = '-80px';
                        }
                    } else {
                        element.style.transform = 'translateX(0)';
                    }
                }
                
                // é˜»æ­¢æ»šåŠ¨
                e.preventDefault();
            }
            
            function handleTouchEnd() {
                if (!isDragging) return;
                isDragging = false;
                element.classList.remove('swiping');
                
                // åˆ¤æ–­æ»‘åŠ¨è·ç¦»æ˜¯å¦è¶³å¤Ÿæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                const diffX = currentX - startX;
                
                if (diffX < -40) {
                    // æ‰“å¼€åˆ é™¤æŒ‰é’®
                    element.style.transform = 'translateX(-80px)';
                    element.setAttribute('data-open', 'true');
                    element.querySelector('.delete-action').style.right = '0';
                } else {
                    // å…³é—­åˆ é™¤æŒ‰é’®
                    element.style.transform = 'translateX(0)';
                    element.setAttribute('data-open', 'false');
                    element.querySelector('.delete-action').style.right = '-80px';
                }
            }
            
            function handleDeleteClick() {
                element.remove();
                updateTotalWeight();
                updateVariationTotal();
            }
            
            element.addEventListener('touchstart', handleTouchStart, { passive: false });
            element.addEventListener('touchmove', handleTouchMove, { passive: false });
            element.addEventListener('touchend', handleTouchEnd);
            
            // æ·»åŠ é¼ æ ‡äº‹ä»¶æ”¯æŒï¼ˆä¸ºäº†åœ¨æ¡Œé¢ç«¯æµ‹è¯•ï¼‰
            element.addEventListener('mousedown', handleMouseDown);
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const deleteBtn = element.querySelector('.delete-action');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', handleDeleteClick);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ‰€æœ‰çš„å·¦æ»‘åˆ é™¤åŠŸèƒ½
        window.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–é»˜è®¤æ·»åŠ çš„ææ–™
            ['flour','starter','dry','wet','aux','base'].forEach(type => {
                addIngredient(type);
            });
            
            // æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬
            document.addEventListener('click', function(e) {
                // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶å…³é—­æ‰€æœ‰æ‰“å¼€çš„åˆ é™¤æŒ‰é’®
                const openItems = document.querySelectorAll('.ingredient-item[data-open="true"]');
                if (openItems.length > 0 && !e.target.closest('.delete-action')) {
                    openItems.forEach(item => {
                        item.style.transform = 'translateX(0)';
                        item.setAttribute('data-open', 'false');
                    });
                }
            });
        });
    </script>
</body>
</html>